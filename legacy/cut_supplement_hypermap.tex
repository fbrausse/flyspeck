% Cut from supplement_hypermap.tex on Feb 3, 2014.

\subsection{main theorem}

We have the following theorem imported from Isabelle.

\begin{theorem}[Import~Tame~Classification]  Let $g$ be a final
planegraph that is tame.  Then there exists a $y$ in the archive such
that the fgraph of g is fgraph congruent to $y$.
\end{theorem}

We have the following theorem about planarity.

\begin{theorem}\guid{LSKOKJE} Let $H$ be a restricted hypermap.  Then
  there exists a planegraph $g$ with every
  face final and such that $H$ is isomorphic to the hypermap of $g$.
\end{theorem}

\begin{proof}  The proof assumes Lemma AQIUNPP,
which is still being formalized.

The proof is by explicit construction of $g$.  The proof constructs a
sequence $(\LL_i,g_i,\phi_i)$, where $\LL_i$ is a normal family in
$H$, $g_i$ is a planegraph, and $\phi_i$ is an isomorphism between its
hypermap and $H/\LL_i$.  Also, the set of canonically true faces of
$H/\LL_i$ corresponds under $\phi_i$ with the set of faces obtained
from finals~$g_i$.  Also, at every step $H/L_i$ will be a simple
hypermap.

At stage $0$, $H/\LL_0$ will be a dihedral hypermap and $g_0$ will be
a seed lgraph (which is a polygon).  At the final stage $N$, $H/\LL_N$
will be isomorphic to $H$ and $g_N$ will be the desired lgraph $g$
asserted in the theorem.

The series of lemmas that follows goes through the details
of the construction.
\end{proof}

\subsection{Construction of $\LL_0$}


The following is an adaptation of Example 4.52 (minimal normal family).

\begin{lemma}\guid{AUQTZYZ} Let $H$ be a restricted hypermap.
  Let $F$ be a face of $H$.  Let $\LL_0$ be the family with two
  contour loops: one following $F$ and its complement.  The family
  $\LL_0$ is normal and the subquotient $H/\LL_0$ is dihedral 
  $dih2k$ with parameter $n=\card(F)$.
\end{lemma} 

We apply this construction to a face $F$ of $H$ of largest possible
cardinality $n$ to obtain the initial normal family $\LL_0$.

%There is a corresponding construction of lgraphs called
%Seed~(n-3).  Every seed is a planegraph.

%\begin{lemma}\guid{ENWCUED} For all $n$,
%The hypermap of Seed~$n$ is dih2k with parameter $n+3$.
%\end{lemma} 

%\begin{proof}
%The seed has an lgraph with two faces of size $n+3$.
%The fgraph is 
%\[
%[[0;1;\ldots;n+2];[n+2;n+1;\ldots;0]].
%\]
%The hypermap of this fgraph has two faces
%\[
%\{(0,1),(1,2),\ldots\} \text{ and } \{(1,0),(2,1),\ldots\}.
%\]
%\end{proof}

%\begin{lemma}\guid{PFUWHJH} If a hypermap $H$ is dih2k, 
%and $x$ and $y$ are darts of $H$, then H has an
%  automorphism sending $x$ to $y$.
%\end{lemma} 

%\begin{proof} Let $x$ be any dart of $H$.  Every dart has the form
%  $f^i e^j x$.  Write $y = f^r e^s x$.  Define the automorphism by 
%$\phi_{r,s}(f^i e^j x) = f^{i+r (-1)^j}  e^{j+s} x$.  
%This is a hypermap automorphism that carries $x$ to $y$.
%\end{proof}

%\begin{lemma}\guid{UYOYIXG}
%Let $H$ be restricted and $\LL_0$ the minimal normal family
%on a face of cardinality $n$.  Assume that $H$ is not dih2k.
%Then there exists an isomorphism
%$\phi_0$ from the hypermap of Seed~$(n-3)$ to $H/\LL_0$.
%Moreover, the isomorphism can be chosen to give a bijection 
%between final faces and the canonically true faces of $H/\LL_0$.
%\end{lemma} 

%\begin{proof}
%Both $H/\LL_0$ and this hypermap are isomorphic
%to the dihedral hypermap of with $2n$ darts.
%Hence there is an isomorphism $\phi_0$ between them.
%by HYP\_ISO\_DIH2K\_PRESERVED


%One face of the fgraph has the attribute finals.  Assuming that $H$ is
%not dih2k, exactly one face of the subquotient is canonically true.
%By a lemma PFUWHJH, 
%we may pick the isomorphism to map the final face
%to the canonically true face.
%\end{proof}


\subsection{Termination}


We describe the termination condition.  How do we recognize
the final state $(\LL_N,g_N,\phi_N)$?  When all the faces
of $g_N$ are terminal, then also all the faces of $H/\LL_N$ are
canonically true.  

We will use some inequalities to guarantee termination.

\begin{lemma}\guid{ADACDYF}  
  Let $(H,\LL,L,x)$ be a marked hypermap in which $L$ is canonically
  false.  Let $T(H,\LL,L,x) = (H,\MM,M,x)$ be its transform.  Then the
  number of darts in $H/\MM$ is greater than the number of darts in
  $H/\LL$.
\end{lemma} 

\begin{proof}  The number of darts in a quotient hypermap is equal
to the number of quotient darts (atoms) in the normal family $\LL$.
The normal family $\MM$ replaces a loop $L$ with $L_1$ and $L_2$
and keeps the other loops the same.  The atoms of $L$ at
$y$ and $z$ are split into two atoms to create $L_1$ and $L_2$.
Hence the number increases.
\end{proof}

\begin{lemma}\guid{ZBHENEI}
\formalauthor{TNT}
 Let $H$ be a restricted hypermap with normal family
$\LL$.  The number of darts in $H/\LL$ is at most the number of
darts in $H$.  
\end{lemma} 

\begin{proof} The darts of $H/\LL$ are obtained by taking a subset
of the darts of $H$ visitited by $\LL$ and then combining them into
atoms.  Taking subsets and combining both are non-increasing
in the number of darts.  
\end{proof}

\begin{lemma}\guid{XWCNBMA}
\formalauthor{TNT}  
Let $H$ be a restricted hypermap with nonempty
normal family
$\LL$.  Assume that each face of $\LL$ is canonically true.  Then
$H/\LL$ is isomorphic to $H$.
\end{lemma} 

\begin{proof} This is Example 4.51 (maximal normal family).
If $L$ is a loop in the family, it is canonically true.  Hence its
darts are singletons and the darts in the loop form a face.  Thus,
the set of darts visited by the family $\LL$ is a union of faces.
By the third, property of normal family, the set of darts visited by
the family $\LL$ is a union of nodes.  Hence the set of such darts is
a connected component.  A restricted hypermap is connected,
so all darts are visited by $\LL$.  

Thus, $x \mapsto [x]$ is an isomorphism of $H$ with $H/\LL$.
\end{proof}


How do we know that we will eventually terminate by reaching
a state in which the faces of $H/\LL_N$ are all canonically true?

Each iteration will involve taking at least one transform, which
increases the number of darts in the quotient.  This number is
limited by the number of darts in $H$.  Thus, the process terminates.

We will see that the process can continue as long as there is a 
loop that is not canonically true.  Hence, termination will produce
a nonempty normal family $\LL_N$ in which every face $\LL_N$ is 
canonically true.  The subquotient hypermap $H/\LL_N$
will then be isomorphic to $H$.


%%% 


%  Let $k$ be
%the number of darts $y$ in the loop $L$ such that $y$ is on $F_x$, but
%the dart following $y$ on the contour loop $L$ is $n^{-1}y$ rather
%than $f y$.  Ordering according to the loop order starting at $x$,
%let $y_i$, for $i=1,\ldots,k$, be the darts in the loop $L$ such
%that $y_i$ is on $F_x$, but followed on $L$ by $n^{-1}y_i$.
%Following $f$-steps from $y_i$, let $z_i$ be the first dart of $H$
%after $y_i$
%that is again visited by $\LL$.


%Here is the main structural theorem.

%\begin{lemma} The darts $z_i$ of $H$ are visited by $L$.  
%The atoms of $\MM_i$ (in order) are the singleton darts $x$,
%$f x$, taking $f$-steps until the atom of $\MM_i$ containing $z_i$
%is reached, then from there following the atoms of the loop $L$
%back to $x$.  The darts $y_j$, for $j\le i$,
%occur in increasing order along the segment before $z_i$.
%The dart $y_{i+1}$ is the first dart encountered on $\MM_i$
%that is followed by a $n^{-1}$-step.
%The dart $z_{i+1}$ occurs on $\MM_i$ (or $L$) in the segment after
%$z_i$.  
%\end{lemma} 

%\begin{proof} This is an induction, using the transform both for
%the base case and induction step.  
%It uses Lemma 4.67 (loop confinement, HQYMRTX).
%\end{proof}



\subsection{The induction step}

The induction step is quite involved.  It goes from
$(\LL_i,g_i,\phi_i)$ to $(\LL_{i+1},g_{i+1},\phi_{i+1})$.
We describe all of these data.

We will give a function $\Phi$ that transforms $(\LL_i,g_i,\phi_i)$ to
$(\LL_{i+1},g_{i+1},\phi_{i+1})$.  For now, we drop the subscripts and
describe the function $\Phi$ on an arbitrary $(\LL,g,\phi)$ such that
$g$ is planegraph, and $\phi$ is an isomorphism between $H/\LL$ and
the hypermap coming from $g$.  Note that $H$ is fixed throughout the
construction.

\subsubsection{construction of $\MM$}

By construction, the loop $L$ is canonically false.
We write $T^k(H,\LL,L,x) = (H,\MM,M,x)$, where $k$ is
the number of iterates required to produce a canonically
true face $M$, (which equals the number of darts $y$ 
on the loop $L$
that are preceded by an $f$-step and followed by an $n^{-1}$-step).
We define the first coordinate of $\Phi(\LL,g,\phi)$ to be $\MM$,
obtained from the $k$th iterate of the transform.

\subsubsection{construction of $g'$}

We next describe the lgraph $g'$ obtained as the second
coordinate of $\Phi(\LL,g,\phi) = (\MM,g',\phi')$.  
In the Isabelle development there are functions, generatePolygon
and nextPlane, that generate a new $g'$ from what is called
an enumeration.  An enumeraton is an increasing list of integers:
\[
a_1\le a_2\le\cdots \le a_r
\]
satisfying a few simple inequalities.   
Thus, to specify $g'$, it is enough to give the list $a_i$.

We say that $(\phi,g,H,NF)$ are corresponding hyperdata if
the following properties hold.
\begin{enumerate}
\item $\LL$ is a normal family in $H$.
\item $g$ is a planegraph.
\item $\phi$ is an isomorphism between the hypermap of $g$  and
$H/\LL$.  
\item  The set of canonically true faces of $H/\LL$
corresponds under $\phi$ with the set of faces obtained from 
finals~$g$.  
\item  $H/\LL$ is a simple hypermap.
\item The node map has no fixed points on the subquotient $H/\LL$.
\item The canonical function is a $\emptyset$-flag on $H/\LL$.
\end{enumerate}

We will need to show that if the input is corresponding hyperdata, then
the output is as well.

There is a function, finalGraph, which is true exactly when
the set of faces of $g$ that are not final is empty.  By our
termination condition, we will stop modifying $(\LL,g,\phi)$
when we have finalGraph~g.  Hence, if finalGraph~g holds, we
set
\[
\Phi(\LL,g,\phi) = (\LL,g,\phi).
\]
Now we assume that finalGraph~g does not hold.

There is a function, minimalFace, that picks out a face $F$ from 
$g$ that is not final.  Under the isomorphism $\phi$ this
corresponds with a loop $L$ of $\LL$ that is canonically false.

There is a function, minimalVertex, that picks out a vertex $v$
of $g$ on the face $F$.  We describe how a face $F$ and a vertex $v$
on the face give a dart $d(F,v)$ of the hypermap of of $g$.
The vertex $v$ is an element of $F$.  The nextVertex $w$ on $F$
gives a dart $(v,w)$ of the hypermap.

Under the isomorphism $\phi$, the dart $(v,w)$ maps to an
atom in $H/\LL$.
Write this atom as $\bar x = [\ldots;x]$, ending in the dart $x$ of $H$.
Then $x$ is a dart visited by $L$, such that $x$ is
followed by an $f$-step in the loop $L$.

\begin{lemma}\guid{HKBGWJI}
In this construction, $(H,\LL,L,x)$ is a marked hypermap.
\end{lemma} 

\begin{proof}  
We verify each of the properties of a marked hypermap.

$H$ is restricted, so it has no M\"obius contours and $e$ acts
without fixed points.

By construction $\LL$ is a normal family, $L$ is a loop of $\LL$
and $x$ is a dart visited by $L$.

1. By assumption, $H/\LL$ is simple. 2. Also, by assumption, the
node map has no fixed points on $H/\LL$.  3.  The face $F$ of
the planegraph $g$ is not final, so the loop $L$ is not canonically
true.  The dart $x = \phi(a,b)$ is visited by $F$.  By an earlier lemma,
the dart $(b,a)$ lies on a face that is canonically true.  Then $\phi(b,a)
= e x$ is visited by a contour loop $L'$ that is canonically true.
5.  It is enough to show that the canonical function is a $\empty$-flag
on the subquotient $H/\LL$.  This is also true by assumption.
\end{proof}



We use $\LL,F,x$ to define the list $a_i$.  The length $r$ will be the
cardinality of $F_x$.  Label the darts in the face $F_x$ as $x_i =
f^{i+1} x$, for $i=0,\ldots,r-1$.  Note the shift in indexing: $x_0 =
f x$.

We use the SOME, NONE type for the sequence $c_i$.
Set $c_i = \text{NONE}$
if $x_i$ is not visited by  $\LL$, and otherwise set 
$c_i = \text{SOME}~Q_i$,
where $Q_i$ is the atom of $\LL$ containing $x_i$.  

Let $t$ be the number of atoms in the loop $L$.  Number the quotient
darts of $H/\LL$ on the face corresponding to the loop $L$ in
consecutive order:
\[
q_0,q_1,\ldots,q_{t-1},
\]
where $q_0$ is the atom of $x_0$ in $L$.

By the previous lemma, each $Q_i = q_j$ for some $j$.
Set $b_i = \text{NONE}$
if $x_i$ is not visited by the loop $L$, and otherwise set 
$b_i = \text{SOME}~j$,
where $Q_i = q_j$.
By the  lemma in the previous subsection, 
the integers $j$ are strictly increasing.

Set $a_i' = j$, where $b_{i'} = \text{SOME}~j$, and
where $i'\le i$ is the largest index less than or equal to $i$ such
that $L$ visits $x_{i'}$.  Then $a_i$ is weakly increasing and
generatePolygon constructs $g'$ from this sequence.

We recall exactly how generatePolygon uses $a_i$ to construct
$g'$.  The function hideDups expands $a_i$ back into $b_i$.
The function indexToVertexList generates the
vertices $v_i$ of $g$ corresponding to the integers $b_i$.
The function subdivFace then creates $g'$ from the vertex list $v_i$.

The function subdivFace is recursive, stepping through the vertex list
$v=[v_0;\ldots]$ one by one.  Only $k$ of the steps modify the lgraph.
This is done by splitting the face in a way that corresponds precisely
to the transform described above.

If the vertex $v_i$ is NONE, then a counter is incremented (starting
from 0).  If the vertex $v_i$ is followed in the list $v$ by the next
vertex on the face $F$ of $g$ and the counter is $0$, then nothing
happens and we move on to $v_{i+1}$.  In the remaining case, the face
$F$ is split into two by running new edges from $v_i$ to $v_{i+1}$,
adding new vertices according to the size of the counter.  The counter
is then reset.  Let $g=h_0,h_1,\ldots,h_k$ be the graphs constructed
by this process, with $g' = h_k$.  When the face $F$ is split into two
$F'$ and $F''$, one of the two faces $F''$ replaces $F$ in the next
step of the iteration.  As we iterate through the list $v_i$, we get a
sequence $F_0=F$, $F_1 =F''$, $F_2 = (F'')''$, etc.  of faces.  Note
that the intermediate lgraphs $h_i$ are not planegraphs, only the
initial $g=h_0$ and $g'=h_k$.

The Isabelle function, subdivFace0, marks one new face final $F_k$.
However, on the hypermap side, the canonical function is updated at
every iteration $\MM_i$.  This means that the list of final faces can
fall out of sync with (lag behind) the canonical function.  At stage
$k$, we can resync using the following lemma.

\begin{lemma}\guid{UWAHKWU}
  Let $g$ be a planegraph with parameter $p$.  If $F$ is any face of
  $g$ with at most $p$ vertices, there is a planegraph $g'$, which is
  identical to $g$ except that it makes the face $F$ final.
\end{lemma} 

\begin{proof}
  Applying the function generatePolygon (with the full enumeration
  $a_i=i$) to the face $F$.  No splits are made and the only effect is
  to make the face final.
\end{proof}

\begin{lemma}\guid{RKXPIXF} Let $H$ be restricted and $\LL$ a normal family.
Then $H/\LL$ has no double joins.
\end{lemma} 

\begin{proof}
By definition, the restricted hypermap $H$  has no double joins.
The set of nodes of $H/\LL$ is a subset of the set of nodes of $H$.
Thus a double join in $H/\LL$ would create a double join in $H$.
\end{proof}


\begin{lemma}\guid{XIZEQEV}  
Let $a_i$, for $i=1,\ldots,r$, be an enumeration.  
Then the lgraph $g_j$ obtained by a partial application of
the enumeration $[a_0;\ldots;a_j]$, for $0<j\le r$, is 
planegraph-relaxed provided $a_j \ne a_{j-1}$.
When $j=r$, the  full application is a planegraph.
\end{lemma} 

\begin{proof} A partial application is the same as a full application
of a modified enumeration
\[
a_1,a_2,\ldots,a_j,(a_j+1),(a_j+2),\ldots,t.
\]
\end{proof}

\begin{remark}
A function, containsDuplicateEdge, is used to eliminate certain
enumerations.  We must check that our enumeration $a_i$ is not
eliminated.  Those eliminated are those that create a double edge
between two vertices.  Thus, the enumeration $a_i$ will pass through
the containsDuplicateEdge filter.
\end{remark}

As a consequence the fgraph of $g_j$ is a good-list and a
good-list-node.

\subsubsection{construction of $\phi'$}

Let $\Phi(\LL,g,\phi) = (\MM,g',\phi')$, where $\phi'$ still
needs to be defined in a way so that $H/\MM$ is isomorphic
under $\phi'$ to the hypermap constructed from $g'$.

We can refine the assertion of an isomorphism so that there is an
isomorphism at every step from the hypermap constructed from $h_i$ and $H/\MM_i$, where $T^i(H,\LL,L,x) = (H,\MM_i,M_i,x)$.  Also, $M_i$ will
correspond with $F_i$ under the isomorphism.  The isomorphism $\phi'$
is constructed from $\phi$ in $k$ steps.  $\psi_0 = \phi,\ldots,\psi_k
= \phi'$.

%(Warning: we have shifted notation from earlier.  The
%subscript $i$ on $h_i$, $\psi_i$ is running from $0$ to $k$
%for the iterates of the transform.  This is all part of one step
%of $\Phi$.  Earlier the subscripts were indexing the iterates of
%$\Phi$ up to $N$.)

Inductively, assume that we have defined the isomorphism $\psi_i$
starting with the base case $\psi_0=\phi$.  We construct $\psi_{i+1}$
from $\psi_i$.  
%Since $H/\LL$ and the higher transforms $H/\MM_i$
%are simple hypermaps, we can specify a dart of $H/\MM_i$ by
%the face and node that it lies at.  That is, we can specify $\psi_{i+1}$
%by saying where it maps each face and vertex of $g$.

Inductively, we know $\psi_i$.  In going from $h_i$ to $h_{i+1}$, the
face $F_i$ splits into two $F'$ and $F_{i+1}=F''$ and the other faces
are the same in the two lgraphs.  The darts of $F'$ and $F''$ are the
same as those of $F_i$ except along a new sequence of edges running
between vertices $v$ and $w$ of $F_i$.  The counter specifies the
number of inserted vertices.  Each of the inserted vertices have
degree two, hence two darts at the level of hypermaps.

Recall that  $T(H,\MM_i,M_i,x) = (H,\MM_{i+1},M_{i+1},x)$.  The
faces of $H/\MM_i$ are in bijection with the loops in $\MM_i$. 
The transform splits $M_i$ into $M_{i+1}$ and $M_i^+$.  At the level
of faces, we have $\psi_{i+1}$ map $F_{i+1}$ to $M_{i+1}$ and $F'$
to $M_i^+$ and leaving other faces unchanged from $\psi_i$.

In going from $h_i$ to $h_{i+1}$, all of the vertices are the same
except for the new vertices $u$ added from the counter (which counts
the number of NONE entries, which equals a suite of consecutive
indices $j$ such that $b_j = \text{NONE}$).  Each entry NONE was
defined as an index $j$ such that $x_j$ does not lie at a node visited
by $M_i$.  By construction, $x_j$ does not
lie at a node visited by $\MM_i$.  Define $\phi_{i+1}$ to map the dart
$d(F'',u)$ to $x_j$, and $d(F',u)$ to $n x_j$.

At the joining vertices $v$ and $w$, we have atoms $\phi_i(d(F_i,v))$
and $\phi_i(d(F_i,w))$ which are each split into two atoms in
$H/\MM_{i+1}$.  by the transform map of marked hypermaps.  We define
$\phi_{i+1}$ on the darts
\[
d(F',v), d(F'',v), d(F',w), d(F'',w)
\]
to map to these four atoms, in the unique way that preserves nodes and
faces.  We leave it as an exercise, that $\phi_{i+1}$ defined on darts
this way is an isomorphism of hypermaps.

\begin{lemma}\guid{EPWRLGS} For all $i$, we have that 
$\psi_{i}$ is an isomorphism of the hypermap
of $h_{i}$  with $H/\MM_i$.
\end{lemma} 

Taking $i=k$, we obtain an isomorphism $\phi'=\psi_k$ of
the hypermap of $g'=h_k$ with $H/\MM$, where $\MM=\MM_k$.

This completes the description of $\Phi(\LL,g,\phi) = (\MM,g',\phi')$.
By construction, if $g$ is a planegraph, then $h_i$ is a planegraph,
and $g' = h_k$ is a planegraph.

As said above, we iterate $\Phi$ for sufficiently many times, to obtain a
hypermap quotient that is isomorphic to $H$ itself.
This completes the description of the isomorphism between
$H$ and the hypermap of a  lgraph $g$ that is a final planegraph.


%%%
\subsection{Index Calculus and Higher Transforms}


Let $(H,\LL,L,x)$ be a marked hypermap.  
Let $T$ be the transform operator on marked hypermaps
(Definition 4.69 YQANQNF).  
Let $T^i(H,\LL,L,x) = (H,\MM_i,M_i,x)$ be the $i$th transform of
$(H,\LL,L,x)$.  We inductively describe the structure of $(H,\MM_i,M_i,x)$.

The natural number $i$ is bounded by the condition that $\MM_{i+1},M_{i+1}$ is defined only for those $i$ such that $M_i$ is canonically false.
We assume this condition without explicit mention.

Definition BVUFRRE associates constants $m_i,p_i,q_i$ and darts $y_i,z_i$
to the marked hypermap $(H,\MM_i,M_i,x)$, where we have added
subscripts to indicate dependence on $i$.


Recall from Section~4.7.3 the construction of $(\MM_{i+1},M_{i+1})$
from $(\MM_i,M_i)$. 
In general, we write modify-loop $(L,x,y,p)$ for the loop obtained
by replacing the segment of $L$ from $x$ to $y$ with the segment
of the path $p$ running from $x$ to $y$.
Let $F_x$ denote the face of $H$ containing the dart $x$. 

\begin{lemma}\guid{LPWFYMU} 
We have 
\[
\MM_{i+1} = (\MM_i \setminus \{M_i\}) \cup \{M_i^-,M_i^+\}
\]
where 
\[
M_i^- = \text{modify-loop} (M_i,x,z_i,F_x): 
  \text{follow } M_i \text{ from } z_i \text{ to } x
  \text{ and follow } F_x \text{ from } x \text{ to } z_i,
\]
and
\[
M_i^+ = \text{modify-loop} (M_i,nz_i,n^{-1}y_i,F^c_x): 
\text{follow } M_i \text{ from } n^{-1} y_i \text{ to } n z_i
  \text{ and follow } F^c_x \text{ from } nz_i \text{ to } n^{-1} y_i,
\]
and 
\[
M_{i+1} = M_i^-,
\]
where $F^c_x$ represents the complementary path of the path on $F_x$.
\end{lemma} 

We order darts on $F_x$ according to the $f$-ordering starting with $x$.
We order darts on $M_i^-$ 
according to the loop ordering starting with $x$.
Write $z <_{L,x} z'$ if a dart $z$ appears before dart $z'$ on the loop $L$
(starting from $x$).  We drop $x$ from notation when it is fixed.


%%%

















\begin{lemma}\guid{RYIUUVK}  $z_i \le _F y_{i+1}$.
\end{lemma} 

\begin{proof} $y_{i+1}$ is defined as the first dart on $M_{i+1}$
that is followed by a $n^{-1}$-step on $M_{i+1} = M_i^-$.  By the
construction of $M_i^-$,
the steps from $x$ to $z_i$ are all $f$-steps.
\end{proof}

By construction $z_i$ appears at or after $y_i$ on $F_x$.  Thus,
$y_0 < z_0 \le y_1 < z_1\cdots$ is in order on $F_x$ (with gaps).

By loop confinement (Lemma~4.67), the dart $z_{i+1}$ appears on
$M_i$ in the segment strictly from $z_i$ back to $x$:
$z_i <_{M_i} z_{i+1}$.

\begin{lemma}\guid{CESHTIN} 
The darts $y_i$ and $z_i$ are visited by $L$.  Their order with
respect to $L$ is the same as their order with respect to $F_x$:
\[
y_0 <_L z_0 \le_L y_1 <_L z_1\cdots \le y_i <_L z_i.
\]
The segment of $L$ from $n^{-1} y_i$ to $n z_i$ is the same
as the segment of $M_i$ from $n^{-1}y_i$ to $n z_i$.
The segment of $L$ from $z_i$ to $x$ is the same as the
segment of $M_{i+1}$ from $z_i$ to $x$.
\end{lemma} 

\begin{proof} By complete induction on $i$, proving all statements
at once.  
Assume that all of these statements hold for $j<i$. We show they
hold at $i$.

%When $i=0$, the fact that $z_0$ is visited by $L$ and that $y_0 <_L z_0$
%in the ordering on $L$ follows from loop confinement. The statements
%about $M_0$ are trivial since $L=M_0$.

By the loop confinement lemma, $y_i$ and $z_i$ are visited by $M_i$.
$y_i$ is obtained from $f$-steps along $M_i$ from $x$, hence
$z_{i-1} <_{F_x} y_i$ implies $z_{i-1} <_{M_i} y_i$.  Also, $y_i <_{M_i} z_i$
by loop confinement.  By induction, from $z_{i-1}$ to $x$, we have that
$L$ and $M_i$ are the same, hence $y_i$ and $z_i$ are visited by $L$, and $z_{i-1} <_L < y_i <_L < z_i$.

The segment of $L$ from $z_i$ to $x$ is a subset of the segment
from $z_{i-1}$ to $x$, hence agrees with $M_i$ on that segment.
By construction, from $z_{i}$ to $x$, we have agreement of $M_i$ with
$M_{i+1}$.  Use transitivity.

Finally, from $y_i$ to $z_i$, we have agreement of $M_i$ with $L$.
By construction $M_i^+$ follows $M_i$ from $n^{-1}y_i$ to $n z_i$.
The conclusion follows.
\end{proof}

\begin{lemma}\guid{LFWKMQW} 
We have
\[
M_i^+: \text{follow } L \text{ from } n^{-1} y_i \text{ to } n z_i
  \text{ and follow } F^c_x \text{ from } nz_i \text{ to } n^{-1} y_i,
\]
\end{lemma} 

\begin{proof} The previous lemma allows us to replace $M_i$
with $L$ in the given  segment.
\end{proof}

Our description of the points $y_i$ and $z_i$ gives the following
conclusion.
