(* ========================================================================== *)
(* FLYSPECK - BOOK FORMALISATION                                              *)
(*                                                                            *)
(* Proof: DLWCHEM                                                           *)
(* Chapter: Packing                                                           *)
(* Author: Dang Tat Dat                                                       *)
(* Date:   In progress                                                      *)
(* ========================================================================== *)

needs "/home/nyx/flyspeck/working/flyspeck_needs.hl";;

(* ** Load parent files ** *)
flyspeck_needs "nonlinear/ineq.hl";;
flyspeck_needs "general/sphere.hl";;

flyspeck_needs "packing/pack_defs.hl";;
flyspeck_needs "tame/tame_defs.hl";;

(* Set Flyspeck base directory *)

let flyspeck_basedir = "/home/nyx/flyspeck/working/";;

(* Load definition modules *)

needs (flyspeck_basedir ^ "packing/half_spaces_def.hl");;


(*needs (flyspeck_basedir ^ "packing/polyhedron_def.hl");;*)

(* Load goal module *)


(* ** Proof module type ** *)


(* ** Proof module ** *)

open Sphere;;
open Vol1;;
open Pack_defs;;
open Tame_defs;;
open Ineq;;
open Fan;;
open Hypermap;;
open Half_spaces_def;;
(*open Polyhedron_def;;*)

(*--------------Definition---------------------------------------------------*)
let V_SET = 
   new_definition 
    `V_SET = {x:real^3| ~(x IN ball(vec 0,&2))}`;; 
   
let weakly_saturated_def = 
  new_definition 
    `!(V_SET:real^3->bool) (r:real) (r':real).
        weakly_saturated V_SET r r' <=> 
             (!(p:real^3).
              &2 <= dist(vec 0,p) /\ dist(vec 0,p) <= r' ==>
                (?(u:real^3). u IN V_SET /\ dist(u,p) < r))`;;

let r = 
    new_definition
     `r = &2` ;;

let r' = 
    new_definition
     `r' = &2 * h0` ;;

let g_fun =
    new_definition 
    `(g_fun) (x:real^3) = (acs(dist(vec 0, x)/(&2))) - (pi/(&6))` ;; 

let bijections = 
    new_definition 
     ` bijections (H) (K) <=> 
       (?f g.
          (!x. x IN H ==> f x IN K /\ g (f x) = x) /\
          (!y. y IN K ==> g y IN H /\ f (g y) = y))`;;


(*-------------------------Fan   Definiton-----------------------------------*)

let CASE_FAN_FINITE = new_definition `CASE_FAN_FINITE (V:real^3 -> bool,E:(real^3 ->bool)->bool) <=> FINITE V /\ ~(V SUBSET {})`;;

let CASE_FAN_ORIGIN = new_definition `CASE_FAN_ORIGIN (V:real^3 -> bool,E:(real^3 ->bool)->bool) <=> ~((vec 0) IN (V))`;;

let CASE_FAN_INDEPENDENCE = 
  new_definition `CASE_FAN_INDEPENDENCE (V:real^3 -> bool,E:(real^3 ->bool)->bool) <=> 
  (!e.  e IN E ==> ~collinear ({vec 0} UNION e))`;;
 
let CASE_FAN_INTERSECTION =  
  new_definition`CASE_FAN_INTERSECTION(V:real^3 -> bool,E:(real^3 ->bool)->bool)<=> 
  (!e1 e2. (e1 IN E UNION {{v}| v IN V}) /\ (e2 IN E UNION {{v}| v IN V})
  ==> ((aff_ge {vec 0 } e1) INTER (aff_ge {vec 0} e2) = aff_ge {vec 0} (e1 INTER e2)))`;;

let FANO =
  new_definition `FANO(V:real^3 -> bool,E:(real^3 ->bool)->bool) <=> 
  ((UNIONS E) SUBSET V) /\ graph(E) /\ CASE_FAN_FINITE(V,E) /\ CASE_FAN_ORIGIN(V,E)/\
  CASE_FAN_INDEPENDENCE(V,E)/\ CASE_FAN_INTERSECTION(V,E)`;;

let FANO_OF_FAN = prove( `!(V:real^3 -> bool)(E:(real^3 ->bool)->bool). (FAN(vec 0 , V , E) <=> FANO(V,E))`, 
  REWRITE_TAC[FAN;FANO;CASE_FAN_FINITE;CASE_FAN_ORIGIN;CASE_FAN_INDEPENDENCE;CASE_FAN_INTERSECTION;fan1;fan2;fan6;fan7]);;

(*-------------------------Fan hypermap---------------------------------------*)

let d1_fan_1 =
   new_definition
   `d1_fan_1 (V:real^3 -> bool,E:(real^3 ->bool)->bool) =
   {(v:real^3,w:real^3)| {v,w} IN E}`;;

let d2_fan_1 =
    new_definition
    `d2_fan_1 (V:real^3 -> bool,E:(real^3 ->bool)->bool) = 
      {(v,v)| (v IN V) /\ ((set_of_edge v V E) ={})}`;;

let dark_fan =
    new_definition
    `dark_fan (V:real^3 -> bool,E:(real^3 ->bool)->bool) =
     d1_fan_1 (V,E) UNION d2_fan_1 (V,E)`;;

(*-------------------------------------------------------------------------*)

let azim_x =
   new_definition
   `azim_x (V:real^3->bool) (E:(real^3->bool)->bool) ((v:real^3),(w:real^3))
     = if (CARD (set_of_edge v V E) > 1) then 
     azim (vec 0) v w (sigma_fan (vec 0) V E v w)
     else (&2) * pi`;;

let fully_surrounded_fan =
   new_definition 
    `fully_surrounded_fan (V:real^3->bool) (E:(real^3 ->bool)->bool) <=> (FANO       (V,E)) /\ 
     (!(v:real^3) (w:real^3). (v,w) IN dark_fan (V,E) ==>
     azim_x V E (v,w) < pi)`;;

(*---------------------------------------------------------------------------*)

let interior_point =
    new_definition 
    `interior_point (p:real^3) (P:real^3->bool) 
       <=> ?(r:real).(ball(p,r) SUBSET P)` ;;

let V_P = 
    new_definition
     `V_P (P:real^3-> bool) = {x:real^3| x extreme_point_of P}` ;;

let E_P = 
    new_definition
    `E_P (P:real^3 -> bool) = 
    {{v:real^3,w:real^3}| ~(v=w) /\ (convex hull {v,w}) face_of P}`;;


let w_topo_component =
    new_definition 
     `w_topo_component (P:real^3 -> bool) =
      {(t:real)%(v:real^3)| (v IN (relative_interior P)) /\ (&0 < t)}`;;

let reg =
    new_definition 
     `reg (a:real) (k:real) = (&2)*pi - (&2)*k*(asn(cos(a)*sin(pi/k)))` ;;

let arc_1 =
    new_definition 
    `arc_1 (a:real) (b:real) (c:real) = 
     pi/(&2) - (atn2( (sqrt (ups_x (a*a) (b*b) (c*c))),(a*a + b*b - c*c)))`;;

(*-----------------Some new axiom--------------------------------------------*)
let TARJJUW_concl = `!(V:real^3 -> bool) (g:real^3->real) (r:real) (r':real) P.(&2 <= r) /\ (r <= r') /\ (FINITE V) /\ saturated V /\ packing V /\ 
(weakly_saturated V r r') /\
 P = INTERS {half_spaces g u| (u IN V) /\ (~(vec 0 = u))} /\ polyhedron P ==>
(bounded P)`;;

let TARJJUW = new_axiom TARJJUW_concl;;

(*----------------------------------------------------------------------------*)

let JLIGZGS_concl = `!(V:real^3 -> bool). (polyhedron V) /\ (bounded V) /\ (interior_point (vec 0) V) ==> FANO (fan_of_polyhedron V)`;;

let JLIGZGS = new_axiom JLIGZGS_concl;;

(*---------------------------------------------------------------------------*)

let CZZHBLI_concl_1 = 
    `!(V:real^3 -> bool) (u:real^3) f b.(polyhedron V) /\ (bounded V) /\ (f = {p | p dot u = b } INTER V) ==> (f facet_of (polyhedron V)) `;;

let CZZHBLI_1 = new_axiom CZZHBLI_concl_1;;

(*----------------------------------------------------------------------------*)

let RDWKARC_concl = `~kepler_conjecture /\ (!V. cell_cluster_estimate V) /\
  marchal_inequality
   ==> (?V.  packing V /\ V SUBSET ball_annulus /\ ~(lmfun_ineq_center V))`;;

let RDWKARC = new_axiom  RDWKARC_concl;;


(*---------------------------------------------------------------------------*)

let AMHFNXP_concl =
    `!(P:real^3 -> bool) F WF. 
     (polyhedron P) /\ (bounded P) /\ (interior_point (vec 0) P) /\
     (F = {f|f facet_of P}) /\ (WF = topological_component_yfan (vec 0,fan_of_polyhedron P))   
      ==> bijections (F) (WF)`;;

let AMHFNXP = new_axiom AMHFNXP_concl;;
 
(*---------------------------------------------------------------------------*)

let BSXAQBQ_concl = `!(P:real^3 -> bool)(v:real^3)(w:real^3).(polyhedron P) /\ (bounded P) /\(interior_point (vec 0) P) /\ ((v,w) IN (dark_fan (fan_of_polyhedron P))) ==> azim_x (V_P P) (E_P P) (v,w) < pi`;;

let BSXAQBQ = new_axiom BSXAQBQ_concl;;
(*---------------------------------------------------------------------------*)

let PIIJBJK_concl =`!(V:real^3 -> bool)(E:(real^3->bool)->bool). 
    fully_surrounded_fan V E ==>
     conforming V E`;;

let PIIJBJK = new_axiom PIIJBJK_concl;;
(*---------------------------------------------------------------------------*)

let UVPFEEP_concl1 =`!(V:real^3 -> bool) (E:(real^3->bool)->bool) F WF.
      FANO (V,E) /\ (conforming V E) /\ 
      (WF = topological_component_yfan (vec 0,V,E)) /\ 
      (F = face_set_of_fan (V,E))
      ==> bijections (F) (WF)`;;

let UVPFEEP_1= new_axiom UVPFEEP_concl1;;                                      
(*---------------------------------------------------------------------------*)
let GOTCJAH_concl = `!s f (v:real^3) b WF h k. 
    polyhedron s /\ bounded s /\ (?r. r> &0 /\ ball(vec 0,r) SUBSET s) /\
    f facet_of s /\ 
    f = { p | p dot v = b } INTER s /\ (v IN s) /\
    topological_component_yfan (v,fan_of_polyhedron s) WF /\
    ~(f INTER WF = {}) /\
    rcone_gt (vec 0) v h SUBSET WF /\
    (k = CARD {u | u extreme_point_of f }) 
   ==> &2 * pi - &2* &k * asn (h* sin(pi/ &k)) <= sol WF (v)`;;


let GOTCJAH = new_axiom GOTCJAH_concl;;

(*---------------------------------proof--------------------------------------*)

g `!(V:real^3 -> bool) (x:real). (&1 <=x ) ==> (lmfun x <= &1)`;;
e (REWRITE_TAC [lmfun;h0]);;
e (REPEAT STRIP_TAC);;
e (ASM_CASES_TAC `(x:real) <= #1.26`);;
e (ASM_REWRITE_TAC[]);;
e (PURE_REWRITE_TAC [ARITH_RULE `#1.26 - &1 = #0.26`]);;
e (SUBGOAL_THEN `&0 < #0.26` ASSUME_TAC);; 
e (ARITH_TAC);;
e (SUBGOAL_THEN `(--x:real <= --(&1) )` ASSUME_TAC);;
e (ASM_REWRITE_TAC [REAL_LE_NEG]);;
e (SUBGOAL_THEN `#1.26 + --(x:real) <= #1.26 + --(&1)` ASSUME_TAC);;
e (ASM_REWRITE_TAC [REAL_LE_LADD]);;
e (POP_ASSUM MP_TAC);;
e (REWRITE_TAC [GSYM real_sub]);;
e (STRIP_TAC);;
e (SUBGOAL_THEN `(#1.26 - (x:real)) / #0.26 <= (#1.26 - &1) / #0.26` ASSUME_TAC);;
e (ASM_MESON_TAC [GSYM REAL_LE_DIV2_EQ]);;
e (SUBGOAL_THEN `(#1.26 - &1) / #0.26 = &1` ASSUME_TAC);;
e (ARITH_TAC);;
e (ASM_MESON_TAC[]);;
e (ASM_REWRITE_TAC[]);;
e (ARITH_TAC);;

let thm1 = top_thm();;

(*----------------------------------------------------------------------------*)


g `!(V:real^3->bool) (u:real^3). (packing V) /\ (V SUBSET ball_annulus) /\
   (u IN V) ==> ((&1) <= dist(vec 0,u)/(&2)) `;;
e (REWRITE_TAC [ball_annulus]);;
e (REWRITE_TAC [cball;ball]);;
e (REWRITE_TAC [DIFF]);;
e (REWRITE_TAC [SUBSET]);;
e (REPEAT STRIP_TAC);;
e (POP_ASSUM MP_TAC);;
e (POP_ASSUM MP_TAC);;
e (DISCH_THEN (LABEL_TAC "F1"));;
e (STRIP_TAC);;
e (USE_THEN "F1" (MP_TAC o SPEC `u:real^3`));;
e (STRIP_TAC);;
e (SUBGOAL_THEN `(u:real^3) IN
          {x:real^3 | x IN {y:real^3 | dist (vec 0,y) <= &2 * h0} /\
               ~(x IN {y | dist (vec 0,y) < &2})} ` ASSUME_TAC);;
e (ASM_MESON_TAC []);;
e (POP_ASSUM MP_TAC);;
e (REWRITE_TAC [IN_ELIM_THM]);;
e (STRIP_TAC);;
e (POP_ASSUM MP_TAC);;
e (REWRITE_TAC [REAL_NOT_LT]);;
e (STRIP_TAC);;
e (SUBGOAL_THEN `(&0) < (&2)` ASSUME_TAC);;
e (ARITH_TAC);;
e (SUBGOAL_THEN `(&2)/(&2) <= dist (vec 0,u:real^3)/(&2)` ASSUME_TAC);;
e (ASM_MESON_TAC [REAL_LE_DIV2_EQ]);;
e (POP_ASSUM MP_TAC);;
e (REWRITE_TAC [ARITH_RULE `(&2)/(&2) = (&1)`]);;

let thm2 = top_thm();;

(*----------------------------------------------------------------------------*)

g `!(V:real^3->bool).(FINITE V) /\ (packing V) /\ (V SUBSET ball_annulus) /\ 
    (&(CARD V) <= (&12)) ==> 
    sum V (\v. lmfun (dist (vec 0,v) / &2)) <= (&12)`;;
e (REPEAT STRIP_TAC);;
e (SUBGOAL_THEN `!(v:real^3). (v IN (V:real^3->bool)) ==> (&1) <= dist(vec 0,v)/(&2)` ASSUME_TAC);;
e (REPEAT STRIP_TAC);;
e (ASM_MESON_TAC [thm2]);;
e (POP_ASSUM (LABEL_TAC "F1"));;
e (USE_THEN "F1" (MP_TAC o SPEC `v:real^3`));;
e (STRIP_TAC);;
e (SUBGOAL_THEN `!(v:real^3). (&1) <= dist(vec 0,v)/(&2) ==> lmfun (dist (vec 0,v) / &2) <= (&1)` ASSUME_TAC);;
e (STRIP_TAC);;
e (MESON_TAC [thm1]);;
e (POP_ASSUM (LABEL_TAC "F2"));;
e (USE_THEN "F2" (MP_TAC o SPEC `v:real^3`));;
e (STRIP_TAC);;
e (SUBGOAL_THEN `!(v:real^3). (v IN (V:real^3->bool)) ==> lmfun (dist (vec 0,v) / &2) <= (&1)` ASSUME_TAC);;
e (STRIP_TAC);;
e (ASM_MESON_TAC[]);;
e (SUBGOAL_THEN `sum (V:real^3->bool) (\v. lmfun (dist (vec 0,v) / &2)) <= (&(CARD V)) * (&1)` ASSUME_TAC);;
e (ASM_MESON_TAC [SUM_BOUND]);;
e (POP_ASSUM MP_TAC);;
e (REWRITE_TAC [ARITH_RULE `&(CARD (V:real^3->bool)) * &1 =  &(CARD V)`]);;
e (STRIP_TAC);;
e (ASM_MESON_TAC[REAL_LE_TRANS]);;

let thm3 = top_thm();;

(*----------------------------------------------------------------------------*)
g `!(V:real^3->bool) (u:real^3).(packing V) /\ (V SUBSET ball_annulus) /\ (weakly_saturated V r r') /\ (u IN V) ==> (dist (vec 0,u) / &2 <= h0)`;;
e (REPEAT GEN_TAC);;
e (REWRITE_TAC [packing;ball_annulus]);;
e (STRIP_TAC);;
e (POP_ASSUM MP_TAC);;
e (POP_ASSUM MP_TAC);;
e (POP_ASSUM MP_TAC);;
e (REWRITE_TAC [cball;ball]);;
e (REWRITE_TAC [SUBSET]);;
e (REWRITE_TAC [DIFF]);;
e (REWRITE_TAC [IN_ELIM_THM]);;
e (DISCH_THEN (LABEL_TAC "F1"));;
e (REPEAT STRIP_TAC);;
e (USE_THEN "F1" (MP_TAC o SPEC `u:real^3`));;
e (STRIP_TAC);;
e (SUBGOAL_THEN `&0 < &2` ASSUME_TAC);;
e (ARITH_TAC);;
e (SUBGOAL_THEN `dist (vec 0,u:real^3) <= (&2) * h0` ASSUME_TAC);;
e (ASM_MESON_TAC[]);;
e (POP_ASSUM MP_TAC);;I
e (FIRST_X_ASSUM MP_TAC);;
e (ABBREV_TAC `uu = dist (vec 0, (u:real^3)) `);;
e (MESON_TAC[REAL_LE_LDIV_EQ; REAL_MUL_SYM]);;

let thm4 = top_thm();;


let thm5_t = `!(V:real^3->bool). packing V /\ packing_calcs /\
  V SUBSET ball_annulus /\ ~(lmfun_ineq_center V) 
  ==> &12 < &(CARD V)`;;

let thm5 = new_axiom thm5_t;;
(*-------------------------------------------------------------------------*)
let IN_DOUBLE = prove(`!x y z:real^3. x IN {y,z} <=> x = y  \/ x = z`,SET_TAC[]);;

(* proof CARD V = CARD {f|f facet_of V}*)

let CARD_P_1 = `!(V:real^3 -> bool) (P:real^3 -> bool).(FINITE V) /\ saturated V /\ packing V /\ 
(weakly_saturated V r r') /\ P = INTERS {half_spaces g_fun u| (u IN V) /\ (~(vec 0 = u))} /\ (polyhedron P) /\ (bounded P) /\ (P SUBSET ball_annulus) ==> (CARD V) = (CARD {f|f facet_of P})`;;

let CARD_1 = new_axiom CARD_P_1;;


(*---------------------------------------------------------------------------*)
(*Proof CARD {f|f facet_of V} = CARD (topological_component_yfan (vec 0,fan_of_polyhedron V)) *)

let CARD_P_2 = `!(V:real^3 -> bool) (P:real^3 -> bool).(FINITE V) /\ saturated V /\ packing V /\ 
(weakly_saturated V r r') /\ P = INTERS {half_spaces g_fun u| (u IN V) /\ (~(vec 0 = u))} /\ (polyhedron P) /\ (bounded P) /\ (P SUBSET ball_annulus) ==> CARD {f|f facet_of P} = CARD (topological_component_yfan (vec 0,fan_of_polyhedron P))`;;

let CARD_2 = new_axiom CARD_P_2;;


(*Proof CARD (topological_component_yfan (vec 0,fan_of_polyhedron V)) =
   CARD (face_set_of_fan (fan_of_polyhedron V))  *)

let CARD_P_3 = `!(P:real^3 -> bool).(polyhedron P) /\ (bounded P) /\ (P SUBSET ball_annulus) ==> CARD (topological_component_yfan (vec 0,fan_of_polyhedron P)) = CARD (face_set_of_fan (fan_of_polyhedron P))`;;


let CARD_3 = new_axiom CARD_P_3;;
(*----------------------------------------------------------------------------*)
g `!(V:real^3 -> bool) (P:real^3 -> bool).(FINITE V) /\ saturated V /\ packing V /\ 
(weakly_saturated V r r') /\ P = INTERS {half_spaces g_fun u| (u IN V) /\ (~(vec 0 = u))} /\ (polyhedron P) /\ (bounded P) /\ (P SUBSET ball_annulus)
  ==> CARD V =  CARD (face_set_of_fan (fan_of_polyhedron P))`;;
e (REPEAT GEN_TAC);;
e (STRIP_TAC);;
e (SUBGOAL_THEN `(CARD (V:real^3 -> bool)) = (CARD {f|f facet_of (P:real^3->bool)})` ASSUME_TAC);;
e (ASM_MESON_TAC [CARD_1]);;
e (SUBGOAL_THEN `(CARD {f|f facet_of (P:real^3 -> bool)}) = CARD (topological_component_yfan (vec 0,fan_of_polyhedron P)) ` ASSUME_TAC);;
e (ASM_MESON_TAC [CARD_2]);;
e (SUBGOAL_THEN `CARD (topological_component_yfan (vec 0,fan_of_polyhedron (P:real^3 -> bool))) =  CARD (face_set_of_fan (fan_of_polyhedron P)) ` ASSUME_TAC);;
e (ASM_MESON_TAC [CARD_3]);;
e (ASM_MESON_TAC[]);;

let CARD_4 = top_thm();;

(*---------------------------------------------------------------------------*)

let CARD_P_5 = `!(V:real^3 -> bool) (P:real^3 -> bool).(FINITE V) /\ saturated V /\ packing V /\ 
(weakly_saturated V r r') /\ P = INTERS {half_spaces g_fun u| (u IN V) /\ (~(vec 0 = u))} /\ (polyhedron P) /\ (bounded P) /\ (P SUBSET ball_annulus) /\ packing_calcs /\
~(lmfun_ineq_center P) ==>
nsum (face_set_of_fan (fan_of_polyhedron P)) (\u:real^3#real^3->bool. (CARD u))
 = CARD (dart_of_fan (fan_of_polyhedron P))`;;

let CARD_5 = new_axiom CARD_P_5;;

(*---------------------------------------------------------------------------*)
let th1_T = `!(V:real^3 -> bool) (P:real^3 -> bool).(FINITE V) /\ saturated V /\ packing V /\ 
(weakly_saturated V r r') /\ P = INTERS {half_spaces g_fun u| (u IN V) /\ (~(vec 0 = u))} /\ (polyhedron P) /\ (bounded P) /\ (P SUBSET ball_annulus) /\ packing_calcs /\
~(lmfun_ineq_center P) ==> 
   connected_hypermap (hypermap_of_fan (fan_of_polyhedron P))`;;

let th1 = new_axiom th1_T;;

let th2_T = `!(V:real^3 -> bool) (P:real^3 -> bool).(FINITE V) /\ saturated V /\ packing V /\ 
(weakly_saturated V r r') /\ P = INTERS {half_spaces g_fun u| (u IN V) /\ (~(vec 0 = u))} /\ (polyhedron P) /\ (bounded P) /\ (P SUBSET ball_annulus) /\ packing_calcs /\
~(lmfun_ineq_center P)  ==> 
   plain_hypermap (hypermap_of_fan (fan_of_polyhedron P))`;;

let th2 = new_axiom th2_T;;

let th3_T = `!(V:real^3 -> bool) (P:real^3 -> bool).(FINITE V) /\ saturated V /\ packing V /\ 
(weakly_saturated V r r') /\ P = INTERS {half_spaces g_fun u| (u IN V) /\ (~(vec 0 = u))} /\ (polyhedron P) /\ (bounded P) /\ (P SUBSET ball_annulus) /\ packing_calcs /\
~(lmfun_ineq_center P)  ==> 
   planar_hypermap (hypermap_of_fan (fan_of_polyhedron P))`;;

let th3 = new_axiom th3_T;;

let th4_T = `!(V:real^3 -> bool) (P:real^3 -> bool).(FINITE V) /\ saturated V /\ packing V /\ 
(weakly_saturated V r r') /\ P = INTERS {half_spaces g_fun u| (u IN V) /\ (~(vec 0 = u))} /\ (polyhedron P) /\ (bounded P) /\ (P SUBSET ball_annulus) /\ packing_calcs /\
~(lmfun_ineq_center P)  ==> 
   (!x. x IN dart (hypermap_of_fan (fan_of_polyhedron P)) ==> ~(edge_map (hypermap_of_fan (fan_of_polyhedron P)) x = x) /\ 3 <= CARD (node (hypermap_of_fan (fan_of_polyhedron P)) x))`;;

let th4 = new_axiom th4_T;;
(*---------------------------------------------------------------------------*)
(*Dart Bound*)

let th5_T = `!(V:real^3 -> bool) (P:real^3 -> bool).(FINITE V) /\ saturated V /\ packing V /\ 
(weakly_saturated V r r') /\ P = INTERS {half_spaces g_fun u| (u IN V) /\ (~(vec 0 = u))} /\ (polyhedron P) /\ (bounded P) /\ (P SUBSET ball_annulus) /\ packing_calcs /\
~(lmfun_ineq_center P)  ==> 
  CARD (dart_of_fan (fan_of_polyhedron P)) <= 
   (6*(CARD (face_set_of_fan (fan_of_polyhedron P)))-12)`;;

let th5 = new_axiom th5_T;;

(*--------------------------------------------------------------------------*)

g `!(V:real^3 -> bool) (P:real^3 -> bool).(FINITE V) /\ saturated V /\ packing V /\ 
(weakly_saturated V r r') /\ P = INTERS {half_spaces g_fun u| (u IN V) /\ (~(vec 0 = u))} /\ (polyhedron P) /\ (bounded P) /\ (P SUBSET ball_annulus) /\ packing_calcs /\
~(lmfun_ineq_center P)  ==> 
nsum (face_set_of_fan (fan_of_polyhedron P)) (\u:real^3#real^3->bool. (CARD u))
 <= (6*(CARD V)-12)`;;
e (REPEAT GEN_TAC);;
e (STRIP_TAC);;

(*SUBGOAL 1*)
e (SUBGOAL_THEN `nsum (face_set_of_fan (fan_of_polyhedron (P:real^3 -> bool))) (\u:real^3#real^3->bool. (CARD u))
 = CARD (dart_of_fan (fan_of_polyhedron P))` ASSUME_TAC);; 
e (ASM_MESON_TAC[CARD_5]);;

(*SUBGOAL 2*)
e (SUBGOAL_THEN `CARD (V:real^3 -> bool) =  CARD (face_set_of_fan (fan_of_polyhedron P))` ASSUME_TAC);;
e (ASM_MESON_TAC [CARD_4]);;
(*SUBGOAL 3*)
e (SUBGOAL_THEN `CARD (dart_of_fan (fan_of_polyhedron (P:real^3 -> bool))) <= 
   (6*(CARD (face_set_of_fan (fan_of_polyhedron P)))-12)` ASSUME_TAC);;
e (ASM_MESON_TAC[th5]);;

e (ASM_MESON_TAC[]);;

let th6 = top_thm();;

(*--------------------------------------------------------------------------*)
let th7_concl = `!V f (v:real^3) b X k.(polyhedron V) /\ (bounded V) /\ packing V /\ packing_calcs /\
  V SUBSET ball_annulus /\ ~(lmfn_ineq_center V) /\ f facet_of V /\ 
    f = {p | p dot v = b } INTER V /\
    topological_component_yfan (vec 0,fan_of_polyhedron V) X /\
    ~(f INTER X = {}) /\
    rcone_gt (vec 0) v (norm v) SUBSET X /\
    (k = CARD {u | u extreme_point_of f }) ==> &4 * pi = sum V (\v. sol X (v))`;;

let th7 = new_axiom th7_concl;;
(*----------------------------------------------------------------------------*)
let th8_concl = `!V f (v:real^3) b X k.(polyhedron V) /\ (bounded V) /\ packing V /\ packing_calcs /\
  V SUBSET ball_annulus /\ ~(lmfn_ineq_center V) /\ f facet_of V /\ 
    f = {p | p dot v = b } INTER V /\
    topological_component_yfan (vec 0,fan_of_polyhedron V) X /\
    ~(f INTER X = {}) /\
    rcone_gt (vec 0) v (norm v) SUBSET X /\
    (k = CARD {u | u extreme_point_of f }) 
  ==> 
sum V (\v. regular_spherical_polygon_area (cos (acs (((norm v) / &2)/(&2)) - pi / &6)) (&k)) <= sum V (\v. sol X (v))`;;

let th8 = new_axiom th8_concl;;

(*----------------------------------------------------------------------------*)

let th9_concl = `!(V:real^3->bool) k.(polyhedron V) /\ (bounded V) /\ packing V /\ packing_calcs /\ V SUBSET ball_annulus /\ ~(lmfn_ineq_center V) /\ (k = nsum (face_set_of_fan (fan_of_polyhedron V)) (\u:real^3#real^3->bool. (CARD u))) ==>
#0.591* (&(CARD V)) - #0.0331 * (&k)  + #0.506 * (sum V (\v. lmfun (((norm v) / &2)/(&2)))) <= sum V (\v. regular_spherical_polygon_area (cos (acs (((norm v) / &2)/(&2)) - pi / &6)) (&k))`;; 


let th9 = new_axiom th9_concl;;

let th10_concl = `!(V:real^3->bool) k.(polyhedron V) /\ (bounded V) /\ packing V /\ packing_calcs /\ V SUBSET ball_annulus /\ ~(lmfn_ineq_center V) /\ (k = nsum (face_set_of_fan (fan_of_polyhedron V)) (\u:real^3#real^3->bool. (CARD u))) ==>
#0.591 * (&(CARD V)) - #0.0331 * &(6*(CARD V)-12) + #0.506 * (&12) <= #0.591* (&(CARD V)) - #0.0331 * (&k)  + #0.506 * (sum V (\v. lmfun (((norm v) / &2)/(&2))))`;; 

let th10 = new_axiom th10_concl;;
(*--------------------------------------------------------------------------*)
let REAL_SUB2_SUB2 = prove(`!x y z:real. x - (y - z) = x - y + z`,REPEAT GEN_TAC THEN SUBGOAL_THEN `--(y:real - z) = z - y` ASSUME_TAC THENL [REWRITE_TAC [REAL_NEG_SUB];POP_ASSUM MP_TAC THEN PURE_REWRITE_TAC [real_sub] THEN STRIP_TAC THEN PURE_REWRITE_TAC [REAL_NEG_ADD;REAL_NEGNEG] THEN REWRITE_TAC[REAL_ADD_ASSOC]]);;

let REAL_ADD2_ADD2 = prove (`!x y z:real. x + (y + z) = x + y + z`,SET_TAC[]);;

g `(pi < #3.15) ==> (&4 * pi - #6.4692) / #0.3924 < &16`;;
e (STRIP_TAC);;
e (SUBGOAL_THEN `&0 < &4` ASSUME_TAC);;
e (ARITH_TAC);;
e (SUBGOAL_THEN `&4*pi < &4 * #3.15` ASSUME_TAC);;
e (ASM_MESON_TAC[REAL_LT_LMUL_EQ]);;
e (POP_ASSUM MP_TAC);;
e (PURE_REWRITE_TAC [ARITH_RULE `&4 * #3.15= #12.6`]);;
e (STRIP_TAC);;
e (SUBGOAL_THEN `&4*pi + (--(#6.4692)) < #12.6 + (--(#6.4692))` ASSUME_TAC);;
e (ASM_REWRITE_TAC[REAL_LT_RADD]);;
e (POP_ASSUM MP_TAC);;
e (PURE_REWRITE_TAC [GSYM real_sub]);;
e (PURE_REWRITE_TAC [ARITH_RULE `#12.6 - #6.4692 = #6.1308`]);;
e (SUBGOAL_THEN `&0 < #0.3924` ASSUME_TAC);;
e (ARITH_TAC);;
e (STRIP_TAC);;
e (SUBGOAL_THEN `(&4 * pi - #6.4692)/( #0.3924) < #6.1308 / #0.3924` ASSUME_TAC);;
e (ASM_MESON_TAC[GSYM REAL_LT_DIV2_EQ]);;
e (SUBGOAL_THEN `#6.1308 / #0.3924 < &16` ASSUME_TAC);;
e (ARITH_TAC);;
e (ASM_MESON_TAC[REAL_LT_TRANS]);;

let th11 = top_thm();;

g `!(V:real^3->bool).(pi < #3.15) /\ ( &12 < &(CARD V)) /\ #0.591 * (&(CARD V)) - #0.0331 * &(6*(CARD V)-12) + #0.506 * (&12) <= &4 * pi ==> &(CARD V) < &16`;;
e (GEN_TAC);;
e (STRIP_TAC);;
e (SUBGOAL_THEN `12 < CARD (V:real^3->bool)` ASSUME_TAC);;
e (ASM_MESON_TAC [REAL_OF_NUM_LT]);;
e (SUBGOAL_THEN ` 12 < 6 * (CARD (V:real^3->bool))` ASSUME_TAC);;
e (SUBGOAL_THEN `6 * 12 < 6 * (CARD (V:real^3->bool))` ASSUME_TAC);;
e (SUBGOAL_THEN `~(6 = 0)` ASSUME_TAC);;
e (ARITH_TAC);;
e (ASM_MESON_TAC[LT_LMULT]);;
e (POP_ASSUM MP_TAC);;
e (PURE_REWRITE_TAC [ARITH_RULE `6 * 12 = 72`]);;
e (STRIP_TAC);;
e (SUBGOAL_THEN ` 12 < 72 ` ASSUME_TAC);;
e (ARITH_TAC);;
e (ASM_MESON_TAC[LT_TRANS]);;
e (SUBGOAL_THEN ` 12 <= 6 * (CARD (V:real^3->bool))` ASSUME_TAC);;
e (ASM_MESON_TAC[LT_IMP_LE]);;
e (SUBGOAL_THEN `&(6*(CARD (V:real^3->bool))-12) = &(6 *(CARD V)) - &12` ASSUME_TAC);; 
e (ASM_MESON_TAC[REAL_OF_NUM_SUB]);;
e (SUBGOAL_THEN `&(6*(CARD (V:real^3->bool))) = &(6) * &(CARD V)` ASSUME_TAC);; 
e (MESON_TAC[REAL_OF_NUM_MUL]);;
e (SUBGOAL_THEN `&(6*(CARD (V:real^3->bool))-12) = &(6) * &(CARD V) - &12` ASSUME_TAC);;
e (ASM_MESON_TAC[]);;
e (SUBGOAL_THEN `#0.591 * (&(CARD (V:real^3 -> bool))) - #0.0331 * (&(6) * &(CARD V) - &12) + #0.506 * (&12)<= &4 * pi` ASSUME_TAC);;
e (ASM_MESON_TAC[]);;
e (SUBGOAL_THEN `#0.0331 * (&(6) * &(CARD (V:real^3->bool)) - &12) = #0.0331 * &(6) * &(CARD (V)) -  #0.0331 * &12` ASSUME_TAC);;
e (MESON_TAC[REAL_SUB_LDISTRIB]);;
e (POP_ASSUM MP_TAC);;
e (PURE_REWRITE_TAC [ARITH_RULE `#0.0331 * &12 = #0.3972`]);;
e (STRIP_TAC);;
e (SUBGOAL_THEN `#0.591 * (&(CARD (V:real^3 -> bool))) - (#0.0331 * &6 * &(CARD V) - #0.3972) + #0.506 * (&12)<= &4 * pi` ASSUME_TAC);;
e (ASM_MESON_TAC[]);;
e (POP_ASSUM MP_TAC);;
e (PURE_REWRITE_TAC [ARITH_RULE `#0.506 * &12 = #6.072`]);;
e (PURE_REWRITE_TAC [REAL_SUB2_SUB2 ]);;
e (SUBGOAL_THEN `#0.0331 * &6 * &(CARD (V:real^3->bool)) = (#0.0331 * &6) * &(CARD V) ` ASSUME_TAC);;
e (REWRITE_TAC[REAL_MUL_ASSOC]);;
e (POP_ASSUM MP_TAC);;
e (PURE_REWRITE_TAC [ARITH_RULE `#0.0331 * &6 = #0.1986`]);;
e (STRIP_TAC);;
e (ASM_REWRITE_TAC[]);;
e (SUBGOAL_THEN `#0.591 * &(CARD (V:real^3->bool)) - #0.1986 * &(CARD V)
= (#0.591 - #0.1986) * &(CARD V)` ASSUME_TAC);;
e (MESON_TAC[REAL_SUB_RDISTRIB]);;
e (POP_ASSUM MP_TAC);;
e (PURE_REWRITE_TAC [ARITH_RULE `(#0.591 - #0.1986) = #0.3924`]);;
e (STRIP_TAC);;
e (SUBGOAL_THEN `#0.591 * &(CARD (V:real^3->bool)) - #0.1986 * &(CARD V) + #0.3972 = #0.3924 * &(CARD V) + #0.3972` ASSUME_TAC);;
e (ASM_MESON_TAC[]);;
e (ASM_REWRITE_TAC[]);;
e (SUBGOAL_THEN `(#0.3924 * &(CARD (V:real^3->bool)) + #0.3972) + #6.072 = 
#0.3924 * &(CARD (V:real^3->bool)) + (#0.3972 + #6.072)` ASSUME_TAC);;
e (MESON_TAC[REAL_ADD_AC]);;
e (ASM_REWRITE_TAC[]);;
e (SUBGOAL_THEN `#0.3972 + #6.072 = #6.4692` ASSUME_TAC);;
e (ARITH_TAC);;
e (ASM_REWRITE_TAC[]);;
e (STRIP_TAC);;
e (SUBGOAL_THEN `(#0.3924 * &(CARD (V:real^3->bool)) + #6.4692) + (--(#6.4692)) <=  &4 * pi + (--(#6.4692))` ASSUME_TAC);;
e (ASM_REWRITE_TAC [REAL_LE_RADD]);;
e (POP_ASSUM MP_TAC);;
e (ONCE_REWRITE_TAC [REAL_ADD_AC]);;
e (PURE_REWRITE_TAC [GSYM real_sub]);;
e (PURE_REWRITE_TAC [ARITH_RULE `#6.4692 - #6.4692 = &0`]);;
e (PURE_REWRITE_TAC [REAL_ADD_RID]);;
e (ONCE_REWRITE_TAC [REAL_ADD_AC]);;
e (PURE_REWRITE_TAC [GSYM real_sub]);;
e (SUBGOAL_THEN `&0 < (#0.3924)` ASSUME_TAC);;
e (ARITH_TAC);;
e (STRIP_TAC);;
e (SUBGOAL_THEN `&(CARD (V:real^3->bool)) <= (&4 * pi - #6.4692)/(#0.3924)` ASSUME_TAC);;
e (POP_ASSUM MP_TAC);;
e (PURE_REWRITE_TAC [ARITH_RULE `#0.3924 * &(CARD (V:real^3->bool)) = &(CARD V)*(#0.3924)`]);;
e (ASM_MESON_TAC [GSYM REAL_LE_RDIV_EQ]);;
e (SUBGOAL_THEN `(&4 * pi - #6.4692) / #0.3924 < &16` ASSUME_TAC);;
e (ASM_MESON_TAC[th11]);;
e (ASM_MESON_TAC[REAL_LET_TRANS]);;

let th12 = top_thm();;


(*---------------------------------------------------------------------------*)
g `!(V:real^3->bool).packing V /\ packing_calcs /\
  V SUBSET ball_annulus /\ ~(lmfun_ineq_center V) ==>
   (CARD V = 13 \/ CARD V = 14 \/ CARD V = 15)`;;
e (GEN_TAC);;
e (STRIP_TAC);;
e (SUBGOAL_THEN `&12 < &(CARD (V:real^3->bool))` ASSUME_TAC);; 
e (ASM_MESON_TAC [thm5]);;
e (SUBGOAL_THEN `&(CARD (V:real^3->bool)) <= &16` ASSUME_TAC);;


