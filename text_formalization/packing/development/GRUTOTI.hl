
let KY_CHEAT_TAC = MP_TAC (mk_thm([],`F`)) THEN SET_TAC[];;

#use "/home/vu/flyspeck/working/marchal_cells_3.hl";;
(* back up for the proof *)

let GRUTOTI1_concl = 
`!V u0 u1 e.
     saturated V /\
     packing V /\
     u0 IN V /\
     u1 IN V /\
     ~(u0 = u1) /\
     hl [u0;u1] < sqrt (&2) /\
     e = {u0, u1}
     ==> sum {X | e IN edgeX V X} (\t. dihX V t (u0,u1)) = &2 * pi`;;

g GRUTOTI1_concl;;
e (REPEAT STRIP_TAC);;
e (NEW_GOAL `barV V 1 [u0;u1:real^3]`);;
e (MATCH_MP_TAC HL_LE_SQRT2_IMP_BARV_1);;
e (ASM_REWRITE_TAC[]);;
e (NEW_GOAL 
  `{k | k IN 1..3 /\
        voronoi_list V [u0;u1:real^3] =
        UNIONS
          {convex hull
          ({omega_list_n V vl i | i IN 1..k - 1} UNION
            voronoi_list V vl) | vl | barV V k vl /\
                                      truncate_simplex 1 vl = [u0;u1]}} =
             1..3`);;
e (MATCH_MP_TAC Rogers.GLTVHUM_lemma1);;
e (ASM_REWRITE_TAC[] THEN ARITH_TAC);;
e (NEW_GOAL 
 `3 IN {k | k IN 1..3 /\
          voronoi_list V [u0; u1] =
          UNIONS
          {convex hull
         ({omega_list_n V vl i | i IN 1..k - 1} UNION voronoi_list V vl) | vl | 
          barV V k vl /\
          truncate_simplex 1 vl = [u0; u1]}}`);;
e (ASM_REWRITE_TAC[IN_NUMSEG] THEN ARITH_TAC);;
e (UP_ASM_TAC THEN ONCE_REWRITE_TAC[IN] THEN REWRITE_TAC[IN_ELIM_THM]);;
e (REWRITE_WITH 
   `UNIONS
   {convex hull ({omega_list_n V vl i | i IN 1..3 - 1} UNION voronoi_list V vl)      | vl | barV V 3 vl /\
           truncate_simplex 1 vl = [u0; u1]} = 
   UNIONS {convex hull {omega_list_n V vl 1, omega_list_n V vl 2, 
           omega_list_n V vl 3} | vl | barV V 3 vl /\
                                       truncate_simplex 1 vl = [u0; u1]}`);;
e (ONCE_REWRITE_TAC[SET_EQ_LEMMA]);;
e (REWRITE_TAC[IN_UNIONS] THEN ONCE_REWRITE_TAC[IN] THEN 
   REWRITE_TAC[IN_ELIM_THM]);;
e (REPEAT STRIP_TAC);;
e (EXISTS_TAC `t:real^3->bool` THEN ASM_REWRITE_TAC[]);;
e (EXISTS_TAC `vl:(real^3)list`);;
e (ASM_REWRITE_TAC[]);;
e (NEW_GOAL `?a. voronoi_list V vl = {a} /\
                    a = circumcenter (set_of_list vl) /\
                    hl vl = dist (HD vl,a)`);;
e (MATCH_MP_TAC Marchal_cells_2_new.VORONOI_LIST_3_SINGLETON_EXPLICIT);;
e (ASM_REWRITE_TAC[]);;
e (UP_ASM_TAC THEN STRIP_TAC);;

e (NEW_GOAL `omega_list_n V vl 3 IN voronoi_list V vl`);;
e (REWRITE_WITH `omega_list_n V vl 3 = omega_list V vl`);;
e (REWRITE_TAC[OMEGA_LIST]);;
e (REWRITE_WITH `LENGTH (vl:(real^3)list) = 3 + 1 /\ 
                 CARD (set_of_list vl) = 3 + 1`);;
e (MATCH_MP_TAC Rogers.BARV_IMP_LENGTH_EQ_CARD);;
e (EXISTS_TAC `V:real^3->bool`);;
e (ASM_REWRITE_TAC[]);;
e (REWRITE_TAC[ARITH_RULE `(3 + 1) - 1 = 3`]);;
e (MATCH_MP_TAC Packing3.OMEGA_LIST_IN_VORONOI_LIST);;
e (EXISTS_TAC `3` THEN ASM_REWRITE_TAC[]);;
e (NEW_GOAL `omega_list_n V vl 3 = a`);;
e (ASM_SET_TAC[]);;
e (ASM_REWRITE_TAC[]);;
e (REWRITE_TAC[ARITH_RULE `3 - 1 = 2`; IN_NUMSEG; 
   ARITH_RULE `1 <= i /\ i <= 2 <=> i = 1 \/ i = 2`]);;
e (REWRITE_WITH `{omega_list_n V vl i | i = 1 \/ i = 2} = 
                 {omega_list_n V vl 1,omega_list_n V vl 2}`);;
e (SET_TAC[]);;
e (REWRITE_WITH `{omega_list_n V vl 1, omega_list_n V vl 2} UNION
   {circumcenter (set_of_list vl)} = {omega_list_n V vl 1, omega_list_n V vl 2,      circumcenter (set_of_list vl)}`);;
e (SET_TAC[]);;

e (EXISTS_TAC `t:real^3->bool` THEN ASM_REWRITE_TAC[]);;
e (EXISTS_TAC `vl:(real^3)list`);;
e (ASM_REWRITE_TAC[]);;
e (NEW_GOAL `?a. voronoi_list V vl = {a} /\
                    a = circumcenter (set_of_list vl) /\
                    hl vl = dist (HD vl,a)`);;
e (MATCH_MP_TAC Marchal_cells_2_new.VORONOI_LIST_3_SINGLETON_EXPLICIT);;
e (ASM_REWRITE_TAC[]);;
e (UP_ASM_TAC THEN STRIP_TAC);;

e (NEW_GOAL `omega_list_n V vl 3 IN voronoi_list V vl`);;
e (REWRITE_WITH `omega_list_n V vl 3 = omega_list V vl`);;
e (REWRITE_TAC[OMEGA_LIST]);;
e (REWRITE_WITH `LENGTH (vl:(real^3)list) = 3 + 1 /\ 
                 CARD (set_of_list vl) = 3 + 1`);;
e (MATCH_MP_TAC Rogers.BARV_IMP_LENGTH_EQ_CARD);;
e (EXISTS_TAC `V:real^3->bool`);;
e (ASM_REWRITE_TAC[]);;
e (REWRITE_TAC[ARITH_RULE `(3 + 1) - 1 = 3`]);;
e (MATCH_MP_TAC Packing3.OMEGA_LIST_IN_VORONOI_LIST);;
e (EXISTS_TAC `3` THEN ASM_REWRITE_TAC[]);;
e (NEW_GOAL `omega_list_n V vl 3 = a`);;
e (ASM_SET_TAC[]);;
e (ASM_REWRITE_TAC[]);;
e (REWRITE_TAC[ARITH_RULE `3 - 1 = 2`; IN_NUMSEG; 
   ARITH_RULE `1 <= i /\ i <= 2 <=> i = 1 \/ i = 2`]);;
e (REWRITE_WITH `{omega_list_n V vl i | i = 1 \/ i = 2} = 
                 {omega_list_n V vl 1,omega_list_n V vl 2}`);;
e (SET_TAC[]);;
e (REWRITE_WITH `{omega_list_n V vl 1, omega_list_n V vl 2} UNION
   {circumcenter (set_of_list vl)} = {omega_list_n V vl 1, omega_list_n V vl 2,      circumcenter (set_of_list vl)}`);;
e (SET_TAC[]);;
e (STRIP_TAC);;

(* ======================================================================= *)

e (ABBREV_TAC `W = aff_gt {u0:real^3} (voronoi_list V [u0;u1])`);;
e (NEW_GOAL `?a. a < &1 /\ rcone_gt (u0:real^3) u1 a SUBSET W`);;

e (ABBREV_TAC `p = circumcenter {u0, u1:real^3}`);;
e (NEW_GOAL `aff_dim (u0 INSERT voronoi_list V [u0;u1]) = &3`);;
e (REWRITE_TAC[AFF_DIM_INSERT]);;
e (COND_CASES_TAC);;
e (NEW_GOAL `F`);;

e (NEW_GOAL `affine hull voronoi_list V [u0; u1] SUBSET 
   affine hull {x | &2 % (u0 - u1) dot x = norm u0 pow 2 - norm u1 pow 2}`);;
e (MATCH_MP_TAC Marchal_cells_2_new.AFFINE_SUBSET_KY_LEMMA);;
e (REWRITE_TAC[VORONOI_LIST; set_of_list; Packing3.VORONOI_SET_2]);;
e (ONCE_REWRITE_TAC[SET_RULE `a INTER b = b INTER a`]);;
e (ASM_SIMP_TAC[Pack2.INTER_VORONOI_SUBSET_BISECTOR]);;
e (NEW_GOAL 
  `affine hull {x | &2 % (u0 - u1) dot x = norm u0 pow 2 - norm u1 pow 2} = 
   {x:real^3 | &2 % (u0 - u1) dot x = norm u0 pow 2 - norm u1 pow 2}`);;
e (REWRITE_TAC[AFFINE_HULL_EQ]);;
e (REWRITE_TAC[AFFINE_HYPERPLANE]);;
e (NEW_GOAL 
 `~(u0 IN {x:real^3 | &2 % (u0 - u1) dot x = norm u0 pow 2 - norm u1 pow 2})`);;
e (REWRITE_TAC[IN; IN_ELIM_THM; NORM_POW_2]);;
e (ONCE_REWRITE_TAC [REAL_ARITH `a = b <=> a - b = &0`]);;
e (REWRITE_TAC[VECTOR_ARITH `&2 % (u0 - u1) dot u0 - (u0 dot u0 - u1 dot u1) = 
                (u0 - u1) dot (u0 - u1)`]);;
e (REWRITE_TAC[DOT_EQ_0] THEN ASM_NORM_ARITH_TAC);;
e (ASM_SET_TAC[]);;
e (ASM_MESON_TAC[]);;
e (REWRITE_TAC[ARITH_RULE `a + &1 = b:int <=> a = b - &1`]);;
e (MATCH_MP_TAC Packing3.AFF_DIM_VORONOI_LIST);;
e (ASM_REWRITE_TAC[]);;

e (NEW_GOAL `aff_dim (u0 INSERT voronoi_list V [u0; u1]) = &(dimindex (:3))`);;
e (ASM_REWRITE_TAC[DIMINDEX_3]);;
e (UP_ASM_TAC THEN REWRITE_TAC[AFF_DIM_EQ_FULL]);;
e (STRIP_TAC);;

e (ABBREV_TAC `S = voronoi_list V [u0;u1]`);;
e (NEW_GOAL `!x. x IN S ==> (x - u0) dot (u1 - u0) = 
                            dist (p, u0) * dist (u1, u0:real^3)`);;
e (REPEAT STRIP_TAC);;
e (NEW_GOAL `p = inv (&2) % (u0 + (u1:real^3))`);;
e (EXPAND_TAC "p" THEN REWRITE_TAC[Rogers.CIRCUMCENTER_2; midpoint]);;
e (REWRITE_TAC[dist]);;
e (REWRITE_WITH `u1 - u0 = &2 % (p - u0:real^3)`);;
e (ASM_REWRITE_TAC[]);;
e (VECTOR_ARITH_TAC);;
e (REWRITE_TAC[NORM_MUL; REAL_ARITH `abs (&2) = &2`;
   REAL_ARITH `a * b * a = b * a pow 2`; NORM_POW_2; DOT_RMUL]);;
e (REWRITE_WITH `(x - u0) dot (p - u0:real^3) = 
                 (p - u0) dot (p - u0) - (x - p) dot (u0 - p)`);;
e (VECTOR_ARITH_TAC);;
e (REWRITE_WITH `(x - p) dot (u0 - p:real^3) = &0`);;
e (EXPAND_TAC "p");;
e (REWRITE_WITH `{u0, u1} = set_of_list [u0; u1:real^3]`);;
e (REWRITE_TAC[set_of_list]);;
e (MATCH_MP_TAC Rogers.MHFTTZN4);;
e (EXISTS_TAC `V:real^3->bool` THEN EXISTS_TAC `1`);;
e (REPEAT STRIP_TAC);;
e (ASM_REWRITE_TAC[]);;
e (ASM_REWRITE_TAC[]);;
e (NEW_GOAL `S SUBSET affine hull voronoi_list V [u0; u1]`);;
e (EXPAND_TAC "S");;
e (REWRITE_TAC[Qzksykg.SET_SUBSET_AFFINE_HULL]);;
e (ASM_SET_TAC[]);;
e (REWRITE_TAC[set_of_list]);;
e (NEW_GOAL `{u0,u1} SUBSET affine hull {u0,u1:real^3}`);;
e (REWRITE_TAC[Qzksykg.SET_SUBSET_AFFINE_HULL]);;
e (ASM_SET_TAC[]);;
e (REAL_ARITH_TAC);;



(* ========================================================================= *)
e (NEW_GOAL `?a. a < &1 /\ rcone_gt u0 u1 a SUBSET aff_ge {u0:real^3} S`);;
e (EXISTS_TAC `a:real`);;
e (STRIP_TAC);;
e (KY_CHEAT_TAC);;  (*  Chon a xong roi chung minh sau *)
e (EXPAND_TAC "W");;
e (REWRITE_TAC[SET_RULE `A SUBSET B <=> (!x. ~(x IN B) ==> ~(x IN A))`]);;
e (REPEAT STRIP_TAC);;
e (NEW_GOAL `x:real^3 IN affine hull (u0 INSERT S)`);;
e (ASM_SET_TAC[]);;
e (UP_ASM_TAC THEN REWRITE_TAC[AFFINE_HULL_EXPLICIT_ALT; IN; IN_ELIM_THM]);;
e (REPEAT STRIP_TAC);;

e (ABBREV_TAC `h = sum (s DELETE u0:real^3) u`);;

e (NEW_GOAL `(x - u0) dot (u1 - u0:real^3) = 
              h * dist (p, u0) * dist (u1, u0:real^3)`);;
e (EXPAND_TAC "x");;
e (NEW_GOAL `u0 = vsum s (\v:real^3. (u:real^3->real) v % (u0:real^3))`);;
e (ASM_SIMP_TAC[VSUM_RMUL]);;
e (VECTOR_ARITH_TAC);;
e (REWRITE_WITH `vsum (s:real^3->bool) (\v. u v % v) - u0:real^3 = 
                 vsum s (\v. u v % v) - vsum s (\v:real^3. u v % u0)`);;
e (ASM_REWRITE_TAC[]);;
e (UP_ASM_TAC THEN MESON_TAC[]);;
e (REWRITE_WITH `vsum s (\v. u v % v) - vsum s (\v:real^3. u v % u0:real^3) = 
                 vsum s (\x. (\v. u v % v) x - (\v. u v % u0) x)`);;
e (ONCE_REWRITE_TAC[EQ_SYM_EQ]);;
e (MATCH_MP_TAC VSUM_SUB);;
e (ASM_REWRITE_TAC[]);;
e (REWRITE_TAC[VECTOR_ARITH `a % x - a % y = a % (x - y)`]);;
e (REWRITE_WITH `vsum s (\x:real^3. u x % (x - u0)) dot (u1 - u0) = 
                 sum s (\x. (\x. u x % (x - u0)) x dot (u1 - u0:real^3))`);;
e (ASM_SIMP_TAC[DOT_LSUM]);;
e (REWRITE_TAC[DOT_LMUL]);;
e (REWRITE_WITH `sum s (\x:real^3. u x * ((x - u0) dot (u1 - u0:real^3))) = 
   sum (s DELETE u0) (\x. u x * (dist (p,u0) * dist (u1,u0)))`);;
e (ASM_CASES_TAC `u0:real^3 IN s`);;
e (NEW_GOAL `s = u0 INSERT (s DELETE u0:real^3)`);;
e (ASM_SET_TAC[]);;
e (NEW_GOAL `FINITE (s DELETE u0:real^3)`);;
e (MATCH_MP_TAC FINITE_SUBSET);;
e (EXISTS_TAC `s:real^3->bool` THEN ASM_REWRITE_TAC[] THEN SET_TAC[]);;

e (REWRITE_WITH `sum s (\x:real^3. u x * ((x - u0) dot (u1 - u0:real^3))) = 
   sum (u0 INSERT (s DELETE u0))  (\x. u x * ((x - u0) dot (u1 - u0)))`);;
e (ASM_MESON_TAC[]);;
e (ABBREV_TAC `f = (\x:real^3. u x * ((x - u0) dot (u1 - u0:real^3)))`);;
e (REWRITE_WITH `sum (u0:real^3 INSERT (s DELETE u0)) f = 
         (if u0 IN (s DELETE u0) then sum (s DELETE u0) f 
          else f u0 + sum (s DELETE u0) f)`);;
e (MATCH_MP_TAC Marchal_cells_2_new.SUM_CLAUSES_alt);;
e (ASM_REWRITE_TAC[]);;
e (COND_CASES_TAC);;
e (NEW_GOAL `F`);;
e (ASM_SET_TAC[]);;
e (ASM_MESON_TAC[]);;
e (REWRITE_WITH `f (u0:real^3) = &0`);;
e (EXPAND_TAC "f");;
e (REWRITE_TAC[VECTOR_ARITH `(u0 - u0) dot (u1 - u0) = &0`]);;
e (REAL_ARITH_TAC);;
e (REWRITE_TAC[REAL_ARITH `&0 + a = a`]);;
e (MATCH_MP_TAC SUM_EQ);;
e (EXPAND_TAC "f");;
e (REPEAT STRIP_TAC);;
e (REWRITE_TAC[REAL_ARITH `a * x = a * y * z <=> a * (x - y * z) = &0`]);;
e (NEW_GOAL `(x' - u0) dot (u1 - u0) - dist (p,u0) * dist (u1,u0:real^3) = &0`);;
e (REWRITE_TAC[REAL_ARITH `a - b = &0 <=> a = b`]);;
e (FIRST_ASSUM MATCH_MP_TAC);;
e (ASM_SET_TAC[]);;
e (ASM_REWRITE_TAC[]);;
e (REAL_ARITH_TAC);;
e (REWRITE_WITH `s DELETE u0:real^3 = s`);;
e (ASM_SET_TAC[]);;
e (MATCH_MP_TAC SUM_EQ);;
e (REPEAT STRIP_TAC);;
e (REWRITE_TAC[]);;
e (REWRITE_TAC[REAL_ARITH `a * x = a * y * z <=> a * (x - y * z) = &0`]);;
e (NEW_GOAL `(x' - u0) dot (u1 - u0) - dist (p,u0) * dist (u1,u0:real^3) = &0`);;
e (REWRITE_TAC[REAL_ARITH `a - b = &0 <=> a = b`]);;
e (FIRST_ASSUM MATCH_MP_TAC);;
e (ASM_SET_TAC[]);;
e (ASM_REWRITE_TAC[]);;
e (REAL_ARITH_TAC);;
e (NEW_GOAL `FINITE (s DELETE u0:real^3)`);;
e (MATCH_MP_TAC FINITE_SUBSET);;
e (EXISTS_TAC `s:real^3->bool` THEN ASM_REWRITE_TAC[] THEN SET_TAC[]);;
e (ASM_SIMP_TAC[SUM_RMUL]);;

e (ASM_CASES_TAC `h <= &0`);;
e (NEW_GOAL `~(x IN rcone_gt u0 (u1:real^3) a)`);;
e (REWRITE_TAC[rcone_gt; rconesgn; IN; IN_ELIM_THM]);;
e (ASM_REWRITE_TAC[]);;
e (MATCH_MP_TAC (REAL_ARITH `&0 <= x /\ y <= &0 ==> ~(y > x)`));;
e (STRIP_TAC);;
e (MATCH_MP_TAC REAL_LE_MUL);;
e (REWRITE_TAC[DIST_POS_LE]);;
e (MATCH_MP_TAC REAL_LE_MUL);;
e (REWRITE_TAC[DIST_POS_LE]);;
e (KY_CHEAT_TAC);;  (* Lien quan den &0 <= a, chon de dang *)

e (REWRITE_TAC[REAL_ARITH `a * b * c <= &0 <=> &0 <= b * c * (--a)`]);;
e (MATCH_MP_TAC REAL_LE_MUL);;
e (REWRITE_TAC[DIST_POS_LE]);;
e (MATCH_MP_TAC REAL_LE_MUL);;
e (REWRITE_TAC[DIST_POS_LE]);;
e (ASM_REAL_ARITH_TAC);;
e (NEW_GOAL `F`);;
e (ASM_MESON_TAC[]);;
e (ASM_MESON_TAC[]);;

e (ABBREV_TAC `y = inv (h) % vsum (s DELETE u0) (\v:real^3. u v % v)`);;
e (NEW_GOAL `?t. t + h = &1 /\ x = t % u0 + h % (y:real^3)`);;
e (EXISTS_TAC `&1 - h`);;
e (STRIP_TAC);;
e (REAL_ARITH_TAC);;
e (ASM_CASES_TAC `u0:real^3 IN s`);;
e (REWRITE_TAC[GSYM (ASSUME `sum s (u:real^3->real) = &1`)]);;
e (EXPAND_TAC "h");;
e (REWRITE_WITH `sum s u = sum (u0 INSERT (s DELETE u0)) (u:real^3->real)`);;
e (REWRITE_WITH `(u0 INSERT (s DELETE u0:real^3)) = s`);;
e (ASM_SET_TAC[]);;
e (NEW_GOAL `FINITE (s DELETE u0:real^3)`);;
e (MATCH_MP_TAC FINITE_SUBSET);;
e (EXISTS_TAC `s:real^3->bool` THEN ASM_REWRITE_TAC[] THEN SET_TAC[]);;

e (SIMP_TAC[Marchal_cells_2_new.SUM_CLAUSES_alt; 
   ASSUME `FINITE (s DELETE u0:real^3)`]);;
e (COND_CASES_TAC);;
e (NEW_GOAL `F`);;
e (UP_ASM_TAC THEN SET_TAC[]);;
e (ASM_MESON_TAC[]);;
e (REWRITE_TAC[REAL_ARITH `(a + b:real) - b = a`]);;
e (ASM_REWRITE_TAC[]);;
e (EXPAND_TAC "y");;
e (REWRITE_TAC[VECTOR_MUL_ASSOC]);;
e (REWRITE_WITH `h * inv h = &1`);;
e (NEW_GOAL `~(h = &0)`);;
e (ASM_REAL_ARITH_TAC);;
e (ASM_SIMP_TAC[Trigonometry2.REAL_MUL_LRINV]);;
e (REWRITE_TAC[VECTOR_MUL_LID]);;
e (EXPAND_TAC "x");;

e (REWRITE_WITH `vsum s (\v. u v % v) = 
   vsum (u0 INSERT (s DELETE u0)) (\v:real^3. u v % v)`);;
e (REWRITE_WITH `(u0 INSERT (s DELETE u0:real^3)) = s`);;
e (ASM_SET_TAC[]);;
e (SIMP_TAC[Marchal_cells_2_new.VSUM_CLAUSES_alt; 
   ASSUME `FINITE (s DELETE u0:real^3)`]);;
e (COND_CASES_TAC);;
e (NEW_GOAL `F`);;
e (UP_ASM_TAC THEN SET_TAC[]);;
e (ASM_MESON_TAC[]);;
e (REFL_TAC);;

e (NEW_GOAL `h = &1`);;
e (EXPAND_TAC "h" THEN REWRITE_WITH `s DELETE u0:real^3 = s`);;
e (ASM_SET_TAC[]);;
e (ASM_REWRITE_TAC[]);;
e (EXPAND_TAC "y" THEN REWRITE_TAC[ASSUME `h = &1`]);;
e (REWRITE_WITH `s DELETE u0:real^3 = s`);;
e (ASM_SET_TAC[]);;
e (ASM_REWRITE_TAC[REAL_ARITH `inv (&1) = &1 /\ &1 - &1 = &0`]);;
e (VECTOR_ARITH_TAC);;
e (UP_ASM_TAC THEN STRIP_TAC);;



e (NEW_GOAL `~(y:real^3 IN S)`);;
e (STRIP_TAC);;
e (NEW_GOAL `x IN aff_ge {u0:real^3} S`);;
e (REWRITE_TAC[IN; aff_ge_def; affsign; sgn_ge; lin_combo]);;

e (ABBREV_TAC `f = (\v:real^3. if v = u0 then t 
                                else if v = y then h else &0)`);;
e (EXISTS_TAC `f:real^3->real`);;
e (REPEAT STRIP_TAC);;
e (REWRITE_WITH `vsum ({u0} UNION S) (\v. f v % v) = 
                 vsum (u0 INSERT {y}) (\v:real^3. f v % v)`);;
e (MATCH_MP_TAC VSUM_SUPERSET);;
e (STRIP_TAC);;
e (ASM_SET_TAC[]);;
e (REPEAT STRIP_TAC);;
e (EXPAND_TAC "f" THEN REWRITE_TAC[]);;
e (COND_CASES_TAC);;
e (NEW_GOAL `F`);;
e (ASM_SET_TAC[]);;
e (ASM_MESON_TAC[]);;
e (COND_CASES_TAC);;
e (NEW_GOAL `F`);;
e (ASM_SET_TAC[]);;
e (ASM_MESON_TAC[]);;
e (VECTOR_ARITH_TAC);;

e (REWRITE_WITH `vsum {u0:real^3, y} (\v. f v % v) = 
                (\v. f v % v) u0 + (\v. f v % v) y`);;
e (MATCH_MP_TAC Geomdetail.VSUM_DIS2);;
e (STRIP_TAC);;
e (NEW_GOAL `~(u0:real^3 IN S)`);;
e (EXPAND_TAC "S");;
e (REWRITE_TAC[VORONOI_LIST; VORONOI_SET; set_of_list; 
   SET_RULE `v IN {a,b} <=> v = a \/ v = b`]);;
e (STRIP_TAC);;
e (NEW_GOAL `u0 IN voronoi_closed V (u1:real^3)`);;
e (ASM_SET_TAC[]);;
e (UP_ASM_TAC THEN REWRITE_TAC[voronoi_closed; IN; IN_ELIM_THM]);;
e (REPEAT STRIP_TAC);;
e (NEW_GOAL `dist (u0,u1) <= dist (u0,u0:real^3)`);;
e (FIRST_ASSUM MATCH_MP_TAC);;
e (ASM_SET_TAC[]);;
e (UP_ASM_TAC THEN REWRITE_TAC[DIST_REFL; REAL_ARITH `~(a <= b) <=> b < a`]);;
e (MATCH_MP_TAC DIST_POS_LT);;
e (ASM_REWRITE_TAC[]);;
e (ASM_MESON_TAC[]);;

e (REWRITE_WITH `(f:real^3->real) u0 = t`);;
e (EXPAND_TAC "f");;
e (COND_CASES_TAC);;
e (REFL_TAC);;
e (NEW_GOAL `F`);;
e (ASM_MESON_TAC[]);;
e (ASM_MESON_TAC[]);;

e (REWRITE_WITH `(f:real^3->real) y = h`);;
e (EXPAND_TAC "f");;
e (COND_CASES_TAC);;
e (NEW_GOAL `F`);;
e (NEW_GOAL `~(u0:real^3 IN S)`);;
e (EXPAND_TAC "S");;
e (REWRITE_TAC[VORONOI_LIST; VORONOI_SET; set_of_list; 
   SET_RULE `v IN {a,b} <=> v = a \/ v = b`]);;
e (STRIP_TAC);;
e (NEW_GOAL `u0 IN voronoi_closed V (u1:real^3)`);;
e (ASM_SET_TAC[]);;
e (UP_ASM_TAC THEN REWRITE_TAC[voronoi_closed; IN; IN_ELIM_THM]);;
e (REPEAT STRIP_TAC);;
e (NEW_GOAL `dist (u0,u1) <= dist (u0,u0:real^3)`);;
e (FIRST_ASSUM MATCH_MP_TAC);;
e (ASM_SET_TAC[]);;
e (UP_ASM_TAC THEN REWRITE_TAC[DIST_REFL; REAL_ARITH `~(a <= b) <=> b < a`]);;
e (MATCH_MP_TAC DIST_POS_LT);;
e (ASM_REWRITE_TAC[]);;
e (ASM_MESON_TAC[]);;
e (ASM_MESON_TAC[]);;
e (COND_CASES_TAC);;
e (REFL_TAC);;
e (NEW_GOAL `F`);;
e (ASM_MESON_TAC[]);;
e (ASM_MESON_TAC[]);;
e (ASM_REWRITE_TAC[]);;


e (EXPAND_TAC "f");;
e (COND_CASES_TAC);;
e (NEW_GOAL `F`);;
e (NEW_GOAL `~((S:real^3->bool) u0)`);;
e (REWRITE_WITH `S u0 <=> u0:real^3 IN S`);;
e (MESON_TAC[IN]);;
e (EXPAND_TAC "S");;
e (REWRITE_TAC[VORONOI_LIST; VORONOI_SET; set_of_list; 
   SET_RULE `v IN {a,b} <=> v = a \/ v = b`]);;
e (STRIP_TAC);;

e (NEW_GOAL `u0 IN voronoi_closed V (u1:real^3)`);;
e (ASM_SET_TAC[]);;
e (UP_ASM_TAC THEN REWRITE_TAC[voronoi_closed; IN; IN_ELIM_THM]);;
e (REPEAT STRIP_TAC);;
e (NEW_GOAL `dist (u0,u1) <= dist (u0,u0:real^3)`);;
e (FIRST_ASSUM MATCH_MP_TAC);;
e (ASM_SET_TAC[]);;
e (UP_ASM_TAC THEN REWRITE_TAC[DIST_REFL; REAL_ARITH `~(a <= b) <=> b < a`]);;
e (MATCH_MP_TAC DIST_POS_LT);;
e (ASM_REWRITE_TAC[]);;
e (ASM_MESON_TAC[]);;
e (ASM_MESON_TAC[]);;
e (COND_CASES_TAC);;
e (ASM_REAL_ARITH_TAC);;
e (REAL_ARITH_TAC);;


e (REWRITE_WITH `sum ({u0:real^3} UNION S) (f:real^3->real) = sum {u0, y} f`);;
e (MATCH_MP_TAC SUM_SUPERSET);;
e (STRIP_TAC);;
e (ASM_SET_TAC[]);;
e (REPEAT STRIP_TAC);;
e (EXPAND_TAC "f" THEN REWRITE_TAC[]);;
e (COND_CASES_TAC);;
e (NEW_GOAL `F`);;
e (ASM_SET_TAC[]);;
e (ASM_MESON_TAC[]);;
e (COND_CASES_TAC);;
e (NEW_GOAL `F`);;
e (ASM_SET_TAC[]);;
e (ASM_MESON_TAC[]);;
e (REAL_ARITH_TAC);;

e (REWRITE_WITH `sum {u0:real^3, y} f = f u0 + f y`);;
e (MATCH_MP_TAC Geomdetail.SUM_DIS2);;
e (STRIP_TAC);;
e (NEW_GOAL `~(u0:real^3 IN S)`);;
e (EXPAND_TAC "S");;
e (REWRITE_TAC[VORONOI_LIST; VORONOI_SET; set_of_list; 
   SET_RULE `v IN {a,b} <=> v = a \/ v = b`]);;
e (STRIP_TAC);;
e (NEW_GOAL `u0 IN voronoi_closed V (u1:real^3)`);;
e (ASM_SET_TAC[]);;
e (UP_ASM_TAC THEN REWRITE_TAC[voronoi_closed; IN; IN_ELIM_THM]);;
e (REPEAT STRIP_TAC);;
e (NEW_GOAL `dist (u0,u1) <= dist (u0,u0:real^3)`);;
e (FIRST_ASSUM MATCH_MP_TAC);;
e (ASM_SET_TAC[]);;
e (UP_ASM_TAC THEN REWRITE_TAC[DIST_REFL; REAL_ARITH `~(a <= b) <=> b < a`]);;
e (MATCH_MP_TAC DIST_POS_LT);;
e (ASM_REWRITE_TAC[]);;
e (ASM_MESON_TAC[]);;

e (REWRITE_WITH `(f:real^3->real) u0 = t`);;
e (EXPAND_TAC "f");;
e (COND_CASES_TAC);;
e (REFL_TAC);;
e (NEW_GOAL `F`);;
e (ASM_MESON_TAC[]);;
e (ASM_MESON_TAC[]);;

e (REWRITE_WITH `(f:real^3->real) y = h`);;
e (EXPAND_TAC "f");;
e (COND_CASES_TAC);;
e (NEW_GOAL `F`);;
e (NEW_GOAL `~(u0:real^3 IN S)`);;
e (EXPAND_TAC "S");;
e (REWRITE_TAC[VORONOI_LIST; VORONOI_SET; set_of_list; 
   SET_RULE `v IN {a,b} <=> v = a \/ v = b`]);;
e (STRIP_TAC);;
e (NEW_GOAL `u0 IN voronoi_closed V (u1:real^3)`);;
e (ASM_SET_TAC[]);;
e (UP_ASM_TAC THEN REWRITE_TAC[voronoi_closed; IN; IN_ELIM_THM]);;
e (REPEAT STRIP_TAC);;
e (NEW_GOAL `dist (u0,u1) <= dist (u0,u0:real^3)`);;
e (FIRST_ASSUM MATCH_MP_TAC);;
e (ASM_SET_TAC[]);;
e (UP_ASM_TAC THEN REWRITE_TAC[DIST_REFL; REAL_ARITH `~(a <= b) <=> b < a`]);;
e (MATCH_MP_TAC DIST_POS_LT);;
e (ASM_REWRITE_TAC[]);;
e (ASM_MESON_TAC[]);;
e (ASM_MESON_TAC[]);;
e (COND_CASES_TAC);;
e (REFL_TAC);;
e (NEW_GOAL `F`);;
e (ASM_MESON_TAC[]);;
e (ASM_MESON_TAC[]);;
e (ASM_REWRITE_TAC[]);;
e (ASM_MESON_TAC[]);;

(* OK until here *)
(* ========================================================================= *)


b();;










e (ASM_SIMP_TAC[Marchal_cells_2_new.VSUM_CLAUSES_alt; Geomdetail.FINITE6]);;
e (COND_CASES_TAC);;
e (NEW_GOAL `F`);;
e (ASM_SET_TAC[]);;
e (ASM_MESON_TAC[]);;
e (REWRITE_WITH `f (u0:real^3) = t:real`);;
e (EXPAND_TAC "f");;
e (COND_CASES_TAC);;
e (REFL_TAC);;
e (NEW_GOAL `F`);;
e (ASM_MESON_TAC[]);;
e (ASM_MESON_TAC[]);;

e (REWRITE_WITH `vsum (s DELETE u0) (\v:real^3. f v % v) = 
                 vsum (s DELETE u0) (\v. u v % v)`);;
e (MATCH_MP_TAC VSUM_EQ);;
e (REPEAT STRIP_TAC);;
e (EXPAND_TAC "f" THEN REWRITE_TAC[]);;
e (COND_CASES_TAC);;
e (NEW_GOAL `F`);;
e (ASM_SET_TAC[]);;
e (ASM_MESON_TAC[]);;

e (COND_CASES_TAC);;
e (REFL_TAC);;
e (NEW_GOAL `F`);;
e (ASM_SET_TAC[]);;
e (ASM_MESON_TAC[]);;

e (EXPAND_TAC "y");;
e (REWRITE_TAC[VECTOR_MUL_ASSOC]);;
e (REWRITE_WITH `h * inv h = &1`);;
e (NEW_GOAL `~(h = &0)`);;
e (ASM_REAL_ARITH_TAC);;
e (ASM_SIMP_TAC[Trigonometry2.REAL_MUL_LRINV]);;
e (VECTOR_ARITH_TAC);;

e (EXPAND_TAC "f");;
e (COND_CASES_TAC);;
e (NEW_GOAL `F`);;
e (NEW_GOAL `~((S:real^3->bool) u0)`);;
e (REWRITE_WITH `S u0 <=> u0:real^3 IN S`);;
e (MESON_TAC[IN]);;
e (EXPAND_TAC "S");;
e (REWRITE_TAC[VORONOI_LIST; VORONOI_SET; set_of_list; 
   SET_RULE `v IN {a,b} <=> v = a \/ v = b`]);;
e (STRIP_TAC);;

e (NEW_GOAL `u0 IN voronoi_closed V (u1:real^3)`);;
e (ASM_SET_TAC[]);;
e (UP_ASM_TAC THEN REWRITE_TAC[voronoi_closed; IN; IN_ELIM_THM]);;
e (REPEAT STRIP_TAC);;
e (NEW_GOAL `dist (u0,u1) <= dist (u0,u0:real^3)`);;
e (FIRST_ASSUM MATCH_MP_TAC);;
e (ASM_SET_TAC[]);;
e (UP_ASM_TAC THEN REWRITE_TAC[DIST_REFL; REAL_ARITH `~(a <= b) <=> b < a`]);;
e (MATCH_MP_TAC DIST_POS_LT);;
e (ASM_REWRITE_TAC[]);;
e (ASM_MESON_TAC[]);;
e (ASM_MESON_TAC[]);;

e (COND_CASES_TAC);;

b();;


DIST_POS_LT;;


b();;

SUM_EQ;;


p();;
b();;

SUM_SUPERSET
VSUM_SUPERSET;;

search [`sum s f = sum t f`];;

`];;

search [`affsign`];;
p();;

affsign;;
b();;
seans_fn();;

search [`aff_gt {a} S`];;


Trigonometry2.REAL_MUL_LRINV
seans_fn();;
search [`&1 % a = a`];;

b();;

b();;







search [`(a - a) = vec 0`];;


b();;

Marchal_cells_2_new.SUM_CLAUSES_alt;;

search [`sum (a INSERT f) g = x`];;



e (!


search [`vsum s f dot y`];;


search 

VSUM_SUB;;


seans_fn();;

b();;


b();;

e (ASM_CASES_TAC `sum (s DELETE u0) u <= &0`);;


search [`aff_gt`];;

aff_gt_def;;
affsign;;
p();;

b();;

IN_AFFINE_HULL;;
search [`affine hull s = t`];;



search [`affine hull (a INSET b)`];;

e (REWRITE_TAC[]

AFF_DIM_EQ_FULL;;
AFF_HULL;;
affine_hull;;

search [`affine hull s = {x | P x}`];;


b();;

g `!S a:real^3. 
   affine hull (a INSERT S) = 
   {s| ?t r y. t + r = &1 /\ y IN affine hull S /\ s = t % a + r % y}`;;
e (REPEAT STRIP_TAC);;
e (ASM_CASES_TAC `a:real^3 IN S`);;
e (REWRITE_WITH `a:real^3 INSERT S = S`);;
e (ASM_SET_TAC[]);;

e (ONCE_REWRITE_TAC[AFFINE_HULL_EXPLICIT_ALT] 
   THEN ONCE_REWRITE_TAC[IN] THEN REWRITE_TAC[IN_ELIM_THM]);;

e (REWRITE_TAC[SET_EQ_LEMMA] THEN ONCE_REWRITE_TAC[IN] THEN
   REWRITE_TAC[IN_ELIM_THM]);;
e (REPEAT STRIP_TAC);;

e (EXISTS_TAC `&0` THEN EXISTS_TAC `&1`);;
e (EXISTS_TAC `vsum s (\v. (u:real^3->real) v % v)`);;
e (REPEAT STRIP_TAC);;
e (REAL_ARITH_TAC);;
e (EXISTS_TAC `s:real^3->bool` THEN EXISTS_TAC `u:real^3->real`);;
e (ASM_REWRITE_TAC[]);;
e (ASM_NORM_ARITH_TAC);;
e (ASM_CASES_TAC `a:real^3 IN s`);;
e (ABBREV_TAC `f = (\x:real^3. if x = a then t + r * u (a:real^3) else r * u x)`);;
e (EXISTS_TAC `s:real^3->bool` THEN EXISTS_TAC `f:real^3->real`);;
e (ASM_REWRITE_TAC[]);;
e (STRIP_TAC);;
e (EXPAND_TAC "f");;
e (ABBREV_TAC `g = (\x:real^3. r * u  x)`);;

e (REWRITE_WITH 
  `sum s (\x:real^3. if x = a then t + r * u (a:real^3) else r * u x) = 
   sum s (\x:real^3. if x = a then t + r * u (a:real^3) else g x)`);;
e (EXPAND_TAC "g" THEN REWRITE_TAC[]);;
e (REWRITE_WITH 
  `sum s (\x:real^3. if x = a then t + r * u (a:real^3) else g x) = 
   sum s g  + (t + r * u (a:real^3)) - g a`);;
e (MATCH_MP_TAC SUM_CASES_1);;
e (ASM_REWRITE_TAC[]);;
e (EXPAND_TAC "g" THEN ASM_SIMP_TAC[SUM_LMUL]);;
e (ASM_REAL_ARITH_TAC);;

e (ABBREV_TAC `g = (\x:real^3. (r * u  x) % x)`);;
e (EXPAND_TAC "f");;
e (REWRITE_WITH 
  `(\v:real^3. (if v = a then t + r * u a else r * u v) % v) = 
   (\v. if v = a then (t + r * u a) % a else g v)`);;
e (EXPAND_TAC "g");;
e (REWRITE_TAC[FUN_EQ_THM]);;
e (STRIP_TAC THEN COND_CASES_TAC);;
e (COND_CASES_TAC);;
e (ASM_REWRITE_TAC[]);;
e (UP_ASM_TAC THEN MESON_TAC[]);;
e (COND_CASES_TAC);;
e (UP_ASM_TAC THEN MESON_TAC[]);;
e (ASM_REWRITE_TAC[]);;

e (REWRITE_WITH 
  `vsum s (\v:real^3. if v = a then (t + r * u a) % a else g v) = 
   vsum s g  + (t + r * u (a:real^3)) % a - g a`);;
e (MATCH_MP_TAC VSUM_CASES_1);;
e (ASM_REWRITE_TAC[]);;
e (EXPAND_TAC "g" THEN REWRITE_TAC[GSYM VECTOR_MUL_ASSOC]);;
e (ASM_SIMP_TAC[VSUM_LMUL]);;
e (VECTOR_ARITH_TAC);;

e (EXISTS_TAC `a:real^3 INSERT s`);;
e (ABBREV_TAC `g = (\v:real^3. r * (u v))`);;
e (ABBREV_TAC `f = (\v:real^3. if v = a then t:real else g v)`);;
e (EXISTS_TAC `f:real^3->real`);;
e (ASM_SIMP_TAC[FINITE_INSERT]);;
e (REPEAT STRIP_TAC);;
e (ASM_SET_TAC[]);;
e (ASM_SIMP_TAC[Marchal_cells_2_new.SUM_CLAUSES_alt]);;
e (EXPAND_TAC "f");;
e (REWRITE_WITH `sum s (\v:real^3. if v = a then t:real else g v) = sum s g`);;
e (MATCH_MP_TAC SUM_EQ);;
e (REPEAT STRIP_TAC THEN REWRITE_TAC[FUN_EQ_THM]);;
e (COND_CASES_TAC);;
e (NEW_GOAL `F`);;
e (ASM_SET_TAC[]);;
e (ASM_MESON_TAC[]);;
e (MESON_TAC[]);;
e (EXPAND_TAC "g" THEN ASM_SIMP_TAC[SUM_LMUL]);;
e (ASM_REAL_ARITH_TAC);;


e (ASM_SIMP_TAC[Marchal_cells_2_new.VSUM_CLAUSES_alt]);;
e (EXPAND_TAC "f");;
e (REWRITE_WITH `vsum s (\v:real^3. (if v = a then t:real else g v) % v) = 
  vsum s (\v:real^3. r % u v % v)`);;
e (MATCH_MP_TAC VSUM_EQ);;
e (REPEAT STRIP_TAC THEN REWRITE_TAC[FUN_EQ_THM]);;
e (COND_CASES_TAC);;
e (NEW_GOAL `F`);;
e (ASM_SET_TAC[]);;
e (ASM_MESON_TAC[]);;
e (EXPAND_TAC "g");;
e (VECTOR_ARITH_TAC);;
e (ASM_SIMP_TAC[VSUM_LMUL]);;




e (ONCE_REWRITE_TAC[AFFINE_HULL_EXPLICIT_ALT] 
   THEN ONCE_REWRITE_TAC[IN] THEN REWRITE_TAC[IN_ELIM_THM]);;

e (REWRITE_TAC[SET_EQ_LEMMA] THEN ONCE_REWRITE_TAC[IN] THEN
   REWRITE_TAC[IN_ELIM_THM]);;
e (REPEAT STRIP_TAC);;

e (ASM_CASES_TAC `a:real^3 IN s`);;
e (ASM_CASES_TAC `sum (s DELETE a:real^3) u = &0`);;
e (NEW_GOAL `sum s u = u a + sum (s DELETE a:real^3) u`);;
e (NEW_GOAL `s = a INSERT (s DELETE a:real^3)`);;
e (ASM_SET_TAC[]);;
e (REWRITE_WITH `sum s u = sum (a INSERT (s DELETE a:real^3)) u`);;
e (UP_ASM_TAC THEN MESON_TAC[]);;
e (NEW_GOAL `FINITE (s DELETE a:real^3)`);;
e (MATCH_MP_TAC FINITE_SUBSET);;
e (EXISTS_TAC `s:real^3->bool`);;
e (ASM_REWRITE_TAC[] THEN SET_TAC[]);;
e (ASM_SIMP_TAC[Marchal_cells_2_new.SUM_CLAUSES_alt]);;
e (COND_CASES_TAC);;
e (NEW_GOAL `F`);;
e (UP_ASM_TAC THEN SET_TAC[]);;
e (ASM_MESON_TAC[]);;
e (NEW_GOAL `(u:real^3->real) a = &1`);;
e (ASM_REAL_ARITH_TAC);;
e (EXISTS_TAC `&1` THEN EXISTS_TAC `&0` THEN EXISTS_TAC `x:real^3`);;



b();;

Marchal_cells_2_new.SUM_CLAUSES_alt;;

search [`sum (a INSERT b) f`];;

e (EXISTS_TAC `&0` THEN EXISTS_TAC `&1`);;
e (EXISTS_TAC `vsum s (\v. (u:real^3->real) v % v)`);;
e (REPEAT STRIP_TAC);;
e (REAL_ARITH_TAC);;
e (EXISTS_TAC `s:real^3->bool` THEN EXISTS_TAC `u:real^3->real`);;
e (ASM_REWRITE_TAC[]);;
e (

b();;

e (ASM_NORM_ARITH_TAC);;
e (ASM_CASES_TAC `a:real^3 IN s`);;
e (ABBREV_TAC `f = (\x:real^3. if x = a then t + r * u (a:real^3) else r * u x)`);;
e (EXISTS_TAC `s:real^3->bool` THEN EXISTS_TAC `f:real^3->real`);;
e (ASM_REWRITE_TAC[]);;
e (STRIP_TAC);;
e (EXPAND_TAC "f");;
e (ABBREV_TAC `g = (\x:real^3. r * u  x)`);;

e (REWRITE_WITH 
  `sum s (\x:real^3. if x = a then t + r * u (a:real^3) else r * u x) = 
   sum s (\x:real^3. if x = a then t + r * u (a:real^3) else g x)`);;
e (EXPAND_TAC "g" THEN REWRITE_TAC[]);;
e (REWRITE_WITH 
  `sum s (\x:real^3. if x = a then t + r * u (a:real^3) else g x) = 
   sum s g  + (t + r * u (a:real^3)) - g a`);;
e (MATCH_MP_TAC SUM_CASES_1);;
e (ASM_REWRITE_TAC[]);;
e (EXPAND_TAC "g" THEN ASM_SIMP_TAC[SUM_LMUL]);;
e (ASM_REAL_ARITH_TAC);;

e (ABBREV_TAC `g = (\x:real^3. (r * u  x) % x)`);;
e (EXPAND_TAC "f");;
e (REWRITE_WITH 
  `(\v:real^3. (if v = a then t + r * u a else r * u v) % v) = 
   (\v. if v = a then (t + r * u a) % a else g v)`);;
e (EXPAND_TAC "g");;
e (REWRITE_TAC[FUN_EQ_THM]);;
e (STRIP_TAC THEN COND_CASES_TAC);;
e (COND_CASES_TAC);;
e (ASM_REWRITE_TAC[]);;
e (UP_ASM_TAC THEN MESON_TAC[]);;
e (COND_CASES_TAC);;
e (UP_ASM_TAC THEN MESON_TAC[]);;
e (ASM_REWRITE_TAC[]);;

e (REWRITE_WITH 
  `vsum s (\v:real^3. if v = a then (t + r * u a) % a else g v) = 
   vsum s g  + (t + r * u (a:real^3)) % a - g a`);;
e (MATCH_MP_TAC VSUM_CASES_1);;
e (ASM_REWRITE_TAC[]);;
e (EXPAND_TAC "g" THEN REWRITE_TAC[GSYM VECTOR_MUL_ASSOC]);;
e (ASM_SIMP_TAC[VSUM_LMUL]);;
e (VECTOR_ARITH_TAC);;

e (EXISTS_TAC `a:real^3 INSERT s`);;
e (ABBREV_TAC `g = (\v:real^3. r * (u v))`);;
e (ABBREV_TAC `f = (\v:real^3. if v = a then t:real else g v)`);;
e (EXISTS_TAC `f:real^3->real`);;
e (ASM_SIMP_TAC[FINITE_INSERT]);;
e (REPEAT STRIP_TAC);;
e (ASM_SET_TAC[]);;
e (ASM_SIMP_TAC[Marchal_cells_2_new.SUM_CLAUSES_alt]);;
e (EXPAND_TAC "f");;
e (REWRITE_WITH `sum s (\v:real^3. if v = a then t:real else g v) = sum s g`);;
e (MATCH_MP_TAC SUM_EQ);;
e (REPEAT STRIP_TAC THEN REWRITE_TAC[FUN_EQ_THM]);;
e (COND_CASES_TAC);;
e (NEW_GOAL `F`);;
e (ASM_SET_TAC[]);;
e (ASM_MESON_TAC[]);;
e (MESON_TAC[]);;
e (EXPAND_TAC "g" THEN ASM_SIMP_TAC[SUM_LMUL]);;
e (ASM_REAL_ARITH_TAC);;


e (ASM_SIMP_TAC[Marchal_cells_2_new.VSUM_CLAUSES_alt]);;
e (EXPAND_TAC "f");;
e (REWRITE_WITH `vsum s (\v:real^3. (if v = a then t:real else g v) % v) = 
  vsum s (\v:real^3. r % u v % v)`);;
e (MATCH_MP_TAC VSUM_EQ);;
e (REPEAT STRIP_TAC THEN REWRITE_TAC[FUN_EQ_THM]);;
e (COND_CASES_TAC);;
e (NEW_GOAL `F`);;
e (ASM_SET_TAC[]);;
e (ASM_MESON_TAC[]);;
e (EXPAND_TAC "g");;
e (VECTOR_ARITH_TAC);;
e (ASM_SIMP_TAC[VSUM_LMUL]);;











b();;

search [`(a % b % c) = d`];;

search [`(f = g) <=> (!x. f x = g x)`];;

search [`(\x. P)`]

e (EXISTS_TAC `s:real^3->bool` THEN EXISTS_TAC `f:real^3->real`);;
e (ASM_REWRITE_TAC[]);;
e (STRIP_TAC);;
e (EXPAND_TAC "f");;
e (ABBREV_TAC `g = (\x:real^3. r * u  x)`);;

e (REWRITE_WITH 
  `sum s (\x:real^3. if x = a then t + r * u (a:real^3) else r * u x) = 
   sum s (\x:real^3. if x = a then t + r * u (a:real^3) else g x)`);;
e (EXPAND_TAC "g" THEN REWRITE_TAC[]);;
e (REWRITE_WITH 
  `sum s (\x:real^3. if x = a then t + r * u (a:real^3) else g x) = 
   sum s g  + (t + r * u (a:real^3)) - g a`);;
e (MATCH_MP_TAC SUM_CASES_1);;
e (ASM_REWRITE_TAC[]);;
e (EXPAND_TAC "g" THEN ASM_SIMP_TAC[SUM_LMUL]);;
e (ASM_REAL_ARITH_TAC);;

;;
VSUM_CASES_1;;

p();;
b();;

search [`sum s (\x. if x = a then b else c)`];;

e (ASM_NORM_ARITH_TAC);;
e (ASM_CASES_TAC `a:real^3 IN s`);;



AFF_TAC;;


seans_fn();;
b();;

b();;


b();;


search [`affine hull s`];;


e (UNDISCH_TAC `barV V 1 [u0;u1]` THEN REWRITE_TAC[BARV]);;

b();;
p();;


search [`barV`; `aff_dim s`];;


search [`a dot a = &0`];;



e (NEW_GOAL `?x:real^3. x IN W1 /\(!y. y IN W1 ==> dist (p,x) <= dist (a,y))`);;


Pack2.INTER_VORONOI_SUBSET_BISECTOR;;

b();;

AFF_DIM_INSERT;;
AFF_DIM_EQ_FULL;;


p();;

search [`affine {x| a dot x = b}`];;



search [`aff_dim (s INSERT t)`];;


seans_fn();;

aff_ge_def;;
affsign;;


DISTANCE_ATTAINS_INF;;

OPEN_RCONE_GT;;
polytope;;

search [`closed`; `dist (a, b) <= dist (c, d)`];;


b();;

search [`voronoi_list V ul`];;
Packing3.POLYTOPE_VORONOI_LIST_BARV;;
search [`polytope`];;

Rogers.XYOFCGX;;

b();;


type_of `rcone_ge`;;


aff_ge_def;;
sear

e (REWRITE_WITH `i IN 1..3-1`

p();;
search [`omega_list_n V ul k = omega_list V ul`];;

omega_list;;
OMEGA_LIST;;


search [`omega_list V vl  IN s`];;
search [`voronoi_list V ul = {s}`];;

b();;

e (KY_CHEAT_TAC);;

b();;


b();;


search [`a IN i..j <=> s`];;

b();;



e (NEW_GOAL `voronoi_list V [u0;u1:real^3] = 
       UNIONS {convex hull
                  ({omega_list_n V vl i | i IN j..k - 1} UNION
                    voronoi_list V vl) | vl | barV V k vl /\
                                              truncate_simplex 1 vl = [u0;u1]}`


search [`rogers`; `packing V`];;
search [`rogers V ul`; `packing V`];;
search [`omega_list V ul`; `packing V`];;
search [`omega_closed V (set_os_list ul)`; `packing V`; `convex hull s`];;
search [`voronoi_list V ul`; `packing V`; `convex hull s`];;
Rogers.VORONOI_LIST_EQ_UNION_CONVEX_HULL_FACETS;;

Rogers.GLTVHUM_lemma1;;




e (REWRITE_TAC[BARV; LENGTH; ARITH_RULE `SUC (SUC 0) = 1 + 1`]);;
e (REPEAT STRIP_TAC);;
e (ASM_CASES_TAC `LENGTH (vl:(real^3)list) = 1`);;
e (NEW_GOAL `initial_sublist vl [u0; u1:real^3] /\ LENGTH vl = 0 + 1`);;
e (ASM_REWRITE_TAC[] THEN ARITH_TAC);;
e (UP_ASM_TAC THEN REWRITE_WITH 
   `initial_sublist vl [u0; u1:real^3] /\ LENGTH vl = 0 + 1 <=>
    truncate_simplex 0 [u0;u1] = vl /\ 0 + 1 <= LENGTH [u0;u1:real^3]`);;
e (ONCE_REWRITE_TAC[EQ_SYM_EQ]);;
e (REWRITE_TAC[Packing3.TRUNCATE_SIMPLEX_INITIAL_SUBLIST]);;
e (ONCE_REWRITE_TAC[EQ_SYM_EQ]);;
e (REPEAT STRIP_TAC);;
e (ASM_REWRITE_TAC[TRUNCATE_SIMPLEX_EXPLICIT_0]);;
e (REWRITE_TAC[VORONOI_NONDG; VORONOI_LIST; VORONOI_SET; set_of_list; LENGTH;
   SET_RULE `INTERS {voronoi_closed V v | v IN {u0}} = voronoi_closed V u0`]);;
e (ASM_SIMP_TAC[Packing3.AFF_DIM_VORONOI_CLOSED]);;
e (REPEAT STRIP_TAC);;
e (ARITH_TAC);;
e (ASM_SET_TAC[]);;
e (ARITH_TAC);;

e (ASM_CASES_TAC `LENGTH (vl:(real^3)list) = 2`);;
e (NEW_GOAL `initial_sublist vl [u0; u1:real^3] /\ LENGTH vl = 1 + 1`);;
e (ASM_REWRITE_TAC[] THEN ARITH_TAC);;
e (UP_ASM_TAC THEN REWRITE_WITH 
   `initial_sublist vl [u0; u1:real^3] /\ LENGTH vl = 1 + 1 <=>
    truncate_simplex 1 [u0;u1] = vl /\ 1 + 1 <= LENGTH [u0;u1:real^3]`);;
e (ONCE_REWRITE_TAC[EQ_SYM_EQ]);;
e (REWRITE_TAC[Packing3.TRUNCATE_SIMPLEX_INITIAL_SUBLIST]);;
e (ONCE_REWRITE_TAC[EQ_SYM_EQ]);;
e (REPEAT STRIP_TAC);;
e (ASM_REWRITE_TAC[TRUNCATE_SIMPLEX_EXPLICIT_1]);;
e (REWRITE_TAC[VORONOI_NONDG; VORONOI_LIST; VORONOI_SET; set_of_list; LENGTH;
  SET_RULE `INTERS {voronoi_closed V v | v IN {u,s}} = 
  voronoi_closed V u INTER voronoi_closed V s`]);;
e (ASM_SIMP_TAC[Packing3.AFF_DIM_VORONOI_CLOSED]);;
e (REPEAT STRIP_TAC);;
e (ARITH_TAC);;
e (ASM_SET_TAC[]);;
e (NEW_GOAL 
 `aff_dim (voronoi_closed V (u0:real^3) INTER voronoi_closed V u1) < &3`);;
e (REWRITE_TAC[GSYM DIMINDEX_3;AFF_DIM_LT_FULL]);;
e (STRIP_TAC);;
e (KY_CHEAT_TAC);;

e (ASM_CASES_TAC
 `aff_dim (voronoi_closed V (u0:real^3) INTER voronoi_closed V u1) <= &1`);;
e (KY_CHEAT_TAC);;
  (* su dung dinh nghia aff_dim, 
     xet tat ca cac diem co khoang cach sqrt 2 den ca u0 va v0 *)
e (ASM_ARITH_TAC);;
e (NEW_GOAL `F`);;
e (NEW_GOAL `initial_sublist vl [u0; u1:real^3] /\ 
             LENGTH vl = (LENGTH vl - 1) + 1`);;
e (ASM_REWRITE_TAC[] THEN ASM_ARITH_TAC);;
e (UP_ASM_TAC THEN REWRITE_WITH 
   `initial_sublist vl [u0; u1:real^3] /\ LENGTH vl = (LENGTH vl - 1) + 1 <=>
    truncate_simplex (LENGTH vl - 1) [u0;u1] = vl /\ 
    (LENGTH vl - 1) + 1 <= LENGTH [u0;u1:real^3]`);;
e (ONCE_REWRITE_TAC[EQ_SYM_EQ]);;
e (REWRITE_TAC[Packing3.TRUNCATE_SIMPLEX_INITIAL_SUBLIST]);;
e (REWRITE_TAC[LENGTH]);;
e (REPEAT STRIP_TAC);;
e (ASM_ARITH_TAC);;
e (ASM_MESON_TAC[]);;

(* seem not necessary *)
(*
e (NEW_GOAL `?vl. barV V (SUC 1) vl /\ truncate_simplex 1 vl = [u0;u1]`);;
e (MATCH_MP_TAC Rogers.BARV_EXISTS);;
e (ASM_REWRITE_TAC[] THEN ARITH_TAC);;
e (UP_ASM_TAC THEN REWRITE_TAC[ARITH_RULE `SUC 1 = 2`] THEN STRIP_TAC);;
e (NEW_GOAL `?zl. barV V (SUC 2) zl /\ truncate_simplex 2 zl = vl`);;
e (MATCH_MP_TAC Rogers.BARV_EXISTS);;
e (ASM_REWRITE_TAC[] THEN ARITH_TAC);;
e (UP_ASM_TAC THEN REWRITE_TAC[ARITH_RULE `SUC 2 = 3`] THEN STRIP_TAC);;
*)

e (NEW_GOAL 
`?r a.
     let C = ball (u0,r) INTER rcone_ge u0 u1 a in
     (!X. mcell_set V X /\ ~NULLSET (X INTER C)
     ==> (?k vl.
              2 <= k /\
              barV V 3 vl /\
              X = mcell k V vl /\
              truncate_simplex 1 vl = [u0; u1]))`);;

e (EXISTS_TAC `r:real`);;  (* choose appropriately later *)
e (EXISTS_TAC `a:real`);;  (* choose appropriately later *)
e (REWRITE_TAC[mcell_set; IN_ELIM_THM]);;
e (LET_TAC THEN REPEAT STRIP_TAC);;

e (ASM_CASES_TAC `i = 0`);;
e (NEW_GOAL `F`);;
e (UNDISCH_TAC `X = mcell i V ul`);;
e (ASM_REWRITE_TAC[MCELL_EXPLICIT; mcell0]);;
e (STRIP_TAC);;
e (NEW_GOAL `X:real^3->bool INTER C = {}`);;
e (REWRITE_TAC[SET_RULE `x = {} <=> (!t. ~(t IN x))`]);;
e (REPEAT STRIP_TAC);;
e (NEW_GOAL `~(t:real^3 IN ball (HD ul, sqrt (&2)))`);;
e (ASM_SET_TAC[]);;
e (NEW_GOAL `t:real^3 IN ball (HD ul, sqrt (&2)))`);;
e (ASM_SET_TAC[]);;


b();;

e (ASM_REWRITE_TAC[] THEN EXPAND_TAC "C");;


b();;
INTERIOR_MAXIMAL;;
SUBSET_INTERIOR;;
frontier;;
HAS_MEASURE_LUNE;;
HAS_MEASURE_LUNE_SIMPLE;;


search [`s SUBSET (interior t)`];;

rcone_ge;;
rconesgn;;

search [`barV`];;

mcell1;;
mcell2;;
mcell3;;
mcell4;;


Ajripqn.AJRIPQN;;
mcell1;;

search [`mcell i V ul = s`];;



aff
KIZHLTL1;;
KIZHLTL2;;
dihu2;;
dihu3;;
dihu4;;


search [`rogers`; `voronoi_closed`];;



(* Lemmas using often *)

MEASURE_DISJOINT_UNIONS_IMAGE;;
MEASURE_NEGLIGIBLE_UNIONS_IMAGE;;
SUM_CONST;;
FINITE_IMAGE_EXPAND;;

packing;;

(* -------------------------------------------------------------- *)



g `!ul a b k. {a, b} SUBSET set_of_list (truncate_simplex k ul) ==> 
        ?vl. ([a;b] = truncate_simplex 1 vl /\ 
             (?p. p permutes 0..k /\ vl = left_action_list p ul))`;;
e (REPEAT STRIP_TAC);;

;;

search []