let KY_CHEAT_TAC = MP_TAC (mk_thm([],`F`)) THEN SET_TAC[];;

(* back up for the proof *)


g `!V u0 u1.
     saturated V /\
     packing V /\
     u0 IN V /\
     u1 IN V /\
     ~(u0 = u1) /\
     hl [u0;u1] < sqrt (&2) ==> barV V 1 [u0;u1:real^3]`;;
e (REPEAT STRIP_TAC);;
e (REWRITE_TAC[BARV; LENGTH; ARITH_RULE `SUC (SUC 0) = 1 + 1`]);;
e (REPEAT STRIP_TAC);;
e (ASM_CASES_TAC `LENGTH (vl:(real^3)list) = 1`);;
e (NEW_GOAL `initial_sublist vl [u0; u1:real^3] /\ LENGTH vl = 0 + 1`);;
e (ASM_REWRITE_TAC[] THEN ARITH_TAC);;
e (UP_ASM_TAC THEN REWRITE_WITH 
   `initial_sublist vl [u0; u1:real^3] /\ LENGTH vl = 0 + 1 <=>
    truncate_simplex 0 [u0;u1] = vl /\ 0 + 1 <= LENGTH [u0;u1:real^3]`);;
e (ONCE_REWRITE_TAC[EQ_SYM_EQ]);;
e (REWRITE_TAC[Packing3.TRUNCATE_SIMPLEX_INITIAL_SUBLIST]);;
e (ONCE_REWRITE_TAC[EQ_SYM_EQ]);;
e (REPEAT STRIP_TAC);;
e (ASM_REWRITE_TAC[TRUNCATE_SIMPLEX_EXPLICIT_0]);;
e (REWRITE_TAC[VORONOI_NONDG; VORONOI_LIST; VORONOI_SET; set_of_list; LENGTH;
   SET_RULE `INTERS {voronoi_closed V v | v IN {u0}} = voronoi_closed V u0`]);;
e (ASM_SIMP_TAC[Packing3.AFF_DIM_VORONOI_CLOSED]);;
e (REPEAT STRIP_TAC);;
e (ARITH_TAC);;
e (ASM_SET_TAC[]);;
e (ARITH_TAC);;

e (ASM_CASES_TAC `LENGTH (vl:(real^3)list) = 2`);;
e (NEW_GOAL `initial_sublist vl [u0; u1:real^3] /\ LENGTH vl = 1 + 1`);;
e (ASM_REWRITE_TAC[] THEN ARITH_TAC);;
e (UP_ASM_TAC THEN REWRITE_WITH 
   `initial_sublist vl [u0; u1:real^3] /\ LENGTH vl = 1 + 1 <=>
    truncate_simplex 1 [u0;u1] = vl /\ 1 + 1 <= LENGTH [u0;u1:real^3]`);;
e (ONCE_REWRITE_TAC[EQ_SYM_EQ]);;
e (REWRITE_TAC[Packing3.TRUNCATE_SIMPLEX_INITIAL_SUBLIST]);;
e (ONCE_REWRITE_TAC[EQ_SYM_EQ]);;
e (REPEAT STRIP_TAC);;
e (ASM_REWRITE_TAC[TRUNCATE_SIMPLEX_EXPLICIT_1]);;
e (REWRITE_TAC[VORONOI_NONDG; VORONOI_LIST; VORONOI_SET; set_of_list; LENGTH;
  SET_RULE `INTERS {voronoi_closed V v | v IN {u,s}} = 
  voronoi_closed V u INTER voronoi_closed V s`]);;
e (ASM_SIMP_TAC[Packing3.AFF_DIM_VORONOI_CLOSED]);;
e (REPEAT STRIP_TAC);;
e (ARITH_TAC);;
e (ASM_SET_TAC[]);;



e (MATCH_MP_TAC (ARITH_RULE `a = &2 ==> a + &(SUC(SUC 0)) = (&4):int`));;
e (REWRITE_WITH `&2 = &(dimindex (:3)) - &1:int`);;
e (REWRITE_TAC[DIMINDEX_3]);;
e (ARITH_TAC);;
e (NEW_GOAL `voronoi_closed V u0 INTER voronoi_closed V u1 SUBSET
           {x | &2 % (u0:real^3 - u1) dot x = norm u0 pow 2 - norm u1 pow 2}`);;
e (ASM_SIMP_TAC[Pack2.INTER_VORONOI_SUBSET_BISECTOR]);;

e (MATCH_MP_TAC AFF_DIM_HYPERPLANE);;


search [`aff_dim (voronoi_closed V u0 INTER voronoi_closed V u1)`];;


seans_fn();;
b();;


AFF_DIM_HYPERPLANE;;




e (NEW_GOAL 
 `aff_dim (voronoi_closed V (u0:real^3) INTER voronoi_closed V u1) < &3`);;
e (REWRITE_TAC[GSYM DIMINDEX_3;AFF_DIM_LT_FULL]);;
e (STRIP_TAC);;
e (REWRITE_WITH `voronoi_closed V u0 INTER voronoi_closed V u1 SUBSET
           {x | &2 % (u0:real^3 - u1) dot x = norm u0 pow 2 - norm u1 pow 2}`);;
e (ASM_SIMP_TAC[Pack2.INTER_VORONOI_SUBSET_BISECTOR]);;
e (NEW_GOAL `affine hull (voronoi_closed V u0 INTER voronoi_closed V u1) SUBSET
             affine hull 
  ({x | &2 % (u0 - u1:real^3) dot x = norm u0 pow 2 - norm u1 pow 2})`);;
e (MATCH_MP_TAC Marchal_cells_2_new.AFFINE_SUBSET_KY_LEMMA);;
e (ASM_REWRITE_TAC[]);;
e (UP_ASM_TAC THEN ASM_REWRITE_TAC[]);;
e (REWRITE_WITH 
   `affine hull 
   {x:real^3 | &2 % (u0 - u1) dot x = norm u0 pow 2 - norm u1 pow 2} = 
   {x | &2 % (u0 - u1) dot x = norm u0 pow 2 - norm u1 pow 2}`);;
e (REWRITE_TAC[AFFINE_HULL_EQ]);;
e (REWRITE_TAC[AFFINE_HYPERPLANE]);;
e (STRIP_TAC);;
e (NEW_GOAL `{x | &2 % (u0 - u1) dot x = norm u0 pow 2 - norm u1 pow 2} =  
  (:real^3)`);;
e (NEW_GOAL `{x | &2 % (u0 - u1) dot x = norm u0 pow 2 - norm u1 pow 2}  
   SUBSET (:real^3)`);;
e (SET_TAC[]);;
e (ASM_SET_TAC[]);;
e (UP_ASM_TAC THEN REWRITE_TAC[HYPERPLANE_EQ_UNIV]);;
e (NEW_GOAL `~(&2 % (u0 - u1:real^3) = vec 0)`);;
e (ASM_NORM_ARITH_TAC);;
e (ASM_MESON_TAC[]);;

e (ASM_CASES_TAC
 `aff_dim (voronoi_closed V (u0:real^3) INTER voronoi_closed V u1) <= &1`);;
e (NEW_GOAL `F`);;

search [`aff_dim s`];;
aff_dim;;
p();;
search [`aff_dim {x| a dot x = b}`];;


e (KY_CHEAT_TAC);;
  (* su dung dinh nghia aff_dim, 
     xet tat ca cac diem co khoang cach sqrt 2 den ca u0 va v0 *)
e (ASM_ARITH_TAC);;
e (NEW_GOAL `F`);;
e (NEW_GOAL `initial_sublist vl [u0; u1:real^3] /\ 
             LENGTH vl = (LENGTH vl - 1) + 1`);;
e (ASM_REWRITE_TAC[] THEN ASM_ARITH_TAC);;
e (UP_ASM_TAC THEN REWRITE_WITH 
   `initial_sublist vl [u0; u1:real^3] /\ LENGTH vl = (LENGTH vl - 1) + 1 <=>
    truncate_simplex (LENGTH vl - 1) [u0;u1] = vl /\ 
    (LENGTH vl - 1) + 1 <= LENGTH [u0;u1:real^3]`);;
e (ONCE_REWRITE_TAC[EQ_SYM_EQ]);;
e (REWRITE_TAC[Packing3.TRUNCATE_SIMPLEX_INITIAL_SUBLIST]);;
e (REWRITE_TAC[LENGTH]);;
e (REPEAT STRIP_TAC);;
e (ASM_ARITH_TAC);;
e (ASM_MESON_TAC[]);;
















search [`barV V 1 ul`];;




let GRUTOTI1_concl = 
`!V u0 u1 e.
     saturated V /\
     packing V /\
     u0 IN V /\
     u1 IN V /\
     ~(u0 = u1) /\
     hl [u0;u1] < sqrt (&2) /\
     e = {u0, u1}
     ==> sum {X | e IN edgeX V X} (\t. dihX V t (u0,u1)) = &2 * pi`;;

g GRUTOTI1_concl;;
e (REPEAT STRIP_TAC);;


search [`rogers`; `packing V`];;
search [`rogers V ul`; `packing V`];;
search [`omega_list V ul`; `packing V`];;
search [`omega_closed V (set_os_list ul)`; `packing V`; `convex hull s`];;
search [`voronoi_list V ul`; `packing V`; `convex hull s`];;
Rogers.VORONOI_LIST_EQ_UNION_CONVEX_HULL_FACETS;;




e (NEW_GOAL `barV V 1 [u0;u1:real^3]`);;
e (REWRITE_TAC[BARV; LENGTH; ARITH_RULE `SUC (SUC 0) = 1 + 1`]);;
e (REPEAT STRIP_TAC);;
e (ASM_CASES_TAC `LENGTH (vl:(real^3)list) = 1`);;
e (NEW_GOAL `initial_sublist vl [u0; u1:real^3] /\ LENGTH vl = 0 + 1`);;
e (ASM_REWRITE_TAC[] THEN ARITH_TAC);;
e (UP_ASM_TAC THEN REWRITE_WITH 
   `initial_sublist vl [u0; u1:real^3] /\ LENGTH vl = 0 + 1 <=>
    truncate_simplex 0 [u0;u1] = vl /\ 0 + 1 <= LENGTH [u0;u1:real^3]`);;
e (ONCE_REWRITE_TAC[EQ_SYM_EQ]);;
e (REWRITE_TAC[Packing3.TRUNCATE_SIMPLEX_INITIAL_SUBLIST]);;
e (ONCE_REWRITE_TAC[EQ_SYM_EQ]);;
e (REPEAT STRIP_TAC);;
e (ASM_REWRITE_TAC[TRUNCATE_SIMPLEX_EXPLICIT_0]);;
e (REWRITE_TAC[VORONOI_NONDG; VORONOI_LIST; VORONOI_SET; set_of_list; LENGTH;
   SET_RULE `INTERS {voronoi_closed V v | v IN {u0}} = voronoi_closed V u0`]);;
e (ASM_SIMP_TAC[Packing3.AFF_DIM_VORONOI_CLOSED]);;
e (REPEAT STRIP_TAC);;
e (ARITH_TAC);;
e (ASM_SET_TAC[]);;
e (ARITH_TAC);;

e (ASM_CASES_TAC `LENGTH (vl:(real^3)list) = 2`);;
e (NEW_GOAL `initial_sublist vl [u0; u1:real^3] /\ LENGTH vl = 1 + 1`);;
e (ASM_REWRITE_TAC[] THEN ARITH_TAC);;
e (UP_ASM_TAC THEN REWRITE_WITH 
   `initial_sublist vl [u0; u1:real^3] /\ LENGTH vl = 1 + 1 <=>
    truncate_simplex 1 [u0;u1] = vl /\ 1 + 1 <= LENGTH [u0;u1:real^3]`);;
e (ONCE_REWRITE_TAC[EQ_SYM_EQ]);;
e (REWRITE_TAC[Packing3.TRUNCATE_SIMPLEX_INITIAL_SUBLIST]);;
e (ONCE_REWRITE_TAC[EQ_SYM_EQ]);;
e (REPEAT STRIP_TAC);;
e (ASM_REWRITE_TAC[TRUNCATE_SIMPLEX_EXPLICIT_1]);;
e (REWRITE_TAC[VORONOI_NONDG; VORONOI_LIST; VORONOI_SET; set_of_list; LENGTH;
  SET_RULE `INTERS {voronoi_closed V v | v IN {u,s}} = 
  voronoi_closed V u INTER voronoi_closed V s`]);;
e (ASM_SIMP_TAC[Packing3.AFF_DIM_VORONOI_CLOSED]);;
e (REPEAT STRIP_TAC);;
e (ARITH_TAC);;
e (ASM_SET_TAC[]);;
e (NEW_GOAL 
 `aff_dim (voronoi_closed V (u0:real^3) INTER voronoi_closed V u1) < &3`);;
e (REWRITE_TAC[GSYM DIMINDEX_3;AFF_DIM_LT_FULL]);;
e (STRIP_TAC);;
e (KY_CHEAT_TAC);;

e (ASM_CASES_TAC
 `aff_dim (voronoi_closed V (u0:real^3) INTER voronoi_closed V u1) <= &1`);;
e (KY_CHEAT_TAC);;
  (* su dung dinh nghia aff_dim, 
     xet tat ca cac diem co khoang cach sqrt 2 den ca u0 va v0 *)
e (ASM_ARITH_TAC);;
e (NEW_GOAL `F`);;
e (NEW_GOAL `initial_sublist vl [u0; u1:real^3] /\ 
             LENGTH vl = (LENGTH vl - 1) + 1`);;
e (ASM_REWRITE_TAC[] THEN ASM_ARITH_TAC);;
e (UP_ASM_TAC THEN REWRITE_WITH 
   `initial_sublist vl [u0; u1:real^3] /\ LENGTH vl = (LENGTH vl - 1) + 1 <=>
    truncate_simplex (LENGTH vl - 1) [u0;u1] = vl /\ 
    (LENGTH vl - 1) + 1 <= LENGTH [u0;u1:real^3]`);;
e (ONCE_REWRITE_TAC[EQ_SYM_EQ]);;
e (REWRITE_TAC[Packing3.TRUNCATE_SIMPLEX_INITIAL_SUBLIST]);;
e (REWRITE_TAC[LENGTH]);;
e (REPEAT STRIP_TAC);;
e (ASM_ARITH_TAC);;
e (ASM_MESON_TAC[]);;

(* seem not necessary *)
(*
e (NEW_GOAL `?vl. barV V (SUC 1) vl /\ truncate_simplex 1 vl = [u0;u1]`);;
e (MATCH_MP_TAC Rogers.BARV_EXISTS);;
e (ASM_REWRITE_TAC[] THEN ARITH_TAC);;
e (UP_ASM_TAC THEN REWRITE_TAC[ARITH_RULE `SUC 1 = 2`] THEN STRIP_TAC);;
e (NEW_GOAL `?zl. barV V (SUC 2) zl /\ truncate_simplex 2 zl = vl`);;
e (MATCH_MP_TAC Rogers.BARV_EXISTS);;
e (ASM_REWRITE_TAC[] THEN ARITH_TAC);;
e (UP_ASM_TAC THEN REWRITE_TAC[ARITH_RULE `SUC 2 = 3`] THEN STRIP_TAC);;
*)

e (NEW_GOAL 
`?r a.
     let C = ball (u0,r) INTER rcone_ge u0 u1 a in
     (!X. mcell_set V X /\ ~NULLSET (X INTER C)
     ==> (?k vl.
              2 <= k /\
              barV V 3 vl /\
              X = mcell k V vl /\
              truncate_simplex 1 vl = [u0; u1]))`);;

e (EXISTS_TAC `r:real`);;  (* choose appropriately later *)
e (EXISTS_TAC `a:real`);;  (* choose appropriately later *)
e (REWRITE_TAC[mcell_set; IN_ELIM_THM]);;
e (LET_TAC THEN REPEAT STRIP_TAC);;

e (ASM_CASES_TAC `i = 0`);;
e (NEW_GOAL `F`);;
e (UNDISCH_TAC `X = mcell i V ul`);;
e (ASM_REWRITE_TAC[MCELL_EXPLICIT; mcell0]);;
e (STRIP_TAC);;
e (NEW_GOAL `X:real^3->bool INTER C = {}`);;
e (REWRITE_TAC[SET_RULE `x = {} <=> (!t. ~(t IN x))`]);;
e (REPEAT STRIP_TAC);;
e (NEW_GOAL `~(t:real^3 IN ball (HD ul, sqrt (&2)))`);;
e (ASM_SET_TAC[]);;
e (NEW_GOAL `t:real^3 IN ball (HD ul, sqrt (&2)))`);;
e (ASM_SET_TAC[]);;


b();;

e (ASM_REWRITE_TAC[] THEN EXPAND_TAC "C");;


b();;


HAS_MEASURE_LUNE;;
HAS_MEASURE_LUNE_SIMPLE;;
rcone_ge;;
rconesgn;;

search [`barV`];;

mcell1;;
mcell2;;
mcell3;;
mcell4;;


Ajripqn.AJRIPQN;;
mcell1;;

search [`mcell i V ul = s`];;



aff
KIZHLTL1;;
KIZHLTL2;;
dihu2;;
dihu3;;
dihu4;;


search [`rogers`; `voronoi_closed`];;



(* Lemmas using often *)

MEASURE_DISJOINT_UNIONS_IMAGE;;
MEASURE_NEGLIGIBLE_UNIONS_IMAGE;;
SUM_CONST;;
FINITE_IMAGE_EXPAND;;

packing;;

(* -------------------------------------------------------------- *)



g `!ul a b k. {a, b} SUBSET set_of_list (truncate_simplex k ul) ==> 
        ?vl. ([a;b] = truncate_simplex 1 vl /\ 
             (?p. p permutes 0..k /\ vl = left_action_list p ul))`;;
e (REPEAT STRIP_TAC);;

;;

search []