

let aff_ge_alt = new_definition
 `aff_ge_alt s t (v:real^3) <=>
         (?f q. FINITE q /\ q SUBSET t /\ v = lin_combo (s UNION q) f /\
              (!w. q w ==> &0 <= f w) /\
              sum (s UNION q) f = &1)`;;

(* #use "/home/vu/flyspeck/working/marchal_cells_3.hl";;          *)
(* back up for the proof *)

let GRUTOTI1_concl = 
`!V u0 u1 e.
     saturated V /\
     packing V /\
     u0 IN V /\
     u1 IN V /\
     ~(u0 = u1) /\
     hl [u0;u1] < sqrt (&2) /\
     e = {u0, u1}
     ==> sum {X | e IN edgeX V X} (\t. dihX V t (u0,u1)) = &2 * pi`;;

g GRUTOTI1_concl;;
e (REPEAT STRIP_TAC);;
e (NEW_GOAL `barV V 1 [u0;u1:real^3]`);;
e (MATCH_MP_TAC HL_LE_SQRT2_IMP_BARV_1);;
e (ASM_REWRITE_TAC[]);;
e (NEW_GOAL 
  `{k | k IN 1..3 /\
        voronoi_list V [u0;u1:real^3] =
        UNIONS
          {convex hull
          ({omega_list_n V vl i | i IN 1..k - 1} UNION
            voronoi_list V vl) | vl | barV V k vl /\
                                      truncate_simplex 1 vl = [u0;u1]}} =
             1..3`);;
e (MATCH_MP_TAC Rogers.GLTVHUM_lemma1);;
e (ASM_REWRITE_TAC[] THEN ARITH_TAC);;
e (NEW_GOAL 
 `3 IN {k | k IN 1..3 /\
          voronoi_list V [u0; u1] =
          UNIONS
          {convex hull
         ({omega_list_n V vl i | i IN 1..k - 1} UNION voronoi_list V vl) | vl | 
          barV V k vl /\
          truncate_simplex 1 vl = [u0; u1]}}`);;
e (ASM_REWRITE_TAC[IN_NUMSEG] THEN ARITH_TAC);;
e (UP_ASM_TAC THEN ONCE_REWRITE_TAC[IN] THEN REWRITE_TAC[IN_ELIM_THM]);;
e (REWRITE_WITH 
   `UNIONS
   {convex hull ({omega_list_n V vl i | i IN 1..3 - 1} UNION voronoi_list V vl)      | vl | barV V 3 vl /\
           truncate_simplex 1 vl = [u0; u1]} = 
   UNIONS {convex hull {omega_list_n V vl 1, omega_list_n V vl 2, 
           omega_list_n V vl 3} | vl | barV V 3 vl /\
                                       truncate_simplex 1 vl = [u0; u1]}`);;
e (ONCE_REWRITE_TAC[SET_EQ_LEMMA]);;
e (REWRITE_TAC[IN_UNIONS] THEN ONCE_REWRITE_TAC[IN] THEN 
   REWRITE_TAC[IN_ELIM_THM]);;
e (REPEAT STRIP_TAC);;
e (EXISTS_TAC `t:real^3->bool` THEN ASM_REWRITE_TAC[]);;
e (EXISTS_TAC `vl:(real^3)list`);;
e (ASM_REWRITE_TAC[]);;
e (NEW_GOAL `?a. voronoi_list V vl = {a} /\
                    a = circumcenter (set_of_list vl) /\
                    hl vl = dist (HD vl,a)`);;
e (MATCH_MP_TAC Marchal_cells_2_new.VORONOI_LIST_3_SINGLETON_EXPLICIT);;
e (ASM_REWRITE_TAC[]);;
e (UP_ASM_TAC THEN STRIP_TAC);;

e (NEW_GOAL `omega_list_n V vl 3 IN voronoi_list V vl`);;
e (REWRITE_WITH `omega_list_n V vl 3 = omega_list V vl`);;
e (REWRITE_TAC[OMEGA_LIST]);;
e (REWRITE_WITH `LENGTH (vl:(real^3)list) = 3 + 1 /\ 
                 CARD (set_of_list vl) = 3 + 1`);;
e (MATCH_MP_TAC Rogers.BARV_IMP_LENGTH_EQ_CARD);;
e (EXISTS_TAC `V:real^3->bool`);;
e (ASM_REWRITE_TAC[]);;
e (REWRITE_TAC[ARITH_RULE `(3 + 1) - 1 = 3`]);;
e (MATCH_MP_TAC Packing3.OMEGA_LIST_IN_VORONOI_LIST);;
e (EXISTS_TAC `3` THEN ASM_REWRITE_TAC[]);;
e (NEW_GOAL `omega_list_n V vl 3 = a`);;
e (ASM_SET_TAC[]);;
e (ASM_REWRITE_TAC[]);;
e (REWRITE_TAC[ARITH_RULE `3 - 1 = 2`; IN_NUMSEG; 
   ARITH_RULE `1 <= i /\ i <= 2 <=> i = 1 \/ i = 2`]);;
e (REWRITE_WITH `{omega_list_n V vl i | i = 1 \/ i = 2} = 
                 {omega_list_n V vl 1,omega_list_n V vl 2}`);;
e (SET_TAC[]);;
e (REWRITE_WITH `{omega_list_n V vl 1, omega_list_n V vl 2} UNION
   {circumcenter (set_of_list vl)} = {omega_list_n V vl 1, omega_list_n V vl 2,      circumcenter (set_of_list vl)}`);;
e (SET_TAC[]);;

e (EXISTS_TAC `t:real^3->bool` THEN ASM_REWRITE_TAC[]);;
e (EXISTS_TAC `vl:(real^3)list`);;
e (ASM_REWRITE_TAC[]);;
e (NEW_GOAL `?a. voronoi_list V vl = {a} /\
                    a = circumcenter (set_of_list vl) /\
                    hl vl = dist (HD vl,a)`);;
e (MATCH_MP_TAC Marchal_cells_2_new.VORONOI_LIST_3_SINGLETON_EXPLICIT);;
e (ASM_REWRITE_TAC[]);;
e (UP_ASM_TAC THEN STRIP_TAC);;

e (NEW_GOAL `omega_list_n V vl 3 IN voronoi_list V vl`);;
e (REWRITE_WITH `omega_list_n V vl 3 = omega_list V vl`);;
e (REWRITE_TAC[OMEGA_LIST]);;
e (REWRITE_WITH `LENGTH (vl:(real^3)list) = 3 + 1 /\ 
                 CARD (set_of_list vl) = 3 + 1`);;
e (MATCH_MP_TAC Rogers.BARV_IMP_LENGTH_EQ_CARD);;
e (EXISTS_TAC `V:real^3->bool`);;
e (ASM_REWRITE_TAC[]);;
e (REWRITE_TAC[ARITH_RULE `(3 + 1) - 1 = 3`]);;
e (MATCH_MP_TAC Packing3.OMEGA_LIST_IN_VORONOI_LIST);;
e (EXISTS_TAC `3` THEN ASM_REWRITE_TAC[]);;
e (NEW_GOAL `omega_list_n V vl 3 = a`);;
e (ASM_SET_TAC[]);;
e (ASM_REWRITE_TAC[]);;
e (REWRITE_TAC[ARITH_RULE `3 - 1 = 2`; IN_NUMSEG; 
   ARITH_RULE `1 <= i /\ i <= 2 <=> i = 1 \/ i = 2`]);;
e (REWRITE_WITH `{omega_list_n V vl i | i = 1 \/ i = 2} = 
                 {omega_list_n V vl 1,omega_list_n V vl 2}`);;
e (SET_TAC[]);;
e (REWRITE_WITH `{omega_list_n V vl 1, omega_list_n V vl 2} UNION
   {circumcenter (set_of_list vl)} = {omega_list_n V vl 1, omega_list_n V vl 2,      circumcenter (set_of_list vl)}`);;
e (SET_TAC[]);;
e (STRIP_TAC);;

(* ======================================================================= *)

e (ABBREV_TAC `p = circumcenter {u0, u1:real^3}`);;
e (NEW_GOAL `aff_dim (u0 INSERT voronoi_list V [u0;u1]) = &3`);;
e (REWRITE_TAC[AFF_DIM_INSERT]);;
e (COND_CASES_TAC);;
e (NEW_GOAL `F`);;

e (NEW_GOAL `affine hull voronoi_list V [u0; u1] SUBSET 
   affine hull {x | &2 % (u0 - u1) dot x = norm u0 pow 2 - norm u1 pow 2}`);;
e (MATCH_MP_TAC Marchal_cells_2_new.AFFINE_SUBSET_KY_LEMMA);;
e (REWRITE_TAC[VORONOI_LIST; set_of_list; Packing3.VORONOI_SET_2]);;
e (ONCE_REWRITE_TAC[SET_RULE `a INTER b = b INTER a`]);;
e (ASM_SIMP_TAC[Pack2.INTER_VORONOI_SUBSET_BISECTOR]);;
e (NEW_GOAL 
  `affine hull {x | &2 % (u0 - u1) dot x = norm u0 pow 2 - norm u1 pow 2} = 
   {x:real^3 | &2 % (u0 - u1) dot x = norm u0 pow 2 - norm u1 pow 2}`);;
e (REWRITE_TAC[AFFINE_HULL_EQ]);;
e (REWRITE_TAC[AFFINE_HYPERPLANE]);;
e (NEW_GOAL 
 `~(u0 IN {x:real^3 | &2 % (u0 - u1) dot x = norm u0 pow 2 - norm u1 pow 2})`);;
e (REWRITE_TAC[IN; IN_ELIM_THM; NORM_POW_2]);;
e (ONCE_REWRITE_TAC [REAL_ARITH `a = b <=> a - b = &0`]);;
e (REWRITE_TAC[VECTOR_ARITH `&2 % (u0 - u1) dot u0 - (u0 dot u0 - u1 dot u1) = 
                (u0 - u1) dot (u0 - u1)`]);;
e (REWRITE_TAC[DOT_EQ_0] THEN ASM_NORM_ARITH_TAC);;
e (ASM_SET_TAC[]);;
e (ASM_MESON_TAC[]);;
e (REWRITE_TAC[ARITH_RULE `a + &1 = b:int <=> a = b - &1`]);;
e (MATCH_MP_TAC Packing3.AFF_DIM_VORONOI_LIST);;
e (ASM_REWRITE_TAC[]);;

e (NEW_GOAL `aff_dim (u0 INSERT voronoi_list V [u0; u1]) = &(dimindex (:3))`);;
e (ASM_REWRITE_TAC[DIMINDEX_3]);;
e (UP_ASM_TAC THEN REWRITE_TAC[AFF_DIM_EQ_FULL]);;
e (STRIP_TAC);;

e (ABBREV_TAC `S = voronoi_list V [u0;u1]`);;
e (NEW_GOAL `!x. x IN S ==> (x - u0) dot (u1 - u0) = 
                            dist (p, u0) * dist (u1, u0:real^3)`);;
e (REPEAT STRIP_TAC);;
e (NEW_GOAL `p = inv (&2) % (u0 + (u1:real^3))`);;
e (EXPAND_TAC "p" THEN REWRITE_TAC[Rogers.CIRCUMCENTER_2; midpoint]);;
e (REWRITE_TAC[dist]);;
e (REWRITE_WITH `u1 - u0 = &2 % (p - u0:real^3)`);;
e (ASM_REWRITE_TAC[]);;
e (VECTOR_ARITH_TAC);;
e (REWRITE_TAC[NORM_MUL; REAL_ARITH `abs (&2) = &2`;
   REAL_ARITH `a * b * a = b * a pow 2`; NORM_POW_2; DOT_RMUL]);;
e (REWRITE_WITH `(x - u0) dot (p - u0:real^3) = 
                 (p - u0) dot (p - u0) - (x - p) dot (u0 - p)`);;
e (VECTOR_ARITH_TAC);;
e (REWRITE_WITH `(x - p) dot (u0 - p:real^3) = &0`);;
e (EXPAND_TAC "p");;
e (REWRITE_WITH `{u0, u1} = set_of_list [u0; u1:real^3]`);;
e (REWRITE_TAC[set_of_list]);;
e (MATCH_MP_TAC Rogers.MHFTTZN4);;
e (EXISTS_TAC `V:real^3->bool` THEN EXISTS_TAC `1`);;
e (REPEAT STRIP_TAC);;
e (ASM_REWRITE_TAC[]);;
e (ASM_REWRITE_TAC[]);;
e (NEW_GOAL `S SUBSET affine hull voronoi_list V [u0; u1]`);;
e (EXPAND_TAC "S");;
e (REWRITE_TAC[Qzksykg.SET_SUBSET_AFFINE_HULL]);;
e (ASM_SET_TAC[]);;
e (REWRITE_TAC[set_of_list]);;
e (NEW_GOAL `{u0,u1} SUBSET affine hull {u0,u1:real^3}`);;
e (REWRITE_TAC[Qzksykg.SET_SUBSET_AFFINE_HULL]);;
e (ASM_SET_TAC[]);;
e (REAL_ARITH_TAC);;

(* ========================================================================= *)

e (ABBREV_TAC `S1 = {x:real^3 | &2 % (u0 - u1) dot x = 
                                norm u0 pow 2 - norm u1 pow 2}`);;
e (ABBREV_TAC `S2:real^3->bool = (S1 DIFF (relative_interior S))`);;
e (NEW_GOAL `closed_in (subtopology euclidean (S1:real^3->bool)) S2`);;
e (EXPAND_TAC "S2");;
e (MATCH_MP_TAC CLOSED_IN_DIFF);;
e (STRIP_TAC);;
e (NEW_GOAL `closed (S1:real^3->bool)`);;
e (EXPAND_TAC "S1" THEN REWRITE_TAC[CLOSED_HYPERPLANE]);;
e (MATCH_MP_TAC CLOSED_SUBSET);;
e (ASM_REWRITE_TAC[] THEN SET_TAC[]);;

e (REWRITE_WITH `S1 = affine hull (S:real^3->bool)`);;
e (EXPAND_TAC "S");;
e (NEW_GOAL `affine hull S1 = S1:real^3->bool`);;
e (REWRITE_TAC[AFFINE_HULL_EQ]);;
e (EXPAND_TAC "S1" THEN REWRITE_TAC[AFFINE_HYPERPLANE]);;
e (ONCE_REWRITE_TAC[GSYM (ASSUME `affine hull S1 = S1:real^3->bool`)]);;
e (ONCE_REWRITE_TAC[EQ_SYM_EQ]);;
e (MATCH_MP_TAC AFF_DIM_EQ_AFFINE_HULL);;
e (STRIP_TAC);;
e (REWRITE_TAC[VORONOI_LIST; VORONOI_SET; set_of_list; 
   SET_RULE `INTERS {f x | x IN {a, b}} = f a INTER f b`]);;
e (DEL_TAC THEN EXPAND_TAC "S1");;
e (MATCH_MP_TAC Pack2.INTER_VORONOI_SUBSET_BISECTOR);;
e (ASM_REWRITE_TAC[]);;
e (REWRITE_WITH `aff_dim (S1:(real^3->bool)) = &(dimindex (:3)) - &1`);;
e (DEL_TAC THEN EXPAND_TAC "S1");;
e (MATCH_MP_TAC AFF_DIM_HYPERPLANE);;
e (REWRITE_TAC[VECTOR_ARITH `&2 % (s - t) = vec 0 <=> s = t`]);;
e (ASM_REWRITE_TAC[]);;
e (REWRITE_TAC[DIMINDEX_3]);;
e (REWRITE_WITH `aff_dim (voronoi_list V [u0;u1:real^3]) = &3 - &1`);;
e (MATCH_MP_TAC Packing3.AFF_DIM_VORONOI_LIST);;
e (ASM_REWRITE_TAC[]);;
e (ARITH_TAC);;

e (REWRITE_TAC[OPEN_IN_RELATIVE_INTERIOR]);;

e (NEW_GOAL `closed (S2:real^3->bool)`);;
e (MATCH_MP_TAC CLOSED_IN_CLOSED_TRANS);;
e (EXISTS_TAC `S1:real^3->bool`);;
e (ASM_REWRITE_TAC[]);;
e (EXPAND_TAC "S1");;
e (REWRITE_TAC[CLOSED_HYPERPLANE]);;


e (NEW_GOAL `~(S2:real^3->bool = {})`);;
e (EXPAND_TAC "S2");;
e (REWRITE_TAC [SET_RULE `A DIFF B = {} <=> A SUBSET B`]);;
e (REPEAT STRIP_TAC);;
e (NEW_GOAL `S1 SUBSET S:real^3->bool`);;
e (NEW_GOAL `relative_interior S SUBSET S:real^3->bool`);;
e (REWRITE_TAC[RELATIVE_INTERIOR_SUBSET]);;
e (UP_ASM_TAC THEN UP_ASM_TAC THEN SET_TAC[]);;

e (NEW_GOAL `S1 = S:real^3->bool`);;
e (NEW_GOAL `S SUBSET S1:real^3->bool`);;
e (EXPAND_TAC "S");;
e (REWRITE_TAC[VORONOI_LIST; VORONOI_SET; set_of_list; 
   SET_RULE `INTERS {f x | x IN {a, b}} = f a INTER f b`]);;
e (EXPAND_TAC "S1");;
e (MATCH_MP_TAC Pack2.INTER_VORONOI_SUBSET_BISECTOR);;
e (ASM_REWRITE_TAC[]);;
e (UP_ASM_TAC THEN UP_ASM_TAC THEN SET_TAC[]);;

e (NEW_GOAL `bounded (S1:real^3->bool)`);;
e (REWRITE_TAC[ASSUME `S1 = S:real^3->bool`]);;
e (DEL_TAC THEN EXPAND_TAC "S");;
e (MATCH_MP_TAC Packing3.BOUNDED_VORONOI_LIST);;
e (EXISTS_TAC `1`);;
e (ASM_REWRITE_TAC[]);;
 
e (NEW_GOAL `~bounded (S1:real^3->bool)`);;
e (EXPAND_TAC "S1");;
e (MATCH_MP_TAC UNBOUNDED_HYPERPLANE);;
e (REWRITE_TAC[VECTOR_ARITH `&2 % (u0 - u1) = vec 0 <=> u0 = u1`]);;
e (ASM_REWRITE_TAC[]);;
e (ASM_MESON_TAC[]);;

e (NEW_GOAL `?z:real^3. z IN S2 /\ 
                (!w. w IN S2 ==> dist (u0,z) <= dist (u0,w))`);;
e (MATCH_MP_TAC DISTANCE_ATTAINS_INF);;
e (ASM_REWRITE_TAC[]);;
e (UP_ASM_TAC THEN STRIP_TAC);;

(* ======================================================================== *)

e (ABBREV_TAC `a = dist (p, u0:real^3) / dist (z, u0)`);;
e (NEW_GOAL `&0 < a /\ a < &1`);;
e (EXPAND_TAC "a");;
e (NEW_GOAL `~(u0:real^3 IN S1)`);;
e (EXPAND_TAC "S1" THEN REWRITE_TAC[IN; IN_ELIM_THM; NORM_POW_2]);;
e (REWRITE_TAC[REAL_ARITH `a = b - c <=> a + c - b = &0`]);;
e (REWRITE_TAC[VECTOR_ARITH `&2 % (u0 - u1) dot u0 + u1 dot u1 - u0 dot u0 = 
  (u0 - u1) dot (u0 - u1)`]);;
e (REWRITE_TAC[DOT_EQ_0; VECTOR_ARITH `a - b = vec 0 <=> a = b`]);;
e (ASM_REWRITE_TAC[]);;
e (NEW_GOAL `&0 < dist (p,u0:real^3)`);;
e (MATCH_MP_TAC DIST_POS_LT);;
e (EXPAND_TAC "p" THEN REWRITE_TAC[Rogers.CIRCUMCENTER_2; midpoint]);;
e (REWRITE_TAC[VECTOR_ARITH `inv (&2) % (u0 + u1) = u0 <=> u0 = u1`]);;
e (ASM_REWRITE_TAC[]);;
e (NEW_GOAL `&0 < dist (z,u0:real^3)`);;
e (MATCH_MP_TAC DIST_POS_LT);;
e (STRIP_TAC);;
e (NEW_GOAL `z:real^3 IN S1`);;
e (ASM_SET_TAC[]);;
e (ASM_MESON_TAC[]);;
e (STRIP_TAC);;
e (MATCH_MP_TAC REAL_LT_DIV);;
e (ASM_REWRITE_TAC[]);;
e (REWRITE_WITH 
  `dist (p,u0) / dist (z,u0:real^3) < &1 <=> dist (p,u0) < &1 * dist (z,u0)`);;
e (ASM_SIMP_TAC[REAL_LT_LDIV_EQ]);;
e (REWRITE_TAC[REAL_MUL_LID]);;
e (MATCH_MP_TAC Tactics_jordan.REAL_POW_2_LT);;
e (REPEAT STRIP_TAC);;
e (ASM_REAL_ARITH_TAC);;
e (ASM_REAL_ARITH_TAC);;
e (REWRITE_TAC[dist]);;
e (REWRITE_WITH `norm (z - u0:real^3) pow 2 = 
                 norm (p - u0) pow 2 + norm (z - p) pow 2`);;
e (MATCH_MP_TAC PYTHAGORAS);;
e (REWRITE_TAC[orthogonal]);;
e (REWRITE_WITH `p = circumcenter (set_of_list [u0;u1:real^3])`);;
e (ASM_REWRITE_TAC[set_of_list]);;
e (ONCE_REWRITE_TAC[DOT_SYM]);;
e (MATCH_MP_TAC Rogers.MHFTTZN4);;
e (EXISTS_TAC `V:real^3->bool` THEN EXISTS_TAC `1`);;
e (REPEAT STRIP_TAC);;
e (ASM_REWRITE_TAC[]);;
e (ASM_REWRITE_TAC[]);;

e (REWRITE_TAC[ASSUME `voronoi_list V [u0; u1] = S`]);;
e (REWRITE_WITH `affine hull (S:real^3->bool) = S1`);;
e (ONCE_REWRITE_TAC[EQ_SYM_EQ]);;
e (EXPAND_TAC "S");;
e (NEW_GOAL `affine hull S1 = S1:real^3->bool`);;
e (REWRITE_TAC[AFFINE_HULL_EQ]);;
e (EXPAND_TAC "S1" THEN REWRITE_TAC[AFFINE_HYPERPLANE]);;
e (ONCE_REWRITE_TAC[GSYM (ASSUME `affine hull S1 = S1:real^3->bool`)]);;
e (ONCE_REWRITE_TAC[EQ_SYM_EQ]);;
e (MATCH_MP_TAC AFF_DIM_EQ_AFFINE_HULL);;
e (STRIP_TAC);;
e (REWRITE_TAC[VORONOI_LIST; VORONOI_SET; set_of_list; 
   SET_RULE `INTERS {f x | x IN {a, b}} = f a INTER f b`]);;
e (DEL_TAC THEN EXPAND_TAC "S1");;
e (MATCH_MP_TAC Pack2.INTER_VORONOI_SUBSET_BISECTOR);;
e (ASM_REWRITE_TAC[]);;
e (REWRITE_WITH `aff_dim (S1:(real^3->bool)) = &(dimindex (:3)) - &1`);;
e (DEL_TAC THEN EXPAND_TAC "S1");;
e (MATCH_MP_TAC AFF_DIM_HYPERPLANE);;
e (REWRITE_TAC[VECTOR_ARITH `&2 % (s - t) = vec 0 <=> s = t`]);;
e (ASM_REWRITE_TAC[]);;
e (REWRITE_TAC[DIMINDEX_3]);;
e (REWRITE_WITH `aff_dim (voronoi_list V [u0;u1:real^3]) = &3 - &1`);;
e (MATCH_MP_TAC Packing3.AFF_DIM_VORONOI_LIST);;
e (ASM_REWRITE_TAC[]);;
e (ARITH_TAC);;
e (ASM_SET_TAC[]);;
e (REWRITE_TAC[set_of_list]);;
e (NEW_GOAL `{u0, u1:real^3} SUBSET affine hull {u0, u1}`);;
e (REWRITE_TAC[Qzksykg.SET_SUBSET_AFFINE_HULL]);;
e (ASM_SET_TAC[]);;
e (REWRITE_TAC[REAL_ARITH `a < a + b <=> &0 < b`; NORM_POW_2; DOT_POS_LT]);;
e (REWRITE_TAC[VECTOR_ARITH `a - b = vec 0 <=> a = b`]);;
e (STRIP_TAC);;
e (NEW_GOAL `~(z:real^3 IN S2)`);;
e (REWRITE_TAC[ASSUME `z = p:real^3`]);;
e (EXPAND_TAC "S2");;
e (NEW_GOAL `p:real^3 IN relative_interior S`);;



e (ABBREV_TAC `B = V INTER ball (p:real^3, &8)`);;
e (ABBREV_TAC `A = B DIFF {u0, u1:real^3}`);;
e (NEW_GOAL `FINITE (A:real^3->bool)`);;
e (EXPAND_TAC "A");;
e (MATCH_MP_TAC FINITE_DIFF);;
e (EXPAND_TAC "B");;
e (MATCH_MP_TAC Packing3.KIUMVTC THEN ASM_REWRITE_TAC[]);;
e (NEW_GOAL `?y. dist (p,y:real^3) = &4`);;
e (MATCH_MP_TAC VECTOR_CHOOSE_DIST);;
e (REAL_ARITH_TAC);;
e (UP_ASM_TAC THEN STRIP_TAC);;
e (UNDISCH_TAC `saturated (V:real^3->bool)`);;
e (REWRITE_TAC[saturated] THEN STRIP_TAC);;
e (NEW_GOAL `?z. z IN V /\ dist (y:real^3, z) < &2`);;
e (ASM_REWRITE_TAC[]);;
e (UP_ASM_TAC THEN STRIP_TAC);;

e (NEW_GOAL `z':real^3 IN A`);;
e (EXPAND_TAC "A" THEN EXPAND_TAC "B");;
e (REWRITE_TAC[IN_DIFF; IN_INTER; IN_BALL]);;
e (REPEAT STRIP_TAC);;
e (ASM_REWRITE_TAC[]);;

e (NEW_GOAL `dist (p,z') <= dist (p, y) + dist (y, z':real^3)`);;
e (REWRITE_TAC[DIST_TRIANGLE]);;
e (ASM_REAL_ARITH_TAC);;
e (NEW_GOAL `dist (p, y) <= dist (p, z') + dist (z', y:real^3)`);;
e (REWRITE_TAC[DIST_TRIANGLE]);;
e (UP_ASM_TAC THEN ASM_REWRITE_TAC[] THEN ONCE_REWRITE_TAC[DIST_SYM]);;
e (STRIP_TAC);;
e (NEW_GOAL `&2 < dist (z', p:real^3)`);;
e (ASM_REAL_ARITH_TAC);;
e (UP_ASM_TAC THEN REWRITE_TAC[] THEN ONCE_REWRITE_TAC[DIST_SYM]);;
e (REWRITE_WITH `p = circumcenter (set_of_list [u0;u1:real^3])`);;
e (ASM_MESON_TAC[set_of_list]);;
e (NEW_GOAL `(!w. w IN set_of_list [u0;u1:real^3]
               ==> dist (circumcenter (set_of_list [u0;u1]),w) = hl [u0;u1])`);;
e (MATCH_MP_TAC Rogers.HL_PROPERTIES);;
e (EXISTS_TAC `V:real^3->bool` THEN EXISTS_TAC `1`);;
e (ASM_REWRITE_TAC[]);;

e (REWRITE_WITH `dist (circumcenter (set_of_list [u0; u1:real^3]),z') = 
   hl [u0; u1]`);;
e (FIRST_ASSUM MATCH_MP_TAC);;
e (ASM_REWRITE_TAC[set_of_list]);;
e (NEW_GOAL `sqrt (&2) <= &2`);;
e (MATCH_MP_TAC Tactics_jordan.REAL_POW_2_LE);;
e (SIMP_TAC[REAL_ARITH `&0 <= &2`; SQRT_POS_LE; SQRT_POW_2]);;
e (REAL_ARITH_TAC);;
e (ASM_REAL_ARITH_TAC);;

e (NEW_GOAL `?a:real^3. a IN A /\ (!x. x IN A ==> dist (p,a) <= dist (p,x))`);;
e (MATCH_MP_TAC Packing3.REAL_FINITE_ARGMIN);;
e (ASM_REWRITE_TAC[]);;
e (UP_ASM_TAC THEN SET_TAC[]);;
e (UP_ASM_TAC THEN STRIP_TAC);;





e (ABBREV_TAC `d = inv (&4) * (dist (p, a') - dist (p, u0:real^3))`);;
e (NEW_GOAL `&0 < d`);;
e (EXPAND_TAC "d");;
e (MATCH_MP_TAC REAL_LT_MUL);;
e (STRIP_TAC);;
e (REAL_ARITH_TAC);;
e (REWRITE_TAC[REAL_ARITH `&0 < a - b <=> a > b`]);;
e (ONCE_REWRITE_TAC[DIST_SYM]);;
e (NEW_GOAL `!u v. u IN {u0,u1} /\ v IN V DIFF {u0,u1} ==> 
                   dist (v,p) > dist (u,p:real^3)`);;
e (MATCH_MP_TAC Rogers.XYOFCGX);;
e (REPEAT STRIP_TAC);;
e (ASM_REWRITE_TAC[]);;
e (ASM_SET_TAC[]);;
e (UP_ASM_TAC THEN REWRITE_TAC[AFFINE_INDEPENDENT_2]);;
e (ASM_MESON_TAC[set_of_list]);;
e (REWRITE_WITH `radV {u0, u1:real^3} = hl [u0;u1]`);;
e (REWRITE_TAC[HL;set_of_list]);;
e (ASM_REWRITE_TAC[]);;
e (FIRST_ASSUM MATCH_MP_TAC);;
e (ASM_SET_TAC[]);;

e (REWRITE_TAC[relative_interior; IN; IN_ELIM_THM]);;
e (ABBREV_TAC `St = S INTER ball (p:real^3, d)`);;
e (EXISTS_TAC `St:real^3->bool`);;
e (REPEAT STRIP_TAC);;

e (REWRITE_TAC[open_in]);;
e (REPEAT STRIP_TAC);;
e (NEW_GOAL `S SUBSET affine hull (S:real^3->bool)`);;
e (REWRITE_TAC[Qzksykg.SET_SUBSET_AFFINE_HULL]);;
e (UP_ASM_TAC THEN UP_ASM_TAC THEN SET_TAC[]);;
e (EXISTS_TAC `d - dist (p:real^3, x)`);;
e (REPEAT STRIP_TAC);;
e (REWRITE_TAC[REAL_ARITH `&0 < a - b <=> b < a`]);;
e (REWRITE_TAC[GSYM IN_BALL]);;
e (ASM_SET_TAC[]);;
e (EXPAND_TAC "St");;
e (REWRITE_TAC[IN_INTER]);;
e (STRIP_TAC);;


e (NEW_GOAL `dist (x',x:real^3) < d`);;
e (NEW_GOAL `&0 <= dist (p,x:real^3)`);;
e (REWRITE_TAC[DIST_POS_LE]);;
e (ASM_REAL_ARITH_TAC);;

e (NEW_GOAL `x' IN voronoi_closed V (u0:real^3)`);;
e (REWRITE_TAC[voronoi_closed; IN; IN_ELIM_THM]);;
e (REPEAT STRIP_TAC);;

e (ASM_CASES_TAC `w IN {u0, u1:real^3}`);;
e (ASM_CASES_TAC `w = u0:real^3`);;
e (REWRITE_TAC[ASSUME `w = u0:real^3`]);;
e (REAL_ARITH_TAC);;
e (NEW_GOAL `w = u1:real^3`);;
e (ASM_SET_TAC[]);;
e (REWRITE_TAC[ASSUME `w = u1:real^3`]);;
e (MATCH_MP_TAC (REAL_ARITH `a = b ==> a <= b`));;






e (NEW_GOAL `x':real^3 IN S1`);;
e (NEW_GOAL `affine hull S SUBSET affine hull (S1:real^3->bool)`);;
e (MATCH_MP_TAC Marchal_cells_2_new.AFFINE_SUBSET_KY_LEMMA);;
e (EXPAND_TAC "S1" THEN REWRITE_TAC[GSYM 
  (ASSUME `voronoi_list V [u0; u1] = S`); VORONOI_LIST; VORONOI_SET; 
  set_of_list; SET_RULE `INTERS {f v | v IN {a, b}} = f a INTER f b`]);;
e (MATCH_MP_TAC Pack2.INTER_VORONOI_SUBSET_BISECTOR);;
e (ASM_REWRITE_TAC[]);;
e (REWRITE_WITH `x' IN S1 <=> x':real^3 IN affine hull S1`);;
e (REWRITE_WITH `affine hull S1 = S1:real^3->bool`);;
e (REWRITE_TAC[AFFINE_HULL_EQ]);;
e (EXPAND_TAC "S1" THEN REWRITE_TAC[AFFINE_HYPERPLANE]);;
e (ASM_SET_TAC[]);;

e (UP_ASM_TAC THEN EXPAND_TAC "S1" THEN REWRITE_TAC[IN_ELIM_THM; NORM_POW_2]);;
e (ONCE_REWRITE_TAC[REAL_ARITH `a = b <=> a - b = &0`]);;
e (REWRITE_TAC[
   VECTOR_ARITH `&2 % (u0 - u1) dot x - (u0 dot u0 - u1 dot u1) = 
                (u1 - x) dot (u1 - x) - (u0 - x) dot (u0 - x)`]);;
e (REWRITE_TAC[REAL_ARITH `a - b = &0 <=> a = b`; GSYM NORM_POW_2; GSYM dist]);;
e (STRIP_TAC);;
e (REWRITE_TAC[DIST_EQ]);;
e (ONCE_REWRITE_TAC[DIST_SYM]);;
e (ASM_REWRITE_TAC[]);;

e (NEW_GOAL `dist (x', u0:real^3) <= dist (x', x) + dist (x, u0)`);;
e (REWRITE_TAC[DIST_TRIANGLE]);;
e (NEW_GOAL `dist (x, u0:real^3) <= dist (x, p:real^3) + dist (p, u0)`);;
e (REWRITE_TAC[DIST_TRIANGLE]);;
e (NEW_GOAL `dist (x,p:real^3) < d`);;
e (NEW_GOAL `x IN ball (p:real^3, d)`);;
e (ASM_SET_TAC[]);;
e (UP_ASM_TAC THEN REWRITE_TAC[IN_BALL]);;
e (REWRITE_TAC[DIST_SYM]);;
e (NEW_GOAL `dist (x',u0) < &2 * d + dist (p:real^3,u0)`);;
e (ASM_REAL_ARITH_TAC);;

e (NEW_GOAL `dist (p, w:real^3)- &2 * d <= dist (x',w)`);;
e (NEW_GOAL `dist (x, w:real^3) <= dist (x, x') + dist (x', w)`);;
e (REWRITE_TAC[DIST_TRIANGLE]);;
e (NEW_GOAL `dist (p, w:real^3) <= dist (p, x) + dist (x, w)`);;
e (REWRITE_TAC[DIST_TRIANGLE]);;
e (NEW_GOAL `dist (x, x':real^3) < d /\ dist (p, x:real^3) < d`);;
e (ONCE_REWRITE_TAC[DIST_SYM] THEN ASM_REWRITE_TAC[]);;
e (ASM_REAL_ARITH_TAC);;
e (NEW_GOAL `dist (p, u0) + &4 * d <= dist (p, w:real^3)`);;
e (EXPAND_TAC "d");;
e (REWRITE_TAC[REAL_ARITH `&4 * inv (&4) * a = a`]);;
e (REWRITE_TAC[REAL_ARITH `a + b - a = b`]);;

e (ASM_CASES_TAC `w:real^3 IN B`);;
e (FIRST_ASSUM MATCH_MP_TAC);;
e (ASM_SET_TAC[]);;
e (NEW_GOAL `~(dist (p,w:real^3) < &8)`);;
e (REWRITE_TAC[GSYM IN_BALL]);;
e (ASM_SET_TAC[]);;
e (NEW_GOAL `dist (p,a':real^3) < &8`);;
e (REWRITE_TAC[GSYM IN_BALL]);;
e (ASM_SET_TAC[]);;
e (ASM_REAL_ARITH_TAC);;
e (ASM_REAL_ARITH_TAC);;




e (NEW_GOAL `x' IN voronoi_closed V (u1:real^3)`);;
e (NEW_GOAL `x':real^3 IN S1`);;
e (NEW_GOAL `affine hull S SUBSET affine hull (S1:real^3->bool)`);;
e (MATCH_MP_TAC Marchal_cells_2_new.AFFINE_SUBSET_KY_LEMMA);;
e (EXPAND_TAC "S1" THEN REWRITE_TAC[GSYM 
  (ASSUME `voronoi_list V [u0; u1] = S`); VORONOI_LIST; VORONOI_SET; 
  set_of_list; SET_RULE `INTERS {f v | v IN {a, b}} = f a INTER f b`]);;
e (MATCH_MP_TAC Pack2.INTER_VORONOI_SUBSET_BISECTOR);;
e (ASM_REWRITE_TAC[]);;
e (REWRITE_WITH `x' IN S1 <=> x':real^3 IN affine hull S1`);;
e (REWRITE_WITH `affine hull S1 = S1:real^3->bool`);;
e (REWRITE_TAC[AFFINE_HULL_EQ]);;
e (EXPAND_TAC "S1" THEN REWRITE_TAC[AFFINE_HYPERPLANE]);;
e (ASM_SET_TAC[]);;

e (UP_ASM_TAC THEN EXPAND_TAC "S1" THEN REWRITE_TAC[IN_ELIM_THM; NORM_POW_2]);;
e (ONCE_REWRITE_TAC[REAL_ARITH `a = b <=> a - b = &0`]);;
e (REWRITE_TAC[
   VECTOR_ARITH `&2 % (u0 - u1) dot x - (u0 dot u0 - u1 dot u1) = 
                (u1 - x) dot (u1 - x) - (u0 - x) dot (u0 - x)`]);;
e (REWRITE_TAC[REAL_ARITH `a - b = &0 <=> a = b`; GSYM NORM_POW_2; GSYM dist]);;
e (STRIP_TAC);;
e (UNDISCH_TAC `x' IN voronoi_closed V (u0:real^3)`);;
e (REWRITE_TAC[voronoi_closed; IN_ELIM_THM; IN]);;
e (REPEAT STRIP_TAC);;
e (REWRITE_WITH `dist (x', u1)= dist (x', u0:real^3)`);;
e (ONCE_REWRITE_TAC[DIST_SYM]);;
e (ASM_REWRITE_TAC[DIST_EQ]);;
e (ASM_SIMP_TAC[]);;

e (REWRITE_TAC[GSYM 
  (ASSUME `voronoi_list V [u0; u1] = S`); VORONOI_LIST; VORONOI_SET; 
  set_of_list; SET_RULE `INTERS {f v | v IN {a, b}} = f a INTER f b`]);;
e (ASM_REWRITE_TAC[IN_INTER]);;

e (REWRITE_TAC[IN_BALL]);;
e (NEW_GOAL `dist (p,x':real^3) <= dist (p,x) + dist (x, x':real^3)`);;
e (REWRITE_TAC[DIST_TRIANGLE]);;
e (NEW_GOAL `dist (x,x':real^3) = dist (x',x)`);;
e (REWRITE_TAC[DIST_SYM]);;
e (ASM_REAL_ARITH_TAC);;
e (REWRITE_WITH `St p <=> p:real^3 IN St`);;
e (REWRITE_TAC[IN]);;
e (EXPAND_TAC "St" THEN REWRITE_TAC[IN_INTER; IN_BALL; DIST_REFL]);;
e (STRIP_TAC);;
e (REWRITE_WITH `p = omega_list V [u0; u1]`);;
e (ONCE_REWRITE_TAC[EQ_SYM_EQ]);;
e (REWRITE_WITH `p = circumcenter (set_of_list [u0;u1:real^3])`);;
e (ASM_MESON_TAC[set_of_list]);;
e (MATCH_MP_TAC Rogers.XNHPWAB1);;
e (EXISTS_TAC `1`);;
e (ASM_REWRITE_TAC[IN]);;
e (REWRITE_TAC[GSYM (ASSUME `voronoi_list V [u0;u1] = S`)]);;
e (MATCH_MP_TAC Packing3.OMEGA_LIST_IN_VORONOI_LIST);;
e (EXISTS_TAC `1` THEN ASM_REWRITE_TAC[]);;
e (ASM_REWRITE_TAC[]);;
e (UP_ASM_TAC THEN SET_TAC[]);;
e (UP_ASM_TAC THEN SET_TAC[]);;
e (ASM_MESON_TAC[]);;

(* ======================================================================== *)

e (NEW_GOAL `?b. &0 < b /\ b < &1 /\ 
                  rcone_gt u0 u1 b SUBSET aff_ge_alt {u0:real^3} S`);;

e (EXISTS_TAC `a:real`);;
e (REPEAT STRIP_TAC);;
e (ASM_REWRITE_TAC[]);;
e (ASM_REWRITE_TAC[]);;
e (REWRITE_TAC[SET_RULE `A SUBSET B <=> (!x. ~(x IN B) ==> ~(x IN A))`]);;
e (REPEAT STRIP_TAC);;
e (NEW_GOAL `x:real^3 IN affine hull (u0 INSERT S)`);;
e (ASM_SET_TAC[]);;
e (UP_ASM_TAC THEN REWRITE_TAC[AFFINE_HULL_EXPLICIT_ALT; IN; IN_ELIM_THM]);;
e (REPEAT STRIP_TAC);;

e (ABBREV_TAC `h = sum (s DELETE u0:real^3) u`);;
e (NEW_GOAL `(x - u0) dot (u1 - u0:real^3) = 
              h * dist (p, u0) * dist (u1, u0:real^3)`);;
e (EXPAND_TAC "x");;
e (NEW_GOAL `u0 = vsum s (\v:real^3. (u:real^3->real) v % (u0:real^3))`);;
e (ASM_SIMP_TAC[VSUM_RMUL]);;
e (VECTOR_ARITH_TAC);;
e (REWRITE_WITH `vsum (s:real^3->bool) (\v. u v % v) - u0:real^3 = 
                 vsum s (\v. u v % v) - vsum s (\v:real^3. u v % u0)`);;
e (ASM_REWRITE_TAC[]);;
e (UP_ASM_TAC THEN MESON_TAC[]);;
e (REWRITE_WITH `vsum s (\v. u v % v) - vsum s (\v:real^3. u v % u0:real^3) = 
                 vsum s (\x. (\v. u v % v) x - (\v. u v % u0) x)`);;
e (ONCE_REWRITE_TAC[EQ_SYM_EQ]);;
e (MATCH_MP_TAC VSUM_SUB);;
e (ASM_REWRITE_TAC[]);;
e (REWRITE_TAC[VECTOR_ARITH `a % x - a % y = a % (x - y)`]);;
e (REWRITE_WITH `vsum s (\x:real^3. u x % (x - u0)) dot (u1 - u0) = 
                 sum s (\x. (\x. u x % (x - u0)) x dot (u1 - u0:real^3))`);;
e (ASM_SIMP_TAC[DOT_LSUM]);;
e (REWRITE_TAC[DOT_LMUL]);;
e (REWRITE_WITH `sum s (\x:real^3. u x * ((x - u0) dot (u1 - u0:real^3))) = 
   sum (s DELETE u0) (\x. u x * (dist (p,u0) * dist (u1,u0)))`);;
e (ASM_CASES_TAC `u0:real^3 IN s`);;
e (NEW_GOAL `s = u0 INSERT (s DELETE u0:real^3)`);;
e (ASM_SET_TAC[]);;
e (NEW_GOAL `FINITE (s DELETE u0:real^3)`);;
e (MATCH_MP_TAC FINITE_SUBSET);;
e (EXISTS_TAC `s:real^3->bool` THEN ASM_REWRITE_TAC[] THEN SET_TAC[]);;

e (REWRITE_WITH `sum s (\x:real^3. u x * ((x - u0) dot (u1 - u0:real^3))) = 
   sum (u0 INSERT (s DELETE u0))  (\x. u x * ((x - u0) dot (u1 - u0)))`);;
e (ASM_MESON_TAC[]);;
e (ABBREV_TAC `f = (\x:real^3. u x * ((x - u0) dot (u1 - u0:real^3)))`);;
e (REWRITE_WITH `sum (u0:real^3 INSERT (s DELETE u0)) f = 
         (if u0 IN (s DELETE u0) then sum (s DELETE u0) f 
          else f u0 + sum (s DELETE u0) f)`);;
e (MATCH_MP_TAC Marchal_cells_2_new.SUM_CLAUSES_alt);;
e (ASM_REWRITE_TAC[]);;
e (COND_CASES_TAC);;
e (NEW_GOAL `F`);;
e (ASM_SET_TAC[]);;
e (ASM_MESON_TAC[]);;
e (REWRITE_WITH `f (u0:real^3) = &0`);;
e (EXPAND_TAC "f");;
e (REWRITE_TAC[VECTOR_ARITH `(u0 - u0) dot (u1 - u0) = &0`]);;
e (REAL_ARITH_TAC);;
e (REWRITE_TAC[REAL_ARITH `&0 + a = a`]);;
e (MATCH_MP_TAC SUM_EQ);;
e (EXPAND_TAC "f");;
e (REPEAT STRIP_TAC);;
e (REWRITE_TAC[REAL_ARITH `a * x = a * y * z <=> a * (x - y * z) = &0`]);;
e (NEW_GOAL `(x' - u0) dot (u1 - u0) - dist (p,u0) * dist (u1,u0:real^3) = &0`);;
e (REWRITE_TAC[REAL_ARITH `a - b = &0 <=> a = b`]);;
e (FIRST_ASSUM MATCH_MP_TAC);;
e (ASM_SET_TAC[]);;
e (ASM_REWRITE_TAC[]);;
e (REAL_ARITH_TAC);;
e (REWRITE_WITH `s DELETE u0:real^3 = s`);;
e (ASM_SET_TAC[]);;
e (MATCH_MP_TAC SUM_EQ);;
e (REPEAT STRIP_TAC);;
e (REWRITE_TAC[]);;
e (REWRITE_TAC[REAL_ARITH `a * x = a * y * z <=> a * (x - y * z) = &0`]);;
e (NEW_GOAL `(x' - u0) dot (u1 - u0) - dist (p,u0) * dist (u1,u0:real^3) = &0`);;
e (REWRITE_TAC[REAL_ARITH `a - b = &0 <=> a = b`]);;
e (FIRST_ASSUM MATCH_MP_TAC);;
e (ASM_SET_TAC[]);;
e (ASM_REWRITE_TAC[]);;
e (REAL_ARITH_TAC);;
e (NEW_GOAL `FINITE (s DELETE u0:real^3)`);;
e (MATCH_MP_TAC FINITE_SUBSET);;
e (EXISTS_TAC `s:real^3->bool` THEN ASM_REWRITE_TAC[] THEN SET_TAC[]);;
e (ASM_SIMP_TAC[SUM_RMUL]);;

e (ASM_CASES_TAC `h <= &0`);;
e (NEW_GOAL `~(x IN rcone_gt u0 (u1:real^3) a)`);;
e (REWRITE_TAC[rcone_gt; rconesgn; IN; IN_ELIM_THM]);;
e (ASM_REWRITE_TAC[]);;
e (MATCH_MP_TAC (REAL_ARITH `&0 <= x /\ y <= &0 ==> ~(y > x)`));;
e (STRIP_TAC);;
e (MATCH_MP_TAC REAL_LE_MUL);;
e (REWRITE_TAC[DIST_POS_LE]);;
e (MATCH_MP_TAC REAL_LE_MUL);;
e (REWRITE_TAC[DIST_POS_LE]);;
e (ASM_REAL_ARITH_TAC);;

e (REWRITE_TAC[REAL_ARITH `a * b * c <= &0 <=> &0 <= b * c * (--a)`]);;
e (MATCH_MP_TAC REAL_LE_MUL);;
e (REWRITE_TAC[DIST_POS_LE]);;
e (MATCH_MP_TAC REAL_LE_MUL);;
e (REWRITE_TAC[DIST_POS_LE]);;
e (ASM_REAL_ARITH_TAC);;
e (NEW_GOAL `F`);;
e (ASM_MESON_TAC[]);;
e (ASM_MESON_TAC[]);;

e (ABBREV_TAC `y = inv (h) % vsum (s DELETE u0) (\v:real^3. u v % v)`);;
e (NEW_GOAL `?t. t + h = &1 /\ x = t % u0 + h % (y:real^3)`);;
e (EXISTS_TAC `&1 - h`);;
e (STRIP_TAC);;
e (REAL_ARITH_TAC);;
e (ASM_CASES_TAC `u0:real^3 IN s`);;
e (REWRITE_TAC[GSYM (ASSUME `sum s (u:real^3->real) = &1`)]);;
e (EXPAND_TAC "h");;
e (REWRITE_WITH `sum s u = sum (u0 INSERT (s DELETE u0)) (u:real^3->real)`);;
e (REWRITE_WITH `(u0 INSERT (s DELETE u0:real^3)) = s`);;
e (ASM_SET_TAC[]);;
e (NEW_GOAL `FINITE (s DELETE u0:real^3)`);;
e (MATCH_MP_TAC FINITE_SUBSET);;
e (EXISTS_TAC `s:real^3->bool` THEN ASM_REWRITE_TAC[] THEN SET_TAC[]);;

e (SIMP_TAC[Marchal_cells_2_new.SUM_CLAUSES_alt; 
   ASSUME `FINITE (s DELETE u0:real^3)`]);;
e (COND_CASES_TAC);;
e (NEW_GOAL `F`);;
e (UP_ASM_TAC THEN SET_TAC[]);;
e (ASM_MESON_TAC[]);;
e (REWRITE_TAC[REAL_ARITH `(a + b:real) - b = a`]);;
e (ASM_REWRITE_TAC[]);;
e (EXPAND_TAC "y");;
e (REWRITE_TAC[VECTOR_MUL_ASSOC]);;
e (REWRITE_WITH `h * inv h = &1`);;
e (NEW_GOAL `~(h = &0)`);;
e (ASM_REAL_ARITH_TAC);;
e (ASM_SIMP_TAC[Trigonometry2.REAL_MUL_LRINV]);;
e (REWRITE_TAC[VECTOR_MUL_LID]);;
e (EXPAND_TAC "x");;

e (REWRITE_WITH `vsum s (\v. u v % v) = 
   vsum (u0 INSERT (s DELETE u0)) (\v:real^3. u v % v)`);;
e (REWRITE_WITH `(u0 INSERT (s DELETE u0:real^3)) = s`);;
e (ASM_SET_TAC[]);;
e (SIMP_TAC[Marchal_cells_2_new.VSUM_CLAUSES_alt; 
   ASSUME `FINITE (s DELETE u0:real^3)`]);;
e (COND_CASES_TAC);;
e (NEW_GOAL `F`);;
e (UP_ASM_TAC THEN SET_TAC[]);;
e (ASM_MESON_TAC[]);;
e (REFL_TAC);;

e (NEW_GOAL `h = &1`);;
e (EXPAND_TAC "h" THEN REWRITE_WITH `s DELETE u0:real^3 = s`);;
e (ASM_SET_TAC[]);;
e (ASM_REWRITE_TAC[]);;
e (EXPAND_TAC "y" THEN REWRITE_TAC[ASSUME `h = &1`]);;
e (REWRITE_WITH `s DELETE u0:real^3 = s`);;
e (ASM_SET_TAC[]);;
e (ASM_REWRITE_TAC[REAL_ARITH `inv (&1) = &1 /\ &1 - &1 = &0`]);;
e (VECTOR_ARITH_TAC);;
e (UP_ASM_TAC THEN STRIP_TAC);;

e (NEW_GOAL `~(y:real^3 IN S)`);;
e (STRIP_TAC);;
e (NEW_GOAL `x IN aff_ge_alt {u0:real^3} S`);;
e (REWRITE_TAC[IN; aff_ge_alt; lin_combo]);;

e (ABBREV_TAC `f = (\v:real^3. if v = u0 then t 
                                else if v = y then h else &0)`);;
e (EXISTS_TAC `f:real^3->real`);;
e (EXISTS_TAC `{y:real^3}`);;

e (REPEAT STRIP_TAC);;
e (REWRITE_TAC[FINITE_SING]);;
e (ASM_SET_TAC[]);;

e (REWRITE_TAC[SET_RULE `{a} UNION {b} = {a, b}`]);;
e (REWRITE_WITH `vsum {u0:real^3, y} (\v. f v % v) = 
                (\v. f v % v) u0 + (\v. f v % v) y`);;
e (MATCH_MP_TAC Geomdetail.VSUM_DIS2);;
e (STRIP_TAC);;
e (NEW_GOAL `~(u0:real^3 IN S)`);;
e (EXPAND_TAC "S");;
e (REWRITE_TAC[VORONOI_LIST; VORONOI_SET; set_of_list; 
   SET_RULE `v IN {a,b} <=> v = a \/ v = b`]);;
e (STRIP_TAC);;
e (NEW_GOAL `u0 IN voronoi_closed V (u1:real^3)`);;
e (ASM_SET_TAC[]);;
e (UP_ASM_TAC THEN REWRITE_TAC[voronoi_closed; IN; IN_ELIM_THM]);;
e (REPEAT STRIP_TAC);;
e (NEW_GOAL `dist (u0,u1) <= dist (u0,u0:real^3)`);;
e (FIRST_ASSUM MATCH_MP_TAC);;
e (ASM_SET_TAC[]);;
e (UP_ASM_TAC THEN REWRITE_TAC[DIST_REFL; REAL_ARITH `~(a <= b) <=> b < a`]);;
e (MATCH_MP_TAC DIST_POS_LT);;
e (ASM_REWRITE_TAC[]);;
e (ASM_MESON_TAC[]);;

e (REWRITE_WITH `(f:real^3->real) u0 = t`);;
e (EXPAND_TAC "f");;
e (COND_CASES_TAC);;
e (REFL_TAC);;
e (NEW_GOAL `F`);;
e (ASM_MESON_TAC[]);;
e (ASM_MESON_TAC[]);;

e (REWRITE_WITH `(f:real^3->real) y = h`);;
e (EXPAND_TAC "f");;
e (COND_CASES_TAC);;
e (NEW_GOAL `F`);;
e (NEW_GOAL `~(u0:real^3 IN S)`);;
e (EXPAND_TAC "S");;
e (REWRITE_TAC[VORONOI_LIST; VORONOI_SET; set_of_list; 
   SET_RULE `v IN {a,b} <=> v = a \/ v = b`]);;
e (STRIP_TAC);;
e (NEW_GOAL `u0 IN voronoi_closed V (u1:real^3)`);;
e (ASM_SET_TAC[]);;
e (UP_ASM_TAC THEN REWRITE_TAC[voronoi_closed; IN; IN_ELIM_THM]);;
e (REPEAT STRIP_TAC);;
e (NEW_GOAL `dist (u0,u1) <= dist (u0,u0:real^3)`);;
e (FIRST_ASSUM MATCH_MP_TAC);;
e (ASM_SET_TAC[]);;
e (UP_ASM_TAC THEN REWRITE_TAC[DIST_REFL; REAL_ARITH `~(a <= b) <=> b < a`]);;
e (MATCH_MP_TAC DIST_POS_LT);;
e (ASM_REWRITE_TAC[]);;
e (ASM_MESON_TAC[]);;
e (ASM_MESON_TAC[]);;
e (COND_CASES_TAC);;
e (REFL_TAC);;
e (NEW_GOAL `F`);;
e (ASM_MESON_TAC[]);;
e (ASM_MESON_TAC[]);;
e (ASM_REWRITE_TAC[]);;

e (EXPAND_TAC "f");;
e (COND_CASES_TAC);;
e (NEW_GOAL `F`);;
e (NEW_GOAL `~({y:real^3} u0)`);;
e (REWRITE_WITH `~({y} u0) <=> ~(u0:real^3 IN {y})`);;
e (MESON_TAC[IN]);;
e (REWRITE_TAC[IN_SING]);;
e (STRIP_TAC);;

e (NEW_GOAL `~(u0:real^3 IN S)`);;
e (EXPAND_TAC "S");;
e (REWRITE_TAC[VORONOI_LIST; VORONOI_SET; set_of_list; 
   SET_RULE `v IN {a,b} <=> v = a \/ v = b`]);;
e (STRIP_TAC);;

e (NEW_GOAL `u0 IN voronoi_closed V (u1:real^3)`);;
e (ASM_SET_TAC[]);;
e (UP_ASM_TAC THEN REWRITE_TAC[voronoi_closed; IN; IN_ELIM_THM]);;
e (REPEAT STRIP_TAC);;
e (NEW_GOAL `dist (u0,u1) <= dist (u0,u0:real^3)`);;
e (FIRST_ASSUM MATCH_MP_TAC);;
e (ASM_SET_TAC[]);;
e (UP_ASM_TAC THEN REWRITE_TAC[DIST_REFL; REAL_ARITH `~(a <= b) <=> b < a`]);;
e (MATCH_MP_TAC DIST_POS_LT);;
e (ASM_REWRITE_TAC[]);;
e (ASM_MESON_TAC[]);;
e (ASM_MESON_TAC[]);;
e (ASM_MESON_TAC[]);;

e (COND_CASES_TAC);;
e (ASM_REAL_ARITH_TAC);;
e (REAL_ARITH_TAC);;

e (REWRITE_TAC[SET_RULE `{a} UNION {b} = {a,b}`]);;
e (REWRITE_WITH `sum {u0:real^3, y} f = f u0 + f y`);;
e (MATCH_MP_TAC Geomdetail.SUM_DIS2);;
e (STRIP_TAC);;
e (NEW_GOAL `~(u0:real^3 IN S)`);;
e (EXPAND_TAC "S");;
e (REWRITE_TAC[VORONOI_LIST; VORONOI_SET; set_of_list; 
   SET_RULE `v IN {a,b} <=> v = a \/ v = b`]);;
e (STRIP_TAC);;
e (NEW_GOAL `u0 IN voronoi_closed V (u1:real^3)`);;
e (ASM_SET_TAC[]);;
e (UP_ASM_TAC THEN REWRITE_TAC[voronoi_closed; IN; IN_ELIM_THM]);;
e (REPEAT STRIP_TAC);;
e (NEW_GOAL `dist (u0,u1) <= dist (u0,u0:real^3)`);;
e (FIRST_ASSUM MATCH_MP_TAC);;
e (ASM_SET_TAC[]);;
e (UP_ASM_TAC THEN REWRITE_TAC[DIST_REFL; REAL_ARITH `~(a <= b) <=> b < a`]);;
e (MATCH_MP_TAC DIST_POS_LT);;
e (ASM_REWRITE_TAC[]);;
e (ASM_MESON_TAC[]);;

e (REWRITE_WITH `(f:real^3->real) u0 = t`);;
e (EXPAND_TAC "f");;
e (COND_CASES_TAC);;
e (REFL_TAC);;
e (NEW_GOAL `F`);;
e (ASM_MESON_TAC[]);;
e (ASM_MESON_TAC[]);;

e (REWRITE_WITH `(f:real^3->real) y = h`);;
e (EXPAND_TAC "f");;
e (COND_CASES_TAC);;
e (NEW_GOAL `F`);;
e (NEW_GOAL `~(u0:real^3 IN S)`);;
e (EXPAND_TAC "S");;
e (REWRITE_TAC[VORONOI_LIST; VORONOI_SET; set_of_list; 
   SET_RULE `v IN {a,b} <=> v = a \/ v = b`]);;
e (STRIP_TAC);;
e (NEW_GOAL `u0 IN voronoi_closed V (u1:real^3)`);;
e (ASM_SET_TAC[]);;
e (UP_ASM_TAC THEN REWRITE_TAC[voronoi_closed; IN; IN_ELIM_THM]);;
e (REPEAT STRIP_TAC);;
e (NEW_GOAL `dist (u0,u1) <= dist (u0,u0:real^3)`);;
e (FIRST_ASSUM MATCH_MP_TAC);;
e (ASM_SET_TAC[]);;
e (UP_ASM_TAC THEN REWRITE_TAC[DIST_REFL; REAL_ARITH `~(a <= b) <=> b < a`]);;
e (MATCH_MP_TAC DIST_POS_LT);;
e (ASM_REWRITE_TAC[]);;
e (ASM_MESON_TAC[]);;
e (ASM_MESON_TAC[]);;

e (COND_CASES_TAC);;
e (REFL_TAC);;
e (NEW_GOAL `F`);;
e (ASM_MESON_TAC[]);;
e (ASM_MESON_TAC[]);;
e (ASM_REWRITE_TAC[]);;
e (ASM_MESON_TAC[]);;

e (NEW_GOAL `y:real^3 IN S2`);;
e (EXPAND_TAC "S2");;
e (NEW_GOAL `y:real^3 IN S1`);;
e (NEW_GOAL `y:real^3 IN affine hull S`);;
e (REWRITE_TAC[AFFINE_HULL_EXPLICIT_ALT]);;
e (REWRITE_TAC[IN; IN_ELIM_THM]);;
e (EXISTS_TAC `s DELETE u0:real^3`);;
e (EXISTS_TAC `(\v:real^3. inv h * u v)`);;
e (REPEAT STRIP_TAC);;
e (ASM_REWRITE_TAC[FINITE_DELETE]);;
e (ASM_SET_TAC[]);;
e (REWRITE_TAC[SUM_LMUL]);;
e (ASM_REWRITE_TAC[]);;
e (ASM_SIMP_TAC[Trigonometry2.REAL_MUL_LRINV; 
   REAL_ARITH `~(h <= &0) ==> ~(h = &0)`]);;
e (REWRITE_TAC[GSYM VECTOR_MUL_ASSOC]);;
e (ASM_SIMP_TAC[VSUM_LMUL; FINITE_DELETE]);;
e (NEW_GOAL `affine hull S1 = S1:real^3->bool`);;
e (REWRITE_TAC[AFFINE_HULL_EQ]);;
e (EXPAND_TAC "S1" THEN REWRITE_TAC[AFFINE_HYPERPLANE]);;

e (NEW_GOAL `affine hull S SUBSET affine hull (S1:real^3->bool)`);;
e (MATCH_MP_TAC Marchal_cells_2_new.AFFINE_SUBSET_KY_LEMMA);;
e (EXPAND_TAC "S");;
e (REWRITE_TAC[VORONOI_LIST; VORONOI_SET; set_of_list; 
   SET_RULE `INTERS {f x | x IN {a, b}} = f a INTER f b`]);;
e (DEL_TAC THEN EXPAND_TAC "S1");;
e (MATCH_MP_TAC Pack2.INTER_VORONOI_SUBSET_BISECTOR);;
e (ASM_REWRITE_TAC[]);;
e (ASM_SET_TAC[]);;

e (NEW_GOAL `relative_interior S SUBSET S:real^3->bool`);;
e (REWRITE_TAC[RELATIVE_INTERIOR_SUBSET]);;
e (ASM_SET_TAC[]);;

(* OK until here *)
(* ========================================================================= *)

e (NEW_GOAL `dist (z,u0) <= dist (y,u0:real^3)`);;
e (ONCE_REWRITE_TAC[DIST_SYM]);;
e (ASM_SIMP_TAC[]);;
e (UNDISCH_TAC `x:real^3 IN rcone_gt u0 u1 a`);;
e (REWRITE_TAC[rcone_gt; rconesgn; IN; IN_ELIM_THM]);;
e (ASM_REWRITE_TAC[]);;
e (REWRITE_WITH `dist (t % u0 + h % y,u0) = h * dist (y, u0:real^3)`);;
e (REWRITE_TAC[dist]);;
e (REWRITE_WITH `(t % u0 + h % y:real^3) - u0 = (t % u0 + h % y) - (t + h) % u0`);;
e (ASM_REWRITE_TAC[] THEN VECTOR_ARITH_TAC);;
e (REWRITE_TAC[VECTOR_ARITH `(t % u0 + h % y) - (t + h) % u0 = h % (y - u0)`]);;
e (REWRITE_TAC[NORM_MUL]);;
e (REWRITE_WITH `abs h = h`);;
e (REWRITE_TAC[REAL_ABS_REFL]);;
e (ASM_REAL_ARITH_TAC);;

e (REWRITE_TAC[REAL_ARITH `~(a > b) <=> a <= b`]);;
e (REWRITE_WITH `h * dist (p,u0:real^3) * dist (u1,u0) = 
            (h * dist (z,u0)) * dist (u1,u0) * a`);;
e (EXPAND_TAC "a");;
e (REWRITE_TAC[REAL_ARITH `(a * b) * c * d / b = (a * d * c) * (b / b)`]);;
e (REWRITE_WITH `dist (z,u0) / dist (z,u0:real^3) = &1`);;
e (MATCH_MP_TAC REAL_DIV_REFL);;
e (REWRITE_TAC[DIST_EQ_0]);;
e (STRIP_TAC);;

e (NEW_GOAL `~(u0:real^3 IN S1)`);;
e (EXPAND_TAC "S1" THEN REWRITE_TAC[IN; IN_ELIM_THM; NORM_POW_2]);;
e (REWRITE_TAC[REAL_ARITH `a = b - c <=> a + c - b = &0`]);;
e (REWRITE_TAC[VECTOR_ARITH `&2 % (u0 - u1) dot u0 + u1 dot u1 - u0 dot u0 = 
  (u0 - u1) dot (u0 - u1)`]);;
e (REWRITE_TAC[DOT_EQ_0; VECTOR_ARITH `a - b = vec 0 <=> a = b`]);;
e (ASM_REWRITE_TAC[]);;
e (NEW_GOAL `z:real^3 IN S1`);;
e (ASM_SET_TAC[]);;
e (ASM_MESON_TAC[]);;

e (REAL_ARITH_TAC);;
e (REWRITE_TAC[REAL_ARITH 
  `(a * x) * b * c <= (a * y) * b * c <=> &0 <= a * b * c *(y - x)`]);;
e (MATCH_MP_TAC REAL_LE_MUL);;
e (STRIP_TAC);;
e (ASM_REAL_ARITH_TAC);;
e (MATCH_MP_TAC REAL_LE_MUL);;
e (REWRITE_TAC[DIST_POS_LE]);;
e (MATCH_MP_TAC REAL_LE_MUL);;
e (STRIP_TAC);;
e (ASM_REAL_ARITH_TAC);;
e (ASM_REAL_ARITH_TAC);;

e (UP_ASM_TAC THEN STRIP_TAC);;

e (ABBREV_TAC `W = aff_ge_alt {u0:real^3} S`);;
e (ABBREV_TAC `c = max b (hl[u0;u1:real^3] / sqrt (&2))`);;
e (NEW_GOAL `&0 < c /\ c < &1`);;
e (EXPAND_TAC "c" THEN REWRITE_TAC[REAL_LT_MAX]);;
e (ASM_REWRITE_TAC[]);;
e (EXPAND_TAC "c" THEN REWRITE_TAC[REAL_MAX_LT]);;
e (STRIP_TAC);;
e (ASM_REWRITE_TAC[]);;
e (REWRITE_WITH `hl [u0; u1:real^3] / sqrt (&2) < &1 <=> 
                 hl [u0; u1] < &1 * sqrt (&2)`);;
e (MATCH_MP_TAC REAL_LT_LDIV_EQ);;
e (ASM_SIMP_TAC[SQRT_POS_LT; REAL_ARITH `&0 < &2`]);;
e (ASM_REAL_ARITH_TAC);;

e (NEW_GOAL `rcone_gt u0 u1 c SUBSET 
             W INTER (rcone_gt u0 u1 (hl [u0; u1:real^3] / sqrt (&2)))`);;
e (REWRITE_TAC[SUBSET_INTER]);;
e (STRIP_TAC);;
e (NEW_GOAL `rcone_gt (u0:real^3) u1 c SUBSET rcone_gt u0 u1 b`);;
e (MATCH_MP_TAC RCONE_GT_SUBSET);;
e (EXPAND_TAC "c" THEN REAL_ARITH_TAC);;
e (ASM_SET_TAC[]);;
e (MATCH_MP_TAC RCONE_GT_SUBSET);;
e (EXPAND_TAC "c" THEN REAL_ARITH_TAC);;
e (ABBREV_TAC `r = &1`);;

e (ABBREV_TAC `C = ball (u0:real^3,r) INTER rcone_gt u0 u1 c`);;
e (NEW_GOAL `C SUBSET 
      UNIONS
      {rogers V vl | vl | barV V 3 vl /\ truncate_simplex 1 vl = [u0; u1]}`);;
e (REWRITE_TAC[SUBSET]);;
e (REPEAT STRIP_TAC);;
e (NEW_GOAL `x IN ball (u0:real^3,r)  /\ x IN aff_ge_alt {u0} S`);;
e (ASM_SET_TAC[]);;
e (UP_ASM_TAC THEN STRIP_TAC);;

(* OK until here *)
(* ===========================================================================*)

e (NEW_GOAL `(x:real^3) IN convex hull (u0 INSERT S)`);;
e (REWRITE_TAC[CONVEX_HULL_EXPLICIT; IN; IN_ELIM_THM]);;

e (UP_ASM_TAC THEN REWRITE_TAC[IN; aff_ge_alt; lin_combo]);;
e (REPEAT STRIP_TAC);;
e (EXISTS_TAC `{u0:real^3} UNION q`);;
e (EXISTS_TAC `f:real^3->real`);;
e (REPEAT STRIP_TAC);;
e (REWRITE_TAC[SET_RULE `{a} UNION b = a INSERT b`; FINITE_INSERT]);;
e (ASM_REWRITE_TAC[]);;
e (ASM_SET_TAC[]);;
e (ASM_CASES_TAC `x':real^3 IN q`);;
e (FIRST_ASSUM MATCH_MP_TAC);;
e (UP_ASM_TAC THEN MESON_TAC[IN]);;
e (REWRITE_WITH `x' = u0:real^3`);;
e (NEW_GOAL `x' IN ({u0:real^3} UNION q)`);;
e (ASM_REWRITE_TAC[IN]);;
e (UP_ASM_TAC THEN UP_ASM_TAC THEN SET_TAC[]);;
e (REWRITE_TAC[REAL_ARITH `&0 <= x <=> ~(x < &0)`]);;
e (STRIP_TAC);;
e (UNDISCH_TAC `x IN ball (u0:real^3,r)`);;
e (ASM_REWRITE_TAC[IN_BALL; SET_RULE `{u} UNION q = u INSERT (q DELETE u)`]);;
e (REWRITE_WITH `vsum (u0 INSERT (q DELETE u0:real^3)) (\v. f v % v) = 
  (if u0 IN (q DELETE u0) then vsum (q DELETE u0) (\v. f v % v)
   else (\v. f v % v) u0 + vsum (q DELETE u0) (\v. f v % v))`);;
e (MATCH_MP_TAC Marchal_cells_2_new.VSUM_CLAUSES_alt);;
e (ASM_REWRITE_TAC[FINITE_DELETE]);;
e (COND_CASES_TAC);;
e (NEW_GOAL `F`);;
e (UP_ASM_TAC THEN SET_TAC[]);;
e (ASM_MESON_TAC[]);;
e (ONCE_REWRITE_TAC[DIST_SYM]);;
e (REWRITE_TAC[dist]);;
e (REWRITE_WITH `!a. a - u0 = a - (sum ({u0:real^3} UNION q) f) % u0`);;
e (ASM_REWRITE_TAC[]);;
e (EXPAND_TAC "r");;
e (VECTOR_ARITH_TAC);;


e (NEW_GOAL `sum ({u0} UNION q) f = f u0 + sum (q DELETE u0:real^3) f`);;
e (REWRITE_TAC[SET_RULE `{u} UNION q = u INSERT (q DELETE u)`]);;
e (REWRITE_WITH `sum (u0 INSERT (q DELETE u0:real^3)) f = 
  (if u0 IN (q DELETE u0) then sum (q DELETE u0) f
   else f u0 + sum (q DELETE u0) f)`);;
e (MATCH_MP_TAC Marchal_cells_2_new.SUM_CLAUSES_alt);;
e (ASM_REWRITE_TAC[FINITE_DELETE]);;
e (COND_CASES_TAC);;
e (NEW_GOAL `F`);;
e (UP_ASM_TAC THEN SET_TAC[]);;
e (ASM_MESON_TAC[]);;
e (ASM_REWRITE_TAC[]);;
e (REWRITE_TAC[VECTOR_ADD_RDISTRIB;
   VECTOR_ARITH `(a + b) - (a + c:real^3) = b - c`;
   ASSUME `sum ({u0} UNION q) f = f u0 + sum (q DELETE u0:real^3) f`; ]);;
e (ABBREV_TAC `h = sum (q DELETE u0:real^3) f`);;
e (ABBREV_TAC `y = inv (h) % vsum (q DELETE u0) (\v:real^3. f v % v)`);;
e (NEW_GOAL `h > &1`);;
e (ASM_REAL_ARITH_TAC);;
e (REWRITE_WITH `vsum (q DELETE u0) (\v. f v % v) = h % y:real^3`);;
e (EXPAND_TAC "y");;
e (REWRITE_TAC[VECTOR_MUL_ASSOC]);;
e (REWRITE_WITH `h * inv h = &1`);;
e (ASM_SIMP_TAC [Trigonometry2.REAL_MUL_LRINV; REAL_ARITH `h > &1 ==> ~(h = &0)`]);;
e (VECTOR_ARITH_TAC);;
e (REWRITE_TAC[VECTOR_ARITH `h % a - h % b = h % (a - b)`; NORM_MUL]);;
e (REWRITE_TAC[REAL_ARITH `~(a < b) <=> b <= a`]);;

e (NEW_GOAL `norm (p - u0) <= norm (y - u0:real^3)`);;
e (MATCH_MP_TAC Tactics_jordan.REAL_POW_2_LE);;
e (REWRITE_TAC[NORM_POS_LE]);;
e (REWRITE_WITH 
  `norm (y - u0) pow 2 = norm (p - u0) pow 2 + norm (y - p:real^3) pow 2`);;
e (MATCH_MP_TAC PYTHAGORAS);;
e (REWRITE_TAC[orthogonal]);;
e (REWRITE_WITH `p = circumcenter (set_of_list [u0;u1:real^3])`);;
e (ASM_REWRITE_TAC[set_of_list]);;
e (ONCE_REWRITE_TAC[DOT_SYM]);;
e (MATCH_MP_TAC Rogers.MHFTTZN4);;
e (EXISTS_TAC `V:real^3->bool` THEN EXISTS_TAC `1`);;
e (REPEAT STRIP_TAC);;
e (ASM_REWRITE_TAC[]);;
e (ASM_REWRITE_TAC[]);;

e (REWRITE_TAC[ASSUME `voronoi_list V [u0; u1] = S`]);;
e (REWRITE_TAC[AFFINE_HULL_EXPLICIT_ALT; IN; IN_ELIM_THM]);;
e (EXISTS_TAC `q DELETE u0:real^3`);;
e (EXISTS_TAC `(\v:real^3. inv h * f v)`);;
e (REPEAT STRIP_TAC);;
e (ASM_REWRITE_TAC[FINITE_DELETE]);;
e (ASM_SET_TAC[]);;
e (ASM_REWRITE_TAC[SUM_LMUL]);;
e (EXPAND_TAC "r");;
e (ASM_SIMP_TAC [Trigonometry2.REAL_MUL_LRINV; REAL_ARITH `h > &1 ==> ~(h = &0)`]);;
e (REWRITE_TAC[GSYM VECTOR_MUL_ASSOC]);;
e (ASM_REWRITE_TAC[VSUM_LMUL]);;

e (REWRITE_TAC[set_of_list]);;
e (NEW_GOAL `{u0, u1:real^3} SUBSET affine hull {u0, u1}`);;
e (REWRITE_TAC[Qzksykg.SET_SUBSET_AFFINE_HULL]);;
e (ASM_SET_TAC[]);;
e (REWRITE_TAC[REAL_ARITH `a <= a + b <=> &0 <= b`; NORM_POW_2; DOT_POS_LE]);;

e (NEW_GOAL `&1 <= norm (p - u0:real^3)`);;
e (EXPAND_TAC "p");;
e (REWRITE_TAC[CIRCUMCENTER_2; midpoint; 
   VECTOR_ARITH `inv (&2) % (u0 + u1) - u0 = inv (&2) % (u1 - u0)`; 
   NORM_MUL; REAL_ARITH `abs (inv(&2)) = inv (&2)`]);;
e (REWRITE_TAC[GSYM dist]);;
e (REWRITE_WITH `&1 = inv (&2) * &2`);;
e (REAL_ARITH_TAC);;
e (REWRITE_TAC[REAL_ARITH `inv (&2) * &2 <= inv (&2) * a <=> &2 <= a`]);;
e (MP_TAC (ASSUME `packing (V:real^3->bool)`));;
e (REWRITE_TAC[packing] THEN STRIP_TAC);;
e (FIRST_ASSUM MATCH_MP_TAC);;
e (ASM_REWRITE_TAC[] THEN ASM_SET_TAC[]);;
e (REWRITE_WITH `abs h = h`);;
e (ASM_REAL_ARITH_TAC);;

e (NEW_GOAL `h <= h * norm (y - u0:real^3)`);;
e (REWRITE_TAC[REAL_ARITH `h <= h * a <=> &0 <= h * (a - &1)`]);;
e (MATCH_MP_TAC REAL_LE_MUL);;
e (ASM_REAL_ARITH_TAC);;
e (ASM_REAL_ARITH_TAC);;

e (ASM_REWRITE_TAC[]);;
e (ASM_REWRITE_TAC[]);;

(* ========================================================================== *)
e (NEW_GOAL `~(S:real^3->bool = {})`);;
e (STRIP_TAC);;
e (NEW_GOAL `~(aff_dim (u0:real^3 INSERT S) = &3)`);;
e (REWRITE_TAC[ASSUME `S:real^3->bool = {}`; AFF_DIM_SING]);;
e (ARITH_TAC);;
e (ASM_MESON_TAC[]);;
e (SWITCH_TAC);;
e (UP_ASM_TAC THEN SIMP_TAC[CONVEX_HULL_INSERT; 
   ASSUME `~(S:real^3->bool = {})`]);;
e (REWRITE_WITH `convex hull S = S:real^3->bool`);;
e (REWRITE_TAC[CONVEX_HULL_EQ]);;
e (EXPAND_TAC "S" THEN REWRITE_TAC[Packing3.CONVEX_VORONOI_LIST]);;
e (ASM_REWRITE_TAC[]);;
e (REWRITE_TAC[IN_UNIONS; IN; IN_ELIM_THM]);;
e (REPEAT STRIP_TAC);;

e (EXISTS_TAC `rogers V vl`);;
e (REPEAT STRIP_TAC);;
e (EXISTS_TAC `vl:(real^3)list`);;
e (ASM_REWRITE_TAC[]);;

e (ASM_SIMP_TAC[Marchal_cells_2.ROGERS_EXPLICIT]);;
e (REWRITE_TAC[CONVEX_HULL_4; IN_ELIM_THM]);;

e (UNDISCH_TAC `(t:real^3->bool) b'`);;
e (ASM_REWRITE_TAC[CONVEX_HULL_3; IN_ELIM_THM]);;
e (REPEAT STRIP_TAC);;

e (EXISTS_TAC `u:real`);;
e (EXISTS_TAC `v * u'`);;
e (EXISTS_TAC `v * v'`);;
e (EXISTS_TAC `v * w`);;
e (ASM_SIMP_TAC[REAL_LE_MUL]);;
e (STRIP_TAC);;

e (REWRITE_TAC[REAL_ARITH `u + v * u' + v * v' + v * w = u + v * (u' + v' +w)`]);;
e (ASM_REWRITE_TAC[]);;
e (REWRITE_TAC [GSYM (ASSUME `&1 = r`)]);;
e (ASM_REAL_ARITH_TAC);;

e (REWRITE_WITH `(HD vl):real^3 = HD (truncate_simplex 1 vl)`);;
e (ONCE_REWRITE_TAC[EQ_SYM_EQ]);;
e (MATCH_MP_TAC Packing3.HD_TRUNCATE_SIMPLEX);;
e (REWRITE_WITH `LENGTH (vl:(real^3)list) = 3 + 1 /\ CARD (set_of_list vl) = 3 + 1`);;
e (MATCH_MP_TAC Rogers.BARV_IMP_LENGTH_EQ_CARD);;
e (EXISTS_TAC `V:real^3->bool`);;
e (ASM_REWRITE_TAC[]);;
e (ARITH_TAC);;

e (ASM_REWRITE_TAC[HD]);;
e (VECTOR_ARITH_TAC);;

(* ========================================================================= *)
(* ========================================================================== *)

e (NEW_GOAL 
 `!X. mcell_set V X /\ ~NULLSET (X INTER C)
     ==> (?k vl.
              2 <= k /\
              barV V 3 vl /\
              X = mcell k V vl /\
              truncate_simplex 1 vl = [u0; u1])`);;

e (REWRITE_TAC[mcell_set_2; IN_ELIM_THM]);;
e (REPEAT STRIP_TAC);;

e (NEW_GOAL `~NULLSET (X INTER UNIONS
      {rogers V vl | vl | barV V 3 vl /\ truncate_simplex 1 vl = [u0; u1]})`);;
e (STRIP_TAC);;
e (UNDISCH_TAC `~NULLSET (X INTER C)`);;
e (REWRITE_TAC[]);;
e (MATCH_MP_TAC NEGLIGIBLE_SUBSET);;
e (EXISTS_TAC `X INTER
       UNIONS
       {rogers V vl | vl | barV V 3 vl /\ truncate_simplex 1 vl = [u0; u1]}`);;
e (STRIP_TAC);;
e (ASM_REWRITE_TAC[]);;
e (ASM_SET_TAC[]);;
e (UP_ASM_TAC THEN REWRITE_TAC[INTER_UNIONS]);;
e (STRIP_TAC);;

e (NEW_GOAL 
  `!s. ~NULLSET (UNIONS s) /\ FINITE s ==> (?t. t IN s /\ ~NULLSET t)`);;
e (MESON_TAC[NEGLIGIBLE_UNIONS]);;
e (ABBREV_TAC `St = {X INTER x | x IN
                    {rogers V vl | vl | barV V 3 vl /\
                                        truncate_simplex 1 vl = [u0; u1]}}`);;
e (NEW_GOAL `?t. t IN St /\ ~NULLSET t`);;
e (FIRST_ASSUM MATCH_MP_TAC);;
e (ASM_REWRITE_TAC[]);;
e (EXPAND_TAC "St");;
e (ABBREV_TAC `Sr = {rogers V vl | vl | barV V 3 vl /\
                                  truncate_simplex 1 vl = [u0; u1]}`);;
e (ABBREV_TAC `f = (\x:real^3->bool. X INTER x)`);;
e (MATCH_MP_TAC FINITE_SUBSET);;
e (EXISTS_TAC `{y:real^3->bool | ?x:real^3->bool. x IN Sr /\ y = f x }`);;
e (STRIP_TAC);;



e (MATCH_MP_TAC FINITE_IMAGE_EXPAND);;
e (ABBREV_TAC `Ss = {vl | barV V 3 vl /\ truncate_simplex 1 vl = [u0; u1]}`);;
e (MATCH_MP_TAC FINITE_SUBSET);;
e (EXISTS_TAC `{y | ?vl. vl IN Ss /\ y = rogers V vl}`);;
e (STRIP_TAC);;
e (MATCH_MP_TAC FINITE_IMAGE_EXPAND);;
e (ABBREV_TAC `Sx = V INTER ball (u0:real^3, &4)`);;
e (MATCH_MP_TAC FINITE_SUBSET);;
e (EXISTS_TAC `{y | ?u0 u1 u2 u3:real^3.
                      u0 IN Sx /\
                      u1 IN Sx /\
                      u2 IN Sx /\
                      u3 IN Sx /\
                      y = [u0; u1; u2; u3]}`);;
e (STRIP_TAC);;
e (MATCH_MP_TAC Ajripqn.FINITE_SET_LIST_LEMMA);;
e (EXPAND_TAC "Sx");;
e (MATCH_MP_TAC Pack2.KIUMVTC);;
e (ASM_REWRITE_TAC[]);;
e (EXPAND_TAC "Ss");;
e (REWRITE_TAC[SUBSET; IN; IN_ELIM_THM]);;
e (REPEAT STRIP_TAC);;

e (NEW_GOAL `?v0 v1 v2 v3. x = [v0;v1;v2;v3:real^3]`);;
e (MATCH_MP_TAC Marchal_cells.BARV_3_EXPLICIT);;
e (EXISTS_TAC `V:real^3->bool` THEN ASM_REWRITE_TAC[]);;
e (UP_ASM_TAC THEN STRIP_TAC);;
e (EXISTS_TAC `v0:real^3`);;
e (EXISTS_TAC `v1:real^3`);;
e (EXISTS_TAC `v2:real^3`);;
e (EXISTS_TAC `v3:real^3`);;
e (ASM_REWRITE_TAC[]);;

e (NEW_GOAL `{v0, v1, v2, v3:real^3} SUBSET Sx`);;
e (EXPAND_TAC "Sx");;
e (REWRITE_TAC[SUBSET_INTER]);;
e (REWRITE_WITH `{v0, v1, v2, v3:real^3} = set_of_list x`);;
e (ASM_REWRITE_TAC[set_of_list]);;
e (STRIP_TAC);;
e (MATCH_MP_TAC Packing3.BARV_SUBSET);;
e (EXISTS_TAC `3` THEN ASM_REWRITE_TAC[]);;
e (MATCH_MP_TAC Qzyzmjc.BARV_3_IMP_FINITE_lemma2);;
e (EXISTS_TAC `V:real^3->bool`);;
e (ASM_REWRITE_TAC[]);;
e (NEW_GOAL `HD (truncate_simplex 1 x) = u0:real^3`);;
e (ASM_REWRITE_TAC[HD]);;
e (NEW_GOAL `HD (truncate_simplex 1 x) = v0:real^3`);;
e (REWRITE_TAC[ASSUME `x = [v0; v1; v2; v3:real^3]`;  
   TRUNCATE_SIMPLEX_EXPLICIT_1; HD]);;
e (REWRITE_WITH `u0 = v0:real^3`);;
e (ASM_MESON_TAC[]);;
e (REWRITE_TAC[set_of_list] THEN SET_TAC[]);;
e (UP_ASM_TAC THEN SET_TAC[]);;

e (EXPAND_TAC "Sr" THEN EXPAND_TAC "Ss");;
e (SET_TAC[]);;
e (REWRITE_WITH `{X INTER x:real^3->bool | x IN Sr} = {f x | x IN Sr}`);;
e (EXPAND_TAC "f");;
e (REFL_TAC);;
e (SET_TAC[]);;

e (UP_ASM_TAC THEN EXPAND_TAC "St" THEN REWRITE_TAC[IN; IN_ELIM_THM]);;
e (REPEAT STRIP_TAC);;

e (NEW_GOAL `x SUBSET UNIONS {mcell i V vl | i <= 4}`);;
e (ASM_REWRITE_TAC[SUBSET; IN_UNIONS; IN; IN_ELIM_THM]);;
e (REPEAT STRIP_TAC);;
e (NEW_GOAL `?i. i <= 4 /\ x' IN mcell i V vl`);;
e (MATCH_MP_TAC Sltstlo.SLTSTLO1);;
e (ASM_REWRITE_TAC[IN]);;
e (UP_ASM_TAC THEN STRIP_TAC);;
e (EXISTS_TAC `mcell i' V vl`);;
e (STRIP_TAC);;
e (EXISTS_TAC `i':num` THEN ASM_REWRITE_TAC[]);;
e (UP_ASM_TAC THEN REWRITE_TAC[IN]);;

e (NEW_GOAL `~NULLSET (X INTER UNIONS {mcell i V vl | i <= 4})`);;
e (STRIP_TAC);;
e (UNDISCH_TAC `~NULLSET (t)`);;
e (REWRITE_TAC[ASSUME `t:real^3->bool = X INTER x`]);;
e (MATCH_MP_TAC NEGLIGIBLE_SUBSET);;
e (EXISTS_TAC `X INTER UNIONS {mcell i V vl | i <= 4}`);;
e (STRIP_TAC);;
e (ASM_REWRITE_TAC[]);;
e (ASM_SET_TAC[]);;
e (UP_ASM_TAC THEN REWRITE_TAC[INTER_UNIONS]);;
e (STRIP_TAC);;

e (NEW_GOAL 
  `!s. ~NULLSET (UNIONS s) /\ FINITE s ==> (?t. t IN s /\ ~NULLSET t)`);;
e (MESON_TAC[NEGLIGIBLE_UNIONS]);;
e (ABBREV_TAC `Sx = {X INTER x | x IN {mcell i V vl | i <= 4}}`);;
e (NEW_GOAL `?t. t IN Sx /\ ~NULLSET t`);;
e (FIRST_ASSUM MATCH_MP_TAC);;
e (ASM_REWRITE_TAC[]);;
e (EXPAND_TAC "Sx");;
e (ABBREV_TAC `Sy = {mcell i V vl | i <= 4}`);;
e (ABBREV_TAC `f = (\x:real^3->bool. X INTER x)`);;
e (MATCH_MP_TAC FINITE_SUBSET);;
e (EXISTS_TAC `{y:real^3->bool | ?x:real^3->bool. x IN Sy /\ y = f x }`);;
e (STRIP_TAC);;
e (MATCH_MP_TAC FINITE_IMAGE_EXPAND);;
e (EXPAND_TAC "Sy");;
e (REWRITE_TAC[GSYM IN_NUMSEG_0]);;
e (ABBREV_TAC `g = (\i:num. mcell i V vl)`);;
e (REWRITE_WITH `{mcell i V vl | i IN 0..4} = {g i | i IN 0..4}`);;
e (EXPAND_TAC "g" THEN REWRITE_TAC[]);;
e (MATCH_MP_TAC FINITE_SUBSET);;
e (EXISTS_TAC `{y:real^3->bool | ?i. i IN 0..4 /\ y = g i}`);;
e (STRIP_TAC);;
e (MATCH_MP_TAC FINITE_IMAGE_EXPAND);;
e (REWRITE_TAC[FINITE_NUMSEG]);;
e (SET_TAC[]);;
e (REWRITE_WITH `{X INTER x:real^3->bool | x IN Sy} = {f x | x IN Sy}`);;
e (EXPAND_TAC "f" THEN REWRITE_TAC[]);;
e (SET_TAC[]);;
e (UP_ASM_TAC THEN EXPAND_TAC "Sx" THEN REWRITE_TAC[IN; IN_ELIM_THM]);;
e (REPEAT STRIP_TAC);;

(* ========================================================================= *)

e (NEW_GOAL `i = i' /\ mcell i V ul = mcell i' V vl`);;
e (MATCH_MP_TAC Ajripqn.AJRIPQN);;
e (ASM_REWRITE_TAC[GSYM Ajripqn.UP_TO_4_KY_LEMMA]);;
e (REPEAT STRIP_TAC);;
e (UNDISCH_TAC `ul IN barV V 3` THEN REWRITE_TAC[IN]);;
e (UNDISCH_TAC `~NULLSET t'`);;
e (ASM_REWRITE_TAC[]);;
e (EXISTS_TAC `i:num` THEN EXISTS_TAC `vl:(real^3)list`);;
e (ASM_REWRITE_TAC[]);;

(* ========================================================================= *)

e (ASM_CASES_TAC `i' = 0`);;
e (NEW_GOAL `F`);;
e (UNDISCH_TAC `~NULLSET (X INTER C)`);;
e (REWRITE_TAC[]);;
e (REWRITE_WITH `X INTER C = {}:real^3->bool`);;
e (ASM_REWRITE_TAC[MCELL_EXPLICIT; mcell0]);;
e (REWRITE_WITH `(HD vl):real^3 = HD (truncate_simplex 1 vl)`);;
e (ONCE_REWRITE_TAC[EQ_SYM_EQ]);;
e (MATCH_MP_TAC Packing3.HD_TRUNCATE_SIMPLEX);;
e (REWRITE_WITH `LENGTH (vl:(real^3)list) = 3 + 1 /\ CARD (set_of_list vl) = 3 + 1`);;
e (MATCH_MP_TAC Rogers.BARV_IMP_LENGTH_EQ_CARD);;
e (EXISTS_TAC `V:real^3->bool`);;
e (ASM_REWRITE_TAC[]);;
e (ARITH_TAC);;
e (ASM_REWRITE_TAC[HD]);;
e (NEW_GOAL `C SUBSET ball (u0:real^3, sqrt (&2))`);;
e (NEW_GOAL `ball (u0:real^3, r) SUBSET ball (u0, sqrt (&2))`);;
e (MATCH_MP_TAC SUBSET_BALL);;
e (EXPAND_TAC "r");;
e (MATCH_MP_TAC (REAL_ARITH `a < b ==> a <= b`));;
e (REWRITE_TAC[Marchal_cells_2_new.ZERO_LT_SQRT_2]);;
e (ASM_SET_TAC[]);;
e (UP_ASM_TAC THEN SET_TAC[]);;
e (REWRITE_TAC[NEGLIGIBLE_EMPTY]);;
e (ASM_MESON_TAC[]);;


e (ASM_CASES_TAC `i' = 1`);;
e (NEW_GOAL `F`);;
e (UNDISCH_TAC `~NULLSET (X INTER C)`);;
e (REWRITE_TAC[]);;
e (REWRITE_WITH `X INTER C = {}:real^3->bool`);;
e (ASM_REWRITE_TAC[MCELL_EXPLICIT; mcell1]);;
e (COND_CASES_TAC);;
e (NEW_GOAL `?v0 v1 v2 v3. vl = [v0;v1;v2;v3:real^3]`);;
e (MATCH_MP_TAC Marchal_cells.BARV_3_EXPLICIT);;
e (EXISTS_TAC `V:real^3->bool` THEN ASM_REWRITE_TAC[]);;
e (UP_ASM_TAC THEN STRIP_TAC);;
e (ASM_REWRITE_TAC[HD; TL]);;

e (REWRITE_WITH `v0 = u0:real^3`);;
e (NEW_GOAL `HD (truncate_simplex 1 vl) = u0:real^3`);;
e (ASM_REWRITE_TAC[HD]);;
e (NEW_GOAL `HD (truncate_simplex 1 vl) = v0:real^3`);;
e (REWRITE_TAC[ASSUME `vl = [v0; v1; v2; v3:real^3]`;  
   TRUNCATE_SIMPLEX_EXPLICIT_1; HD]);;
e (ASM_MESON_TAC[]);;

e (REWRITE_WITH `v1 = u1:real^3`);;
e (NEW_GOAL `HD (TL(truncate_simplex 1 vl)) = u1:real^3`);;
e (ASM_REWRITE_TAC[HD; TL]);;
e (NEW_GOAL `HD (TL(truncate_simplex 1 vl)) = v1:real^3`);;
e (REWRITE_TAC[ASSUME `vl = [v0; v1; v2; v3:real^3]`;  
   TRUNCATE_SIMPLEX_EXPLICIT_1; HD; TL]);;
e (ASM_MESON_TAC[]);;

e (NEW_GOAL `C SUBSET (rcone_gt u0 u1 (hl [u0:real^3; u1] / sqrt (&2)))`);;
e (EXPAND_TAC "C");;
e (SET_TAC[ASSUME `rcone_gt u0 u1 c SUBSET
                   W INTER rcone_gt u0 u1 (hl [u0:real^3; u1] / sqrt (&2))`]);;
e (UP_ASM_TAC THEN SET_TAC[]);;
e (SET_TAC[]);;
e (REWRITE_TAC[NEGLIGIBLE_EMPTY]);;
e (UP_ASM_TAC THEN MESON_TAC[]);;
e (ASM_ARITH_TAC);;

(* ========================================================================= *)
e (NEW_GOAL `C = conic_cap (u0:real^3) u1 r c`);;
e (EXPAND_TAC "C" THEN REWRITE_TAC[conic_cap; NORMBALL_BALL]);;

e (NEW_GOAL `!X. mcell_set V X /\ ~NULLSET (X INTER C) ==>
   vol (X INTER C) = vol (C) * (dihX V X (u0,u1)) / (&2 * pi)`);;
e (REPEAT STRIP_TAC);;
e (NEW_GOAL `?k vl.
                   2 <= k /\
                   barV V 3 vl /\
                   X = mcell k V vl /\
                   truncate_simplex 1 vl = [u0; u1]`);;
e (FIRST_ASSUM MATCH_MP_TAC);;
e (ASM_REWRITE_TAC[]);;
e (UP_ASM_TAC THEN REPEAT STRIP_TAC);;

(* ========================================================================= *)
(*  Case k = 2                                                               *)
(* ========================================================================= *)

e (ASM_CASES_TAC `k = 2`);;
e (ABBREV_TAC `m = mxi V vl`);;
e (ABBREV_TAC `s3 = omega_list_n V vl 3`);;
e (ABBREV_TAC `L = aff_ge{u0, u1} {m, s3:real^3}`);;

e (REWRITE_WITH `vol (X INTER C) = vol (L INTER C)`);;
e (AP_TERM_TAC);;
e (ASM_REWRITE_TAC[MCELL_EXPLICIT; mcell2]);;
e (LET_TAC);;
e (COND_CASES_TAC);;
e (NEW_GOAL `?v0 v1 v2 v3. vl = [v0;v1;v2;v3:real^3]`);;
e (MATCH_MP_TAC Marchal_cells.BARV_3_EXPLICIT);;
e (EXISTS_TAC `V:real^3->bool` THEN ASM_REWRITE_TAC[]);;
e (UP_ASM_TAC THEN STRIP_TAC);;

e (REWRITE_WITH `HD vl = u0 /\ HD (TL vl) = u1:real^3`);;
e (REWRITE_WITH `(HD vl):real^3 = HD (truncate_simplex 1 vl)`);;
e (ONCE_REWRITE_TAC[EQ_SYM_EQ]);;
e (MATCH_MP_TAC Packing3.HD_TRUNCATE_SIMPLEX);;
e (ASM_REWRITE_TAC[LENGTH] THEN ARITH_TAC);;
e (ASM_REWRITE_TAC[HD; TL]);;
e (NEW_GOAL `HD (TL(truncate_simplex 1 vl)) = u1:real^3`);;
e (ASM_REWRITE_TAC[HD; TL]);;
e (NEW_GOAL `HD (TL(truncate_simplex 1 vl)) = v1:real^3`);;
e (REWRITE_TAC[ASSUME `vl = [v0; v1; v2; v3:real^3]`;  
   TRUNCATE_SIMPLEX_EXPLICIT_1; HD; TL]);;
e (ASM_MESON_TAC[]);;

e (EXPAND_TAC "L");;
e (REWRITE_TAC [SET_RULE `(A INTER B INTER C) INTER D = C INTER D 
                       <=> (!x. x IN C INTER D ==> x IN A /\ x IN B)`]);;

e (REPEAT GEN_TAC THEN STRIP_TAC);;
e (NEW_GOAL `x:real^3 IN C`);;
e (ASM_SET_TAC[]);;
e (UP_ASM_TAC THEN EXPAND_TAC "C" THEN STRIP_TAC);;
e (NEW_GOAL `x:real^3 IN rcone_gt u0 u1 a'`);;
e (ASM_SET_TAC[]);;
e (STRIP_TAC);;
e (UP_ASM_TAC THEN SET_TAC[RCONE_GT_SUBSET_RCONE_GE]);;

(* ========================================================================== *)
e (UP_ASM_TAC THEN REWRITE_TAC[rcone_ge; rconesgn; rcone_gt; IN; IN_ELIM_THM]);;
e (STRIP_TAC);;

e (ABBREV_TAC `y = u0 + proj_point (u1 - u0:real^3) (x - u0)`);;
e (NEW_GOAL `orthogonal (x - y) (u1 - u0:real^3)`);;
e (REWRITE_WITH `x - y = (x - u0) - proj_point (u1 - u0) (x - u0:real^3)`);;
e (EXPAND_TAC "y" THEN VECTOR_ARITH_TAC);;
e (REWRITE_TAC[GSYM Marchal_cells_2_new.projection_proj_point]);;
e (REWRITE_TAC[orthogonal; Packing3.PROJECTION_ORTHOGONAL]);;

e (NEW_GOAL `norm (x - u0) pow 2 = norm (y - u0) pow 2 + norm (x - y:real^3) pow 2`);;
e (MATCH_MP_TAC PYTHAGORAS);;
e (REWRITE_TAC[orthogonal]);;
e (ONCE_REWRITE_TAC[VECTOR_ARITH `(a - b) dot c = --(c dot (b - a))`]);;
e (REWRITE_WITH `y - u0 = proj_point (u1 - u0) (x - u0:real^3)`);;
e (EXPAND_TAC "y" THEN REWRITE_TAC[VECTOR_ARITH `(a + b) - a:real^3 = b`]);;
e (REWRITE_TAC[PRO_EXP; DOT_RMUL]);;
e (UP_ASM_TAC THEN REWRITE_TAC[orthogonal] THEN STRIP_TAC);;
e (ASM_REWRITE_TAC[]);;
e (REAL_ARITH_TAC);;

e (NEW_GOAL `norm (x - u1) pow 2 = norm (y - u1) pow 2 + norm (x - y:real^3) pow 2`);;
e (MATCH_MP_TAC PYTHAGORAS);;
e (REWRITE_TAC[orthogonal]);;
e (ONCE_REWRITE_TAC[VECTOR_ARITH `(a - b) dot c = c dot (a - b)`]);;
e (REWRITE_WITH `u1 - y = (u1 - u0) - proj_point (u1 - u0) (x - u0:real^3)`);;
e (EXPAND_TAC "y" THEN VECTOR_ARITH_TAC);;
e (REWRITE_TAC[PRO_EXP; VECTOR_ARITH `x - a % x = (&1 - a) % x`]);;
e (REWRITE_TAC[DOT_RMUL] THEN DEL_TAC);;
e (UP_ASM_TAC THEN REWRITE_TAC[orthogonal] THEN STRIP_TAC);;
e (ASM_REWRITE_TAC[]);;
e (REAL_ARITH_TAC);;

e (MP_TAC (ASSUME `(x - u0:real^3) dot (u1 - u0) > 
                dist (x,u0) * dist (u1,u0) * a'`));;
e (REWRITE_WITH `(x - u0) dot (u1 - u0) = 
                 (x - y) dot (u1 - u0) + (y - u0) dot (u1 - u0:real^3)`);;
e (VECTOR_ARITH_TAC);;
e (REWRITE_WITH `(x - u1) dot (u0 - u1) = 
                 (x - y) dot (u0 - u1) + (y - u1) dot (u0 - u1:real^3)`);;
e (VECTOR_ARITH_TAC);;
e (REWRITE_WITH `(x - y) dot (u1 - u0:real^3) = &0`);;
e (ASM_REWRITE_TAC[GSYM orthogonal]);;
e (REWRITE_WITH `(x - y) dot (u0 - u1:real^3) = &0`);;
e (ONCE_REWRITE_TAC[VECTOR_ARITH `a dot (u0 - u1) = --(a dot (u1 - u0))`]);;
e (REWRITE_TAC[REAL_ARITH `--a = &0 <=> a = &0`]);;
e (ASM_REWRITE_TAC[GSYM orthogonal]);;
e (REWRITE_TAC[REAL_ARITH `&0 + a = a`]);;

e (STRIP_TAC);;
e (NEW_GOAL `(y - u0) dot (u1 - u0) = norm (y - u0) * norm (u1 - u0:real^3)`);;
e (REWRITE_TAC[NORM_CAUCHY_SCHWARZ_EQ]);;
e (REWRITE_WITH `y - u0 = proj_point (u1 - u0) (x - u0:real^3)`);;
e (EXPAND_TAC "y" THEN REWRITE_TAC[VECTOR_ARITH `(a + b) - a:real^3 = b`]);;
e (REWRITE_TAC[PRO_EXP; NORM_MUL; VECTOR_MUL_ASSOC]);;
e (MATCH_MP_TAC (MESON[] `a = b ==> a % x = b % x`));;
e (REWRITE_TAC[REAL_ARITH `a * norm b = norm b * a`]);;
e (MATCH_MP_TAC (MESON[] `a = b ==> x * a = x * b`));;
e (REWRITE_TAC[REAL_ABS_REFL]);;
e (MATCH_MP_TAC REAL_LE_DIV);;
e (REWRITE_TAC[DOT_POS_LE]);;

e (REWRITE_WITH `(x - u0) dot (u1 - u0) = 
                 (x - y) dot (u1 - u0) + (y - u0) dot (u1 - u0:real^3)`);;
e (VECTOR_ARITH_TAC);;
e (REWRITE_WITH `(x - y) dot (u1 - u0:real^3) = &0`);;
e (ASM_REWRITE_TAC[GSYM orthogonal]);;
e (REWRITE_TAC[REAL_ARITH `&0 + a = a`]);;

e (NEW_GOAL `y IN convex hull {u0, u1:real^3}`);;
e (NEW_GOAL `y IN affine hull {u0, u1:real^3}`);;
e (REWRITE_TAC[AFFINE_HULL_2; IN; IN_ELIM_THM]);;
e (EXPAND_TAC "y" THEN REWRITE_TAC[PRO_EXP]);;
e (ABBREV_TAC `rtemp = ((x - u0) dot (u1 - u0)) / ((u1 - u0) dot (u1 - 
                u0:real^3))`);;
e (EXISTS_TAC `&1 - rtemp` THEN EXISTS_TAC `rtemp:real`);;
e (STRIP_TAC);;
e (REAL_ARITH_TAC);;
e (VECTOR_ARITH_TAC);;
e (UP_ASM_TAC THEN REWRITE_TAC[IN; AFFINE_HULL_2; CONVEX_HULL_2; IN_ELIM_THM]);;
e (REPEAT STRIP_TAC);;
e (EXISTS_TAC `u:real` THEN EXISTS_TAC `v:real`);;
e (ASM_REWRITE_TAC[]);;

e (NEW_GOAL `y - u0 = v % (u1 - u0:real^3)`);;
e (NEW_GOAL `y - u0 = y - (u + v) % u0:real^3`);;
e (REWRITE_TAC[ASSUME `u + v = &1`; VECTOR_MUL_LID]);;
e (UP_ASM_TAC THEN REWRITE_WITH `y - (u + v) % u0 = v % (u1 - u0:real^3)`);;
e (REWRITE_TAC[ASSUME `y = u % u0 + v % u1:real^3`] THEN VECTOR_ARITH_TAC);;

e (ASM_CASES_TAC `u < &0`);;
e (NEW_GOAL `F`);;
e (NEW_GOAL `norm (y - u0) <= norm (x - u0:real^3)`);;
e (MATCH_MP_TAC Tactics_jordan.REAL_POW_2_LE);;
e (REWRITE_TAC[NORM_POS_LE; ASSUME 
  `norm (x - u0:real^3) pow 2 = norm (y - u0) pow 2 + norm (x - y) pow 2`; 
   REAL_ARITH `a <= a + b <=> &0 <= b`; REAL_LE_POW_2]);;
e (NEW_GOAL `norm (x - u0:real^3) < &1`);;
e (REWRITE_TAC[GSYM dist] THEN ONCE_REWRITE_TAC[DIST_SYM] THEN 
   REWRITE_TAC[GSYM IN_BALL]);;
e (ASM_SET_TAC[]);;
e (NEW_GOAL `norm (y - u0) = v * norm (u1:real^3 - u0)`);;
e (ASM_REWRITE_TAC[NORM_MUL]);;

e (REWRITE_WITH `abs v = v`);;
e (REWRITE_TAC[REAL_ABS_REFL] THEN ASM_REAL_ARITH_TAC);;
e (NEW_GOAL `&2 <= norm (u1 - u0:real^3)`);;
e (REWRITE_TAC[GSYM dist]);;
e (UNDISCH_TAC `packing (V:real^3->bool)` THEN REWRITE_TAC[packing]);;
e (REPEAT STRIP_TAC);;
e (FIRST_ASSUM MATCH_MP_TAC);;
e (ASM_SET_TAC[]);;
e (NEW_GOAL `v * &2 <= v * norm (u1 - u0:real^3)`);;
e (REWRITE_TAC[REAL_ARITH `a * b <= a * c <=> &0 <= a * (c - b)`]);;
e (MATCH_MP_TAC REAL_LE_MUL);;
e (ASM_REAL_ARITH_TAC);;
e (ASM_REAL_ARITH_TAC);;
e (ASM_MESON_TAC[]);;

e (ASM_CASES_TAC `v < &0`);;
e (NEW_GOAL `F`);;
e (NEW_GOAL `(y - u0) dot (u1 - u0:real^3) <= &0`);;
e (ASM_REWRITE_TAC[DOT_LMUL; REAL_ARITH `a * b <= &0 <=> &0 <= (--a) * b`]);;
e (MATCH_MP_TAC REAL_LE_MUL);;
e (REWRITE_TAC[DOT_POS_LE] THEN ASM_REAL_ARITH_TAC);;
e (NEW_GOAL `&0 <= dist (x,u0) * dist (u1,u0:real^3) * a'`);;
e (MATCH_MP_TAC REAL_LE_MUL);;
e (REWRITE_TAC[DIST_POS_LE]);;
e (MATCH_MP_TAC REAL_LE_MUL);;
e (REWRITE_TAC[DIST_POS_LE]);;
e (EXPAND_TAC "a'" THEN MATCH_MP_TAC REAL_LE_DIV);;
e (STRIP_TAC);;
e (REWRITE_TAC[HL_2]);;
e (MATCH_MP_TAC REAL_LE_MUL);;
e (REWRITE_TAC[DIST_POS_LE] THEN REAL_ARITH_TAC);;
e (MATCH_MP_TAC SQRT_POS_LE THEN REAL_ARITH_TAC);;
e (ASM_REAL_ARITH_TAC);;
e (ASM_MESON_TAC[]);;
e (ASM_REAL_ARITH_TAC);;

e (NEW_GOAL `&0 <= dist (x,u0) * dist (u1,u0:real^3) * a'`);;
e (MATCH_MP_TAC REAL_LE_MUL);;
e (REWRITE_TAC[DIST_POS_LE]);;
e (MATCH_MP_TAC REAL_LE_MUL);;
e (REWRITE_TAC[DIST_POS_LE]);;
e (EXPAND_TAC "a'" THEN MATCH_MP_TAC REAL_LE_DIV);;
e (STRIP_TAC);;
e (REWRITE_TAC[HL_2]);;
e (MATCH_MP_TAC REAL_LE_MUL);;
e (REWRITE_TAC[DIST_POS_LE] THEN REAL_ARITH_TAC);;
e (MATCH_MP_TAC SQRT_POS_LE THEN REAL_ARITH_TAC);;
e (ASM_REAL_ARITH_TAC);;


e (NEW_GOAL `(y - u1) dot (u0 - u1) = norm (y - u1) * norm (u0 - u1:real^3)`);;
e (REWRITE_TAC[NORM_CAUCHY_SCHWARZ_EQ]);;
e (REWRITE_WITH `y - u1 = proj_point (u1 - u0) (x - u0:real^3) - (u1 - u0)`);;
e (EXPAND_TAC "y" THEN VECTOR_ARITH_TAC);;
e (REWRITE_TAC[PRO_EXP; VECTOR_ARITH `x % a - a = (x - &1) % a`; NORM_MUL;
               VECTOR_MUL_ASSOC]);;
e (REWRITE_WITH ` 
   (norm (u0 - u1) *
   (((x - u0) dot (u1 - u0)) / ((u1 - u0) dot (u1 - u0)) - &1)) % (u1 - u0) =  
   (norm (u0 - u1:real^3) *
   (&1 - ((x - u0) dot (u1 - u0)) / ((u1 - u0) dot (u1 - u0)))) % (u0 - u1)`);;
e (VECTOR_ARITH_TAC);;
e (MATCH_MP_TAC (MESON[] `a = b ==> a % x = b % x`));;
e (REWRITE_TAC[REAL_ARITH `a * norm b = norm b * a`]);;
e (REWRITE_TAC[NORM_ARITH `norm (a - b) = norm (b - a)`]);;
e (MATCH_MP_TAC (MESON[] `a = b ==> x * a = x * b`));;
e (REWRITE_TAC[REAL_ARITH `abs (x - &1) = abs (&1 - x)`]);;
e (REWRITE_TAC[REAL_ABS_REFL; REAL_ARITH `&0 <= a - b <=> b <= a`]);;
e (REWRITE_WITH `((x - u0) dot (u1 - u0)) / ((u1 - u0) dot (u1 - u0)) <= &1
  <=> ((x - u0) dot (u1 - u0)) <= &1 * ((u1 - u0) dot (u1 - u0:real^3))`);;
e (MATCH_MP_TAC REAL_LE_LDIV_EQ);;
e (REWRITE_TAC[DOT_POS_LT; VECTOR_ARITH `a - b = vec 0 <=> b = a`]);;
e (ASM_REWRITE_TAC[]);;
e (NEW_GOAL `(x - u0) dot (u1 - u0) <= norm (x - u0) * norm (u1 - u0:real^3)`);;
e (REWRITE_TAC[NORM_CAUCHY_SCHWARZ]);;

e (NEW_GOAL `norm (x - u0) * norm (u1 - u0) <= &1 * norm (u1 - u0:real^3)`);;
e (REWRITE_TAC[REAL_ARITH `a * x <= b * x <=> &0 <= (b - a) * x`]);;
e (MATCH_MP_TAC REAL_LE_MUL);;
e (REWRITE_TAC[NORM_POS_LE; REAL_ARITH `&0 <= a - b <=> b <= a`; GSYM dist]);;
e (MATCH_MP_TAC (REAL_ARITH `a < x ==> a <= x`));;
e (ONCE_REWRITE_TAC[DIST_SYM] THEN REWRITE_TAC[GSYM IN_BALL]);;
e (ASM_SET_TAC[]);;
e (REWRITE_TAC[GSYM NORM_POW_2; REAL_ARITH `&1 * a pow 2 = a * a`]);;
e (NEW_GOAL `&1 * norm (u1 - u0) <= norm (u1 - u0) * norm (u1 - u0:real^3)`);;
e (REWRITE_TAC[REAL_ARITH `a * x <= b * x <=> &0 <= (b - a) * x`]);;
e (MATCH_MP_TAC REAL_LE_MUL);;
e (REWRITE_TAC[NORM_POS_LE; REAL_ARITH `&0 <= a - b <=> b <= a`; GSYM dist]);;
e (MATCH_MP_TAC (REAL_ARITH `&2 <= x ==> &1 <= x`));;
e (UNDISCH_TAC `packing (V:real^3->bool)` THEN REWRITE_TAC[packing]);;
e (STRIP_TAC);;
e (FIRST_ASSUM MATCH_MP_TAC);;
e (ASM_SET_TAC[]);;
e (ASM_REAL_ARITH_TAC);;

e (ASM_REWRITE_TAC[dist]);;
e (REWRITE_TAC[REAL_ARITH `a * b >= x * b * c <=> &0 <= b * (a - x * c)`]);;
e (MATCH_MP_TAC REAL_LE_MUL);;
e (REWRITE_TAC[NORM_POS_LE; REAL_ARITH `&0 <= a - b <=> b <= a`]);;
e (MATCH_MP_TAC Tactics_jordan.REAL_POW_2_LE);;
e (STRIP_TAC);;

e (MATCH_MP_TAC REAL_LE_MUL);;
e (REWRITE_TAC[NORM_POS_LE]);;
e (EXPAND_TAC "a'" THEN MATCH_MP_TAC REAL_LE_DIV);;
e (STRIP_TAC);;
e (REWRITE_TAC[HL_2]);;
e (MATCH_MP_TAC REAL_LE_MUL);;
e (REWRITE_TAC[DIST_POS_LE] THEN REAL_ARITH_TAC);;
e (MATCH_MP_TAC SQRT_POS_LE THEN REAL_ARITH_TAC);;
e (REWRITE_TAC[NORM_POS_LE; REAL_ARITH `(a * b) pow 2 = a pow 2 * b pow 2`]);;
e (ASM_REWRITE_TAC[]);;
e (REWRITE_TAC[REAL_ARITH `(a + b) * x <= a <=> b * x <= (&1 - x) * a`]);;

e (UNDISCH_TAC `(y - u0) dot (u1 - u0) > dist (x,u0) * dist (u1,u0:real^3) * a'`);;
e (ASM_REWRITE_TAC[dist]);;
e (REWRITE_TAC[REAL_ARITH `a * b > x * b * c <=> &0 < b * (a - x * c)`]);;
e (REWRITE_TAC[REAL_MUL_POS_LT]);;
e (REWRITE_WITH `~(norm (u1 - u0:real^3) < &0 /\ 
                   norm (y - u0) - norm (x - u0) * a' < &0)`);;
e (NEW_GOAL `&0 <= norm (u1 - u0:real^3)`);;
e (REWRITE_TAC[NORM_POS_LE]);;
e (ASM_REAL_ARITH_TAC);;
e (REWRITE_TAC[REAL_ARITH `&0 < a - b <=> b < a`]);;
e (REWRITE_WITH `norm (x - u0) * a' < norm (y - u0:real^3) <=> 
                (norm (x - u0) * a') pow 2 < norm (y - u0) pow 2`);;
e (MATCH_MP_TAC Pack1.bp_bdt);;
e (STRIP_TAC);;
e (MATCH_MP_TAC REAL_LE_MUL);;
e (REWRITE_TAC[NORM_POS_LE]);;
e (EXPAND_TAC "a'" THEN MATCH_MP_TAC REAL_LE_DIV);;
e (STRIP_TAC);;
e (REWRITE_TAC[HL_2]);;
e (MATCH_MP_TAC REAL_LE_MUL);;
e (REWRITE_TAC[DIST_POS_LE] THEN REAL_ARITH_TAC);;
e (MATCH_MP_TAC SQRT_POS_LE THEN REAL_ARITH_TAC);;
e (REWRITE_TAC[NORM_POS_LE]);;

e (ASM_REWRITE_TAC[REAL_ARITH `(a * b) pow 2 = a pow 2 * b pow 2`]);;
e (REWRITE_TAC[REAL_ARITH `(a + b) * x < a <=> b * x < (&1 - x) * a`]);;
e (STRIP_TAC);;
 
e (NEW_GOAL `(&1 - a' pow 2) * norm (y - u0) pow 2 <= 
             (&1 - a' pow 2) * norm (y - u1:real^3) pow 2`);;
e (REWRITE_TAC[REAL_ARITH `a * x <= a * y <=> &0 <= a * (y - x)`]);;
e (MATCH_MP_TAC REAL_LE_MUL);;
e (STRIP_TAC);;
e (REWRITE_TAC[REAL_ARITH `&0 <= &1 - b <=> b <= &1 pow 2`]);;
e (REWRITE_WITH `a' pow 2 <= &1 pow 2 <=> a' <= &1`);;
e (ONCE_REWRITE_TAC[EQ_SYM_EQ]);;
e (MATCH_MP_TAC Collect_geom.POW2_COND);;
e (REWRITE_TAC[REAL_ARITH `&0 <= &1`]);;
e (EXPAND_TAC "a'" THEN MATCH_MP_TAC REAL_LE_DIV);;
e (STRIP_TAC);;
e (REWRITE_TAC[HL_2]);;
e (MATCH_MP_TAC REAL_LE_MUL);;
e (REWRITE_TAC[DIST_POS_LE] THEN REAL_ARITH_TAC);;
e (MATCH_MP_TAC SQRT_POS_LE THEN REAL_ARITH_TAC);;

e (EXPAND_TAC "a'");;
e (MATCH_MP_TAC REAL_DIV_LE_1_TACTICS);;
e (ASM_SIMP_TAC[SQRT_POS_LT; REAL_ARITH `&0 < &2`]);;
e (ASM_REAL_ARITH_TAC);;
e (NEW_GOAL `norm (x - u0) pow 2 <= norm (x - u1:real^3) pow 2`);;
e (REWRITE_WITH `norm (x - u0) pow 2 <= norm (x - u1:real^3) pow 2 <=>
                 norm (x - u0)  <= norm (x - u1:real^3)`);;
e (ONCE_REWRITE_TAC[EQ_SYM_EQ]);;
e (MATCH_MP_TAC Collect_geom.POW2_COND);;
e (REWRITE_TAC[NORM_POS_LE]);;
e (MATCH_MP_TAC (REAL_ARITH `&2 * x <= x + y ==> x <= y`));;
e (REWRITE_TAC[GSYM dist]);;

e (NEW_GOAL `dist (x, u0:real^3) < &1`);;
e (ONCE_REWRITE_TAC[DIST_SYM] THEN REWRITE_TAC[GSYM IN_BALL]);;
e (ASM_SET_TAC[]);;
e (NEW_GOAL `&2 * dist (x, u0:real^3) < &2`);;
e (ASM_REAL_ARITH_TAC);;
e (NEW_GOAL `&2 <= dist (x, u0) + dist (x, u1:real^3)`);;
e (NEW_GOAL `&2 <= dist (u0, u1:real^3)`);;
e (UNDISCH_TAC `packing (V:real^3->bool)` THEN REWRITE_TAC[packing]);;
e (STRIP_TAC);;
e (FIRST_ASSUM MATCH_MP_TAC);;
e (ASM_SET_TAC[]);;
e (NEW_GOAL `dist (u0, u1:real^3) <= dist (u0, x) + dist (x, u1)`);;
e (REWRITE_TAC[DIST_TRIANGLE]);;
e (UP_ASM_TAC THEN REWRITE_TAC[DIST_SYM]);;
e (ASM_REAL_ARITH_TAC);;
e (ASM_REAL_ARITH_TAC);;
e (UP_ASM_TAC THEN ASM_REWRITE_TAC[]);;
e (REAL_ARITH_TAC);;
e (REWRITE_TAC[GSYM (ASSUME `&1 = r`)]);;
e (ASM_REAL_ARITH_TAC);;


e (NEW_GOAL `F`);;
e (UNDISCH_TAC `~NULLSET (X INTER C)`);;
e (ASM_REWRITE_TAC[MCELL_EXPLICIT; mcell2; SET_RULE `{} INTER s = {}`]);;
e (REWRITE_TAC[NEGLIGIBLE_EMPTY]);;
e (ASM_MESON_TAC[]);;

e (NEW_GOAL `~coplanar {u0, u1:real^3, m, s3}`);;
e (ONCE_REWRITE_TAC[GSYM COPLANAR_AFFINE_HULL_COPLANAR]);;
e (STRIP_TAC);;
e (NEW_GOAL `NULLSET X`);;
e (MATCH_MP_TAC NEGLIGIBLE_SUBSET);;
e (EXISTS_TAC `affine hull {u0, u1, m, s3:real^3}`);;
e (STRIP_TAC);;
e (MATCH_MP_TAC COPLANAR_IMP_NEGLIGIBLE);;
e (UP_ASM_TAC THEN MESON_TAC[]);;
e (ASM_REWRITE_TAC[MCELL_EXPLICIT; mcell2]);;
e (COND_CASES_TAC);;
e (LET_TAC);;
e (MATCH_MP_TAC (SET_RULE `A SUBSET B ==> M INTER N INTER A SUBSET B`));;

e (NEW_GOAL `?v0 v1 v2 v3. vl = [v0;v1;v2;v3:real^3]`);;
e (MATCH_MP_TAC Marchal_cells.BARV_3_EXPLICIT);;
e (EXISTS_TAC `V:real^3->bool` THEN ASM_REWRITE_TAC[]);;
e (UP_ASM_TAC THEN STRIP_TAC);;
e (REWRITE_WITH `HD vl = u0 /\ HD (TL vl) = u1:real^3`);;
e (REWRITE_WITH `(HD vl):real^3 = HD (truncate_simplex 1 vl)`);;
e (ONCE_REWRITE_TAC[EQ_SYM_EQ]);;
e (MATCH_MP_TAC Packing3.HD_TRUNCATE_SIMPLEX);;
e (ASM_REWRITE_TAC[LENGTH] THEN ARITH_TAC);;
e (ASM_REWRITE_TAC[HD; TL]);;
e (NEW_GOAL `HD (TL(truncate_simplex 1 vl)) = u1:real^3`);;
e (ASM_REWRITE_TAC[HD; TL]);;
e (NEW_GOAL `HD (TL(truncate_simplex 1 vl)) = v1:real^3`);;
e (REWRITE_TAC[ASSUME `vl = [v0; v1; v2; v3:real^3]`;  
   TRUNCATE_SIMPLEX_EXPLICIT_1; HD; TL]);;
e (ASM_MESON_TAC[]);;
e (REWRITE_WITH `{u0, u1, m, s3} = {u0, u1} UNION {m:real^3, s3}`);;
e (SET_TAC[]);;
e (REWRITE_TAC[AFF_GE_SUBSET_AFFINE_HULL]);;
e (SET_TAC[]);;
e (UNDISCH_TAC `~NULLSET (X INTER C)`);;
e (REWRITE_TAC[] THEN MATCH_MP_TAC NEGLIGIBLE_SUBSET);;
e (EXISTS_TAC `X:real^3->bool`);;
e (ASM_REWRITE_TAC[] THEN SET_TAC[]);;

(* ========================================================================= *)

e (ASM_CASES_TAC `azim u0 u1 m (s3:real^3) < pi`);;
e (REWRITE_WITH `vol (L INTER C) = vol (C INTER wedge u0 u1 m s3)`);;
e (ASM_SIMP_TAC[WEDGE_LUNE]);;
e (REWRITE_WITH `L INTER conic_cap (u0:real^3) u1 r c = 
                 conic_cap u0 u1 r c INTER L`);;
e (SET_TAC[]);;
e (MATCH_MP_TAC MEASURE_NEGLIGIBLE_SYMDIFF);;
e (REWRITE_WITH `conic_cap (u0:real^3) u1 r c INTER 
   aff_gt {u0, u1} {m, s3} DIFF conic_cap u0 u1 r c INTER L = {}`);;
e (EXPAND_TAC "L");;
e (MATCH_MP_TAC (SET_RULE `A SUBSET B ==> C INTER A DIFF C INTER B = {}`));;
e (REWRITE_TAC[AFF_GT_SUBSET_AFF_GE]);;
e (REWRITE_TAC[SET_RULE `A UNION {} = A`]);;
e (EXPAND_TAC "L");;

e (REWRITE_WITH `aff_ge {u0, u1:real^3} {m, s3} =
                 aff_gt {u0, u1} {m, s3} UNION 
   UNIONS {aff_ge {u0, u1} ({m, s3} DELETE a) | a | a IN  {m, s3}}`);;
e (MATCH_MP_TAC AFF_GE_AFF_GT_DECOMP);;
e (REWRITE_TAC[Geomdetail.FINITE6]);;
e (REWRITE_TAC[DISJOINT]);;

e (ASM_CASES_TAC `m IN {u0, u1:real^3}`);;
e (NEW_GOAL `F`);;
e (UNDISCH_TAC `~coplanar {u0, u1, m, s3:real^3}`);;
e (REWRITE_WITH `{u0, u1, m, s3} = {u0, u1, s3:real^3}`);;
e (UP_ASM_TAC THEN SET_TAC[]);;
e (REWRITE_TAC[COPLANAR_3]);;
e (ASM_MESON_TAC[]);;

e (ASM_CASES_TAC `s3 IN {u0, u1:real^3}`);;
e (NEW_GOAL `F`);;
e (UNDISCH_TAC `~coplanar {u0, u1, m, s3:real^3}`);;
e (REWRITE_WITH `{u0, u1, m, s3} = {u0, u1, m:real^3}`);;
e (UP_ASM_TAC THEN SET_TAC[]);;
e (REWRITE_TAC[COPLANAR_3]);;
e (ASM_MESON_TAC[]);;
e (UP_ASM_TAC THEN UP_ASM_TAC THEN SET_TAC[]);;

e (MATCH_MP_TAC NEGLIGIBLE_SUBSET);;
e (EXISTS_TAC 
  `UNIONS {aff_ge {u0, u1:real^3} ({m, s3} DELETE a) | a | a IN {m, s3}}`);;
e (STRIP_TAC);;
e (MATCH_MP_TAC NEGLIGIBLE_SUBSET);;
e (EXISTS_TAC 
  `aff_ge {u0, u1:real^3} {m} UNION aff_ge {u0, u1:real^3} {s3}`);;
e (STRIP_TAC);;
e (MATCH_MP_TAC NEGLIGIBLE_UNION);;
e (STRIP_TAC);;

e (MATCH_MP_TAC NEGLIGIBLE_SUBSET);;
e (EXISTS_TAC `affine hull {u0, u1:real^3, m}`);;
e (STRIP_TAC);;
e (REWRITE_TAC[NEGLIGIBLE_AFFINE_HULL_3]);;
e (REWRITE_WITH `{u0,u1,m:real^3} = {u0,u1} UNION {m}`);;
e (SET_TAC[]);;
e (REWRITE_TAC[AFF_GE_SUBSET_AFFINE_HULL]);;
e (MATCH_MP_TAC NEGLIGIBLE_SUBSET);;
e (EXISTS_TAC `affine hull {u0, u1:real^3, s3}`);;
e (STRIP_TAC);;
e (REWRITE_TAC[NEGLIGIBLE_AFFINE_HULL_3]);;
e (REWRITE_WITH `{u0,u1,s3:real^3} = {u0,u1} UNION {s3}`);;
e (SET_TAC[]);;
e (REWRITE_TAC[AFF_GE_SUBSET_AFFINE_HULL]);;
e (REWRITE_TAC[SET_RULE 
  `UNIONS {aff_ge {u0, u1} ({m, s3} DELETE a) | a | a IN {m, s3}} = 
         aff_ge {u0, u1} ({m, s3} DELETE s3) 
   UNION aff_ge {u0, u1} ({m, s3} DELETE m)`]);;
e (MATCH_MP_TAC (SET_RULE 
  `A SUBSET B /\ C SUBSET D ==> A UNION C SUBSET B UNION D`));;
e (STRIP_TAC);;
e (MATCH_MP_TAC AFF_GE_MONO_RIGHT);;
e (STRIP_TAC);;
e (SET_TAC[]);;

e (REWRITE_TAC[DISJOINT]);;
e (ASM_CASES_TAC `m IN {u0, u1:real^3}`);;
e (NEW_GOAL `F`);;
e (UNDISCH_TAC `~coplanar {u0, u1, m, s3:real^3}`);;
e (REWRITE_WITH `{u0, u1, m, s3} = {u0, u1, s3:real^3}`);;
e (UP_ASM_TAC THEN SET_TAC[]);;
e (REWRITE_TAC[COPLANAR_3]);;
e (ASM_MESON_TAC[]);;
e (UP_ASM_TAC THEN SET_TAC[]);;

e (MATCH_MP_TAC AFF_GE_MONO_RIGHT);;
e (STRIP_TAC);;
e (SET_TAC[]);;
e (REWRITE_TAC[DISJOINT]);;
e (ASM_CASES_TAC `s3 IN {u0, u1:real^3}`);;
e (NEW_GOAL `F`);;
e (UNDISCH_TAC `~coplanar {u0, u1, m, s3:real^3}`);;
e (REWRITE_WITH `{u0, u1, m, s3} = {u0, u1, m:real^3}`);;
e (UP_ASM_TAC THEN SET_TAC[]);;
e (REWRITE_TAC[COPLANAR_3]);;
e (ASM_MESON_TAC[]);;
e (UP_ASM_TAC THEN SET_TAC[]);;

e (SET_TAC[]);;

e (REWRITE_TAC[ASSUME `C = conic_cap (u0:real^3) u1 r c`]);;
e (REWRITE_WITH `vol (conic_cap u0 u1 r c INTER wedge u0 u1 m s3) =
             (if &1 < c \/ r < &0
              then &0
              else azim u0 u1 m s3 / &3 * (&1 - max c (-- &1)) * r pow 3)`);;
e (NEW_GOAL `~collinear {u0:real^3, u1, m} /\ ~collinear {u0, u1, s3}`);;
e (STRIP_TAC);;
e (MATCH_MP_TAC NOT_COPLANAR_NOT_COLLINEAR);;
e (EXISTS_TAC `s3:real^3`);;
e (ASM_REWRITE_TAC[]);;
e (MATCH_MP_TAC NOT_COPLANAR_NOT_COLLINEAR);;
e (EXISTS_TAC `m:real^3`);;
e (ONCE_REWRITE_TAC[SET_RULE `{a,b,c,d} = {a,b,d,c}`]);;
e (ASM_REWRITE_TAC[]);;

e (ASM_SIMP_TAC[VOLUME_CONIC_CAP_WEDGE]);;
e (COND_CASES_TAC);;
e (NEW_GOAL `F`);;
e (ASM_REAL_ARITH_TAC);;
e (ASM_MESON_TAC[]);;

e (REWRITE_WITH `azim (u0:real^3) u1 m s3 = dihV u0 u1 m s3`);;
e (MATCH_MP_TAC AZIM_DIHV_SAME);;
e (ASM_REWRITE_TAC[]);;
e (STRIP_TAC);;
e (MATCH_MP_TAC NOT_COPLANAR_NOT_COLLINEAR);;
e (EXISTS_TAC `s3:real^3`);;
e (ASM_REWRITE_TAC[]);;
e (MATCH_MP_TAC NOT_COPLANAR_NOT_COLLINEAR);;
e (EXISTS_TAC `m:real^3`);;
e (ONCE_REWRITE_TAC[SET_RULE `{a,b,c,d} = {a,b,d,c}`]);;
e (ASM_REWRITE_TAC[]);;

e (REWRITE_TAC[dihX]);;
e (COND_CASES_TAC);;
e (NEW_GOAL `F`);;
e (UNDISCH_TAC `~NULLSET (X INTER C)`);;
e (REWRITE_TAC[]);;
e (MATCH_MP_TAC NEGLIGIBLE_SUBSET);;
e (EXISTS_TAC `X:real^3->bool`);;
e (ASM_REWRITE_TAC[] THEN SET_TAC[]);;
e (ASM_MESON_TAC[]);;

e (LET_TAC);;

e (UP_ASM_TAC THEN REWRITE_TAC[cell_params_d]);;
e (ABBREV_TAC `P = (\(k, ul). k <= 4 /\
           ul IN barV V 3 /\
           X = mcell k V ul /\
           initial_sublist [u0; u1] ul)`);;
e (STRIP_TAC);;
e (NEW_GOAL `(P:num#(real^3)list->bool) ((@) P)`);;
e (MATCH_MP_TAC SELECT_AX);;
e (EXISTS_TAC `(2, vl:(real^3)list)`);;
e (EXPAND_TAC "P");;
e (REWRITE_TAC[BETA_THM]);;
e (REWRITE_TAC[IN; ARITH_RULE `2 <= 4`] THEN ASM_REWRITE_TAC[]);;
e (REWRITE_WITH `initial_sublist [u0;u1:real^3] vl /\ LENGTH [u0;u1] = 1 + 1`);;
e (REWRITE_TAC[GSYM Packing3.TRUNCATE_SIMPLEX_INITIAL_SUBLIST]);;
e (ASM_REWRITE_TAC[]);;

e (NEW_GOAL `?v0 v1 v2 v3. vl = [v0;v1;v2;v3:real^3]`);;
e (MATCH_MP_TAC Marchal_cells.BARV_3_EXPLICIT);;
e (EXISTS_TAC `V:real^3->bool` THEN ASM_REWRITE_TAC[]);;
e (UP_ASM_TAC THEN STRIP_TAC);;
e (ASM_REWRITE_TAC[LENGTH] THEN ARITH_TAC);;
e (UP_ASM_TAC THEN ASM_REWRITE_TAC[]);;
e (EXPAND_TAC "P" THEN REWRITE_TAC[IN] THEN REPEAT STRIP_TAC);;

e (NEW_GOAL `k' = 2 /\ mcell k' V ul = mcell 2 V vl`);;
e (MATCH_MP_TAC Ajripqn.AJRIPQN);;
e (ASM_REWRITE_TAC[]);;
e (REWRITE_WITH `mcell k' V ul INTER mcell 2 V vl = X`);;
e (ASM_SET_TAC[]);;
e (REPEAT STRIP_TAC);;
e (UNDISCH_TAC `k' <= 4` THEN REWRITE_TAC[ARITH_RULE 
   `a <= 4 <=> a = 0 \/a = 1 \/ a = 2 \/ a = 3 \/ a = 4`] THEN SET_TAC[]);;
e (SET_TAC[]);;
e (ASM_MESON_TAC[]);;

e (COND_CASES_TAC);;
e (REWRITE_TAC[dihu2]);;

e (REWRITE_WITH `omega_list_n V ul 3 = s3`);;
e (EXPAND_TAC "s3");;
e (NEW_GOAL `2  = 2 /\
             (!k. 2 - 1 <= k /\ k <= 3
                  ==> omega_list_n V ul k = omega_list_n V vl k)`);;
e (MATCH_MP_TAC MCELL_ID_OMEGA_LIST_N);;
e (ASM_REWRITE_TAC[SET_RULE `2 IN {2,3,4}`]);;
e (ASM_MESON_TAC[]);;
e (UP_ASM_TAC THEN STRIP_TAC);;
e (FIRST_ASSUM MATCH_MP_TAC);;
e (ARITH_TAC);;

e (REWRITE_WITH `mxi V ul = m`);;
e (EXPAND_TAC "m");;
e (MATCH_MP_TAC MCELL_ID_MXI);;
e (EXISTS_TAC `2` THEN EXISTS_TAC `2`);;
e (ASM_REWRITE_TAC[SET_RULE `2 IN {2,3}`]);;
e (STRIP_TAC);;

e (REWRITE_WITH `(HD vl):real^3 = HD (truncate_simplex 1 vl)`);;
e (ONCE_REWRITE_TAC[EQ_SYM_EQ]);;
e (MATCH_MP_TAC Packing3.HD_TRUNCATE_SIMPLEX);;
e (REWRITE_WITH `LENGTH (vl:(real^3)list) = 3 + 1 /\ 
                 CARD (set_of_list vl) = 3 + 1`);;
e (MATCH_MP_TAC Rogers.BARV_IMP_LENGTH_EQ_CARD);;
e (EXISTS_TAC `V:real^3->bool` THEN ASM_REWRITE_TAC[]);;
e (ARITH_TAC);;
e (ASM_REWRITE_TAC[HD]);;

e (REWRITE_WITH `(HD ul):real^3 = HD (truncate_simplex 1 ul)`);;
e (ONCE_REWRITE_TAC[EQ_SYM_EQ]);;
e (MATCH_MP_TAC Packing3.HD_TRUNCATE_SIMPLEX);;
e (REWRITE_WITH `LENGTH (ul:(real^3)list) = 3 + 1 /\ 
                 CARD (set_of_list ul) = 3 + 1`);;
e (MATCH_MP_TAC Rogers.BARV_IMP_LENGTH_EQ_CARD);;
e (EXISTS_TAC `V:real^3->bool` THEN ASM_REWRITE_TAC[]);;
e (ARITH_TAC);;

e (REWRITE_WITH `truncate_simplex 1 ul = [u0;u1:real^3] /\ 1 + 1 <= LENGTH ul`);;
e (REWRITE_TAC[Packing3.TRUNCATE_SIMPLEX_INITIAL_SUBLIST]);;
e (ASM_REWRITE_TAC[LENGTH] THEN ARITH_TAC);;
e (REWRITE_TAC[HD]);;
e (ASM_MESON_TAC[]);;
e (NEW_GOAL `initial_sublist [u0; u1:real^3] ul /\ LENGTH [u0; u1] = 1 + 1`);;
e (ASM_REWRITE_TAC[LENGTH] THEN ARITH_TAC);;
e (NEW_GOAL `truncate_simplex 1 ul = [u0;u1:real^3] /\ 1 + 1 <= LENGTH ul`);;
e (REWRITE_TAC[Packing3.TRUNCATE_SIMPLEX_INITIAL_SUBLIST]);;
e (ASM_REWRITE_TAC[]);;

e (REWRITE_WITH `EL 0 (ul:(real^3)list) = EL 0 (truncate_simplex 1 ul)`);;
e (ONCE_REWRITE_TAC[EQ_SYM_EQ]);;
e (MATCH_MP_TAC Packing3.EL_TRUNCATE_SIMPLEX);;
e (REWRITE_WITH `LENGTH (ul:(real^3)list) = 3 + 1 /\ 
                 CARD (set_of_list ul) = 3 + 1`);;
e (MATCH_MP_TAC Rogers.BARV_IMP_LENGTH_EQ_CARD);;
e (EXISTS_TAC `V:real^3->bool` THEN ASM_REWRITE_TAC[]);;
e (ARITH_TAC);;

e (REWRITE_WITH `EL 1 (ul:(real^3)list) = EL 1 (truncate_simplex 1 ul)`);;
e (ONCE_REWRITE_TAC[EQ_SYM_EQ]);;
e (MATCH_MP_TAC Packing3.EL_TRUNCATE_SIMPLEX);;
e (REWRITE_WITH `LENGTH (ul:(real^3)list) = 3 + 1 /\ 
                 CARD (set_of_list ul) = 3 + 1`);;
e (MATCH_MP_TAC Rogers.BARV_IMP_LENGTH_EQ_CARD);;
e (EXISTS_TAC `V:real^3->bool` THEN ASM_REWRITE_TAC[]);;
e (ARITH_TAC);;
e (ASM_REWRITE_TAC[EL; HD; ARITH_RULE `1 = SUC 0`; TL]);;
e (REWRITE_TAC[REAL_ARITH `a / b * c * d pow 3 = (c/ b * d pow 3) * a`]);;
e (REWRITE_TAC[REAL_ARITH `a * b / (&2 * c) = (a / (&2 * c)) * b`]);;
e (AP_THM_TAC THEN AP_TERM_TAC);;
e (REWRITE_WITH 
  `measurable (conic_cap u0 u1 r c) /\
             vol (conic_cap u0 u1 r c) =
             (if u1 = u0 \/ &1 <= c \/ r < &0
              then &0
              else &2 / &3 * pi * (&1 - c) * r pow 3)`);;
e (MATCH_MP_TAC VOLUME_CONIC_CAP);;
e (ASM_REWRITE_TAC[]);;
e (COND_CASES_TAC);;
e (NEW_GOAL `F`);;
e (UP_ASM_TAC THEN STRIP_TAC);;
e (ASM_MESON_TAC[]);;
e (ASM_REAL_ARITH_TAC);;
e (ASM_REAL_ARITH_TAC);;
e (ASM_MESON_TAC[]);;

e (REWRITE_WITH `max c (--r) = c`);;
e (EXPAND_TAC "r");;
e (ASM_REAL_ARITH_TAC);;
e (REWRITE_WITH `
  (&2 / &3 * pi * (&1 - c) * r pow 3) / (&2 * pi) = (r - c) / &3 * r pow 3 *   
  ((&2 * pi) / (&2 * pi))`);;
e (EXPAND_TAC "r" THEN REAL_ARITH_TAC);;
e (REWRITE_WITH `(&2 * pi) / (&2 * pi) = &1`);;
e (MATCH_MP_TAC REAL_DIV_REFL);;
e (REWRITE_TAC[REAL_ENTIRE; PI_NZ; REAL_ARITH `~(&2 = &0)`]);;
e (REAL_ARITH_TAC);;
e (NEW_GOAL `F`);;
e (ASM_MESON_TAC[]);;
e (ASM_MESON_TAC[]);;

(* ========================================================================= *)

e (ASM_CASES_TAC `azim u0 u1 s3 (m:real^3) < pi`);;
e (UNDISCH_TAC `~coplanar {u0, u1, m, s3:real^3}`);;
e (ONCE_REWRITE_TAC[SET_RULE `{a,b,c,d} = {a,b,d,c}`]);;
e (STRIP_TAC);;
e (REWRITE_WITH `vol (L INTER C) = vol (C INTER wedge u0 u1 s3 m)`);;
e (ASM_SIMP_TAC[WEDGE_LUNE]);;
e (REWRITE_WITH `L INTER conic_cap (u0:real^3) u1 r c = 
                 conic_cap u0 u1 r c INTER L`);;
e (SET_TAC[]);;
e (MATCH_MP_TAC MEASURE_NEGLIGIBLE_SYMDIFF);;

e (REWRITE_WITH `conic_cap (u0:real^3) u1 r c INTER 
   aff_gt {u0, u1} {s3, m} DIFF conic_cap u0 u1 r c INTER L = {}`);;
e (EXPAND_TAC "L");;
e (REWRITE_TAC[SET_RULE `{a,b} = {b, a}`]);;
e (MATCH_MP_TAC (SET_RULE `A SUBSET B ==> C INTER A DIFF C INTER B = {}`));;
e (REWRITE_TAC[AFF_GT_SUBSET_AFF_GE]);;
e (REWRITE_TAC[SET_RULE `A UNION {} = A`]);;
e (EXPAND_TAC "L");;
e (REWRITE_TAC[SET_RULE `{a,b} = {b, a}`]);;

e (REWRITE_WITH `aff_ge {u0, u1:real^3} {m, s3} =
                 aff_gt {u0, u1} {m, s3} UNION 
   UNIONS {aff_ge {u0, u1} ({m, s3} DELETE a) | a | a IN  {m, s3}}`);;
e (MATCH_MP_TAC AFF_GE_AFF_GT_DECOMP);;
e (REWRITE_TAC[Geomdetail.FINITE6]);;
e (REWRITE_TAC[DISJOINT]);;

e (ASM_CASES_TAC `m IN {u0, u1:real^3}`);;
e (NEW_GOAL `F`);;
e (UNDISCH_TAC `~coplanar {u0, u1, s3, m:real^3}`);;
e (REWRITE_WITH `{u0, u1, s3, m} = {u0, u1, s3:real^3}`);;
e (UP_ASM_TAC THEN SET_TAC[]);;
e (REWRITE_TAC[COPLANAR_3]);;
e (ASM_MESON_TAC[]);;

e (ASM_CASES_TAC `s3 IN {u0, u1:real^3}`);;
e (NEW_GOAL `F`);;
e (UNDISCH_TAC `~coplanar {u0, u1, s3, m:real^3}`);;
e (REWRITE_WITH `{u0, u1, s3, m} = {u0, u1, m:real^3}`);;
e (UP_ASM_TAC THEN SET_TAC[]);;
e (REWRITE_TAC[COPLANAR_3]);;
e (ASM_MESON_TAC[]);;
e (UP_ASM_TAC THEN UP_ASM_TAC THEN SET_TAC[]);;

e (MATCH_MP_TAC NEGLIGIBLE_SUBSET);;
e (EXISTS_TAC 
  `UNIONS {aff_ge {u0, u1:real^3} ({m, s3} DELETE a) | a | a IN {m, s3}}`);;
e (STRIP_TAC);;
e (MATCH_MP_TAC NEGLIGIBLE_SUBSET);;
e (EXISTS_TAC 
  `aff_ge {u0, u1:real^3} {m} UNION aff_ge {u0, u1:real^3} {s3}`);;
e (STRIP_TAC);;
e (MATCH_MP_TAC NEGLIGIBLE_UNION);;
e (STRIP_TAC);;

e (MATCH_MP_TAC NEGLIGIBLE_SUBSET);;
e (EXISTS_TAC `affine hull {u0, u1:real^3, m}`);;
e (STRIP_TAC);;
e (REWRITE_TAC[NEGLIGIBLE_AFFINE_HULL_3]);;
e (REWRITE_WITH `{u0,u1,m:real^3} = {u0,u1} UNION {m}`);;
e (SET_TAC[]);;
e (REWRITE_TAC[AFF_GE_SUBSET_AFFINE_HULL]);;
e (MATCH_MP_TAC NEGLIGIBLE_SUBSET);;
e (EXISTS_TAC `affine hull {u0, u1:real^3, s3}`);;
e (STRIP_TAC);;
e (REWRITE_TAC[NEGLIGIBLE_AFFINE_HULL_3]);;
e (REWRITE_WITH `{u0,u1,s3:real^3} = {u0,u1} UNION {s3}`);;
e (SET_TAC[]);;
e (REWRITE_TAC[AFF_GE_SUBSET_AFFINE_HULL]);;
e (REWRITE_TAC[SET_RULE 
  `UNIONS {aff_ge {u0, u1} ({m, s3} DELETE a) | a | a IN {m, s3}} = 
         aff_ge {u0, u1} ({m, s3} DELETE s3) 
   UNION aff_ge {u0, u1} ({m, s3} DELETE m)`]);;
e (MATCH_MP_TAC (SET_RULE 
  `A SUBSET B /\ C SUBSET D ==> A UNION C SUBSET B UNION D`));;
e (STRIP_TAC);;
e (MATCH_MP_TAC AFF_GE_MONO_RIGHT);;
e (STRIP_TAC);;
e (SET_TAC[]);;

e (REWRITE_TAC[DISJOINT]);;
e (ASM_CASES_TAC `m IN {u0, u1:real^3}`);;
e (NEW_GOAL `F`);;
e (UNDISCH_TAC `~coplanar {u0, u1, s3, m:real^3}`);;
e (REWRITE_WITH `{u0, u1, s3, m} = {u0, u1, s3:real^3}`);;
e (UP_ASM_TAC THEN SET_TAC[]);;
e (REWRITE_TAC[COPLANAR_3]);;
e (ASM_MESON_TAC[]);;
e (UP_ASM_TAC THEN SET_TAC[]);;

e (MATCH_MP_TAC AFF_GE_MONO_RIGHT);;
e (STRIP_TAC);;
e (SET_TAC[]);;
e (REWRITE_TAC[DISJOINT]);;
e (ASM_CASES_TAC `s3 IN {u0, u1:real^3}`);;
e (NEW_GOAL `F`);;
e (UNDISCH_TAC `~coplanar {u0, u1, s3, m:real^3}`);;
e (REWRITE_WITH `{u0, u1, s3, m} = {u0, u1, m:real^3}`);;
e (UP_ASM_TAC THEN SET_TAC[]);;
e (REWRITE_TAC[COPLANAR_3]);;
e (ASM_MESON_TAC[]);;
e (UP_ASM_TAC THEN SET_TAC[]);;

e (SET_TAC[]);;

e (REWRITE_TAC[ASSUME `C = conic_cap (u0:real^3) u1 r c`]);;
e (REWRITE_WITH `vol (conic_cap u0 u1 r c INTER wedge u0 u1 s3 m) =
             (if &1 < c \/ r < &0
              then &0
              else azim u0 u1 s3 m / &3 * (&1 - max c (-- &1)) * r pow 3)`);;
e (NEW_GOAL `~collinear {u0:real^3, u1, m} /\ ~collinear {u0, u1, s3}`);;
e (STRIP_TAC);;
e (MATCH_MP_TAC NOT_COPLANAR_NOT_COLLINEAR);;
e (EXISTS_TAC `s3:real^3`);;
e (ONCE_REWRITE_TAC[SET_RULE `{a,b,c,d} = {a,b,d,c}`]);;
e (ASM_REWRITE_TAC[]);;
e (MATCH_MP_TAC NOT_COPLANAR_NOT_COLLINEAR);;
e (EXISTS_TAC `m:real^3`);;
e (ASM_REWRITE_TAC[]);;

e (ASM_SIMP_TAC[VOLUME_CONIC_CAP_WEDGE]);;
e (COND_CASES_TAC);;
e (NEW_GOAL `F`);;
e (ASM_REAL_ARITH_TAC);;
e (ASM_MESON_TAC[]);;

e (REWRITE_WITH `azim (u0:real^3) u1 s3 m = dihV u0 u1 s3 m`);;
e (MATCH_MP_TAC AZIM_DIHV_SAME);;
e (ASM_REWRITE_TAC[]);;
e (STRIP_TAC);;

e (MATCH_MP_TAC NOT_COPLANAR_NOT_COLLINEAR);;
e (EXISTS_TAC `m:real^3`);;
e (ASM_REWRITE_TAC[]);;
e (MATCH_MP_TAC NOT_COPLANAR_NOT_COLLINEAR);;
e (EXISTS_TAC `s3:real^3`);;
e (ONCE_REWRITE_TAC[SET_RULE `{a,b,c,d} = {a,b,d,c}`]);;
e (ASM_REWRITE_TAC[]);;

e (REWRITE_TAC[dihX]);;
e (COND_CASES_TAC);;
e (NEW_GOAL `F`);;
e (UNDISCH_TAC `~NULLSET (X INTER C)`);;
e (REWRITE_TAC[]);;
e (MATCH_MP_TAC NEGLIGIBLE_SUBSET);;
e (EXISTS_TAC `X:real^3->bool`);;
e (ASM_REWRITE_TAC[] THEN SET_TAC[]);;
e (ASM_MESON_TAC[]);;

e (LET_TAC);;

e (UP_ASM_TAC THEN REWRITE_TAC[cell_params_d]);;
e (ABBREV_TAC `P = (\(k, ul). k <= 4 /\
           ul IN barV V 3 /\
           X = mcell k V ul /\
           initial_sublist [u0; u1] ul)`);;
e (STRIP_TAC);;
e (NEW_GOAL `(P:num#(real^3)list->bool) ((@) P)`);;
e (MATCH_MP_TAC SELECT_AX);;
e (EXISTS_TAC `(2, vl:(real^3)list)`);;
e (EXPAND_TAC "P");;
e (REWRITE_TAC[BETA_THM]);;
e (REWRITE_TAC[IN; ARITH_RULE `2 <= 4`] THEN ASM_REWRITE_TAC[]);;
e (REWRITE_WITH `initial_sublist [u0;u1:real^3] vl /\ LENGTH [u0;u1] = 1 + 1`);;
e (REWRITE_TAC[GSYM Packing3.TRUNCATE_SIMPLEX_INITIAL_SUBLIST]);;
e (ASM_REWRITE_TAC[]);;

e (NEW_GOAL `?v0 v1 v2 v3. vl = [v0;v1;v2;v3:real^3]`);;
e (MATCH_MP_TAC Marchal_cells.BARV_3_EXPLICIT);;
e (EXISTS_TAC `V:real^3->bool` THEN ASM_REWRITE_TAC[]);;
e (UP_ASM_TAC THEN STRIP_TAC);;
e (ASM_REWRITE_TAC[LENGTH] THEN ARITH_TAC);;
e (UP_ASM_TAC THEN ASM_REWRITE_TAC[]);;
e (EXPAND_TAC "P" THEN REWRITE_TAC[IN] THEN REPEAT STRIP_TAC);;

e (NEW_GOAL `k' = 2 /\ mcell k' V ul = mcell 2 V vl`);;
e (MATCH_MP_TAC Ajripqn.AJRIPQN);;
e (ASM_REWRITE_TAC[]);;
e (REWRITE_WITH `mcell k' V ul INTER mcell 2 V vl = X`);;
e (ASM_SET_TAC[]);;
e (REPEAT STRIP_TAC);;
e (UNDISCH_TAC `k' <= 4` THEN REWRITE_TAC[ARITH_RULE 
   `a <= 4 <=> a = 0 \/a = 1 \/ a = 2 \/ a = 3 \/ a = 4`] THEN SET_TAC[]);;
e (SET_TAC[]);;
e (ASM_MESON_TAC[]);;

e (COND_CASES_TAC);;
e (REWRITE_TAC[dihu2]);;
e (REWRITE_WITH `omega_list_n V ul 3 = s3`);;
e (EXPAND_TAC "s3");;
e (NEW_GOAL `2  = 2 /\
             (!k. 2 - 1 <= k /\ k <= 3
                  ==> omega_list_n V ul k = omega_list_n V vl k)`);;
e (MATCH_MP_TAC MCELL_ID_OMEGA_LIST_N);;
e (ASM_REWRITE_TAC[SET_RULE `2 IN {2,3,4}`]);;
e (ASM_MESON_TAC[]);;
e (UP_ASM_TAC THEN STRIP_TAC);;
e (FIRST_ASSUM MATCH_MP_TAC);;
e (ARITH_TAC);;

e (REWRITE_WITH `mxi V ul = m`);;
e (EXPAND_TAC "m");;
e (MATCH_MP_TAC MCELL_ID_MXI);;
e (EXISTS_TAC `2` THEN EXISTS_TAC `2`);;
e (ASM_REWRITE_TAC[SET_RULE `2 IN {2,3}`]);;
e (STRIP_TAC);;

e (REWRITE_WITH `(HD vl):real^3 = HD (truncate_simplex 1 vl)`);;
e (ONCE_REWRITE_TAC[EQ_SYM_EQ]);;
e (MATCH_MP_TAC Packing3.HD_TRUNCATE_SIMPLEX);;
e (REWRITE_WITH `LENGTH (vl:(real^3)list) = 3 + 1 /\ 
                 CARD (set_of_list vl) = 3 + 1`);;
e (MATCH_MP_TAC Rogers.BARV_IMP_LENGTH_EQ_CARD);;
e (EXISTS_TAC `V:real^3->bool` THEN ASM_REWRITE_TAC[]);;
e (ARITH_TAC);;
e (ASM_REWRITE_TAC[HD]);;

e (REWRITE_WITH `(HD ul):real^3 = HD (truncate_simplex 1 ul)`);;
e (ONCE_REWRITE_TAC[EQ_SYM_EQ]);;
e (MATCH_MP_TAC Packing3.HD_TRUNCATE_SIMPLEX);;
e (REWRITE_WITH `LENGTH (ul:(real^3)list) = 3 + 1 /\ 
                 CARD (set_of_list ul) = 3 + 1`);;
e (MATCH_MP_TAC Rogers.BARV_IMP_LENGTH_EQ_CARD);;
e (EXISTS_TAC `V:real^3->bool` THEN ASM_REWRITE_TAC[]);;
e (ARITH_TAC);;

e (REWRITE_WITH `truncate_simplex 1 ul = [u0;u1:real^3] /\ 1 + 1 <= LENGTH ul`);;
e (REWRITE_TAC[Packing3.TRUNCATE_SIMPLEX_INITIAL_SUBLIST]);;
e (ASM_REWRITE_TAC[LENGTH] THEN ARITH_TAC);;
e (REWRITE_TAC[HD]);;
e (ASM_MESON_TAC[]);;
e (NEW_GOAL `initial_sublist [u0; u1:real^3] ul /\ LENGTH [u0; u1] = 1 + 1`);;
e (ASM_REWRITE_TAC[LENGTH] THEN ARITH_TAC);;
e (NEW_GOAL `truncate_simplex 1 ul = [u0;u1:real^3] /\ 1 + 1 <= LENGTH ul`);;
e (REWRITE_TAC[Packing3.TRUNCATE_SIMPLEX_INITIAL_SUBLIST]);;
e (ASM_REWRITE_TAC[]);;

e (REWRITE_WITH `EL 0 (ul:(real^3)list) = EL 0 (truncate_simplex 1 ul)`);;
e (ONCE_REWRITE_TAC[EQ_SYM_EQ]);;
e (MATCH_MP_TAC Packing3.EL_TRUNCATE_SIMPLEX);;
e (REWRITE_WITH `LENGTH (ul:(real^3)list) = 3 + 1 /\ 
                 CARD (set_of_list ul) = 3 + 1`);;
e (MATCH_MP_TAC Rogers.BARV_IMP_LENGTH_EQ_CARD);;
e (EXISTS_TAC `V:real^3->bool` THEN ASM_REWRITE_TAC[]);;
e (ARITH_TAC);;

e (REWRITE_WITH `EL 1 (ul:(real^3)list) = EL 1 (truncate_simplex 1 ul)`);;
e (ONCE_REWRITE_TAC[EQ_SYM_EQ]);;
e (MATCH_MP_TAC Packing3.EL_TRUNCATE_SIMPLEX);;
e (REWRITE_WITH `LENGTH (ul:(real^3)list) = 3 + 1 /\ 
                 CARD (set_of_list ul) = 3 + 1`);;
e (MATCH_MP_TAC Rogers.BARV_IMP_LENGTH_EQ_CARD);;
e (EXISTS_TAC `V:real^3->bool` THEN ASM_REWRITE_TAC[]);;
e (ARITH_TAC);;
e (ASM_REWRITE_TAC[EL; HD; ARITH_RULE `1 = SUC 0`; TL]);;
e (REWRITE_TAC[DIHV_SYM_2]);;

e (REWRITE_TAC[REAL_ARITH `a / b * c * d pow 3 = (c/ b * d pow 3) * a`]);;
e (REWRITE_TAC[REAL_ARITH `a * b / (&2 * c) = (a / (&2 * c)) * b`]);;
e (AP_THM_TAC THEN AP_TERM_TAC);;
e (REWRITE_WITH 
  `measurable (conic_cap u0 u1 r c) /\
             vol (conic_cap u0 u1 r c) =
             (if u1 = u0 \/ &1 <= c \/ r < &0
              then &0
              else &2 / &3 * pi * (&1 - c) * r pow 3)`);;
e (MATCH_MP_TAC VOLUME_CONIC_CAP);;
e (ASM_REWRITE_TAC[]);;
e (COND_CASES_TAC);;
e (NEW_GOAL `F`);;
e (UP_ASM_TAC THEN STRIP_TAC);;
e (ASM_MESON_TAC[]);;
e (ASM_REAL_ARITH_TAC);;
e (ASM_REAL_ARITH_TAC);;
e (ASM_MESON_TAC[]);;

e (REWRITE_WITH `max c (--r) = c`);;
e (EXPAND_TAC "r");;
e (ASM_REAL_ARITH_TAC);;
e (REWRITE_WITH `
  (&2 / &3 * pi * (&1 - c) * r pow 3) / (&2 * pi) = (r - c) / &3 * r pow 3 *   
  ((&2 * pi) / (&2 * pi))`);;
e (EXPAND_TAC "r" THEN REAL_ARITH_TAC);;
e (REWRITE_WITH `(&2 * pi) / (&2 * pi) = &1`);;
e (MATCH_MP_TAC REAL_DIV_REFL);;
e (REWRITE_TAC[REAL_ENTIRE; PI_NZ; REAL_ARITH `~(&2 = &0)`]);;
e (REAL_ARITH_TAC);;
e (NEW_GOAL `F`);;
e (ASM_MESON_TAC[]);;
e (ASM_MESON_TAC[]);;

(* ========================================================================== *)

e (NEW_GOAL `F`);;
e (NEW_GOAL `azim (u0:real^3) u1 s3 m = 
  (if azim u0 u1 m s3 = &0 then &0 else &2 * pi - azim u0 u1 m s3)`);;
e (MATCH_MP_TAC AZIM_COMPL);;
e (STRIP_TAC);;

e (MATCH_MP_TAC NOT_COPLANAR_NOT_COLLINEAR);;
e (EXISTS_TAC `s3:real^3`);;
e (ASM_REWRITE_TAC[]);;
e (MATCH_MP_TAC NOT_COPLANAR_NOT_COLLINEAR);;
e (EXISTS_TAC `m:real^3`);;
e (ONCE_REWRITE_TAC[SET_RULE `{a,b,c,d} = {a,b, d, c}`]);;
e (ASM_REWRITE_TAC[]);;
e (UP_ASM_TAC THEN COND_CASES_TAC);;
e (NEW_GOAL `F`);;
e (NEW_GOAL `(&0 < pi)`);;
e (REWRITE_TAC[PI_POS]);;
e (ASM_REAL_ARITH_TAC);;
e (ASM_MESON_TAC[]);;
e (STRIP_TAC);;

e (NEW_GOAL `azim (u0:real^3) u1 m s3 = pi`);;
e (ASM_REAL_ARITH_TAC);;
e (UNDISCH_TAC `~coplanar {u0, u1, m, s3:real^3}`);;
e (REWRITE_TAC[] THEN MATCH_MP_TAC AZIM_EQ_0_PI_IMP_COPLANAR);;
e (ASM_REWRITE_TAC[]);;
e (ASM_MESON_TAC[]);;





