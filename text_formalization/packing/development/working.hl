let TSKAJXY = prove (TSKAJXY_concl, KY_CHEAT_TAC);;
let OXLZLEZ = prove (OXLZLEZ_concl, KY_CHEAT_TAC);;
(* ======================================================================== *)
let KY_CHEAT_TAC = MP_TAC (mk_fthm([],`F`)) THEN MESON_TAC[];;

let SUM_GAMMAX_LMFUN_ESTIMATE_concl = 
  `!V. ?c. !r. saturated V /\ packing V /\ &1 <= r /\ 
               cell_cluster_estimate V /\ marchal_inequality /\
               lmfun_inequality V ==> 
    c * r pow 2 <=  sum {X | X SUBSET ball (vec 0, r)  /\ mcell_set V X} 
    (\X. gammaX V X lmfun)`;;

let TSKAJXY_concl = 
`!V X. saturated V /\ packing V /\ mcell_set V X /\ critical_edgeX V X  = {} 
   ==> gammaX V X lmfun >= &0`;;

let SUM_BETA_BUMP_LEMMA = prove_by_refinement (
 `!V X. saturated V /\ packing V /\ mcell_set V X ==> 
         sum {e | e IN critical_edgeX V X } (\e. beta_bump V e X) = &0`,
[KY_CHEAT_TAC]);;

let TSKAJXY = prove (TSKAJXY_concl, KY_CHEAT_TAC);;
let OXLZLEZ = prove (OXLZLEZ_concl, KY_CHEAT_TAC);;

let BOUND_GAMMA_X_lmfun = prove (
`?c. 
  (!V X. packing V /\ saturated V /\ mcell_set V X ==> gammaX V X lmfun <= c)`,
  KY_CHEAT_TAC);;

(* ========================================================================= *)
(* ========================================================================= *)

g SUM_GAMMAX_LMFUN_ESTIMATE_concl;;
e (GEN_TAC);;

(* ================== Choose some constants ===================== *)
e (NEW_GOAL `?cc1. (&1 <= cc1) /\ (!V X.
             packing V /\ saturated V /\ mcell_set V X
             ==> gammaX V X lmfun <= cc1)`);;
e (MP_TAC BOUND_GAMMA_X_lmfun THEN STRIP_TAC);;
e (EXISTS_TAC `max (c:real) (&1)`);;
e (STRIP_TAC);;
e (REAL_ARITH_TAC);;
e (REPEAT STRIP_TAC);;
e (NEW_GOAL `gammaX V X lmfun <= c`);;
e (ASM_MESON_TAC[]);;
e (ASM_REAL_ARITH_TAC);;
e (UP_ASM_TAC THEN STRIP_TAC);;

e (NEW_GOAL `?cc2. !V u0.
             saturated V /\ packing V /\ u0 IN V
             ==> & (CARD {X | mcell_set V X /\ VX V X u0}) <= cc2`);;

e (MP_TAC CARD_MCELL_CONTAINS_POINT_klemma);;
e (STRIP_TAC);;
e (EXISTS_TAC `&c:real` THEN ASM_REWRITE_TAC[REAL_OF_NUM_LE]);;
e (UP_ASM_TAC THEN STRIP_TAC);;

e (ASM_CASES_TAC `saturated V /\ packing V`);;
e (EXISTS_TAC `c:real`);;

(* ================== Choose some constants ===================== *)

e (REPEAT STRIP_TAC);;
e (NEW_GOAL `!X. mcell_set V X /\ critical_edgeX V X  = {} ==> 
                 gammaX V X lmfun >= &0`);;
e (ASM_MESON_TAC[TSKAJXY]);;
e (ABBREV_TAC `B = {X | X SUBSET ball (vec 0, r)  /\ mcell_set V X}`);;
e (ABBREV_TAC `B0 = {X | X SUBSET ball (vec 0,r) /\ mcell_set V X /\
                         critical_edgeX V X = {}}`);;
e (ABBREV_TAC `B1 = {X | X SUBSET ball (vec 0,r) /\ mcell_set V X /\
                         ~(critical_edgeX V X = {})}`);;
e (NEW_GOAL `FINITE (B1:(real^3->bool)->bool)`);;
e (EXPAND_TAC "B1");;
e (MATCH_MP_TAC FINITE_SUBSET);;
e (EXISTS_TAC `{X | X SUBSET ball (vec 0,r) /\ mcell_set V X}`);;
e (STRIP_TAC);;
e (ASM_SIMP_TAC[FINITE_MCELL_SET_LEMMA]);;
e (SET_TAC[]);;

e (REWRITE_WITH `B = B0 UNION B1:(real^3->bool)->bool`);;
e (EXPAND_TAC "B" THEN EXPAND_TAC "B1" THEN EXPAND_TAC "B0");;
e (SET_TAC[]);;
e (REWRITE_WITH `sum (B0 UNION B1) (\X. gammaX V X lmfun) = 
   sum B0 (\X. gammaX V X lmfun) + sum B1 (\X. gammaX V X lmfun)`);;
e (MATCH_MP_TAC SUM_UNION);;
e (REPEAT STRIP_TAC);;
e (EXPAND_TAC "B0");;
e (MATCH_MP_TAC FINITE_SUBSET);;
e (EXISTS_TAC `{X | X SUBSET ball (vec 0,r) /\ mcell_set V X}`);;
e (STRIP_TAC);;
e (ASM_SIMP_TAC[FINITE_MCELL_SET_LEMMA]);;
e (SET_TAC[]);;
e (ASM_REWRITE_TAC[]);;
e (EXPAND_TAC "B1" THEN EXPAND_TAC "B0");;
e (SET_TAC[]);;
e (MATCH_MP_TAC (REAL_ARITH `&0 <= b /\ a <= c ==> a <= b + c`));;
e (STRIP_TAC);;
e (MATCH_MP_TAC SUM_POS_LE);;
e (STRIP_TAC);;
e (EXPAND_TAC "B0");;
e (MATCH_MP_TAC FINITE_SUBSET);;
e (EXISTS_TAC `{X | X SUBSET ball (vec 0,r) /\ mcell_set V X}`);;
e (STRIP_TAC);;
e (ASM_SIMP_TAC[FINITE_MCELL_SET_LEMMA]);;
e (SET_TAC[]);;
e (REWRITE_TAC[BETA_THM; REAL_ARITH `&0 <= a <=> a >= &0`]);;
e (EXPAND_TAC "B0" THEN REWRITE_TAC[IN; IN_ELIM_THM]);;
e (REPEAT STRIP_TAC);;
e (ASM_SIMP_TAC[]);;

e (REWRITE_WITH 
  `sum B1 (\X. gammaX V X lmfun) = 
   sum B1 (\X. (gammaX V X lmfun) * 
                sum (critical_edgeX V X) (\e. critical_weight V X))`);;
e (MATCH_MP_TAC SUM_EQ);;
e (EXPAND_TAC "B1" THEN REWRITE_TAC[IN; IN_ELIM_THM]);;
e (REPEAT STRIP_TAC);;
e (REWRITE_TAC[critical_weight]);;
e (REWRITE_WITH 
  `sum (critical_edgeX V x) (\e. &1 / &(CARD (critical_edgeX V x))) = 
   &(CARD (critical_edgeX V x)) * (&1 / &(CARD (critical_edgeX V x)))`);;
e (MATCH_MP_TAC SUM_CONST);;
e (REWRITE_TAC[FINITE_critical_edgeX]);;
e (REWRITE_TAC[REAL_ARITH `a * &1 / a = a / a`]);;
e (REWRITE_WITH `&(CARD (critical_edgeX V x)) / &(CARD (critical_edgeX V x)) = &1`);;
e (MATCH_MP_TAC REAL_DIV_REFL);;
e (REWRITE_TAC[REAL_OF_NUM_EQ]);;
e (REWRITE_WITH `CARD (critical_edgeX V x) = 0 <=> critical_edgeX V x = {}`);;
e (MATCH_MP_TAC CARD_EQ_0);;
e (REWRITE_TAC[FINITE_critical_edgeX]);;
e (ASM_REWRITE_TAC[]);;
e (REAL_ARITH_TAC);;

(* ------------------------------------------------------------------------- *)
(* Hint:      - See proofs of KIZHLTL1; KIZHLTL2 to adapt                    *)
(* ------------------------------------------------------------------------- *)

e (REWRITE_TAC[GSYM SUM_LMUL]);;

e (ABBREV_TAC `T1:real^3->bool = V INTER ball (vec 0, r)`);;
e (ABBREV_TAC `T2 = {{u0, u1:real^3} | u0 IN T1 /\ u1 IN T1 /\ ~(u0 = u1) /\   
                                       hl [u0; u1] <= hplus}`);;
e (NEW_GOAL `FINITE (T2:(real^3->bool)->bool)`);;
e (EXPAND_TAC "T2" THEN MATCH_MP_TAC FINITE_SUBSET);;
e (EXISTS_TAC `{{u0, u1:real^3} | u0 IN T1 /\ u1 IN T1}`);;
e (STRIP_TAC);;
e (MATCH_MP_TAC FINITE_SET_PRODUCT_KY_LEMMA);;
e (EXPAND_TAC "T1" THEN MATCH_MP_TAC Pack2.KIUMVTC);;
e (ASM_REWRITE_TAC[]);;
e (SET_TAC[]);;

e (REWRITE_WITH 
 `sum B1 (\X. sum (critical_edgeX V X) 
                   (\x. gammaX V X lmfun * critical_weight V X)) =
  sum B1 (\X. sum {y:real^3->bool| y IN T2 /\ critical_edgeX V X y} 
                   (\x. gammaX V X lmfun * critical_weight V X))`);;
e (MATCH_MP_TAC SUM_EQ);;
e (EXPAND_TAC "B1" THEN REWRITE_TAC[IN; IN_ELIM_THM]);;
e (REPEAT STRIP_TAC);;
e (AP_THM_TAC THEN AP_TERM_TAC);;
e (REWRITE_TAC[SET_RULE `a = b <=> b SUBSET a /\ a SUBSET b`]);;
e (STRIP_TAC);;
e (SET_TAC[]);;
e (REWRITE_TAC[SET_RULE `A SUBSET {y | T2 y /\ A y} <=> A SUBSET T2`]);;
e (EXPAND_TAC "T2" THEN REWRITE_TAC[SUBSET; critical_edgeX; IN; IN_ELIM_THM; edgeX]);;
e (REPEAT STRIP_TAC);;
e (EXPAND_TAC "T1" THEN REWRITE_TAC[IN_ELIM_THM]);;
e (EXISTS_TAC `u':real^3` THEN EXISTS_TAC `v':real^3`);;
e (REWRITE_TAC[ASSUME `~(u' = v':real^3)`]);;

e (REWRITE_TAC[ASSUME `x' = {u, v:real^3}`; MESON[IN] `V (x:real^3) <=> x IN V`;
               GSYM (ASSUME `{u, v} = {u', v':real^3}`); IN_INTER]);;

e (NEW_GOAL `VX V x = V INTER x`);;
e (MATCH_MP_TAC Hdtfnfz.HDTFNFZ);;
e (UNDISCH_TAC `mcell_set V x` THEN REWRITE_TAC[mcell_set; IN; IN_ELIM_THM]);;
e (STRIP_TAC);;
e (EXISTS_TAC `ul:(real^3)list` THEN EXISTS_TAC `i:num`);;
e (ASM_REWRITE_TAC[]);;
e (STRIP_TAC);;
e (NEW_GOAL `VX V x = {}`);;
e (REWRITE_TAC[VX]);;
e (ASM_REWRITE_TAC[]);;
e (UNDISCH_TAC `VX V x u'` THEN ASM_REWRITE_TAC[MESON[IN] `{} x <=> x IN {}`]);;
e (SET_TAC[]);;

e (STRIP_TAC);;
e (ASM_SET_TAC[]);;
e (STRIP_TAC);;
e (ASM_SET_TAC[]);;
e (REWRITE_WITH `hl [u'; v':real^3] = hl [u; v:real^3]`);;
e (ASM_REWRITE_TAC[HL; set_of_list]);;
e (ASM_REWRITE_TAC[]);;

e (ABBREV_TAC `f = (\X. (\x:real^3->bool. 
                            gammaX V X lmfun * critical_weight V X))`);;
e (REWRITE_WITH 
 `sum B1 (\X. sum {y | y IN T2 /\ critical_edgeX V X y}
                  (\x:real^3->bool. gammaX V X lmfun * critical_weight V X)) = 
  sum B1 (\X. sum {y | y IN T2 /\ critical_edgeX V X y}
                  (\x:real^3->bool. f X x))`);;
e (EXPAND_TAC "f" THEN REFL_TAC);;
e (REWRITE_WITH 
  `sum B1 (\X. sum {y | y IN T2 /\ critical_edgeX V X y} (\x. f X x)) = 
   sum T2 (\x. sum {X | X IN B1 /\ critical_edgeX V X x} (\X. f X x))`);;
e (ASM_SIMP_TAC[SUM_SUM_RESTRICT]);;

e (EXPAND_TAC "B1" THEN REWRITE_TAC[IN; IN_ELIM_THM]);;
e (REWRITE_TAC[MESON[] `(A/\B/\C)/\D <=> A/\B/\C/\D`]);;
e (REWRITE_WITH 
`sum T2 (\x. sum
               {X | X SUBSET ball (vec 0,r) /\ mcell_set V X /\
                   ~(critical_edgeX V X = {}) /\ critical_edgeX V X x}
        (\X. f X x)) = 
 sum T2  (\x. sum {X | mcell_set V X /\
                     ~(critical_edgeX V X = {}) /\ critical_edgeX V X x}
      (\X. f X x)) - 
sum T2  (\x. sum {X | ~(X SUBSET ball (vec 0,r)) /\ mcell_set V X /\
                      ~(critical_edgeX V X = {}) /\ critical_edgeX V X x}
      (\X. f X x))`);;
e (REWRITE_TAC[REAL_ARITH `a = b - c <=> b = a + c`]);;
e (REWRITE_WITH 
` sum T2
 (\x. sum
      {X | X SUBSET ball (vec 0,r) /\ mcell_set V X /\
           ~(critical_edgeX V X = {}) /\ critical_edgeX V X x}
      (\X. f X x)) +
 sum T2
 (\x. sum
      {X | ~(X SUBSET ball (vec 0,r)) /\ mcell_set V X /\
           ~(critical_edgeX V X = {}) /\ critical_edgeX V X x}
      (\X. f X x)) = 
 sum T2 
 (\x. (\x. sum
      {X | X SUBSET ball (vec 0,r) /\ mcell_set V X /\
           ~(critical_edgeX V X = {}) /\ critical_edgeX V X x}
      (\X. f X x)) x + 
(\x. sum
      {X | ~(X SUBSET ball (vec 0,r)) /\ mcell_set V X /\
           ~(critical_edgeX V X = {}) /\ critical_edgeX V X x}
      (\X. f X x)) x)`);;
e (ONCE_REWRITE_TAC[EQ_SYM_EQ]);;
e (MATCH_MP_TAC SUM_ADD);;
e (ASM_REWRITE_TAC[]);;
e (MATCH_MP_TAC SUM_EQ);;
e (REWRITE_TAC[BETA_THM] THEN REPEAT STRIP_TAC);;

e (REWRITE_WITH 
`sum
 {X | X SUBSET ball (vec 0,r) /\
      mcell_set V X /\
      ~(critical_edgeX V X = {}) /\
      critical_edgeX V X x}
 (\X. f X x) +
 sum
 {X | ~(X SUBSET ball (vec 0,r)) /\
      mcell_set V X /\
      ~(critical_edgeX V X = {}) /\
      critical_edgeX V X x}
 (\X. f X x) = 
 sum ({X | X SUBSET ball (vec 0,r) /\
      mcell_set V X /\
      ~(critical_edgeX V X = {}) /\
      critical_edgeX V X x} UNION 
      {X | ~(X SUBSET ball (vec 0,r)) /\
      mcell_set V X /\
      ~(critical_edgeX V X = {}) /\
      critical_edgeX V X x}) 
 (\X. f X x)`);;
e (ONCE_REWRITE_TAC[EQ_SYM_EQ]);;
e (MATCH_MP_TAC SUM_UNION);;
e (REPEAT STRIP_TAC);;

e (MATCH_MP_TAC FINITE_SUBSET);;
e (EXISTS_TAC `B1:(real^3->bool)->bool`);;
e (ASM_REWRITE_TAC[]);;
e (EXPAND_TAC "B1" THEN SET_TAC[]);;

e (UP_ASM_TAC THEN EXPAND_TAC "T2");;
e (REWRITE_TAC[IN; IN_ELIM_THM] THEN REPEAT STRIP_TAC);;
e (MATCH_MP_TAC FINITE_SUBSET);;
e (EXISTS_TAC `{X | X SUBSET ball (vec 0,r + &8) /\ mcell_set V X}`);;
e (STRIP_TAC);;
e (ASM_SIMP_TAC[Marchal_cells_3.FINITE_MCELL_SET_LEMMA]);;
e (REWRITE_TAC[SUBSET; IN; IN_ELIM_THM]);;
e (REPEAT STRIP_TAC);;
e (NEW_GOAL `x SUBSET VX V x'`);;
e (UNDISCH_TAC `critical_edgeX V x' x` THEN REWRITE_TAC[critical_edgeX;edgeX]);;
e (REWRITE_TAC[IN_ELIM_THM]);;
e (REPEAT STRIP_TAC);;
e (REWRITE_TAC[ASSUME `x = {u, v:real^3}`; ASSUME `{u, v:real^3} = {u', v'}`]);;
e (SET_TAC[ASSUME `VX V x' u'`; ASSUME `VX V x' v'`]);;
e (NEW_GOAL `VX V x' = V INTER x'`);;
e (MATCH_MP_TAC Hdtfnfz.HDTFNFZ);;
e (UNDISCH_TAC `mcell_set V x'` THEN REWRITE_TAC[mcell_set; IN_ELIM_THM; IN]);;
e (REPEAT STRIP_TAC);;
e (EXISTS_TAC `ul:(real^3)list` THEN EXISTS_TAC `i:num`);;
e (ASM_REWRITE_TAC[]);;
e (STRIP_TAC);;
e (NEW_GOAL `VX V x' = {}`);;
e (ASM_REWRITE_TAC[VX]);;
e (UNDISCH_TAC `x SUBSET VX V x'` THEN REWRITE_TAC[ASSUME `VX V x' = {}`]);;
e (REWRITE_TAC[ASSUME `x = {u0, u1:real^3}`] THEN SET_TAC[]);;
e (REWRITE_TAC[MESON[IN] `(A:real^3->bool) x <=> x IN A`; IN_BALL]);;
e (NEW_GOAL `dist (vec 0, x'') <= dist (vec 0, u0:real^3) + dist (u0, x'')`);;
e (NORM_ARITH_TAC);;
e (NEW_GOAL `dist (vec 0, u0:real^3) < r`);;
e (REWRITE_TAC[GSYM IN_BALL]);;
e (UNDISCH_TAC `(T1:real^3->bool) u0` THEN EXPAND_TAC "T1");;
e (REWRITE_TAC[MESON[IN] `(A:real^3->bool) x <=> x IN A`] THEN SET_TAC[]);;
e (NEW_GOAL `dist (u0, x'':real^3) < &8`);;
e (REWRITE_TAC[GSYM IN_BALL]);;
e (NEW_GOAL `x' SUBSET ball (u0:real^3,&8)`);;
e (UNDISCH_TAC `mcell_set V x'` THEN REWRITE_TAC[mcell_set; IN_ELIM_THM; IN]);;
e (REPEAT STRIP_TAC);;
e (ASM_REWRITE_TAC[]);;
e (MATCH_MP_TAC MCELL_SUBSET_BALL8);;
e (ASM_REWRITE_TAC[]);;
e (REWRITE_TAC[GSYM (ASSUME `x' = mcell i V ul`)]);;
e (UNDISCH_TAC `x SUBSET VX V x'` THEN UNDISCH_TAC `VX V x' = V INTER x'`);;
e (ASM_REWRITE_TAC[]);;
e (SET_TAC[]);;
e (SUBGOAL_THEN `(x'':real^3) IN x'` MP_TAC);;
e (UNDISCH_TAC `(x':real^3->bool) x''` THEN SET_TAC[]);;
e (UP_ASM_TAC THEN SET_TAC[]);;
e (ASM_REAL_ARITH_TAC);;
e (ASM_REWRITE_TAC[]);;
e (SET_TAC[]);;

e (REWRITE_WITH ` ({X | X SUBSET ball (vec 0,r) /\
       mcell_set V X /\
       ~(critical_edgeX V X = {}) /\
       critical_edgeX V X x} UNION
  {X | ~(X SUBSET ball (vec 0,r)) /\
       mcell_set V X /\
       ~(critical_edgeX V X = {}) /\
       critical_edgeX V X x}) = 
 {X | mcell_set V X /\ ~(critical_edgeX V X = {}) /\ critical_edgeX V X x}`);;
e (SET_TAC[]);;
e (REWRITE_WITH 
  `(\x. sum
      {X | mcell_set V X /\
           ~(critical_edgeX V X = {}) /\ critical_edgeX V X x} (\X. f X x)) = 
    (\x. sum
      {X | mcell_set V X /\ critical_edgeX V X x} (\X. f X x))`);;
e (REWRITE_TAC[FUN_EQ_THM]);;
e (STRIP_TAC);;
e (REWRITE_WITH 
`{X | mcell_set V X /\
      ~(!x. critical_edgeX V X x <=> {} x) /\ critical_edgeX V X x} = 
 {X | mcell_set V X /\ critical_edgeX V X x}`);;
e (REWRITE_TAC[SET_RULE `A = B <=> A SUBSET B /\ B SUBSET A`]);;
e (STRIP_TAC);;
e (SET_TAC[]);;
e (REWRITE_TAC[SUBSET; IN; IN_ELIM_THM] THEN REPEAT STRIP_TAC);;
e (ASM_REWRITE_TAC[]);;
e (SWITCH_TAC THEN UP_ASM_TAC THEN ASM_REWRITE_TAC[]);;
e (REWRITE_TAC[MESON[IN] `(A:(real^3->bool)->bool) x <=> x IN A`]);;
e (SET_TAC[]);;
e (ASM_REWRITE_TAC[]);;

e (REWRITE_WITH 
  ` (\x. sum
      {X | ~(X SUBSET ball (vec 0,r)) /\ mcell_set V X /\
           ~(critical_edgeX V X = {}) /\ critical_edgeX V X x} (\X. f X x)) = 
     (\x. sum
      {X | ~(X SUBSET ball (vec 0,r)) /\ mcell_set V X /\
           critical_edgeX V X x} (\X. f X x))`);;
e (REWRITE_TAC[FUN_EQ_THM]);;
e (STRIP_TAC);;
e (REWRITE_WITH 
`{X | ~(X SUBSET ball (vec 0,r)) /\ mcell_set V X /\
      ~(!x. critical_edgeX V X x <=> {} x) /\ critical_edgeX V X x} = 
 {X | ~(X SUBSET ball (vec 0,r)) /\ mcell_set V X /\ critical_edgeX V X x}`);;
e (REWRITE_TAC[SET_RULE `A = B <=> A SUBSET B /\ B SUBSET A`]);;
e (STRIP_TAC);;
e (SET_TAC[]);;
e (REWRITE_TAC[SUBSET; IN; IN_ELIM_THM]);;
e (GEN_TAC THEN DISCH_TAC);;
e (ASM_REWRITE_TAC[]);;
e (UP_ASM_TAC THEN REPEAT STRIP_TAC);;
e (SWITCH_TAC THEN UP_ASM_TAC THEN ASM_REWRITE_TAC[]);;
e (REWRITE_TAC[MESON[IN] `(A:(real^3->bool)->bool) x <=> x IN A`]);;
e (SET_TAC[]);;

(* OK here *)


e (MATCH_MP_TAC (REAL_ARITH `(?x. c <= x /\ a + x <= b) ==> a <= b - c`));;
e (EXISTS_TAC `d * r pow 2`);; (* Chon d sau *)
e (STRIP_TAC);;

e (ABBREV_TAC 
   `T3:real^3->bool = V INTER ball (vec 0, r) DIFF ball (vec 0, r - &8)`);;
e (ABBREV_TAC `T4 = {{u0:real^3, u1} | u0 IN T3 /\ u1 IN T3 /\ 
                                      ~(u0 = u1) /\ hl [u0; u1] <= hplus}`);;
e (REWRITE_WITH `sum T2
 (\x. sum
      {X | ~(X SUBSET ball (vec 0,r)) /\
           mcell_set V X /\
           critical_edgeX V X x}
      (\X. f X x)) =  sum T4
 (\x. sum
      {X | ~(X SUBSET ball (vec 0,r)) /\
           mcell_set V X /\
           critical_edgeX V X x}
      (\X. f X x))`);;
 
e (EXPAND_TAC "T2");;
e (MATCH_MP_TAC SUM_SUPERSET);;
e (STRIP_TAC);;
e (EXPAND_TAC "T4" THEN EXPAND_TAC "T1" THEN EXPAND_TAC "T3" THEN SET_TAC[]);;

e (REWRITE_TAC[IN; IN_ELIM_THM] THEN REPEAT STRIP_TAC);;
e (REWRITE_WITH 
  `{X | ~(X SUBSET ball (vec 0,r)) /\ mcell_set V X /\ critical_edgeX V X x} =
   {}`);;
e (REWRITE_TAC[SET_RULE `x = {} <=> ~(?s. s IN x)`]);;
e (REWRITE_TAC[IN; IN_ELIM_THM] THEN STRIP_TAC);;

e (NEW_GOAL `(x:real^3->bool) SUBSET s`);;
e (MATCH_MP_TAC CRITICAL_EDGEX_SUBSET_MCELL);;
e (EXISTS_TAC `V:real^3->bool` THEN ASM_REWRITE_TAC[]);;

e (NEW_GOAL `?p:real^3. p IN s DIFF ball (vec 0,r)`);;
e (UNDISCH_TAC `~(s SUBSET ball ((vec 0):real^3,r))` THEN SET_TAC[]);;
e (UP_ASM_TAC THEN STRIP_TAC);;
e (UP_ASM_TAC THEN REWRITE_TAC[IN_DIFF; IN_BALL; REAL_ARITH 
   `~(a < r) <=> r <= a`] THEN STRIP_TAC);;
e (NEW_GOAL `s SUBSET ball (p:real^3,&8)`);;
e (MATCH_MP_TAC MCELL_SUBSET_BALL8_2);;
e (EXISTS_TAC `V:real^3->bool`);;
e (ASM_REWRITE_TAC[]);;
e (NEW_GOAL `u0:real^3 IN ball (p,&8) /\ u1 IN ball (p,&8)`);;
e (ASM_SET_TAC[]);;
e (UP_ASM_TAC THEN REWRITE_TAC[IN_BALL] THEN STRIP_TAC);;
e (UNDISCH_TAC `~(T4:(real^3->bool)->bool) x`);;
e (REWRITE_TAC[MESON[IN] `(T4:(real^3->bool)->bool) x <=> x IN T4`]);;
e (EXPAND_TAC "T4" THEN EXPAND_TAC "T3" THEN REWRITE_TAC[IN_INTER; IN_DIFF; IN_BALL]);;
e (REWRITE_TAC[IN; IN_ELIM_THM]);;
e (EXISTS_TAC `u0:real^3` THEN EXISTS_TAC `u1:real^3` THEN ASM_REWRITE_TAC[]);;
e (UNDISCH_TAC `(T1:(real^3->bool)) u0` THEN 
   UNDISCH_TAC `(T1:(real^3->bool)) u1`);;
e (REWRITE_WITH `!x. T1 x <=> x:real^3 IN T1`);;
e (ASM_REWRITE_TAC[IN]);;
e (EXPAND_TAC "T1" THEN REWRITE_TAC[IN_INTER; IN_BALL]);;
e (REWRITE_TAC[IN] THEN REPEAT STRIP_TAC THEN ASM_REWRITE_TAC[]);;
e (NEW_GOAL `dist (vec 0,p) <= dist (p, u0) + dist (vec 0, u0:real^3)`);;
e (NORM_ARITH_TAC);;
e (ASM_REAL_ARITH_TAC);;
e (NEW_GOAL `dist (vec 0,p) <= dist (p, u1) + dist (vec 0, u1:real^3)`);;
e (NORM_ARITH_TAC);;
e (ASM_REAL_ARITH_TAC);;
e (REWRITE_TAC[SUM_CLAUSES]);;

e (MATCH_MP_TAC (REAL_ARITH `(?x. a <= x /\ x <= b) ==> a <= b`));;
e (EXISTS_TAC `sum T4 (\x:real^3->bool. cc2 * cc1)`);;
e (STRIP_TAC);;
e (MATCH_MP_TAC SUM_LE);;
e (STRIP_TAC);;
e (MATCH_MP_TAC FINITE_SUBSET);;
e (EXISTS_TAC `{{u0:real^3, u1} | u0 IN T3 /\ u1 IN T3}`);;
e (STRIP_TAC);;
e (MATCH_MP_TAC FINITE_SUBSET);;
e (ABBREV_TAC `S_temp = {u0, u1:real^3 | u0 IN T3 /\ u1 IN T3}`);;
e (ABBREV_TAC `f_temp = (\(u0,u1:real^3). {u0, u1})`);;
e (EXISTS_TAC `IMAGE (f_temp:real^3#real^3->real^3->bool) S_temp`);;
e (STRIP_TAC);;
e (MATCH_MP_TAC FINITE_IMAGE);;
e (EXPAND_TAC "S_temp" THEN MATCH_MP_TAC FINITE_PRODUCT THEN REWRITE_TAC[]);;
e (MATCH_MP_TAC FINITE_SUBSET);;
e (EXISTS_TAC `T1:real^3->bool`);;
e (STRIP_TAC);;
e (EXPAND_TAC "T1" THEN MATCH_MP_TAC FINITE_PACK_LEMMA THEN ASM_REWRITE_TAC[]);;
e (ASM_SET_TAC[]);;
e (EXPAND_TAC "f_temp" THEN EXPAND_TAC "S_temp" THEN 
   REWRITE_TAC[IMAGE; SUBSET; IN; IN_ELIM_THM]);;
e (REPEAT STRIP_TAC);;
e (EXISTS_TAC `u0:real^3, u1:real^3` THEN ASM_REWRITE_TAC[]);;
e (EXISTS_TAC `u0:real^3` THEN EXISTS_TAC `u1:real^3` THEN ASM_REWRITE_TAC[]);;
e (ASM_SET_TAC[]);;
e (REWRITE_TAC[IN] THEN EXPAND_TAC "T4" THEN EXPAND_TAC "T3" THEN
   REWRITE_TAC[ABS_SIMP; IN_DIFF; IN_INTER; IN_ELIM_THM]);;
e (REPEAT STRIP_TAC);;

e (MATCH_MP_TAC (REAL_ARITH `(?x. a <= x /\ x <= b) ==> a <= b`));;
e (EXISTS_TAC 
 `sum {X| ~(X SUBSET ball (vec 0,r)) /\ mcell_set V X /\ critical_edgeX V X x}  
  (\x. cc1)`);;
e (STRIP_TAC);;
e (MATCH_MP_TAC SUM_LE);;
e (STRIP_TAC);;
e (MATCH_MP_TAC FINITE_SUBSET);;
e (EXISTS_TAC `{X | mcell_set V X /\ edgeX V X x}`);;
e (STRIP_TAC);;
e (MATCH_MP_TAC Marchal_cells_3.FINITE_EDGE_X2);;
e (EXISTS_TAC `u0:real^3` THEN EXISTS_TAC `u1:real^3` THEN ASM_REWRITE_TAC[]);;
e (REWRITE_TAC[critical_edgeX] THEN SET_TAC[]);;
e (REWRITE_TAC[BETA_THM; ABS_SIMP; IN; IN_ELIM_THM] THEN REPEAT STRIP_TAC);;
e (EXPAND_TAC "f");;
e (NEW_GOAL `critical_weight V x' <= &1`);;
e (REWRITE_TAC[critical_weight]);;
e (REWRITE_WITH `&1 / &(CARD (critical_edgeX V x')) <= &1 <=> 
                 &1  <= &(CARD (critical_edgeX V x'))`);;
e (MATCH_MP_TAC Packing3.REAL_DIV_LE_1);;
e (REWRITE_TAC[REAL_OF_NUM_LT; ARITH_RULE `0 < a <=> ~(a = 0)`]);;
e (REWRITE_WITH `CARD (critical_edgeX V x') = 0 <=> critical_edgeX V x' = {}`);;
e (MATCH_MP_TAC CARD_EQ_0);;
e (REWRITE_TAC[critical_edgeX; edgeX] THEN MATCH_MP_TAC FINITE_SUBSET);;


e (EXISTS_TAC `{{u0:real^3, u1} | u0 IN VX V x' /\ u1 IN VX V x'}`);;
e (STRIP_TAC);;
e (MATCH_MP_TAC FINITE_SUBSET);;
e (ABBREV_TAC `S_temp = {u0, u1:real^3 | u0 IN VX V x' /\ u1 IN VX V x'}`);;
e (ABBREV_TAC `f_temp = (\(u0,u1:real^3). {u0, u1})`);;
e (EXISTS_TAC `IMAGE (f_temp:real^3#real^3->real^3->bool) S_temp`);;
e (STRIP_TAC);;
e (MATCH_MP_TAC FINITE_IMAGE);;
e (EXPAND_TAC "S_temp" THEN MATCH_MP_TAC FINITE_PRODUCT THEN REWRITE_TAC[]);;
e (MATCH_MP_TAC FINITE_VX);;
e (ASM_REWRITE_TAC[]);;
e (EXPAND_TAC "f_temp" THEN EXPAND_TAC "S_temp" THEN 
   REWRITE_TAC[IMAGE; SUBSET; IN; IN_ELIM_THM]);;
e (REPEAT STRIP_TAC);;
e (EXISTS_TAC `u0':real^3, u1':real^3` THEN ASM_REWRITE_TAC[]);;
e (EXISTS_TAC `u0':real^3` THEN EXISTS_TAC `u1':real^3` THEN ASM_REWRITE_TAC[]);;
e (ASM_SET_TAC[]);;
e (UP_ASM_TAC THEN SET_TAC[]);;
e (REWRITE_TAC[REAL_OF_NUM_LE; ARITH_RULE `1 <= a <=> ~(a = 0)`]);;
e (REWRITE_WITH `CARD (critical_edgeX V x') = 0 <=> critical_edgeX V x' = {}`);;
e (MATCH_MP_TAC CARD_EQ_0);;
e (REWRITE_TAC[critical_edgeX; edgeX] THEN MATCH_MP_TAC FINITE_SUBSET);;
e (EXISTS_TAC `{{u0:real^3, u1} | u0 IN VX V x' /\ u1 IN VX V x'}`);;
e (STRIP_TAC);;
e (MATCH_MP_TAC FINITE_SUBSET);;
e (ABBREV_TAC `S_temp = {u0, u1:real^3 | u0 IN VX V x' /\ u1 IN VX V x'}`);;
e (ABBREV_TAC `f_temp = (\(u0,u1:real^3). {u0, u1})`);;
e (EXISTS_TAC `IMAGE (f_temp:real^3#real^3->real^3->bool) S_temp`);;
e (STRIP_TAC);;
e (MATCH_MP_TAC FINITE_IMAGE);;
e (EXPAND_TAC "S_temp" THEN MATCH_MP_TAC FINITE_PRODUCT THEN REWRITE_TAC[]);;
e (MATCH_MP_TAC FINITE_VX);;
e (ASM_REWRITE_TAC[]);;
e (EXPAND_TAC "f_temp" THEN EXPAND_TAC "S_temp" THEN 
   REWRITE_TAC[IMAGE; SUBSET; IN; IN_ELIM_THM]);;
e (REPEAT STRIP_TAC);;
e (EXISTS_TAC `u0':real^3, u1':real^3` THEN ASM_REWRITE_TAC[]);;
e (EXISTS_TAC `u0':real^3` THEN EXISTS_TAC `u1':real^3` THEN ASM_REWRITE_TAC[]);;
e (ASM_SET_TAC[]);;
e (UP_ASM_TAC THEN SET_TAC[]);;
e (NEW_GOAL `&0 <= critical_weight V x'`);;
e (REWRITE_TAC[critical_weight] THEN MATCH_MP_TAC REAL_LE_DIV);;
e (REWRITE_TAC[REAL_ARITH `&0 <= &1`; REAL_OF_NUM_LE]);;
e (ARITH_TAC);;
e (NEW_GOAL `gammaX V x' lmfun <= cc1`);;
e (FIRST_ASSUM MATCH_MP_TAC);;
e (ASM_REWRITE_TAC[]);;
e (NEW_GOAL `gammaX V x' lmfun * critical_weight V x' <= cc1 * critical_weight V x'`);;

e (ONCE_REWRITE_TAC[REAL_ARITH `(a <= b <=> &0 <= b - a)`]);;
e (REWRITE_TAC[REAL_ARITH `a * x - b * x = (a - b) * x`]);;
e (MATCH_MP_TAC REAL_LE_MUL THEN ASM_REAL_ARITH_TAC);;

e (NEW_GOAL `cc1 * critical_weight V x' <= cc1`);;
e (ONCE_REWRITE_TAC[REAL_ARITH `(a <= b <=> &0 <= b - a)`]);;
e (REWRITE_WITH `!x b. b - b * x = b * (&1 - x)`);;
e (REAL_ARITH_TAC);;
e (MATCH_MP_TAC REAL_LE_MUL THEN STRIP_TAC);;
e (ASM_REAL_ARITH_TAC);;
e (ASM_REAL_ARITH_TAC);;
e (ASM_REAL_ARITH_TAC);;
e (REWRITE_WITH 
 `sum
  {X | ~(X SUBSET ball (vec 0,r)) /\ mcell_set V X /\ critical_edgeX V X x}
  (\x. cc1) = 
 &(CARD
   {X | ~(X SUBSET ball (vec 0,r)) /\ mcell_set V X /\ critical_edgeX V X x}) 
   * cc1`);;
e (MATCH_MP_TAC SUM_CONST);;
e (MATCH_MP_TAC FINITE_SUBSET);;
e (EXISTS_TAC `{X | mcell_set V X /\ edgeX V X x}`);;
e (STRIP_TAC);;
e (MATCH_MP_TAC Marchal_cells_3.FINITE_EDGE_X2);;
e (EXISTS_TAC `u0:real^3` THEN EXISTS_TAC `u1:real^3` THEN ASM_REWRITE_TAC[]);;
e (REWRITE_TAC[critical_edgeX] THEN SET_TAC[]);;

e (ONCE_REWRITE_TAC[REAL_ARITH `(a <= b <=> &0 <= b - a)`]);;
e (REWRITE_TAC[REAL_ARITH `a * x - b * x = x * (a - b)`]);;
e (MATCH_MP_TAC REAL_LE_MUL THEN STRIP_TAC);;
e (ASM_REAL_ARITH_TAC);;
e (NEW_GOAL 
  ` &(CARD
     {X | ~(X SUBSET ball (vec 0,r)) /\ mcell_set V X /\ critical_edgeX V X x})
    <=  &(CARD {X | mcell_set V X /\ VX V X u0})`);;
e (REWRITE_TAC[REAL_OF_NUM_LE] THEN MATCH_MP_TAC CARD_SUBSET);;
e (STRIP_TAC);;
e (ASM_REWRITE_TAC[critical_edgeX; edgeX; IN; IN_ELIM_THM]);;
e (SET_TAC[]);;
e (MATCH_MP_TAC FINITE_SUBSET);;
e (EXISTS_TAC `{X | X SUBSET ball (u0,&8) /\ mcell_set V X}`);;
e (STRIP_TAC);;
e (MATCH_MP_TAC FINITE_MCELL_SET_LEMMA_2);;
e (ASM_REWRITE_TAC[]);;
e (ONCE_REWRITE_TAC[SUBSET]);;
e (REWRITE_TAC[IN; IN_ELIM_THM] THEN REPEAT STRIP_TAC);;
e (MATCH_MP_TAC MCELL_SUBSET_BALL8_2);;
e (EXISTS_TAC `V:real^3->bool`);;
e (ASM_REWRITE_TAC[]);;
e (NEW_GOAL `VX V x' = V INTER x'`);;
e (MATCH_MP_TAC Hdtfnfz.HDTFNFZ);;
e (UNDISCH_TAC `mcell_set V x'` THEN 
   REWRITE_TAC[mcell_set; IN; IN_ELIM_THM] THEN REPEAT STRIP_TAC);;
e (EXISTS_TAC `ul:(real^3)list` THEN EXISTS_TAC `i:num`);;
e (ASM_REWRITE_TAC[]);;
e (STRIP_TAC);;
e (UNDISCH_TAC `VX V x' u0` THEN ASM_REWRITE_TAC[VX]);;
e (REWRITE_TAC[MESON[IN] `{} x <=> x IN {}`]);;
e (SET_TAC[]);;
e (UP_ASM_TAC THEN UP_ASM_TAC THEN SET_TAC[]);;
e (ASM_REWRITE_TAC[]);;

e (NEW_GOAL `&(CARD {X | mcell_set V X /\ VX V X u0}) <= cc2`);;
e (ASM_MESON_TAC[]);;

e (ABBREV_TAC `s1_temp = &(CARD
       {X | ~(X SUBSET ball (vec 0,r)) /\
            mcell_set V X /\
            critical_edgeX V X x})`);;
e (ABBREV_TAC `s2_temp = &(CARD {X | mcell_set V X /\ VX V X u0})`);;
e (ASM_REAL_ARITH_TAC);;

e (KY_CHEAT_TAC);;  (* Xem KIZHLTL 1,2 *)


(* ==================================================================== *)

e (REWRITE_WITH 
 `sum T2 (\x. sum {X | mcell_set V X /\ critical_edgeX V X x} (\X. f X x)) = 
  sum T2 (\e. cluster_gammaX V e (cell_cluster V e)) - 
  sum T2 (\x. sum {X | mcell_set V X /\ critical_edgeX V X x} (beta_bump V x))`);;
e (REWRITE_TAC[REAL_ARITH `a = b - c <=> b = a + c`]);;
e (ABBREV_TAC 
 `f1 = (\x. sum {X | mcell_set V X /\ critical_edgeX V X x} (\X. f X x))`);;
e (ABBREV_TAC 
 `f2 = (\x. sum {X | mcell_set V X /\ critical_edgeX V X x} (beta_bump V x))`);;
e (REWRITE_WITH 
 `sum T2 (\e. cluster_gammaX V e (cell_cluster V e)) = 
  sum T2 (\e:real^3->bool. f1 e + f2 e)`);;
e (MATCH_MP_TAC SUM_EQ);;
e (EXPAND_TAC "T2" THEN REWRITE_TAC[IN; IN_ELIM_THM] THEN REPEAT STRIP_TAC);;
e (EXPAND_TAC "f1" THEN EXPAND_TAC "f2" THEN REWRITE_TAC[cluster_gammaX; cell_cluster]);;
e (REWRITE_TAC[FUN_EQ_THM] THEN REPEAT STRIP_TAC);;
e (EXPAND_TAC "f");;
e (REWRITE_TAC[SET_RULE `{X | x IN critical_edgeX V X /\ mcell_set V X} = 
                         {X | mcell_set V X /\ critical_edgeX V X x}`]);;
e (MATCH_MP_TAC SUM_ADD);;
e (MATCH_MP_TAC FINITE_SUBSET);;
e (EXISTS_TAC `{X | X SUBSET ball (u0,&8) /\ mcell_set V X}`);;
e (STRIP_TAC);;
e (MATCH_MP_TAC FINITE_MCELL_SET_LEMMA_2);;
e (ASM_REWRITE_TAC[]);;
e (ONCE_REWRITE_TAC[SUBSET]);;
e (REWRITE_TAC[IN; IN_ELIM_THM] THEN REPEAT STRIP_TAC);;
e (MATCH_MP_TAC MCELL_SUBSET_BALL8_2);;
e (EXISTS_TAC `V:real^3->bool`);;
e (ASM_REWRITE_TAC[]);;
e (NEW_GOAL `VX V x' = V INTER x'`);;
e (MATCH_MP_TAC Hdtfnfz.HDTFNFZ);;
e (UNDISCH_TAC `mcell_set V x'` THEN 
   REWRITE_TAC[mcell_set; IN; IN_ELIM_THM] THEN REPEAT STRIP_TAC);;
e (EXISTS_TAC `ul:(real^3)list` THEN EXISTS_TAC `i:num`);;
e (ASM_REWRITE_TAC[]);;
e (STRIP_TAC);;

e (UNDISCH_TAC `critical_edgeX V x' x` THEN 
   REWRITE_TAC[critical_edgeX; edgeX; IN; IN_ELIM_THM] THEN STRIP_TAC);;
e (NEW_GOAL `VX V x' u0`);;
e (NEW_GOAL `u0 = u' \/ u0 = v':real^3`);;
e (ASM_SET_TAC[]);;
e (UP_ASM_TAC THEN STRIP_TAC);;
e (REWRITE_TAC[ASSUME `u0 = u':real^3`]);;
e (ASM_REWRITE_TAC[]);;
e (REWRITE_TAC[ASSUME `u0 = v':real^3`]);;
e (ASM_REWRITE_TAC[]);;

e (UNDISCH_TAC `VX V x' u0` THEN ASM_REWRITE_TAC[VX]);;
e (REWRITE_TAC[MESON[IN] `{} x <=> x IN {}`]);;
e (SET_TAC[]);;

e (NEW_GOAL `VX V x' u0`);;
e (UNDISCH_TAC `mcell_set V x'` THEN 
   REWRITE_TAC[mcell_set; IN; IN_ELIM_THM] THEN REPEAT STRIP_TAC);;
e (UNDISCH_TAC `critical_edgeX V x' x` THEN 
   REWRITE_TAC[critical_edgeX; edgeX; IN; IN_ELIM_THM] THEN STRIP_TAC);;
e (NEW_GOAL `u0 = u' \/ u0 = v':real^3`);;
e (ASM_SET_TAC[]);;
e (UP_ASM_TAC THEN STRIP_TAC);;
e (REWRITE_TAC[ASSUME `u0 = u':real^3`]);;
e (ASM_REWRITE_TAC[]);;
e (REWRITE_TAC[ASSUME `u0 = v':real^3`]);;
e (ASM_REWRITE_TAC[]);;
e (UP_ASM_TAC THEN UP_ASM_TAC THEN SET_TAC[]);;
e (ASM_REWRITE_TAC[]);;
e (MATCH_MP_TAC SUM_ADD);;
e (ASM_REWRITE_TAC[]);;

e (MATCH_MP_TAC (REAL_ARITH `&0 <= a /\ b + x <= &0 ==> x <= a - b`));;
e (STRIP_TAC);;
e (MATCH_MP_TAC SUM_POS_LE);;
e (ASM_REWRITE_TAC[]);;
e (EXPAND_TAC "T2" THEN REWRITE_TAC[IN; IN_ELIM_THM]);;
e (REPEAT STRIP_TAC);;

e (NEW_GOAL `cell_cluster_estimate V`);;
e (ASM_SIMP_TAC[OXLZLEZ]);; 
(* sau nay dua luon cell_cluster_estimate V vao gia thuyet; ko dung nua *)
e (UP_ASM_TAC THEN REWRITE_TAC[cell_cluster_estimate]);;
e (REWRITE_TAC[REAL_ARITH `&0 <= a <=> a >= &0`] THEN STRIP_TAC);;
e (ASM_REWRITE_TAC[]);;


(* ----------- *)
b();;

e (ABBREV_TAC 
  `f1 = (\x. sum {X | X SUBSET ball (vec 0, r + &8) DIFF ball (vec 0, r - &16)
                      /\ mcell_set V X 
                      /\ critical_edgeX V X x} (beta_bump V x))`);;
e (ABBREV_TAC 
  `f2 = (\x. sum {X | X SUBSET ball (vec 0, r - &8) /\ mcell_set V X /\
                      critical_edgeX V X x} (beta_bump V x))`);;

e (REWRITE_WITH 
  `sum T2 (\x. sum {X | mcell_set V X /\ critical_edgeX V X x} (beta_bump V x))
 = sum T2 f1 + sum T2 f2`);;
e (REWRITE_WITH 
`sum T2 (\x. sum {X | mcell_set V X /\ critical_edgeX V X x} (beta_bump V x)) =
 sum T2 (\x. f1 x + f2 x)`);;
e (MATCH_MP_TAC SUM_EQ);;
e (EXPAND_TAC "T2" THEN REWRITE_TAC[IN; IN_ELIM_THM] THEN REPEAT STRIP_TAC);;
e (EXPAND_TAC "f1" THEN EXPAND_TAC "f2");;
e (ABBREV_TAC 
 `s1 = {X | X SUBSET ball (vec 0,r + &8) DIFF ball (vec 0,r - &16) /\
            mcell_set V X /\critical_edgeX V X x}`);;
e (ABBREV_TAC `s2 = {X | X SUBSET ball (vec 0,r - &8) /\ mcell_set V X /\
                         critical_edgeX V X x}`);;
e (REWRITE_WITH `{X | mcell_set V X /\ critical_edgeX V X x} = s1 UNION s2`);;
e (EXPAND_TAC "s1" THEN EXPAND_TAC "s2" THEN 
   REWRITE_TAC[SET_EQ_LEMMA; IN_UNION; IN_ELIM_THM; IN]);;
e (REPEAT STRIP_TAC);;
e (ASM_REWRITE_TAC[]);;

e (ASM_CASES_TAC `x' SUBSET ball ((vec 0):real^3,r - &8)`);;
e (ASM_REWRITE_TAC[]);;
e (ASM_REWRITE_TAC[SUBSET; IN_DIFF; IN_BALL]);;
e (REPEAT STRIP_TAC);;

e (NEW_GOAL `x' SUBSET ball (u0:real^3, &8)`);;
e (MATCH_MP_TAC MCELL_SUBSET_BALL8_2);;

e (EXISTS_TAC `V:real^3->bool`);;
e (ASM_REWRITE_TAC[]);;
e (NEW_GOAL `x:real^3->bool SUBSET x'`);;
e (MATCH_MP_TAC CRITICAL_EDGEX_SUBSET_MCELL);;
e (EXISTS_TAC `V:real^3->bool`);;
e (ASM_REWRITE_TAC[]);;
e (UP_ASM_TAC THEN ASM_REWRITE_TAC[]);;
e (SET_TAC[]);;
e (NEW_GOAL `dist (u0:real^3, x'') < &8`);;
e (REWRITE_TAC[GSYM IN_BALL] THEN ASM_SET_TAC[]);;
e (NEW_GOAL `dist (vec 0, x'') <= dist (u0, x'') + dist (vec 0, u0:real^3)`);;
e (NORM_ARITH_TAC);;
e (NEW_GOAL `dist (vec 0, u0:real^3) < r`);;
e (REWRITE_TAC[GSYM IN_BALL]);;
 THEN ASM_SET_TAC[]);;
e (UNDISCH_TAC `(T1:real^3->bool) u0`);;
e (EXPAND_TAC "T1" THEN REWRITE_TAC[MESON[IN] `(A:real^3->bool) x <=> x IN A`]);;
e (SET_TAC[]);;
e (ASM_REAL_ARITH_TAC);;
e (NEW_GOAL `?p:real^3. p IN x' /\ ~(p IN ball (vec 0,r - &8))`);;
e (UNDISCH_TAC `~(x' SUBSET ball ((vec 0):real^3,r - &8))`);;
e (SET_TAC[]);;
e (UP_ASM_TAC THEN REWRITE_TAC[IN_BALL] THEN STRIP_TAC);;
e (UP_ASM_TAC THEN REWRITE_TAC[]);;

e (NEW_GOAL `x' SUBSET ball (x'':real^3, &8)`);;
e (MATCH_MP_TAC MCELL_SUBSET_BALL8_2);;
e (EXISTS_TAC `V:real^3->bool`);;
e (ASM_REWRITE_TAC[]);;

e (NEW_GOAL `dist (x'':real^3, p) < &8`);;
e (REWRITE_TAC[GSYM IN_BALL] THEN ASM_SET_TAC[]);;
e (NEW_GOAL `dist (vec 0, p) <= dist (x'',p:real^3) + dist (vec 0, x'')`);;
e (NORM_ARITH_TAC);;
e (ASM_REAL_ARITH_TAC);;
e (ASM_REWRITE_TAC[]);;
e (ASM_REWRITE_TAC[]);;
e (ASM_REWRITE_TAC[]);;
e (ASM_REWRITE_TAC[]);;
e (MATCH_MP_TAC SUM_UNION);;

SUM_UNION;;

s

b();;
p();;

search [`sum (s UNION t) f`];;







cluster_gammaX;;


b();;

search [`VX V x' = V INTER x'`];;




seans_fn();;










e (REWRITE_TAC[BETA_THM; ABS_SIMP; IN; IN_ELIM_THM] THEN REPEAT STRIP_TAC);;
e (EXPAND_TAC "f");;
e (NEW_GOAL `critical_weight V x' <= &1`);;
e (REWRITE_TAC[critical_weight]);;
e (REWRITE_WITH `&1 / &(CARD (critical_edgeX V x')) <= &1 <=> 
                 &1  <= &(CARD (critical_edgeX V x'))`);;
e (MATCH_MP_TAC Packing3.REAL_DIV_LE_1);;
e (REWRITE_TAC[REAL_OF_NUM_LT; ARITH_RULE `0 < a <=> ~(a = 0)`]);;
e (REWRITE_WITH `CARD (critical_edgeX V x') = 0 <=> critical_edgeX V x' = {}`);;
e (MATCH_MP_TAC CARD_EQ_0);;
e (REWRITE_TAC[critical_edgeX; edgeX] THEN MATCH_MP_TAC FINITE_SUBSET);;


e (EXISTS_TAC `{{u0:real^3, u1} | u0 IN VX V x' /\ u1 IN VX V x'}`);;
e (STRIP_TAC);;
e (MATCH_MP_TAC FINITE_SUBSET);;
e (ABBREV_TAC `S_temp = {u0, u1:real^3 | u0 IN VX V x' /\ u1 IN VX V x'}`);;
e (ABBREV_TAC `f_temp = (\(u0,u1:real^3). {u0, u1})`);;
e (EXISTS_TAC `IMAGE (f_temp:real^3#real^3->real^3->bool) S_temp`);;
e (STRIP_TAC);;
e (MATCH_MP_TAC FINITE_IMAGE);;
e (EXPAND_TAC "S_temp" THEN MATCH_MP_TAC FINITE_PRODUCT THEN REWRITE_TAC[]);;
e (MATCH_MP_TAC FINITE_VX);;
e (ASM_REWRITE_TAC[]);;
e (EXPAND_TAC "f_temp" THEN EXPAND_TAC "S_temp" THEN 
   REWRITE_TAC[IMAGE; SUBSET; IN; IN_ELIM_THM]);;
e (REPEAT STRIP_TAC);;
e (EXISTS_TAC `u0':real^3, u1':real^3` THEN ASM_REWRITE_TAC[]);;
e (EXISTS_TAC `u0':real^3` THEN EXISTS_TAC `u1':real^3` THEN ASM_REWRITE_TAC[]);;
e (ASM_SET_TAC[]);;
e (UP_ASM_TAC THEN SET_TAC[]);;
e (REWRITE_TAC[REAL_OF_NUM_LE; ARITH_RULE `1 <= a <=> ~(a = 0)`]);;
e (REWRITE_WITH `CARD (critical_edgeX V x') = 0 <=> critical_edgeX V x' = {}`);;
e (MATCH_MP_TAC CARD_EQ_0);;
e (REWRITE_TAC[critical_edgeX; edgeX] THEN MATCH_MP_TAC FINITE_SUBSET);;
e (EXISTS_TAC `{{u0:real^3, u1} | u0 IN VX V x' /\ u1 IN VX V x'}`);;
e (STRIP_TAC);;
e (MATCH_MP_TAC FINITE_SUBSET);;
e (ABBREV_TAC `S_temp = {u0, u1:real^3 | u0 IN VX V x' /\ u1 IN VX V x'}`);;
e (ABBREV_TAC `f_temp = (\(u0,u1:real^3). {u0, u1})`);;
e (EXISTS_TAC `IMAGE (f_temp:real^3#real^3->real^3->bool) S_temp`);;
e (STRIP_TAC);;
e (MATCH_MP_TAC FINITE_IMAGE);;
e (EXPAND_TAC "S_temp" THEN MATCH_MP_TAC FINITE_PRODUCT THEN REWRITE_TAC[]);;
e (MATCH_MP_TAC FINITE_VX);;
e (ASM_REWRITE_TAC[]);;
e (EXPAND_TAC "f_temp" THEN EXPAND_TAC "S_temp" THEN 
   REWRITE_TAC[IMAGE; SUBSET; IN; IN_ELIM_THM]);;
e (REPEAT STRIP_TAC);;
e (EXISTS_TAC `u0':real^3, u1':real^3` THEN ASM_REWRITE_TAC[]);;
e (EXISTS_TAC `u0':real^3` THEN EXISTS_TAC `u1':real^3` THEN ASM_REWRITE_TAC[]);;
e (ASM_SET_TAC[]);;
e (UP_ASM_TAC THEN SET_TAC[]);;
e (NEW_GOAL `&0 <= critical_weight V x'`);;
e (REWRITE_TAC[critical_weight] THEN MATCH_MP_TAC REAL_LE_DIV);;
e (REWRITE_TAC[REAL_ARITH `&0 <= &1`; REAL_OF_NUM_LE]);;
e (ARITH_TAC);;
e (NEW_GOAL `gammaX V x' lmfun <= cc1`);;
e (FIRST_ASSUM MATCH_MP_TAC);;
e (ASM_REWRITE_TAC[]);;
e (NEW_GOAL `gammaX V x' lmfun * critical_weight V x' <= cc1 * critical_weight V x'`);;

e (ONCE_REWRITE_TAC[REAL_ARITH `(a <= b <=> &0 <= b - a)`]);;
e (REWRITE_TAC[REAL_ARITH `a * x - b * x = (a - b) * x`]);;
e (MATCH_MP_TAC REAL_LE_MUL THEN ASM_REAL_ARITH_TAC);;

e (NEW_GOAL `cc1 * critical_weight V x' <= cc1`);;
e (ONCE_REWRITE_TAC[REAL_ARITH `(a <= b <=> &0 <= b - a)`]);;
e (REWRITE_WITH `!x b. b - b * x = b * (&1 - x)`);;
e (REAL_ARITH_TAC);;
e (MATCH_MP_TAC REAL_LE_MUL THEN STRIP_TAC);;
e (ASM_REAL_ARITH_TAC);;
e (ASM_REAL_ARITH_TAC);;
e (ASM_REAL_ARITH_TAC);;
e (REWRITE_WITH 
 `sum
  {X | ~(X SUBSET ball (vec 0,r)) /\ mcell_set V X /\ critical_edgeX V X x}
  (\x. cc1) = 
 &(CARD
   {X | ~(X SUBSET ball (vec 0,r)) /\ mcell_set V X /\ critical_edgeX V X x}) 
   * cc1`);;
e (MATCH_MP_TAC SUM_CONST);;

b();;

e (ASM_REAL_ARITH_TAC);;

b();;


FINITE_EDGEX;;


bREAL_ARITH `&0 < a ==> b / a <= &1 <=> b <= a`;;

search [`&0 < a ==> (b / a <= &1 <=> b <= a)`];;
b();;

;;
search [`critical_weight`];;

search [`FINITE`; `mcell_set`];;



b();;

search [`(\x. c) x = c`];;

FINITE_PACK_LEMMA;;

seans_fn();;

search [`sum s f = sum t f`];;

b();;

search [`VX V X = V INTER X`];;

b();;

MCELL_SUBSET_BALL8_2;;

e (ABBREV_TAC 
  `g =  (\x. sum  {X | ~(X SUBSET ball (vec 0,r)) /\  mcell_set V X /\
                        critical_edgeX V X x}
             (\X. f X x))`);;
e (REWRITE_WITH 
   `sum {{u0:real^3, u1} | u0 IN T1 /\ u1 IN T1 /\ 
                          ~(u0 = u1) /\ hl [u0; u1] <= hplus} g =
    &1 / &2 * 
    sum {m,(n:real^3) | m IN T1 /\ n IN T1 /\ 
                       ~(m = n) /\ hl [m; n] <= hplus} (\(m,n). g {m, n})`);;
e (REWRITE_TAC[REAL_ARITH `a = &1 / &2 * b <=> b = &2 * a`]);;
e (REWRITE_TAC[HL_2; REAL_ARITH `inv (&2) * a <= b <=> a <= &2 * b`]);;
e (MATCH_MP_TAC SUM_PAIR_2_SET);;
e (EXPAND_TAC "T1" THEN MATCH_MP_TAC FINITE_PACK_LEMMA);;
e (ASM_REWRITE_TAC[]);;

e (ABBREV_TAC `t = (\m:real^3. 
                       {n | n IN T1 /\ ~(m = n) /\ hl [m; n] <= hplus})`);;
e (REWRITE_WITH 
  `sum {m:real^3,n | m IN T1 /\ n IN T1 /\ ~(m = n) /\ hl [m; n] <= hplus}
   (\(m,n). g {m, n}) =  
   sum {m,n | m IN T1 /\ n IN t m} (\(m,n). g {m, n})`);;
e (EXPAND_TAC "t" THEN REWRITE_TAC[IN; IN_ELIM_THM]);;
e (ABBREV_TAC `h = (\m n:real^3. (g:(real^3->bool)->real) {m,n})`);;
e (REWRITE_WITH `sum {m,n:real^3 | m IN T1 /\ n IN t m} (\(m,n). g {m, n}) = 
                 sum {m,n | m IN T1 /\ n IN t m} (\(m,n). h m n)`);;
e (EXPAND_TAC "h");;
e (REWRITE_TAC[]);;

e (REWRITE_WITH 
   `sum {m:real^3,n:real^3 | m IN T1 /\ n IN t m} (\(m,n). h m n) = 
    sum T1 (\m. sum (t m) (h m))`);;
e (ONCE_REWRITE_TAC[EQ_SYM_EQ]);;
e (MATCH_MP_TAC SUM_SUM_PRODUCT);;
e (REPEAT STRIP_TAC);;
e (EXPAND_TAC "T1" THEN MATCH_MP_TAC FINITE_PACK_LEMMA);;
e (ASM_REWRITE_TAC[]);;
e (EXPAND_TAC "t");;
e (MATCH_MP_TAC FINITE_SUBSET);;
e (EXISTS_TAC `T1:real^3->bool`);;
e (STRIP_TAC);;
e (EXPAND_TAC "T1" THEN MATCH_MP_TAC FINITE_PACK_LEMMA);;
e (ASM_REWRITE_TAC[]);;
e (SET_TAC[]);;

e (EXPAND_TAC "h" THEN EXPAND_TAC "t" THEN EXPAND_TAC "g");;
e (REWRITE_TAC[IN; IN_ELIM_THM]);;

e (EXPAND_TAC "f");;
e (REWRITE_WITH `sum T1
 (\m. sum {n | T1 n /\ ~(m = n) /\ hl [m; n] <= hplus}
      (\n. sum
           {X | ~(X SUBSET ball (vec 0,r)) /\
                mcell_set V X /\
                critical_edgeX V X {m, n}}
           (\X. gammaX V X lmfun * critical_weight V X))) = 
sum ()
 (\m. sum {n | T1 n /\ ~(m = n) /\ hl [m; n] <= hplus}
      (\n. sum
           {X | ~(X SUBSET ball (vec 0,r)) /\
                mcell_set V X /\
                critical_edgeX V X {m, n}}
           (\X. gammaX V X lmfun * critical_weight V X)))`

b();;

V INTER ball (vec 0,r);;

e (EXPAND_TAC "T1");;

search [`gammaX`];;

p();;

edgeX;;
search [`mcell_set`; `ball (x,y)`];;
Marchal_cells_3.MCELL_SUBSET_BALL_4;;
search [`ball (p, &4)`]
search []
gammaX;;
gamma_y_lmfun_bound ;;
search [`edgeX`];;

total_solid;;
gammaY;;
BOUNDS_VGEN_klemma;;
BOUNDS_V4_klemma;;
p();;

p();;
search [`mcell_set`; `ball (a, r)`];;

CARD_MCELL_CONTAINS_POINT_klemma;;



(* ========================================================================= *)


g `!V X. packing V /\ saturated V /\ mcell_set V X ==>
         CARD (edgeX V X) <= 15625`;;
e (REWRITE_TAC[mcell_set]



















g `?c. !V X e.
         saturated V /\ packing V /\ mcell_set V X /\ critical_edgeX V X e
         ==> beta_bump V e X <= c`;;
e (EXISTS_TAC `&614400`);;
e (REWRITE_TAC[mcell_set_2; IN_ELIM_THM; IN; beta_bump]);;
e (REPEAT STRIP_TAC THEN LET_TAC);;
e (UP_ASM_TAC THEN REWRITE_TAC[cell_params]);;

e (ONCE_REWRITE_TAC[EQ_SYM_EQ]);;
e (STRIP_TAC);;
e (ABBREV_TAC `P = (\(k,ul'). k <= 4 /\ ul' IN barV V 3 /\ 
                              mcell i V ul = mcell k V ul')`);;
e (NEW_GOAL `(P:(num#(real^3)list->bool)) (k,ul')`);;
e (ASM_REWRITE_TAC[]);;
e (MATCH_MP_TAC SELECT_AX);;
e (EXISTS_TAC `(i:num,ul:(real^3)list)`);;
e (EXPAND_TAC "P");;
e (REWRITE_TAC[BETA_THM]);;
e (ASM_REWRITE_TAC[IN]);;
e (UP_ASM_TAC THEN EXPAND_TAC "P");;
e (REWRITE_TAC[BETA_THM; IN] THEN STRIP_TAC);;

e (ABBREV_TAC `S = {e',e'',p,vl | 4 = k /\
                {e', e''} = critical_edgeX V X /\
                e' = e /\
                p permutes 0..3 /\
                left_action_list p ul' = vl /\
                {EL 0 vl, EL 1 vl} = e' /\
                {EL 2 vl, EL 3 vl} = e''}`);;

e (NEW_GOAL `?u0 u1 u2 u3. ul = [u0;u1;u2;u3:real^3]`);;
e (MATCH_MP_TAC BARV_3_EXPLICIT);;
e (EXISTS_TAC `V:real^3->bool` THEN ASM_REWRITE_TAC[]);;
e (UP_ASM_TAC THEN STRIP_TAC);;
e (ABBREV_TAC `K1 = {us:real^3->bool | us SUBSET set_of_list ul}`);;
e (NEW_GOAL `FINITE (K1:(real^3->bool)->bool)`);;
e (EXPAND_TAC "K1" THEN MATCH_MP_TAC FINITE_POWERSET);;
e (ASM_REWRITE_TAC[set_of_list; Geomdetail.FINITE6]);;

e (NEW_GOAL `critical_edgeX V X SUBSET K1`);;
e (EXPAND_TAC "K1" THEN 
   REWRITE_TAC[critical_edgeX; edgeX; SUBSET; IN; IN_ELIM_THM]);;
e (REPEAT STRIP_TAC);;

e (NEW_GOAL `(x:real^3->bool) SUBSET set_of_list ul`);;
e (REWRITE_TAC[ASSUME `x = {u, v:real^3}`; ASSUME `{u, v} = {u', v':real^3}`]);;
e (NEW_GOAL `VX V X = V INTER X`);;
e (MATCH_MP_TAC Hdtfnfz.HDTFNFZ);;
e (EXISTS_TAC `ul:(real^3)list` THEN EXISTS_TAC `i:num`);;
e (ASM_REWRITE_TAC[]);;
e (STRIP_TAC);;
e (NEW_GOAL `VX V X = {}`);;
e (ASM_REWRITE_TAC[VX]);;
e (UNDISCH_TAC `VX V X u'` THEN 
   ASM_REWRITE_TAC[MESON[IN] `{} x <=> x IN {}`] THEN SET_TAC[]);;
e (NEW_GOAL 
  `V INTER (X:real^3->bool) = set_of_list (truncate_simplex (i - 1) ul)`);;
e (REWRITE_TAC[ASSUME `X = mcell i V ul`]);;
e (MATCH_MP_TAC Lepjbdj.LEPJBDJ);;
e (ASM_REWRITE_TAC[]);;
e (STRIP_TAC);;
e (ASM_CASES_TAC `i = 0`);;
e (NEW_GOAL `F`);;
e (NEW_GOAL `VX V X = {}`);;
e (REWRITE_TAC[ASSUME `VX V X = V INTER X`; ASSUME `X = mcell i V ul`; 
   ASSUME `i = 0`]);;
e (MATCH_MP_TAC Lepjbdj.LEPJBDJ_0);;
e (ASM_REWRITE_TAC[]);;
e (UNDISCH_TAC `VX V X u'` THEN REWRITE_TAC[ASSUME `VX V X = {}`; 
   MESON[IN] `{} x <=> x IN {}`] THEN SET_TAC[]);;
e (ASM_MESON_TAC[]);;
e (ASM_ARITH_TAC);;
e (REWRITE_TAC[GSYM (ASSUME `mcell i V ul = mcell k V ul'`); 
   GSYM (ASSUME `X = mcell i V ul`)]);;
e (STRIP_TAC);;
e (NEW_GOAL `NULLSET X`);;
e (REWRITE_TAC[NEGLIGIBLE_EMPTY; ASSUME `X = {}:real^3->bool`]);;
e (NEW_GOAL `VX V X = {}`);;
e (REWRITE_TAC[VX; ASSUME `NULLSET X`]);;
e (UNDISCH_TAC `VX V X u'` THEN REWRITE_TAC[MESON[IN] `{} x <=> x IN {}`; 
   ASSUME `VX V X = {}`] THEN SET_TAC[]);;
e (NEW_GOAL `set_of_list (truncate_simplex (i - 1) ul) SUBSET 
             set_of_list (ul:(real^3)list)`);;
e (MATCH_MP_TAC Rogers.SET_OF_LIST_TRUNCATE_SIMPLEX_SUBSET);;
e (ASM_REWRITE_TAC[LENGTH] THEN ASM_ARITH_TAC);;
e (ASM_SET_TAC[]);;
e (ASM_SET_TAC[]);;

e (NEW_GOAL 
   `FINITE  
      (S:(real^3->bool)#(real^3->bool)#(num->num)#(real^3)list->bool)`);;
e (EXPAND_TAC "S");;
e (MATCH_MP_TAC FINITE_SUBSET);;
e (EXISTS_TAC `{e',e'',p,vl | {e', e''} = critical_edgeX V X /\
                               p permutes 0..3 /\
                               left_action_list p ul' = vl:(real^3)list}`);;
e (STRIP_TAC);;
e (MATCH_MP_TAC FINITE_SUBSET);;
e (EXISTS_TAC `{e',e'',p,vl | (e':real^3->bool) IN K1 /\ e'' IN K1 /\
                               p permutes 0..3 /\
                               left_action_list p ul' = vl:(real^3)list}`);;
e (STRIP_TAC);;
e (ABBREV_TAC `S_temp = {e',e'',p | (e':real^3->bool) IN K1 /\ e'' IN K1 /\
                         p permutes 0..3}`);;
e (ABBREV_TAC 
  `f_temp = (\(e':real^3->bool,e'':real^3->bool,p). 
              e',e'',p, (left_action_list p (ul':(real^3)list)))`);;
e (MATCH_MP_TAC FINITE_SUBSET);;
e (EXISTS_TAC `IMAGE  (f_temp:(real^3->bool)#(real^3->bool)#(num->num)->(real^3->bool)#(real^3->bool)#(num->num)#(real^3)list) S_temp`);;
e (STRIP_TAC);;
e (MATCH_MP_TAC FINITE_IMAGE);;

e (REWRITE_WITH `S_temp = {e':real^3->bool,u | e' IN K1 /\ 
                           u IN {e'', p | e'' IN K1 /\p permutes 0..3}}`);;
e (EXPAND_TAC "S_temp");;
e (SET_TAC[]);;
e (ABBREV_TAC `K2 = {e'':real^3->bool, p | e'' IN K1 /\p permutes 0..3}`);;
e (MATCH_MP_TAC FINITE_PRODUCT);;
e (ASM_REWRITE_TAC[]);;

e (REWRITE_WITH 
  `K2 = {e'':real^3->bool,p | e'' IN K1 /\ p IN {p | p permutes 0..3}}`);;
e (EXPAND_TAC "K2" THEN SET_TAC[]);;
e (MATCH_MP_TAC FINITE_PRODUCT);;
e (ASM_REWRITE_TAC[]);;
e (REWRITE_TAC[GSYM NUMSEG_LE; ARITH_RULE `a <= 3 <=> a < 4`;
   Marchal_cells_2_new.SET_OF_0_TO_3;  
   Upfzbzm_support_lemmas.FINITE_PERMUTE_4]);;
e (EXPAND_TAC "f_temp" THEN EXPAND_TAC "S_temp" THEN REWRITE_TAC[IMAGE]);;
e (REWRITE_TAC[IN; SUBSET; IN_ELIM_THM] THEN REPEAT STRIP_TAC);;
e (EXISTS_TAC `e':real^3->bool,e'':real^3->bool,p:num->num`);;
e (ASM_REWRITE_TAC[]);;
e (EXISTS_TAC `e':real^3->bool` THEN 
   EXISTS_TAC `e'':real^3->bool` THEN EXISTS_TAC `p:num->num`);;
e (ASM_REWRITE_TAC[]);;
e (UP_ASM_TAC THEN SET_TAC[]);;
e (SET_TAC[]);;


(* ------------------------------------------------------------------------ *)
(* Finish proving S is FINITE *)
(* ------------------------------------------------------------------------ *)

e (MATCH_MP_TAC (REAL_ARITH `(?x. a <= x /\ x <= b) ==> a <= b`));;
e (EXISTS_TAC 
   `sum (S:(real^3->bool)#(real^3->bool)#(num->num)#(real^3)list->bool) 
        (\x. &100)`);;
e (STRIP_TAC);;
e (MATCH_MP_TAC SUM_LE);;
e (ASM_REWRITE_TAC[]);;
e (EXPAND_TAC "S" THEN REWRITE_TAC[IN; IN_ELIM_THM] THEN REPEAT STRIP_TAC);;
e (ASM_REWRITE_TAC[]);;
e (REWRITE_TAC[GSYM (ASSUME `4 = k`); REAL_ARITH `a / &4 <= &100 <=> a <= &400`]);;
e (REWRITE_TAC[bump]);;
e (REWRITE_TAC[REAL_ARITH 
   `#0.005 * (&1 - a) - #0.005 * (&1 - b) <= &400 <=>
    b - a <= &80000`]);;
e (MATCH_MP_TAC (REAL_ARITH `(&0 <= a /\ b <= c ==> b - a <= c)`));;
e (STRIP_TAC);;
e (MATCH_MP_TAC REAL_LE_DIV);;
e (REWRITE_TAC[Real_ext.REAL_LE_POW_2]);;
e (REWRITE_TAC[hplus; h0; REAL_ARITH 
   `a / (#1.3254 - #1.26) pow 2 <= &80000 <=> a <= #342.1728`]);;
e (NEW_GOAL `barV V 3 vl`);;
e (MATCH_MP_TAC Qzksykg.QZKSYKG1);;
e (EXISTS_TAC `ul':(real^3)list`);;
e (EXISTS_TAC `4` THEN EXISTS_TAC `p:num->num`);;
e (ASM_REWRITE_TAC[ARITH_RULE `4 - 1 = 3`]);;
e (STRIP_TAC);;
e (SET_TAC[]);;
e (REWRITE_TAC[GSYM (ASSUME `mcell i V ul = mcell k V ul'`); 
               GSYM (ASSUME `X = mcell i V ul`)]);;
e (STRIP_TAC);;
e (NEW_GOAL `critical_edgeX V X = {}`);;
e (REWRITE_TAC[critical_edgeX ; edgeX; IN; IN_ELIM_THM; 
               SET_RULE `X = {} <=> ~(?s. s IN X)`]);;
e (STRIP_TAC);;
e (NEW_GOAL `NULLSET X`);;
e (ASM_MESON_TAC[NEGLIGIBLE_EMPTY]);;
e (UNDISCH_TAC `VX V X v'` THEN REWRITE_TAC[VX; ASSUME `NULLSET X`]);;
e (REWRITE_TAC[MESON[IN] `{} x <=> x IN {}`] THEN SET_TAC[]);;
e (UNDISCH_TAC `critical_edgeX V X e`);;
e (REWRITE_TAC[ASSUME `critical_edgeX V X = {}`; MESON[IN] `{} x <=> x IN {}`]
   THEN SET_TAC[]);;


e (NEW_GOAL `?v0 v1 v2 v3. vl = [v0;v1;v2;v3:real^3]`);;
e (MATCH_MP_TAC BARV_3_EXPLICIT);;
e (EXISTS_TAC `V:real^3->bool` THEN ASM_REWRITE_TAC[]);;
e (UP_ASM_TAC THEN REPEAT STRIP_TAC);;
e (ASM_REWRITE_TAC[EL; ARITH_RULE `3 = SUC 2 /\ 2 = SUC 1 /\ 1 = SUC 0`; HD; TL]);;
e (REWRITE_TAC[ARITH_RULE `SUC (SUC 0) = 2`]);;
e (NEW_GOAL `(hl [v2; v3:real^3] - #1.26) pow 2 <= (&10) pow 2`);;
e (REWRITE_TAC[GSYM REAL_LE_SQUARE_ABS; REAL_ARITH `abs (&10) = &10`]);;
e (ASM_CASES_TAC `&0 <= hl [v2; v3:real^3] - #1.26`);;
e (REWRITE_WITH `abs (hl [v2; v3:real^3] - #1.26) = hl [v2; v3] - #1.26`);;
e (ASM_REAL_ARITH_TAC);;

e (REWRITE_TAC[HL_2; 
   REAL_ARITH `inv (&2) * a - #1.26 <= &10 <=> a <= #22.52`]);;
e (NEW_GOAL `set_of_list vl SUBSET ball (v2:real^3,&4)`);;
e (MATCH_MP_TAC Qzyzmjc.BARV_3_IMP_FINITE_lemma2);;
e (EXISTS_TAC `V:real^3->bool` THEN ASM_REWRITE_TAC[set_of_list]);;
e (SET_TAC[]);;
e (UP_ASM_TAC THEN ASM_REWRITE_TAC[set_of_list] THEN STRIP_TAC);;
e (SUBGOAL_THEN `v3:real^3 IN ball (v2, &k)` MP_TAC);;
e (UP_ASM_TAC THEN SET_TAC[]);;
e (REWRITE_TAC[IN_BALL; GSYM (ASSUME `4 = k`)]);;
e (REAL_ARITH_TAC);;
e (REWRITE_WITH `abs (hl [v2; v3] - #1.26) = #1.26 - hl [v2; v3:real^3]`);;
e (ASM_REAL_ARITH_TAC);;
e (MATCH_MP_TAC (REAL_ARITH `&0 <= a ==> #1.26 - a <= &10`));;
e (REWRITE_TAC[HL_2] THEN NORM_ARITH_TAC);;
e (UP_ASM_TAC THEN REAL_ARITH_TAC);;
e (ASM_SIMP_TAC[SUM_CONST]);;


e (EXPAND_TAC "S");;
e (MATCH_MP_TAC (REAL_ARITH `(?s. x <= s /\ s <= b) ==> x <= b`));;
e (EXISTS_TAC `& (CARD {e',e'',p,vl | {e', e''} = critical_edgeX V X /\
                         p permutes 0..3 /\
                         left_action_list p ul' = vl:(real^3)list}) * &100 `);;
e (STRIP_TAC);;
e (REWRITE_TAC[REAL_ARITH `a * &100 <= b * &100 <=> a <= b`]);;
e (REWRITE_TAC[REAL_OF_NUM_LE]);;
e (MATCH_MP_TAC CARD_SUBSET);;
e (STRIP_TAC);;
e (SET_TAC[]);;
e (MATCH_MP_TAC FINITE_SUBSET);;

(*****)
e (EXISTS_TAC `{e',e'',p,vl | (e':real^3->bool) IN K1 /\ e'' IN K1 /\
                               p permutes 0..3 /\
                               left_action_list p ul' = vl:(real^3)list}`);;
e (STRIP_TAC);;
e (ABBREV_TAC `S_temp = {e',e'',p | (e':real^3->bool) IN K1 /\ e'' IN K1 /\
                         p permutes 0..3}`);;
e (ABBREV_TAC 
  `f_temp = (\(e':real^3->bool,e'':real^3->bool,p). 
              e',e'',p, (left_action_list p (ul':(real^3)list)))`);;
e (MATCH_MP_TAC FINITE_SUBSET);;
e (EXISTS_TAC `IMAGE  (f_temp:(real^3->bool)#(real^3->bool)#(num->num)->(real^3->bool)#(real^3->bool)#(num->num)#(real^3)list) S_temp`);;
e (STRIP_TAC);;
e (MATCH_MP_TAC FINITE_IMAGE);;

e (REWRITE_WITH `S_temp = {e':real^3->bool,u | e' IN K1 /\ 
                           u IN {e'', p | e'' IN K1 /\p permutes 0..3}}`);;
e (EXPAND_TAC "S_temp");;
e (SET_TAC[]);;
e (ABBREV_TAC `K2 = {e'':real^3->bool, p | e'' IN K1 /\p permutes 0..3}`);;
e (MATCH_MP_TAC FINITE_PRODUCT);;
e (ASM_REWRITE_TAC[]);;

e (REWRITE_WITH 
  `K2 = {e'':real^3->bool,p | e'' IN K1 /\ p IN {p | p permutes 0..3}}`);;
e (EXPAND_TAC "K2" THEN SET_TAC[]);;
e (MATCH_MP_TAC FINITE_PRODUCT);;
e (ASM_REWRITE_TAC[]);;
e (REWRITE_TAC[GSYM NUMSEG_LE; ARITH_RULE `a <= 3 <=> a < 4`;
   Marchal_cells_2_new.SET_OF_0_TO_3;  
   Upfzbzm_support_lemmas.FINITE_PERMUTE_4]);;
e (EXPAND_TAC "f_temp" THEN EXPAND_TAC "S_temp" THEN REWRITE_TAC[IMAGE]);;
e (REWRITE_TAC[IN; SUBSET; IN_ELIM_THM] THEN REPEAT STRIP_TAC);;
e (EXISTS_TAC `e':real^3->bool,e'':real^3->bool,p:num->num`);;
e (ASM_REWRITE_TAC[]);;
e (EXISTS_TAC `e':real^3->bool` THEN 
   EXISTS_TAC `e'':real^3->bool` THEN EXISTS_TAC `p:num->num`);;
e (ASM_REWRITE_TAC[]);;
e (SWITCH_TAC THEN UP_ASM_TAC THEN SET_TAC[]);;

e (MATCH_MP_TAC (REAL_ARITH `(?s. x <= s /\ s <= b) ==> x <= b`));;
e (EXISTS_TAC `& (CARD {e',e'',p,vl | (e':real^3->bool) IN K1 /\ e'' IN K1 /\
                          p permutes 0..3 /\
                          left_action_list p ul' = vl:(real^3)list}) * &100 `);;
e (STRIP_TAC);;
e (REWRITE_TAC[REAL_ARITH `a * &100 <= b * &100 <=> a <= b`]);;
e (REWRITE_TAC[REAL_OF_NUM_LE]);;
e (MATCH_MP_TAC CARD_SUBSET);;
e (STRIP_TAC);;
e (SWITCH_TAC THEN UP_ASM_TAC THEN SET_TAC[]);;

(* **** *)
e (ABBREV_TAC `S_temp = {e',e'',p | (e':real^3->bool) IN K1 /\ e'' IN K1 /\
                         p permutes 0..3}`);;
e (ABBREV_TAC 
  `f_temp = (\(e':real^3->bool,e'':real^3->bool,p). 
              e',e'',p, (left_action_list p (ul':(real^3)list)))`);;
e (MATCH_MP_TAC FINITE_SUBSET);;
e (EXISTS_TAC `IMAGE  (f_temp:(real^3->bool)#(real^3->bool)#(num->num)->(real^3->bool)#(real^3->bool)#(num->num)#(real^3)list) S_temp`);;
e (STRIP_TAC);;
e (MATCH_MP_TAC FINITE_IMAGE);;

e (REWRITE_WITH `S_temp = {e':real^3->bool,u | e' IN K1 /\ 
                           u IN {e'', p | e'' IN K1 /\p permutes 0..3}}`);;
e (EXPAND_TAC "S_temp");;
e (SET_TAC[]);;
e (ABBREV_TAC `K2 = {e'':real^3->bool, p | e'' IN K1 /\p permutes 0..3}`);;
e (MATCH_MP_TAC FINITE_PRODUCT);;
e (ASM_REWRITE_TAC[]);;

e (REWRITE_WITH 
  `K2 = {e'':real^3->bool,p | e'' IN K1 /\ p IN {p | p permutes 0..3}}`);;
e (EXPAND_TAC "K2" THEN SET_TAC[]);;
e (MATCH_MP_TAC FINITE_PRODUCT);;
e (ASM_REWRITE_TAC[]);;
e (REWRITE_TAC[GSYM NUMSEG_LE; ARITH_RULE `a <= 3 <=> a < 4`;
   Marchal_cells_2_new.SET_OF_0_TO_3;  
   Upfzbzm_support_lemmas.FINITE_PERMUTE_4]);;
e (EXPAND_TAC "f_temp" THEN EXPAND_TAC "S_temp" THEN REWRITE_TAC[IMAGE]);;
e (REWRITE_TAC[IN; SUBSET; IN_ELIM_THM] THEN REPEAT STRIP_TAC);;
e (EXISTS_TAC `e':real^3->bool,e'':real^3->bool,p:num->num`);;
e (ASM_REWRITE_TAC[]);;
e (EXISTS_TAC `e':real^3->bool` THEN 
   EXISTS_TAC `e'':real^3->bool` THEN EXISTS_TAC `p:num->num`);;
e (ASM_REWRITE_TAC[]);;


e (MATCH_MP_TAC (REAL_ARITH `(?s. x <= s /\ s <= b) ==> x <= b`));;
e (ABBREV_TAC `S_temp = {e',e'',p | (e':real^3->bool) IN K1 /\ e'' IN K1 /\
                         p permutes 0..3}`);;
e (ABBREV_TAC 
  `f_temp = (\(e':real^3->bool,e'':real^3->bool,p). 
              e',e'',p, (left_action_list p (ul':(real^3)list)))`);;
e (EXISTS_TAC `& (CARD (IMAGE  (f_temp:(real^3->bool)#(real^3->bool)#(num->num)->(real^3->bool)#(real^3->bool)#(num->num)#(real^3)list) S_temp)) * &100`);;

e (STRIP_TAC);;
e (REWRITE_TAC[REAL_ARITH `a * &100 <= b * &100 <=> a <= b`]);;
e (REWRITE_TAC[REAL_OF_NUM_LE]);;
e (MATCH_MP_TAC CARD_SUBSET);;
e (STRIP_TAC);;
e (EXPAND_TAC "f_temp" THEN EXPAND_TAC "S_temp" THEN REWRITE_TAC[IMAGE]);;
e (REWRITE_TAC[IN; SUBSET; IN_ELIM_THM] THEN REPEAT STRIP_TAC);;
e (EXISTS_TAC `e':real^3->bool,e'':real^3->bool,p:num->num`);;
e (ASM_REWRITE_TAC[]);;
e (EXISTS_TAC `e':real^3->bool` THEN 
   EXISTS_TAC `e'':real^3->bool` THEN EXISTS_TAC `p:num->num`);;
e (ASM_REWRITE_TAC[]);;

e (MATCH_MP_TAC FINITE_IMAGE);;
e (REWRITE_WITH `S_temp = {e':real^3->bool,u | e' IN K1 /\ 
                           u IN {e'', p | e'' IN K1 /\p permutes 0..3}}`);;
e (EXPAND_TAC "S_temp");;
e (SET_TAC[]);;
e (ABBREV_TAC `K2 = {e'':real^3->bool, p | e'' IN K1 /\p permutes 0..3}`);;
e (MATCH_MP_TAC FINITE_PRODUCT);;
e (ASM_REWRITE_TAC[]);;

e (REWRITE_WITH 
  `K2 = {e'':real^3->bool,p | e'' IN K1 /\ p IN {p | p permutes 0..3}}`);;
e (EXPAND_TAC "K2" THEN SET_TAC[]);;
e (MATCH_MP_TAC FINITE_PRODUCT);;
e (ASM_REWRITE_TAC[]);;
e (REWRITE_TAC[GSYM NUMSEG_LE; ARITH_RULE `a <= 3 <=> a < 4`;
   Marchal_cells_2_new.SET_OF_0_TO_3;  
   Upfzbzm_support_lemmas.FINITE_PERMUTE_4]);;

e (MATCH_MP_TAC (REAL_ARITH `(?s. x <= s /\ s <= b) ==> x <= b`));;
e (EXISTS_TAC 
  `& (CARD (S_temp:(real^3->bool)#(real^3->bool)#(num->num)->bool)) * &100`);;
e (STRIP_TAC);;
e (REWRITE_TAC[REAL_ARITH `a * &100 <= b * &100 <=> a <= b`]);;
e (REWRITE_TAC[REAL_OF_NUM_LE]);;
e (MATCH_MP_TAC CARD_IMAGE_LE);;
e (REWRITE_WITH `S_temp = {e':real^3->bool,u | e' IN K1 /\ 
                           u IN {e'', p | e'' IN K1 /\p permutes 0..3}}`);;
e (EXPAND_TAC "S_temp");;
e (SET_TAC[]);;
e (ABBREV_TAC `K2 = {e'':real^3->bool, p | e'' IN K1 /\p permutes 0..3}`);;
e (MATCH_MP_TAC FINITE_PRODUCT);;
e (ASM_REWRITE_TAC[]);;

e (REWRITE_WITH 
  `K2 = {e'':real^3->bool,p | e'' IN K1 /\ p IN {p | p permutes 0..3}}`);;
e (EXPAND_TAC "K2" THEN SET_TAC[]);;
e (MATCH_MP_TAC FINITE_PRODUCT);;
e (ASM_REWRITE_TAC[]);;
e (REWRITE_TAC[GSYM NUMSEG_LE; ARITH_RULE `a <= 3 <=> a < 4`;
   Marchal_cells_2_new.SET_OF_0_TO_3;  
   Upfzbzm_support_lemmas.FINITE_PERMUTE_4]);;

e (REWRITE_WITH `S_temp = {e':real^3->bool,u | e' IN K1 /\ 
                           u IN {e'', p | e'' IN K1 /\p permutes 0..3}}`);;
e (EXPAND_TAC "S_temp");;
e (SET_TAC[]);;
e (ABBREV_TAC `K2 = {e'':real^3->bool, p | e'' IN K1 /\p permutes 0..3}`);;
e (REWRITE_WITH `CARD {e':real^3->bool,u:(real^3->bool)#(num->num) | 
                            e' IN K1 /\ u IN K2} = CARD K1 * CARD K2`);;
e (MATCH_MP_TAC CARD_PRODUCT);;
e (ASM_REWRITE_TAC[]);;

e (REWRITE_WITH 
  `K2 = {e'':real^3->bool,p | e'' IN K1 /\ p IN {p | p permutes 0..3}}`);;
e (EXPAND_TAC "K2" THEN SET_TAC[]);;
e (MATCH_MP_TAC FINITE_PRODUCT);;
e (ASM_REWRITE_TAC[]);;
e (REWRITE_TAC[GSYM NUMSEG_LE; ARITH_RULE `a <= 3 <=> a < 4`;
   Marchal_cells_2_new.SET_OF_0_TO_3;  
   Upfzbzm_support_lemmas.FINITE_PERMUTE_4]);;

e (REWRITE_WITH `CARD (K2:(real^3->bool)#(num->num)->bool) = 
                 CARD (K1:(real^3->bool)->bool) * CARD {p | p permutes 0..3}`);;
e (REWRITE_WITH 
  `K2 = {e'':real^3->bool,p | e'' IN K1 /\ p IN {p | p permutes 0..3}}`);;
e (EXPAND_TAC "K2" THEN SET_TAC[]);;
e (MATCH_MP_TAC CARD_PRODUCT);;
e (ASM_REWRITE_TAC[]);;
e (REWRITE_TAC[GSYM NUMSEG_LE; ARITH_RULE `a <= 3 <=> a < 4`;
   Marchal_cells_2_new.SET_OF_0_TO_3;  
   Upfzbzm_support_lemmas.FINITE_PERMUTE_4]);;
e (REWRITE_WITH `CARD (K1:(real^3->bool)->bool) = 16`);;

e (REWRITE_WITH `16 = 2 EXP (CARD (set_of_list (ul:(real^3)list)))`);;
e (REWRITE_WITH `CARD (set_of_list (ul:(real^3)list)) = 3 + 1`);;
e (MATCH_MP_TAC BARV_CARD_LEMMA);;
e (EXISTS_TAC `V:real^3->bool` THEN ASM_REWRITE_TAC[]);;
e (ARITH_TAC);;
e (EXPAND_TAC "K1");;
e (MATCH_MP_TAC CARD_POWERSET);;
e (ASM_REWRITE_TAC[set_of_list; Geomdetail.FINITE6]);;
e (REWRITE_WITH `CARD {p | p permutes 0..3} = FACT (CARD (0..3))`);;
e (MATCH_MP_TAC CARD_PERMUTATIONS);;
e (REWRITE_TAC[FINITE_NUMSEG]);;
e (REWRITE_TAC[CARD_NUMSEG; ARITH_RULE `16 * 16 * FACT ((3 + 1) - 0) = 6144`]);;

e (REAL_ARITH_TAC);;

let BOUND_BETA_BUMP = top_thm();;





