(* 
   Build file for Flyspeck project.

   the system dependent string flyspeck should be set to the "text_formalization" path.
   For example, on my system, I have added a line to my .bashrc file
   export FLYSPECK_DIR="$HOME/Desktop/flyspeck_google/source/text_formalization"

 *)

let flyspeck_dir = 
  (try Sys.getenv "FLYSPECK_DIR" with Not_found -> Sys.getcwd());;

let fullpath s = Filename.concat flyspeck_dir s;;


(* track constants by file *)

let findpos = 
  let rec findpos' c l a = match l with
      [] -> failwith "find"
    | b::bs -> if Pervasives.compare a b = 0 then c else findpos' (c+1) bs a
  in findpos' 0;;

let rec sublist t a b = match t with
   [] -> []
  | t0::ts -> if (a>0) then sublist ts (a-1) (b-1) else if (b<=0) then [] else t0::sublist ts 0 (b-1);;

let range_by_table c m s = 
  try(
    let r = assoc s m in
    let i = findpos m (s,r) in
    let start = if (i<=0) then 0 else (let (_,j) = List.nth m (i-1) in j) in
      sublist c start r)
  with Failure "find" -> [];;

let rec rev_assoc_sorted t i = match t with
   [] -> failwith "find"
  | (x,j)::ts -> if (i>=j) then rev_assoc_sorted ts i else x;;

(* new reference to track constants by included file *)
let ftable = ref [("pervasives",List.length (constants()))];;

(* Example: constants_by_file "trigonometry/trig1.hl" *)
let constants_by_file   = fun s -> range_by_table (constants()) (!ftable) s;;

(* Example: file_of_constant "packing" *)
let file_of_constant s = 
   let cs = map fst (constants()) in
   try (let i = findpos cs s in rev_assoc_sorted (List.rev (!ftable)) i)
   with Failure "find" -> "Constant not located";;


(* limit changes in the state of the proof assistant  *)

let CHEAT_TAC = FAIL_TAC "cheaters never prosper";;
let new_axiom _ = failwith "new_axiom has been disabled";; 

let (partially_restore_state:string->unit) =
  let (rewrites,conversions) = (basic_rewrites(),basic_convs()) in
  fun s ->
   (
       current_goalstack := ([]:goalstack);
       if not(List.length(axioms()) =3) then failwith ("Illegal axioms added by "^s); 
       prioritize_real();
       if not(basic_rewrites()=rewrites) then set_basic_rewrites rewrites;
       if not(basic_convs()==conversions) then set_basic_convs conversions  
   );;

partially_restore_state "build";;

let fileid s = 
  let s' = file_on_path (!load_path) (fullpath s) in
    (Filename.basename s',Digest.file s');;

let host = ref (fileid "build.hl");;
let depend = ref ([]:((string*Digest.t)*(string*Digest.t)) list);; (* dependency table *)

let flyspeck_needs s = 
  let id = fileid s in 
    if (List.mem id (!loaded_files))
    then Format.print_string("File \""^s^"\" already loaded\n")
    else
      (
        if List.mem (!host,id) (!depend) then failwith "There may be circular needs.";
	depend := (!host,id)::(!depend);
	(let h = (!host) in host := id; needs (fullpath s); host := h);
        ftable:= (s,List.length(constants()))::(!ftable);
	partially_restore_state s;
      );;


(* HOL LIGHT *)
hol_version;;
needs "Multivariate/flyspeck.ml";;

(* utilities *)
flyspeck_needs "general/print-types.ml";;
flyspeck_needs  "general/update_database_310.ml";;
flyspeck_needs "general/prove_by_refinement.hl";;

(* general *)
flyspeck_needs  "general/sphere.hl";;

(* lemmas in geometry *)
flyspeck_needs "leg/geomdetail.hl";;
flyspeck_needs "leg/affprops.hl";;
flyspeck_needs "leg/cayleyR_def.hl";;
flyspeck_needs  "leg/collect_geom.hl";;


(* slow, and not generally needed. contains NUHSVLM on cayleyR:*)
(* flyspeck_needs  "leg/collect_geom2.hl";;  *)

(* nonlinear *)
flyspeck_needs  "nonlinear/ineq.hl";;
flyspeck_needs  "nonlinear/ineqdata3q1h.hl";;

(* trigonometry *)
flyspeck_needs  "trigonometry/trig1.hl";;
flyspeck_needs  "trigonometry/trig2.hl";;
flyspeck_needs  "trigonometry/trigonometry.hl";;

(* volume *)
flyspeck_needs  "volume/vol1.hl";;

(* build to here *)
(* flyspeck_needs  "volume/vol2.hl";; *)
flyspeck_needs  "volume/volume.hl";;

(* hypermap *)
flyspeck_needs  "hypermap/hypermap.ml";;

(* fan *)
flyspeck_needs  "fan/fan.ml";;
flyspeck_needs  "fan/fan_summary.hl";;

(* packing *)
flyspeck_needs  "packing/formulation.ml";;

(* local fan -- no files *)


(* tame *)
