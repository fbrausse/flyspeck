
(* PROOFS *)

let eta_atn = prove_by_refinement(
  `!x1 x2 x3 x4 x5 x6.
(&0 < x1 /\ &0 < x2 /\ &0 < x6 ==>    eta2_126 x1 x2 x3 x4 x5 x6 = eta_x x1 x2 x6 pow 2) /\
(&0 < x1 /\ &0 < x3 /\ &0 < x5 ==>    eta2_135 x1 x2 x3 x4 x5 x6 = eta_x x1 x3 x5 pow 2) /\
(&0 < x4 /\ &0 < x5 /\ &0 < x6 ==>    eta2_456 x1 x2 x3 x4 x5 x6 = eta_x x4 x5 x6 pow 2 )
`,
  (* {{{ proof *)
  [
  REPEAT WEAKER_STRIP_TAC;
  REWRITE_TAC[Functional_equation.functional_eta2_135;Functional_equation.functional_eta2_456];
  INTRO_TAC Functional_equation.functional_eta2_126 [];
  REWRITE_TAC[domain6;Sphere.rotate3;Sphere.rotate4];
  ASM_SIMP_TAC[arith `&0 < x ==> &0 <= x`];
  DISCH_THEN kill;
  REWRITE_TAC[uni;Nonlin_def.rotate126;Nonlin_def.promote3_to_6;compose6;proj_x1;proj_x2;proj_x6;Nonlin_def.pow2];
  BY(MESON_TAC[Collect_geom.ETA_X_SYMM])
  ]);;
  (* }}} *)

let arclength_x1x1' = prove_by_refinement(
  `!x1 x2 x3 x4 x5 x6 a b.
    &2 <= a /\ a <= &4 /\ &2 <= b /\ b <= &4 /\ &4 <= x1 /\ x1 <= &16 ==>
    arclength_x1 a b x1 x2 x3 x4 x5 x6 = arclength_x1' a b x1 x2 x3 x4 x5 x6`,
  (* {{{ proof *)
  [
  REPEAT WEAKER_STRIP_TAC;
  MATCH_MP_TAC Functional_equation.arclength_x1';
  TYPIFY `&2 <= sqrt x1 /\ sqrt x1 <= &4` (C SUBGOAL_THEN ASSUME_TAC);
    CONJ_TAC;
      MATCH_MP_TAC REAL_LE_RSQRT;
      BY(ASM_TAC THEN REAL_ARITH_TAC);
    TYPIFY `&4 = sqrt (&16)` (C SUBGOAL_THEN SUBST1_TAC);
      REWRITE_TAC[arith `&16 = &4 * &4`];
      GMATCH_SIMP_TAC Nonlinear_lemma.sqrtxx;
      BY(REAL_ARITH_TAC);
    GMATCH_SIMP_TAC SQRT_MONO_LE_EQ;
    BY(ASM_TAC THEN REAL_ARITH_TAC);
  BY(ASM_TAC THEN REAL_ARITH_TAC)
  ]);;
  (* }}} *)

let muR_alt = prove_by_refinement(
  `!y1 y2 y3 y4 y5 y6 y7 y8 y9.
         muR y1 y2 y3 y4 y5 y6 y7 y8 y9  =
         cayleyR (y6 * y6) (y5 * y5) (y1 * y1) (y7 * y7) (y4 * y4) (y2 * y2)
         (y8 * y8)
         (y3 * y3)
         (y9 * y9)
         `,
  (* {{{ proof *)
  [
    BY(REWRITE_TAC[FUN_EQ_THM;Mur.muR])
  ]);;
  (* }}} *)

let quad_cross_diag2_x_cayleyR = prove_by_refinement(
  `!x1 x2 x3 x4 x5 x6 x7 x8 x9.  
    &0 <= x1 /\
    &0 <= x2 /\
    &0 <= x3 /\
    &0 <= x4 /\
    &0 <= x5 /\
    &0 <= x6 /\
    &0 <= x7 /\
    &0 <= x8 /\
    &0 <= x9 ==>
    quad_cross_diag2_x x1 x2 x3 x4 x5 x6 x7 x8 x9 = 
	sqrt(quadratic_root_plus (abc_of_quadratic (cayleyR x3 x2 x1 x7 x4 x5 x8 x6 x9)))
`,
  (* {{{ proof *)
  [
  REWRITE_TAC[Enclosed.quad_cross_diag2_x;Enclosed.enclosed;muR_alt];
  BY(SIMP_TAC[Merge_ineq.sqrtpow2])
  ]);;
  (* }}} *)

let delta_test_1 = prove_by_refinement(
  `!x1 x2 x3 x4 x5 x6 y.  ~(&0 < delta_x x1 x2 x3 x4 x5 x6) /\ (&0 < y) ==>
   delta_x x1 x2 x3 x4 x5 x6 + unit6 x1 x2 x3 x4 x5 x6 * -- y < &0
   `,
  (* {{{ proof *)
  [
  REWRITE_TAC[Nonlin_def.unit6];
  BY(REAL_ARITH_TAC)
  ]);;
  (* }}} *)

let etest_1 = prove_by_refinement(
  `!x1 x2 x3 x4 x5 x6 y.  &0 < x1 /\ ~(&0 < delta_x x1 x2 x3 x4 x5 x6) /\ (&0 < y) ==>
   x1_delta_x x1 x2 x3 x4 x5 x6 * &4 +
     delta4_squared_x x1 x2 x3 x4 x5 x6 * -- y <
     &0`,
  (* {{{ proof *)
  [
  REWRITE_TAC[Nonlin_def.unit6];
  BY(REAL_ARITH_TAC)
  ]);;
  (* }}} *)

(*
let etest i = 
  let odom = ([6.;4.;4.;8.;4.;4.],[8.; 7.; 7.; 25.; 7.;7.]) in
  let t = concl (h1 i) in
  let (a,b) = ocaml_domain t in
  let (_,_,fs) = Optimize.dest_ineq t in
    include_domain (a,b) odom && 
   exists (has_match `x1_delta_x x1 x2 x3 x4 x5 x6 * &4 +
     delta4_squared_x x1 x2 x3 x4 x5 x6 * -- y <
     &0`) fs;;

let ftest i  = 
  let odom = ([4.;4.;4.;9.;9.;9.],[6.3504; 6.3504; 6.3504; 15.328;15.328;15.328]) in
  let t = concl (h1 i) in
  let (a,b) = ocaml_domain t in
  let (_,_,fs) = Optimize.dest_ineq t in
    include_domain (a,b) odom && 
      exists (has_match `eulerA_x x1 x2 x3 x4 x5 x6 < &0`) fs;;

let delta_x_pos = 
  let dx = `(delta_x x1 x2 x3 x4 x5 x6 * -- &1 < &0)` in
  let p1 = !Prep.prep_ineqs in
    filter (fun t ->  
	      let i = t.ineq in
	      let (inq,d,f) = simple_dest_ineq i in
		f = dx) p1;;

map (rhs o concl o REAL_RAT_REDUCE_CONV) (map (fun t -> t.ineq) delta_x_pos);;
REAL_RAT_REDUCE_CONV;;

let h1 = 
  let i1 = map (get_nth) (map (fun t -> Random.int 5070) (0--80)) in
    fun k -> (ASSUME (snd(strip_forall (List.nth i1 k))));;

*)





let domain6_assum = prove_by_refinement(
  `!h g f. domain6 h f g ==> (F ==> (f = g))`,
  (* {{{ proof *)
  [
  MESON_TAC[]
  ]);;
  (* }}} *)

  let strip_domain6 thm = 
    try 
      UNDISCH (MATCH_MP domain6_assum (SPEC_ALL thm))
    with Failure _ -> thm;;



(* ignore domain6 constraints *)

(* expand is in prep_def.hl *)

  let rewrite_to_cpp_library_functions = map strip_domain6 
   exp2;;   

expand_nodomain;;

  let test k = 
    let u = REWRITE_RULE rewrite_to_cpp_library_functions
     (h1 k) in
    let v = REWRITE_RULE (rewrite_to_cpp_library_functions @ [Sphere.rotate2;Sphere.rotate3;Sphere.rotate4;Sphere.rotate5;Sphere.rotate6]) u in
       (concl v);;

  let ptest k = const_names (test k);;


ptest 50;;
map ptest (100--200);;
it;;
sz;;
filter (fun i ->  (ptest i = [])) (0--100);;

ptest 328;;
Sphere.norm2hh_x;;
map (concl o h1) [595;597;599;601;778; 779; 783];;
[595; 597; 599; 601; 778; 779; 783];; (* quad cases *)

  let uu = List.flatten it;;


let cons1 = (map (const_types o test) (100--200));;
let cons = (map (const_types o test) (0--(List.length !Prep.prep_ineqs - 1)));;
let nubcons = Flyspeck_lib.nub cons;;
let z1 = zip !Prep.prep_ineqs cons;;
let z2 = filter (fun (_,c) -> mem "sol_x" c) z1;;
List.length !Prep.prep_ineqs;;
map (fun (t,_) -> t.idv) z2;;

let has_const x i = 
  mem x (const_types (test i));;

filter (has_const "sol_y") (0--30);;

test 1;;

Sphere.hminus;;

(*old*)
  let rewrite_to_cpp_library_functions = map strip_domain6 [
Sphere.ineq;
    Sphere.gchi;
   Functional_equation.uni;
Functional_equation.functional_vol_x;
Functional_equation.functional_dih2_x;
Functional_equation.functional_dih3_x;
Functional_equation.functional_dih4_x;
Functional_equation.functional_dih5_x;
Functional_equation.functional_dih6_x;
Functional_equation.functional_gchi1_x;
Functional_equation.functional_gchi2_x;
Functional_equation.functional_gchi3_x;
Functional_equation.functional_gchi4_x;
Functional_equation.functional_gchi5_x;
Functional_equation.functional_gchi6_x;
Functional_equation.functional_ldih2_x;
Functional_equation.functional_ldih3_x;
Functional_equation.functional_eulerA_x;
Functional_equation.functional_sol156_euler_x_div_sqrtdelta;
Functional_equation.functional_sol246_euler_x_div_sqrtdelta;
Functional_equation.functional_sol345_euler_x_div_sqrtdelta;
   Functional_equation.add6;
   Functional_equation.sub6;
   Functional_equation.mul6;
   Functional_equation.div6;
   Functional_equation.mk_126;
   Functional_equation.mk_135;
   Functional_equation.mk_456;
   Nonlinear_lemma.proj_x1;
   Nonlinear_lemma.proj_x2;
   Nonlinear_lemma.proj_x3;
   Nonlinear_lemma.proj_x4;
   Nonlinear_lemma.proj_x5;
   Nonlinear_lemma.proj_x6;
   Functional_equation.compose6;
   Functional_equation.functional_rotate2;
   Functional_equation.functional_rotate3;
   Functional_equation.functional_rotate4;
   Functional_equation.functional_rotate5;
   Functional_equation.functional_rotate6;
   Functional_equation.proj_y1;
   Functional_equation.functional_proj_y2;
   Functional_equation.functional_proj_y3;
   Functional_equation.functional_proj_y4;
   Functional_equation.functional_proj_y5;
   Functional_equation.functional_proj_y6;
Functional_equation.functional_delta_126_x;
Functional_equation.functional_delta_234_x;
Functional_equation.functional_delta_135_x;
Nonlin_def.flat_term2_135_x;Nonlin_def.flat_term2_234_x;
Functional_equation.functional_mud_135_x;Functional_equation.functional_mud_126_x;
Functional_equation.functional_mud_234_x;
Functional_equation.functional_ldih2_x_div_sqrtdelta_posbranch; 
Functional_equation.functional_ldih3_x_div_sqrtdelta_posbranch; 
Functional_equation.functional_ldih5_x_div_sqrtdelta_posbranch; 
Functional_equation.functional_ldih6_x_div_sqrtdelta_posbranch; 
(*   Sphere.delta_x; *)
Functional_equation.functional_ldih_x_div_sqrtdelta_posbranch;
Functional_equation.functional_sol_euler_x_divsqrtdelta;
Functional_equation.functional_dih_x_div_sqrtdelta_posbranch;
Functional_equation.functional_rhazim_x;
Functional_equation.functional_rhazim2_x;
Functional_equation.functional_rhazim3_x;
    Functional_equation.rh0;
Functional_equation.functional_delta4_squared_x;
Functional_equation.functional_x1_delta_x;
Functional_equation.functional_tau_residual;
Nonlin_def.mu6_x;Functional_equation.taud_x_ALT;
Nonlin_def.taud_D2_num_x;Nonlin_def.taud_D1_num_x;
Functional_equation.functional_edge2_126_x;Functional_equation.functional_edge2_135_x;
Functional_equation.functional_edge2_234_x;
Nonlin_def.flat_term2_126_x;Nonlin_def.flat_term2_135_x;Nonlin_def.flat_term2_234_x;
Functional_equation.functional_delta_x1;
    REWRITE_RULE[Sphere.flat_term] Sphere.flat_term_x;
Functional_equation.functional_rhazim_x_div_sqrt_delta_posbranch;
Functional_equation.functional_rhazim2_x_div_sqrt_delta_posbranch;
Functional_equation.functional_rhazim3_x_div_sqrt_delta_posbranch;
Nonlin_def.mudLs_234_x;Nonlin_def.mudLs_126_x;
Nonlin_def.mudLs_135_x;
Functional_equation.functional_taum_x;
Functional_equation.functional_dnum1;
Nonlinear_lemma.halfbump_x;
Functional_equation.functional_halfbump_x1;
Functional_equation.functional_halfbump_x4;
Functional_equation.functional_asn797k;
Functional_equation.functional_asnFnhk;
Functional_equation.functional_acs_sqrt_x1_d4;
   Sphere.arc_hhn;
Functional_equation.functional_arclength_x1;
REWRITE_RULE[LET_DEF;LET_END_DEF] Functional_equation.functional_arclength_x_123;
Functional_equation.vol3f_456;
Functional_equation.functional_vol3_x_sqrt;
Functional_equation.functional_vol3f_x_sqrt2_lmplus;
Functional_equation.functional_vol3f_x_lfun;
Functional_equation.functional_eta2_135;
Functional_equation.functional_eta2_456;
Functional_equation.gamma3_x;
Functional_equation.gamma23_full8_x;
Functional_equation.gamma23_keep135_x;
Functional_equation.gamma3f_x_div_sqrtdelta_alt;
Functional_equation.functional_dih4_x_div_sqrtdelta_posbranch;
Functional_equation.functional_ldih6_x;
Functional_equation.functional_ldih_x;
   Functional_equation.functional_norm2hh_x;
     Nonlin_def.unit6;Sphere.rad2_x;Sphere.y_of_x;Sphere.rho_x;
(*  Sphere.dih_x; *)
Sphere.const1;Sphere.delta_x4;Nonlin_def.scalar6;
    ];;

(* prep.hl, removed conditional rewrites, delta_x, atn2 *)

  let ready = ["prep-2125338128"; ];;

  let dependency = [("prep-2445657182",["prep-2445657182"])];;
		    
st 2 [`mudLs_135_x`];;
st 5 [def "mu_y"];;
let ineq_4_799_8 =  (REWRITE_CONV[GSYM Nonlinear_lemma.ineq_expand6]) (concl (SPEC_ALL delta_min_corner_4_799_8));;
Nonlinear_lemma.ineq_expand6;;
