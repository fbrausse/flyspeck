open Counting_spheres;;
open Hales_tactic;;

let CALC_ID_TAC = Calc_derivative.CALC_ID_TAC;;
(*
let CALC_ID_TAC (asl,t) =  (MATCH_MP_TAC (Calc_derivative.rational_identity t) (asl,t));;
*)

let DLWCHEM_concl = `!V. packing V /\ packing_ineq_def_a /\
  V SUBSET ball_annulus /\ ~(lmfun_ineq_center V) ==>
   (CARD V = 13 \/ CARD V = 14 \/ CARD V = 15)`;;


let XULJEPR_concl = `!V. packing V /\ V SUBSET ball_annulus /\ packing_ineq_def_a /\
 (?v.  v IN V /\ norm (v) = &2 /\ (!u.  (u IN V) /\ ~(u = v) ==> &2 * h0 <= dist(u,v) ))
==> (lmfun_ineq_center V)`;;


(* ========================================================================== *)
(* COMPLETED LEMMAS  *)
(* ========================================================================== *)

(* ========================================================================== *)
(* WORK IN PROGRESS *)
(* ========================================================================== *)



let CONE0_SUBSET_WEDGE = prove_by_refinement(
  `!u0 u1 u w.
    (collinear {vec0,u0,u1}) /\
    ~(u0 =  u1) ==>
    cone0 (vec 0) {u0,u,w} SUBSET wedge u0 u1 u w`,
  (* {{{ proof *)
  [
  #
  ]);;
  (* }}} *)


(* mixed up u0 u1 and vec 0 *)

(*
let gotcjah_sol_lemma = prove_by_refinement(
  `!c3 v b P W t rho bet u u0 u1 u2 w.
    polyhedron P /\ bounded P /\ (&0 < b) /\
    (vec 0 IN interior P) /\
    (c3 facet_of P) /\
    (fchanged c3 = W) /\
    (&0 < t /\ t < &1 ) /\
    (&0 < rho) /\
    (c3 = P INTER { p | p dot v = b } /\ rcone_gt (vec 0) v t SUBSET W) /\
    (b / (v dot v ) % v = u0) /\
    ~(v = vec 0) /\
    ~(u1 = u0) /\
    ~(u2 = u0) /\
    &0 < v dot v /\
    u0 IN rcone_gt (vec 0 ) v t /\
    u0 IN c3 /\
    cos (arcV(vec 0) u0 w) = t /\
    cos (arcV(vec 0) u0 w) = t /\
    u IN c3 /\
    v IN c3 /\
    w IN c3 /\
    azim u0 u1 u w / &2 = bet /\
    &0 < azim u0 u1 u w /\
    azim u0 u1 u w < pi /\
    azim u0 u1 u2 u < azim u0 u1 u2 w /\
    azim u0 u1 u v = bet /\
    azim u0 u1 v w = bet /\
    (u - u0) dot (v - u) = &0 /\
    (w - u0) dot (v - w) = &0 /\
    ~(u = u0) /\
    ~(v = u0) /\
    ~(w = u0) /\
    azim u0 u1 u w < pi ==>
    (?X.  X SUBSET (wedge u0 u1 u w INTER W) /\
       measurable (X INTER normball (vec 0) rho) /\
       radial_norm rho (vec 0) (X INTER normball (vec 0) rho) /\
       &2 * (bet - asn (sin bet * t)) <= sol (vec 0) X)
`,
  (* {{{ proof *)
  [
str/r
exist (% `cone0 (vec 0) {u0,u,v} UNION cone0 (vec 0) {u0,v,w}`)
comment "cone0 subset ... "
sgth (%` cone0 (vec 0) {u0,u,v} SUBSET wedge u0 u1 u v`) assume


subconj 
rt [ UNION_SUBSET ; SUBSET_INTER]
mmp (taut `(a /\ c) /\ (b /\ d) ==> (a /\ b) /\ c /\ d`)
conj
## (* UNFINISHED *)
  ]);;
  (* }}} *)
*)

let gotcjah_sol_lemma = prove_by_refinement(
  `!c3 v v0 b P W t rho bet w0 w1 w2.
    polyhedron P /\ bounded P /\ (&0 < b) /\
    (vec 0 IN interior P) /\
    (c3 facet_of P) /\
    (fchanged c3 = W) /\
    (&0 < t /\ t < &1 ) /\
    (&0 < rho) /\
    (c3 = P INTER { p | p dot v = b } /\ rcone_gt (vec 0) v t SUBSET W) /\
    (b / (v dot v ) % v = (vec 0)) /\
    ~(v = vec 0) /\
    &0 < v dot v /\
    v0 IN rcone_gt (vec 0 ) v t /\
    v0 IN c3 /\
    cos (arcV(vec 0) v0 w0) = t /\
    cos (arcV(vec 0) v0 w2) = t /\
    w0 IN c3 /\
    w1 IN c3 /\
    w2 IN c3 /\
    ~(w0 = u0) /\ ~(w1 = u0) /\ ~(w2 = u0) /\
    azim (vec 0) v w0 w2 / &2 = bet /\
    &0 < azim (vec 0) v w0 w2 /\
    azim (vec 0) v w0 w2 < pi /\
    azim (vec 0) v w0 w1 = bet /\
    azim (vec 0) v w1 w2 = bet /\
    (w0 - v0) dot (w1 - w0) = &0 /\
    (w2 - v0) dot (w1 - w2) = &0 /\
  ==>
    (?X.  X SUBSET (wedge (vec 0) v w0 w2 INTER W) /\
       measurable (X INTER normball (vec 0) rho) /\
       radial_norm rho (vec 0) (X INTER normball (vec 0) rho) /\
       &2 * (bet - asn (sin bet * t)) <= sol (vec 0) X)
`,
  (* {{{ proof *)
  [
## (* UNFINISHED *)
  ]);;


let GOTCJAH_concl = `!c v b P  WF t n. 
    polyhedron P /\ bounded P /\  (&0 < b) /\
    (vec 0 IN interior P) /\ 
    c facet_of P /\ 
    fchanged c = WF /\
    (&0 < t /\ t < &1) /\
    (c = P INTER { p | p dot v = b } /\ rcone_gt (vec 0) v t SUBSET WF) /\
    ( {u | u facet_of c } HAS_SIZE n) 
   ==> &2 * pi - &2* &n * asn (t* sin(pi/ &n)) <= sol (vec 0)  WF`;;

let GOTCJAH = prove_by_refinement(
  GOTCJAH_concl,
  (* {{{ proof *)
  [
  X_GENv_TAC "c3";
  REPEAT WEAK_STRIP_TAC;
  ABBREV_TAC (`A = { (p:real^3) | p dot v = b}`);
  ABBREV_TAC `u0 = (b / (v dot v)) % (v:real^3)`;
  SUBGOAL_THEN `~((v:real^3) = vec 0)` ASSUME_TAC;
    DISCH_TAC;
    HASH_UNDISCH_TAC 2896;
    ASM_REWRITE_TAC[DOT_RZERO];
    REWRITE_TAC[ FUN_EQ_THM ;IN_ELIM_THM];
    DISCH_TAC;
    (fun (asl,w) -> (SUBGOAL_THEN ( env (asl,w)`A = {}`) ASSUME_TAC) (asl,w));
      BY(REPEAT (FIRST_X_ASSUM MP_TAC) THEN SET_TAC[arith `&0 < b ==> ~(&0 = b)`]);
    (fun (asl,w) -> (SUBGOAL_THEN ( env (asl,w)`c3 = {}`) ASSUME_TAC) (asl,w));
      BY(REPEAT (FIRST_X_ASSUM MP_TAC) THEN SET_TAC[]);
    BY(ASM_MESON_TAC[ facet_of ]);
  COMMENT "1";
  COMMENT "v dot v";
  SUBGOAL_THEN `&0 < (v:real^3) dot v` ASSUME_TAC;
    BY(ASM_REWRITE_TAC[DOT_POS_LT]);
  COMMENT "subgoal";
  SUBGOAL_THEN `(u0:real^3) IN rcone_gt (vec 0) v t` ASSUME_TAC;
    REWRITE_TAC[rcone_gt ; rconesgn ; IN_ELIM_THM ; VECTOR_SUB_RZERO ; DIST_0 ];
    EXPAND_TAC "u0";
    REWRITE_TAC[ DOT_LMUL ];
    REWRITE_TAC[ NORM_MUL ];
    REWRITE_TAC[ GSYM NORM_POW_2 ];
    REWRITE_TAC[ arith `x pow 2 = x * x`];
    REWRITE_TAC[ arith `x > y <=> y < x`];
    (fun (asl,w) -> (SUBGOAL_THEN ( env (asl,w)`abs (b / (norm v * norm v)) = b / (norm v * norm v)`) SUBST1_TAC) (asl,w));
      MATCH_MP_TAC Trigonometry2.LT_IMP_ABS_REFL;
      MATCH_MP_TAC REAL_LT_DIV;
      BY(ASM_MESON_TAC [ NORM_POW_2 ; arith `x pow 2 = x * x` ]);
    REWRITE_TAC[ arith `(a * b) * c = a * (b * c)`];
    REWRITE_TAC[ arith `x * x = x pow 2`; NORM_POW_2 ; arith `a * b * c * d = a * (b * c) * d`];
    MATCH_MP_TAC REAL_LT_LMUL;
    CONJ_TAC;
      BY(ASM_MESON_TAC [ REAL_LT_DIV ]);
    REWRITE_TAC[ arith `a * t < a <=> &0 < a * (&1 - t)`];
    BY(ASM_MESON_TAC [ REAL_LT_MUL ; arith `t < &1 <=> &0 < &1 - t`])
  COMMENT "u0";
  SUBGOAL_THEN `(u0:real^3) IN c3` ASSUME_TAC;
    ENOUGH_TO_SHOW_TAC `(u0:real^3) IN fchanged c3 /\ (u0 IN affine hull c3)`;
      REWRITE_TAC[ GSYM IN_INTER];
      BY(ASM_MESON_TAC[FCHANGED_AFFINE; SUBSET; IN; RELATIVE_INTERIOR_SUBSET ]);
    CONJ_TAC;
      BY(ASM_MESON_TAC[SUBSET; IN]);
    GOAL_TERM (fun w -> (MP_TAC (ISPECL ( envl w[`P`;`c3`;`v`;`b`]) Counting_spheres.affine_facet_hyper )));
    ANTS_TAC;
      ASM_REWRITE_TAC[];
      CONJ_TAC;
        MATCH_MP_TAC Polyhedron.INTERIOR_AFFINIE_HUL_EQ_UNIV;
        BY(ASM_MESON_TAC[]);
      AP_TERM_TAC;
      EXPAND_TAC "A";
      MATCH_MP_TAC EQ_EXT;
      REWRITE_TAC[ IN_ELIM_THM ];
      BY(MESON_TAC[ DOT_SYM ]);
    DISCH_THEN SUBST1_TAC;
    REWRITE_TAC[ IN_ELIM_THM ];
    EXPAND_TAC "u0";
    REWRITE_TAC [ DOT_RMUL ];
    CALC_ID_TAC;
    BY(REPEAT (FIRST_X_ASSUM MP_TAC ) THEN REAL_ARITH_TAC)
 COMMENT "1";
  GOAL_TERM (fun w -> (MP_TAC (ISPECL ( envl w [`v`;`u0`;`b`;`t`]) RDISK_R)));
  ASM_REWRITE_TAC[];
  REPEAT WEAK_STRIP_TAC;
  ABBREV_TAC (`(s:(real^3->bool)->bool) = {u | u facet_of c3}`);
  SUBGOAL_THEN `?uperp. ~(uperp = vec 0) /\ ((v:real^3) dot uperp = &0)` MP_TAC;
    BY(ASM_MESON_TAC[ Trigonometry2.EXISTS_OTHOR_VECTOR_DIFFF_VEC0 ]);
  REPEAT WEAK_STRIP_TAC;
  ABBREV_TAC (`(u2:real^3) = u0 + uperp`);
  ABBREV_TAC (`(u1:real^3) = u0 + v`);

(* XXD to here *)
      mptac (specl (%% [`c3`;`A`;`n`;`s`;`r`;`u0`;`u1`;`u2`]) EUSOTYP_general)
      art[]
      alls [`INTER`]
      dthen (fun t -> assume (sym  t))
      art[]

#


  ]);;
  (* }}} *)


