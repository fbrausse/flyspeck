\chapter{Hypermap}\label{chap:hypermap}
\indy{Index}{hypermap}%

\section{Background on Permutations}

\begin{definition}[permutation]\guid{IFPQAWD}
A \newterm{permutation} $f$ on a set
  $D$ is a bijection $f:D\to D$.
\end{definition}

For example, the identity map $I_D$ on a set $D$,
\begin{displaymath}
I_D(x)=x \text{ for all } x \in D,
\end{displaymath}
 is a permutation.
If $f:D\to D$ is a permutation then there is an inverse function $f^{-1}:D\to D$
that is also a permuation.  
It satisfies
\begin{displaymath}
f f^{-1} = f^{-1} f = I_D.
\end{displaymath}
(This chapter uses product notation $f g$ for the composition of maps
$f\circ g$.)
If $D$ is a finite set, and two maps
$f,g:D\to D$ satisfy $f g = I_D$ on $D$, then $f$ and $g$ are permutations and are
inverses of one another:
\begin{displaymath}
f g = g f = I_D.
\end{displaymath}

Natural number powers  $f^k$ of a permutation $f:D\to D$ are defined
recursively by
\begin{displaymath}
f^0 = I_D,\quad\text{ and } f^{k+1} = f f^k.
\end{displaymath}
Integer powers $f^m$ of a permutation are defined as
$$f^m = f^i (f^{-1})^j,$$ where $m = i -j$.  This is well-defined.
The usual rule of exponents holds:
\begin{displaymath}
f^{a+b} = f^a f^b.
\end{displaymath}

If $f:D\to D$ is a permutation on a finite set $D$, then there is a smallest
positive integer $k$ such that $f^k=I_D$.  The integer $k$ is the \newterm{order}
of the permutation $f$.  If $f^m=I_D$ for any some $m$, then $m = k i$ for some
integer $i$, where $k$ is the order of $f$. The inverse $f^{-1} = f^k f^{-1} = f^{k-1}$ can be written as a
non-negative power of $f$.

A permutation $f$ of a finite set $D$ is \newterm{cyclic}, if the order of $f$ is the cardinality
of $D$.  A permutation $f$ is cyclic if and only if for every $x,y\in D$, there exists an integer $i$
such that $f^i x = y$.

The set of all permutations of the set $\{0,1,2,\ldots,k-1\}$ is written $\op{Sym}(k)$.
The set $\op{Sym}(k)$ is finite and has cardinality $k!$.



\section{Definitions}



\begin{definition}[hypermap,~dart]\guid{ZIHYYRA}\label{def:hypermap}  
  A hypermap is a finite set $D$, together with three functions
  $e,n,f:D\to D$ whose composition is the identity:
  \begin{displaymath}
e\ocirc n\ocirc f = I_D.
\end{displaymath} The
elements of $D$ are called \newterm{darts}.  The functions $e,n$ and
$f$ are called the \newterm{edge map}, the \newterm{node map}, and
the \newterm{face map}, respectively.  \indy{Index}{hypermap}%
\indy{Index}{dart}%
\indy{Index}{edge!map}%
\indy{Index}{node!map}%
\indy{Index}{face!map}%
\indy{Notation}{edgemapz@$e$ (edge map)}%
\indy{Notation}{nodemap@$n$ (node map)}%
\indy{Notation}{facemap@$f$ (face map)}%
\indy{Notation}{D@$D$ (dart)}%
\end{definition}

%\pdf{dart.pdf}{dart}{The arrowhead represents a dart.}
\begin{figure}[htb]
\centering
\szincludegraphics[width=2mm]{\pdfp/dart.eps}
\caption{This symbol represents a dart.}
\label{fig:dart}
\end{figure}

\begin{remark}[planar graphs as hypermaps]\guid{IVPJYAG}\tlabel{rem:hypermap} A hypermap is an abstraction of
the concept of 
planar graph.  Place a dart at each angle of a planar graph.
One function, $f$, 
cycles counterclockwise around the angles of each face.  
Another function, $n$, 
rotates counterclockwise around the angles at each
node.  A third function, $e$, pairs angles at opposite ends of
each edge  (Figure~\ref{fig:hypermap_ex}).   The hypermap extracts
the data $(D,e,n,f)$ from the planar graph and discards the rest.
\indy{Index}{planar graph}%
\end{remark}

\begin{figure}[htb]
\centering
\szincludegraphics[width=80mm]{\pdfp/hypermap-ex.eps}
\caption{Darts mark the angles of a planar graph.  Darts may
be permuted about faces, nodes, and edges.}
\label{fig:hypermap_ex}
\end{figure}

By the background on permutations, $e,n,f$ are all permutations on $D$.
A hypermap satisfies 
\begin{equation}\tlabel{eqn:triality}
e \ocirc n\ocirc f = n\ocirc f\ocirc e = f\ocirc e\ocirc n = I_D.
\end{equation}
Inverted, this triality becomes
\begin{displaymath}
n^{-1} \ocirc e^{-1} \ocirc f^{-1} = (f \ocirc e \ocirc n)^{-1} = I_D.
\end{displaymath}
This inversion is the abstract form of the the duality between nodes
and faces in a planar graph.  Because of these symmetries in the
defining relation, there will be multiple versions of theorems about
hypermaps, all obtained from one proof by symmetry.


\begin{definition}[path,~list,~sublist,~visit,~dart~set]\guid{RRQWGAY} 
Let $D$ be a set (of darts), and let $S$ be a set of permutations of $D$.
A \newterm{path} with \newterm{steps} in $S$
from $x_0$ to $x_{k-1}$ is a \newterm{list}\xfootnote{The empty path $[]$ seems
to have an ancient origin: ``This is the path made known to me
when I had learned to remove all darts.'' --The Dhammapada} of
darts $[x_0;x_1;\ldots;x_{k-1}]$ such that for each $i$, $x_{i+1} = h_i x_i$,
for some $h_i \in S$.   A \newterm{sublist} of a list is a consecutive
subsequence  $[x_i;x_{i+1};x_{i+1};\ldots;x_j]$, with $0\le i\le j\le k-1$.
A \newterm{unit list} is a list of the form $[x]$.  A
path is \newterm{injective} if $x_i=x_j$ implies $i=j$. 
The \newterm{dart set} of $L$ is $\{x_0,x_1,\ldots,x_{k-1}\}$.  A path \newterm{visits}
a dart $x$, if $x$ is an element of the dart set of $L$.  A set of paths visits a
dart $x$, if some path in the set visits the dart.
\end{definition}

\begin{notation}[$\cooln$]
%Write $P[x_i:x_j]$ for $i<j$ for the sublist $[x_{i+1};\ldots;x_j]$ of
%$P=[x_0;\ldots;x_{k-1}]$.  (The notation is ambiguous when the path is
%not injective.)  
The infix operator $\cooln$ prepends an element $x$ to a list $[x_0;\ldots]$:
\begin{displaymath}
x\cooln[x_0;\ldots] = [x;x_0;\ldots].
\end{displaymath}
%The infix operator $\opat$  \newterm{concatenates} 
%lists:
%\begin{displaymath}
%[a;\ldots;b] \opat [c;\ldots;d]  = [a;\ldots;b;c;\ldots;d].
%\end{displaymath}
\end{notation}
\indy{Notation}{1@$\cooln$ (list operation)}%
\indy{Notation}{P@$P$ (dart path)}%
%\indy{Notation}{1@$[-:-]$ (dart sublist)}%
%\indy{Notation}{Z@$\opat$~(concatenation)}%


\begin{definition}[$\sim_S$]\guid{IENSLJP}
Let $D$ be a set, and let $S$ be a 
set of permutations on $D$.
Define a relation on the set of darts by $x\sim_S y$ when there is a
path from $x$ to $y$ with steps in $S$.
\end{definition}

\begin{lemma}[equal equivalences]\guid{YBGABWW}\rating{50}\label{lemma:er} %\guid{QLPBIKV}
% wording changed by thales Jan 7, 2010.
Let $(D,e,n,f)$ be a hypermap and let $S$ be a  set of permutations.
Then for each $h_1,h_2\in S$, 
the relation $\sim_S$ is the same as the relation $\sim_T$, where
\begin{displaymath}
T = S \cup \{h_1h_2\}.
\end{displaymath}
Moreover, for each $h\in S$, 
the relation $\sim_S$ is the same as the relation $\sim_T$, where
\begin{displaymath}
T = S \cup \{h^{-1}\}.
\end{displaymath}
Also,  the relation $\sim_S$ (that is, $\sim_T$) is an equivalence relation.  
\indy{Index}{equivalence relation}%
\end{lemma}

\begin{proof} If $x\sim_S y$ then clearly $x\sim_T y$.  Conversely,
if $x\sim_T y$, where $T = S\cup\{h_1,h_2\}$, pick a path $P$ from $x$ to $y$ with steps
in $T$ that contains the fewest $h_1h_2$-steps.  

\claim{$P$ does not contain any $h_1h_2$-steps}.  Otherwise, a sublist $[\ldots;u;h_1h_2u;\ldots]$
of $P$ can be expanded to a path $[\ldots;u;h_2u;h_1u;\ldots]$ that contradicts the minimal
property of $P$.

This proves the first conclusion of the lemma.  Fix $h$ in a set of permutations $R$.
By an induction that uses the first conclusion,  for all $i$, $\sim_R$ equals the relation $\sim_{R(h,i)}$,
where $R(h,i) = R \cup \{h,h^2,\ldots,h^i\}$.  If $h\in S$ is an element of order $k$, 
and $T = S\cup\{h^{-1}\}$, then
the second conclusion follows because the following sets give the same relation:
\begin{displaymath}
S,\quad S(h,k-1) = T(h,k-2),\quad T.
\end{displaymath}

By repeated action of the previous conclusion, $\sim_S=\sim_T$, where 
$T = S\cup S^{-1}\cup \{I_D\}$, and where $S^{-1} = \{h^{-1}\mid h\in S\}$.
The unit path $[x]$ yields reflexivity of $\sim_T$.  Also, $T^{-1} = T$ gives the symmetry.  Finally, concatenation of paths gives transitivity.  Thus, $\sim_T$ (i.e., $\sim_S$) is an equivalence relation.
\end{proof}

\begin{definition}[combinatorial~component,~connected]\guid{JVTRXQR}
A \newterm{combinatorial component} of a hypermap $(D,e,n,f)$ is an 
equivalence class of the relation $\sim_S$, where
$S=\{e,f,n\}$. 
(See Lemma~\ref{lemma:er} for other sets that define the same equivalence classes.)  
Write $\#c$ for the
number of combinatorial components.  The hypermap is \newterm{connected} if
$\#c=1$.  \indy{Index}{Dhammapada}%
\indy{Index}{path}%
\indy{Index}{connected}%
\indy{Index}{component!combinatorial}%
\indy{Notation}{1@$\#c$~ (number of components)}%
\end{definition}





\begin{definition}[orbit,~node,~face,~edge]\guid{JIOUCMV}
The \newterm{orbit} of $x\in D$ under a permutation $h$ on
a set $D$ is a set of the form $\{h^i x\mid i\in\ring{N}\}$.  A \newterm{node}
of a hypermap $(D,e,n,f)$ is the orbit of a dart $x\in D$ under $n$.  
A \newterm{face} is an orbit under $f$.  
An \newterm{edge} is an
orbit under $e$.  \indy{Index}{node}%
\indy{Index}{face}%
\indy{Index}{edge}%
\end{definition}

Write $\#h$ for the
number of orbits of a permutation $h$ on $D$.  
\indy{Notation}{h@$h$ (permutation)}%
\indy{Notation}{1@$\#h$~(number of orbits)}%


\begin{lemma}[orbit relation]\guid{PKRQTKP}
Let $D$ be a finite set.  The orbit of $x\in D$ of a permutation $h:D\to D$
is the equivalence class of $x$ under the relation $\sim_S$, when $S=\{h\}$.
\end{lemma}

\begin{definition}[plain]\guid{HFRNMIU}
A hypermap $(D,e,n,f)$ is \newterm{plain}
  (carefully note\xfootnote{This deliberate play on the homophonous
    {\it plane} privileges writing over speech.  Every plane (hyper)graph may
be planar, but not all plain hypermaps are planar.}
  the  spelling!) when $e$ is an involution on $D$ (that is, $e^2 = I_D$).
  \indy{Index}{planar}%
\end{definition}




\begin{definition}[degenerate]\guid{MKSZLRM}
 A dart in a hypermap $(D,e,n,f)$ 
is degenerate if it is a
fixed point of one of the maps $e,n,f$; otherwise it is nondegenerate.  
%%It is nondegenerate otherwise.
\indy{Index}{dart!degenerate}%
\indy{Index}{dart!nondegenerate}%
\end{definition}

\begin{definition}[simple]\guid{KMHUQNS} 
A hypermap is \newterm{simple} if the intersection of each face with
each node contains at most one dart.  \indy{Index}{simple}%
\end{definition}


% Moved from cup05_tame.tex section on tame plane graphs. 9/5/07:
\begin{lemma}[nodal fixed point]\guid{ZHQCZLX}\rating{50}\tlabel{lemma:nondegen} 
Let $(D,e,n,f)$ be a simple plain hypermap such that every face has
at least three darts.
Then $n$ has no fixed point.
\indy{Index}{fixed point}%
\end{lemma}

\begin{proof} For a contradiction, let $x$ be a fixed point of
$n$. 

\claim{The darts $e x$ and $f x$ lie in the same node and face, so are
equal in the simple hypermap.}  Indeed, they lie in the same node
because $n(f x) = e^{-1} x = e x$. They lie in the same face because
\begin{displaymath}f^2 (e x) = f (f e n x) = f x.\end{displaymath}
So $e x = f x$.

Thus, $f^2 (e x) = f x = e x$, and $e x$ lies on a
face with at most two darts.  This contradicts what is given.
\end{proof}




\section{Walkup}

To focus on a dart $x$ in a
hypermap, it can be useful to draw a hexagon around $x$ and place
the six darts $e x$,
$f x$, $e^{-1} x$, $n x$,  $f^{-1} x$, $e x$, $n^{-1} x$  at its corners
in Figure~\ref{fig:dart+}.  Some of these seven darts may be
equal to one another, even if the figure draws them apart.
Figure~\ref{fig:dart-fix} shows the layout of a degenerate dart.
\indy{Notation}{x@$x$ (dart)}%

\begin{figure}[htb]
\centering
\szincludegraphics[width=40mm]{\pdfp/dart+.eps}
\caption{A dart $x$ and its entourage}
\label{fig:dart+}
\end{figure}

\begin{figure}[htb]
\centering
\szincludegraphics[width=60mm]{\pdfp/dart-fix.eps}
\caption{A dart fixed under a face map.}
\label{fig:dart-fix}
\end{figure}

\subsection{single}

A \newterm{walkup} deletes
a dart from a hypermap and reforms the edge, node, and face
maps to produce a hypermap on the reduced set of darts.  Walkups
come in three flavors: edge walkups, face walkups,
and node walkups.

\begin{definition}[walkup,~degenerate]\guid{DAIZNHD}
The edge \newterm{walkup}
$W_e$ at  a dart $x\in D$ of a hypermap $(D,e,n,f)$ is the hypermap
$(D',e',n',f')$, where $D' = D\setminus\{x\}$ and the
the maps skip over $x$:
\begin{displaymath}
\begin{array}{lll}
f' y &= \text{ if } (f y =  x) \text{ then } f x \text{ else
} f y\\
n' y &= \text{ if } (n y = x) \text{ then } n x \text{ else
} n y\\
e' &= (n'\ocirc f')^{-1}
\end{array}
\end{displaymath}
A walkup at $x$ is said to be \newterm{degenerate} if the dart $x$ is
degenerate.  
\indy{Index}{walkup}%
\indy{Index}{edge!walkup}%
\indy{Index}{face!walkup}%
\indy{Index}{node!walkup}%
\indy{Notation}{Wh@$W_h$ (walkup)}%
\end{definition}

Figure~\ref{fig:walk} shows
the result of an edge walkup on the hexagon around a dart $x$.
The triality symmetry~\ref{eqn:triality}, applied to the definition
of edge walkups, yields the definition of
face walkup $W_f$ and node walkup $W_n$.  
% Figure~\ref{fig:walkfn} shows the result of the face and node
% walkups on the hexagon around a dart $x$.

At a degenerate dart $x$, all three walkups are equal:
$W=W_e=W_n=W_f$ (Figure~\ref{fig:walkdegen}).
\indy{Index}{walkup!degenerate}%
\indy{Notation}{x@$x$ (dart)}%

\begin{figure}[htb]
\centering
\szincludegraphics[width=80mm]{\pdfp/walk.eps}
\caption{The effect of a walkup at $x$}
\label{fig:walk}
\end{figure}


\begin{figure}[htb]
\centering
\szincludegraphics[width=80mm]{\pdfp/walkdegen.eps}
\caption{The effect of a walkup at a degenerate dart}
\label{fig:walkdegen}
\end{figure}


\begin{definition}[merge,~split]\guid{KJIOZBJ}\tlabel{def:merge-split} 
Let $(D,e,n,f)$ be a hypermap, and let $h=n,e$, or $f$.  Let $\op{orbit}(h,x)$
denote the orbit of $x\in D$ under $h$.  Let $(D',e',n',f')$ be the hypermap obtained
from $(D,e,n,f)$ by the walkup $W_h$ at $x\in D$.
Let $h'=e',n',f'$, respectively, according to the choice of $h$.
The walkup $W_h$ at $x$ \newterm{merges} when the walkup joins the
orbit of $h$ through $x$ with another orbit.  That is, there is an orbit $O$ of some
$y\in D'$ under $h':D'\to D'$ of the form
\begin{displaymath}
O \cup\{x\} = \op{orbit}(h,x) \cup \op{orbit}(h,y),
\end{displaymath}
where $y\not\in \op{orbit}(h,x)$.
It \newterm{splits}
when the walkup splits the orbit at $x$ into two orbits.  That is, there are 
distinct orbits $O_1,O_2$ under $h'$ in the hypermap $(D',e',n',f')$ such that
\begin{displaymath}
\{x\}\cup O_1\cup O_2 = \op{orbit}(h,x).
\end{displaymath}
\indy{Index}{split}%
\indy{Index}{merge}%
\indy{Index}{orbit}%
\end{definition}

\begin{lemma}[merge-split]\guid{ZMFKZNH}\rating{150}\tlabel{lemma:merge-split} 
  Let $(D,e,n,f)$ be a hypermap and let $W_h$ be a nondegenerate
  walkup at a dart $x$.  Then $W_h$ merges or splits. Moreover, it merges if
  and only if $x$ and $y$ lie in distinct $h$-orbits, where
  $(h,y)=(f,e x)$,  $(e,n x)$, or $(n,f x)$.
\end{lemma}

\begin{proof} The walkup $W_f$ splits if and only if $f x$ 
(or $x$)
and $e x$ lie in the same $f$-orbit before the split. 
Figure~\ref{fig:split} makes this clear.
The other cases $h=e,n$ hold by triality.
\end{proof}


\begin{figure}[htb]
\centering
\szincludegraphics[height=90mm]{\pdfp/split.eps}
\caption{The face walkup at $x$ mixes $f$-orbits.  If it mixes a
single orbit, the orbit splits. If it mixes two separate orbits, the
orbits merge. }
\label{fig:split}
\end{figure}

The following is a useful way to tell if a walkup merges.


\begin{lemma}[merge criterion]\guid{FKSNTKR}\rating{80}\tlabel{lemma:ng-merge}  
Suppose, in a simple plain hypermap $(D,e,n,f)$, that an edge $\{x,y\}$ consists
of two nondegenerate darts.  Then the walkup $W_f$ 
% (resp. $W_n$)  removed Jan 10, 2009.  Needed? Is it even true?
at $x$ merges.
\end{lemma}
\indy{Index}{merge}%

\begin{proof} 
The darts $f x$ and $e x$ lie in the same node: $n (f x) = e^{-1} x
= e x$. If they are also in the same face of a simple hypermap, then
$f x = e x = y$. So
\begin{displaymath}n y  = n f x = n f e y = y,\end{displaymath}
and $y$ is a fixed
point of $n$, hence degenerate, contrary to assumption.  
Thus, $f x$ and $e x$ are in different faces, and the walkup merges
by Lemma~\ref{lemma:merge-split}.  
\end{proof}


\subsection{double}
\indy{Index}{walkup!double}%

A double walkup is the composite of two walkups of the same type.  The
two darts for the two walkups are to be the members of an orbit of
size two (under $n$, $e$, or $f$).
%%XX?The first walkup is to be chosen so that it merges.  
By choosing the type of the walkups to be different from the type of
the orbit, the first walkup reduces the orbit to a singleton, forcing
the second walkup to be degenerate.

Here are some examples.
\begin{itemize}
\item A double $W_n$ along an edge deletes the edge and 
merges the two endpoints into
a single node (Figure~\ref{fig:doublenode}). 
\item A double $W_f$ along an edge 
deletes the edge and merges the two faces along the edge into
one (Figure~\ref{fig:doubleface}).
\item A double $W_e$ at a node of degree two
deletes the node and merges the two edges at the node into
one (Figure~\ref{fig:doubleedge}).
\end{itemize}


\begin{figure}[htb]
\centering
\szincludegraphics[width=90mm]{\pdfp/double-node-walkup.eps}
\caption{The double node walkup applied to an edge}
\label{fig:doublenode}
\end{figure}


\begin{figure}[htb]
\centering
\szincludegraphics[width=90mm]{\pdfp/double-face-walkup.eps}
\caption{The double face walkup applied to an edge}
\label{fig:doubleface}
\end{figure}


\begin{figure}[htb]
\centering
\szincludegraphics[width=80mm]{\pdfp/double-edge-walkup.eps}
\caption{The double edge walkup applied to a node}
\label{fig:doubleedge}
\end{figure}

\begin{figure}[htb]
\centering
\szincludegraphics[width=80mm]{\pdfp/double_edge.eps}
\caption{The double edge walkup preserves plainness.}
\label{fig:doubleplain}
\end{figure}


\begin{lemma}[plain walkup]\guid{HOZKXVW}\rating{150}\tlabel{lemma:dwalk-planar}  
The three preceding double walkups carry plain
hypermaps into plain hypermaps.
\end{lemma}
\indy{Index}{hypermap!plain}%

\begin{proof} The walkups $W_n$ and $W_f$ preserve the orbit structure
of edges, except for dropping one dart.  By dropping both darts from
the same edge, one edge is lost and all others edges remain
unchanged.

Figure~\ref{fig:doubleplain} illustrates the double $W_e$.  The two
edges $\{x,e x\}$, $\{y, e y\}$ meeting the node are fused by the
double walkup into $\{e x, e y\}$, which is still an edge of size
two.
\end{proof}

\begin{remark}[reverse double walkup]\guid{KPRURND}\label{rem:reverse-double-walkup}
Double walkup transformations can be run in reverse.
Let $H'=(D',e',n',f')$ be
a hypermap and let $D\supset D'$ be a set that contains two additional elements
$x,y$.  Fix distinct elements $x',y'\in D'$.  Define $n,e:D\to D$ as follows.
\begin{displaymath}
\begin{cases} 
e x = y, &\\
e y = x,&\\
e z = e' z,&\text{otherwise.}\\
\end{cases}
\qquad\qquad
\begin{cases} 
n x' = x, &\\
n x =  n' x',&\\
n y' = y,&\\
n y =  n' y',&\\
n z = n' z, &\text{otherwise.}\\
\end{cases}
\end{displaymath}
Define $f$ by forcing the hypermap identity $e n f = I_D$.  
The edge $\{x,y\}$ has been inserted by a reverse double walkup.  The insertion points of the edge
into the hypermap
depend on the data $\{(x',x),(y',y)\}$.   

Reverse double walkup transformations that
insert a node $\{x,y\}$ or a face $\{x,y\}$ into a hypermap are obtained similarly  by triality symmetry.  For example, to insert a node onto an edge $\{x',y'\}$ of cardinality $2$, use
\begin{displaymath}
\begin{cases} 
n x = y, &\\
n y = x,&\\
n z = n' z,&\text{otherwise.}\\
\end{cases}
\qquad\qquad
\begin{cases} 
f x' = x, &\\
f x =  f' x',&\\
\text{etc.}&\\%f
%f y' = y,&\\
%f y =  f' y',&\\
%f z = f' z, &\text{otherwise.}\\
\end{cases}
\end{displaymath}
\indy{Index}{reverse double walkup}%
\end{remark}

\begin{remark}[dart universe]\guid{SCYVYJW}\label{rem:dart-universe}
For reverse double walkups, we need a set from which to draw new darts $x,y$.
We will use a well-ordered set $\Omega$ from which we draw, as needed,
the minimal element of the complement in $\Omega$ of the set of darts
already in play.  We assume that darts can be supplied from $\Omega$,
without mentioning it explicitly.  

For example, if we insert an edge into $(D',e',n',f')$
using the
ordered pair $(x',y')$, we use the data $\{(x',x),(y',y)\}$, where $x$ is the
least element of $\Omega\setminus D'$, and $y$ is the least element of
$\Omega\setminus (D'\cup \{x\})$.  To insert a node into an edge of cardinality
two, it is enough to specify one dart $x'$ in the edge.  Then let $y'$ be the other
dart in the edge, and choose $x,y\in \Omega$ as above.
\indy{Notation}{zzZ@$\Omega$ (well-ordered universe of darts)}
\end{remark}

\begin{definition}[RDW]\guid{TPEZAAM}\label{def:R}  
  Let $H'=(D',e',n',f')$ be a hypermap and let $x'\in D'$.  
%  Let $r$ be the
%  cardinality of the face of $x$, and let $m,p,q$ be integers that
%  satisfy $0\le p$, $0\le m < q < r$, and $m+1 <
%  p+q$.
Let $m,q,p$ be natural numbers.  Assume that $y' =(f')^{m+1}x'$ is not
equal to $z'=(f')^{q+1}x'$.
Construct a hypermap $RDW(H',x',m,p,q)$  as follows.  
First
  add an edge into $H$ using the ordered pair $(y',z')$
(by the reverse double walkup of
  Remark~\ref{rem:reverse-double-walkup}).  Then insert $p$ new nodes
  (of degree $2$) again by reverse double
  walkup transformations, each time at the edge containing $y'$.  
This is $RDW(H,x',m,p,q)$.
\end{definition}
\indy{Notation}{RDW@$RDW$ (reverse double walkup)}


\section{Planarity}
\indy{Index}{walkup}%
\indy{Index}{planarity}%

\begin{definition}[planar]\guid{QVATKMJ}
A hypermap is \newterm{planar} (note the
spelling!) when the Euler relation holds:
\begin{displaymath}\# n + \# e + \# f = \# D + 2\, \#c.\end{displaymath}
\indy{Index}{planar}%
\end{definition}


\begin{remark}[Eulerian relation]\guid{YPVCMHI}\label{rem:Euler}   
The Euler relation for planar graphs can be translated into the
language of hypermaps.  Consider a connected planar graph that
satisfies the Euler relation for the alternating sum of Betti
numbers:
\begin{displaymath}b_0 - b_1 + b_2 = 2\end{displaymath} where $b_0$
is the number of vertices, $b_1$ the number of edges, and $b_2$ the
number of faces (including an unbounded face) of the planar
graph. The hypermap $(D,e,n,f)$, made from the planar graph in
Remark~\ref{rem:hypermap}, is plain, and the involution $e$ has no fixed points.  
Thus, $\# D = 2\#e$, according to the partition of $D$ into edges.  Moreover,
\begin{displaymath}\begin{array}{lll}
b_0 &= \# n\\
b_1 &= \# e\\
b_2 &= \# f\\
2b_1 &= \# D\\
1 &= \#c\\
b_0 - b_1 + b_2  &= \# n + (\#e - \#D) + \# f = 2\,\# c.
\end{array}
\end{displaymath}
Thus, the hypermap is also planar.
\indy{Index}{Euler relation} %
\end{remark}


\begin{lemma}[dart bound]\guid{TGJISOK}\rating{80}\label{lemma:dart-upper} 
Let $H$ be a connected plain planar hypermap such that every edge
has cardinality two.  Assume that there are at least three darts in
every node.  Then
\begin{displaymath}
\# D \le (6\, \#f - 12).
\end{displaymath}
\end{lemma}
\indy{Notation}{H@$H$ (hypermap)}%

\begin{proof}  In a plain planar hypermap, the Euler relation becomes
\begin{displaymath}6\, \#f - 12 = 3\,\#D - 6\,\#n,\end{displaymath}
so it is enough to show that
\begin{displaymath}
\# D \ge 3\,\#n.
\end{displaymath}
This follows directly by assumption: the set of darts can be
partitioned into nodes, with at least three darts per node.
\end{proof}


\begin{definition}[planar~index]\guid{ICAWSNK}
The planar index of a hypermap is
\begin{displaymath}\iota = \# f + \# e + \# n - \# D - 2\,\#
c.\end{displaymath}
(A hypermap with null index is planar.)
\indy{Index}{hypermap!planar index}%
\indy{Notation}{ZZiota@$\iota$ (planar index)}%
\end{definition}

\begin{lemma}[walkup index]\guid{IUCLZYI}\rating{400}\tlabel{lemma:index} 
Let $x$ be a nondegenerate dart of a hypermap $(D,e,n,f)$. Let
$(D',e',n',f')$ be the result of the face walkup $W$ at $x$.  The
walkup changes the size of some orbits.
\begin{displaymath}
\begin{array}{lll}
%\text{\bf Non-degenerate dart $x$: }&\\
\# f' &=\# f +\op{split}_f  \\  
\# e'&=\# e \\
\# n'&=\# n \\
\# D'&=\# D - 1 \\
\#c'&=\# c + \op{split}_c\\
\iota' &= \iota + 1+\op{split}_f - 2\op{split}_c,\\
\end{array}
\end{displaymath}
where
\begin{displaymath}
\op{split}_f = \begin{cases}
1,&\text{if $W$ splits }\\
-1,&\text{if $W$ merges}\\
\end{cases}
\end{displaymath}
and $\op{split}_c=1$ if $e x$ and $f^{-1} x$ belong to different
combinatorial components after the walkup $W$, and $\op{split}_c=0$
otherwise. Moreover, a walkup at a degenerate dart preserves the
planar index.  \indy{Notation}{splitc@$\op{split}_c$}%
\indy{Notation}{splitf@$\op{split}_f$}%
\indy{Notation}{W@$W$ (walkup)}%
\end{lemma}

\begin{proof} The figures make this clear.
\end{proof}

\begin{lemma}[index inequality]\guid{BISHKQW}\rating{100}\tlabel{lemma:planar-index2}
Let $\iota$ be the index of a hypermap $(D,e,n,f)$, and let $\iota'$
be the index after a walkup $W_h$ at a dart $x$.  Then $\iota \le
\iota'$.
\end{lemma} 


\begin{proof} Without loss of generality, by triality symmetry, the
walkup is a face walkup.  If $\op{split}_c=0$, the inequality is
immediate by Lemma~\ref{lemma:index}.  If $\op{split}_c=1$, 
then $e x$ and $f^{-1} x$ lie in
different components after the walkup, hence also in different
faces.  Thus, the walkup splits by Lemma~\ref{lemma:merge-split}.
Hence  $\op{split}_f = 1$.  The result
follows by Lemma~\ref{lemma:index}.
\end{proof}


\begin{lemma}[non-positive index]\guid{FOAGLPA}\rating{50}
\tlabel{lemma:planar-nonpos}  
The planar index
of a hypermap is never positive.
\end{lemma}

\begin{proof}  An face walkup never decreases the index.  A sequence
of face walkups leads to the empty hypermap, which has
index zero.
\end{proof}


\begin{lemma}[planar walkup]\guid{SGCOSXK}\rating{50}
\tlabel{lemma:walkup-planar}
Walkups take planar hypermaps to planar
hypermaps.
\end{lemma}

\begin{proof}  
A planar hypermap has maximum index.  The walkup
can only increase the index, but never beyond its maximum.  
Thus, the index remains at its maximum value.
\end{proof}





\section{Path}

\subsection{contour}

\begin{definition}[cyclic~list]\guid{MYJNYCZ}
A \newterm{cyclic list} $\lp{x_0;\ldots;x_{k-1}}$ is an equivalence class of lists under the transitive closure of the relation:
\begin{displaymath}
[x_0;x_1;x_2\ldots;x_{k-1}] \sim [x_1;x_2;\ldots;x_{k-1};x_0].
\end{displaymath}
A sublist of a cyclic list is a sublist of some representative of the equivalence class.
\end{definition}

\begin{definition}[contour~path,cyclic~list,~contour~loop]\guid{AUIDQRN}
 A \newterm{contour path} from
$x_0$ to $x_{k-1}$ is a path $[x_0;x_1;\ldots;x_{k-1}]$ such that
$x_{i+1} = n^{-1} x_i$ or $f x_i$ for each $i<k$.  (That is, each
step in the path is clockwise step around a node or a
counterclockwise step around a face.)  
A \newterm{contour loop} is an injective cyclic list
$\lp{x_0;x_1;\ldots;x_{k-1}}$ such that
for every $i$, there exists $h_i\in \{f,n^{-1}\}$ such that $x_{i+1} = h_i x_i$, 
where the subscripts are
read modulo $k$.
%$[x_1;\ldots;x_{k-1}]$ is injective and $x_0 = x_{k-1}$, then it is
%a \newterm{contour loop}.  
%A sublist of a contour loop $[x_0;\ldots;x_{k-1}]$ is a path
%$[y_0;
\indy{Index}{contour!path}%
\indy{Index}{contour!loop}%
\indy{Index}{loop}%
\end{definition}



\begin{remark}[contour path illustration]\guid{AWRGIPA}
 Figure~\ref{fig:hypermap_ex}
  constructs a hypermap from a planar graph by drawing darts next to
  each angle.  In this representation, the darts along a contour path
  lie to the left of the corresponding planar graph edges.  For that
  reason, a shaded region to the left of a curve depicts a contour
  path.
\end{remark}

\begin{figure}[htb]
\centering
\szincludegraphics[width=80mm]{\pdfp/shade_dart.eps}
\caption{A contour path as a sequence as dart is represented as a
shaded path.}
\label{fig:shade-dart}
\end{figure}

\begin{lemma}[injective path]\guid{QZTPGJV}\rating{50} 
An injective contour path from
  $x$ to $y$ can be constructed from an arbitrary contour path from
  $x$ to $y$ by dropping some darts from the path.
\end{lemma}

\begin{proof} Repeatedly replace $[\ldots;a;b;\ldots;b;c;\ldots]$ with
$[\ldots;a;b;c;\ldots]$.
\end{proof}





\begin{lemma}[contours-components]\guid{KDAEDEX}\rating{100}\tlabel{lemma:connect-contour}  
Let $H$ be a hypermap.
If $x$ and $y$ are darts in the same combinatorial component of $H$ if and only if
there exists a contour path from $x$ to $y$.
\end{lemma}

\begin{proof} 
Combinatorial components are defined by an equivalence relation $\sim_S$, where
$S = \{e,n,f\}$.  By Lemma~\ref{lemma:er}, this is the same equivalence relation as
$\sim_T$, where $T = \{n^{-1},f\}$.  By the definition of the equivalence relation $T$,
$x\sim_T y$ if and only if there is a contour path from $x$ to $y$.
\end{proof}
\indy{Index}{component!combinatorial}%

\begin{definition}[complement]\guid{GCACAFP} 
Let $(D,e,n,f)$ be a plain hypermap.
Let $P=\lp{x;y;\ldots}$ be a contour loop that does not visit any node
twice in a plain hypermap.   (That is, the dart set of $P$ intersected with a node
is the dart set of a maximal sublist $[z;n^{-1}z;\ldots;n^{-k}z]$ of $n^{-1}$ steps.)
 Replace each maximal sublist of
$n^{-1}$-steps
\begin{displaymath}
[z;n^{-1} z; \ldots; n^{-k} z]
\end{displaymath}
with the sublist
\begin{displaymath}
[n^{-(k+1)} z;n^{-(k+2)} z;\ldots; n z]
\end{displaymath}
Concatenate these new sublists in reverse order.  By the relation $n f = f^{-1} n^{-1}$,
the transitions between the new sublists are $f$-steps.
The resulting contour loop $P^c$
is the \newterm{complement}. 
\end{definition}
\indy{Notation}{1@$*^c$ (complement)}

\begin{figure}[htb]
\centering
\szincludegraphics[width=70mm]{\pdfp/complement.eps}
\caption{The complement contour traces the remaining darts
at the same nodes as the original contour loop. }
\label{fig:contour-comp}
\end{figure}


\subsection{M\"obius}

\begin{definition}[M\"obius~contour]\guid{MBYIEQP}
 A M\"obius contour in a hypermap
$(D,e,n,f)$ is an
injective contour path $P=[x_0;\ldots]$ that satisfies
\begin{equation}
\tlabel{eqn:mobius}
x_j = n x_0\quad x_k = n x_i
\end{equation}
for some $0 < i\le j< k$ (Figure~\ref{fig:mobius}).
\indy{Index}{contour!M\"obius}%
\end{definition}


\begin{remark}[Four-Color theorem]\guid{ROIPZSU}
G. Gonthier devised the notion of M\"obius contour as a way to prove
the Four-Color theorem without appeal to topology.  (The Appel-Haken
proof of the Four-Color theorem relies on the Jordan curve theorem.)
This chapter uses a significant amount of material from ~\cite{Gonthier:2005:FourColor}.
\end{remark}

\begin{figure}[htb]
\centering
\szincludegraphics[width=50mm]{\pdfp/mobius.eps}
\caption{A M\"obius contour}
\label{fig:mobius}
\end{figure}

\begin{figure}[htb]
\centering
\szincludegraphics[width=30mm]{\pdfp/3m.eps}
\caption{The face map on this hypermap gives a M\"obius contour with
three darts}
\label{fig:3m}
\end{figure}

\begin{remark}[M\"obius strip]\guid{NGALZAC}
 Heuristically, a M\"obius contour is a 
combinatorial M\"obius strip that
twists to make 
its left-hand side into
its right-hand side.  A planar hypermap has no such contour.  
Figure~\ref{fig:violate-jct}
redraws a violation of the Jordan curve theorem
as a M\"obius contour.   
\end{remark}

\begin{figure}[htb]
\centering
\szincludegraphics[width=80mm]{\pdfp/violate-jct2.eps}
\caption{A path that tunnels from the interior to the exterior
of a simple closed curve
is analogous to a M\"obius contour.}
\label{fig:violate-jct}
\end{figure}

\begin{figure}[htb]
\centering
\szincludegraphics[width=80mm]{\pdfp/mobius_contour.eps}
\caption{Some M\"obius contours}
\label{fig:mobius-contour}
\end{figure}






\begin{lemma}[planar-non-M\"obius]\guid{LIPYTUI}\rating{300}\tlabel{lemma:no-mobius}
A planar hypermap does not have a M\"obius contour.
\end{lemma}
\indy{Index}{hypermap!planar}%

\begin{proof} For a contradiction, assume that there exist planar
hypermaps with M\"obius contours.  An edge walkup carries
planar hypermaps into planar hypermaps. An edge walkup
at a dart that is not on the M\"obius contour carries the
M\"obius contour to a M\"obius contour 
and reduces the number of darts.  
In the M\"obius Condition~\ref{eqn:mobius},
a walkup at a dart that is not at position $0$, $i$, $j$, $k$
along the contour carries the M\"obius contour to a M\"obius contour
and reduces the number of darts. Thus, a counterexample with
the smallest possible number of darts contains no
darts except those on the M\"obius contour, and its only darts
are at positions $0$, $i=j=1$, $k=2$.

This is a three darted hypermap (Figure~\ref{fig:3m}.)  
The M\"obius condition, the
definition of contours, together with $e\ocirc n\ocirc f=I_D$ force
$e=n=f$, all permutations of order three.  This hypermap is not planar:
\begin{displaymath}\# e + \# n + \# f = 3~~\ne~~ 5 = \# D + 2\,
\#c.\end{displaymath}
\end{proof}



%\subsection{interior}
%\indy{Index}{interior}%
%
%\begin{definition}[interior]\guid{NQXQALU}\label{def:interior} 
%A dart $y$ lies in the \newterm{interior} of a contour
%loop $L$ if there is a an injective contour path
%$x_0,x_1,\ldots,x_k=y$ such that $x_1 = f x_0$ (or $k=0$), and
%such that $x_i$ lies on the loop $L$ if and only if $i=0$.
%\indy{Index}{interior!contour loop}%
%\indy{Notation}{L@$L$ (contour loop)}%
%\indy{Notation}{y@$y$ (dart)}%
%\end{definition}
%

\begin{lemma}[step coherence]\guid{ILTXRQD}\rating{100}\tlabel{lemma:contour-path-type}
Suppose that a hypermap has no M\"obius contours. Let $L$ be a
contour loop.  Let $P$ be any injective contour path with at least
$3$ darts, that starts and ends on $L$, but visits no other darts of
$L$.  Then the first and last steps of $P$ are both of the same type
($n^{-1}$ or $f$).
\end{lemma}
\indy{Notation}{P@$P$ (contour path)}%

\begin{figure}[htb]
\centering
\szincludegraphics[width=80mm]{\pdfp/interior_nf.eps}
\caption{A path must enter and depart from a contour loop with the
same type of step.}
\label{fig:interior_nf}
\end{figure}


\begin{proof} The proof shows the contrapositive.  Suppose $P=[n x;f n
x;\ldots;n y;y]$.  The successor of $n x$ on $L$ is $x$.  Starting
at $x$, follow $L$ to $y$, and on to $n x$.  Follow $P$ back to $n
y$.
%\begin{displaymath}
%x\cooln L[x:n x] \opat P[ n x;ny].
%\end{displaymath}  
This is a M\"obius contour $x\ldots y\ldots n x\ldots n y$.

Suppose $P=[n x;x;\ldots;f^{-1} y;y]$.  Starting at $x$, follow $P$ to
$y$, then follow $L$ to $n x$, and on to $n y$.  This is a M\"obius
contour.\xfootnote{The second statement can also be deduced from the first statement
by the duality $(D,e,n,f)\leftrightarrow (D,e^{-1},f^{-1},n^{-1})$ that swaps
$f$-steps with $n^{-1}$-steps in a path.}
\end{proof}

%\begin{lemma}[]\guid{UMYSGDB}\rating{80}\tlabel{lemma:dart-interior}
%  Let $L$ be a contour loop on a plain hypermap without M\"obius
%  contours.  Assume a dart $x$ lies in the interior of the loop $L$.
%  Then every dart in its $f$-orbit lies in the interior of the loop.
%  Moreover, if the dart $x$ does not lie on the same node as any dart
%  in $L$, then every dart in the $n$-orbit of $x$ lies in the
%  interior of $L$.
%\end{lemma}

%\begin{proof} Let $P= [x_0;\ldots;x]$ be an injective path that
%  certifies that $x$ lies in the interior of $L$.  If $f x$ lies
%  along this path already or if it lies on $L$, then it is clearly
%  interior.  Otherwise, $[x_0;\ldots,x;f x]$ is a certifying path for
%  $f x$.  Similarly, use the certifying path $[x_0;\ldots;x;n^{-1}
%  x]$ for $n^{-1} x$.
%\end{proof}
%
%%
%\begin{definition}[interior~face,~node]\guid{JUXKJTU}
% A face or a node is interior
%  to a loop in a hypermap if all of its darts are interior.
%  \indy{Index}{interior!face}%
%  \indy{Index}{interior!node}%
%\end{definition}


\begin{lemma}[loop separation]\guid{ICJHAOQ}\rating{180}\tlabel{lemma:contour-f}
Suppose that a hypermap has no M\"obius contours.  Let $L$ be a
contour loop.  Then there does not exist a contour path
$[x_0;\ldots;x_k]$, for $k\ge 1$ with the following properties:
\begin{enumerate}
\item $x_i$ lies on $L$ if and only if $i=0$.
\item $x_1 = f x_0$.
\item $x_0$ and $x_k$ lie in different nodes.
\item Some dart of $L$ is at the node of $x_k$.
\end{enumerate}
\end{lemma}

%\begin{figure}[htb]
%  \centering
%  \szincludegraphics[width=40mm]{\pdfp/no_node_path.eps}
%  \caption{No path exists from a node of $L$ to the interior.}
%  \label{fig:no-node-path}
%\end{figure}

\begin{proof} Assume for a contradiction that the path $P$ exists.
Some sublist is injective and satisfies the same conditions.  Again,
without loss of generality, shrinking the path if needed, $k$ is the
smallest index for which the last two conditions are met.  Append
$n^{-1}$-steps to $P$ to reach a dart of $L$.  This is contrary to
Lemma~\ref{lemma:contour-path-type}.
\end{proof}

\begin{lemma}[three darts]\guid{EUXPBPO}\rating{ZZ}\label{lemma:3dart}  
Assume that each face of a hypermap  has at least three darts.
Then every contour loop that meets at least two nodes has at least
three darts.
\end{lemma}

\begin{proof} Let $P=\lp{x;y}$ be a contour loop meeting two nodes.  Then
$y = f x$ and $x = f y$, so that the face has size two.
\end{proof}


\section{Quotient}
\indy{Index}{quotient}%

\subsection{definition}

\begin{definition}[isomorphism]\guid{GUDUERI}
 Two hypermaps $(D,e,n,f)$ and
$(D',e',n',f')$ are \newterm{isomorphic} when there is a bijection
$G:D\to D'$ such that
\begin{displaymath}h'\circ G = G\circ h\end{displaymath}
for $(h,h')=(e,e'), (f,f'), (n,n')$.
\indy{Index}{isomorphic hypermaps}%
\indy{Notation}{G@$G$ (morphism of hypermaps)}%
\end{definition}


\begin{definition}[normal family]\guid{RQSVFLE}
Let $(D,e,n,f)$ be a hypermap. 
%Assume that 
%there are no darts fixed by $e$ 
%(so that $f x \ne n^{-1} x$ at each dart). 
Let $\cal L$ be a family of contour
loops.  The family $\cal L$ is  normal if the following
conditions hold of its loops. \begin{enumerate}
\item  No dart is visited by two different loops.
\item  Every loop visits at least two nodes.
\item  If a loop visits a node, then every dart at that node is visited
by some loop.
\end{enumerate}
\indy{Index}{normal family}%
\end{definition}

A normal family determines a new hypermap.  A dart in the new set $D'$
of darts is a maximal sublist $[x;n^{-1} x; n^{-2} x;\ldots;n^{-k}
x]$ of $n^{-1}$ steps appearing in some loop in $\cal L$. The map $f'$
takes the maximal path $[x;n^{-1}x;\ldots;y]$ to the maximal path (in
the same contour loop) starting at $f y$. The map ${n'}^{-1}$ takes
the maximal path $[\ldots;y]$ to the maximal sequence (in some other
contour loop) starting $[n^{-1}y;\ldots]$. Equivalently, $n'$ takes
the maximal path $[x;\ldots]$ to the maximal path ending $[\ldots;n
x]$. The map $e'$ is defined by $e'\ocirc n'\ocirc f' = I_{D'}$.
\indy{Index}{path!maximal} %
\indy{Notation}{D@$D$ (dart)}%

\begin{definition}[quotient]\guid{AJENHSB}
 The hypermap $(D',e',n',f')$
constructed from the normal
family $\cal L$ of $H=(D,e,n,f)$ 
is called the \newterm{quotient} of $H$ by $\cal L$, and is denoted
$H/{\cal L}$.  If $x$ is a dart visited by some loop in $\cal L$, then
the maximal path $[\ldots;x;\ldots]$ is called the \newterm{quotient dart} of $x$.
%The hypermap $H$ is said to be a \newterm{cover} of $H/{\cal L}$.  
\indy{Index}{quotient}%
\end{definition}
\indy{Notation}{L@$\cal L$}%
\indy{Notation}{H@$H/{\cal L}$}%
%\indy{Index}{cover}%
\indy{Index}{hypermap!quotient}%
\indy{Index}{normal family}%

Intuitively, the quotient hypermap is represented as a graph whose
cycles under $f'$ are precisely the contour loops in the normal family
(Figure~\ref{fig:quot}).


\begin{figure}[htb]
\centering
\szincludegraphics[width=70mm]{\pdfp/quot.eps}
\caption{The contour loops in a normal family become faces in the
quotient}
\label{fig:quot}
\end{figure}

\subsection{properties}

This subsection explores some of the properties of a quotient hypermap.
The first two lemmas describe the faces and the nodes of the quotient
in terms of the combinatorics of the normal family.

\begin{lemma}[quotient face,~$\F$]\guid{WIRLCNL}\label{lemma:quotient-bijection}
  Let ${\cal L}$ be a normal family of the hypermap $H$.  Then ${\cal
    L}$ is in natural bijection with the set of faces of the quotient
  $H/{\cal L}$.  If $x'=[x;\ldots;n^{-k}x]$ is a maximal path of
  $n^{-1}$ steps in the contour loop $L\in{\cal L}$, then the
  corresponding face $\F(L)$ of $H/{\cal L}$ is the
  one containing the quotient dart $x'$.
\end{lemma}
\indy{Notation}{F@$\F$ (quotient bijection)}

\begin{proof}  This is left as an exercise to the reader.
\end{proof}


\begin{lemma}[quotient node]\guid{UDJNSHH}\label{lemma:quotient-node}
Let $H$ be a hypermap and let ${\cal L}$ be a normal family of $H$.
Then there is a natural bijection between  the set of nodes of
$H/{\cal L}$ and the set of nodes of $H$ that
are visited by some contour loop in ${\cal L}$.   
The bijective function sends the node in $H/{\cal L}$ of 
the dart $x' = [x;n^{-1} x;\ldots;n^{-k}x]$ to the node of $x$ in $H$.
\end{lemma}

\begin{proof}  The proof is an elementary verification.
Let $H/{\cal L} = (D',e',n',f')$.
\claim{This function is well-defined.}  Indeed, 
 \begin{displaymath}
(n')^{-1} x' = [n^{-(k+1)} x;\ldots]
\end{displaymath}
 is also sent to the node of $x$ in $H$.

\claim{This function is onto.}  Indeed,
If $L\in {\cal L}$ visits $x$,  and $x'$ is the image of $x$ in $D'$.
Then the node of $x'$ clearly maps to the node of $x$.  

\claim{Finally, the function is one-to-one.}  Indeed, if the nodes of
two quotient darts $x'$, $y'$ map to the same node of $H$, then
$x'=[x;\ldots]$ and $y'=[y;\ldots]$, where $n^j x = y$ for some $j$.
It follows by the definition of the node map on the quotient, that
$x'$ and $y'$ belong to the same node.
\end{proof}

The next two lemmas look at properties of the quotient that are
inherited from the orignal hypermap.

\begin{lemma}[plain quotient]\guid{JMKRXLA}\rating{280}\tlabel{lemma:quotient-plain}
Let $H$ be a plain hypermap, and let $\cal L$ be a
normal family.  Then $H/{\cal L}$ is a plain hypermap.
\end{lemma}

\begin{proof}  Write $H=(D,e,n,f)$ and $H/{\cal L} = (D',e',n',f')$.  
Write $[\ldots; x]$ for the node in
the quotient ending in dart $x\in D$ and $[x;\ldots]$ for the node
in the quotient starting with dart $x\in D$.  Plainness gives $e^2 x
= x$, so that for any dart $[\ldots x]$ in the quotient:
\begin{displaymath}\begin{array}{lll}
{e'}^{-2} [\ldots; x] &= n' f' n' f' [\ldots; x] = n' f' n' [f x; \ldots] \\&=
n' f' [\ldots; n f x] = n' [f n f; \ldots] = [\ldots; n f n f x]\\ &=
[\ldots; e^{-2} x] = [\ldots; x].
\end{array}\end{displaymath}
Thus, $e'$ has order $2$ on the quotient.
\end{proof}




\begin{definition}[no double joins]\guid{EDUYIEA}
A hypermap $H$ has no \newterm{double joins}, if for every two nodes
in $H$, there is at most one edge that meets both of them.
\end{definition}


\begin{lemma}[quotient-no-double-joins]\guid{KSRDPTZ}
Let $H$ be a plain hypermap with no double joins and let ${\cal L}$ be a normal
family of $H$.  Then $H/{\cal L}$ has no double joins.
\end{lemma}

\begin{proof} By Lemma~\ref{lemma:quotient-plain}, the quotient
  $H/{\cal L}$ is plain.  Let $\{x',e'x'\}$ and $\{y',e'y'\}$ be edges
  with the property that $x'$ and $y'$ lie at one node of $H/{\cal L}$
  and $e'x'$ and $e'y'$ lie at a second (different) node.  Write $x' =
  [\ldots;x]$ and $y' = [\ldots;y]$.  Then $e'x' = [\ldots;e x]$ and
  $e'y' = [\ldots;e y]$.  According to
  Lemma~\ref{lemma:quotient-node}, there is an injective map from
  nodes of $H/{\cal L}$ to nodes of $H$.  It follows that $x$ and $y$
  belong to the same node and that $e x$ and $e y$ belong to the same
  (different) node.  By the assumption that $H$ has no double joins,
  it follows that $x=y$.  Hence also $x' = y'$, and $H/{\cal L}$ has
  no double joins.
\end{proof}


\begin{lemma}[nodal fixed point]\guid{PYOVATA}\label{lemma:nfp}
Let $H=(D,e,n,f)$ be a hypermap in which the edge map has no fixed points.
Let ${\cal  L}$ be a normal family of $H$, with quotient $H/{\cal L} = (D',e',n',f')$.  
Then the following are equivalent conditions:
\begin{itemize}
\item $n'$ has a fixed point in $D'$.
\item The dart set of some $L\in {\cal L}$ contains a node.
\end{itemize}
\end{lemma}

\begin{proof}
If $x'=[x;n^{-1} x;\ldots;n^{-k} x]$ is a dart in $D'$, then $(n')^{-1}x'$ is
$[n^{-(k+1)} x;\ldots]$.  The dart $x'$ is a fixed point if and only if
$x = n^{-(k+1)} x$.  This holds if and only if the dart set of $x'$ is an entire node.
\end{proof}

\subsection{example}

\begin{example}[maximal normal family]\label{ex:Hall} 
  Assume that $H=(D,e,n,f)$ is a
  hypermap. % with no fixed points under $e$.
  Assume that every face meets at least two nodes. Then the set of all
  faces defines a normal family of contour loops: follow $f$ around
  each face $[x;f x;\ldots]$.  If $e$ acts without fixed points, then
  each dart of the quotient is just a unit path consisting of a single
  dart of $H$, and the quotient is isomorphic to $H$ itself.
\end{example}

\begin{example}[minimal normal family]\label{ex:H2} 
  Assume that $H=(D,e,n,f)$ is a plain hypermap.  Let $F = \{x,f x,\ldots\}$ be a face
  that visits at least three nodes and that meets each node in at most
  one dart.  Let $\cal L$ be the family with two contour loops: $\lp{x;f x;\ldots}$ 
and its complement $L^c = \lp{n^{-1} x;\ldots}$.
%\begin{displaymath}
%  [n^{-1} x;n^{-2} x;\ldots;n x;f n x = y;n^{-1} y; n^{-2} y;\ldots; n y; f ny;\ldots]
%\end{displaymath}
The family $\cal L$ is normal. The quotient hypermap $H/{\cal L}$ has
two faces: $F$ and a back side $F'$ of the same cardinality $k$.
\indy{Notation}{F@$F$ (hypermap face)}%
\end{example}

\begin{example}[dihedral]\label{ex:D2k} 
There is a hypermap $\op{Dih}_{2k}$ whose dart set has cardinality $2k$.
The permutations $f,n,e$ have  orders $k$, $2$, and $2$ respectively, and 
$e n f = I$.
The set of darts is given by
\begin{displaymath}
\{x, f x,f^2 x,\ldots,f^{k-1} x\}\cup \{n x, n f x, n f^2 x,\ldots, n f^{k-1} x\},
\end{displaymath}
for any dart $x$.
If a hypermap is isomorphic to $\op{Dih}_{2k}$ for
some $k$, then it is \newterm{dihedral}.\xfootnote{The three permutations generate the dihedral
group of order $2k$, acting on a set of $2k$ darts under the left action of the group upon itself.}   
In particular,
the hypermap constructed in the previous example is dihedral.
\indy{Index}{hypermap!dihedral}%
\end{example}

\begin{lemma}\guid{CODE}\rating{ZZ}\label{lemma:dih-iso}
A hypermap $H$ is isomorphic to $\op{Dih}_{2k}$ if and only if the hypermap is connected,
the dart set has cardinality $2k$, and the permutations $f,n,e$ have orders $k$, $2$, and $2$ respectively.
\end{lemma}

\begin{proof} Let $y$ be any dart of $H$, and $x$ any dart of $\op{Dih}_{2k}$.
By the connectedness of $H$, and the relations between $f$ and $n$, every dart of $H$ is
equal to one of the following: $f^i y$, $n f^i y$, for $i=0,\ldots,k-1$.  By the cardinality assumption,
these darts are all distinct.  By the relations between $f$ and $n$ on the hypermap $\op{Dih}_{2k}$,
the bijection $f^i x \mapsto f^i y$, $n f^i x \mapsto n f^i y$ is an isomorphism of hypermaps.
\end{proof}

%\begin{lemma}[three darts]\guid{BPAKIYP}
%Let $H$ be a plain hypermap with no double joins in which every
%face has at least three darts.  Let ${\cal L}$ be a node-free normal family of $H$.
%Then every face of $H/{\cal L}$ has at least three darts.
%\end{lemma}
%
%\begin{proof}  By definition, every contour loop in a normal family meets
%at least two nodes.  It follows that every face of $H/{\cal L}$ has at least two
%darts.
%
%Suppose for a contradiction that a face of $H'=H/{\cal L}$ only has two darts $x'$
%and $y'$, exchanged by the face map $f'$ of $H'$:
%\begin{displaymath}
%\begin{array}{lllll}
%y' &= [y;n^{-1} y;\ldots; n^{-k} y] &= f' x' &= [f n^{-\ell} x;\ldots;f x],\\
%x' &= [x;n^{-1}x;\ldots; n^{-\ell} x] &= f' y' &= [f n^{-k} y;\ldots; f y].\\
%\end{array}
%\end{displaymath}
%Using the relation $e^{-1} = n f$, it follows that $\{n^{-\ell} x, n y\}$
%and $\{n^{-k} y, n x\}$ are edges.  Both meet the node of $x$ and the node of $y$.
%In a hypermap with no mutiple joins, this implies that the edges are equal:
%\begin{displaymath}
%n y = n^{-k} y,\qquad n x = n^{-\ell} x.
%\end{displaymath}
%This shows that the dart set of $x'$ is the entire node.  This contradicts
%the assumption that ${\cal L}$ is node-free.
%\end{proof}
%

%\begin{lemma}[]\guid{ZOKKAOI}\tlabel{lemma:quotient-planar}
%Let $H$ be a plain planar hypermap, and let $\cal L$
%be a normal family.  Then $H/{\cal L}$ is a plain planar hypermap.
%\end{lemma}
%
%\begin{proof} Suppose $H/{\cal L}$ is not planar.
%Let $P$ be a M\"obius contour on $H/{\cal L}$.  It lifts uniquely to
%a contour on $H$ with the property that the darts visited on $H$ are
%precisely the darts that belong to a dart in the quotient.  This is
%compatible with the node map $n$.  So the contour path lifts to a
%M\"obius contour on $H$.  Thus, $H$ is not planar.
%\end{proof}

\section{Generation}
\indy{Index}{generation}%


The final section of this chapter presents an algorithm that generates all
simple, plain, planar hypermaps satisfying certain general conditions
(Definition~\ref{def:restricted}).  The algorithm proceeds by adding more and
more
edges and nodes to a dihedral hypermap by a sequence of reverse double walkup
transformations.

\begin{definition}[restricted]\guid{INCRVQC}\label{def:restricted}
A restricted hypermap $H = (D,e,n,f)$ is one with the following
properties.
\begin{enumerate}
\item The hypermap $H$ has no double joins, and is nonempty, planar,
  connected, plain and simple.
\item The edge map $e$ has no fixed points.  % Needed in Lemma:[flag quotient]
\item The node map $n$ has no fixed points.
\item The size of every face is at least $3$.
%%  (All hypoth. Needed?)
\end{enumerate}
\indy{Index}{hypermap!restricted}%
\indy{Notation}{H@$H$ (hypermap)}%
\end{definition}

\begin{remark}[step type]\guid{BMZYWKV}
The assumption that $e x \ne x$ implies that $f x \ne n^{-1} x$ so that $f$-steps of a 
path can be distinguished from $n^{-1}$-steps.
\end{remark}


\subsection{boolean value}
\indy{Index}{flag}%

The algorithm  marks certain faces as `true.'
Roughly, this  means that the the face cannot be modified
at any later stage of the algorithm.   When all of its faces
are true, the hypermap stands in final form.
The function that marks each face as true or false is a
\newterm{flag}.  For the algorithm to work properly, it is necessary
to impose some constraints, as captured in Definition~\ref{def:flag}.
\indy{Index}{hypermap!algorithm}%

%% XX \hat doesn't get used.

Under the bijection $\F$ between a normal family ${\cal L}$ and the set of
faces of a quotient $H/{\cal L}$, any function $\hat\varphi$ on ${\cal L}$
can be identified with a function $\check\varphi$ on the set of faces of $H/{\cal L}$.
(The {\it hat} points up to $H$, and the {\it check} points down to the quotient.)
This identification of functions will be used frequently in this section.

\begin{definition}[canonical function]\guid{CRUDEHU}
 Let $H$ be a hypermap with
  normal family $\cal L$.  The \newterm{canonical function}
  $\hat\varphi_{can}$ is the boolean-valued function on ${\cal L}$
  that is true on $L$ exactly when the dart set of $L$ maps
  bijectively to the face $\F(L)$ of $H/{\cal L}$, under $x\mapsto [x]$.  The
  corresponding function $\check\varphi_{can}$ is also called the
  canonical function.  A contour loop $L$ (or face $\F(L)$)
  is said to be canonically true or false, according to the value of the canonical
  function.  
\indy{Index}{function!canonical boolean}%
\indy{Notation}{zzP@$\check\varphi_{can}$}
\indy{Notation}{zzP@$\hat\varphi_{can}$}
\end{definition}

In other words, the face in the quotient is canonically true, exactly
when the corresponding contour loop $L\in {\cal L}$ has no $n^{-1}$
steps.  The dart set of such a contour loop $L$ is a face of $H$.  
%Based on this observation, we make the following definition.


\begin{definition}[flag]\guid{HFTAHWB}\label{def:flag} 
  Let $S$ be a set of darts in a hypermap $H$.  An $S$-\newterm{flag}
  on $H$ is a boolean-valued function $\check\varphi$ on the set of faces that
  satisfies the following two constraints.
\begin{enumerate}
\item If darts $x,y$ belong to true faces,
then there is a contour path from $x$ to $y$ that remains
in true faces.
\item Each edge of the hypermap meets a true face or $S$.
\end{enumerate}
An $\emptyset$-flag is simply called a flag.
%An isomorphism of flagged hypermaps is an isomorphism of
%hypermaps that respects the flags.
\indy{Index}{flag}%
\indy{Notation}{S@$S$ (set ofdarts)}%
\end{definition}



\begin{example}[dihedral hypermap flag] 
The dihedral hypermap of Example~\ref{ex:D2k}, carries a
flag that marks one face true and the other false.
\end{example}

\begin{example}[maximal quotient flag]\label{ex:Hall-flag} 
Let $H$ be a connected hypermap, and let $\cal L$ be the example of
Example~\ref{ex:Hall}, then the canonical map takes value
$\op{true}$ on every face.  This is a flag. In fact,
Lemma~\ref{lemma:connect-contour} provides the contour paths that
are required in the definition of flag.
\end{example}


%\begin{definition}[canonically true]\guid{PYAOBOS}
%  A contour loop $L$ in a hypermap is \newterm{canonically true} 
%if its
%  dart set is a face of $H$.
%\end{definition}


%\begin{lemma}[quotient isomorphism criterion]\guid{STKBEPH}\rating{100}
%\tlabel{lemma:all-dart}  
%  Let $H$ be a hypermap in which $e$ acts without fixed points, and
%  let ${\cal L}$ be a normal family of $H$. If the canonical boolean
%  function on the set of faces of $H/{\cal L}$ has at least as many
%  true values as there are faces of $H$, then $\cal L$ is the normal
%  family in Example~\ref{ex:Hall}. In particular, $H/{\cal L}$ is
%  isomorphic to $H$.
%\end{lemma}
%
%\begin{proof} If a face of  $H/{\cal L}$ is $\op{true}$,  then
%its darts are unit paths, and the face of $H/{\cal L}$ is in natural
%bijection with a face in $H$.  This is an injective map from the
%set of true faces of $H/{\cal L}$ to the set of faces of $H$.  The
%hypothesis of the lemma implies that this injective map is
%bijective. All of the darts of $H$ are accounted for under this
%bijection. Thus, the quotient has no false faces.  The result
%follows.
%\end{proof}
%


There is a standard way of constructing the sets $S$ of darts that
will be used in $S$-flags.  


\begin{definition}[S]\guid{FDRMSZG}
Let $H$ be a hypermap, $L$ a contour loop of the hypermap,
and $x$ an element of the dart set of $L$.
If  $L$ is  canonically true, then let $S=\emptyset$.
Otherwise,
let $m\ge0$ to be the largest $m$ 
such that 
\begin{displaymath}
[x;f x; f^2 x;\ldots;f^{m+1} x]
\end{displaymath}  
is a sublist of $L$, and
%Set $y = f^{m+1} x$
set $S(H,L,x) = \{f^i x \mid 1 \le i\le m\}$.
\end{definition}
\indy{Notation}{S@$S(H,L,x)$ (flag set)}

\begin{lemma}[flag quotient]\guid{KHGAQRG}\label{lemma:flag-set-quotient}
Let $H$ be a hypermap in which $e$ acts without fixed points, 
$L$ a contour loop, and $x$ and element of the dart set of $L$.
Let ${\cal L}$ be a normal family of $H$ that contains $L$.
Then $S(H,L,x)$ maps bijectively to a set $S'$ of darts in the quotient $H/{\cal L}$.
\end{lemma}

\begin{proof} The darts of the quotient are maximal sublists
  $[y;n^{-1} y;\ldots;n^{-k} y]$ of contour loops $L'\in {\cal L}$
  made entirely of $n^{-1}$ steps.  Each $y\in S(H,L,x)$ is preceded
  by an $f$-step and is followed by an $f$-step in $L$.  Hence the
  maximal sublist of $L$ containing $y$ is a unit path $[y]$.  The
  bijection follows.
\end{proof}


\subsection{markup}\label{sec:face-insert}
\indy{Index}{extension}%


%This section describes the transition from $H/{\cal L}$ to $H/{\cal
%M}$.  The algorithm carries along various auxiliary data satisfying
%various assumptions, enumerated as follows:

%\begin{definition}[node free]\guid{RZNSLOS}
%A  family ${\cal L}$ of contour loops in a hypermap $H$  
%is \newterm{node free}, if no node of $H$ is contained the dart set of any 
%$L\in {\cal L}$.
%\end{definition}



\begin{definition}[marked hypermap]\guid{TUFOKWK}\label{def:marked}
Let $(H,{\cal L},L,x)$ be a tuple, consisting of 
\begin{itemize}
\item a hypermap $H=(D,e,n,f)$ with no M\"obius contours, and in which
  $e$ acts without fixed points.  % Mobius needed for HQY...
\item a normal family ${\cal L}$, 
\item a contour loop $L\in{\cal L}$, and
\item a dart $x$ visited by $L$.
%and 
%\item the canonical boolean-valued function $\varphi'$ on $H/{\cal L}$
%  (identified with a function $\varphi$ on ${\cal L}$ by
%  Lemma~\ref{lemma:quotient-bijection}).
\end{itemize}
Such a tuple is a \newterm{marked hypermap} if
the following conditions hold.
\begin{enumerate}
\item The quotient $H'=H/{\cal L} = (D',e',n',f')$ is simple.  
\item $n'$ has no fixed points on $D'$.
\item $x$ is followed by an $f$-step in the loop: $L = \lp{x;fx;\ldots}$.
%\item $\varphi$ coincides with the natural boolean function on ${\cal L}\setminus \{L\}$.
%\item $\varphi$ is false on the loop $L$.
\item The contour loop $L'\in {\cal L}$ that visits%
\xfootnote{$L$ visits  $f x$.  By the definition of normality, some contour loop in
${\cal L}$ visits the dart $n f x$ at the same node.} 
$n f x$ is canonically true.
\item 
  $\check\varphi_{can}$ is an $S'$-flag on $H'$, where $S'$ is the image of 
  $S(H,L,x)$ in $D'$.  %Lemma~\ref{lemma:flag-set-quotient}.
  %under the identification of $\varphi$ with a boolean-valued
  %function on $H'$ ().
\end{enumerate}
\end{definition}

%\item $H$ is a hypermap.
%\item $\cal L$ is a normal family of $H$.
%\item $L$ is a contour loop in ${\cal L}$.
%\item $x$ belongs to the dart set of $L$.
%\item $\varphi$ is a boolean function on the faces of $H'$.
%\item The set $S(H,L,x)$ maps bijectively to a set $S'$
%of darts in the quotient.






\begin{example}[illustration]\label{ex:graph-gen}  
  This example illustrates the markup (Figure~\ref{fig:graph-gen}).
  In the figure, the hypermap $H$ is represented as a planar graph.
  The contour loops are represented by left-side shadings of the edges
  of the planar graph.  The shaded edges give the edges of a planar
  graph representing the quotient.  The polygons that are fully shaded
  are true.  Two polygons in the quotient are false.  A dart of $H$ in
  a false contour loop $L$ in $H'$ is marked $x$.  By inspection,
  $S(H,L,x)=\{f x,f^2 x,f^3 x\}$.  By inspection,
  $\check\varphi_{can}$ is an $S'$-flag.  (In fact, the darts in true
  faces form a connected region.  Every edge in the quotient except
  $\{f' x', e' f' x'\}$ meets a true face, and this one edge meets
  $S'$.)
%% XX recheck
\end{example}

\begin{figure}[htb]
\centering
\szincludegraphics[width=90mm]{\pdfp/graph_gen.eps}
\caption{An example of the current situation.}
\label{fig:graph-gen}
\end{figure}

\begin{definition}[$m$,$p$,$q$,$y$,$z$]\guid{BVUFRRE}\label{def:yz}
Let $(H,{\cal L},L,x)$ be a marked hypermap.
Several lemmas use the following natural numbers $m,p,q$ and darts $y,z$.
Set  $y = f^{m+1} x$, where $m = \card(S(H,L,x))$.
  Set
$z=f^{p+1} y$, where $p$ is the smallest natural number 
%Then there is a smallest $p\ge0$,
such that some contour loop in ${\cal L}$ visits $f^{p+1} y$.
Let $x'$ and $z'$ be the images of $x$ and $z$ respectively in $H/{\cal L} = (D',e',n',f')$.
Let $q$ be the smallest natural number such that $z' = (f')^{q+1} x'$.  
\end{definition}
\indy{Notation}{m@$m$ (face map exponent)}
\indy{Notation}{p@$p$ (face map exponent)}
\indy{Notation}{y@$y$ (dart)}
\indy{Notation}{z@$z$ (dart)}

The existence of $q$ follows from the following lemma showing that $x'$ and $z'$
lie in the same face $\F(L)$ of $H/{\cal L}$.  (The existence of $q$ is trivial
when $L$ is canonically true.)

\begin{lemma}[loop confinement]\guid{HQYMRTX}\rating{200} \label{lemma:yz}
Let $(H,{\cal L},L,x)$ be a marked hypermap.
Assume that  $L$ is canonically false. % canonically true assumption not needed.
Let the natural number $m,p$ and darts $y,z$ be given by Definition~\ref{def:yz}.
Then, $L$ visits $z$, and $z\ne f^k x$ when $0 < k \le {m+1}$.
\end{lemma}

\begin{proof} 
%We break the proof into two cases, depending on whether $L$ is canonically true.
%
%\claim{[$L$ is canonically true.]}  In this case $S=\emptyset$,  $m=0$, $p=0$, $k=1$,
%$y = f x$, and $z = f y = f^2 x$.  Also, $L = \lp{x;f x;f^2 x;\ldots}$, and it clearly
%visits $z$.  If $z=f^k x = y$, then $x=y=z$ is a fixed point of $f$.
%
%This completes the first case.
%
%\claim{[$L$ is canonically false.]} In this case,
  For a contradiction, suppose $f^{p+1} y = f^k x$, for some $0<k\le
  m+1$.  Then also, $f^p y = f^{k-1} x$.  If $p>0$, then this
  contradicts the minimality of $p$.   (Note that $L$ visits $f^{k-1}x$ by the
definition of $S$ and $m$.)  So $p=0$, and $y=f^{k-1} x =
  f^{m+1} x$.  Also, $0\le k-1 < {m+1}$, which implies that the face of $x$ has size at
most $m+1$.  This  forces $L$ to be canonically true, which is contrary to assumption.  This proves the second
  conclusion of the lemma.  In particular, $z\not\in S$, where $S =
  S(H,L,x)$.

Let $L'$ be the contour loop of ${\cal L}$ that visits $z$.  For a contradiction,
assume that $L'\ne L$.

\claim{$L'$ is false.}  Otherwise, $L'$ is true with respect to the
canonical flag and it therefore a loop consisting entirely of
$f$-steps.  In particular, $L'$ visits $z,x$, and $y$.  This is
contrary, to the assumption that the contour loop containing $x$ is
false.

Let $H' = (D',e',n',f') = H/{\cal L}$, and let $S'$ be the image of $S$ in $D'$.
Let $z' = [\ldots;u]\in D'$ be the
image of $z$ in $D'$.    
As $z\not\in S$, we also have $z'\not\in S'$.
By the definition of
$S'$-flag, the dart $e'z'$ lies in a true face or $e'z'\in S'$.  
This disjunction splits
splits the proof into two cases.
\begin{enumerate}
\item\claim{[$e'z'$ lies in a true face.]}  In this case, 
\begin{displaymath}
e'z' = f^{-1} n^{-1} [\ldots,u] = f^{-1} [n^{-1}u;\ldots],
\end{displaymath}
so that $n^{-1} u$ is visited by a true contour loop.
Consider the following
path in $H$:
\begin{displaymath}
[y;fy;\ldots;z] @ [n^{-1}z;\ldots;u] @ [n^{-1} u;\ldots;n^{-1} x].
\end{displaymath}
The first segment consists of $f$-steps; the second of $n^{-1}$-steps;
and the third segment exists within true contour loops of ${\cal L}$
by the connectedness of true faces (by properties of flags).  This
path satisfies all the assumptions of Lemma~\ref{lemma:contour-f}.  (In particular,
the node of $n f x$ (or of $f x$)  is distinct from the node of $x$ by the
assumed simplicity of the quotient $H/{\cal L}$.)
The lemma asserts that the path does not exist.
\item 
\claim {[$e'z'\in S$.]}  In this case,  
$f^{-1}n^{-1}u \in S$ and $L$ visits $n^{-1} u$ at the node of $z$.
Consider the following path of $f$-steps in $H$:
\begin{displaymath}
[y;f y;\ldots;z].
\end{displaymath}
This path satisfies all the enumerated conditions of
Lemma~\ref{lemma:contour-f}.  (In particular, $y$ and $z$ are at
different nodes by the assumed simplicity of the quotient $H/{\cal
  L}$.)  The lemma asserts that the path does not exist.
\end{enumerate}
\end{proof}

\begin{lemma}[parameters]\guid{QRDYXYJ}\label{lemma:parameters}
Let $(H,{\cal L},L,x)$ be a
marked hypermap, where $H$ is restricted. Assume that $L$ is canonically false.
Let $m,p,q$ be the natural numbers and let $x,y,z$ be the darts given by
Definition~\ref{def:yz}.  Let $r = \op{card}(\F(L))$.  Then
\begin{displaymath}
0\le p,\quad 0\le m < q < r,\quad m+1 < p+q.
\end{displaymath}
Furthermore, the darts $x$, $y$ belong to different nodes; the darts
$y$ and $z$ belong to different nodes.
\end{lemma}

\begin{proof}
Let $H/{\cal L}=(D',e',n',f')$.  Let $y'$ and $z'$ be the images of $y$ and $z$
in $D'$, respectively.  Let $S'$ be the image of $S(L,x)$ in $D'$.
By definition $m = \op{card}(S(L,x))$.  Both $m$ and $p$ are natural numbers,
so $0\le p$ and $0\le m$. 

\claim{The darts $x$, $y$ belong to different nodes; the darts $y$ and
  $z$ belong to different nodes.}  Indeed, $x$, $y$, and $z$ belong to
the same face.  By the simplicity of $H$, if two of these darts belong
to the same node, then they are equal to each other.  However, $x\ne
y$, for otherwise the subpath $P=[x;f x;\ldots;f^{m+1}x]$ gives a canonically true contour loop, which is contrary to the assumption that $L$ is
canonically false.  Also, $y\ne z$, for otherwise the face of $y$ is
equal to $\{y,f y,f^2 y,\ldots,f^p y\}$.  It follows that $x = f^k y$
is visited by $L$, for some $1<k\le p$.  This contradicts the defining
minimality property of $p$.

\claim{$q<r$.}  Indeed,
by definition, $z' = (f')^{q+1} x'$ and no smaller natural
number has this property.  Also, $x'$ and $y'$ belong to the face $\F(L)$.
If $q\ge r$, then $(f')^{q+1} = (f')^{q-r+1}$, which contradicts the minimality of $q$.

\claim{$m<q$.} Indeed, if $0\le k< m$, then
\begin{displaymath}
(f')^{k+1} x' = [f^{k+1} x]\in S', \quad z' \not\in S',
\end{displaymath}
by Lemma~\ref{lemma:flag-set-quotient} and Lemma~\ref{lemma:yz}.
Thus, $0\le q< m$.  Also, $q\ne m$, for otherwise $z' = (f')^{m+1} x'
= y'$.  This implies that $z$ and $y$ lie in the same node, which has
been proved impossible.  This completes the proof that $m<q$.
 
\claim{$m+1 < p+q$.}  Indeed, the inequalities $0\le p$ and $m<q$ imply
that either $m+1 < p+q$ or $p=0~\land~m+1=q$.  The second disjunct
cannot hold, for otherwise $z' = (f')^{q+1} x' = f' y'$.  Write $y' = [y;\ldots;u]$.
This is not a unit path by the definitions of $S(L,x)$ and $m$, so $y\ne u$, but
they lie at the same node.  Also from $p=0$ it follows that $z= f^{p+1} y = f y$.
So $e y$ and $e u$ both lie at the node of $z'$.  The existence of
 two edges, $\{y, e y\}$ and
$\{u, e u\}$, between two nodes contradicts the hypothesis
on $H$ of no double joins.  This proves the claim and the lemma.
\end{proof}

\subsection{transform}

\begin{definition}[transform]\guid{YQANQNF}
  From one marked hypermap $(H,{\cal L},L,x)$ in which $L$ is
  canonically false, we construct a new tuple
\begin{displaymath}
T(H,{\cal L},L,x) = (H,{\cal M},L_1,x),
\end{displaymath}
 called the \newterm{transform} of
  $(H,{\cal{L}},L,x)$.  
As the notation indicates, the hypermap $H$ and the dart $x$ are the same for both
tuples.  The data ${\cal M}$ and $L_1$ are specified in
the following paragraphs.
\end{definition}

Let $m$, $p$, $y$, and $z$ be  given by
Definition~\ref{def:yz}.
Let $L_1$ be 
%With improvised notation, write
%\begin{displaymath}
%L_1 = \lp{L[x:y] \opat P[y:z] \opat L[z:x]},
%\end{displaymath}
the contour loop in $H$ that follows $L$ from $x$ to $y$, then takes
$f$-steps from $y$ to $z$, then continues along $L$ back to $x$.  
Let $L_2$ be
%\begin{displaymath}
%L_2 = \lp{L[n^{-1}y:n z] \opat P^c[n z:n^{-1}y]},
%\end{displaymath}
the contour loop in $H$ that follows $L$ from $n^{-1} y$ to $n z$,
then complements the path of $L_1$ from $y$ to $z$, traveling instead
from $n z$ to $n^{-1} y$. 


Set
\begin{displaymath}{\cal M} = ({\cal L}\setminus \{L\}) \cup
\{L_1,L_2\}.\end{displaymath}

\begin{remark}[canonical compatibility]\guid{HBLIYVM}
There is a canonical boolean function on ${\cal L}$ and one on ${\cal M}$.
The canonical boolean functions agree on the intersection ${\cal L}\cap {\cal M}$.
This means, there is a well defined boolean-valued function on 
${\cal L}\cup {\cal M}$.  There is no ambiguity.  
\end{remark}
\indy{Index}{function!boolean}%

%  Under the bijection between the set of faces of a quotient $H/{\cal
%    L}$ and the family ${\cal L}$ (of
%  Lemma~\ref{lemma:quotient-bijection}), an $S$-flag on a quotient
%  $H/{\cal L}$ can be identified with a boolean function on ${\cal L}$
%  satisfying appropriate properties.  With this in mind, 
%\begin{displaymath}
%\begin{cases}
%\psi(L) = \varphi(L), &\text{if } L\ne L_1,L_2,\\
%\psi(L_2) = \op{true}, &\text{if $L_2$ is canonically true},\\
%\psi(L) = \op{false}, &\text{otherwise}.\\
%\end{cases}
%\end{displaymath}




\begin{figure}[htb]
\centering
\szincludegraphics[width=80mm]{\pdfp/L1L2.eps}
\caption{The loop $L$ is replaced with two loops $L_1, L_2$.}
\label{fig:L1L2}
\end{figure}



%Each of the two
%loops $L_i$ meets at least two nodes (those
%of $y$ and $z$) and has length at least three by
%Lemma~\ref{lemma:3dart}.  
% $S(H,L_1,x)$ contains the proper subset $S(H,L,x)$.


\begin{lemma}[markup transform]\guid{AQIUNPP}\rating{600}\tlabel{lemma:flag} 
Let $H$ be a restricted hypermap.
If $(H,{\cal L},L,x)$ is a marked hypermap such that $L$
is canonically false,  then the transform
$(H,{\cal M},L_1,x)$ 
is also a marked hypermap.
\end{lemma}

\begin{proof} Let 
\begin{displaymath}
H=(D,e,n,f),\   H' =(D',e',n',f') = H/{\cal
    L},\  H'' = (D'',e'',n'',f'') = H/{\cal M}.   
\end{displaymath}
Let $S'$ be the image of $S(H,L,x)$ in $D'$.  Let $y,z$ be the darts
constructed in Definition~\ref{def:yz} from the marked hypermap $(H,{\cal
  L},L,x)$.  The dart $z$ is not at the same node as $y$ (by
the simplicity of $H$).

  The proof can be organized into independent parts, according to the separate
  properties of a marked hypermap.  The first part of the proof
  establishes that ${\cal M}$ is a normal family.


\case{normal-1} \claim{No dart is visited by two different loops.}
Indeed by construction, the sets of darts of $L_1$ and $L_2$
are disjoint from each other and disjont from the sets of darts of $L'\in
{\cal L}\setminus \{L\}$.  The result now follows from the normality of  ${\cal L}$.

\case{normal-2} \claim{Every loop visits at least two nodes.}  Indeed, this
is true for $L_1$ and $L_2$ because they visit the nodes of $y$ and
$z$.  It is true of the other loops because they belong to the
normal family ${\cal L}$. 

\case{normal-3} \claim{If a loop visits a node, then every dart at
that node is visited by some loop.} 
% Indeed, the new nodes visited on the
%sublist of $L_1$ from $y$ to $z$ do not contain any darts in any
%loop in ${\cal L}$.  (By the definition of normal family, if a loop
%visits a node, then every dart at that node is visited by some loop
%of ${\cal L}$.)  These new nodes contain two darts, with one dart
%along $L_1$ and the other along $L_2$.  The paths $L_1$ and $L_2$
%visit every dart visited by $L$.  They visit every dart at the nodes
%of $y,\ldots,z$.
Indeed, the nodes that are visited by some loop in ${\cal M}$ are
precisely those visited by some loop in ${\cal L}$, together with the
``new'' nodes; that is, the nodes of $f y,\ldots,f^p y$.  The set of
darts that are visited by some loop of ${\cal M}$ is the union of the
set visited by loops in ${\cal L}$, together with two darts at the
new nodes.  As each new nodes has only two darts, and as ${\cal L}$ itself
it normal, the result follows. It follows that ${\cal M}$ is normal.  


\case{simple} To prove the simplicity of the quotient, it is enough to show that
none of the contour
loops in ${\cal M}$  ever return to a node after leaving it.
 (More precisely, the dart set of any $L'\in{\cal M}$ intersected with a node
is the dart set of a maximal sublist $[z;n^{-1}z;\ldots;n^{-k}z]$ of $n^{-1}$ steps.)
This is true of $L'\in{\cal L}\setminus\{L\}$ by assumption and true of
$L_1$ and $L_2$ by construction.  Simplicity follows.

\case{fixed-point free} By Lemma~\ref{lemma:nfp}, to prove that $n''$
does not have a fixed-point, it is enought to show that no loop in
${\cal M}$ has a dart set containing a node.  It is sufficient to
consider the loops $L_1$ and $L_2$.  The set of darts of $L_1$ and
$L_2$ at the old nodes (that is, those not meeting $\{f y,\ldots,f^p
y\}$) are subsets of the set of darts of $L$ at those nodes.  As the
dart set of $L$ does not contain an old node, neither do $L_1$ and
$L_2$.  At the new nodes, $L_1$ and $L_2$ both have at least one dart,
so neither contains the entire node.  It follows that $n''$ is
fixed-point free.

\claim{$e'y'\not\in S'$, where $y'$ is the image of $y$ in $H'$. }
Otherwise, write $y' = [y;n^{-1}y;\ldots;u]$, a sublist of $L$, and
pick $k$ such that $e'y' = [f^k x]\in S'$.  Then
\begin{displaymath}
(n')^{-1} y' = f'e'y' = f'[f^k x] = [f^{k+1}x;\ldots].
\end{displaymath}
By the construction of $S(H,L,x)$, we know that $L$ visits $f^{k+1}x$.
Hence $y'$ and $(n')^{-1}y'$ both lie in the same node and in the same
face $\F(L)$.  By the simplicity of $H'$, it follows that $y' =
(n')^{-1} y'$.  That is, $y'$ is a fixed point of $n'$.  This is contrary to
assumption. The claim follows.


\claim{$e'y'$ lies in a true face of $H'$.}  Indeed,
 since $\check\varphi_{can}$ is
an $S'$-flag on $H'$, the edge $\{y',e'y'\}$ meets a true face or
$S'$.  However, $y'\not\in S'\subset \F(L)$, by the simplicity of $H$.  Also,
$e'y'\not\in S'$, by the previous paragraph.
The dart $y'$ lies in the false face $\F(L)$.  The only
remaining possibility is that $e'y'$ lies in a true face.  



\case{flag-1} \claim{The true faces of $H''$ are
  connected.}  Indeed,  $L_1$ is connected to a true face
by the contour path $[x;n^{-1} x]$, because $n^{-1} x$ lies
in the same face as $n f x$, which is a true face by assumption.
If $L'\in{\cal M}\setminus\{L_1,L_2\}$ is a true, then $L'\in  {\cal L}$, and
it connects with the true faces of ${\cal L}$ as before.
If $L_2$ is true, then the proof requires more
argument.   Write $y'=[y;\ldots;u]$ as above.
The dart $u''=[n^{-1}y;\ldots;u]$ of $H''$ lies in the face $\F(L_2)$.
Also, 
\begin{displaymath}
(n'')^{-1} u''= [n^{-1} u;\ldots] = [f e u;\ldots] = f'' [\ldots; e u]
  = f'' e' y'
\end{displaymath}
Thus, we have a contour path from $u''$ to $e'' y'$, which lies in a
true face, by an earlier claim.  (The dart $e'y'$ is naturally
identified with the dart $e'' y'$ on in $H''$, because the faces are
true.)  Hence a path exists from the true face $\F(L_2)$ into another
true face, and from there any true face may be reached.

\case{flag-2} \claim{Each edge of $H''$ meets a true face or $S''$, where $S''$ is
the image of $S(H,L_1,x)$ in $D''$.}
Indeed, the function $\check\varphi_{can}$ is an $S'$-flag on $H'$.  The edges of
$H'$ can be identified with a subset of the edges of $H''$.  For this
subset, the flag condition on edges is immediate.  Consider the
new  edges  (that is, edges of $H''$ that are not in $H'$).
They all meet $\{y,f y,\ldots,f^p y\}$.  This set is either contained
ini $S(H,L_1,x)$ (when $F_1$ is false), or is contained in the true face
$F_1$ (when $F_1$ is true).  Hence each new  edge meets
a true face or $S''$.


The other verifications are routine.
\end{proof}


\subsection{digraph}

The aim is to prove that every restricted hypermap with a given bound
on the size of the dart set is generated by a particular algorithm.
The proof is a long induction argument.  The proof starts by showing
how to go from one partially constructed hypermap to another more
fully constructed hypermap.  The hypermap $H$ represents the fully
constructed hypermap and two quotients $H/{\cal L}$ and $H/{\cal M}$
represent the partially constructed hypermaps.  The algorithm involves
the transition from the hypermap $H/{\cal L}$ to $H/{\cal M}$.  The
transition from one quotient to another is given by the transform of
marked hypermaps.  The transform thus represents one step of the
algorithm.  \indy{Notation}{M@$\cal M$ (normal family)}%


\begin{definition}[digraph,~vertex,~edge,~head,~tail,~sink,~path]\guid{AVXKIRW}
  A \newterm{digraph} (directed graph) is an ordered pair $(V,E)$
  where $V$ is any set, and $E$ is a set of ordered pairs of vertices.
  An element of $V$ is called a \newterm{vertex}.  An element of $E$
  is called a \newterm{directed edge}.  If $(v,w)\in E$, then $v$ is
  the \newterm{head} and $w$ is the \newterm{tail} of the directed
  edge.  A vertex $v$ is a \newterm{sink} if it is not the head of any
  directed edge.  A path $P=[v_0;v_1;\ldots;v_{k-1}]$ in a digraph is
  a list of vertices, such that $(v_i,v_{i+1})\in E$ for all $i<k-1$.
\end{definition}

\begin{definition}[digraph of a hypermap]\guid{QQHIKFL}
Let $H$ be a restricted hypermap.  Form a directed graph as follows.
The vertex set $V$ of the digraph is the set of all marked hypermaps 
${\cal H}=(H,{\cal L},L,x)$ such that $L$ is canonically false.  
Write $T{\cal H} = (H,{\cal M},L_1,x)$, where $T$ is the transform on $V$.  
The set of tails of directed edges with head ${\cal H}$ is as follows:
\begin{itemize}
\item If every contour loop of ${\cal M}$ is canonically true, then ${\cal H}$ is a sink.
\item If $M$ is canonically false, 
then there is a single tail $T{\cal H}$.
\item If $M$ is canonically true, but not every loop in ${\cal M}$ is canonically true,
then the tails are $(H,{\cal M},M,y)$, where $M$ is a 
canonically false loop in ${\cal M}$ and $y$ is a dart visited by $M$ such
that $y$ is followed by an $f$-step:  $M = \lp{y;f y;\ldots}$.
\end{itemize}
\end{definition}

\begin{lemma}[digraph sink]\guid{XCOXWYJ}\label{lemma:digraph-sink}
Let $(V,E)$ be the digraph of a restricted hypermap $H=(D,e,n,f)$.  Then every path
in $(V,E)$ reaches a sink after at most $\#D$ steps.  Moreover, if ${\cal H}$ is
a sink, and if $T{\cal H} =(H,{\cal M},L_1,x)$ is its transform, then
$H$ is naturally isomorphic to $H/{\cal M}$, under the map that sends
a dart $y$ of $H$ to the unit path $[y]$.
\end{lemma}

\begin{proof} Each step in the path makes one transform.  Each
  transform increases the number of darts visited by the normal
  family.  The number of darts visited by a normal family is bounded
  by $\#D$.  This bounds the length of a path.

  The condition on a sink ${\cal H}$ is that every contour loop of
  ${\cal M}$ is canonically true. 

\claim{${\cal M}$ visits every dart.}  Indeed, let $y$ be any dart of
$H$. Since $H$ is assumed connected, there exists some contour path
$P=[x;\ldots;y]$.  Let $u$ be the last dart on the path that is
visited by ${\cal M}$.  Let $M\in{\cal M}$ be the contour loop that
visits $u$.  Then $u$ is not followed by an $f$-step, because every contour
loop is canonically true: $M = \lp{u;f u;\ldots}$.
Nor is $u$ followed by a $n^{-1}$ because in a normal family every dart
at the node of $u$ is visited by a loop in ${\cal M}$.  Thus, $u$ is the final
dart in the path $P$, which means that $y$ is visited by ${\cal M}$.

It follows that is a bijection between the dart set of $H$ and the
dart set of $H/{\cal M}$, sending a dart $y$ to the unit path $[y]$.
This bijection induces an isomorphism of hypermaps.
\end{proof}


%In the next lemma there are a number of choices to be made.  Let
%$\op{ch}$ be any function on the set of normal families ${\cal L}$ of $H$ containing
%at least one canonically false loop, returning a dart $x'$ of $H/{\cal L}$
%in a false face (with respect to the canonical boolean function).
%Given a normal family ${\cal L}$ (with a canonically false loop),  write
% $x' = [\ldots;x]$ and let $L$ be the the canonically false contour loop of ${\cal L}$ that
%visits $x'$.  Write ${\cal L}\rightsquigarrow (L,x)$.   The dart $x$ of $H$ has the property
%that $L = \lp{x;f x;\ldots}$; that is, $x$ is followed by an $f$-step in $L$.
%
%
%\begin{lemma}[sequence]\guid{YCFWVQJ}\label{lemma:sequence}  
%  Let $H$ be a restricted hypermap.  Fix a choice function $\op{ch}$ as
%  above, and let $F$ be any face of $H$. Then associated with $(\op{ch},F)$, there is a sequence of
%  marked hypermaps ${\cal H}_i = (H,{\cal L}_i,L_i,x_i)$ for
%  $i=0,\ldots,k-1$ such that
%\begin{itemize}
%\item $\varphi'_i$ is the canonical boolean function on $H/{\cal L}_i$, and
%$\varphi_i$ is its lift to ${\cal L}_i$.
%\item ${\cal L}_0$ is the normal family associated with the given face $F$,
%described in Example~\ref{ex:H2}, and ${\cal L}_0 \rightsquigarrow (L_0,x_0)$.
%\item If the contour loop $L$ in the transform $T{\cal H}_i=(H,{\cal M},L,\ldots)$ 
%is canonically false, then ${\cal H}_{i+1} = T{\cal H}_i$.
%\item If the contour loop $L$ in the transform $T{\cal H}_i=(H,{\cal
%    M},L,\ldots)$ is canonically true, and there exists some other
%  contour loop of ${\cal M}$ that is canonically false, then ${\cal
%    H}_{i+1}=(H,{\cal M},M,y,\varphi_{i+1})$, where ${\cal M}\rightsquigarrow (M,y)$. 
%\item The transform $(H,{\cal L}_k,\ldots)$ of $\,{\cal H}_{k-1}$ has
%  quotient $H/{\cal L}_k$ that is naturally isomorphic to $H$.
%\end{itemize}
%\end{lemma}
%
%\begin{proof}
%  Let ${\cal H}_0=(H,{\cal L}_0,L_0,x_0,\varphi_0)$ be given as
%  follows.  Pick any face $F$ of $H$, and construct the normal family
%  ${\cal L}$ of Example~\ref{ex:H2}.
%
%  The construction of ${\cal H}_{i+1}$ depends on the structure of the
%  transform $(H,{\cal M},L,x)$ of ${\cal H}_i$.  We consider
%  three cases.
%\begin{nomerate}
%\item 
%\claim{[Every contour loop of ${\cal M}$ is canonically true.]}   In this case,  by
%Lemma~\ref{lemma:all-dart}, the quotient map $H\to H/{\cal M}$ is an
%isomorphism.  Set $k= i+1$. The sequence terminates.
%\item \claim{[The contour loop $L$ is canonically false.]}  In this
%  case, from the inductive hypothesis that $\varphi'_i$ is the
%  canonical function and the definition of $\psi$, it follows that
%  $\psi'$ is the canonical function.  By Lemma~\ref{lemma:flag}, the
%  transform is a marked hypermap.  Let ${\cal H}_{i+1}$ equal the
%  transform of ${\cal H}_i$.
%\item \claim{[The contour loop $L$ is canonically true, but not all contour loops in
%     ${\cal M}$ are canonically true.]}  In this
%  case, the canonical function on $H/{\cal M}$ is a flag (with
%  $S=\emptyset$).   
%${\cal H}_{i+1}$, as defined, is a marked
%  hypermap.
%\end{nomerate}
%
%The sequence must terminate eventually, because each step
%constructs a quotient of $H$ with more darts than the previous one and
%the number of steps is bounded by the size of the dart set of
%$H$.
%\end{proof}

Next, we wish to describe the directed edges in a way that relies to a
lesser degree on the structural details of the marked hypermaps.
(These details will not be available to us in the algorithm of the
next subsection.)  The next lemma uses reverse doble walkup
transformations to construct a new hypermap from a given hypermap $H'$
that does not require us to represent it first as a quotient $H' =
H/{\cal L}$ for some normal family.
We can immediately relate the to the digraph we
have constructed.   

\begin{lemma}[walkup-digraph]\guid{ISMLATS}\label{lemma:RDW}
Let ${\cal H} =(H,{\cal L},L,x)$ be a marked hypermap,
  with $H$ restricted.  Assume that $L$ is canonically false, and let 
$(H,{\cal{M}},M,x)$ be 
  the transform of $\cal H$.   
Let $m$, $p$, $q$, $y$, and $z$ be
  the constants of Definition~\ref{def:yz}.  Let $x'$ be the
  image of the dart $x$ in $H/{\cal L} = (D',e',n',f')$.
%Then $m,p,q$ satisfy the constraints of
%  Definition~\ref{def:R}, and 
Then $H/{\cal M}$ is isomorphic to $RDW(H/{\cal{L}},x',m,p,q)$.
\end{lemma}


\begin{proof}
%The constraints on $(m,p,q)$ of Definition~\ref{def:R} are satisfied 
%by Lemma~\ref{lemma:parameters}.
%
  By construction, the passage from $H/{\cal M}$ to $H/{\cal L}$
  consists of a double walkups to eliminate the nodes (of size two) at
  $f y$, $f^2 y, \ldots, f^p y$, and then a double walkup to eliminate
  the edge that runs from the the node of $y$ to the node of
  $z$.  %The passage in the other direction from $H/{\cal L}$ to
%$H/{\cal M}$ comes by adding an edge from the node of $y$ to
%the node of $z$ and inserting $p$ new nodes (of degree two)
%along it.
If we play these double walkups in reverse,
one may also pass from $H/{\cal L}$ to $H/{\cal M}$.  
%If
%$m,p,q$ are chosen as above, 
Then $RDW(H/{\cal L},x',m,p,q)$ is isomorphic to
$H/{\cal M}$.  
\end{proof}


\begin{figure}[htb]
\centering
\szincludegraphics[width=80mm]{\pdfp/L1L2dart.eps}
\caption{$H/{\cal L}$ is obtained from $H/{\cal M}$ by double walkup
transformations.}
\label{fig:L1L2dart}
\end{figure}



\subsection{algorithm}

This final section puts the algorithm a precise form, based on
the Knaster-Tarski fixed point theorem.  The Knaster-Tarski fixed
point theorem is a common way to give precise mathematical form to
an algorithm.

\begin{lemma}[Knaster-Tarski]\guid{EAOGWLE}\rating{ZZ}   
Let $X$ be a set.  Let $f:\powerset(X)\to \powerset(X)$ be a
function from the powerset of $X$ to itself.  Assume that $f$ is
monotonic in the sense that whenever $Y\subset Z\subset X$, it
follows that $f(Y) \subset f(Z)$.  Then $f$ has a least fixed point.
That is there exists a set $\op{fix}(f,X)\subset X$ such that
$f(\op{fix}(f,X)) = \op{fix}(f,X)$ and such that the following
minimality condition holds: if $Y\subset X$ is any set such that
$f(Y) \subset Y$, then $Y\subset \op{fix}(f,X)$.
\end{lemma}
\indy{Notation}{X@$X$ (set)}%
\indy{Notation}{f@$f$ (function on powerset)}%
\indy{Notation}{fix@$\op{fix}$~(Knaster-Tarski fixed point)}%
\indy{Notation}{P@$\powerset(\cdot)$ (powerset)}%
\indy{Index}{Knaster-Tarski fixed point theorem}%

\begin{proof} Let $\op{fix}(f,X)$ be the intersection of all subsets
$Y$ of $X$ such that $f(Y)\subset Y$.  It is easily verified that
this set has the required properties.
\end{proof}

Various data are needed for the application of the Knaster-Tarski
fixed-point theorem to the construction of restricted hypermaps.  This
data is presented in a series of definitions.  The first definition
gives a domain $\Omega$ that will contain all the darts of all the
hypermaps that will be constructed by the algorithm.  In practice, we
take $\Omega$ to be a finite subset of the set of natural numbers.

\begin{definition}[$\Omega$,~$\op{ch}$,~$d$]\guid{LVXTTSP}
  Let $\Omega$ be any fixed finite set.  Fix a choice function
  $\op{ch}:\powerset(\Omega)\to \Omega$ that picks an element from
  each nonempty subset:
\begin{displaymath}
X\ne\emptyset\quad  \Rightarrow \quad  \op{ch}(X)\in X.
\end{displaymath}
For example, when
$\Omega$ is a well-ordered set, let $\op{ch}$ choose the least element of a subset
of $\Omega$.  An $(\Omega,d)$-hypermap is a hypermap whose dart set is a
subset of $\Omega$ and such that $d$ is the maximum face size.  A
$(\card(\Omega),d)$-hypermap is one isomorphic to an $(\Omega,d)$-hypermap.
(In applications later in the book, $\card(\Omega)\le14$ and $3\le d\le 6$.) 
\end{definition}
\indy{Notation}{d3@$d$ (upper bound)}%
\indy{Notation}{zzZ@$\Omega$ (set of darts)}%
\indy{Notation}{ch@$\op{ch}$~(choice)}%


The following constructions depend on $\Omega$ and $d$, although the
notation does not reflect this.  One may think of $X_1$ in the next
definition as holding the output of the algorithm and $X_2$ as the
workspace that holds partially constructed hypermaps.

\begin{definition}[$X$,~$X_1$,~$X_2$]\guid{KFPEPWO}
Define a set $X$ as the disjoint union of $X_1$ and $X_2$ as follows.
Let $X_1$ be the set of all $(\Omega,d)$-hypermaps.
Let $X_2$ be the set of tuples $(H,m,\check\varphi,x)$, where 
\begin{itemize}
\item $H$ is an $(\Omega,d)$-hypermap,
\item $\check\varphi$ is an $S$-flag on $H$,
\item  $x$ is a dart in a false face of $H$ (with respect to $\check\varphi$),
\item $m\in\{0,\ldots,d-1\}$, 
and
\item $S = \{f^i x\mid 1 \le i \le m\}$.
\end{itemize}
\end{definition}


The set $A$ in the following definition gives the initialization of the algorithm.

\begin{definition}[A]\guid{JBUOJMF}
Let $H$ be a fixed hypermap isomorphic to $\op{Dih}_{2d}$, with darts in $\Omega$.
Let $\check\varphi$ be the flag on $H$ (with one true face and one
false face).  Let $x$ be the value of the choice function on the false
face.  Set
\begin{displaymath}
A = \{(H,m,\check\varphi,x) \mid 0\le m \le d-1\} \subset X_2.
\end{displaymath}
\end{definition}

The following set gives the indexing set for the iteration of the algorithm.

\begin{definition}[C]\guid{IDDKWYX}
Let $C$ be the set of of $4$-tuples $(m,p,q,r)$ that satisfy the following
constraints:
\begin{itemize}
\item $0\le m < q < r$.
\item $0\le p$.
\item $m+1 < p+q$.
\item $m+p+2 \le d$.
\item if $q+1< r$, then $m+p+3\le d$.
\end{itemize}
\end{definition}

\begin{definition}[extension]\guid{ZMVBANY}  
  Let $(H,m,\check\varphi,x)\in X_2$.  Choose $p,q$ such that $(m,p,q,r)\in
  C$, where $r$ is the cardinality of the face of $x$.  Let $F$ be the
  face of $x$ in $H$.  It follows by construction, that every face
  $F'\ne F$ of $H$ is naturally identified with a face of
  $RDW(H,x,m,p,q)$.  Say that a boolean-valued function $\check\psi$ on the
  set of faces of $RDW(H,x,m,p,q)$ is an \newterm{extension} of
  $\check\varphi$ on $H$ if $\check\psi(F') =\check\varphi(F')$, when $F'\ne F$.
  \indy{Index}{extension}%
\end{definition}


The functions $f$ and $g$ give one iteration of the algorithm.  The
powerset-valued function $g$ is the heart of the algorithm.  It takes
one partially constructed hypermap and modifies it in various ways to
construct further partially constructed hypermaps.  When the flag
$\check\varphi$ permits, some hypermaps are also fully constructed.


\begin{definition}[g]\guid{DMAMRYR}
 Let $g:X_2 \mapsto \powerset(X)$ be given as
  follows.  Let $r$ be the cardinality of the face $F$ of $x$.  The
  subset $g(H,m,\check\varphi,x)\subset X$ is presented as a union of two
  sets:
\begin{displaymath}
   Y_i = X_i \cap g(H,m,\check\varphi,x).
\end{displaymath}
 $H'\in Y_1$ if and only 
\begin{itemize}
\item there exists
$p,q$ with $(m,p,q,r)\in C$ such that $H'=RDW(H,x,m,p,q)$,
and 
\item $\check\varphi(F')$ is true for all $F'\ne F$.
\end{itemize}
 $(H',m',\check\psi,x')\in Y_2$ if and only if
\begin{itemize}
\item there exists $p,q$ with $(m,p,q,r)\in C$, such that $H'=RDW(H,x,m,p,q)$,
\item  $\check\psi$ is an extension of
$\check\varphi$, and 
\item Let $F_1$ be the face of $x$ in $H'$.  One of the following two
  conditions hold:
\begin{itemize}
\item $\check\psi(F_1)$ is false;  $x' = x$; and  $p+m+1 \le m' < r$.
\item $\check\psi(F_1)$ is true; there exists a false face in $H'$; $x'$ is
  the value of the choice function on the union of false faces of
  $H'$; and $0 \le m' < r$.
\end{itemize}
\end{itemize}
\end{definition}


\begin{definition}[f]\guid{YSJTEDX}
Given the function 
$g:X_2 \to \powerset(X)$, set 
\begin{displaymath}f(S) = A \cup (\bigcup \{g(s) \mid s\in S\cap
X_2\}).\end{displaymath}
\indy{Notation}{g@$g$(function)}%
\end{definition}

Any function $f :\powerset(X)\to \powerset(X)$ of this form is
monotonic.  Thus, we have a Knaster-Tarski fixed point set
$\op{fix}(f,X)$.  The main result of this chapter is that a fixed
point construction generates all restricted hypermaps:

\begin{theorem}[hypermap algorithm]\guid{BRGEFNH}\rating{2000}  
\label{lemma:algorithm}
Define $f $ and $X$ as above (depending on $d\ge 3$ and $\Omega\ne
\emptyset$) .    Then every restricted hypermap with at
most $\card(\Omega)$ darts and such that the largest face has size  $d$
is isomorphic to a hypermap in $\op{fix}(f,X)\cap X_1$.
\end{theorem}


In informal terms, by starting with the \newterm{seed} hypermaps in $A$
one may find all restricted hypermaps (for given $\Omega$ and $d$) by
applying the function $f$ repeatedly:
\begin{displaymath}
A_0 = A = f(\emptyset),\quad A_1 = f(A_0),\quad A_2 = f(A_1),\ldots
\end{displaymath}
and by looking at the output $A_i \cap X_1$.
\indy{Index}{seed}%

The proof will be presented below.  The proof is a matter of correlating the Knaster-Tarski fixed point set with the digraph of a restricted hypermap $H$.
Write $\op{fix}_i$ for $\op{fix}(f,X)\cap X_i$.


\begin{definition}[correlation]\guid{SFBFNVW}
  A marked hypermap $(H,{\cal L},L,x)$ is said to be
  \newterm{correlated} to an element $(H',m',\check\varphi,x')\in X_2$ if
  the following conditions hold:
\begin{itemize}
\item $H/{\cal L}$ is isomorphic to $H'$ by some isomorphism $G$.
\item The image of $x$ in $H/{\cal L}$ maps to $x'$ under $G$.
\item The pull back of $\check\varphi$ under $G$ is the canonical function
$\check\varphi_{can}$ on $H/{\cal L}$.
\item $m = \card(S(H,L,x))$.
\end{itemize}
\end{definition}

\begin{lemma}[correlated seed]\guid{NRDWGYQ}\label{lemma:correlated-seed}
  Let $H$ be a restricted $(\card(\Omega),d)$-hypermap with digraph
  $(V,E)$.  There exist a marked hypermap in
  $V$ and an element in $\op{fix}_2$ that are
  correlated.
\end{lemma}

\begin{proof}  From the definition of $f$, it follows
that $A\subset \op{fix}_2$.  Thus, it suffices to correlate a marked
hypermap with an element of $A$.  Let $(H',\cdot,\check\varphi,x')\in A$.

Let $F$ be a face of $H$ of cardinality $d$.  Form the normal family ${\cal L}$ of example~\ref{ex:H2}.  The quotient $H/{\cal L}$ is isomorphic to $\op{Dih}_{2d}$, hence also isomorphic to $H'$.  The isomorphism can be chosen so that
$\check\varphi$ pulls back to $\check\varphi_{can}$ on the faces of $H/{\cal L}$, and so that $x'$ is the image of a dart $x$ in the canonically false 
face of $H/{\cal L}$.  

Let $m = \card(S(H,L,x))$.  Then $(H,{\cal L},L,x)$ is a marked hypermap that
is correlated with $(H',m,\check\varphi,x')\in A$.
\end{proof}

\begin{lemma}[correlated edge]\guid{FDQZOSJ}\label{lemma:correlated-edge}
  Let $H$ be a restricted $(\card(\Omega),d)$-hypermap with digraph $(V,E)$. 
  Assume that ${\cal H}\in V$ is not a
  sink and is correlated with an element in $\op{fix}_2$.
  Then there exists a directed edge  $({\cal H},{\cal H}')\in E$, such that
 $\cal H'$ is correlated with an element of  $\op{fix}_2$.
\end{lemma}

\begin{proof}  Assume that the marked hypermap ${\cal H}=(H,{\cal L},L,x)$
is correlated with the tuple $(H',m,\check\varphi,x')\in \op{fix}_2$,
by means of an isomorphism
\begin{displaymath}
G: H/{\cal L} \to H'.
\end{displaymath}
Let $T{\cal H} = (H,{\cal M},L_1,x)$ be the transform.  Let $m,p,q,x,y,z$
be the parameters of Definition~\ref{def:yz}.  Let $r$ be the cardinality
of $\F(L)$, which is equal to the cardinality of the face of $x'$ in $H'$.  
Then $(m,p,q,r)\in C$ by Lemma~\ref{lemma:yz}.

Let $H'' = RDW(H',x',m,p,q)$.  The isomorphism $G$ and Lemma~\ref{lemma:RDW} combine to give an isomorphism $G':H/{\cal M} \mapsto H''$.
Push the canonical function on the faces of $H/{\cal M}$ to a function
$\check\psi$ on the faces of $H''$.

If $L_1$ is false, then $({\cal H},T{\cal H})$ is a directed edge of the digraph, and
$T{\cal H}$ is correlated with $(H'',m',\check\psi,x')\in g(H',m,\check\varphi,x')\subset \op{fix}_2$, where $m'=\card(S(L_1,x))$.  

If $L_1$ is true, then $H''$ has a false face, and the choice function $\op{ch}$ picks a dart $x''$ in the union of the false faces of $H''$.  Transport this by $G$ to a dart $y'\in H/{\cal M}$ in a false face.  Write $y'=[\ldots;y]$
with $y$ a dart visited by a false contour loop $M$ of ${\cal M}$.  Then
$(H,{\cal L},L,x),(H,{\cal M},M,y))$ is a directed edge of the digraph,
whose tail is correlated with $(H'',m',\check\psi,x'')\in g(H',m,\check\varphi,x')\subset \op{fix}_2$, where $m'=\card(S(M,y))$.
\end{proof}

\begin{lemma}[correlated sink]\guid{RIZGJVS}\label{lemma:correlated-sink}
Let $H$ be a restricted $(\card(\Omega),d)$-hypermap with digraph $(V,E)$.
Then some sink in the digraph is correlated with some element of
$\op{fix}_2$.
\end{lemma}

\begin{proof} Start with any  correlated pair $({\cal
    H}_0,{\cal K}_0)$ with ${\cal H}_0\in V$ and ${\cal K}_0\in \op{fix}_2$ 
  (Lemma~\ref{lemma:correlated-seed}).  Use
  Lemma~\ref{lemma:correlated-edge}, to produce a sequence $({\cal
    H}_i,{\cal K}_i)$ of correlated pairs, where $[{\cal H}_0;{\cal
    H}_1;\ldots]$ is a path in the vertex set $V$.  By Lemma~\ref{lemma:digraph-sink},
  the path reaches a sink within $\#D$ steps.  The final marked
  hypermap ${\cal H}_k$ in the path is a sink that is correlated with
  ${\cal K}_k\in X_2$.
\end{proof}

\begin{proof} Turn to the proof of Theorem~\ref{lemma:algorithm}.  Let
  $(H,{\cal L},L,x)$ be a sink that is correlated with some tuple
  $(H',m,\check\varphi',y')\in \op{fix}_2$
  (Lemma~\ref{lemma:correlated-sink}).  By
  Lemma~\ref{lemma:digraph-sink}, $H$ is isomorphic to the quotient
  $H/{\cal M}$, where $(H,{\cal M},\ldots)$ is the transform of the
  sink.  This quotient is isomorphic to $\op{RDW}(H/{\cal
    L},x',m,p,q)$, where $x'$, $m$, $p$, $q$ are given by
  Definition~\ref{def:yz}.  By the correlatedness of the sink, $H$ is
  isomorphic to $H''=\op{RDW}(H',x',m,p,q)$.  By
  Lemma~\ref{lemma:parameters}, $(m,p,q,r)\in C$, where
  $r=\op{card}(\F(L))$.  Under the isomorphism, $r$ is the cardinality
  of the face of $y$ in $H'$.  By the definition of $f$ and $g$,
  $H''\in \op{fix}_1$.
\end{proof}





%
%
%\begin{proof} Let $H$ be a restricted hypermap whose dart set belongs
%  to $D$ and whose greatest face size is $d$.  It has a quotient
%  $H/{\cal L}_0$ isomorphic to $\op{Dih}_{2d}$.  Let ${\cal L}_i = (H,{\cal
%    L}_i,L_i,x_i,\check\varphi_i)$ be the sequence of marked hypermaps
%  constructed in Lemma~\ref{lemma:sequence}.  XX.
%\end{proof}
%
%\begin{proof} Let $H$ be a restricted hypermap whose dart set belongs
%to $D$ and whose greatest face size is $d$.  It has a quotient
%$H/{\cal L}_0$ isomorphic to $\op{Dih}_{2d}$.  By repeating the
%construction of Section~\ref{sec:face-insert}, one obtains a
%sequence of hypermaps $\op{Dih}_i = H/{\cal L}_i$, $i=0,\ldots,N$,
%terminating with a hypermap $H/{\cal L}_N$, which is isomorphic to
%$H$.  The data $m_i,\check\varphi_i,x_i$ is also obtained for each $\op{Dih}_i$.
%
%The tuple $(\op{Dih}_0,m_0,\check\varphi_0,x_0)$ is isomorphic to an element of
%$A$.  By construction, $A\subset \op{fix}(f,X)$.  If the lemma is
%false, there is a smallest $i>0$ for which
%$(H_i,m_i,\check\varphi_i,x_i)\not\in \op{fix}(f,X)$ (or if $i=N$, for which
%$H\not\in \op{fix}(f,X)$).  There are isomorphisms
%$RDW(H_i,x_i,m_i,p_i,q_i) \simeq H_{i+1}$ for appropriate choices of
%$p_i,q_i$.  By construction, when the data belongs to $\op{fix}(f,X)$
%for $i-1$, the data belongs to $\op{fix}(f,X)$ for $i$.  Thus, $H$
%belongs to $\op{fix}(f,X)\cap X_1$.
%\end{proof}
%
%\subsection{old algorithm}
%
%If a hypermap is restricted and $x$ is any dart, then $x$ and $n x$
% lie on different faces.  In particular, a restricted hypermap has at
% least two faces.  To begin the process, take ${\cal L}$ to be the
% normal family of Example~\ref{ex:H2} with two contour loops, whose
% quotient hypermap is a polygon $\op{Dih}_{2d}$.  When the the initial
% contour loop is chosen on a face of maximal size, the natural number
% $d$ is an upper bound on size of a face.
%
% In summary, a process starts with a single polygon and then adds
% edges and nodes of degree two along the inserted edges, to obtain a
% restricted hypermap $H$.
%
% A modification of the process avoids explicit reference to the
% hypermap $H$ and to the normal family ${\cal L}$.  Let $D$ be a
% finite set that contains all the darts for all of the restricted
% hypermaps to be constructed.  For each $d=3,\ldots,\# D$, the
% process generates all restricted hypermaps with greatest face-size
% $d$, with darts in $D$.
%
% The algorithms performs the following initialization.  The initial
% hypermap is the polygonal hypermap $\op{Dih}_{2d}$.  A flag $\varphi$ marks
% one face true and the other false.  A distinguished dart $x$ is
% selected on the false face.  For each $m<d$, set $S=S_m = \{f^i
% x\mid 1\le i\le m\}$.
%
% Each iteration processes a finite list ${\cal H}$ of quadruples
% $(H,m,\varphi,x)$, where $H$ is a simple hypermap, $\varphi$ is an
% $S$-flag, $x$ lies in a false face, and $S = \{f^i x\mid 1\le i\le
% m\}$ for some $m$.  The algorithm terminates when every face of
% every hypermap in ${\cal H}$ is true.  At every step of the
% algorithm, one quadruple with some false face is removed from ${\cal
%   H}$ and finitely many quadruples are returned to ${\cal H}$.
%
% At each iteration the chosen $(H,m,\varphi,x)$ is modified in the
% following ways and each modification is placed back in the list
% ${\cal H}$.  As the natural number $m$ depends on the unknown normal
% family ${\cal L}$, all possible $m < d$ are used.  Similarly, the
% natural number $p < d$ depends on ${\cal L}$, and all possible $p$
% are used.  Any quadruple that is isomorphic to one previously
% considered is discarded as redundant.
%
% In summary, the algorithm constructs of hypermaps.  The process must
% terminate, because the set $D$ is finite, so there are only finitely
% many quadruples (or quadruples up to isomorphism) that construct
% their dart sets from $D$.
%
%\begin{lemma}[]\guid{BRGEFNH}\rating{2000}  Fix $d\ge 3$ and $D\ne \emptyset$.
%  This process constructs in a finite number of steps all restricted
%  hypermaps, up to isomorphism, such that the dart set belongs to the
%  finite set $D$, and whose greatest face size is $d$.
%\end{lemma}




%%%%%%%%%%%%%%%%%

