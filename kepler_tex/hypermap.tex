
%% HYPERMAP

\chapter{Hypermap}\label{chap:hypermap}
\indy{Index}{hypermap}

\section{Basics}



\begin{definition}[hypermap]\label{def:hypermap}  A hypermap is a finite set $D$, together with
three functions $e,n,f:D\to D$ that satisfy
    $$e\ocirc n\ocirc f = I.$$
The elements of $D$ are called {\it darts}.  The functions $e,n,f$
are called the {\it edge map}, the {\it node map}, and the {\it
face map}, respectively.
\indy{Index}{hypermap}
\indy{Index}{dart}
\indy{Index}{edge!map}
\indy{Index}{node!map}
\indy{Index}{face!map}
\indy{Notation}{edgemap@$e (edge map)$}
\indy{Notation}{nodemap@$n (node map)$}
\indy{Notation}{facemap@$f (face map)$}
\end{definition}

%\pdf{dart.pdf}{dart}{The arrowhead represents a dart.}
\begin{figure}[htb]
  \centering
  \szincludegraphics[width=2mm]{\pdfp/dart.eps}
  \caption{This symbol represents a dart.}
  \label{fig:dart}
\end{figure}

\begin{remark}\tlabel{rem:hypermap} A hypermap is an abstraction of
the concept of 
planar graph.  Place a dart at each angle of a planar graph.
One function, $f$, 
cycles counterclockwise around the angles of each face.  
Another function, $n$, 
rotates counterclockwise around the angles at each
node.  A third function, $e$, pairs angles at opposite ends of
each edge  (Figure~\ref{fig:hypermap_ex}).   The hypermap extracts
the data $(D,e,n,f)$ from the planar graph and discards the rest.
\indy{Index}{planar graph}
\end{remark}

\begin{figure}[htb]
  \centering
  \szincludegraphics[width=80mm]{\pdfp/hypermap-ex.eps}
  \caption{Darts mark the angles of a planar graph.  Darts may
  be permuted about faces, nodes, and edges.}
  \label{fig:hypermap_ex}
\end{figure}

A hypermap satisfies 
  \begin{equation}\tlabel{eqn:triality}
  n\ocirc f\ocirc e = f\ocirc e\ocirc n = I.
  \end{equation}
Inverted, this triality becomes
   $$
   n^{-1} \ocirc e^{-1} \ocirc f^{-1} = (f \ocirc e \ocirc n)^{-1} = I.
   $$
This inversion is the abstract form of the the duality between nodes and faces in a planar graph.  Because of these symmetries in the defining relation, there will be multiple versions of theorems about hypermaps, all obtained from one proof by symmetry.

Each function $e,n,f$ is a permutation of $D$.  Write $\#h$ for the number of orbits of a permutation $h$ on $D$.

\indy{Notation}{orbits@$\#h$~ (number of orbits)}

\begin{definition}[path,~connected,~combinatorial~component]  A path from $x_0$ to $x_{k-1}$ is a list of darts $[x_0;x_1;\ldots;x_{k-1}]$ such that $x_{i+1} = h_i x_i$, where $h_i \in \{e,f,n,e^{-1},f^{-1},n^{-1},I\}$ for each $i$.   The contour path is injective if $x_i=x_j$ implies $i=j$. Darts $x$ and $y$ lie in the same combinatorial component if there is a path from $x$ to $y$. (See Lemma~\ref{lemma:er}.)  Write $\#c$ for the number of combinatorial components.  The hypermap is connected if $\#c=1$.
\indy{Index}{path}
\indy{Index}{connected}
\indy{Index}{component!combinatorial}
\indy{Notation}{combinatorialcomponent@$\#c$~ (number of components)}
\end{definition}

\begin{lemma}\rating{50}\label{lemma:er} The relation on the set of darts $x\sim y$ when there is a path from $x$ to $y$ is an equivalence relation.
\indy{Index}{equivalence relation}
\end{lemma}

\begin{proof} This is elementary.
\end{proof}

Write  $P[x_i:x_j]$ for $i<j$ for the subpath $[x_{i+1};\ldots;x_j]$ of $P=[x_0;\ldots;k_{k-1}]$.  (The notation is ambiguous when the path is not injective.)  Write $x::P$ to prepend to a list: $[x;x_0;\ldots;x_{k-1}]$.  Write $\opat$ for the concatenation of lists:
$$
[a;\ldots;b] \opat [c;\ldots;d]  = [a;\ldots;b;c;\ldots;d].
$$
%\indy{Notation}{Z@$\opat$~(concatenation)}


\begin{definition}[node,~face,~edge]  A node is an orbit  under $n$.  A face is an  orbit  under $f$.  An edge is an orbit under $e$. 
\indy{Index}{node}
\indy{Index}{face}
\indy{Index}{edge}
\end{definition}

\begin{definition}[plain,~planar] A hypermap is {\it plain} (carefully note the spelling!) if
$e$ is an involution on $D$ (that is, $e\ocirc e = I$).  A hypermap
is {\it planar} (note the spelling!) if the Euler relation holds:
    $$\# n + \# e + \# f = \# D + 2\, \#c.$$
\indy{Index}{plain}
\indy{Index}{planar}
\end{definition}


\begin{remark}\label{rem:Euler}  The Euler relation for hypermaps harks back
to the Euler relation for planar graphs.
Consider a connected planar graph that satisfies the
Euler relation for the alternating sum of Betti numbers:
    $$b_0 - b_1 + b_2 = 2$$
where $b_0$ is the number of vertices, $b_1$ the number of edges, and
$b_2$ the number of faces of the planar graph (including an unbounded face). The
hypermap $(D,e,n,f)$, made from the planar graph in
Remark~\ref{rem:hypermap}, is plain.
Moreover,
    $$\begin{array}{lll}
    b_0 &= \# n\\
    b_1 &= \# e\\
    b_2 &= \# f\\
    2b_1 &= \# D\\
    1 &= \#c\\
    b_0 - b_1 + b_2  &\# n + (\#e - \#D) + \# f = 2\,\# c.
    \end{array}
    $$
Thus, the hypermap is also planar.
\indy{Index}{Euler relation} 
\end{remark}


\begin{lemma}\guid{TGJISOK}\rating{80}\label{lemma:dart-upper} 
Let $H$ be a connected plain planar hypermap such that every edge has cardinality two.  Assume that
there are at least three darts in every node.  Then
$$
\# D \le (6\, \#f - 12).
$$
\end{lemma}

\begin{proof}  In a plain planar hypermap, the Euler relation is
$$6\, \#f - 12 = 3\,\#D - 6\,\#n,$$
so it is enough to show that
$$
\# D \ge 3\,\#n.
$$
This follows directly by assumption: the set of darts can be partitioned into nodes, with at least three darts per node.
\end{proof}



\begin{definition}[degenerate] A dart is degenerate if it is a
fixed point of one of the maps $e,n,f$; otherwise it is nondegenerate.  
%%It is nondegenerate otherwise.
\indy{Index}{dart!degenerate}
\indy{Index}{dart!nondegenerate}
\end{definition}

\begin{definition}[simple] 
A hypermap is {\it simple} if the intersection of each face with each node contains at most one dart.
\indy{Index}{simple}
\end{definition}


% Moved from cup05_tame.tex section on tame plane graphs. 9/5/07:
\begin{lemma}\guid{ZHQCZLX}\rating{50}\tlabel{lemma:nondegen} 
Let $(D,e,n,f)$ be a simple plain hypermap such that every face has
at least three darts.
Then $n$ has no fixed point.
\indy{Index}{fixed point}
\end{lemma}

\begin{proof}  For a contradiction, let $x$ be a fixed point of $n$. The darts $e x$ and $f x$ lie in the same node and face, so are equal in the simple hypermap.  Indeed, they lie in the same node because $n(f x) = e^{-1} x = e x$. They lie in the same face because     
  $$f^2 (e x) =  f(n^{-1} x) = f x.$$
So $e x = f x$.   Thus, $f^2 (e x) = f x = e x$, and $e x$ lies on a face with at most two darts.  This contradicts what is given.
\end{proof}




\section{Walkup}

To focus on a dart $x$ in a
hypermap, it can be useful to draw a hexagon around $x$ and place
the six darts $e x$,
$f x$, $e^{-1} x$, $n x$,  $f^{-1} x$, $e x$, $n^{-1} x$  at its corners
in Figure~\ref{fig:dart+}.  Some of these $7$ darts may be
equal to one another, even if the figure draws them apart.
Figure~\ref{fig:dart-fix} shows the layout of a degenerate darts.

\begin{figure}[htb]
  \centering
  \szincludegraphics[width=40mm]{\pdfp/dart+.eps}
  \caption{A dart $x$ and its entourage}
  \label{fig:dart+}
\end{figure}

\begin{figure}[htb]
  \centering
  \szincludegraphics[width=60mm]{\pdfp/dart-fix.eps}
  \caption{A dart fixed under a face map.}
  \label{fig:dart-fix}
\end{figure}


A {\it walkup} deletes
a dart from a hypermap and reforms the edge, node, and face
maps to produce a hypermap on the reduced set of darts.  Walkups
come in three flavors: edge walkups, face walkups,
and node walkups.

\begin{definition}[walkup]
Let $x$ be a dart in a hypermap.  The edge walkup 
$W_e$ at $x$ of the hypermap is the hypermap
$(D',e',n',f')$, where $D' = D\setminus\{x\}$ and the
the maps skip over $x$:
    $$
    \begin{array}{lll}
    f' y &= \text{ if } (f y =  x) \text{ then } f x \text{ else
    } f y\\
    n' y &= \text{ if } (n y = x) \text{ then } n x \text{ else
    } n y\\
    e' &= (n'\ocirc f')^{-1}
    \end{array}
    $$
\indy{Index}{walkup}
\indy{Index}{edge!walkup}
\indy{Index}{face!walkup}
\indy{Index}{node!walkup}
\end{definition}

Figure~\ref{fig:walk} shows
the result of an edge walkup on the hexagon around a dart $x$.
The triality symmetry~\ref{eqn:triality}, applied to the definition
of edge walkups, yields the definition of
face walkup $W_f$ and node walkup $W_n$.  
%Figure~\ref{fig:walkfn} shows the result of the face and node walkups on the hexagon around a dart $x$.

A walkup at $x$ is said to be degenerate if the dart $x$ is degenerate.   At a degenerate dart $x$, all three walkups are equal: $W=W_e=W_n=W_f$ (Figure~\ref{fig:walkdegen}).
\indy{Index}{walkup!degenerate}

\begin{figure}[htb]
  \centering
  \szincludegraphics[width=80mm]{\pdfp/walk.eps}
  \caption{The effect of a walkup at $x$}
  \label{fig:walk}
\end{figure}


\begin{figure}[htb]
  \centering
  \szincludegraphics[width=80mm]{\pdfp/walkdegen.eps}
  \caption{The effect of a walkup at a degenerate dart}
  \label{fig:walkdegen}
\end{figure}


\begin{definition}[merge,~split]\tlabel{def:merge-split} Let $h=n,e$, or $f$.
A walkup $W_h$ at $x$ merges,
if the walkup joins the orbit of $h$ through $x$ with another orbit.  
It splits, if the walkup splits the orbit at $x$ into two orbits.
\indy{Index}{split}
\indy{Index}{merge}
\indy{Index}{orbit}
\end{definition}

\begin{lemma}\guid{ZMFKZNH}\rating{150}\tlabel{lemma:merge-split} 
Every nondegenerate walkup merges or splits. The nondegenerate walkup $W_h$ at $x$ merges if and only if $x$ and $y$  lie in distinct $h$-orbits, where $(h,y)=(f,e x)$.   (The lemma also holds for $(h,y)=(e,n x)$ and other cases generated
by triality.)
\end{lemma}

\begin{proof} The walkup $W_f$ splits if and only if $f x$ 
(or $x$)
and $e x$ lie in the same $f$-orbit before the split. 
Figure~\ref{fig:split} makes this clear.
\end{proof}


\begin{figure}[htb]
  \centering
  \szincludegraphics[height=90mm]{\pdfp/split.eps}
  \caption{The face walkup at $x$ mixes $f$-orbits.   If it mixes a single orbit,   the orbit splits. If it mixes   two separate    orbits, the orbits merge. }
  \label{fig:split}
\end{figure}


\subsection{walkup and planarity}
\indy{Index}{walkup}
\indy{Index}{planarity}

\begin{definition}[planar~index] The planar index of a hypermap is
$$\iota = \# f + \# e + \# n - \# D - 2\,\# c.$$
(A hypermap with null index is planar.)
\indy{Index}{hypermap!planar index}
\end{definition}

\begin{lemma}\guid{IUCLZYI}\rating{400}\tlabel{lemma:index} Let $x$ be a nondegenerate dart of a hypermap $(D,e,n,f)$. Let $(D',e',n',f')$ be the result of the face walkup $W$ at $x$.  
The walkup changes the size of some orbits.
    $$
    \begin{array}{lll}
    %\text{\bf Non-degenerate dart $x$: }&\\
    \# f' &=\# f +\op{split}_f  \\  
    \# e'&=\# e \\
    \# n'&=\# n \\
    \# D'&=\# D - 1 \\
    \#c'&=\# c + \op{split}_c\\
    \iota' &= \iota + 1+\op{split}_f - 2\op{split}_c.\\
    \end{array}
    $$
where
   $$
   \op{split}_f = \begin{cases}
     1 & W \text{ splits }\\
    -1 & W \text{ merges}\\
   \end{cases}
   $$
and $\op{split}_c=1$ if $e x$ and $f^{-1} x$ belong to the different connected components after the walkup $W$, and $\op{split}_c=0$ otherwise. Moreover, a walkup at a degenerate dart preserves the planar index.
\indy{Notation}{splitc@$\op{split}_c$}
\indy{Notation}{splitf@$\op{split}_f$}
\end{lemma}

\begin{proof} The figures make this clear.
\end{proof}

\begin{lemma}\guid{BISHKQW}\rating{100}\tlabel{lemma:planar-index2}
Let $\iota$ be the index of a  hypermap $(D,e,n,f)$, and let $\iota'$ be the index after a walkup $W_h$ at a dart $x$.  Then $\iota \le \iota'$.
\end{lemma} 


\begin{proof}  Without loss of generality, by triality symmetry,  the walkup is an face walkup.  If $\op{split}_c=0$, the inequality is immediate.  If $\op{split}_c=1$, 
$e x$ and $f^{-1} x$ lie in different components after the walkup, hence also in different faces.  Thus, the walkup splits and $\op{split}_f = 1$.  The result follows.
\end{proof}


\begin{lemma}\guid{FOAGLPA}\rating{50}\tlabel{lemma:planar-nonpos}  
The planar index
of a hypermap is never positive.
\end{lemma}

\begin{proof}  An face walkup never decreases the index.  A sequence
of face walkups leads to the empty hypermap, which has
index zero.
\end{proof}


\begin{lemma}\guid{SGCOSXK}\rating{50}\tlabel{lemma:walkup-planar}
Walkups take planar hypermaps to planar
hypermaps.
\end{lemma}

\begin{proof}  
A planar hypermap has maximum index.  The walkup
can only increase the index, but never beyond its maximum.  
Thus, the index remains at its maximum value.
\end{proof}


\subsection{double walkup}
\indy{Index}{walkup!double}

A double walkup is the composite of two walkups of the same type.  The two darts for the two walkups  are to be the members of an orbit of size two (under $n$, $e$, or $f$).  
%%XX?The first walkup is to be chosen so that it merges.  
The second walkup is to be degenerate. By choosing the type of the walkups to be different from the type of the orbit, the first walkup reduces the orbit to a singleton, forcing the second walkup to be degenerate. 
 
Here are some examples.
\begin{itemize}
    \item A double $W_n$ along an edge deletes the edge and 
   merges the two endpoints into
    a single node (Figure~\ref{fig:doublenode}). 
    \item A double $W_f$ along an edge 
    deletes the edge and merges the two faces along the edge into
    one (Figure~\ref{fig:doubleface}).
    \item A double $W_e$ at a node of degree two
    deletes the node and merges the two edges at the node into
    one (Figure~\ref{fig:doubleedge}).
\end{itemize}


\begin{figure}[htb]
  \centering
  \szincludegraphics[width=90mm]{\pdfp/double-node-walkup.eps}
  \caption{The double node walkup applied to an edge}
  \label{fig:doublenode}
\end{figure}


\begin{figure}[htb]
  \centering
  \szincludegraphics[width=90mm]{\pdfp/double-face-walkup.eps}
  \caption{The double face walkup applied to an edge}
  \label{fig:doubleface}
\end{figure}


\begin{figure}[htb]
  \centering
  \szincludegraphics[width=80mm]{\pdfp/double-edge-walkup.eps}
  \caption{The double edge walkup applied to a node}
  \label{fig:doubleedge}
\end{figure}

\begin{figure}[htb]
  \centering
  \szincludegraphics[width=80mm]{\pdfp/double_edge.eps}
  \caption{The double edge walkup preserves plainness.}
  \label{fig:doubleplain}
\end{figure}


\begin{lemma}\guid{HOZKXVW}\rating{150}\tlabel{lemma:dwalk-planar}  
The three preceding double walkups carry plain
hypermaps into plain hypermaps.
\end{lemma}
\indy{Index}{hypermap!plain}

\begin{proof} The walkups $W_n$ and $W_f$ preserve the orbit structure of edges, except for dropping one dart.  By dropping both darts from the same edge, one edge is lost and all others edges remain unchanged.

Figure~\ref{fig:doubleplain} illustrates the double $W_e$.  The two edges $\{x,e x\}$, $\{y, e y\}$ meeting the node are fused by the double walkup into $\{e x, e y\}$, which is still an edge of size two.
\end{proof}

The following is a useful way to tell if a walkup merges.


\begin{lemma}\guid{FKSNTKR}\rating{80}\tlabel{lemma:ng-merge}  
Suppose, in a simple plain hypermap, that an edge $\{x,y\}$ consists of two nondegenerate darts.  Then the walkup  $W_f$ (resp. $W_n$) at $x$  merges.
\end{lemma}
\indy{Index}{merge}

\begin{proof} 
The darts $f x$ and $e x$ lie in the same node: $n (f x) = e^{-1} x = e x$. If they are also in the same face of a simple hypermap, then $f x = e x
= y$. So 
  $$n y  = n f x = n f e y = y,$$
and $y$ is a fixed
point of $n$, hence degenerate, contrary to assumption.  
Thus, $f x$ and $e x$ are in different faces, and the walkup merges
by Lemma~\ref{lemma:merge-split}.  
\end{proof}




\section{Contour}


\begin{definition}[contour~path,~contour~loop]  A contour path from $x_0$ to $x_{k-1}$ is a path  $[x_0;x_1;\ldots;x_{k-1}]$ such that $x_{i+1} = n^{-1} x_i$ or $f x_i$ for each $i<k$.  (That is, each step in the path is clockwise step around a node or a counterclockwise step around a face.)   If the contour path $[x_1;\ldots;x_{k-1}]$ is injective and  $x_0 = x_{k-1}$, then it is a contour loop.
\indy{Index}{contour!path}
\indy{Index}{contour!loop}
\indy{Index}{loop}
\end{definition}

\begin{remark}  Figure~\ref{fig:hypermap_ex} constructs a hypermap from a planar graph by drawing darts next to each angle.  In this representation, the darts along a contour path lie to the left of the corresponding planar graph edges.  For that reason, a shaded region to the left of a curve depicts a contour path.
\end{remark}

\begin{figure}[htb]
  \centering
  \szincludegraphics[width=80mm]{\pdfp/shade_dart.eps}
  \caption{A contour path as a sequence as dart is represented as a shaded path.}
  \label{fig:shade-dart}
\end{figure}

\begin{lemma}\rating{50} An injective contour path from $x$ to $y$ can be constructed from a contour path from $x$ to $y$ by dropping some darts from the path.
\end{lemma}

\begin{proof} Repeatedly replace $[\ldots;a;b;\ldots;b;c;\ldots]$ with
$[\ldots;a;b;c;\ldots]$.
\end{proof}





\begin{lemma}\guid{KDAEDEX}\rating{100}\tlabel{lemma:connect-contour}  
If $x$ and $y$ are darts in the same combinatorial component, then there exists a contour path from $x$ to $y$.
\end{lemma}

\begin{proof} 
In the same combinatorial component, the darts $x$ and $y$ are joined by a path, where each step is $z\mapsto h z$, for $h=e,n$, or $f$.  Eliminate $e$-steps through the relation $e\ocirc n\ocirc f = I$.   Replace each $n$-step with a sequence of $n^{-1}$-steps.  This gives the desired path.
\end{proof}
\indy{Index}{component!combinatorial}

\begin{definition}[complementary~path] 
Let $P=[x;y;\ldots]$ be a contour loop that does not visit any node twice in a plain hypermap.   Replace each maximal sublist of $n^{-1}$-steps
$$
[z;n^{-1} z; \ldots; n^{-k} z]
$$
with the sublist
$$
[n^{-(k+1)} z;n^{-(k+2)} z;\ldots; n z]
$$
Replace each sublist $[f^{-1} z;z]$ with the sublist
$$
[n z; f n z],\quad f n z = n^{-1} f^{-1} z.
$$
Then join all the pieces in reverse order. The resulting contour loop is the complementary path $P^c$.
\indy{Index}{path!complementary}
\end{definition}

\begin{figure}[htb]
  \centering
  \szincludegraphics[width=70mm]{\pdfp/complement.eps}
  \caption{The complementary contour loop traces the remaining darts
   at the same nodes as the original contour loop. }
  \label{fig:contour-comp}
\end{figure}
\indy{Index}{contour!complementary}

\subsection{M\"obius}

\begin{definition}[M\"obius~contour] A M\"obius contour is an
injective contour path $P=[x_0;\ldots]$ that satisfies
    \begin{equation}
    \tlabel{eqn:mobius}
    x_j = n x_0\quad x_k = n x_i
    \end{equation}
for some $0 < i\le j< k$ (Figure~\ref{fig:mobius}).
\indy{Index}{contour!M\"obius}
\end{definition}

\begin{figure}[htb]
  \centering
  \szincludegraphics[width=50mm]{\pdfp/mobius.eps}
  \caption{A M\"obius contour}
  \label{fig:mobius}
\end{figure}

\begin{figure}[htb]
  \centering
  \szincludegraphics[width=30mm]{\pdfp/3m.eps}
  \caption{The face map on this hypermap gives a M\"obius contour with three darts}
  \label{fig:3m}
\end{figure}

\begin{remark} A M\"obius contour is a 
combinatorial M\"obius strip that
twists to make 
its left-hand side into
its right-hand side.  A planar hypermap has no such contour.  
Figure~\ref{fig:violate-jct}
redraws a violation of the Jordan curve theorem
as a M\"obius contour.   
\end{remark}

\begin{figure}[htb]
  \centering
  \szincludegraphics[width=80mm]{\pdfp/violate-jct2.eps}
  \caption{A path that tunnels from the interior to the exterior
   of a simple closed curve
   is analogous to a M\"obius contour.}
  \label{fig:violate-jct}
\end{figure}

\begin{figure}[htb]
  \centering
  \szincludegraphics[width=80mm]{\pdfp/mobius_contour.eps}
  \caption{Some M\"obius contours}
  \label{fig:mobius-contour}
\end{figure}






\begin{lemma}\guid{LIPYTUI}\rating{300}\tlabel{lemma:no-mobius}
Planar hypermaps have no M\"obius contours.
\end{lemma}
\indy{Index}{hypermap!planar}

\begin{proof} For a contradiction, assume that there exist planar
hypermaps with M\"obius contours.  An edge walkup carries
planar hypermaps into planar hypermaps. An edge walkup
at a dart that is not on the M\"obius contour carries the
M\"obius contour to a M\"obius contour 
and reduces the number of darts.  
In the M\"obius Condition~\ref{eqn:mobius},
a walkup at a dart that is not at position $0$, $i$, $j$, $k$
along the contour carries the M\"obius contour to a M\"obius contour
and reduces the number of darts. Thus, a counterexample with
the smallest possible number of darts contains no
darts except those on the M\"obius contour, and its only darts
are at positions $0$, $i=j=1$, $k=2$.

This is a three darted hypermap (Figure~\ref{fig:3m}.)  
The M\"obius condition, the
definition of contours, together with $e\ocirc n\ocirc f=I$ force
$e=n=f$, all permutations of order three.  This hypermap is not planar:
    $$\# e + \# n + \# f = 3~~\ne~~ 5 = \# D + 2\, \#c.$$
\end{proof}



\subsection{interior}
\indy{Index}{interior}

\begin{definition}[interior]\label{def:interior} 
A dart $y$ lies in the {\it interior} of a contour
loop $L$ if there is a an injective contour path
$x_0,x_1,\ldots,x_k=y$ such that $x_1 = f x_0$ (or $k=0$), and
such that $x_i$ lies on the loop $L$ if and only if $i=0$.
\indy{Index}{interior!contour loop}
\end{definition}

\begin{lemma}\guid{ILTXRQD}\rating{100}\tlabel{lemma:contour-path-type}
Suppose that a hypermap has no M\"obius contours. Let $L$ be a contour loop.  Let $P$ be any injective contour path (with at least $3$ darts) that starts and ends on $L$, but visits no other darts of $L$ on the way.  Then the first and last steps of $P$ are both of the same type ($n^{-1}$ or $f$).
\end{lemma}

\begin{figure}[htb]
  \centering
  \szincludegraphics[width=80mm]{\pdfp/interior_nf.eps}
  \caption{A path must enter and depart from a contour loop with the same type of step.}
  \label{fig:interior_nf}
\end{figure}


\begin{proof}   The proof shows the contrapositive.   Suppose $P=[n x;f n x;\ldots;n y;y]$.   The successor of $n x$ on $L$ is $x$.  Starting at $x$,  follow $L$ to $y$, and on to $n x$.  Follow $P$ back to $n y$:
$$
x::L[x:n x] \opat P[ n x;ny].
$$  
This is a M\"obius contour $x\ldots y\ldots n x\ldots n y$.

Suppose $P=[n x;x;\ldots;f^{-1} y;y]$.  Starting at $x$, follow $P$ to $y$, then follow $L$ to $n x$, and  on to $n y$.  This is a M\"obius contour.
\end{proof}

\begin{lemma}\guid{UMYSGDB}\rating{80}\tlabel{lemma:dart-interior}
Let $L$ be a contour loop on a plain hypermap without
M\"obius contours.  Assume a dart $x$ lies in the interior of the loop $L$. 
Then every dart in its $f$-orbit lies in
the interior of the loop.  Moreover, if the dart
$x$ does not lie on the same node as any dart in $L$, then every
dart in the $n$-orbit of $x$ lies in the interior 
of $L$.
\end{lemma}

\begin{proof} Let $P= [x_0;\ldots;x]$ be an injective path that certifies that $x$ lies in the interior of $L$.  If $f x$ lies along this path already or if it lies on $L$, then it is clearly interior.  Otherwise, $[x_0;\ldots,x;f x]$ is a certifying path for $f x$.  Similarly, use the certifying path $[x_0;\ldots;x;n^{-1} x]$ for $n^{-1} x$.
\end{proof}


\begin{definition}[interior~face,~node]  A face or a node is interior to a
loop in a hypermap if all of its darts are interior.
\indy{Index}{interior!face}
\indy{Index}{interior!node}
\end{definition}


\begin{lemma}\guid{ICJHAOQ}\rating{180}\tlabel{lemma:contour-interior-exterior}
Suppose that a hypermap has no M\"obius contours.  Let $L$ be a contour loop.
Then there does not exist a contour path
$[x_0;\ldots;x_k]$, for $k\ge 1$ with the following properties:
\begin{enumerate}
\item $x_i$ lies on $L$ iff $i=0$.
\item $x_1 = f x_0$.
\item $x_0$ and $x_k$ lie in different nodes.
\item Some dart of $L$ is at the node of $x_k$.
\end{enumerate}
\end{lemma}

\begin{figure}[htb]
  \centering
  \szincludegraphics[width=40mm]{\pdfp/no_node_path.eps}
  \caption{No path exists from a node of $L$ to the interior.}
  \label{fig:no-node-path}
\end{figure}

\begin{proof}  Assume for a contradiction that the path $P$ exists.  Some subpath is injective and satisfies the same conditions.  Again, without loss of generality, shrinking the path if needed, $k$ is the smallest index for which the last two conditions are met.  Append $n^{-1}$-steps to $P$ to reach a dart of $L$.  This is contrary to Lemma~\ref{lemma:contour-path-type}.
\end{proof}

\begin{lemma}\label{lemma:3dart}  
Assume that each face of a hypermap has has at least three darts.  Then every contour loop that meets at least two nodes has at least three darts.
\end{lemma}

\begin{proof}  Let $P=[x;y]$ be a contour loop meeting  two nodes.  Then $y = f x$ and $x = f y$, so that the face has size two.
\end{proof}

\section{Generation}
\indy{Index}{generation}

\subsection{quotient}
\indy{Index}{quotient}

\begin{definition}[isomorphic] Two hypermaps $(D,e,n,f)$ and $(D',e',n',f')$ are
isomorphic, if there is a bijection $F:D\to D'$ such that
    $$h'\ocirc F = F\ocirc h$$
for $(h,h')=(e,e'), (f,f'), (n,n')$.
\indy{Index}{isomorphic}
\end{definition}


\begin{definition}[normal~collection]
Let $H$ be a hypermap. Assume that 
there are no darts fixed by $e$ 
(so that $f x \ne n^{-1} x$ at each dart). 
Let $\cal L$ be a collection of contour
loops.  The collection $\cal L$ is  normal if the following
conditions hold of its loops. \begin{enumerate}
 \item No dart is visited by two different loops.
 \item Every loop visits at least two nodes.
 \item If a loop visits a node, then every dart at that node is visited by some loop.
\end{enumerate}
\indy{Index}{normal collection}
\end{definition}

A normal collection determines a new hypermap.   A dart in the new set $D'$ of darts $D$ is a maximal path $[x;n^{-1} x; n^{-2} x;\ldots;n^{-k} x]$  of $n^{-1}$ steps appearing in some loop in $\cal L$. The map $f'$ takes the maximal path $[x;n^{-1}x;\ldots;y]$ to the maximal path (in the same contour loop) starting $[f y;\ldots]$. The map ${n'}^{-1}$ takes the maximal path  $[\ldots;y]$ to the maximal sequence (in some other contour loop) starting $[n^{-1}y;\ldots]$. Equivalently, $n'$ takes the maximal path $[x;\ldots]$ to the maximal path ending $[\ldots;n x]$. The map $e'$ is defined by $e'\ocirc n'\ocirc f' = I$. 
\indy{Index}{path!maximal} 

\begin{definition}[quotient]  The hypermap constructed from the normal collection is called the quotient of $H$ by $\cal L$, and is denoted $H/{\cal L}$.  The hypermap $H$ is said to be a cover of $H/{\cal L}$.
\indy{Index}{quotient}
\end{definition}

Intuitively, the quotient hypermap is represented as a graph whose cycles under $f$ are precisely the contour loops in the normal family (Figure~\ref{fig:quot}).


\begin{figure}[htb]
  \centering
  \szincludegraphics[width=70mm]{\pdfp/quot.eps}
  \caption{The contour loops in a normal family become faces in the quotient}
  \label{fig:quot}
\end{figure}


\begin{example}\label{ex:Hall} 
Assume that $H$ is a hypermap with no fixed points under $e$. Assume that every face meets at least two nodes. Then the set of all faces defines a normal collection of contour loops (follow $f$ around each face: $[x;f x;\ldots]$).  Each dart of the quotient is then just a singleton set consisting of a single dart of $H$, and the quotient is isomorphic to $H$ itself.
\end{example}

\begin{example}\label{ex:H2} 
Assume that $H$ is a hypermap with no fixed points
under $e$.  Let $F = (x,f x,\ldots)$ be a face 
that visits at least
three nodes and that meets each node in at most one dart.
Let $\cal L$ be the
collection with two contour loops:  $[x;f x;\ldots]$ and its
complement $L^c = [n^{-1} x;\ldots]$.
%$$
%  [n^{-1} x;n^{-2} x;\ldots;n x;f n x = y;n^{-1} y; n^{-2} y;\ldots; n y; f ny;\ldots]
%$$
The family $\cal L$ is normal. The quotient hypermap $H/{\cal L}$ has two faces $F$ and a backside $F'$ of the same cardinality $k$.
\end{example}





\begin{example}[cyclic]\label{ex:H2k} 
There is a hypermap $H_{2k}$, whose darts are arranged in two faces.  Each
face is $Z_n$, a cyclic group of order $n$ with generator $1$.
The face map is $x\mapsto x+1$.
The node map swaps the two faces $Z_n$.
The usual condition $e\ocirc n\ocirc f = I$ defines the edge map.
If a hypermap is isomorphic to $H_{2k}$ for
some $k$, then it is {\it cyclic}.  For example,
the hypermap constructed in the previous example is cyclic.
\indy{Index}{hypermap!cyclic}
\end{example}

\begin{lemma}\guid{JMKRXLA}\rating{280}\tlabel{lemma:quotient-plain}
Let $H$ be a plain hypermap, and let $\cal L$ be a
normal family.  Then $H/{\cal L}$ is a plain hypermap.
\end{lemma}

\begin{proof} Let $e'$, $f'$, and $n'$ be the edge, face, and node maps on the
quotient hypermap.  Write $[\ldots; x]$ for the node in the quotient
ending in dart $x\in H$ and $[x;\ldots]$ for the node in the quotient
starting with dart $x\in H$.  Plainness gives $e^2 x = x$, so that for any
dart $[\ldots x]$ in the quotient:
    $$\begin{array}{lll}
    {e'}^{-2} [\ldots; x] &= n' f' n' f' [\ldots; x] = n' f' n' [f x; \ldots] \\&=
    n' f' [\ldots; n f x] = n' [f n f; \ldots] = [\ldots; n f n f x]\\ &=
    [\ldots; e^{-2} x] = [\ldots; x].
    \end{array}$$
Thus, $e'$ has order $2$ on the quotient.
\end{proof}

%\begin{lemma}\guid{ZOKKAOI}\tlabel{lemma:quotient-planar}
%Let $H$ be a plain planar hypermap, and let $\cal L$
%be a normal family.  Then $H/{\cal L}$ is a plain planar hypermap.
%\end{lemma}
%
%\begin{proof} Suppose $H/{\cal L}$ is not planar.
%Let $P$ be a M\"obius contour on $H/{\cal L}$.  It lifts uniquely to
%a contour on $H$ with the property that the darts visited on $H$ are
%precisely the darts that belong to a dart in the quotient.  This is
%compatible with the node map $n$.  So the contour path lifts to a
%M\"obius contour on $H$.  Thus, $H$ is not planar.
%\end{proof}


\subsection{flag}
\indy{Index}{flag}

The remainder of the chapter presents an algorithm that
generates all simple, plain, planar hypermaps satisfying certain general
conditions (Definition~\ref{def:restricted}).   The algorithm  proceeds by adding edges and nodes to a hypermap by reverse double walkup transformations.

The algorithm  marks certain faces as `true.'
Roughly, this  means that the the face cannot be modified
at any later stage of the algorithm.   When all of its faces
are true, the hypermap stands in final form.
The function that marks each face as true or false is a
{\it flag}.
\indy{Index}{hypermap!algorithm}


\begin{definition}[flag]  Let $S$ be a set of darts in a hypermap.  
An $S$-flag is a boolean function on the set of faces that satisfies the following two constraints.
\begin{enumerate}
    \item If darts $x,y$ belong to true faces,
    then there is a contour path from $x$ to $y$ that remains
    in true faces.
    \item Each edge of the hypermap meets a true face or $S$.
    \end{enumerate}
An $\emptyset$-flag is simply called a flag.
%An isomorphism of flagged hypermaps is an isomorphism of
%hypermaps that respects the flags.
\indy{Index}{flag}
\end{definition}

\begin{definition}[canonical boolean function] Let $H/{\cal L}$ be a quotient hypermap with normal family $\cal L$.  The {\it canonical boolean function} on the set of faces of the quotient is the function that is true exactly when every dart in the face is a singleton of $H$.
\indy{Index}{function!canonical boolean}
\end{definition}

\begin{example} The cyclic hypermap of Example~\ref{ex:H2k}, carries a flag that marks one face true and the other false.
\end{example}

\begin{example} Let $H$ be a connected, plain hypermap, and such that $e$ has no fixed points, and let $\cal L$ be the example of Example~\ref{ex:Hall}, then the canonical map takes value $\op{true}$ on every face.  This is a flag. In fact, Lemma~\ref{lemma:connect-contour} provides the contour paths that are required in the definition of flag.
\end{example}

\begin{lemma}\guid{STKBEPH}\rating{100}\tlabel{lemma:all-dart}  
Let $H$ be a hypermap with normal family ${\cal L}$. If the canonical boolean function on the set of faces of $H/{\cal L}$ has at least as many true values as there are faces of $H$, then $\cal L$ is the normal family in Example~\ref{ex:Hall}. In particular, $H/{\cal L}$ is isomorphic to $H$.
\end{lemma}

\begin{proof}  If a face takes value $\op{true}$ in $H/{\cal L}$, then its darts are singletons, and the face of $H/{\cal L}$ is naturally identified with a face in $H$.  This is an injective map from the set of true faces of $H/{\cal L}$ to the set of faces of $H$.  The hypothesis of the lemma implies that this injective map is bijective. All of the darts of $H$ are accounted for under this bijection. Thus, the quotient has no false faces.  The result follows.
\end{proof}


\subsection{extension}\label{sec:face-insert}
\indy{Index}{extension}

% What is the subject of the following sentence???
In this subsection,  is a hypermap with restrictive properties.

\begin{definition}[restricted]\label{def:restricted}
A restricted hypermap $H = (D,e,n,f)$ is one with the following properties.
    \begin{enumerate}
        \item It is nonempty, connected, plain, planar, simple.
        \item The edge map $e$ has no fixed points.
        \item The node map $n$ has no fixed points.
        \item The size of every face is at least $3$.
        %%  (All hypoth. Needed?)
    \end{enumerate}
\indy{Index}{restricted!hypermap}
\end{definition}


Our aim is to prove that every restricted hypermap with a given bound on the size of the dart set is generated by a particular algorithm.  The proof is a long induction argument.  The proof starts by showing how to go from one partially constructed hypermap to another more fully constructed hypermap.  The hypermap $H$ represents the fully constructed hypermap and two quotients $H/{\cal L}$ and $H/{\cal M}$ represent the partially constructed hypermaps.  The algorithm involves the transition from the hypermap $H/{\cal L}$ to $H/{\cal M}$.  This represents one step of the algorithm.

This section describes the transition from $H/{\cal L}$ to $H/{\cal M}$.  The algorithm carries along various auxiliary data satisfying various assumptions, enumerated as follows:

\begin{remark}[context]\label{enum:context}
\begin{enumerate}
\item Assume $\cal L$ is a normal family of $H$.
\item Assume the quotient $H'=(D',e',n',f')=H/{\cal L}$ is simple.  
\item Assume that $L$ is a contour loop in ${\cal L}$ such that the corresponding face $F(L)$ in the quotient is false under the canonical boolean function.
\item Assume $x'\in F(L)$ is a quotient dart such that $e'x'$ lies in a true face.  Write $x' = [\ldots;x]$ with $x\in D$. 
\item There is a largest $m\ge0$ such that 
$$
[x;f x; f^2 x;\ldots;f^{m+1} x]
$$  
is a subpath of $L$.
Let $y = f^{m+1} x$.  Let $S = S(x,{\cal L}) = \{f^i x \mid 1 \le i\le m\}$.   The set $S$ maps bijectively to a set of darts in the quotient, which is also denoted  $S$. 
\item Assume that the canonical boolean function on $H'$ is an $S$-flag.
\end{enumerate}
\end{remark}

  


\begin{example}\label{ex:graph-gen}  This example illustrates illustrated the setup (Figure~\ref{fig:graph-gen}).   In the figure, the hypermap $H$ is represented as a planar graph.
The contour loops are represented by left-side shadings of the edges of the
planar graph.  The shaded edges give the edges of a planar graph representing the quotient.  The polygons that are fully shaded are true.   Two polygons in the quotient are false.  A dart on one of the false faces is marked $x$.  By inspection, $m=3$ and $S=\{f x,f^2 x,f^3 x\}$.  By inspection, the canonical boolean function is an $S$-flag.  (In fact, the darts in true faces form a connected region.  Every edge except one edge $\{f x, e f x\}$ meets a true face, and this one edge meets $S$.)
\end{example}

\begin{figure}[htb]
  \centering
  \szincludegraphics[width=90mm]{\pdfp/graph_gen.eps}
  \caption{An example of the current situation.}
  \label{fig:graph-gen}
\end{figure}


\begin{lemma}\guid{HQYMRTX}\rating{200}  There is a smallest $p\ge0$, such that $f^{p+1} y$ belongs to some loop of ${\cal L}$.  Set $z=f^{p+1} y$.  Then   $z$ is on the contour loop $L$ and is not equal to $f^k x$, for $0 < k \le {m+1}$.
\end{lemma}

\begin{proof} 
For a contradiction, suppose $f^{p+1} y = f^k x$. Then also, $f^p y = f^{k-1} x$.  If $p>0$, then this goes against the minimality of $p$.  So $p=0$, and $y=f^{k-1} x = f^{m+1} x$.  Also, $0\le k-1 < {m+1}$, which forces $L$ to coincide with the contour loop around $F$, which is impossible for a false face.  This proves the second claim of the lemma.  In particular, $z\not\in S$.

For a contradiction, assume that $z = f^{p+1} y$ lies on a different contour loop $L'\in {\cal L}$.  If $z$ lies in a true face, then $y$ and $x$ lie in the same true face, contrary to the choice of $x$.  So $z$ lies in a false face.  Let $z' = [\ldots;z_1]\in D'$ be the image of $z$ in $D'$.  Also,  $z'\not\in S$.  By the definition of $S$-flag, the dart $e'z'$ lies in a true face or $e'z'\in S$.  The proof splits into two cases depending on which holds.

{\bf Case 1: $e'z'$ lies in a true face.}  Consider the following path in $H$:
$$
[y;fy;\ldots;z] @ [z;\ldots;z_1] @ [n^{-1} z_1;\ldots;f e x].
$$
The first segment consists of $f$-steps; the second of $n^{-1}$; and the third segment exists within true faces by the connectedness of true faces (for flags).  This
path satisfies all the enumerated conditions of Lemma~\ref{lemma:contour-interior-exterior}.  The lemma asserts that the path does not exist.

{\bf Case 2: $e'z'\in S$.}   Consider the following path in $H$:
$$
[y;f y;\ldots;z].
$$
 This
path satisfies all the enumerated conditions of Lemma~\ref{lemma:contour-interior-exterior}.  The lemma asserts that the path does not exist.
\end{proof}


The algorithm constructs a new collection at each step:
$${\cal M} = ({\cal L}\setminus \{L\}) \cup \{L_1,L_2\}.$$
Here $L_1$ is the contour loop
$$
L[x:y] \opat P[y:z] \opat L[z:x].
$$
that follows $L$ from $x$ to $y$, then takes $f$-steps from $y$ to $z$, then continues along $L$ back to $x$.  This loop meets at least two nodes and has length at least three by Lemma~\ref{lemma:3dart}. Also, $L_2$ is the contour loop
$$
L[n^{-1}y:n z] \opat P^c[n z:n^{-1}y].
$$
which follows $L$ from $n^{-1} y$ to $n z$, then complements the path of $L_1$ from $y$ to $z$, traveling instead from $n z$ to $n^{-1} y$.  This loop meets at least two nodes (those of $y$ and $z$) and has length at least three by Lemma~\ref{lemma:3dart}.

\begin{figure}[htb]
  \centering
  \szincludegraphics[width=80mm]{\pdfp/L1L2.eps}
  \caption{The loop $L$ is replaced with two loops $L_1, L_2$.}
  \label{fig:L1L2}
\end{figure}

\begin{figure}[htb]
  \centering
  \szincludegraphics[width=80mm]{\pdfp/L1L2dart.eps}
  \caption{$H/{\cal L}$ is obtained from $H/{\cal M}$ by double walkup transformations.}
  \label{fig:L1L2dart}
\end{figure}

The passage from  $H/{\cal M}$ to $H/{\cal L}$ consists of  a double walkup on all of the nodes coming from the nodes of $f y$, $f^2 y, \ldots, f^p y$, and then a double walkup on the edge from the node of $y$ to the node of $z$.  %The passage in the other direction from $H/{\cal L}$ to $H/{\cal M}$ comes by adding an edge from the node of $y$ to the node of $z$ and inserting $p$ new nodes (of degree two) along it.
One may also pass from $H/{\cal L}$ to $H/{\cal M}$ as follows.
Given $H' (= H/{\cal L})$, and dart $x$, let $r$ be the cardinality of the face of $x$.  Suppose given $m\ge 0$, $p\ge 0$, and $0 \le m < q < r$, satisfying the further constraint that $m+1=q$ implies $p\ge1$.  From this data, a new hypermap $h(H',x,m,q,p)$ may be constructed.  First construct an edge from the node of $y = f^{m+1} x$ to the node of $z = f^{q+1} x$ by a reverse double walkup.  Then insert $p$ new nodes (of degree $2$) along the constructed edge.  This is $h(H',x,m,q,p)$.  If $m,q,p$ are chosen as above, then $h(H',x,m,q,p)$ is isomorphic to $H/{\cal M}$.


Let $\varphi$ be the (noncanonical) boolean function that is false on the face $F(L_1)$ and is otherwise equal to the canonical boolean function. The set $S_{\cal M}=S(x,{\cal M})$ contains the proper subset $S=S(x,{\cal L})$.  The following lemma is used to show that the context of the iteration is preserved.
\indy{Notation}{phi@$\varphi$ (boolean function)}
\indy{Index}{function!boolean}

\begin{lemma}\guid{AQIUNPP}\rating{600}\tlabel{lemma:flag}  
${\cal M}$ is a normal family, the noncanonical function $\varphi$ is an $S_{\cal M}$-flag, and the assumptions on the context (Remark~\ref{enum:context}) are all satisfied in this new context (with $\varphi$ instead of the canonical function, ${\cal M}$ instead of ${\cal L}$, etc.).
\end{lemma}


\begin{proof}   The proof can be organized into three parts, establishing that ${\cal M}$ is normal, that $\varphi$ is a flag, and that the quotient is simple.
\indy{Index}{normal}

{\bf [normal(1)]~} {\it No dart is visited by two different loops.}  By construction, the sets of darts are visited by $L_1$ and $L_2$ are disjoint and disjont from the darts visited by the loops of ${\cal L}\setminus \{L\}$.  The result follows.  

{\bf [normal(2)]~} {\it Every loop visits at least two nodes.}  This is true for $L_1$ and $L_2$ because they visit the nodes of $y$ and $z$.  It is true of the other loops because they belong to the normal family ${\cal L}$. It follows that  ${\cal M}$ is normal.

{\bf [normal(3)]~} {\it If a loop visits a node, then every dart at that node is visited by some loop.}  The new nodes visited on the subpath of $L_1$ from $y$ to $z$ do not contain any darts in any loop in ${\cal L}$.  (By the definition of normal family, every dart at a node or no dart at a node lies along some loop of ${\cal L}$.)  These new nodes contain two darts, with one dart along $L_1$ and the other along $L_2$.   The paths $L_1$ and $L_2$ visit every dart visited by $L$.  They visit every dart at the nodes of $y,\ldots,z$.  

{\bf [flag(1)]~} {\it The true faces are connected.}   If $F(L_2)$ is false, then the set of true faces is the same on $H/{\cal L}$ and $H/{\cal M}$.  In this case the proof is immediate.  If $F(L_2)$ is true, then the proof requires more argument.  Let $y'$ be the image of $y$ in $H'$.  Since the canonical function on $H'$ is a flag, the edge $\{y',e'y'\}$ meets a true face or $S$.  However, $y'\not\in S\subset F(L)$, by the simplicity of $H$.  $e'y'\not\in S \subset F(L)$, by the simplicity of $H'$.  The only remaining possibility is that $e'y'$ lies in a true face.  The dart $e'y'$ is naturally identified with the dart $e_{\cal M} y'$ on in $H/{\cal M}$, and hence a path exists from the true face $F(L_2)$ into another true face, and from there any true face may be reached.

{\bf [flag(2)]~} {\it Each edge meets $S$ or a true face.}  
The function $\varphi$ is an $S_{\cal M}$-flag.  The edges of $H/{\cal L}$ can be identified with a subset of the edges of $H/{\cal M}$.   For this subset, the flag condition on edges is immediate.  Any other edge is one of the newly created edges, and they all share a dart with $S(x',{\cal M})$.  


{\bf [simple]~} For simplicity of the quotient, each of the contour paths in ${\cal M}$ should never return to a node after leaving it.  This is true of ${\cal L}\setminus\{L\}$ by assumption and true of $L_1$ and $L_2$ by construction.  Note in particular, that the dart $z$ is not at the same node as $y$ (by the simplicity of $H$).
\end{proof}


There are various possibilities for $H/{\cal M} = (D_{\cal M},e_{\cal M},\ldots)$.
\begin{enumerate}
\item  The canonical function might be true on every face.  By Lemma~\ref{lemma:all-dart}, the quotient map $H\to H/{\cal M}$ is an isomorphism.  The iteration terminates.
\item The canonical function is false on $F(L_1)$.  Then $\varphi$ is the canonical function.  By Lemma~\ref{lemma:flag}, all the context assumptions hold for the canonical function.  The iteration continues another step.
\item The canonical function is true on $F(L_1)$, but there exists another face $F(L_3)$ that is false.  In this case, the canonical function is a flag (with $S=\emptyset$).  Pick any $x\in F(L_3)$.  The dart $e_{\cal M} x$ lies in a true face.  Take $S=S(x,{\cal M})$.  The canonical function is a flag, hence an $S$-flag.  The iteration continues another step.
\end{enumerate}

The iteration must terminate, because each iteration constructs a quotient of $H$ with more darts than before.  The number of iterations is bounded by the size of the set of darts of $H$.

\subsection{algorithm}

This final section puts the algorithm in a more precise form, based on the Knaster-Tarski fixed point theorem.

\begin{lemma}[Knaster-Tarski]   Let $X$ be a set.  Let $f:P(X)\to P(X)$ be a function from the powerset of $X$ to itself.  Assume that $f$ is monotonic in the sense that whenever $Y\subset Z\subset X$, it follows that
$f(Y) \subset f(Z)$.  Then $f$ has a least fixed point.  That is there exists a set $\op{fix}(f,X)\subset X$ such that $f(\op{fix}(f,X)) = \op{fix}(f,X)$ and such that the following minimality condition holds: if $Y$ is any set such that $f(Y) \subset Y$, then $Y\subset \op{fix}(f,X)$.
\end{lemma}
\indy{Notation}{fix@$\op{fix}$~(Knaster-Tarski fixed point)}
\indy{Index}{Knaster-Tarski fixed point theorem}

Let $D$ be a fixed finite universe that will contain all of the darts from all of the hypermaps to be constructed.   (The set of darts for some of the hypermaps may be a proper subset of $D$.) 
Fix a choice function $\op{ch}:P(D)\to D$ that picks an element from each nonempty subset:
$$
X\ne\emptyset\quad  \Rightarrow \quad  \op{ch}(X)\in X.
$$
\index{Notation}{ch@$\op{ch}$~(choice)}
For example, when $D\subset\ring{N}$, let $\op{ch}$ choose the least element of a subset of $D$.

Fix $d\ge 3$, representing an upper bound on the size of the faces of the hypermaps that will be constructed.  (In applications to the sphere packing problem, $d=6$.)
The construction depends on $D,d$, although the notation does not reflect this.

Define a set $X$ as the disjoint union of $X_1$ and $X_2$ as follows.  Let $X_1$ be the
set of all hypermaps whose darts are elements of $D$.  Let $X_2$ be the set of four-tuples
$(H,m,\varphi,x)$, where $H$ is a hypermap whose darts are elements of $D$, 
$m\in\{0,\ldots,d-1\}$, $\varphi$ is an $S$-flag on $H$, $x$ is a dart in a false face of $H$,
and $S = \{f^i x\mid 1 \le i \le m\}$.   (One may think of $X_1$ as holding the output of the algorithm and $X_2$ as holding the partially constructed hypermaps.)

Let $H$ be a fixed hypermap isomorphic to $H_{2d}$,
with darts in $D$.  Let $\phi$ be the canonical flag on $H$ (with one true face and one false face).
Let $x$ be the value of the choice function on the false face.  Set
$$A = \{(H,m,\varphi,x) \mid 0\le m \le d-1 \}.$$

When a function 
$g:X_2 \to P(X)$ is given, set 
$$f(S) = A \cup  (\bigcup  \{g(s) \mid s\in S\cap X_2\}).$$
Any function $f :P(X)\to P(X)$ defined in this way is monotonic.

The function $g$ is defined as follows.  Let $(H,m,\varphi,x)\in X_2$.  Let $r$ be the
cardinality of the face of $x$.  Consider $q,p$ satisfying the following constraints:
\begin{itemize}
\item $0\le m < q < r$.
\item $0\le p$.
\item if $m+1 = q$, then $p \ge 1$.
\item $m+p+2 \le d$.
\item if $q+1\ne r$, then $m+p+3\le d$.
\end{itemize}

For each such $q,p$, construct the hypermap $h(H,x,m,q,p)$.  Recall that this hypermap is constructed from $H$ by adding two faces $F_1$ and $F_2$ and eliminating the face $F$ of $x$.  All other faces can be naturally identified.  Say that a boolean function $\varphi'$ on $h(H,x,m,q,p)$ is an {\it extension} of the boolean function $\varphi$ on $H$ if $\varphi'(F') =\varphi(F')$, when $F'\ne F$.  
\indy{Index}{function!extension}

Let $g(H,m,\varphi,x)$ be the following subset of $X$:
\begin{itemize}
\item $H'\in X_1\cap g(H,m,\varphi,x)$ iff there exists $q,p$ satisfying the given constraints such that $H'=h(H,x,m,q,p)$ and $\varphi(F')$ is true for all $F'\ne F$.
\item $(H',m',\varphi',x')\in X_2\cap g(H,m,\varphi,x)$ iff there exists $q,p$ satisfying the given constraints such that $H'=h(H,x,m,q,p)$ and such that $\varphi'$ is an extension of $\varphi$, and one of the following two conditions hold:
  \begin{itemize}
    \item $\varphi'(F_1)$ is false;  $x' = x$; and  $p+m+1 \le m' \le r-1$.
     \item $\varphi'(F_1)$ is true; $x'$ is the value of the choice function on the union of false faces of $H'$; and $0 \le m' \le r-1$.
  \end{itemize}
\end{itemize}



\begin{lemma}\guid{BRGEFNH}\rating{2000}  
Define $f $ and $X$ as above (depending on $d\ge 3$ and $D\ne \emptyset$) .   Let $F=\op{fix}(f,X)$ be the Knaster-Tarski fixed point set of $f$ on $X$.   Then every restricted hypermap with at most $\card(D)$ darts and such that every face has size at most $d$ is isomorphic to a hypermap in $F\cap X_1$.
\end{lemma}

In other words, by starting with the {\it seed} hypermaps in $A$ one may find all restricted hypermaps (for given $D,d$) by applying the function $f$ repeatedly:
$$
A_0 = A = f(\emptyset),\quad A_1 = f(A_0),\quad A_2 = f(A_1),\ldots
$$
and by looking at the output $A_i \cap X_1$.
\indy{Index}{seed}

\begin{proof}  Let $H$ be a restricted hypermap whose dart set belongs to $D$ and whose greatest face size is $d$.  It has a quotient $H/{\cal L}_0$ isomorphic to $H_{2d}$.  By repeating the construction of Section~\ref{sec:face-insert}, one obtains a sequence of hypermaps $H_i = H/{\cal L}_i$, $i=0,\ldots,N$, terminating with a hypermap $H/{\cal L}_N$, which is isomorphic to $H$.  The data $m_i,\varphi_i,x_i$ is also obtained for each $H_i$.

The tuple $(H_0,m_0,\varphi_0,x_0)$ is isomorphic to an element of $A$.   By construction,
$A\subset F$.  If the lemma is false, there is a smallest $i>0$ for which $(H_i,m_i,\varphi_i,x_i)\not\in F$  (or if $i=N$, for which $H\not\in F$).   There are isomorphisms isomorphisms $h(H_i,x_i,m_i,q_i,p_i) \simeq H_{i+1}$ for appropriate choices of $q_i,p_i$.  By construction, when the data belongs to $F$ for $i-1$, the data belongs to $F$ for $i$.  Thus, $H$ belongs to $F\cap X_1$.
\end{proof}

%\subsection{old algorithm}
%
%If a hypermap is restricted and $x$ is any dart, then $x$ and $n x$ lie
%on different faces.  In particular, a restricted hypermap has at least two faces.
%To begin the process,  take ${\cal L}$ to be the normal family of Example~\ref{ex:H2} with two contour loops, whose quotient hypermap is a polygon $H_{2d}$.  When the the initial contour loop is chosen on a face of maximal size,  the natural number $d$ is  an upper bound on size of a face.
%
%In summary,  a process  starts with a single polygon and then adds edges and nodes of degree two along the inserted edges,  to obtain a restricted hypermap $H$.
%
%A modification of the process avoids explicit reference to the hypermap $H$ and to the normal family ${\cal L}$.   Let $D$ be a finite set that contains all the darts for all of the restricted hypermaps to be constructed.  For each $d=3,\ldots,\# D$, the process generates all restricted hypermaps with greatest face-size $d$, with darts in $D$.  
%
%The algorithms performs the following initialization.  The initial hypermap is the polygonal hypermap $H_{2d}$.  A flag $\varphi$ marks one face  true and the other false.  A distinguished dart $x$ is selected on the false face.  For each  $m<d$, set $S=S_m = \{f^i x\mid 1\le i\le m\}$.
%
%Each iteration processes a finite list ${\cal H}$ of quadruples $(H,m,\varphi,x)$, where $H$ is a simple hypermap, $\varphi$ is an $S$-flag, $x$ lies in a false face, and $S = \{f^i x\mid 1\le i\le m\}$ for some $m$.  The algorithm terminates when every face of every hypermap in ${\cal H}$ is true.  At every step of the algorithm, one quadruple with some false face is removed from ${\cal H}$ and finitely many quadruples are returned to ${\cal H}$.
%
%At each iteration the chosen $(H,m,\varphi,x)$ is modified in the following ways and each modification is placed back in the list ${\cal H}$.  As the natural number $m$ depends on the unknown normal family ${\cal L}$, all possible $m < d$ are used.  Similarly, the natural number $p < d$ depends on ${\cal L}$, and  all possible $p$ are used.  Any quadruple that is isomorphic to one previously considered is discarded as redundant. 
%
%In summary, the algorithm constructs of hypermaps.  The process must terminate, because the set $D$ is finite, so there are only finitely many quadruples (or quadruples up to isomorphism) that construct their dart sets from $D$.
%
%\begin{lemma}\guid{BRGEFNH}\rating{2000}  Fix $d\ge 3$ and $D\ne \emptyset$.
%This process constructs in a finite number of steps all restricted hypermaps, up to isomorphism,  such that the dart set belongs to the finite set $D$, and whose greatest face size is $d$.
%\end{lemma}


\bigskip

\begin{note} %XX
 I thank Tran Nam Trung for many helpful comments, discussions, and corrections about the material in this chapter.
\end{note}

\begin{remark}
G. Gonthier devised the notion of M\"obius contour as a way to prove the Four-Color theorem without appeal to topology.  (The Appel-Haken proof of the Four-Color theorem relies on the Jordan curve theorem.)  
\end{remark}

%%%%%%%%%%%%%%%%%

