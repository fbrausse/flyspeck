
%% HYPERMAPS
%XX e for both hypermap edge and edge {v,w}
\def\e{\varepsilonup}
\def\ocirc{}
\chapter{Hypermap}\label{chap:hypermap}

\section{Basics}



\begin{definition}[hypermap]\label{def:hypermap}  A hypermap is a finite set $D$, together with
three functions $e,n,f:D\to D$ that satisfy
    $$e\ocirc n\ocirc f = I.$$
The elements of $D$ are called {\it darts}.  The functions $e,n,f$
are called the {\it edge map}, the {\it node map}, and the {\it
face map}, respectively.
\end{definition}

%\pdf{dart.pdf}{dart}{The arrowhead represents a dart.}
\begin{figure}[htb]
  \centering
  \includegraphics[width=2mm]{\pdfp/dart.eps}
  \caption{This symbol represents a dart.}
  \label{fig:dart}
\end{figure}

\begin{remark}\tlabel{rem:hypermap} A hypermap is an abstraction of
the concept of 
planar graph.  Place a dart at each angle of a planar graph $G$.
One function, $f$, 
cycles counterclockwise around the angles of each face.  
Another function, $n$, 
rotates counterclockwise around the angles at each
node.  A third function, $e$, pairs angles at opposite ends of
each edge  (Figure~\ref{fig:hypermap_ex}).   The hypermap extracts
the data $(D,e,n,f)$ from the planar graph and discards the rest.
\end{remark}

\begin{figure}[htb]
  \centering
  \includegraphics[width=80mm]{\pdfp/hypermap-ex.eps}
  \caption{Darts mark the angles of a planar graph.  We may
  permute darts about faces, nodes, and edges.}
  \label{fig:hypermap_ex}
\end{figure}

A hypermap satisfies 
  \begin{equation}\tlabel{eqn:triality}
  n\ocirc f\ocirc e = f\ocirc e\ocirc n = I.
  \end{equation}
Inverted, this triality becomes
   $$
   n^{-1} \ocirc e^{-1} \ocirc f^{-1} = (f \ocirc e \ocirc n)^{-1} = I.
   $$
This inversion is the abstract form of the the duality between nodes and faces in a planar graph.  Because of these symmetries in the defining relation, there will be multiple versions of theorems about hypermaps, all obtained from one proof by symmetry.

Each function $e,n,f$ is a permutation of $D$.  Write $\#h$ for the number of orbits of a permutation $h$ on $D$.

\begin{definition}[path,~connected,~combinatorial~component]  A path from $x_0$ to $x_{k-1}$ is a list of darts $[x_0;p_1;\ldots;x_{k-1}]$ such that $x_{i+1} = h_i x_i$, where $h_i \in \{e,f,n,e^{-1},f^{-1},n^{-1},I\}$ for each $i$.   The contour path is injective if $x_i=x_j$ implies $i=j$. Darts $x$ and $y$ lie in the same combinatorial component if there is a path from $x$ to $y$. (See Lemma~\ref{lemma:er}.)  Write $\#c$ for the number of combinatorial components.  The hypermap is connected if $\#c=1$.
\end{definition}

\begin{lemma}\rating{50}\label{lemma:er} The relation on the set of darts $x\sim y$ when there is a path from $x$ to $y$ is an equivalence relation.
\end{lemma}

\begin{proof} This is elementary.
\end{proof}

Write  $p[x_i:x_j]$ for $i<j$ for the subpath $[x_{i+1};\ldots;x_j]$ of $p=[x_0;\ldots;k_{k-1}]$.  (The notation is ambiguous when the path is not injective.)  Write $x::p$ to prepend to a list: $[x;x_0;\ldots;x_{k-1}]$.  Write $\opat$ for the concatenation of lists:
$$
[a;\ldots;b] \opat [c;\ldots;d]  = [a;\ldots;b;c;\ldots;d].
$$


\begin{definition}[node,~face,~edge]  A node is an orbit  under $n$.  A face is an  orbit  under $f$.  An edge is an orbit under $e$. 
\end{definition}

\begin{definition}[plain,~planar] A hypermap is {\it plain} (carefully note the spelling!) if
$e$ is an involution on $D$ (that is, $e\ocirc e = I$).  A hypermap
is {\it planar} (note the spelling!) if the Euler relation holds:
    $$\# n + \# e + \# f = \# D + 2\, \#c.$$
\end{definition}


\begin{remark}\label{rem:Euler}  The Euler relation for hypermaps harks back
to the Euler relation for planar graphs.
Let $G$ be a connected planar graph that satisfies the
Euler relation
    $$V - E + F = 2$$
where $V$ is the number of vertices, $E$ the number of edges, and
$F$ the number of faces of $G$ (including an unbounded face). The
hypermap $(D,e,n,f)$, made from $G$ in
Remark~\ref{rem:hypermap}, is plain.
Moreover,
    $$\begin{array}{lll}
    V &= \# n\\
    E &= \# e\\
    F &= \# f\\
    2E &= \# D\\
    1 &= \#c\\
    V - E + F  &\# n + (\#e - \#D) + \# f = 2\,\# c.
    \end{array}
    $$
Thus, the hypermap is also planar. 
\end{remark}


\begin{lemma}\guid{TGJISOK}\rating{80}\label{lemma:dart-upper} 
Let $H$ be a connected plain planar hypermap such that every edge has cardinality two.  Assume that
there are at least three darts in every node.  Then
$$
\# D \le (6\, \#f - 12).
$$
\end{lemma}

\begin{proof}  In a plain planar hypermap, the Euler relation is
$$6\, \#f - 12 = 3\,\#D - 6\,\#n,$$
so it is enough to show that
$$
\# D \ge 3\,\#n.
$$
This follows directly by assumption: the set of darts can be partitioned into nodes, with at least three darts per node.
\end{proof}



\begin{definition}[degenerate] A dart is degenerate if it is a
fixed point of one of the maps $e,n,f$; otherwise it is nondegenerate.  
%%It is nondegenerate otherwise.
\indy{Index}{degenerate}\indy{Index}{nondegenerate}
\end{definition}

\begin{definition}[simple] 
A hypermap is {\it simple} if the intersection of each face with each node contains at most one dart.
\indy{Index}{simple}
\end{definition}


% Moved from cup05_tame.tex section on tame plane graphs. 9/5/07:
\begin{lemma}\guid{ZHQCZLX}\rating{50}\tlabel{lemma:nondegen} 
Let $(D,e,n,f)$ be a simple plain hypermap such that every face has
at least three darts.
Then $n$ has no fixed point.
\end{lemma}

\begin{proof}  For a contradiction, let $x$ be a fixed point of $n$. The darts $e x$ and $f x$ lie in the same node and face, so are equal in the simple hypermap.  Indeed, they lie in the same node because $n(f x) = e^{-1} x = e x$. They lie in the same face because     
  $$f^2 (e x) =  f(n^{-1} x) = f x.$$
So $e x = f x$.   Thus, $f^2 (e x) = f x = e x$, and $e x$ lies on a face with at most two darts.  This contradicts what is given.
\end{proof}




\section{Walkup}

To focus on a dart $x$ in a
hypermap, it can be useful to draw a hexagon around $x$ and place
the six darts $e x$,
$f x$, $e^{-1} x$, $n x$,  $f^{-1} x$, $e x$, $n^{-1} x$  at its corners
in Figure~\ref{fig:dart+}.  Some of these $7$ darts may be
equal to one another, even if the figure draws them apart.
Figure~\ref{fig:dart-fix} shows the layout of a degenerate darts.

\begin{figure}[htb]
  \centering
  \includegraphics[width=40mm]{\pdfp/dart+.eps}
  \caption{A dart $x$ and its entourage}
  \label{fig:dart+}
\end{figure}

\begin{figure}[htb]
  \centering
  \includegraphics[width=60mm]{\pdfp/dart-fix.eps}
  \caption{A dart fixed under a face map.}
  \label{fig:dart-fix}
\end{figure}


A {\it walkup} deletes
a dart from a hypermap and reforms the edge, node, and face
maps to produce a hypermap on the reduced set of darts.  Walkups
come in three flavors: edge walkups, face walkups,
and node walkups.

\begin{definition}[walkup]
Let $x$ be a dart in a hypermap.  The edge walkup 
$W_e$ at $x$ of the hypermap is the hypermap
$(D',e',n',f')$, where $D' = D\setminus\{x\}$ and the
the maps skip over $x$:
    $$
    \begin{array}{lll}
    f' y &= \text{ if } (f y =  x) \text{ then } f x \text{ else
    } f y\\
    n' y &= \text{ if } (n y = x) \text{ then } n x \text{ else
    } n y\\
    e' &= (n'\ocirc f')^{-1}
    \end{array}
    $$
\indy{Index}{walkup}
\indy{Index}{edge walkup}
\end{definition}

Figure~\ref{fig:walk} shows
the result of an edge walkup on the hexagon around a dart $x$.
The triality symmetry~\ref{eqn:triality}, applied to the definition
of edge walkups, yields the definition of
face walkup $W_f$ and node walkup $W_n$.  
%Figure~\ref{fig:walkfn} shows the result of the face and node walkups on the hexagon around a dart $x$.

A walkup at $x$ is said to be degenerate if the dart $x$ is degenerate.   At a degenerate dart $x$, all three walkups are equal: $W=W_e=W_n=W_f$ (Figure~\ref{fig:walkdegen}).

\begin{figure}[htb]
  \centering
  \includegraphics[width=80mm]{\pdfp/walk.eps}
  \caption{The effect of a walkup at $x$}
  \label{fig:walk}
\end{figure}


\begin{figure}[htb]
  \centering
  \includegraphics[width=80mm]{\pdfp/walkdegen.eps}
  \caption{The effect of a walkup at a degenerate dart}
  \label{fig:walkdegen}
\end{figure}


\begin{definition}[merge,~split]\tlabel{def:merge-split} Let $h=n,e$, or $f$.
A walkup $W_h$ at $x$ merges,
if the walkup joins the orbit of $h$ through $x$ with another orbit.  
It splits, if the walkup splits the orbit at $x$ into two orbits.
\indy{Index}{split}
\indy{Index}{merge}
\end{definition}

\begin{lemma}\guid{ZMFKZNH}\rating{150}\tlabel{lemma:merge-split} 
Every nondegenerate walkup merges or splits. The nondegenerate walkup $W_h$ at $x$ merges if and only if $x$ and $y$  lie in distinct $h$-orbits, where $(h,y)=(f,e x)$.   (The lemma also holds for $(h,y)=(e,n x)$ and other cases generated
by triality.)
\end{lemma}

\begin{proof} The walkup $W_f$ splits if and only if $f x$ 
(or $x$)
and $e x$ lie in the same $f$-orbit before the split. 
Figure~\ref{fig:split} makes this clear.
\end{proof}


\begin{figure}[htb]
  \centering
  \includegraphics[height=90mm]{\pdfp/split.eps}
  \caption{The face walkup at $x$ mixes $f$-orbits.   If it mixes a single orbit,   the orbit splits. If it mixes   two separate    orbits, the orbits merge. }
  \label{fig:split}
\end{figure}


\subsection{walkup and planarity}

\begin{definition}[planar~index] The planar index of a hypermap is
$$\iota = \# f + \# e + \# n - \# D - 2\,\# c.$$
(A hypermap with null index is planar.)
\indy{Index}{index}
\indy{Index}{planar index}
\end{definition}

\begin{lemma}\guid{IUCLZYI}\rating{400}\tlabel{lemma:index} Let $x$ be a nondegenerate dart of a hypermap $(D,e,n,f)$. Let $(D',e',n',f')$ be the result of the face walkup $W$ at $x$.  
The walkup changes the size of some orbits.
    $$
    \begin{array}{lll}
    %\text{\bf Non-degenerate dart $x$: }&\\
    \# f' &=\# f +\op{split}_f  \\  
    \# e'&=\# e \\
    \# n'&=\# n \\
    \# D'&=\# D - 1 \\
    \#c'&=\# c + \op{split}_c\\
    \iota' &= \iota + 1+\op{split}_f - 2\op{split}_c.\\
    \end{array}
    $$
where
   $$
   \op{split}_f = \begin{cases}
     1 & W \text{ splits }\\
    -1 & W \text{ merges}\\
   \end{cases}
   $$
and $\op{split}_c=1$ if $e x$ and $f^{-1} x$ belong to the different connected components after the walkup $W$, and $\op{split}_c=0$ otherwise. Moreover, a walkup at a degenerate dart preserves the planar index.
\end{lemma}

\begin{proof} The figures make this clear.
\end{proof}

\begin{lemma}\guid{BISHKQW}\rating{100}\tlabel{lemma:planar-index2}
Let $\iota$ be the index of a  hypermap $(D,e,n,f)$, and let $\iota'$ be the index after a walkup $W_h$ at a dart $x$.  Then $\iota \le \iota'$.
\end{lemma} 


\begin{proof}  Without loss of generality, by triality symmetry,  the walkup is an face walkup.  If $\op{split}_c=0$, the inequality is immediate.  If $\op{split}_c=1$, 
$e x$ and $f^{-1} x$ lie in different components after the walkup, hence also in different faces.  Thus, the walkup splits and $\op{split}_f = 1$.  The result follows.
\end{proof}


\begin{lemma}\guid{FOAGLPA}\rating{50}\tlabel{lemma:planar-nonpos}  
The planar index
of a hypermap is never positive.
\end{lemma}

\begin{proof}  An face walkup never decreases the index.  A sequence
of face walkups leads to the empty hypermap, which has
index zero.
\end{proof}


\begin{lemma}\guid{SGCOSXK}\rating{50}\tlabel{lemma:walkup-planar}
Walkups take planar hypermaps to planar
hypermaps.
\end{lemma}

\begin{proof}  
A planar hypermap has maximum index.  The walkup
can only increase the index, but never beyond its maximum.  
Thus, the index remains at its maximum value.
\end{proof}


\subsection{double walkup}

A double walkup is the composite of two walkups of the same type.  The two darts for the two walkups  are to be the members of an orbit of size two (under $n$, $e$, or $f$).  
%%XX?The first walkup is to be chosen so that it merges.  
The second walkup is to be degenerate. By choosing the type of the walkups to be different from the type of the orbit, the first walkup reduces the orbit to a singleton, forcing the second walkup to be degenerate. 
 
Here are some examples.
\begin{itemize}
    \item A double $W_n$ along an edge deletes the edge and 
   merges the two endpoints into
    a single node (Figure~\ref{fig:doublenode}). 
    \item A double $W_f$ along an edge 
    deletes the edge and merges the two faces along the edge into
    one (Figure~\ref{fig:doubleface}).
    \item A double $W_e$ at a node of degree two
    deletes the node and merges the two edges at the node into
    one (Figure~\ref{fig:doubleedge}).
\end{itemize}


\begin{figure}[htb]
  \centering
  \includegraphics[width=90mm]{\pdfp/double-node-walkup.eps}
  \caption{The double node walkup applied to an edge}
  \label{fig:doublenode}
\end{figure}


\begin{figure}[htb]
  \centering
  \includegraphics[width=90mm]{\pdfp/double-face-walkup.eps}
  \caption{The double face walkup applied to an edge}
  \label{fig:doubleface}
\end{figure}


\begin{figure}[htb]
  \centering
  \includegraphics[width=80mm]{\pdfp/double-edge-walkup.eps}
  \caption{The double edge walkup applied to a node}
  \label{fig:doubleedge}
\end{figure}

\begin{figure}[htb]
  \centering
  \includegraphics[width=80mm]{\pdfp/double_edge.eps}
  \caption{The double edge walkup preserves plainness.}
  \label{fig:doubleplain}
\end{figure}


\begin{lemma}\guid{HOZKXVW}\rating{150}\tlabel{lemma:dwalk-planar}  
The three preceding double walkups carry plain
hypermaps into plain hypermaps.
\end{lemma}

\begin{proof} The walkups $W_n$ and $W_f$ preserve the orbit structure of edges, except for dropping one dart.  By dropping both darts from the same edge, one edge is lost and all others edges remain unchanged.

Figure~\ref{fig:doubleplain} illustrates the double $W_e$.  The two edges $\{x,e x\}$, $\{y, e y\}$ meeting the node are fused by the double walkup into $\{e x, e y\}$, which is still an edge of size two.
\end{proof}

The following is a useful way to tell if a walkup merges.


\begin{lemma}\guid{FKSNTKR}\rating{80}\tlabel{lemma:ng-merge}  
Suppose, in a simple plain hypermap, that an edge $\{x,y\}$ consists of two nondegenerate darts.  Then the walkup  $W_f$ (resp. $W_n$) at $x$  merges.
\end{lemma}

\begin{proof} 
The darts $f x$ and $e x$ lie in the same node: $n (f x) = e^{-1} x = e x$. If they are also in the same face of a simple hypermap, then $f x = e x
= y$. So 
  $$n y  = n f x = n f e y = y,$$
and $y$ is a fixed
point of $n$, hence degenerate, contrary to assumption.  
Thus, $f x$ and $e x$ are in different faces, and the walkup merges
by Lemma~\ref{lemma:merge-split}.  
\end{proof}




\section{Contour}



\begin{definition}[contour~path,~contour~loop]  A contour path from $x_0$ to $x_{k-1}$ is a path  $[x_0;x_1;\ldots;x_{k-1}]$ such that $x_{i+1} = n^{-1} x_i$ or $f x_i$ for each $i<k$.  (That is, each step in the path is clockwise step around a node or a counterclockwise step around a face.)   If the contour path $[x_1;\ldots;x_{k-1}]$ is injective and  $x_0 = x_{k-1}$, then it is a contour loop.
\indy{Index}{contour path}\indy{Index}{path}
\indy{Index}{contour loop}\indy{Index}{loop}
\end{definition}

\begin{remark}  Figure~\ref{fig:hypermap_ex} constructs a hypermap from a planar graph by drawing darts next to each angle.  In this representation, the darts along a contour path lie to the left of the corresponding planar graph edges.  For that reason, a shaded region to the left of a curve depicts a contour path.
\end{remark}

\begin{figure}[htb]
  \centering
  \includegraphics[width=80mm]{\pdfp/shade_dart.eps}
  \caption{A contour path as a sequence as dart is represented as a shaded path.}
  \label{fig:shade-dart}
\end{figure}

\begin{lemma}\rating{50} An injective contour path from $x$ to $y$ can be constructed from a contour path from $x$ to $y$ by dropping some darts from the path.
\end{lemma}

\begin{proof} Repeatedly replace $[\ldots;a;b;\ldots;b;c;\ldots]$ with
$[\ldots;a;b;c;\ldots]$.
\end{proof}





\begin{lemma}\guid{KDAEDEX}\rating{100}\tlabel{lemma:connect-contour}  
If $x$ and $y$ are darts in the same combinatorial component, then there exists a contour path from $x$ to $y$.
\end{lemma}

\begin{proof} 
In the same combinatorial component, the darts $x$ and $y$ are joined by a path, where each step is $z\mapsto h z$, for $h=e,n$, or $f$.  Eliminate $e$-steps through the relation $e\ocirc n\ocirc f = I$.   Replace each $n$-step with a sequence of $n^{-1}$-steps.  This gives the desired path.
\end{proof}


\begin{definition}[complementary~path] 
Let $p=[x;y;\ldots;z]$ be a contour loop that does not visit any node twice in a plain hypermap.   Replace each maximal sublist of $n^{-1}$-steps
$$
[u;n^{-1} u; \ldots; n^{-k} u]
$$
with the sublist
$$
[n^{-(k+1)} u;n^{-(k+2)} u;\ldots; n u]
$$
Replace each sublist $[f^{-1} u;u]$ with the sublist
$$
[n u; f n u],\quad f n u = n^{-1} f^{-1} u.
$$
Then join all the pieces in reverse order. The resulting contour loop is the complementary path $p^c$.
\end{definition}

\begin{figure}[htb]
  \centering
  \includegraphics[width=70mm]{\pdfp/complement.eps}
  \caption{The complementary contour loop traces the remaining darts
   at the same nodes as the original contour loop. }
  \label{fig:contour-comp}
\end{figure}

\subsection{M\"obius}

\begin{definition}[M\"obius~contour] A M\"obius contour is an
injective contour path $p$ that satisfies
    \begin{equation}
    \tlabel{eqn:mobius}
    p_j = n p_0\quad p_k = n p_i
    \end{equation}
for some $0 < i\le j< k$ (Figure~\ref{fig:mobius}).
\end{definition}

\begin{figure}[htb]
  \centering
  \includegraphics[width=50mm]{\pdfp/mobius.eps}
  \caption{A M\"obius contour}
  \label{fig:mobius}
\end{figure}

\begin{figure}[htb]
  \centering
  \includegraphics[width=30mm]{\pdfp/3m.eps}
  \caption{The face map on this hypermap gives a M\"obius contour with three darts}
  \label{fig:3m}
\end{figure}

\begin{remark} A M\"obius contour is a 
combinatorial M\"obius strip that
twists to make 
its left-hand side into
its right-hand side.  A planar hypermap has no such contour.  
Figure~\ref{fig:violate-jct}
redraws a violation of the Jordan curve theorem
as a M\"obius contour.   
\end{remark}

\begin{figure}[htb]
  \centering
  \includegraphics[width=80mm]{\pdfp/violate-jct2.eps}
  \caption{A path that tunnels from the interior to the exterior
   of a simple closed curve
   is analogous to a M\"obius contour.}
  \label{fig:violate-jct}
\end{figure}

\begin{figure}[htb]
  \centering
  \includegraphics[width=80mm]{\pdfp/mobius_contour.eps}
  \caption{Some M\"obius contours}
  \label{fig:mobius-contour}
\end{figure}






\begin{lemma}\guid{LIPYTUI}\rating{300}\tlabel{lemma:no-mobius}
Planar hypermaps have no M\"obius contours.
\end{lemma}

\begin{proof} For a contradiction, assume that there exist planar
hypermaps with M\"obius contours.  An edge walkup carries
planar hypermaps into planar hypermaps. An edge walkup
at a dart that is not on the M\"obius contour carries the
M\"obius contour to a M\"obius contour 
and reduces the number of darts.  
In the M\"obius Condition~\ref{eqn:mobius},
a walkup at a dart that is not at position $0$, $i$, $j$, $k$
along the contour carries the M\"obius contour to a M\"obius contour
and reduces the number of darts. Thus, a counterexample with
the smallest possible number of darts contains no
darts except those on the M\"obius contour, and its only darts
are at positions $0$, $i=j=1$, $k=2$.

This is a three darted hypermap (Figure~\ref{fig:3m}.)  
The M\"obius condition, the
definition of contours, together with $e\ocirc n\ocirc f=I$ force
$e=n=f$, all permutations of order three.  This hypermap is not planar:
    $$\# e + \# n + \# f = 3~~\ne~~ 5 = \# D + 2\, \#c.$$
\end{proof}



\subsection{interior}

\begin{definition}[interior]\label{def:interior} 
A dart $y$ lies in the {\it interior} of a contour
loop $L$ if there is a an injective contour path
$x_0,x_1,\ldots,x_k=y$ such that $x_1 = f x_0$ (or $k=0$), and
such that $x_i$ lies on the loop $L$ if and only if $i=0$.
\end{definition}

\begin{lemma}\guid{ILTXRQD}\rating{100}\tlabel{lemma:contour-path-type}
Suppose that a hypermap has no M\"obius contours. Let $L$ be a contour loop.  Let $P$ be any injective contour path (with at least $3$ darts) that starts and ends on $L$, but visits no other darts of $L$ on the way.  Then the first and last steps of $P$ are both of the same type ($n^{-1}$ or $f$).
\end{lemma}

\begin{figure}[htb]
  \centering
  \includegraphics[width=80mm]{\pdfp/interior_nf.eps}
  \caption{A path must enter and depart from a contour loop with the same type of step.}
  \label{fig:interior_nf}
\end{figure}


\begin{proof}   The proof shows the contrapositive.   Suppose $P=[n x;f n x;\ldots;n y;y]$.   The successor of $n x$ on $L$ is $x$.  Starting at $x$,  follow $L$ to $y$, and on to $n x$.  Follow $P$ back to $n y$:
$$
x::L[x:n x] \opat P[ n x;ny].
$$  
This is a M\"obius contour $x\ldots y\ldots n x\ldots n y$.

Suppose $P=[n x;x;\ldots;f^{-1} y;y]$.  Starting at $x$, follow $P$ to $y$, then follow $L$ to $n x$, and  on to $n y$.  This is a M\"obius contour.
\end{proof}

\begin{lemma}\guid{UMYSGDB}\rating{80}\tlabel{lemma:dart-interior}
Let $L$ be a contour loop on a plain hypermap without
M\"obius contours.  Assume a dart $x$ lies in the interior of the loop $L$. 
Then every dart in its $f$-orbit lies in
the interior of the loop.  Moreover, if the dart
$x$ does not lie on the same node as any dart in $L$, then every
dart in the $n$-orbit of $x$ lies in the interior 
of $L$.
\end{lemma}

\begin{proof} Let $P= [x_0;\ldots;x]$ be an injective path that certifies that $x$ lies in the interior of $L$.  If $f x$ lies along this path already or if it lies on $L$, then it is clearly interior.  Otherwise, $[x_0;\ldots,x;f x]$ is a certifying path for $f x$.  Similarly, use the certifying path $[x_0;\ldots;x;n^{-1} x]$ for $n^{-1} x$.
\end{proof}


\begin{definition}[interior~face,~node]  A face or a node is interior to a
loop in a hypermap if all of its darts are interior.
\end{definition}


\begin{lemma}\guid{ICJHAOQ}\rating{180}\tlabel{lemma:contour-interior-exterior}
Suppose that a hypermap has no M\"obius contours.  Let $L$ be a contour loop.
Then there does not exist a contour path
$[x_0;\ldots;x_k]$, for $k\ge 1$ with the following properties:
\begin{enumerate}
\item $x_i$ lies on $L$ iff $i=0$.
\item $x_1 = f x_0$.
\item $x_0$ and $x_k$ lie in different nodes.
\item Some dart of $L$ is at the node of $x_k$.
\end{enumerate}
\end{lemma}

\begin{figure}[htb]
  \centering
  \includegraphics[width=40mm]{\pdfp/no_node_path.eps}
  \caption{No path exists from a node of $L$ to the interior.}
  \label{fig:no-node-path}
\end{figure}

\begin{proof}  Assume for a contradiction that the path $p$ exists.  Some subpath is injective and satisfies the same conditions.  Again, without loss of generality, shrinking the path if needed, $k$ is the smallest index for which the last two conditions are met.  Append $n^{-1}$-steps to $p$ to reach a dart of $L$.  This is contrary to Lemma~\ref{lemma:contour-path-type}.
\end{proof}

\begin{lemma}\label{lemma:3dart}  
Assume that each face of a hypermap has has at least three darts.  Then every contour loop that meets at least two nodes has at least three darts.
\end{lemma}

\begin{proof}  Let $p=[x;y]$ be a contour loop meeting  two nodes.  Then $y = f x$ and $x = f y$, so that the face has size two.
\end{proof}

\section{Generation}

\subsection{quotient}

\begin{definition}[isomorphic] Two hypermaps $(D,e,n,f)$ and $(D',e',n',f')$ are
isomorphic, if there is a bijection $F:D\to D'$ such that
    $$h'\ocirc F = F\ocirc h$$
for $(h,h')=(e,e'), (f,f'), (n,n')$.
\end{definition}


\begin{definition}[normal~collection]
Let $H$ be a hypermap. Assume that 
there are no darts fixed by $e$ 
(so that $f x \ne n^{-1} x$ at each dart). 
Let $\cal L$ be a collection of contour
loops.  The collection $\cal L$ is  normal if the following
conditions hold of its loops. \begin{enumerate}
 \item No dart is visited by two different loops.
 \item Every loop visits at least two nodes.
 \item If a loop visits a node, then every dart at that node is visited by some loop.
\end{enumerate}
\end{definition}

A normal collection determines a new hypermap.   A dart in the new set $D'$ of darts $D$ is a maximal path $[x;n^{-1} x; n^{-2} x;\ldots;n^{-k} x]$  of $n^{-1}$ steps appearing in some loop in $\cal L$. The map $f'$ takes the maximal path $[x;n^{-1}x;\ldots;y]$ to the maximal path (in the same contour loop) starting $[f y;\ldots]$. The map ${n'}^{-1}$ takes the maximal path  $[\ldots;y]$ to the maximal sequence (in some other contour loop) starting $[n^{-1}y;\ldots]$. Equivalently, $n'$ takes the maximal path $[x;\ldots]$ to the maximal path ending $[\ldots;n x]$. The map $e'$ is defined by $e'\ocirc n'\ocirc f' = I$.  

\begin{definition}[quotient]  The hypermap constructed from the normal collection is called the quotient of $H$ by $\cal L$, and is denoted $H/{\cal L}$.  The hypermap $H$ is said to be a cover of $H/{\cal L}$.
\end{definition}

Intuitively, the quotient hypermap is represented as a graph whose cycles under $f$ are precisely the contour loops in the normal family (Figure~\ref{fig:quot}).


\begin{figure}[htb]
  \centering
  \includegraphics[width=70mm]{\pdfp/quot.eps}
  \caption{The contour loops in a normal family become faces in the quotient}
  \label{fig:quot}
\end{figure}


\begin{example}\label{ex:Hall} 
Assume that $H$ is a hypermap with no fixed points under $e$. Assume that every face meets at least two nodes. Then the set of all faces defines a normal collection of contour loops (follow $f$ around each face: $[x;f x;\ldots]$).  Each dart of the quotient is then just a singleton set consisting of a single dart of $H$, and the quotient is isomorphic to $H$ itself.
\end{example}

\begin{example}\label{ex:H2} 
Assume that $H$ is a hypermap with no fixed points
under $e$.  Let $F = (x,f x,\ldots)$ be a face 
that visits at least
three nodes and that meets each node in at most one dart.
Let $\cal L$ be the
collection with two contour loops:  $[x;f x;\ldots]$ and its
complement $L^c = [n^{-1} x;\ldots]$.
%$$
%  [n^{-1} x;n^{-2} x;\ldots;n x;f n x = y;n^{-1} y; n^{-2} y;\ldots; n y; f ny;\ldots]
%$$
The family $\cal L$ is normal. The quotient hypermap $H/{\cal L}$ has two faces $F$ and a backside $F'$ of the same cardinality $k$.
\end{example}





\begin{example}[cyclic]\label{ex:H2k} 
There is a hypermap $H_{2k}$, whose darts are arranged in two faces.  Each
face is $Z_n$, a cyclic group of order $n$ with generator $1$.
The face map is $x\mapsto x+1$.
The node map swaps the two faces $Z_n$.
The usual condition $e\ocirc n\ocirc f = I$ defines the edge map.
If a hypermap is isomorphic to $H_{2k}$ for
some $k$, then it is {\it cyclic}.  For example,
the hypermap constructed in the previous example is cyclic.
\indy{Index}{cyclic hypermap}
\end{example}

\begin{lemma}\guid{JMKRXLA}\rating{280}\tlabel{lemma:quotient-plain}
Let $H$ be a plain hypermap, and let $\cal L$ be a
normal family.  Then $H/{\cal L}$ is a plain hypermap.
\end{lemma}

\begin{proof} Let $e'$, $f'$, and $n'$ be the edge, face, and node maps on the
quotient hypermap.  Write $[\ldots; x]$ for the node in the quotient
ending in dart $x\in H$ and $[x;\ldots]$ for the node in the quotient
starting with dart $x\in H$.  Plainness gives $e^2 x = x$, so that for any
dart $[\ldots x]$ in the quotient:
    $$\begin{array}{lll}
    {e'}^{-2} [\ldots; x] &= n' f' n' f' [\ldots; x] = n' f' n' [f x; \ldots] \\&=
    n' f' [\ldots; n f x] = n' [f n f; \ldots] = [\ldots; n f n f x]\\ &=
    [\ldots; e^{-2} x] = [\ldots; x].
    \end{array}$$
Thus, $e'$ has order $2$ on the quotient.
\end{proof}

%\begin{lemma}\guid{ZOKKAOI}\tlabel{lemma:quotient-planar}
%Let $H$ be a plain planar hypermap, and let $\cal L$
%be a normal family.  Then $H/{\cal L}$ is a plain planar hypermap.
%\end{lemma}
%
%\begin{proof} Suppose $H/{\cal L}$ is not planar.
%Let $P$ be a M\"obius contour on $H/{\cal L}$.  It lifts uniquely to
%a contour on $H$ with the property that the darts visited on $H$ are
%precisely the darts that belong to a dart in the quotient.  This is
%compatible with the node map $n$.  So the contour path lifts to a
%M\"obius contour on $H$.  Thus, $H$ is not planar.
%\end{proof}


\subsection{flag}

The remainder of the chapter presents an algorithm that
generates all simple, plain, planar hypermaps satisfying certain general
conditions (Definition~\ref{def:restricted}).   The algorithm  proceeds by adding edges and nodes to a hypermap by reverse double walkup transformations.

The algorithm  marks certain faces as `true.'
Roughly, this  means that the the face cannot be modified
at any later stage of the algorithm.   When all of its faces
are true, the hypermap stands in final form.
The function that marks each face as true or false is a
{\it flag}.


\begin{definition}[flag]  Let $S$ be a set of darts in a hypermap.  
An $S$-flag is a boolean function on the set of faces that satisfies the following two constraints.
\begin{enumerate}
    \item If darts $x,y$ belong to true faces,
    then there is a contour path from $x$ to $y$ that remains
    in true faces.
    \item Each edge of the hypermap meets a true face or $S$.
    \end{enumerate}
An $\emptyset$-flag is simply called a flag.
%An isomorphism of flagged hypermaps is an isomorphism of
%hypermaps that respects the flags.
\end{definition}

\begin{definition}[canonical boolean function] Let $H/{\cal L}$ be a quotient hypermap with normal family $\cal L$.  The {\it canonical boolean function} on the set of faces of the quotient is the function that is true exactly when every dart in the face is a singleton of $H$.
\end{definition}

\begin{example} The cyclic hypermap of Example~\ref{ex:H2k}, carries a flag that marks one face true and the other false.
\end{example}

\begin{example} Let $H$ be a connected, plain hypermap, and such that $e$ has no fixed points, and let $\cal L$ be the example of Example~\ref{ex:Hall}, then the canonical map takes value $\op{true}$ on every face.  This is a flag. In fact, Lemma~\ref{lemma:connect-contour} provides the contour paths that are required in the definition of flag.
\end{example}

\begin{lemma}\guid{STKBEPH}\rating{100}\tlabel{lemma:all-dart}  
Let $H$ be a hypermap with normal family ${\cal L}$. If the canonical boolean function on the set of faces of $H/{\cal L}$ has at least as many true values as there are faces of $H$, then $\cal L$ is the normal family in Example~\ref{ex:Hall}. In particular, $H/{\cal L}$ is isomorphic to $H$.
\end{lemma}

\begin{proof}  If a face takes value $\op{true}$ in $H/{\cal L}$, then its darts are singletons, and the face of $H/{\cal L}$ is naturally identified with a face in $H$.  This is an injective map from the set of true faces of $H/{\cal L}$ to the set of faces of $H$.  The hypothesis of the lemma implies that this injective map is bijective. All of the darts of $H$ are accounted for under this bijection. Thus, the quotient has no false faces.  The result follows.
\end{proof}


\subsection{extension}\label{sec:face-insert}

In this subsection,  is a hypermap with restrictive properties.

\begin{definition}[restricted]\label{def:restricted}
A restricted hypermap $H = (D,e,n,f)$ is one with the following properties.
    \begin{enumerate}
        \item It is nonempty, connected, plain, planar, simple.
        \item The edge map $e$ has no fixed points.
        \item The node map $n$ has no fixed points.
        \item The size of every face is at least $3$.
        %%  (All hypoth. Needed?)
    \end{enumerate}
\end{definition}


Our aim is to prove that every restricted hypermap with at most $V$ darts is generated by a particular algorithm.  The proof is a long induction argument.  The proof starts by showing how to go from one partially constructed hypermap to another more fully constructed hypermap.  The hypermap $H$ represents the fully constructed hypermap and two quotients $H/{\cal L}$ and $H/{\cal M}$ represent the partially constructed hypermaps.  The algorithm involves the transition from the hypermap $H/{\cal L}$ to $H/{\cal M}$.  This represents one step of the algorithm.

This section describes the transition from $H/{\cal L}$ to $H/{\cal M}$.  The algorithm carries along various auxiliary data satisfying various assumptions, enumerated as follows:

\begin{remark}[context]\label{enum:context}
\begin{enumerate}
\item Assume $\cal L$ is a normal family of $H$.
\item Assume the quotient $H'=(D',e',n',f')=H/{\cal L}$ is simple.  
\item Assume that $L$ is a contour loop in ${\cal L}$ such that the corresponding face $F(L)$ in the quotient is false under the canonical boolean function.
\item Assume $x'\in F(L)$ is a quotient dart such that $e'x'$ lies in a true face.  Write $x' = [\ldots;x]$ with $x\in D$. 
\item There is a largest $m\ge0$ such that 
$$
[x;f x; f^2 x;\ldots;f^{m+1} x]
$$  
is a subpath of $L$.
Let $y = f^{m+1} x$.  Let $S = S(x,{\cal L}) = \{f^i x \mid 1 \le i\le m\}$.   The set $S$ maps bijectively to a set of darts in the quotient, which also denoted  $S$. 
\item Assume that the canonical boolean function on $H'$ is an $S$-flag.
\end{enumerate}
\end{remark}

  


\begin{example}\label{ex:graph-gen}  This example illustrates illustrated the setup (Figure~\ref{fig:graph-gen}).   In the figure, the hypermap $H$ is represented as a planar graph.
The contour loops are represented by left-side shadings of the edges of the
planar graph.  The shaded edges give the edges of a planar graph representing the quotient.  The polygons that are fully shaded are true.   Two polygons in the quotient are false.  A dart on one of the false faces is marked $x$.  By inspection, $m=3$ and $S=\{f x,f^2 x,f^3 x\}$.  By inspection, the canonical boolean function is an $S$-flag.  (In fact, the darts in true faces form a connected region.  Every edge except one edge $\{f x, e f x\}$ meets a true face, and this one edge meets $S$.)
\end{example}

\begin{figure}[htb]
  \centering
  \includegraphics[width=90mm]{\pdfp/graph_gen.eps}
  \caption{An example of the current situation.}
  \label{fig:graph-gen}
\end{figure}


\begin{lemma}\guid{HQYMRTX}\rating{200}  There is a smallest $p\ge0$, such that $f^{p+1} y$ belongs to some loop of ${\cal L}$.  Set $z=f^{p+1} y$.  Then   $z$ is on the contour loop $L$ and is not equal to $f^k x$, for $0 < k \le {m+1}$.
\end{lemma}

\begin{proof} 
For a contradiction, suppose $f^{p+1} y = f^k x$. Then also, $f^p y = f^{k-1} x$.  If $p>0$, then this goes against the minimality of $p$.  So $p=0$, and $y=f^{k-1} x = f^{m+1} x$.  Also, $0\le k-1 < {m+1}$, which forces $L$ to coincide with the contour loop around $F$, which is impossible for a false face.  This proves the second claim of the lemma.  In particular, $z\not\in S$.

For a contradiction, assume that $z = f^{p+1} y$ lies on a different contour loop $L'$.  If $z$ lies in a true face, then $y$ and $x$ lie in the same true face, contrary to the choice of $x$.  So $z$ lies in a false face.  Let $z' = [\ldots;z_1]\in D'$ be the image of $z$ in $D'$.  Also,  $z'\not\in S$.  By the definition of $S$-flag, the dart $e'z'$ lies in a true face or $e'z'\in S$.  The proof splits into two cases depending on which holds.

{\bf Case 1: $e'z'$ lies in a true face.}  Consider the following path in $H$:
$$
[y;fy;\ldots;z] @ [z;\ldots;z_1] @ [n^{-1} z_1;\ldots;f e x].
$$
The first segment consists of $f$-steps; the second of $n^{-1}$; and the third segment exists within true faces by the connectedness of true faces (for flags).  This
path satisfies all the enumerated conditions of Lemma~\ref{lemma:contour-interior-exterior}.  The lemma asserts that the path does not exist.

{\bf Case 2: $e'z'\in S$.}   Consider the following path in $H$:
$$
[y;f y;\ldots;z].
$$
 This
path satisfies all the enumerated conditions of Lemma~\ref{lemma:contour-interior-exterior}.  The lemma asserts that the path does not exist.
\end{proof}


The algorithm constructs a new collection at each step:
$${\cal M} = ({\cal L}\setminus \{L\}) \cup \{L_1,L_2\}.$$. 
Here $L_1$ is the contour loop
$$
L[x:y] \opat P[y:z] \opat L[z:x].
$$
that follows $L$ from $x$ to $y$, then takes $f$-steps from $y$ to $z$, then continues along $L$ back to $x$.  This loop meets at least two nodes and has length at least three by Lemma~\ref{lemma:3dart}. Also, $L_2$ is the contour loop
$$
L[n^{-1}y:n z] \opat P^c[n z:n^{-1}y].
$$
which follows $L$ from $n^{-1} y$ to $n z$, then complements the path of $L_1$ from $y$ to $z$, traveling instead from $n z$ to $n^{-1} y$.  This loop meets at least two nodes (those of $y$ and $z$) and has length at least three by Lemma~\ref{lemma:3dart}.

\begin{figure}[htb]
  \centering
  \includegraphics[width=80mm]{\pdfp/L1L2.eps}
  \caption{The loop $L$ is replaced with two loops $L_1, L_2$.}
  \label{fig:L1L2}
\end{figure}

\begin{figure}[htb]
  \centering
  \includegraphics[width=80mm]{\pdfp/L1L2dart.eps}
  \caption{$H/{\cal L}$ is obtained from $H/{\cal M}$ by double walkup transformations.}
  \label{fig:L1L2dart}
\end{figure}

The passage from  $H/{\cal M}$ to $H/{\cal L}$ consists of  a double walkup on all of the nodes coming from the nodes of $f y$, $f^2 y, \ldots, f^p y$, and then a double walkup on the edge from the node of $y$ to the node of $z$.  The passage in the other direction from $H/{\cal L}$ to $H/{\cal M}$ comes by adding an edge from the node of $y$ to the node of $z$ and inserting $p$ new nodes (of degree two) along it.


Let $\varphi$ be the (noncanonical) boolean function that is false on the face $F(L_1)$ and is otherwise equal to the canonical boolean function. The set $S_{\cal M}=S(x,{\cal M})$ contains the proper subset $S=S(x,{\cal L})$.  The following lemma is used to show that the context of the iteration is preserved.

\begin{lemma}\guid{AQIUNPP}\rating{600}\tlabel{lemma:flag}  
${\cal M}$ is a normal family, the noncanonical function $\varphi$ is an $S_{\cal M}$-flag, and the assumptions on the context (Remark~\ref{enum:context}) are all satisfied in this new context (with $\varphi$ instead of the canonical function, ${\cal M}$ instead of ${\cal L}$, etc.).
\end{lemma}


\begin{proof}   The proof can be organized into three parts, establishing that ${\cal M}$ is normal, that $\varphi$ is a flag, and that the quotient is simple.

{\bf [normal(1)]~} {\it No dart is visited by two different loops.}  By construction, the sets of darts are visited by $L_1$ and $L_2$ are disjoint and disjont from the darts visited by the loops of ${\cal L}\setminus \{L\}$.  The result follows.  

{\bf [normal(2)]~} {\it Every loop visits at least two nodes.}  This is true for $L_1$ and $L_2$ because they visit the nodes of $y$ and $z$.  It is true of the other loops because they belong to the normal family ${\cal L}$. It follows that  ${\cal M}$ is normal.

{\bf [normal(3)]~} {\it If a loop visits a node, then every dart at that node is visited by some loop.}  The new nodes visited on the subpath of $L_1$ from $y$ to $z$ do not contain any darts in any loop in ${\cal L}$.  (By the definition of normal family, every dart at a node or no dart at a node lies along some loop of ${\cal L}$.)  These new nodes contain two darts, with one dart along $L_1$ and the other along $L_2$.   The paths $L_1$ and $L_2$ visit every dart visited by $L$.  They visit every dart at the nodes of $y,\ldots,z$.  

{\bf [flag(1)]~} {\it The true faces are connected.}   If $F(L_2)$ is false, then the set of true faces is the same on $H/{\cal L}$ and $H/{\cal M}$.  In this case the proof is immediate.  If $F(L_2)$ is true, then the proof requires more argument.  Let $y'$ be the image of $y$ in $H'$.  Since the canonical function on $H'$ is a flag, the edge $\{y',e'y'\}$ meets a true face or $S$.  However, $y'\not\in S\subset F(L)$, by the simplicity of $H$.  $e'y'\not\in S \subset F(L)$, by the simplicity of $H'$.  The only remaining possibility is that $e'y'$ lies in a true face.  The dart $e'y'$ is naturally identified with the dart $e_{\cal M} y'$ on in $H/{\cal M}$, and hence a path exists from the true face $F(L_2)$ into another true face, and from there any true face may be reached.

{\bf [flag(2)]~} {\it Each edge meets $S$ or a true face.}  
The function $\varphi$ is an $S_{\cal M}$-flag.  The edges of $H/{\cal L}$ can be identified with a subset of the edges of $H/{\cal M}$.   For this subset, the flag condition on edges is immediate.  Any other edge is one of the newly created edges, and they all share a dart with $S(x',{\cal M})$.  


{\bf [simple]~} For simplicity of the quotient, each of the contour paths in ${\cal M}$ should never return to a node after leaving it.  This is true of ${\cal L}\setminus\{L\}$ by assumption and true of $L_1$ and $L_2$ by construction.  Note in particular, that the dart $z$ is not at the same node as $y$ (by the simplicity of $H$).
\end{proof}


There are various possibilities for $H/{\cal M} = (D_{\cal M},e_{\cal M},\ldots)$.
\begin{enumerate}
\item  The canonical function might be true on every face.  By Lemma~\ref{lemma:all-dart}, the quotient map $H\to H/{\cal M}$ is an isomorphism.  The iteration terminates.
\item The canonical function is false on $F(L_1)$.  Then $\varphi$ is the canonical function.  By Lemma~\ref{lemma:flag}, all the context assumptions hold for the canonical function.  The iteration continues another step.
\item The canonical function is true on $F(L_1)$, but there exists another face $F(L_3)$ that is false.  In this case, the canonical function is a flag (with $S=\emptyset$).  Pick any $x\in F(L_3)$.  The dart $e_{\cal M} x$ lies in a true face.  Take $S=S(x,{\cal M})$.  The canonical function is a flag, hence an $S$-flag.  The iteration continues another step.
\end{enumerate}

The iteration must terminate, because each iteration constructs a quotient of $H$ with more darts than before.  The number of iterations is bounded by the size of the set of darts of $H$.

\subsection{algorithm}

If a hypermap is restricted and $x$ is any dart, then $x$ and $n x$ lie
on different faces.  In particular, a restricted hypermap has at least two faces.
To begin the process,  take ${\cal L}$ to be the normal family of Example~\ref{ex:H2} with two contour loops, whose quotient hypermap is a polygon $H_{2k}$.  When the the initial contour loop is chosen on a face of maximal size,  the natural number $k$ is  an upper bound on size of a face.

In summary,  a process  starts with a single polygon and then adds edges and nodes of degree two along the inserted edges,  to obtain a restricted hypermap $H$.

A modification of the process avoids explicit reference to the hypermap $H$ and to the normal family ${\cal L}$.   Let $V$ be a finite set that contains all the darts for all of the restricted hypermaps to be constructed.  For each $k=3,\ldots,\# V$, the process generates all restricted hypermaps with greatest face-size $k$, with darts in $V$.  

The algorithms performs the following initialization.  The initial hypermap is the polygonal hypermap $H_{2k}$.  A flag $\varphi$ marks one face  true and the other false.  A distinguished dart $x$ is selected on the false face.  For each  $m<k$, set $S=S_m = \{f^i x\mid 1\le i\le m\}$.

Each iteration processes a finite list ${\cal H}$ of quadruples $(H,m,\phi,x)$, where $H$ is a simple hypermap, $\varphi$ is an $S$-flag, $x$ lies in a false face, and $S = \{f^i x\mid 1\le i\le m\}$ for some $m$.  The algorithm terminates when every face of every hypermap in ${\cal H}$ is true.  At every step of the algorithm, one quadruple with some false face is removed from ${\cal H}$ and finitely many quadruples are returned to ${\cal H}$.

At each iteration the chosen $(H,m,\phi,x)$ is modified in the following ways and each modification is placed back in the list ${\cal H}$.  As the natural number $m$ depends on the unknown normal family ${\cal L}$, all possible $m < k$ are used.  Similarly, the natural number $p < k$ depends on ${\cal L}$, and  all possible $p$ are used.  Any quadruple that is isomorphic to one previously considered is discarded as redundant. 

In summary, the algorithm constructs of hypermaps.  The process must terminate, because the set $V$ is finite, so there are only finitely many quadruples (or quadruples up to isomorphism) that construct their dart sets from $V$.

\begin{lemma}\guid{BRGEFNH}\rating{2000}  Fix $k\ge 3$ and $V\ne \emptyset$.
This process constructs in a finite number of steps all restricted hypermaps, up to isomorphism,  such that the dart set belongs to the finite set $V$, and whose greatest face size is $k$.
\end{lemma}


\bigskip

\begin{note} %XX
 I thank Tran Nam Trung for many helpful comments, discussions, and corrections about the material in this chapter.
\end{note}

\begin{remark}
G. Gonthier devised the notion of M\"obius contour as a way to prove the Four-Color theorem without appeal to topology.  (The Appel-Haken proof of the Four-Color theorem relies on the Jordan curve theorem.)  
\end{remark}

%%%%%%%%%%%%%%%%%


\chapter{Fan}\label{sec:fan}

A fan is a geometric object that gives a bridge between sphere packings and hypermaps.  A fan is a particular geometric realization of a hypermap.  It is closely related to the notion of planar graph, but relates more directly to sphere packings.  This chapter does not  assume the Jordan curve theorem or Euler formula for planar graphs.  The main result of this chapter gives a simple version of the Euler formula, 
which implies that the hypermap of a fan is planar.

In this chapter, we fix a point $\orgn\in\ring{R}^3$, which serves as the origin.  It does no harm to assume, in face, that $\orgn =0\in\ring{R}^3$.

If $S$ is a set of points,
set
  $$
  \begin{array}{lll}
  C(S) &= \op{aff}_+(\orgn,S)\\
  C^0(S) &= \op{aff}^0_+(\orgn,S)\\
  \end{array}
  $$

\begin{definition}[fan]  
Let $(V,E)$ be a pair consisting of a set $V\subset \ring{R}^3$ and a set of pairs of elements of $V$.  The pair is said to be
a {\it fan\/} if the following conditions hold.
    \begin{itemize}
    \item $V$ is finite.
    \item $\orgn\not\in V$.
    \item If $\e \in E$, then $\{\orgn\}\cup \e$ is not a collinear set.
    \item Let $\Sigma = E \cup \{\{v\}\mid v\in V\}$.
    For all $\sigma,\sigma'\in \Sigma$, 
 $$C(\sigma)\cap C(\sigma') = C(\sigma\cap \sigma').$$
    \end{itemize}
When $\e\in E$, call $C^0(\e)$ or $C(\e)$ a {\it blade\/} of the fan.
\indy{Index}{blade}
\indy{Index}{fan}
\end{definition}

\begin{lemma}  Let $(V,E)$ be a fan.
For each $v\in V$, the set
        $$
        E(v) = \{w\in V\mid \{v,w\}\in E\}
        $$
        is cyclic with respect to $(\orgn,v)$.
\end{lemma}

\begin{proof}  If $w\in E(v)$, then $\{\orgn,v,w\}$ is not collinear.
Also, if $w\ne w'\in E(v)$, then
$$
C(\{v,w\})\cap C(\{v,w'\}) = C(\{v\}).
$$
This implies that $E(v)$ is cyclic.
\end{proof}

\begin{remark}\tlabel{rem:fan}\rating{30}
\begin{itemize}
\item The pair $(V,E)$ is a graph with nodes $V$ and edges $E$.  The set
$\{\{v,w\}\mid w\in E(v)\}$ is the set of edges around a fixed node $v$.
Note that $w\in E(v)$ if and only if $v\in E(w)$.   
%
\item The final condition implies that the sets $C^0(\e)$
do not meet.   This condition will eventually yield planar
hypermaps.
%
\item
Since $E(v)$ is cyclic,
for each $v\in V$, we have an azimuth cycle $\sigma(v):E(v)\to E(v)$.
We allow $E(v) = \{w\}$ to be a
singleton set. If so,
$\sigma(v)$ is the identity map on $E(v)$.
%
Sometimes we write $\sigma(v,w)$ for $\sigma(v)(w)\in E(v)$.
%
\item 
The condition that $\{\orgn,\e\}$ is not a collinear set, when $\e\in
E$, implies no loops: $\{v,v\}\not\in E$.
%
\end{itemize}
\end{remark}


Let $(V,E)$ be a fan.  We define a sets of darts $D$, and
two subsets $D_1,D_2$:
    $$
    \begin{array}{lll}
    D_1 &= \{(v,w)\mid \{v,w\}\in E\}\\
    D_2 &= \{v \mid v\in V,\ \ E(v) = \emptyset\},\\
    D   &= D_1\cup D_2.
    \end{array}
    $$
Darts in $D_2$ are said to be {\it isolated}; and darts in $D_1$ are {\it non-isolated}.
%
We define a permutation $n$ on $D_1$ by
    $$n(v,w) = (v,\sigma(v,w)).$$
We define a permutation $f$ on $D_1$ by
    $$
    f (v,w) = (w,\sigma(w)^{-1} v).
    $$
Define a permutation $e$ on $D_1$ by
    $$
    e (v,w) = (w,v).
    $$
Define permutations $e,n,f$ on $D_2$ by making them degenerate on $D_2$:
    $$
    e (v) = n(v) = f(v) = v.
    $$
Write $\op{hyp}_r(V,E)=(D_1,e,n,f)$ and $\op{hyp}(V,E)=(D,e,n,f)$.  We call them the non-isolated hypermap
and the hypermap associated with $(V,E)$.  The next
lemma justifies this terminology.



\begin{lemma}\guid{AAUHTVE}\rating{70}
Let $(V,E)$ be a fan.  Let $D = D_1\cup D_2$
and $\op{hyp}(V,E) = (D,e,n,f)$, as constructed above.  Then
    \begin{itemize}
    \item $\op{hyp}(V,E)$ is a plain hypermap.
    \item  $e$ has no fixed
points in $D_1$.
    \item  $f$ has no fixed points on $D_1$.
    \item For every pair of distinct nodes, there is at most one
    edge meeting both.
    \item The two darts of an edge (of $D_1$) lie at different nodes.
    \end{itemize}
\end{lemma}

\begin{proof}  We compute
    $$
\begin{array}{lll}
e(n(f(v,w))) &= e(n(w,\sigma(w)^{-1} v))) &=
        e(w,v)\\ 
&= (v,w).
\end{array}
$$
So it is a hypermap. We compute
    $$e(e(v,w)) = e(w,v) = (v,w).$$
So it is plain. A fixed point in $D_1$ under $e$ would force $v = w\in E(v)$,
but by construction $v\not\in E(v)$.  The argument that $f$ has no
fixed points is similar.

   We show that for every pair of distinct nodes, there is at most one edge
meeting both.
That is,
        $$(n^k e x = e n^\ell x)\Rightarrow (n^\ell x = x).$$
Let $x = (v,w)\in D_1$.  Let $\sigma=\sigma(v)$. Then
    $$
    \begin{array}{lllllll}
    n^\ell x &= (v,\sigma^\ell w)\\
    e n^\ell x &= (\sigma^\ell w,*)\\
    e x &= (w,*)\\
    n^k e x &= (w,*)\\
    n^k e x &= e n^\ell x &\ \Rightarrow (w = \sigma^\ell w) &\ \Rightarrow
    (n^\ell x &= (v,w) = x)
    \end{array}
    $$

Finally, we show that each dart of an edge lies on a different node.
That is, $e x \ne n^k x$, for $x\in D_1$.  We have
    $$
    \begin{array}{lll}
        e(v,w) &= (w,*),\quad w\in E(v)\\
        n^k(v,w) &= (v,*),\quad v\not\in E(v).
    \end{array}
    $$
The result follows.
\end{proof}

\section{Topology}\label{sec:topology}

\subsection{basics}

There is hardly any topology that comes up in this book.  Most of
what is needed appears in this chapter.  We make use of some basic
notions in topology such as continuity, connectedness, and compactness.

\begin{remark} The term {\it connected} is now being used in
two different senses: in the topological sense and in a combinatorial
sense for hypermaps.   We will refer to the connected components
of a topological space as topological components and the connected
components of a hypermap as combinatorial components to reduce the confusion.
\end{remark}






The set $\ring{R}^3$ is a metric space under the
Euclidean distance function $d(v,w) = \norm{v}{w}$.  Subsets of
$\ring{R}^3$ are a metric space under the restriction of the metric
$d$ to the subset. Subsets carry the metric space topology. 
If $Y$ is an open set in $\ring{R}^3$, write
$\comp{Y}$ for its set of topological components.
If two
points in $\ring{R}^3$ 
can be joined by a continuous path that avoids $X$,
then they lie in the same topological component of $Y$.
If we produce a family of pairwise disjoint nonempty connected open sets in
$Y$, whose union is all of $Y$, then
this family is $\comp{Y}$.
%embers of the family are the topological components of $Y$.
Let $$S^2(\orgn) = \{ v \mid \norm{ v}{\orgn } = 1\}$$ be the unit sphere in
$\ring{R}^3$, centered at $\orgn$.  






\subsection{topological component and dart}

Let $(V,E)$ be a fan and let $(D,e,n,f) = \op{hyp}(V,E)$
be the associated hypermap.  Write $D = D_1\cup D_2$ as a union of
non-isolated and isolated darts.

\begin{definition}[X,~Y]\label{def:XY}
Let $(V,E)$ be a fan.  Let $X=X(V,E)$ be the union of the
cones
   $$C(\e)$$
as $\e$ ranges over $E$.  Let $Y=Y(V,E)$ be the complement
$Y = \ring{R}^3\setminus X$.
\indy{Index}{X}\indy{Index}{Y}.
\end{definition}


We associate a wedge $\Wdart(x)$, a subset $\Wdart(x,\epsilon)$,
and an azimuth angle $\op{azim}(x)$
with each dart $x\in D$.  If
$x=(v,w)\in D_1$, set
$\Wdart(x) = W(\orgn,v,w,\sigma(v,w))$ and $\op{azim}(x) =
\op{azim}(\orgn,v,w,\sigma(v,w))$.   If $x=v\in D_2$, then we set
$\Wdart(x) = \ring{R}^3\setminus \op{aff}\{\orgn,v\}$ and $\op{azim}(x) = 2\pi$.  For any $x = (v,\ldots)\in D$, set
    $$
    \Wdart(x,\epsilon) = \Wdart(x) \cap \op{rcone}^0(\orgn,v,\cos\epsilon).
    $$

\begin{note}%XX
All the hypermaps in this book are connected. $D_2$ is not needed.
\end{note}


\begin{lemma}\guid{VBTIKLP}\tlabel{lemma:disjoint}\rating{120}
Let $(D,e,n,f)$ be the hypermap attached to a 
fan $(V,E)$.
Let $N$ be a node of $D$.  There exists $v\in V$
such that the darts of $N$ are precisely
the darts of the form $(v,\ldots)$.  Furthermore, there is a 
disjoint sum decomposition of $\ring{R}^3$ given by
  $$
  \ring{R}^3 = 
  \op{aff}\{\orgn,v\} \cup
  \bigcup_{x\in N} \Wdart(x)  \cup 
  \bigcup_{\{v,w\}\in E} \op{aff}_+^0(\{\orgn,v\},w).
  $$
\end{lemma}

If $x\in D$, write $v(x)\in V$ for the corresponding vertex.  By the lemma,
we may identify $V$ with the set of nodes of $D$.

\begin{proof}
We prove the existence of the disjoint sum decomposition.
First of all, $\ring{R}^3$ is the disjoint union of $\op{aff}\{\orgn,v\}$
and its complement.
Fix $u$ such that $\{v,u\}\in E$, and let $\sigma$ be the azimuth
cycle on $E(v)$.  Every $y\in\ring{R}^3\setminus\op{aff}\{\orgn,v\}$ satisfies
$$
\op{azim}(\orgn,v,u,\sigma^i u)<
\op{azim}(\orgn,v,u,y) < \op{azim}(\orgn,v,u,\sigma^{i+1} u).
$$
or 
$$
\op{azim}(\orgn,v,u,\sigma^i u) = \op{azim}(\orgn,v,u,y)
$$
for a unique $0 \le i < n$, where $n$ is the cardinality of $E(v)$.
These conditions are exactly the membership conditions for the sets
$
\Wdart(v,\sigma^i u)
$
and $\op{aff}_+^0(\{\orgn,v\},\sigma^iu)$, respectively.
The result follows.
\end{proof}

\begin{corollary}\guid{IBZWFFH}\tlabel{cor:W}\rating{40}
Let $x = (v,\ldots)$ be a node.
We have $\Wdart(x)\cap C(\{v,w\})=\emptyset$, for $w\in E(v)$.
\end{corollary}

\begin{proof} The decomposition of Lemma~\ref{lemma:disjoint} is
disjoint.  It follows directly from the definitions that
   $$C(\e)\subset \op{aff}_+^0(\{\orgn,v\},w) \cup 
    \op{aff}\{\orgn,v\}.$$
\end{proof}

\begin{lemma}\guid{JGIYDLE}\rating{120} 
For each $x$, and $\epsilon$ sufficiently small and positive,
$\Wdart(x,\epsilon)$ is nonempty and lies in a single 
topological component of $Y(V,E)$.
\end{lemma}

\begin{proof}  First we show that $\Wdart(x,\epsilon)$ lies in $Y$,
for $\epsilon$ small.  Let $x=(v,w)\in D_1$.  
Let $S^2(\orgn)$ be the unit sphere centered at $\orgn$.
By making $\epsilon$ small enough,
the sets $\Wdart(x,\epsilon)\cap S^2(\orgn)$
avoid the compact sets $C(\e)\cap S^2(\orgn)$ when $v\not\in e$.
Thus, $\Wdart(x,\epsilon)$ also avoids $C(e)$ when $v\not\in e$.
By Corollary~\ref{cor:W}, $\Wdart(x,\epsilon)$ avoids $C(\e)$, when $v\in \e$.
Thus, $\Wdart(x,\epsilon)\subset Y$, for $\epsilon$ small.

To complete the proof, it is enough to show that each $\Wdart(x,\epsilon)$ is
connected.  
The  set
   $$
   R=\{(r,\theta,\epsilon') \in (0,\infty) \times (\theta_1,\theta_2) \times (0,\epsilon)\}
   $$
is connected.
The set $\Wdart(x,\epsilon)$  is the image of $R$
under a spherical coordinate representation (Definition~\ref{def:sph}).
It is readily verified that the polar coordinate representation is
a continuous map. As the image of a connected set under a continuous map
is connected, $\Wdart(x,\epsilon)$ is connected.
\end{proof}

\begin{definition}[leads~into] For each dart $x$, 
there is then a well-defined connected
component $U_x$ of $Y(V,E)$ 
that contains $\Wdart(x,\epsilon)$ (for all
sufficiently small $\epsilon$). Say the dart {\it leads into}
$U_x$.
\end{definition}


\section{Planarity}


\subsection{face attributes}

For $x\in D$, let $v(x)\in V$ be the node of $x$.

\begin{lemma}\guid{DHVFGBC}[sweep]\rating{400}\label{lemma:sweep}  
Let $(V,E)$ be a fan, with hypermap $(D,e,n,f)$.  
Suppose that $\op{azim}(x)<\pi$
for all darts $x\in D$.  Fix a dart $x\in D$.
Let $v = v(x)$, $v_0 = v(f x)$,
and $v_1 = v(f^2 x)$.  Let $v_t = (1-t) v_0 + t v_1$, for
$0\le t\le 1$.  Let $C^0(t) = \op{aff}_+^0(\orgn,\{v,v_t\})$.
Let $Y = Y(V,E)$ and $X = X(V,E)$.
Then
\begin{itemize}
\item The set $\{\orgn,v,v_t\}$ is not collinear for any $t\in[0,1]$.
\item If $0 < t \le 1$, and $C^0(t)$ meets $X$, then $t=1$, $\{v,v_1\}\in E$, and $C^0(1) = C^0(\{v,v_1\})$.
%\item For $0< t < 1$, we have $C^0(t)\subset Y$.
%item If $\{v,v_1\}\in E$ (that is, if the face of $x$ is a triangle), 
%then $C^0(1)$ is the blade $C^0(\{v,v_1\})$ of the fan.
%\item If $\{v,v_1\}\not\in E$, then $C^0(1)\subset Y$.
\end{itemize}
\end{lemma}


\begin{figure}[htb]
  \centering
  \includegraphics[width=50mm]{\pdfp/vt.eps}
  \caption{Adding an edge to the fan.}
  \label{fig:vt}
\end{figure}


\begin{proof}
It follows from the definition of a fan that $\{v,v_0\}\in E$ and
that $\{\orgn,v,v_0\}$ is not collinear.  By continuity, $\{\orgn,v,v_t\}$
is not collinear for $t>0$ sufficiently small.  If it exists, set $t'$ as
the smallest $t>0$ for which $\{\orgn,v,v_t\}$ is a collinear set.  If it exists, let $I=\{t\mid 0< t < t'\}$, otherwise let $I=\{t\mid 0 < t \le 1\}$.  For each $t\in I$, the blade $C^0(t)$ is not a collinear set and is contained in a unique plane $P(t)$ through $\orgn$ and $v$.

We claim that if $t\in I$ and $C^0(t)$ meets $X$, then $t=1$, $\{v,v_1\}\in E$, and $C^0(1)= C^0(\{v,v_1\})$.  By considering possible intersections with vertices $w\in V$ and blades
$C^0(\e)\subset X$, we find that for $t>0$ sufficiently small,
$C^0(t)$ does not meet $X$, hence $C^0(t)\subset Y$.  Assuming 
that it exists, set $t''$
as the smallest $t\in I$ for which $C^0(t)$ meets $X$.   
$C^0(t'')$ cannot meet $X$ at a vertex $w\in V$, because each azimuth angle
is $<\pi$ at $w$, which means that for any $t$ for which  $C^0(t)$ meets $w$ 
there is a smaller $t'''<t$ for which $C^0(t''')$ meets a blade into $w$.
Thus, $C^0(t'')$ first meets $X$ along a blade $C^0(\e)$. If
the intersection is transversal, again we can find a smaller $t$ that
gives an intersection with the blade.  Hence, we may assume that
$C^0(t'')$ and $C^0(\e)$ are coplanar.  From the disjointness
properties of blades of a fan, it follows that $\e = \{v,v_1\}\in E$,
that $t''=1$, and that $C^0(1)$ is a blade of the fan.

Now assume for a contradiction that $t'$ exists.  Pick $0<t''<t'$.  Then
$\{\orgn,v(t''),v(t'),v\}$ lie in a unique plane $P$.  Since all $v(t)$
are collinear,  $v(t)\in P$ all $t\in I$.  In particular $v_0\in C^0(t'')\cap X$,
contradicting the established disjointness of $X$ from $C^0(t'')$.  Thus, $t'$ does not exist.  This proves the first
claim of the lemma.  

Now $I= \{t\mid 0 < t \le 1\}$ and the other claims follow immediately.
\end{proof}

\begin{lemma}\guid{RWXUYZZ}\rating{100} 
Let $(V,E)$ be a fan with hypermap $(D,e,n,f)$. Let $Y=Y(V,E)$. Assume that $\op{azim}(x)<\pi$ for all darts. Then for every face $F$ of the hypermap, there exists a topological component $U$ of $Y$ such that for every $x\in F$, the dart $x$ leads into $U$. 
\end{lemma}

Write $F\mapsto U_F$ for this map from faces to topological components.

\begin{proof}  Fix any dart $x\in F$ and construct the set $C^0(t)$ as
in the previous lemma.  By the previous lemma, the set $C^0(t)$ lies in a single
component $U$ for all $t>0$ sufficiently small.  For all $\epsilon>0$
sufficiently small, there exists $\delta>0$ such that set $C^0(t)$ meets
both $W(x,\epsilon)$ and $W(f x,\epsilon)$ for all $t<\delta$.  Thus,
$x$ and $f x$ lead into the same component $U$.  By induction, for all
$y\in F$, the dart $y$ leads into $U$.
\end{proof}

\begin{lemma}\guid{JUTSTKG}\rating{120}
Let $(V,E)$ be a fan with hypermap $(D,e,n,f)$. Let $Y=Y(V,E)$. Assume that $\op{azim}(x)<\pi$ for all darts.  For every topological component $U$ of $Y$, there is a dart $x\in D$ that leads into $U$.
\end{lemma}

\begin{proof}  
To show the dependence of the sets $C^0(t)$ on the initial dart $x$, write $C^0(t,x)$.

Let $p\in U$.  Choose a path $\gamma:[0,1]\to \ring{R}^3$
such that $\gamma(t)\in U$ for $t<1$ and $\gamma(1)\not\in U$.  Then
$q=\gamma(1)\in X$.  If $q\in\op{aff}^0_+(\orgn,v)$ for some $v\in V$,
then there exists a dart $x$ with node $v = v(x)$ such that for 
all $0\le t < 1$ and all sufficiently
small $\epsilon>0$, we have $\gamma(t)\in W(x,\epsilon)$.  Thus,
$x$ leads into $U$.

The other possibility is that
$q\in C^0(\{v,w\})$ for some $\{v,w\}\in E$.  There is a unique
edge $\{x,y\}$ of the hypermap such that $v=v(x)$ and $w=v(y)$.  
There
is a small neighborhood of $q$ such that every point $q'$ in that neighborhood
takes one of the following forms:
\begin{itemize} \item $q'\in C^0(\{v,w\})$.
\item $q'\in C^0(s,x)$ for some $0<s<1$.
\item $q'\in C^0(s,y)$ for some $0<s<1$.
\end{itemize}
Points of the first form do not meet $Y$.  Thus for some $t<1$ and $s<1$
we have $\gamma(t)\in C^0(s,x)$ or $\gamma(t)\in C^0(s,y)$.  Thus,
$x$ or $y$ leads into $U$.
\end{proof}

\begin{lemma}\guid{KVQWYDL}[triangle attributes]\rating{200} \label{lemma:triangle}
Let $(V,E)$ be a fan with hypermap $(D,e,n,f)$. 
Let $Y=Y(V,E)$.
Assume that $\op{azim}(x)<\pi$
for all darts.  Fix a face $F$ of cardinality three, fix
$x\in F$, and set $x_i = f^i x$. Then
\begin{itemize}  
\item $U_F$ is equal to the intersection of the three half-spaces
$$H^0(i)=\op{aff}_-^0(\{\orgn,v(x_{i+1}),v(x_{i+2})\},v(x_i)),\quad i=0,1,2$$
\item if a dart $y$ leads into $U_F$, then $y\in F$.
\end{itemize}
\end{lemma}

\begin{proof} The intersection of two half-spaces, $H^0(1)\cap H^0(2)$ is
the wedge $W(x)$.   The sets $C^0(t)\subset W(x)$ sweep out precisely
the intersection of $W(x)$ with $H^0(0)$.  The sets $C^0(t)$ belong to
$U_F$.  Hence the intersection $U'$ of the three half-spaces is a subset of $U_F$.

Suppose for a contradiction 
that $p$ is a point of $U_F$ that does not belong to $U'$.  Choose a path $\gamma:[0,1]\to U_F$ with $\gamma(0)\in U'$ and $\gamma(1)=p$.  Let $t>0$ be the first time such that $\gamma(t)\not\in U'$.  Then $q=\gamma(t)$ lies in the set consisting of the closed intersection of half-spaces $H(i)$ corresponding to $H^0(i)$ and lies
in one of the bounding planes.  Let 
$$
X' = \cup C(i),\quad\text{ where } C(i)=C(\{v(x_i),v(x_{i+1})\}).
$$
Then $q\in X'\subset X$.  Thus,
$q\in X\cap Y = \emptyset$, which is impossible.  Thus, $U'=U_F$.

Let $y$ be any dart that leads into $U_F$ at vertex $v(y)$.  Then
$W(y,\epsilon)$ meets $U_F$ for all $\epsilon>0$ sufficiently small.
This implies that $v(y)$ lies in the intersection of the closed half-spaces $H(i)$.  As we have seen, this intersection is the disjoint union of $U_F$ and
$X'$.  As $v(y)\in X$, which does not meet $U_F$, we have $v(y)\in X'$.
The set $X'$ is the disjoint union of the rays $\op{aff}_+(\orgn,v(x_i))$ and
the three blades $C^0(i)$.  These blades do not meet the vertices, hence
$v(y)=v(x_i)$ for some $i$.  Thus, $y$ and $x_i$ belong to the same
node.  The sets $W(y)$ and $W( x_i)$ are disjoint for distinct darts at the same
node, and this implies that $y=x_i\in F$.
\end{proof}

\begin{corollary}\guid{MOZNWEH}\rating{60}\label{lemma:girard-component}
Let $F$ be a face of size $3$ in in the context of Lemma~\ref{lemma:triangle}.  Then $U_F$ is measurable and eventually radial at $\orgn$.
The solid angle of $U_F$ is given by the formula
$$
\sol(U_F) = -\pi + \sum_{x\in F}\op{azim}(x),
$$
\end{corollary}

\begin{proof} An intersection of half-spaces is measurable and
eventually radial.  The solid angle is given by Girard's formula for
a spherical triangle.
\end{proof}

\begin{lemma}\guid{PIIJBJK}[face attributes]\rating{1000}\label{lemma:face}
Let $(V,E)$ be a fan with hypermap $(D,e,n,f)$. 
Let $Y=Y(V,E)$.
Assume that $\op{azim}(x)<\pi$
for all darts $x\in D$.  Then
\begin{itemize}
\item The map $F\mapsto U_F$ is a bijection between faces of the hypermap
and topological components of $Y$.
\item  Each topological component $U_F$ is the intersection of the open
half-spaces $\op{aff}_+^0(\{\orgn,v(x),v({f x})\},v(f^2 x))$, as $x$ runs
over $F$.
\item For every $F$, the topological component $U_F$ is measurable and
eventually radial at $\orgn$.  The solid angle of $U_F$ is given by the
formula
$$
\sol(U_F) = 2\pi + \sum_{x\in F}(\op{azim}(x)-\pi).
$$
\item If $x,y\in F$, with corresponding vertices $v(x),v(y)\in V$, then
$\{\orgn,v(x),v(y)\}$ are not collinear.
Furthermore, 
either $x,y$ are adjacent under the face map, or $C^0(\{v(x),v(y)\})\subset U_F$.  {\it That is, the diagonals of the polygon $U_F$ are all interior.}
\item  Triangulations of $U_F$ exist.
\end{itemize}
\end{lemma}

Before moving to the proof, we give some corollaries.

\begin{corollary}\guid{GINGUAP}\rating{40}
Each topological component $U_F$ is convex.
\end{corollary}

\begin{proof} It is the intersection of half-spaces.
\end{proof}

\begin{corollary}\guid{SRPRNPL}\rating{60}  
The hypermap is simple.
\end{corollary}

\begin{proof}  Let $x\in F$.  By the intersection of half-spaces property, $U_F$ is contained in the wedge $W(x)$ at $x$.  If there is a second dart $y$ at the same node in $F$, then $U_F$ is also contained in $W(y)$. However, by Lemma~\ref{lemma:disjoint}, the wedges at a given node are disjoint.
\end{proof}

\begin{corollary}\guid{WGVWSKE}\rating{150}  
The hypermap is connected.
\end{corollary}

\begin{proof} Assume that $x,y$ be any two darts.  By replacing $x$ with $f x$ if necessary, which lies in the same combinatorial component as $x$, we may
assume that $\{\orgn,v(x),v(y)\}$ is not a collinear set. 
For each blade $C^0(\e)$ of the fan that meets $C=C^0(\{v(x),v(y)\})$
pick one of the two endpoints of $\e$.  Then we get a sequence
$$
v(x)=v_0,v_1,\ldots,v_k=v(y)
$$
such that $C^0(\{v_i,v_{i+1}\})$ lies in a single topological component $U_i$.  Each $U_i$ has the form $U_{F_i}$ for some face $F_i$ of the hypermap.
Thus, we may construct a combinatorial path from $x$ to $y$, by moving by the face map from dart to dart within each $F_i$ and by the node map from dart to dart around a given node $v_j$.
\end{proof}

\begin{corollary}\guid{GGRLKHP}\rating{100}  
The hypermap is planar.
\end{corollary}

\begin{proof}  The solid angle of a sphere is $4\pi$.  The set $X$
has measure zero, so that
$$
4\pi = \sol(Y)= \sum_F \sol(U_F) = 
\sum_F ( 2\pi + \sum_{x\in F} (\op{azim}(x)-\pi) ).
$$
The double sum over faces and darts in a face can be replaced by
a single sum over darts.  
The sum of the azimuth angles of all darts at a node is $2\pi$. Thus,
all the azimuth angle terms give $2\pi\,\#n$.
Thus, the formula becomes
$$
4\pi = 2\pi\, \#f +2\pi\,\#n - \pi\, \#D.
$$
In a plain hypermap in which the edge map has no fixed points, $\#D = 2\,\#e$.
The relation becomes
$$
2 + \#D = \#f + \#e + \#n.
$$
This is the condition of planarity for a connected hypermap.
\end{proof}

\subsection{proof of face attributes}

Now we turn to the proof of the face-attribute lemma (Lemma~\ref{lemma:face}).  We break the proof into a series of small lemmas.  The primary proof method is an induction on the following invariant of a fan $(V,E)$.  If $(V,E)$ is a fan,  let $N(V,E)$ be the natural number
$$
\sum_F (n_F - 3),
$$
where the sum runs over faces of the  hypermap, and $n_F$ is the cardinality of the face $F$.
%We prove the conclusion of the lemma, together with the additional
%conclusion:
%\begin{itemize}
%\item If $C^0(\e)$ is any diagonal of $U_F$ (with $\e\not\in E$), then the %fan $(V,E'')$, where $E'' = E\cup\{\e\}$, satisfies
%$N(V,E'')+1 = N(V,E)$.
%\end{itemize}

\begin{lemma} Lemma~\ref{lemma:face} holds under the additional assumption that $N(V,E) = 0$.
\end{lemma}

\begin{proof}
If $N(V,E)=0$, then the hypermap is a triangulation.  We consider this
case first.  By earlier lemmas, every topological component of $Y$ has
the form $U_F$ for some face $F$.  By Lemma~\ref{lemma:triangle}, $U$ uniquely determines the face $F$.  Thus, there is a bijection between faces of the hypermap and topological components.  By Lemma~\ref{lemma:triangle}, the topological component $U_F$ is the intersection of open half-spaces as asserted.  The solid angle formula is given by Corollary~\ref{lemma:girard-component}.  The facts about diagonals and triangulations are trivial for a hypermap that is already a triangulation. This completes the proof in the base case $N(V,E)=0$.
\end{proof}

Now consider the case $N(V,E)>0$.  There exists a face $F$ of the hypermap that is not a triangle.  By Lemma~\ref{lemma:sweep}, there is a diagonal in $U_F$. We form a new fan $(V,E')$ on the same vertex set with
$E' = E\cup \{\{v,w\}\}$.   

\begin{lemma} 
$N(V,E')<N(V,E)$.
\end{lemma}


\begin{proof}  There is a uniquely determined edge $\{x,z\}$ of $\op{hyp}(V,E')$ such that $v=v(x)$ and $w=v(z)$.   The hypermap $\op{hyp}(V,E)$ is obtained from $\op{hyp}(V,E')$ by a double walkup transformation on the edge $\{x,z\}$.  The darts belong to different faces $F_x$ and $F_z$ (by Lemma~\ref{lemma:triangle}), one of which (say $F_x$ is a triangle.  Thus, the walkup transformation merges two faces.  Let $n$ be the cardinality of $F_z$. Then 
$$N(V,E) - N(V,E') = ((n+1)-3) ~~-~~ ((n-3) + (3-3)) = 1 >0.$$
\end{proof}

Assume for a contradiction that there exists a fan $(V,E)$ 
satisfying the assumptions of the lemma, but not the conclusion.
Among all such counterexamples with fixed $(V)$, we may pick
$E$ to minimize  $N(V,E)$.

By the assumed minimality of $E$, the conclusion of the lemma holds for the
fan $(V,E')$.  Add primes
for quantities associated to the fan $(V,E')$.  The two faces
$F_x$ and $F_z$ merge into a single face $F$ of $\op{hyp}(V,E)$.
Then 
\begin{equation}\label{eqn:U}
U= U_{F_x}\cup U_{F_z}\cup C^0(\e)
\end{equation} 
is a connected open set in $Y$.
If $F'\ne F_x,F_z$ is any other face in $\op{hyp}'$, then $U_{F'}$ is
a connected open set in $Y$.  Moreover, the set $U$ and sets $U_{F'}$
are disjoint and exhaust $Y$, so that the are precisely the topological
components of $Y$.  Some dart of $F$ leads into $U$, so $U=U_F$.  It follows
that the number of faces is equal to the number of topological components, so that the map $F\mapsto U_F$ is a bijection.

\begin{lemma} The area formula holds.
\end{lemma}

\begin{proof} Every topological component of $Y$ 
except $U$ is already a topological component of $Y'$ and the conclusion
holds for components of $Y'$.  The component $U$ is a disjoint union of two
components of $Y'$ and a set $C^0(\e)$ of measure zero.  Thus, it
is also measurable and eventually radial.  The solid angle formula is
additive over the disjoint union, so the formula holds for $U$.
\end{proof}

\begin{lemma}  For any dart $x$ on the face $F$, and dart $y\in F$ that is not adjacent to $x$ under the face map, 
$$
C^0(\{v(x),v(y)\} \subset U_F.
$$
\end{lemma}

\begin{proof}
By the minimality of $E$, it is enough to consider the merged face $F$.  
If $y=f^2x$, then the diagonal is precisely $C^0(\{v,w\})$,
which has already been established.  Otherwise, $y$ can be identified with
a dart of the face $F_z$ in the hypermap $\op{hyp}'$.  The conclusion holds
already for $U_{F_z}\subset U$.  
\end{proof}

%Next we show the extra conclusion added at the beginning of the lemma.
%If the added diagonal is $\{v,w\}$, then $E''=E'$ and we have already
%checked that $N(V,E')+1=N(V,E)$.  Since $x$ was arbitrary, we may assume
%that $v(x)\in e$.  Let $E''' = E \cup \{e\, \{v,w\}\}$.  By the minimality,
%$N(V,E''') + 1 = N(V,E')$.  Also, $E''' = E''\cup \{\{v,w\}\}$.  The
%same argument that shows $N(V,E')+1=N(V,E)$ shows $N(V,E''')+1 = N(V,E'')$.
%Hence,
%$$
%N(V,E'')+1 = N(V,E''')+2 = N(V,E')+1 = N(V,E).
%$$

\begin{lemma} The given intersection of open half-spaces is equal
to the topological component. 
\end{lemma}

\begin{proof}
By the minimality of $E$, it is enough to consider
the merged face $F$ and its topological component $U=U_F$.
We first show that the intersection $U'$ of half-spaces lies in $U$.
Every point in this intersection lies in the plane
$$
\op{aff}(\{\orgn,v,w\})
$$
or in one of the two open half-planes bounded by this plane.  The intersection
of this plane with $U'$ is the blade $C^0(\{v,w\})$, which belongs
to $U$. The intersection of the two half-spaces, by the minimality of $E$,
belong to $U_{F_x}$ and $U_{F_y}$, which are subsets of $U$.  Thus, $U'\subset U$.

To prove the reverse inclusion, let $y$  be a dart of
the face $F$.  we show that $U$ is a subset of the half-space with bounding
plane $\{\orgn,v(y),v(f y)\}$.  We may assume that the edge $\{x,z\}$ of the
hypermap $\op{hyp}'$ satisfies $v(x) = v(y)$, as $x$ can be chosen at an
arbitrary node.  By the minimality of $E$,  
the partition (\ref{eqn:U}) of $U$ gives three pieces
contained respectively in the three parts:
$$
W(x) \cup C^0(\{v,w\}) \cup W(x'),
$$
where $x,x'\in D'$ correspond to the single dart $y\in D$:
$$
\op{azim}(x) + \op{azim}(x') = \op{azim}(y) < \pi.
$$
Thus, $U$ itself is contained in the lune
$$
\op{wedge}(\{\orgn,v(y)\},\{v(f y),v(f^{-1} y)\}),
$$
which is contained in the desired half-space.
\end{proof}

\section{Polygon}


\subsection{perimeter}


\begin{lemma}\guid{WSEWPCH}\tlabel{lemma:convex-hyper}\rating{400}
Let $(V,E)$ be a fan.  
Let $U=U_F$ be a topological component of $Y(V,E)$, associated
with face $F$.
Assume
that every dart of $F$ has $\op{azim}(x)<\pi$. 
Then the unit-sphere perimeter of the face is at most $2\pi$.
\end{lemma}

\begin{proof}  A fan does not have any faces of cardinality less than three.
Every blade of the fan has radian measure less than $\pi$.  

Consider the case of a spherical triangle.  If the edges of the
the triangle are $a_i$ and the angles of the polar
triangle are $\alpha'_i$, then $\alpha'_i+a_i=\pi$.
The the perimeter is 
$$a_1+a_2+a_3 = 2\pi - (\alpha'_1 -\alpha'_2 - \alpha'_3-\pi) < 2\pi,$$
because the area of the polar triangle is always strictly positive.

Similarly, if the sides of the faces of the spherical polygon are
$a_i$, then the angles of the polar polygon are $\alpha'_i = \pi-a_i$.
The perimeter is
$$
a_1+\cdots+a_n  = 2pi- A< 2\pi,
$$
where $A = 2\pi-\sum a_i$ is the area of the polar polygon.
%~\cite[p.261]{williamson:2008}.
\end{proof}

\begin{note}%XX
Futher details about polar polygons are to be added, including a definition and a justification of the area formula for the polar.
\end{note}


\subsection{area}

\begin{note}%XX
This subsection will be expanded with a lemma on the properties of  deformations of polygons needed for estimates of $\tau$.
\end{note}


\section{Polyhedron}

This section shows that a convex polyhedron determines a fan.

\begin{definition}
A polyhedron the intersection of finitely many closed half-spaces.
An interior point $p$ of a polyhedron is a point that contains a neighborhood
entirely contained in the polyhedron. An isolating half-space of
a polyhedron is a closed half-space containing the polyhedron.  A face of a polyhedron
is the intersection of the polyhedron with the bounding plane of an isolating-half space.   The dimension of a face is defined as the dimension of the affine hull of the face.  A vertex is a face of dimension $0$.  An edge is a face of dimension $1$.
\end{definition}

\begin{lemma}\guid{JLIGZGS}\rating{800}\label{lemma:polyhedron}  
Let $P$ be a polyhedron with an interior point $\orgn$.
Let $V$ be the set of vertices of $P$.  Let $E$ be the set of pairs $\{v,w\}$
of vertices such that $\op{conv}\{v,w\}$ is an edge of $P$.
\begin{itemize}
\item $(V,E)$ is a fan.
\item Every dart $x$ of the associated hypermap satisfies $\op{azim}(x)<\pi$.
\end{itemize}
\end{lemma}


\begin{note}%XX
We also need the fact that the circular disks of Lemma~\ref{lemma:13-14} lie in different topological components $Y(V,E)$.  More precisely, no disk meets $X$; and no two disks lie in the same topological component.
\end{note}


