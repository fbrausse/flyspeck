%% HYPERMAPS



\section{Basic Concepts}



\begin{definition}  A hypermap is a finite set $D$, together with
three functions $e,n,f:D\to D$ that satisfy the identity
    $$e\circ n\circ f = I.$$
The elements of $D$ are called {\it darts}.  The functions $e,n,f$
are called the {\it edge maps}, the {\it node map}, and the {\it
face map}, respectively.
\end{definition}



\begin{remark} We represent hypermaps graphically as follows.  A
dart is drawn as a small black dart.
\end{remark}

\begin{figure}[htb]
  \centering
  \myincludegraphics{\ps/dart.eps}
  \caption{A dart}
  \label{fig:dart}
\end{figure}

\begin{remark}\label{rem:hypermap} A hypermap is an abstraction of
the combinatorial properties of planar graphs.  The following
example shows how the abstraction was made.  Let $G$ be a planar
graph.  Place a dart at each angle.    Let $f$ be the function that
cycles counterclockwise through the angles of each face.  Let $n$ be
the function that moves counterclockwise through the angles at each
node.  Finally, let $e$ be the function that pairs each angle with
the angle at the opposite end of the opposite side of each edge.  A
hypermap is the abstraction that forgets everything about the planar
graph except for the data $(D,e,n,f)$.
\end{remark}

\begin{figure}[htb]
  \centering
  \myincludegraphics{\ps/hypermap_ex.eps}
  \caption{Darts mark each angle of a planar graph. A hypermap comes by
  permuting darts around faces, nodes, and edges.}
  \label{fig:hypermap_ex}
\end{figure}

By symmetry, a hypermap also satisfies $n\circ f\circ e = f\circ
e\circ n = I$.  The symmetry between $n$ and $f$ is an abstraction
of the duality between nodes and faces in a planar graph. Because of
the symmetry in the definition, there will be three versions of many
of the theorems, all obtained from one proof by symmetry.

Each of the functions $e,n,f$ is invertible.  We write $\#h$ for the
number of orbits of a function $h$ on $D$, and $\#\tangle{e,n,f}$
for the number of orbits of the combined action of functions $e,n,f$
on $D$.  We say that the hypermap is connected if $\#\tangle{e,n,f}
= 1$.

\begin{definition}  A node of a hypermap is an orbit of darts under
$n$.  A face of a hypermap is an  orbit of darts under $f$.  An edge
of a hypermap is an orbit of darts under $e$.
\end{definition}

\begin{definition} A hypermap is {\it plain} (note the spelling!) if
$e$ is an involution on $D$ (that is, $e\circ e = I$).  A hypermap
is {\it planar} (note the spelling!) if
    $$\# n + \# e + \# f = \# D + 2 \#\tangle{e,n,f}.$$
\end{definition}

\begin{definition} A dart in a hypermap is degenerate if it is a
fixed point of one of the maps $e,n,f$.  It is nondegenerate
otherwise.
\end{definition}


% Moved from cup05_tame.tex section on tame plane graphs. 9/5/07:
\begin{lemma}\label{lemma:nondegen} 
Let $(D,e,n,f)$ be a plane hypermap such that every face has
cardinality at least $3$ and no face meets a node in more than one
dart.  Then no dart is a fixed point under $n$.
\end{lemma}

\begin{proof}  Let $x$ be a fixed point under
$n$. We claim that $e x$ and $f x$ lie on the same node and the same
face, so are equal by Lemma~XX.  They are on the same node because
$n(f x) = e^{-1} x = e x$. They are on the same face because
    $$f^2 (e x) =  f(n^{-1} x) = f x.$$
So $e x = f x$.   Thus, $f^2 (e x) = f x = e x$, so $e x$ lies on a
face of cardinality at most two.  This contradicts an assumption.
\end{proof}


\begin{remark}  A connected $2$-connected
planar graph $G$ is known to satisfy the Euler relation
    $$ V - E + F = 2$$
where $V$ is the number of vertices, $E$ is the number of edges, and
$F$ is the number of faces on $G$ (including the unbounded face). If
we create a hypermap $(D,e,n,f)$ from $G$ along the lines of
Remark~\ref{rem:hypermap}, then the function $e$ is an involution,
so the hypermap is plain. Moreover,
    $$\begin{array}{lll}
    V &= \# n\\
    E &= \# e\\
    F &= \# f\\
    2E &= \# D\\
    1 &= \#\tangle{e,n,f}\\
    \# n + \#e + \# f &= V + E + F = 2 E + 2 = \# D + 2 \#\tangle{e,n,f}.
    \end{array}
    $$
Thus, the hypermap is also planar.  The identity defining a planar
hypermap should be viewed as a transcription of the Euler relation
in terms of hypermaps, and the definition of planarity is simply
that the Euler relation is satisfied.
\end{remark}

\begin{lemma}  Let $H$ be a plain planar hypermap that is connected.
Let $f_i$ be the number of faces with $i$ darts.  Then
    $$2 \# n - 2 =  f_3 + 2 f_4 + 3 f_5 +\cdots$$
\end{lemma}

\begin{proof}  We have
    $$
    \begin{array}{lll}
     \# D &= 2 \# e = 3 f_3 + 4 f_4 + \cdots\\
    \# f &= f_3 + f_4 + \cdots.
    \end{array}
    $$
Use these equations to eliminate $\#e$, $\#f$, $\#D$ from the Euler
relation.  The result follows.
\end{proof}



\subsection{Walkup transformations}

When we focus our attention on a particular dart $x$ in a
hypermap, it is sometimes useful to represent the six darts $e x$,
$n x$, $f x$, $e^{-1} x$, $n^{-1} x$, $f^{-1} x$ as a hexagon
around the center $x$ as in Figure~\ref{fig:dart+}.  These $7$
darts are not necessarily distinct.   When $x$ is fixed under one
of the transformations $e$, $n$, or $f$, then the figure takes one
of the degenerate forms of Figure~\ref{fig:dart-fix}.

\begin{figure}[htb]
  \centering
  \myincludegraphics{noimage.eps}
  \caption{A dart $x$ and its entourage}
  \label{fig:dart+}
\end{figure}

\begin{figure}[htb]
  \centering
  \myincludegraphics{noimage.eps}
  \caption{A dart fixed under a face map.}
  \label{fig:dart-fix}
\end{figure}

Walkup transformations are certain transformations that modify a
hypermap by deleting one of its darts.  The result of a walkup
transformation is a new hypermap with one fewer dart.  Walkup
transformations come in three flavors: edge walkups, face walkups,
and node walkups.

\begin{definition}
Let $x$ be a dart in a hypermap.  The edge walkup transformation
$W_e$ at $x$ of the the hypermap is the hypermap
$(D\setminus\{x\},e',n',f')$ obtained by deleting the dart $x$ and
modifying the permutations $f,n$ to skip past $x$ as follows:
    $$
    \begin{array}{lll}
    f' y &= \text{ if } (y = f^{-1} x) \text{ then } f x \text{ else
    } f y\\
    n' y &= \text{ if } (y = n^{-1} x) \text{ then } n x \text{ else
    } n y\\
    e' = (n'\circ f')^{-1}
    \end{array}
    $$
\end{definition}

The effect of the edge walkup transformation on the hexagon at $x$
is shown in Figure~\ref{fig:walk}.  The face walkup $W_f$ and node walkup
$W_n$ transformations are defined by symmetry.  The effect of these
transformations on the hexagon at $x$ is shown in Figure~\ref{fig:walkfn}.

We say that a walkup transformation is degenerate if the dart $x$ it
uses is degenerate.   If $x$ is a degenerate dart, all three walkup
transformations at $x$ become equal: $W=W_e=W_n=W_f$. This
degenerate walkup transformation is shown in Figure~\ref{fig:walkdeg}.

\begin{figure}[htb]
  \centering
  \myincludegraphics{noimage.eps}
  \caption{The effect of an edge walkup at $x$}
  \label{fig:walk}
\end{figure}

\begin{figure}[htb]
  \centering
  \myincludegraphics{noimage.eps}
  \caption{The effect of face and node walkups at $x$}
  \label{fig:walkfn}
\end{figure}

\begin{figure}[htb]
  \centering
  \myincludegraphics{noimage.eps}
  \caption{The effect of a walkup at a degenerate dart}
  \label{fig:walkdeg}
\end{figure}


\begin{definition}\label{def:merge-split} Let $h=n,e$, or $f$.
A walkup transformation $W_h$ at $x$ is a merge,
if the orbit of $h$ through $x$ is combined with another orbit by
the walkup transformation.  It is a split transformation, if the
orbit at $x$ is split into two orbits by the walkup transformation.
\end{definition}

\begin{lemma}\label{lemma:merge-split} 
Every nondegenerate walkup transformation is a merge or a split.
The walkup $W_h$ at $x$ is a merge if and only if $x$ and $y$  lie
in distinct $h$-orbits, where $(h,y)=(f,e x)$.  
(The same result holds with $(h,y)$
replaced by $(e,n x)$ or other situations obtained by
$e,n,f$-symmetry.)
\end{lemma}

\begin{proof} The walkup $W_f$ splits if and only if $f x$ (or equivalently $x$)
and $e x$ are in the same $f$-orbit before the split. This is clear
from Figures~\ref{fig:split}.
\end{proof}


\begin{figure}[htb]
  \centering
  \myincludegraphics{noimage.eps}
  \caption{The face walkup at $x$ mixes $f$-orbits as shown.  If the mixing
   occurs between two separate $f$-orbits, the orbits are merged.  If the
   mixing occurs along a single $f$-orbit, the orbit is split.}
  \label{fig:split}
\end{figure}


\subsection{walkups and planarity}

\begin{definition} Define the planar index of a hypermap to be
$$\# f + \# e + \# n - \# D - 2\# \tangle{e,n,f}.$$
(Thus, a planar hypermap is a hypermap whose planar index is $0$.)
\end{definition}

\begin{lemma}\label{lemma:index} Let $x$ be a dart of a hypermap $(D,e,n,f)$ (not necessarily
planar). Let $(D',e',n',f')$ be the result of the edge walkup $W_e$ at
a nondegenerate dart $x$.  
The effect on the various constants in the planar index is as
follows.
    $$
    \begin{array}{lll}
    \text{\bf Non-degenerate dart $x$: }&\\
    \# f &= \# f'\\  
    \# e + \epsilon_e &= \# e'\\
    \# n &= \# n'\\
    \# D - 1&= \# D' \\
    \# \tangle{e,n,f} + \epsilon_0&= \#\tangle{e',n',f'}\\
    \end{array}
    $$
The constants $\epsilon_e$ and $\epsilon_0$ are given as follows.
We have 
   $$
   \epsilon_e = \begin{cases}
     1 & W_e \text{ split }\\
    -1 & W_e \text{ merge}\\
   \end{cases}
   $$
and
   $$
   \epsilon_0 = \begin{cases}
    0 & W_e \text{ merge }\\
    0 & W_e \text{ split and } x,nx \text{ same } \tangle{e,n,f}\text{-orbit}\\
    1 & otherwise.
     \end{cases}
   $$
Moreover, at a degenerate dart, the planar index is preserved under a
walkup transformation.
\end{lemma}

\begin{proof} This is evident from the Figures.
\end{proof}

\begin{lemma}  Let $\iota$ be the index of a  hypermap $(D,e,n,f)$, and
let $\iota'$ be the index of the hypermap obtained by a walkup transformation
$W_h$
at a dart $x$.
planar).   If $x$ is degenerate, then $\iota=\iota'$.
If $W_h$ is a merge, then $\iota=\iota'$.
If $x$ is non-degenerate and and the walkup is
split, the planar index is preserved iff the walkup splits the orbit of
$\tangle{e,n,f}$ through $x$ into two orbits. When the walkup transformation
does not preserve the planar index, $\iota+2=\iota'$.
\end{lemma}

\begin{proof}  By symmetry, we can restrict our attention to 
edge walkups $W_e$.  The result follows from  Lemma~\ref{lemma:index} together
with the observation that if the $\tangle{e,n,f}$-orbit splits then
the $e$-orbit also splits.
\end{proof}


\begin{lemma}  The planar index
of a hypermap is never positive.
\end{lemma}

\begin{proof}  An edge walkup never decreases the index.  By a sequence
of edge walkups we eventually reach the empty hypermap, which has
index zero.
\end{proof}


\begin{lemma} Walkup transformations take planar hypermaps to planar
hypermaps.
\end{lemma}

\begin{proof}  
A planar hypermap has maximum index.  The walkup
transformation can only increase the index, but can never increase
it above its maximum.  Thus, the index remains at its maximum value.
\end{proof}


\subsection{Double Walkup Transformations}

Double walkup transformations are the composite of one walkup
transformation followed by another of the same type.  For a double
walkup transformation, we need to choose two darts.  We will always
choose both darts to be the two members of an orbit of cardinality
two (under $n$, $e$, or $f$).  The first walkup transformation will be
chosen so that it is a merge transformation.  The second walkup will
be chosen to be a degenerate walkup transformation.

If we chose the type of the walkups to be different from the type of
the orbit of cardinality two, then the second walkup will
automatically be degenerate.  (The first walkup reduces the
cardinality of the orbit to $1$, which means that it is a
fixed-point.)

We point out a few interesting cases of this construction. In each
case, we assume the target darts of the walkup form orbits of
cardinality $2$.
\begin{itemize}
    \item A double $W_n$ applied to an edge has the effect on
    the hypermap of deleting the edge and merging the two nodes into
    one (Figure~\ref{fig:doublenode}). 
    \item A double $W_f$ applied to an edge has the effect of
    deleting the edge and merging the two faces along the node into
    one (Figure~\ref{fig:doubleface}).
    \item A double $W_e$ applied to a node has the effect of
    deleting the node and merging the two edges along the node into
    one (Figure~\ref{fig:doubleedge}).
\end{itemize}


\begin{figure}[htb]
  \centering
  \myincludegraphics{noimage.eps}
  \caption{The double node walkup applied to an edge}
  \label{fig:doublenode}
\end{figure}


\begin{figure}[htb]
  \centering
  \myincludegraphics{noimage.eps}
  \caption{The double face walkup applied to an edge}
  \label{fig:doubleface}
\end{figure}


\begin{figure}[htb]
  \centering
  \myincludegraphics{noimage.eps}
  \caption{The double edge walkup applied to a node}
  \label{fig:doubleedge}
\end{figure}


\begin{lemma}  The three preceding double walkups transform plain
hypermaps into plain hypermaps.
\end{lemma}

\begin{proof} The transformations $W_n$ and $W_f$ preserve the orbit
structure of edges, except for dropping one dart.  By dropping both
darts from the same edge, one edge is lost and all others edges
remain unchanged.

For the double $W_e$, we refer to Figure~\ref{fig:doubleedge}.  If the
original hypermap is plain, then the two darts marked $A$ are equal, as are
the two darts marked $B$.  The new edge map $e''$ swaps $A$ and $B$ and is 
otherwise equal to the restriction of $e$ to the set of darts $D''\subset D$
of the new hypermap.  The result follows.
\end{proof}

The following is a useful criterion for detecting merge
transformations.

\begin{lemma}  Suppose that each face of a hypermap intersects each node in at
most one dart.  Suppose that the edge $\{x,y\}$ through $x$ has
cardinality two, with both darts nondegenerate.  Then the walkup
transformation $W_f$ (resp. $W_n$) at $x$ is a merge.
\end{lemma}

\begin{proof} 



We have $n (f x) = e^{-1} x = e x$. So $f x$ and $e x$ are at the
same node. By the first hypothesis in the lemma, we have $f x = e x
= y$. Then $$n y  = n f x = n f e y = y,$$ so $y$ is a fixed
point of $n$, hence degenerate, contrary to assumption.  Thus, $f x$
and $e x$ are in different faces, and the walkup is a merge.
It is a merge if and only if $f x$ and $e x$ are in
distinct faces (by Lemma~\ref{lemma:merge-split}).  
\end{proof}




\subsection{Contours}

\begin{definition}  A dart path is a function $p:\{0,\ldots,k\}\to D$
for some $k$.  A contour path is a dart path such that $p_{i+1} =
n^{-1} p_i$ or $f p_i$ for each $i<k$.  (That is, the only allowed
steps in the path are clockwise steps around the darts in a node and
counterclockwise steps around the darts in a face.)  A dart loop is
a path $p:\{0,\ldots,k\}$ that is injective on $\{0,\ldots,k-1\}$
and such that $p_0 = p_k$.  A contour loop is a dart loop that is
also a contour path.
\end{definition}

\begin{lemma}\label{lemma:connect-contour}  If $x$ and $y$ are darts
in the same $\tangle{e,n,f}$-orbit of a hypermap, then there exists
a contour path from $x$ to $y$.
\end{lemma}

\begin{proof} 
The darts
$x$ and $y$ are joined by a sequence where the step at every stage
is $z\mapsto h z$, for $h=e,n$, or $f$.  Using the relation $e\circ
n\circ f = I$, we eliminate the $e$-steps. Using the fact that $n$
has finite order, we replace $z \mapsto n z$ by a sequence
of $n^{-1}$ steps.  This gives the desired path.
\end{proof}

\begin{definition} A M\"obius contour is an
injective contour path $p$ that satisfies
    \begin{equation}
    \label{eqn:mobius}
    p_j = n p_0\quad p_k = n p_i
    \end{equation}
for some $0 < i\le j< k$ (Figure~\ref{fig:mobius}.
\end{definition}

\begin{figure}[htb]
  \centering
  \myincludegraphics{noimage.eps}
  \caption{A M\"obius contour}
  \label{fig:mobius}
\end{figure}

\begin{figure}[htb]
  \centering
  \myincludegraphics{noimage.eps}
  \caption{A M\"obius contour with three darts}
  \label{fig:3m}
\end{figure}


\begin{remark}
 G. Gonthier was led to
this definition while abstracting the Jordan curve property: a
simple closed curve in the plane separates the plane into an
interior and an exterior.  Although this definition takes some getting used to,
it is possible to reason about a hypermap without any M\"obius contours in
much the same way as we are accustomed to reason with the Jordan curve theorem
in the plane.
The term {\it M\"obius} comes by way of
analogy with the M\"obius strip, which has the property that the
simple closed curve through the center of the strip fails to
separate the strip into two halves.
\end{remark}



\begin{lemma}\label{lemma:no-mobius}  
Planar hypermaps have no M\"obius contours.
\end{lemma}

\begin{proof} Assume for a contradiction that there exist planar
hypermaps with M\"obius contours.  Among all counterexamples,
consider one that has the fewest darts.  The edge walkup transforms
planar hypermaps into planar hypermaps.  If we apply an edge walkup
transformation on a dart that is not on the M\"obius contour, the
M\"obius contour carries over to a M\"obius contour 
in the transformed hypermap.  By the
minimality of our counterexample, we may assume that it contains no
darts except those on the M\"obius contour.

In the M\"obius Condition~\ref{eqn:mobius}, if $1<i$, $i<j$, or
$j+1<k$, we may apply an edge walkup transformation to  delete a
dart along the contour that is not at index position $0$, $i$,
$j$, $k$.  The resulting contour is again M\"obius.
By minimality of our counterexample, we may now assume
that $i=1$, $j=i$, and $k=2$.

This is a three darted hypermap (Figure~\ref{fig:3m}.)  
The M\"obius condition, the
definition of contours, together with $e\circ n\circ f=I$ force
$e=n=f$, all permutations of order three. We reach the contradiction
that this hypermap is not planar:
    $$3 = \# e + \# n + \# f,\quad 5 = 3+2 = \# D + 2 \#\tangle{e,n,f}.$$
\end{proof}

%\begin{lemma}  Suppose that a hypermap has no M\"obius contours.
%Let $L$ be a contour loop.  Let $P$ be any injective contour path
%that starts and ends on $L$, but visits no other darts of $L$ in
%between.  Then the first and last steps of $P$ are both of the same
%type $n^{-1}$ or $f$.
%\end{lemma}
%
%\begin{proof}  Suppose $P$ is $n x,f n x,\ldots,n y,y$.   Form
%contour path starting at $x$, then $n^{-1}$ steps to $L$, then
%follow $L$ to $y$, and on to $n x$.  Follow $P$ back to $n y$.  This
%is a M\"obius contour.
%
%Suppose $P$ is $n x,x,\ldots,f^{-1} y,y$.  Form a contour path
%starting at $x$, then along $P$ to $y$, along $L$ to $n x$, and
%continuing on $L$ to $n y$.  This is a M\"obius contour.
%\end{proof}
%
%\begin{definition}  Let $L$ be a contour loop on a hypermap.  We say that a dart
%lies in the interior (resp. exterior) of the loop $L$, if there is a
%path $P$ as in the previous lemma starting and ending with $f$ steps
%(resp. $n^{-1}$ steps).
%\end{definition}
%
%\begin{lemma}  Let $L$ be a contour loop on a plain hypermap without
%M\"obius contours.  Assume a dart $x$ lies in the interior (resp.
%exterior) of the loop $L$. Then every dart in its $f$-orbit lies in
%the interior (resp. exterior) of the loop.  Moreover, if the dart
%$x$ does not lie on the same node as any dart in $L$, then every
%dart in the $n$-orbit of $x$ lies in the interior (resp. exterior)
%of $L$.
%\end{lemma}
%
%\begin{proof} First consider the $f$-orbit.
%For a contradiction, we may assume that $x$ is in the interior but
%not $f^{-1} x$.  If we have a contour path $P = \ldots,n  x,
%x,\ldots$, we can modify it by stepping around the node of $f^{-1}
%x$:
%  $$P' = \ldots,n  x,f n  x = n^{-1}f^{-1} x,n^{-2}
%f^{-1} x,\ldots,f^{-1} x,f x,\ldots.
%    $$
%This works when the new darts added to the path are not already on
%$P$ and not on $L$.  If one of the new darts is on $L$, a subpath of
%$P'$ starts and ends on $L$ in different types of steps, which is
%prohibited by Lemma X.  If a new dart is on $P$, we just eliminate
%a segment of $P'$ if the new dart appears on the initial segment of
%$P$.  If it appears on the final segment of $P$, there is a M\"obius
%loop on $P$, which is contrary to hypothesis.  [X finish.]
%
%
%For the $n$-orbit, assume that $x$ but not $n^{-1} x$ is in the path
%$P$.  We take a path $P = \ldots,x,f x,\ldots$ and modify it by
%stepping around the face of $n^{-1} x$
%    $$
%    P' = \ldots,x,n^{-1}x,f n^{-1}x,f^2 n^{-1}x\ldots,f^{-1} n^{-1}
%    x = n f x, f x,\ldots
%    $$
%[Can you get everything by symmetry? X] [X finish]
%\end{proof}
%
%\begin{definition}  A face or a node is interior (resp. exterior) to a
%loop in a hypermap if all of its darts are interior (resp.
%exterior).
%\end{definition}
%
%\begin{lemma} Suppose that in a nonempty hypermap without M\"obius contours,
%there is a face that coincides with an $\tangle{e,n,f}$-orbit of
%darts.  Then that face contains a dart that is fixed under $n$.
%\end{lemma}
%
%\begin{proof}  If the face contains a single dart, then it is
%obviously fixed by $n$.  Assume that the face contains at least two
%darts.  For a contradiction, assume that none of the darts is fixed
%by $n$.  Thus, every node contains at least two darts.
%
%We will use the face path $z,f z,f^2 z,\ldots$ to construct a
%M\"obius contour. Since the set of darts is finite, the face path
%must eventually revisit a node already encountered.  Thus, we can
%find a subpath $z',f z',\ldots,f^{k+1} z'$ such that the first $k$
%darts lie on distinct nodes, but $f^{k+1} z'$ and $z'$ lie in the
%same node $A$.
%
%If we had $f^{k+1} z' = z'$, then we have the full $f$-orbit in this
%subpath, and hence also the full $\tangle{e,n,f}$-orbit.  We have
%$k>0$, so $f z'$ is then a dart that has no other darts in its node,
%and is hence a fixed-point.  Hence $f^{k+1} z'\ne z'$.
%
%Continue the path further, so that $f^{r+1} z'$ is at the same node
%as some $f^p z'$ (with $p < r$), at a different node than
%$z',\ldots,f^r z'$, but so that the only repeated node among
%$z',\ldots,f^r z'$ is the one at $z'$.  We have $0 < p$.
%
%If $f^{r+1} z' = f^p z'$, then $f^{r+1-p} z' = z'$ so all darts are
%in the segment $z',f z',\ldots,f^{r-p} z'$ and the only node with
%more than one dart is the one at $z'$.  Thus, we have a fixed point.
%So $f^{r+1} z'\ne f^p z'$.
%
%Let $0 < k_1 < k_2 < \cdots < k_m < r+1$ be the indices at which
%$f^{k_i} z'$ is at $A$.  Let $x = n^{-1} f^{k_m} z'$. If the segment
%$x,n^{-1} x,\ldots,z'$ contains some $f^{k_i} z'$, we obtain a
%M\"obius contour.  [X DETAIL.]  Take $n^{-1}$ steps from $x$ to
%$z'$. Then take $f$-steps to $y = f^p z'$, on to $n x = f^{k_m} z'$,
%on to $f^{r+1} z'$, then $n^{-1}$ steps to $n y$.  This is a
%M\"obius contour.
%\end{proof}
%
%\begin{lemma}[Jordan curve theorem for hypermaps]  If a plain hypermap
%has no M\"obius contours then it is planar.
%\end{lemma}
%
%\begin{proof}  Face double walkups along edges preserve the planar
%index.  By repeated application, we reduce to the case where every
%connected component of $\tangle{e,n,f}$ contains a single face. In
%other words, $f$ acts transitively on the darts in a given connected
%component.
%
%If there are any darts that are fixed by all three maps $e,n,f$,
%then the walkup at that dart eliminates the dart while preserving
%the planar index.  Thus, we may assume there are no such darts.
%
%If there are any darts that are fixed points under $n$, then the
%dart is degenerate.  The double walkup (of any type) along the edge
%that meets that dart eliminates the dart while preserving the planar
%index.  Thus, we may assume that there are no such darts.
%
%By the previous lemma, the plane hypermap must be empty.  Thus, our
%planar-index preserving transformations have transformed an
%arbitrary plane hypermap without M\"obius contours into the empty
%hypermap, which is clearly planar.  The result follows.
%\end{proof}
%




\section{Quotient Hypermaps}


\begin{definition} Two hypermaps $(D,e,n,f)$ and $(D',e',n',f')$ are
isomorphic, if there is a bijection $F:D\to D'$ such that
    $$h'\circ F = F\circ h$$
for $(h,h')=(e,e'), (f,f'), (n,n')$.
\end{definition}


\begin{definition}
Let $H$ be a hypermap and let $\cal L$ be a collection of contour
loops.  We say that $\cal L$ is a normal collection if the following
conditions hold. \begin{itemize}
 \item No dart is visited by two different loops in $\cal
L$.
 \item There are no darts fixed by $e$ (so that we can distinguish $f x$
from $n^{-1} x$ at each dart).
 \item Every loop in the
collection visits darts in at least two nodes.
 \item If a loop in the
 collection visits a dart at a node, then every dart at that node is
 visited by some loop in the collection.
\end{itemize}
\end{definition}

From a normal collection we can create a new hypermap.   A dart in the
new set $D'$ of darts
$D$ is a maximal sequences $[x,n^{-1} x, n^{-2} x,\ldots,n^{-k} x]$
    of $n^{-1}$ steps appearing in some loop in $\cal L$.
The map $f'$ takes the maximal sequence
    $[x,n^{-1}x,\ldots,y]$ to the maximal
   sequence (in the same contour loop) starting 
    $[f y,\ldots]$.
The map $n^{-1}$ takes the maximal sequence
    $[\ldots,y]$ to the maximal sequence (in some other contour loop)
starting $[n^{-1}y,\ldots]$. Equivalently, $n$ takes the maximal sequence
$[x,\ldots]$ to the maximal sequence ending $[\ldots,n x]$. The map $e$ is
defined by $e\circ n\circ f = I$.  

\begin{definition}  The hypermap constructed from the normal collection
is called the quotient of $H$ by $\cal L$, and is denoted $H/{\cal
L}$.  $H$ is said to be a cover of $H/{\cal L}$.
\end{definition}

Intuitively, we can represent the quotient hypermap as a graph whose
cycles under $f$ 
are precisely the contour loops in the normal family (Figure~\ref{fig:quot}).

%% No sketch has been made for this.
\begin{figure}[htb]
  \centering
  \myincludegraphics{noimage.eps}
  \caption{Intuitively, 
   the contour loops in a normal family become orbits of $f$ in the
   quotient}
  \label{fig:quot}
\end{figure}


\begin{example}\label{ex:Hall} 
Assume that $H$ is a hypermap with no fixed points under $e$.
Assume that every face visits at least two nodes.
Then the set of all faces
defines a normal collection of contour loops (follow $f$ around each face:
$x,f x,\ldots$).  Each dart of the quotient is then just a singleton
set consisting of a single dart of $H$, and the quotient is
isomorphic to $H$ itself.
\end{example}

\begin{example}\label{ex:H2} 
Assume that $H$ is a hypermap with no fixed points
under $e$.  Let $F = (x,f x,\ldots)$ be a face that visits at least two nodes.  
Let $\cal L$ be the
collection with two contour loops:  $(x,f x,\ldots)$ and its
``complement''
$$[n^{-1} x,
n^{-2} x,\ldots,n x,f n x = y,n^{-1} y, n^{-2} y,\ldots, n y, f n
y,\ldots]
$$
(See Figure~\ref{fig:contour-comp}.) 
The family $\cal L$ is normal.
The quotient hypermap $H/{\cal L}$ has two faces $F$ and a
backside $F'$ of the same cardinality.
\end{example}


\begin{figure}[htb]
  \centering
  \myincludegraphics{noimage.eps}
  \caption{The complementary contour loop traces the remaining darts
   at the same nodes as the origonal contour loop.}
  \label{fig:contour-comp}
\end{figure}


\begin{example}\label{ex:H2k} 
In the previous example, the quotient hypermap can
be described directly.  Let $2k$ be the number of darts.  We have a
hypermap $H_{2k}$, whose darts are arranged in two faces
    $$\{\pm x,\pm f x,\ldots, \pm f^{k-1} x\},$$
(one positive face, one negative face) whose node map is
    $$\pm y \mapsto \mp y,$$
and whose edge map is given by $e\circ n\circ f = I$.
\end{example}

\begin{lemma} Let $H$ be a plain hypermap, and let $\cal L$ be a
normal family.  Then $H/{\cal L}$ is a plain hypermap.
\end{lemma}

\begin{proof} Let $e'$, $f'$, and $n'$ be the edge, face, and node maps on the
quotient hypermap.  Write $[\ldots, x]$ for the node in the quotient
ending in dart $x\in H$ and $[x,\ldots]$ for the node in the quotient
starting with dart $x\in H$.  We have $e^2 x = x$, so that for any
dart $\ldots x$ in the quotient:
    $$\begin{array}{lll}
    {e'}^{-2} [\ldots, x] &= n' f' n' f' [\ldots, x] = n f n [f x, \ldots] \\&=
    n f [\ldots, n f x] = n [f n f, \ldots] = [\ldots, n f n f x]\\ &=
    [\ldots, e^{-2} x] = [\ldots, x].
    \end{array}$$
Thus, ${e'}^{-1}$ and $e'$ have order $2$ on the quotient.
\end{proof}

%\begin{lemma} Let $H$ be a plain planar hypermap, and let $\cal L$
%be a normal family.  Then $H/{\cal L}$ is a plain planar hypermap.
%\end{lemma}
%
%\begin{proof} Suppose $H/{\cal L}$ is not planar.
%Let $P$ be a M\"obius contour on $H/{\cal L}$.  It lifts uniquely to
%a contour on $H$ with the property that the darts visited on $H$ are
%precisely the darts that belong to a dart in the quotient.  This is
%compatible with the node map $n$.  So the contour path lifts to a
%M\"obius contour on $H$.  Thus, $H$ is not planar.
%\end{proof}


\subsection{Flags}

\begin{definition}  If we have a function from the set of faces of a hypermap
to the set $\op{bool}=\{\op{true},\op{false}\}$, we say that a face is true or
false, according to the value of the function.  A flag on a hypermap
is a function from its set of faces to the set
$\op{bool}$ that satisfies the following two
constraints.
\begin{itemize}
    \item If darts $x,y$ belong to true faces,
    then there is a contour path from $x$ to $y$ consisting of darts
    in true faces.
    \item Every edge of a false face is shared with a true face.
    \end{itemize}
An isomorphism of hypermaps with flags is an isomorphism of
hypermaps that respects the flags.
\end{definition}

\begin{example} Let $H/{\cal L}$ be a quotient hypermap with
normal family $\cal L$.  We define
a natural $\phi$ from faces of the quotient to $\op{bool}$ by setting
the value of a face $F$ to be $\op{true}$ exactly when every dart in
the face is a singleton of $H$.
\end{example}

\begin{example} The natural boolean map on the faces of the
quotient of Example~\ref{ex:H2} is a flag.  If we identify this
quotient with the hypermap $H_{2k}$ of Example~\ref{ex:H2k}, 
then it is natural to define a flag
on $H_{2k}$ with one true face and one false face.
\end{example}

\begin{example} Let 
$H$ be a connected plain hypermap and $e$ has no fixed points,
and let $\cal L$ be the example of Example~\ref{ex:Hall}, 
then the natural
map takes value $\op{true}$ on every face.  This is in fact a flag.
To say that $H$ is connected is to say $\#\tangle{e,n,f}=1$. 
By Lemma~\ref{lemma:connect-contour}, there is a contour path between
any two darts $x$ to $y$ in $H$.  This gives the desired path.
\end{example}

\begin{lemma}\label{lemma:all-dart}  
Let $H$ be a hypermap with normal family ${\cal L}$.
If the natural boolean function on the set of faces of
$H/{\cal L}$ has at least as many
true values as there are faces of $H$, then $\cal L$ is the normal family
in Example~\ref{ex:Hall}. In particular, $H/{\cal L}$ is isomorphic to $H$.
\end{lemma}

\begin{proof}  If a face takes value $\op{true}$ 
in $H/{\cal L}$, then its darts are
singletons, and the face of $H/{\cal L}$ is naturally identified with
 a face in $H$.  This is an injective map from the 
set of true faces of $H/{\cal L}$ to
the set of faces of $H$.  The hypothesis of the lemma implies that this
injective map is bijective.
All of the darts of $H$ are accounted for under this bijection.
Thus, the quotient has no
false faces.  The result follows.
\end{proof}


\subsection{Face insertion}


In this section, we describe an inductive construction of all
connected, plain, planar hypermaps that satisfy certain constraints.

We define a set ${\cal H}$ of tuples $(H,\phi,\{x,e x\},N,\lambda)$.
The tuples are assumed to satisfy the following conditions:
\begin{itemize}
    \item $H$ is a hypermap.
    \item $\phi$ is a flag on $H$.
    \item $\{x,e x\}$ is an edge of cardinality two, such that one
    of its darts lies on a true face and the other on a false face.
    \item $N$ is the cardinality of the false face meeting $\{x,e
    x\}$.
    \item $\lambda$ is a finite increasing sequence of natural numbers:
        $$
        \lambda = (\lambda_1,\lambda_2,\ldots,\lambda_r)
        $$
    such that $\lambda_1 = 1$ and $\lambda_r \le N-1$.
\end{itemize}

We define a function from $\cal H$ to the set of hypermaps with
flags.  We call it face insertion, because the function creates a
hypermap with one more true face than its source hypermap $H$.

In the ordered pair $\{x,e x\}$, we write $x_0$ for the dart in the
false face and $e x_0$ for the dart in the true face.  Write $f^i
x_0 = x_i$ for the darts in the false face.  (Set $x_N = x_0$.)

\subsection{transforming partitions}

We describe an algorithm $\lambda\mapsto A(\lambda)$ that takes
as input a partition $\lambda$ (and the number $N$)
and produces as output a list of
tuples.
In the first step of the algorithm,
replace each $\lambda_j$ except for the
first occurrence of a given natural number by a dummy symbol $*$.
Insert $N$ at the end of the list. For example, if $N=7$,
    $$(1,1,1,2,3,3,3,5,5)$$ becomes
    $$(1,*,*,2,3,*,*,5,*,7).$$

Next, break the sequence at each natural number (except at the initial $1$
and terminal $N$)
creating shorter sequences, duplicating the number at the break,
so that each sequence begins and ends with a natural number,
and is padded inbetween with dummy symbols. So
    $$(1,*,*,2,3,*,*,5,*,7)$$ becomes
$$(1,*,*,2),\ (2,3),\ (3,*,*,5),\ (5,*,7).$$

Next,
delete any ordered pair of the form $(j,j+1)$. In our example, there
is one such ordered pair: $(2,3)$.  Our example becomes
  $$
  (1,*,*,2),\  (3,*,*,5),\ (5,*,7).
  $$
This list of tuples is the output from the algorithm.
In our example,
  $$A(1,1,1,2,3,3,3,5,5) = ((1,*,*,2),(3,*,*,5),(5,*,7)).$$



\subsection{new hypermaps}

This output $A(\lambda)$
becomes an instruction for how to draw new edges to create a
new hypermap. A fragment $(j,*,*,\ldots,*,k)$ with $r$ dummy symbols
is an instruction to insert an edge between darts $x_j$ and $x_k$
and then to insert $r$ new nodes along this edge.
Expressed in terms of double walkups, we first apply (in
reverse) the double walkup $W_f$, and then apply $r$ times (in
reverse) the double walkup $W_n$.  Each fragment creates $r$ new
nodes, one new face, and $r+1$ new edges.  The net result, as this process is
iterated over all the tuples in $A(\lambda)$, is a new hypermap. 
This hypermap is the result of what we call face-insertion
on $(H,\phi,\{x,e x\},\lambda)$.

For example, Figure~\ref{fig:7darts} shows the effect of the fragments
$$(1,*,*,2),\ (3,*,*,5),\ (5,*,7).
  $$ on a face with seven darts.


\begin{figure}[htb]
  \centering
  \myincludegraphics{noimage.eps}
  \caption{The process of face-insertion on a $7$-gon for
   $A(\lambda) = ((1,*,*,2),(3,*,*,5),(5,*,7))$.}
  \label{fig:7darts}
\end{figure}

The reverse walkup transformations insert darts.  The darts $x_0$ and
$y_0$ are naturally identified with darts $x_0'$ and $y_0'$ in $H'=(D',e',n',f')$.
The double node walkup transformation preserves the edges (except for
the one that entirely disappears in the process).  The same is true of the
double face walkup transformation.  Thus, $\{x_0',y_0'\}$ is an edge of
$H'$ (of cardinality two).

We mark the face containing the dart $x'_0$ as true, and the other
faces created by the construction as false.   All other faces are
marked true or false as in the flag on the originating hypermap $H$.  By
construction, the new hypermap contains exactly one more true face
than the originating hypermap.

\begin{lemma}\label{lemma:flag} 
The boolean function on faces constructed in this way is a
flag.
\end{lemma}

\begin{proof}  We show first that every edge of a false face is shared
with a true face.  If the false face is one of the newly created
faces, its edges are those along the new true face or the old false
face. Either way they are shared with a true face.   If it is a
false face from the originating hypermap, it shares edges with the
same true faces as before.

Next, we show that every pair of darts $x,y$ in true faces can be
joined by a contour path.  Let $H'=(D',e',n',f')$ and let
$x_0' = e'^{-1} y_0$ be as above.  If neither of the darts is in the
$f'$-orbit of $x'_0$, we can use the contour path that was used in the
originating hypermap.  If both are in the $f'$-orbit of $x'_0$, then
we can join $x$ to $y$ by a sequence of $f'$-steps.

If $x$ is in the $f'$-orbit of $x'_0$, but not $y$, we first join $x$
to $x'_0$ by $f'$-steps, then to $n'^{-1} x_0 = f' e' x'_0 = f' y_0$, 
which is in
the $f'$-orbit of $y_0$, which is a true face by construction.
From $n'^{-1} x'_0$, we can move to $y$.
Similarly, if $y$ is in the $f'$-orbit of $x'_0$ but not $x$; we first
take a contour path from $x$ to $e' x'_0$ then to $n'^{-1} e' x_0 = f'
x_0$ then to $y$.
\end{proof}

\subsection{Inductive Hypermaps}

We claim that we can generate all sufficiently nice hypermaps by a
sequence of face-insertions.  The precise claim is as follows.

\begin{lemma}  Let $H$ be a hypermap with the following properties:
    \begin{enumerate}
        \item It is plain, planar, and connected.
        \item The edge map $e$ has no fixed points.
        \item The node map $n$ has no fixed points.
        \item Every orbit of $f$ has cardinality at least $3$.
        \item There are at least $2$ faces. 
        %%  (All hypoth. Needed?)
        \item Every face meets every node in at most one
        dart.
    \end{enumerate}
Let $\cal L$ be a normal family of contour paths in $H$. Assume that
the natural boolean function $\phi$ on $H/{\cal L}$ is a flag. Let
$\{x,e' x\}$ be an edge of $H/{\cal L}$ that meets both a true face
and a false face. Let $N$ be the cardinality of that false face. Let
$M$ be a constant such that every face of $H$ has cardinality at
most $M$. Then there is exists a partition $\lambda=(\lambda_1,\ldots,\lambda_r)$ with at most
$M$ parts satisfying $$1=\lambda_1\le \cdots\lambda_r \le N-1$$
and a normal family
${\cal L}'$ such that $H/{\cal L}'$ with its natural boolean
function is isomorphic to the image of the face insertion map on
$(H/{\cal L},\phi,\{x,e' x\},N,\lambda)\in {\cal H}$. 
Moreover, $H/{\cal L}'$
has one more true face than $H/{\cal L}$ has.
\end{lemma}

\begin{remark} The lemma implies that sufficiently nice hypermaps can be recovered
from their quotients by face insertions.  (Here {\it `nice'} means
that it satisfies the conditions of the lemma.)   
We can start with a standard quotient such 
as $H_{2k}=H/{\cal L}_0$
from Examples~\ref{ex:H2} and~\ref{ex:H2k} 
that every nice hypermap is known to have. Then we
generate all face insertions (as we vary over relevant partitions).
Among the generated hypermaps is some $H/{\cal L}_1$, which
has one more $\op{true}$ face than $H/{\cal L}_0$.  By 
Lemma~\ref{lemma:flag}, 
the natural boolean function on this new quotient
is a flag.  Repeating the process, we get a sequence
$H_{2k} = H/{\cal L}_0, H/{\cal L}_1,\ldots, H/{\cal L}_k$,
each obtained from the previous one by face-insertion.
By Lemma~\ref{lemma:all-dart}, 
as
soon as a quotient $H/{\cal L}_k$ 
has sufficiently many true faces, it is
isomorphic to the the original hypermap $H$, and the process
terminates.
Note that we get to choose the edge at which we apply the face
insertion, but we cannot choose the partition.  We must run through
all partitions.  To make the entire process finite, we can bound the
number of partitions that must be considered, say by placing a
priori bounds $M$ on the cardinalities of the faces of $H$.
\end{remark}

\begin{proof}
Write $f,e,n$ for the maps on $H$ and $f',e',n'$ for the maps on the
quotient hypermap.   The construction picks out an edge of $H/{\cal
L}$ that borders a true face and a false face. Let the edge be given
by $\{y,e' y\}$, where $y$ lies on the true face and is hence a
singleton set. It can be identified with a dart $y$ in $H$.  Let
$y_0 = e y$, and let $y_k = {f}^k y_0$ be the darts of $H$ on the
face of $y_0$ (Figure~\ref{fig:algordart}).  
Let $r$ be the cardinality of the face. 
Let $*$ be an
object distinct from the darts of $H/{\cal L}$.  We have a map
$\psi$ from $\{y_i\}$ to the union of $\{*\}$ with the darts of
$H/{\cal L}$ sending $y_i$ to $\{*\}$ if $y_i$ is not visited by any
of the loops in ${\cal L}$, and to the dart of $H/{\cal L}$
containing $y_i$ otherwise.
Since every face of $H$ meets every node of $H$
in at most one dart, no two darts
$y_k$ map to the same dart in $H/{\cal L}$.


\begin{figure}[htb]
  \centering
  \myincludegraphics{noimage.eps}
  \caption{An example of the algorithm}
  \label{fig:algordart}
\end{figure}


Let $x_0 = e' y$ and let $x_k = {f'}^k x_0$.  Let $r'$ be the
cardinality of the $f'$-orbit through $x_0$.  
We claim that (1) $\psi(y_i)$ is either $*$ or one of the
nodes $x_k$.  This claim will be proved below.
For those that give darts $x_k$, write $\psi(y_i) =
x_{\psi' i}$, for some $0\le i < r'$. We claim further that (2) if
$i<j\le n$, and both $\psi(y_i)$ and $\psi(y_j)$ are darts, then
$\psi' i < \psi' j$.  We justify this claim below.

Accepting these two claims, we complete the proof.  Set $\psi' i =
*$, if $\psi(y_i)$ is not a dart.  We form a sequence
    $$(\psi' 1,\psi' 2,\ldots,\psi' r).$$
In this sequence, replace each $*$ in the
subsequence $(j,*,*,\ldots,*)$ by $j$. Thus,
    $$(1,*,*,2,*,4,*,*,5)$$
becomes
    $$(1,1,1,2,2,4,4,4,5).$$
This gives the partition $\lambda$ used in the construction.

Applying the face-insertion for $\lambda$ to the hypermap $H/{\cal
L}$ corresponds to constructing some $H/{\cal L}'$.  We describe
${\cal L}'$.  It is the collection of contour loops of $H$ obtained from
the collection ${\cal L}$ after deleting the loop $L$ that 
corresponds to the $f'$-orbit of $x_0$, 
and adding the loop corresponding to the $f$-orbit
of $y_0$ as well as the loops corresponding to the false faces on
the new hypermap.
More specifically, we show that each false face of $H'$
corresponds to some contour loop in $H$. These are the
contour loops that are added to ${\cal L}\setminus\{L\}$ to obtain
${\cal L'}$.  There is a contour loop for each sequence
$j,*,\ldots,j'$ with $j< j'$ and one for each sequence $j,j'$ with
$j+1< j'$.  A contour loop in $H$ is determined by the darts it
visits.  

We describe the darts.
Write $(j,j') = (\psi'i,\psi' i')$.
Take the case $j,j'$, with $j+1<j'$. 
It can be shown that $j+1 < j'$ implies that both $n^{-1}
y_i$ and $n y_{i'}$ are in $x_j$ and $x_{j'}$ respectively.
In this case we take the subset
of $x_j$ in the consecutive sequence starting $n^{-1} y_i$, and the
subset of all darts in $x_{j'}$ in the consecutive sequence starting $n y_{i'}$.
We also
have it visit all the darts of $x_k$ for $j<k<j'$.

In the case $(j,*,\ldots,j')$ we form consecutive sequences of darts
starting at $n^{-1} y_i$ and $n y_{i'}$ as in the previous case, and
all the darts of $x_k$ for $j<k<j'$, 
Each $y_k$, for $i < k < i'$ belongs to a node $N_k$ in $H$.
We also have the loop visit the darts in $N_k\setminus\{y_k\}$.
This construction gives a normal family of loops that has all the
required properties.

{\bf Claim 1}:
The proof is now complete except for two earlier claims.  We claim
that $\psi(y_i)$ is either $*$ or one of the darts $x_k$.  Suppose
to the contrary that the dart $z$ of $H/{\cal L}$ containing
$y_i$ is not equal to any $x_k$.
Set $n x = y_1$.  Define $y$ to be such
that $\{y,\ldots,y_0\} = x_0$. Start at $x$ follow $L$ all the away
around the loop to $n x$, passing through $y$ on the way.  Then from
$y_1$ take $f$ steps to $z$, step around that node to a true face,
along true faces to $n y$.  This is a M\"obius contour in 
$H$.  This contradicts Lemma~\ref{lemma:no-mobius}.

{\bf Claim 2}:
We claim further that if $i<j\le n$, and both $\psi(y_i)$ and
$\psi(y_j)$ are darts, then $\psi' i < \psi' j$.  Assume to the
contrary that $\psi' j \le \psi' i$.  Then we take a contour loop
$L'$ from $y_1$ along the darts $y_j$ until reaching $x_{\psi' i}$,
then continuing for the rest of the path of $L$ back to $y_1$.
Giving the identical argument as in the preceding paragraph, but
using $L'$ instead of $L$, we again get a M\"obius contour $H$.  
Again, we contradict Lemma~\ref{lemma:no-mobius}.
\end{proof}


%% \section{All about Polygons}

\section{Patching}\label{sec:patch}


Let $H=(D,e,n,f)$ be a hypermap.  We write
$\op{face}(\alpha)$, $\op{edge}(\alpha)$, and $\op{node}(\alpha)$
for the face, edge, and node containing the dart $\alpha\in D$.
We write $H/f$, $H/e$, and $H/n$ for the set of faces,
edges, and darts.
%
%\begin{definition}  A {\it hypermap} $H=(D,e,n,f)$ is a finite set $D$
%together with three permutations $e,n,f:D\to D$ satisfying the
%identity $e\circ n\circ f = I$.  The elements of $D$ are called
%{\it darts}.  The permutations $e,n,f$ are called the {\it edge},
%{\it node}, and {\it face} permutations, respectively.
%\end{definition}
%
%\begin{definition}  A {\it face} of a hypermap $H=(D,e,n,f)$ is an orbit of $D$
%under $f$.  We write $\op{face}(\alpha)$ for the face of
%$\alpha\in D$.  We write $H/f$ for the set of faces.
%\end{definition}
%
%\begin{definition}  An {\it edge} of a hypermap $H=(D,e,n,f)$ is an orbit of $D$
%under $e$.  We write $\op{edge}(\alpha)$ for the edge of
%$\alpha\in D$.  We write $H/e$ for the set of edges.
%\end{definition}
%
%\begin{definition}  A {\it node} of a hypermap $H=(D,e,n,f)$ is an orbit of $D$
%under $n$.  We write $\op{node}(\alpha)$ for the node of
%$\alpha\in D$.  We write $H/n$ for the set of nodes.
%\end{definition}
%

\begin{definition} 
%A hypermap is {\it plain} (note the spelling!)
%if $e\circ e=I$.  
A hypermap is {\it simple} if for every two darts
$\alpha,\beta\in D$, we have
    $$\card{(\op{face}(\alpha) \cap \op{node}(\beta))} \le 1.$$
\end{definition}

%\begin{definition} A hypermap is {\it planar} (note the spelling!)
%if Euler's relation holds:
%    $$
%    \card{H/e} + \card{H/n} + \card{H/f} = \card(D) + \card{H/\langle
%    n,e,f\rangle},
%    $$
%where $H/\langle n,e,f\rangle$ is the number of orbits of $H$
%under the combined action of $n,e,f$.
%\end{definition}
%

Let $A$ and $B$ be simple hypermaps with face and node
permutations
    $f_A,f_B$, and $n_A,n_B$, respectively; and darts $D_A$ and
    $D_B$.  Assume that the darts of $A$ and the darts of $B$ are
    disjoint sets.

Let $\phi:F_A\to F_B$ be a bijection between a face of $A$ and a
face of $B$ such that
    $$
    \phi(f_A \alpha) = f_B^{-1}\phi(\alpha),\quad \forall
    \alpha\in F_A.
    $$

\begin{definition} Let $\op{patch}(A,B,\phi)$ be the following hypermap
$(D,f,n,e)$:
    $$D = D_A \cup D_B \setminus (F_A\cup F_B)$$
    $$f\alpha = f_A\alpha \text{if } \alpha\in D_A, \ f_B\alpha
    \text{otherwise}.
    $$
    $$n\alpha = \begin{cases}
    n_A\alpha &
        \text{if } \alpha\in D_A \wedge n_A\alpha\not\in F_A\\
    n_B[\phi(n_A\alpha)] &
        \text{if } \alpha\in D_A \wedge n_A\alpha\in F_A\\
    n_B\alpha &
        \text{if } \alpha\in D_B \wedge n_B\alpha\not\in F_B\\
    n_A[\phi^{-1}(n_B \alpha)] &
        \text{if } \alpha\in D_B \wedge n_B\alpha\in F_B\\
    \end{cases}
    $$
Let $e$ be defined by the relation $e\circ n\circ f = 1$.
\end{definition}

To justify this construction, the following lemma shows that the
maps $\phi,\phi^{-1}$ are applied only to darts in their domains.

\begin{lemma} With context as above (simple hypermaps, etc.),
if $\alpha\in F_B$ then $n_B\alpha\not\in F_B$.  If $\alpha\in
F_A$, then $n_A\alpha\not\in F_A$.
\end{lemma}

\begin{proof} Elementary.
\end{proof}

\begin{lemma} If $n_A$ and $n_B$ have no fixed points, then
    the node map on $\op{patch}(A,B,\phi)$ does not either.
\end{lemma}

\begin{proof}
\end{proof}

\begin{lemma} If $A$ and $B$ are simple, then
$\op{patch}(A,B,\phi)$ is simple.
\end{lemma}

\begin{lemma} If $A$ and $B$ are plain, then
$\op{patch}(A,B,\phi)$ is plain.
\end{lemma}

\begin{lemma} If $A$ and $B$ are planar and plain, then
    $\op{patch}(A,B,\phi)$ is planar.
\end{lemma}


%%%%%%%%%%%%%%%%%


\chapter{Hypermap and Geometry}

In this section we show how a hypermap can be attached to certain
graphs whose nodes are vectors in $\ring{R}^3$. This hypermap will
encode the combinatorial properties of the vectors.

%\begin{definition}  Let $v\in\ring{R}^3$ and $W \subset
%\ring{R}^3$.  We say that $\sigma:W\to W$ is an azimuth cycle on $W$
%coming from $v$, if there is a orthonormal $2$-frame $P=(0,e_1,e_2)$
%with $e_1 \times e_2 = v/|v|$, and a cycle is $\sigma:W\to W$ with
%respect to $P$. (By REF%%, an azimuth cycle is unique, but may not
%exist.)
%\end{definition}

%[ change the following definition, so that edges are triples
%$(v,w,u)$, where $u$ is a unit vector orthogonal to $v$ and $w$.
%Assume that if $(v,w,u)\in E$ then $(w,v,-u)\in E$.  We then ask for
%an azimuth cycle on the vectors $u\times v$ rather than on the
%vectors $w$.  The third element $u$ allows for the case that the $v$
%and $w$ are antipodal, or the long end of a great circle, which is
%convenient for some of the proofs. In standard situations, we can
%just take $u$ to be the unit length vector in the direction $v\times
%w$.  This change ripples through the text.  For instance, the proof
%that  $\#c = \#f$ for linear graphs reduces all the way down to the
%case of a single plane.]

If $e=\{v_1,v_2\}$ is a set of two points and $v_0$ is any other point,
set
  $$
  \begin{array}{lll}
  C(v_0,e) &= \op{aff}_+(v_0,\{v_1,v_2\})\\
  C^0(v_0,e) &= \op{aff}^0_+(v_0,\{v_1,v_2\})\\
  \end{array}
  $$
We drop the $v_0$ from the notation, when it is clear from context,
and write $C(e), C^0(e)$.
% Note that the base point is always variable $v_0$.


\begin{definition}  Let $(v_0,V,E)$ be a triple consisting of a point,
a set of
vectors, and a subset of the powerset of $V$.  The pair is said to be
a pre-planar graph if the following conditions hold.
    \begin{itemize}
    \item $V$ is finite and nonempty.
    \item $v_0\not\in V$.
    \item Each element of $E$ has two elements.
    \item For each $v\in V$, the set
        $$
        E_v = \{w\in V\mid \{v,w\}\in E\}
        $$
        is cyclic with respect to $(v_0,v)$.
    \item For sets $e,e'\in E$,   we have
        $$C^0(v_0,e) \cap C^0(v_0,e')\ne\emptyset\ \Rightarrow e = e'.$$
    \end{itemize}
\end{definition}

We make a series of remarks about this definition.

\begin{remark}\tlabel{rem:pre-planar}
\begin{itemize}
\item The pair $(V,E)$ is a graph with nodes $V$ and edges $E$.  The set
$E_v$ is the set of edges around a fixed node $v$.
Note that $w\in E_v$ if and only if $v\in E_w$.   
%
\item The final condition states that the sets $C^0(v_0,e)$
do not meet.   It
is this condition that will eventually give us a construction of planar
hypermaps.
%
\item
By the condition that $E_v$ should be cyclic,
for each $v\in V$, we have an azimuth cycle $\sigma(v):E_v\to E_v$.
We specifically allow the situation where $E_v = \{w\}$ is a
singleton set. In this case,
$\sigma(v)$ is the identity map on $E_v$.
%
\item
We generally write $\sigma(v,w)$ for $\sigma(v)(w)\in E_v$.
%
\item 
The hypothesis of the existence of an azimuth cycle
prevents $\{v_0,v,v'\}$ from being a collinear set, when $\{v,v'\}\in
E$.
%
\end{itemize}
\end{remark}



\section{Topology of pre-planar graphs}

Let $(v_0,V,E)$ be pre-planar.  We define sets of darts $D_1,D_2,D$:
    $$
    \begin{array}{lll}
    D_1 &= \{(v_0,v,w,w')\mid v\in V,\ w\in E_v,\ w' = \sigma(v,w)\}\\
    D_2 &= \{(v_0,v) \mid v\in V,\ \ E_v = \emptyset\},
    D   &= D_1\cup D_2.
    \end{array}
    $$
We call $D_1$ the reduced set of darts and $D$ the extended set of darts.

We define a permutation $n$ on $D_1$ by
    $$n(v_0,v,w,w') = (v_0,v,w',\sigma(v,w')).$$
We define a permutation $f$ on $D_1$ by
    $$
    f (v_0,v,w,w') = (v_0,w,\sigma(w)^{-1} v,v).
    $$
Define a permutation $e$ on $D_1$ by
    $$
    e (v_0,v,w,w') = (v_0,w,v,\sigma(w,v)).
    $$
Define permutations $e,n,f$ on $D_2$ by making them degenerate on $D_2$:
    $$
    e (v_0,v) = n(v_0,v) = f(v_0,v) = (v_0,v).
    $$
Write $\op{hyp}_r(v_0,V,E)=(D_1,e,n,f)$ and
Write $\op{hyp}(v_0,V,E)=(D,e,n,f)$.  We call them the reduced hypermap
and the (extended) hypermap associated with $(v_0,V,E)$.  The next
lemma justifies this terminology.


\begin{lemma} Let $(v_0,V,E)$ be pre-planar.  Let $D = D_1\cup D_2$
and $\op{hyp}(v_0,V,E) = (D,e,n,f)$, as constructed above.  Then
    \begin{itemize}
    \item $\op{hyp}(v_0,V,E)$ is a plain hypermap.
    \item The edge map $e$ has no fixed
points in $D_2$.
    \item The face map $f$ has no fixed points on $D_2$.
    \item For every pair of distinct nodes, there is at most one
    edge meeting both.
    \item Each dart of an edge lies on a different node.
    \end{itemize}
\end{lemma}

\begin{lemma}  We compute
    $$e(n(f(v_0,v,w,w'))) = e(n(v_0,w,\sigma(w)^{-1} v,v))) =
        e(v_0,w,v,\sigma(w, v)) = (v_0,v,w,\sigma(w, v)) = (v_0,v,w,w').$$
So it is a hypermap. We compute
    $$e(e(v_0,v,w,w')) = e(v_0,w,v,\sigma(w,v)) = (v_0,v,w,w').$$
So it is plain. A fixed point in $D_2$ under $e$ would force $v = w\in E_v$,
but by construction $v\not\in E_v$.  The argument that $f$ has no
fixed points is similar.

    Next we show that for every pair of distinct nodes, there is at
most one edge meeting both.  That is,
        $$(n^k e x = e n^\ell x)\Rightarrow n^\ell x = x.$$
Let $x = (v_0,v,w,w')\in D_1$.  Let $\sigma=\sigma(v)$. Then
    $$
    \begin{array}{lll}
    n^\ell x &= (v_0,v,\sigma^\ell w,\sigma^{\ell+1}w)\\
    e n^\ell x &= (v_0,\sigma^\ell w,*,*)\\
    e x &= (v_0,w,*,*)\\
    n^k e x &= (v_0,w,*,*)\\
    n^k e x &= e n^\ell x \Rightarrow w = \sigma^\ell w \Rightarrow
    n^\ell x &= (v_0,v,w,\sigma w) = x
    \end{array}
    $$

Finally, we show that each dart of an edge lies on a different node.
That is, $e x \ne n^k x$, for $x\in D_1$.  We have
    $$
    \begin{array}{lll}
        e(v_0,v,w,w') &= (v_0,w,*,*),\quad w\in E_v\\
        n^k(v_0,v,w,w') &= (v_0,v,*,*),\quad v\not\in E_v.
    \end{array}
    $$
The result follows.
\end{lemma}

\subsection{Basic Topology}

There is hardly any topology that comes up in this book.  Most of
what is needed appears in this chapter.  We make use of some basic
notions in topology such as continuity, connectedness, and compactness.

\begin{remark} The term {\it connected} is now being used in
two different senses: in the topological sense and in a combinatorial
sense for hypermaps.
\end{remark}

\begin{definition}\label{def:XY}
Let $(v_0,V,E)$ be a pre-planar.  Let $X=X(v_0,V,E)$ be the union of the
cones
   $$C(v_0,e)$$
as $e$ ranges over $E$.  Let $Y=Y(v_0,V,E)$ be the complement
$Y = \ring{R}^3\setminus X$.
\index{X}\index{Y}.
\end{definition}


Let $$S^2(v_0) = \{ v \mid | v-v_0 | = 1\}$$ be the unit sphere in
$\ring{R}^3$, centered at $v_0$.  

The set $\ring{R}^3$ is a metric space under the
Euclidean distance function $d(v,w) = |v-w|$.  Subsets of
$\ring{R}^3$ are a metric space under the restriction of the metric
$d$ to the subset. Subsets carry the metric space topology.  We
investigate the connected components of $Y$,
for a given closed set $X$.    If two
points in $\ring{R}^3$ 
can be joined by a continuous path that avoids $X$,
then they lie in the same connected component of $Y$.
If we produce a family of nonempty connected open sets in
$Y$, whose union is all of $Y$, then the
members of the family are the connected components of $\ring{R}^3\setminus
X$.






If $e=\{v,v'\}\in E$, then $v_0,v,v'$ are not collinear
(Remark~\ref{rem:pre-planar}), so that $C(v_0,e)$
does not lie in a line, and does not contain any
distinct points $u,u'\in
C(v_0,e)\setminus\{v_0\}$ 
with $\op{aff}\{u,u',v_0\}$ collinear. 
In particular, $C(v_0,e)$ does not contain a line through $v_0$.



\subsection{Components and Darts}

Let $(v_0,V,E)$ be pre-planar and let $(D,e,n,f) = \op{hyp}(v_0,V,E)$
be the associated hypermap.  Write $D = D_1\cup D_2$ as a union of
reduced darts $D_1$ and non-reduced darts $D_2$.

Each dart $x=(v_0,v,w,w')\in D_1$ defines
a wedge $W(x) = W(v_0,v,w,w')$ and an azimuth angle $\op{azim}(x) =
\op{azim}(v_0,v,w,w')$.   If $x=(v_0,v)\in D_2$, then we set
$W(x) = \ring{R}^3\setminus \op{aff}\{v_0,v\}$ and $\op{azim}(x) = 2\pi$.

We can further restrict the wedge by putting conditions on the zenith angle.
If $x = (v_0,v,w,w')\in D_1$ or $x = (v_0,v)\in D_2$, set
    $$
    W(x,\phi) = W(x) \cap \op{rcone}^0(v_0,v,\cos\phi).
    $$

\begin{lemma}\tlabel{lemma:disjoint}  
Let $(D,e,n,f)$ be the hypermap attached to a 
pre-planar graph $(v_0,V,E)$.
Let $N$ be a node of $D$.  There exists $v\in V$
such that the darts of $N$ are precisely
the darts of the form $(v_0,v,\ldots)$.  Furthermore, there is a 
disjoint sum decomposition of $\ring{R}^3$ given by
  $$
  \ring{R}^3 = 
  \op{aff}\{v_0,v\} \cup
  \bigcup_{x\in N} W(x)  \cup 
  \bigcup_{\{v,w\}\in E} \op{aff}_+^0(\{v_0,v\},w).
  $$
\end{lemma}

\begin{corollary}\tlabel{cor:W}  
Let $x = (v_0,v,\ldots)$ be a node.
We have $W(x)\cap C(v_0,e)=\emptyset$, for $e\in E_v$.
\end{corollary}

\begin{proof} The decomposition of Lemma~\ref{lemma:disjoint} is
disjoint.  It follows directly from the definitions that
   $$C(v_0,e)\subset \op{aff}_+^0(\{v_0,v\},w).$$
\end{proof}

\begin{lemma} For each $x$, and $\phi$ sufficiently small and positive,
$W(x,\phi)$ is nonempty and lies in a single connected
component of $Y$.
\end{lemma}

\begin{proof}  First we show that $W(x,\phi)$ lies in $Y$,
for $\phi$ small.  Let $x=(v_0,v,w,w')\in D_1$.  
Let $S^2(v_0)$ be the unit sphere centered at $v_0$.
By making $\phi$ small enough,
the sets $W(x,\phi)\cap S^2(v_0)$
avoid the compact sets $C(v_0,e)\cap S^2(v_0)$ when $v\not\in e$.
Thus, $W(x,\phi)$ also avoids $C(v_0,e)$ when $v\not\in e$.
By Corollary~\ref{cor:W}, $W(x,\phi)$ avoids $C(v_0,e)$, when $v\in e$.
Thus, $W(x,\phi)\in Y$, for $\phi$ small.

To complete the proof, it is enough to show that each $W(x,\phi)$ is
connected.  
The  set
   $$
   R=\{(r,\theta,\phi) \in (0,\infty) \times (\theta,\theta') \times (0,\phi)\}
   $$
is connected.
The set $W(x,\phi)$  is the image of $R$
under a spherical coordinate representation (Definition~\ref{def:sph}).
It is readily verified that the polar coordinate representation is
a continuous map. As the image of a connected set under a continuous map
is connected, we conclude that $W(x,\phi)$ is connected.
\end{proof}

\begin{definition} For each dart, there is then a well-defined connected
component of $\ring{R^3}\setminus X$ that contains $W(x,\phi)$ (for all
sufficiently small $\phi$). We say that the dart {\it leads into}
that component.
\end{definition}

\begin{lemma}
For each connected component of 
$Y$, there exists a
dart $x$ that leads into that component.
\end{lemma}

\begin{proof} This follows from the claim
of the following lemma (Lemma~\ref{dart-curve}), 
which constructs
a continuous curve from any point in 
$Y$ to a wedge
$W(x,\phi)$.
\end{proof}

\begin{lemma}\label{lemma:dart-curve}
Let $(v_0,V,E)$ be a pre-planar graph.  Assume that $E\ne\emptyset$.
Let $X=X(v_0,V,E)$.
Let $v\in Y$.  
Then there exists a nondegenerate dart 
$x=(v_0,v_1,w_1,w_2)$ of $\op{hyp}(v_0,V,E)$ with the
following properties:
\begin{itemize}
\item Let $F$ be the orthonormal frame with respect to 
  $(v_0,v_1,w_1)$ and let $P(F,r,\theta,\phi)$ be the spherical
  coordinate representation with respect to this frame
  (Definition~\ref{def:sph}).
\item We have
   $$v = P(F,r_v,\theta_v,\phi_v).$$
\item 
   For all $0 < \phi \le \phi_v$, we have
   $P(F,r_v,\theta_v,\phi)$ does not meet any $C(v_0,e)$, 
   for $e\in E$.
\item For all $\phi>0$ sufficiently small,
   $P(F,r_v,\theta_v,\phi)\in W(x)$.
\end{itemize}
\end{lemma}

\begin{proof} 
If $v$ lies in some $W(x,\phi)$, the conclusion follows
directly from the definition of $W(x,\phi)$.  We may
assume that $v$ does not lie in any of the sets $W(x,\phi)$.

Now assume that no  dart $x$ satisfying the conditions
of the lemma exists.  
Consider the circle
   $$S^1 = \{u\mid |u-v_0|=1,\quad
     (u-v_0)\cdot (v-v_0) = 0\}.$$
The set $S^1$ is a metric space in the induced metric
from $\ring{R}^3$ and a connected topological space in the
metric space topology.
Let $A\subset S^1$ be defined as
  $$
  A = \{u \in S^1 \mid  \op{aff}\{v_0,v,u\} \cap X(v_0,V,E)\ne\emptyset\}.
  $$

We claim that $A$ is not empty.  Let $u'\in X(v_0,V,E)$ be any
element such that $u'\not\in \op{aff}\{v_0,v\}$.  Then
$\op{aff}\{v_0,v,u'\} = \op{aff}\{v_0,v,u\}$ for some $u\in S^1$.
This element $u$ belongs to $A$.

The set $X(v_0,V,E)$ is closed, and this implies that $A\subset S^1$
is closed.  

We define a function $f:A\to E$ as follows.  Take $u\in A$.
Write
$u'\in\op{aff}(v_0,v,u)$ in polar coordinates
$(r,\theta)$ with respect to $(v_0,v,u)$ (Definition~\ref{def:polar}).
Let $\theta$ be the smallest polar coordinate such
that the point $u'$ with polar coordinates $(r,\theta)$ lies
in $X(v_0,V,E)$.  (By a compactness argument
on $X(v_0,V,E)\cap S^2(v_0)$, $\theta$ exists.)  By the
assumption that the desired dart $x$ does not exist, we
find that $u'$ lies in a unique $C(v_0,e)$.  Define $f(u)=e$.

In fact, the element $u'$  lies in $C^0(v_0,e)$.  Under small
perturbations of $u\in S^1$, the corresponding $u'$ also
lies in $C^0(v_0,e)$.  Thus, the preimage $f^{-1}(e)$ is an
open set of $S^1$, for each $e\in E$.  The sets $S^1\setminus A$,
and $f^{-1}(e)$ give a finite cover of $S^1$ by disjoint open
sets.  By the connectedness of $S^1$, we have $f^{-1}(e)=S^1$
for some $e\in E$.

However, by Lemma~\ref{tarski:miss-plane}, there is a 
plane $\op{aff}\{v_0,v,u\}$ that does not meet $C(v_0,e)$.
This contradiction gives the desired conclusion.
\end{proof}

%XX Why not replace this with a result that takes any
%plane that meets $X()$.  It isn't necessary to close in on
%a corner.  The only use of generalized polar coords was this.

\subsection{Components and Faces}

Let $(v_0,V,E)$ be a pre-planar graph.  Let $X=X(v_0,V,E)$ as above. For
every dart $x=(v_0,v,w,w')$, we define a region $U(x,\epsilon,\phi)$ along
$C(v_0,e)$, with $e = \{v,w\}$ as follows. 
We assume that $\phi$ is sufficiently small that $W(x,\phi)$
and $W(f x,\phi)$ each lie in a single connected component and
that $W(x,\phi)\cap W(f x,\phi) =\emptyset$.
Let 
  $$C(v_0,e,\psi) =
    \{ c\in C(v_0,e,\psi) \mid c\not\in \op{rcone}(v_0,v,\psi)
    \cup\op{rcone}^0(v_0,w,\psi)\}.
  $$
Let 
  $$n = (v-v_0)\times (w-v_0)$$
and let
  $$
  U(x,\epsilon,\phi) = \{ c + \mu n |c-v_0| \in \ring{R}^3 \mid
     c\in C(v_0,e,\phi/2)\quad
     0 < \mu < \epsilon\quad 
     \}
  $$

\begin{lemma}  Let $(v_0,V,E)$ be a pre-planar graph.
Let $x=(v_0,v,w,w')$ be a dart in the associated hypermap.
For $\epsilon,\phi > 0$, the set $U(x,\epsilon,\phi)$ is
open and connected.
\end{lemma}

\begin{proof}  The set 
$U(x,\epsilon,\phi)$ is homeomorphic to the product
  $$
  \{x \in\ring{R}\mid x > 0\} \times U',\quad
  U' = \{x \in U \mid |x-v_0| = 1\}.
  $$
It is enough to show that $U'$ is open and connected in
the sphere $$S^2(v_0) = \{x\mid |x-v_0|=1\}.$$
$C(v_0,e,\phi/2) \cap S^2(v_0)$ is open in the
topology on the circle $A=\op{aff}\{v_0,v,w\}\cap S^2(v_0)$, 
because it is
obtained by removing the closed sets $\op{rcone}(v_0,\cdot,\phi/2)\cap A$ from the open set $A\cap C^0(v_0,e)$.
It is also connected.   However, $U'$ is homeomophic to the
product
  $$
  (0,\epsilon) \times (C(v_0,e,\phi/2) \cap A.
  $$
The result follows.
\end{proof}

\begin{lemma}
Let $(v_0,V,E)$ be a pre-planar graph.
Let $x=(v_0,v,w,w')$ be a dart in the associated hypermap.
For all $\phi > 0$ and sufficiently small, there exists
$\epsilon(\phi)>0$ such that
the set $U(x,\epsilon,\phi)$ is
contained in a single connected component of $\ring{R}^3\setminus
X(v_0,V,E)$ for all $0 < \epsilon <\epsilon(\phi)$.
\end{lemma}

\begin{proof}  Fix $\phi>0$ small enough that $W(x,\phi)$
and $W(f x,\phi)$ are contained in a single component.
By the previous lemma, $U(x,\epsilon,\phi)$ 
is connected.  It is enough to
show that $U\cap S^2(v_0)$  does not meet $X(v_0,V,E) \cap S^2(v_0)$.
If there is an
intersection of $C(v_0,e)$ (for some $e\ne\{v,w\}$)
with $U(x,\epsilon,\phi)$ for all $\epsilon > 0$, we can pick
a sequence $c_i + \mu_i n \in U(x,\epsilon_i,\phi)\cap S^2(v_0)
\cap C(v_0,e)$, and $c_i\in C(v_0,\{v,w\},\phi/2)$. 
with $\epsilon_i \to 0$.  By compactness,
the element $c_i$ converges to an
element $c$ in 
  $$(C(v_0,\{v,w\})\cap C(v_0,e)\cap S^2)
  $$
By the assumption that  $(v_0,V,E)$ is pre-planar, this
implies that $\{v,w\}$ meets $e$ at a vertex, say $v\in e$.
The elements $c_i\not\in \op{rcone}^0(v_0,v,\phi/2)$, so
in the limit we have $c\not\in\op{rcone}^0(v_0,v,\phi/2)$.
However, the intersection of $C(v_0,v)$ with $C(v_0,\{v,w\})$
lies in $\op{rcone}^0(v_0,v,\phi/2)$.  This is a contradiction.
\end{proof}

\begin{lemma}
Let $(v_0,V,E)$ be a pre-planar graph.
Let $x=(v_0,v,w,w')$ be a dart in the associated hypermap.
For all $\phi,\epsilon > 0$
the set $U=U(x,\epsilon,\phi)$ meets $W=W(x,\phi)$ and 
$W'=W(f x,\phi)$.
Furthermore, the darts $x$ and $f x$ lead into the same
component of $Y(v_0,V,E)$.
\end{lemma}

\begin{proof}
We will show that $U$ meets $W$.    Let $e=\{v,w\}$. Pick 
 $$c\in C(v_0,e) \cap 
      (\op{rcone}^0(v_0,v,\phi)\setminus \op{rcone}(v_0,v,\phi/2)).
 $$
Let $n$ be as above.  For $\mu$ sufficiently small,
$u_\mu=c + \mu n\in U$.  We show that $u_\mu\in W(x,\phi)$, for $\mu$ small.
By construction $u_\mu\in \op{rcone}^0(v_0,v,\phi)$.
The direction of the normal $n$ was chosen so that for $\mu$ small
we have
   $$
   \op{azim}(v_0,v,w,c) < \op{azim}(v_0,v,w,u_\mu).
   $$
Note that $\op{azim}(v_0,v,w,c) = 0$, because 
$c\in\op{aff}_+^0(\{v_0,v\},w)$. % XX
The function $\op{azim}$ is continuous %XX
so $\op{azim}(v_0,v,w,u_\mu)$ tends to zero with $\mu$.
Thus, for $\mu$ sufficiently small,
   $$
   0 < \op{azim}(v_0,v,w,u_\mu) < \op{azim}(v_0,v,w,w').
   $$
This is precisely the condition for $u_\mu\in W(x,\phi)$.
The argument that $U$ meets
$W'$ is similar.

Each of the sets $U$, $W$, $W'$ lies in a single connected
component of the complement.  Since $W$ and $U$ meet, they
lie in the same component.  Likewise, $U$ and $W'$ lie in the
same component.  By transitivity, $W$ and $W'$ lie in the same
component.
\end{proof}

\begin{lemma} Let $(v_0,V,E)$ be pre-planar.
If $x$ and $y$ are darts in the same face of the hypermap
$\op{hyp}(v_0,V,E)$, then they lead into the same connected component.
\end{lemma}

\begin{proof}  This is an easy induction, based on the previous
lemma.  
\end{proof}

This implies in particular
that the number of connected components is no more than
the number of faces.  

%%%%%

\begin{lemma}\label{lemma:approach-Ce}
Let $(v_0,V,E)$ be a pre-planar graph.  Let $V$ be a connected
component of $Y(v_0,V,E)$.  Let $e\in E$ and let $\{x,y\}$
be the two darts forming an edge of $\op{hyp}(v_0,V,E)$
corresponding to $e$.  Let $\gamma:[0,1]\to V\cup C^0(v_0,e)$
be a path that begins in $V$ and ends on $C^0(v_0,e)$.
Then for all $\phi,\epsilon>0$ sufficiently small,
there exists  $t\in[0,1]$ such that
  $$\gamma(t)\in 
  V(x,\phi) \cup V(f x,\phi)\cup 
  V(y,\phi)\cup \cup V(f y,\phi) 
  \cup U(x,\epsilon,\phi)
  \cup U(y,\epsilon,\phi).
  $$
\end{lemma}

\begin{proof}
Suppose for a contradiction, that path avoids the given union
of sets $V(x,\phi)\cup\cdots$.  
%% XX complete.
\end{proof}

\begin{lemma}
Let $(v_0,V,E)$ be a pre-planar graph.  Let $(v_0,V,E')$
be the pre-planar graph obtained by deleting one edge:
  $$
  E' = E\setminus\{e\}, \quad X(v_0,V,E) = X(v_0,V,E')\cup C(v_0,e).
  $$
There is a well-defined map from the set of components
of $Y(v_0,V,E)$ to the set of components
of $Y(v_0,V,E')$ induced by the natural
inclusion
   $$Y(v_0,V,E) \subset \ring{R}^3
   \setminus X(v_0,V,E).
   $$
\end{lemma}

\begin{lemma}\label{lemma:pre-walkup}
Let $(v_0,V,E)$ be a pre-planar graph.  Let $(v_0,V,E')$
be the pre-planar graph obtained by deleting one edge $e$.
Let $x,y$ be the darts of the edge of
$\op{hyp}(v_0,V,E)$ corresponding
to $e$.
Then $\op{hyp}(v_0,V,E')$ is obtained from $\op{hyp}(v_0,V,E)$
by a double walkup transformation on the edge $\{x,y\}$.
\end{lemma}


\begin{lemma}\label{lemma:join-comp}
Let $(v_0,V,E)$ be a pre-planar graph.  Let $(v_0,V,E')$
be the pre-planar graph obtained by deleting one edge $e$.
Let $x,y$ be the darts of the edge of
$\op{hyp}(v_0,V,E)$ corresponding
to $e$.
Let $V,V'$ be two distinct
components of $Y(v_0,V,E)$ that are mapped
to the same component of $Y'=Y(v_0,V,E')$.  Then exchanging
$x$ and $y$ if necessary, we have that $x$ leads into $V$
and $y$ leads into $V'$.
\end{lemma}

\begin{proof}
Since $V$ and $V'$ merge into a single component of $Y'$,
there is a path in $V\cup V'\cup C^0(v_0,e)$, starting in $V$
and ending in $V'$.  Since $V$ and $V'$ are separate components
in $Y$, the path necessarily meets $C^0(v_0,e)$.
By Lemma~\ref{lemma:approach-Ce}, the
initial part of the path in $V\cup C^0(v_0,e)$ up to the first
intersection with $C^0(v_0,e)$ meets $A(x)\cup A(y)$, where
  $$
  A(z,\epsilon,\phi) = 
    V(z,\phi) \cup V(f z,\phi)\cup 
  \cup U(z,\epsilon,\phi).
  $$
(We assume that $\epsilon$ and $\phi$ are positive and sufficiently
small; then drop them from the notation.)
Similarly, the terminal part of the path in $V'\cup C^0(v_0,e)$, 
from the
final intersection with $C^0(v_0,e)$ on, meets $A(x)\cup A(y)$.
Recall that $A(x)$ and $A(y)$ are connected.  Thus,
if the initial and terminal segments of the path were to
meet the
same set (say $A(x)$), then $V$ and $V'$ would be equal components.
Thus, $V$ contains (say) $A(x)$ and $V'$ contains $A(y)$.
The result now follows from the definition of what it means
to lead into a component.
\end{proof}


\begin{lemma}
Let $(v_0,V,E)$ be a pre-planar graph.  Let $(v_0,V,E')$
be the pre-planar graph obtained by deleting one edge $e$.
Let $x,y$ be the darts of the edge of
$\op{hyp}(v_0,V,E)$ corresponding
to $e$.  Then
the natural map from components of $Y(v_0,V,E)$ to components
of $Y'=Y(v_0,V,E')$ is onto.
Suppose, furthermore, that the double walkup transformation
on $\{x,y\}$ corresponding to the deletion of $e$ is a split
(see Lemma~\ref{lemma:pre-walkup} 
and Definition~\ref{def:merge-split}).  
The the natural map from $Y$ to $Y'$ is a bijection.
\end{lemma}

\begin{proof}
First we show that the map is onto.  Let $V'$
be a component of $Y'$.  If $p\in V'$,
then a sufficiently small neighborhood of $p$ is contained
in $Y'$ and contains a point $q\not\in C(v_0,e)$.  The
point $q$ belongs to some component $V$ of $Y$.  The image
of $V$ is $V'$.

We show that the map is injective.  If not, two
components $V,V'$ map to the same component of $Y'$.
By Lemma~\ref{lemma:join-comp}, $x$ leads into $V$ and
$y$ leads into $V'$ (swapping $x$ with $y$ if necessary).
However, in a split, $x$ and $y$ are in the same face of
the hypermap $\op{hyp}(v_0,V,E)$ and hence lead into the
same component.  Thus, $V=V'$.
\end{proof}

%\begin{lemma} Let $(v_0,V,E)$ be a pre-planar graph.  Suppose that
%deleting an edge of the graph is given combinatorially as a split
%double face walkup.  Then the number of connected components of
%$Y(v_0,V,E)$ is preserved by the edge deletion.  All
%components are left as before, except one that differs only by the
%presence of the edge.
%\end{lemma}
%
%\begin{proof}
%The components other those along the edge are unaffected. Suppose
%that there are two connected components $U,U'$ in $H'$ that become
%connected after the edge deletion.  If sets $U(x,\epsilon,\phi)$ and
%$U({e x},\epsilon,\phi)$  ($\epsilon$ small) were both to belong to the
%same component $U$, then $U\cup\{\text{the open-ended edge}\}$ XX
%and $U$ are disjoint open after the deletion, contrary to the
%assumption they become connected.  So $U(x,\epsilon,\phi) \subset U$ and
%$U({e x},\epsilon,\phi) \subset U'$.  Thus, $x$ and $e x$ lie on
%different faces of $H'$ and this implies that the double walkup is a
%merge, contradicting the hypothesis that it is split. Thus, the
%number of connected components remains constant.
%\end{proof}
%

XX Notational problem V for vertices, V for components.

\begin{lemma} 
Let $(v_0,V,E)$ be a pre-planar graph.  Let $(v_0,V,E')$
be the pre-planar graph obtained by deleting one edge $e$.
Let $x,y$ be the darts of the edge of
$H=\op{hyp}(v_0,V,E)$ corresponding
to $e$.  
Suppose that $x$ and $y$ lead into different components $V,V'$
of $Y(v_0,V,E)$.
Then $V$ and $V'$ map to the same component of $Y'=Y(v_0,V,E')$.
\end{lemma}

\begin{proof}
Let $f,n$ be the face and node maps on the hypermap
$H$.
If $y$ leads into $V'$, then so does
$f y = n^{-1} x$.  Let $z$ be the dart in
on $\op{hyp}(v_0,V,E')$ that is the image of the dart $n^{-1}x$
in $H$. We see that
$W(x,\phi)$ and $W(n^{-1} x,\phi)$ combine into a single
region $W(m^{-1}z,\phi)$.  Thus, $V$ and $V'$ map to the
same component of $Y'$.
\end{proof}

%
%%Let $(v_0,V,E)$ be a pre-planar graph.  Suppose that
%deleting an edge of the graph is given combinatorially as a merge
%double face walkup.  Let $x$ be a dart along the given edge.  Assume
%that $x$ and $e x$ lead into distinct components. Then the number of
%connected components of $Y(v_0,V,E)$ is decreased by one by
%the edge deletion. All components except the components of $x$ and
%$e x$ (along the given edge) are left as before.  The components of
%$x$ and $e x$ are joined.


%\begin{proof} The components other than those of $x$ and $e x$ are
%unaffected.  The darts $f x$ and $e x$ lead into different
%components before the deletion, but the wedge $W({f x})$ and $W({e
%x})$ are combined into $W({f' x})$ after the deletion.  So the two
%components are combined.
%\end{proof}
%

\begin{lemma}  
Let $(v_0,V,E)$ be a pre-planar graph.  
$(D,e,n,f) = \op{hyp}(v_0,V,E)$ be the associated hypermap.
Fix a union of orbits $A$ 
of $\tangle{e,n,f}$.  Let $X_1$ be
the union of cones $C(v_0,{\{v,w\}})$ such that there is a dart 
$x =
(v_0,v,w,w')$ in $A$.  Let $X_2$ be the union of cones coming in the
same way, but for darts not in $A$.  Then $X_1\setminus\{v_0\}$ is disjoint
from $X_2\setminus\{v_0\}$.
\end{lemma}

\begin{proof} 
If the two sets are not disjoint, we can find a sequence of
edges
   $$C_i=C(v_0,e_i),\quad i=0,\ldots,k.$$
with $C^0(v_0,e_i)\subset X_j$, $(i,j)=(0,1),(k,2)$.
such that $C_i$ meets $C_{i+1}$ along $\op{aff}_+^0(v_0,v_i)$,
with $v_i\in V$.   We have
$$C_i = \op{aff}_+(v_0,\{v_i,u_i\}),
  \quad 
  C_{i+1} = \op{aff}_+(v_0,\{v_i,w_i\}),$$
for some points edges $\{v_i,u_i\},\{v_i,w_i\}\in E(v_i)$.
By the definition of pre-planarity, $u_i$ and $w_i$ are
in the same orbit of the azimuth cycle $\sigma=\sigma(v_i)$ on $E(v_i)$.
The azimuth cycle is used to define the node map.
Hence, the darts 
   $$
   (v_0,v_i,w_i,\sigma(w_i)),\quad
   (v_0,v_i,u_i,\sigma(u_i)).
   $$
are connected by a contour path of $n^{-1}$-steps.
Joining these contour paths together along the sequence
$C_i$ gives a contour path from a dart along $C_0$ to
one along $C_k$.  This is contrary to the construction of
the lemma.
\end{proof}



\subsection{Linear Graphs}


\begin{definition}
  $(v_0,V,E)$ is a linear graph if the following hold:
  \begin{itemize}
  \item $(v_0,V,E)$ is a pre-planar graph.
  \item For each $\{v,w\}\in E$ and each $u\ne0$ orthogonal to both
  $v$ and $w$, we have an azimuth cycle $\tau_u$ on
    $$V_u = \{ v' \in V \mid v'\cdot u = 0\}$$
    coming from $u$.  Moreover, if $v'\in V_u$, then $\{v',\tau_u
    v'\}\in E$, and
    $$\cup_{i} C({\{\tau_u^i v',\tau_u^{i+1} v'\}}) = \{x \in \ring{R}^3\mid
    x\cdot u = 0\}.$$
  \end{itemize}
\end{definition}

[XX notation is too heavy.]

Intuitively, this says that once there is one edge with $C(e)$ in a
plane, then the cones continue in a cyclic way to fill the entire
plane. The cones $C(e)$ form planes through the center $v_0$.
A linear graph is one that can be viewed as
constructed from a finite number of great circles on the unit
sphere, whose nodes include all the points of intersection of the
great circles.

Let $(v_0,V,E)$ be a linear graph.   Let $F$ be a finite set of linear
functions whose zero sets define the planes $P$ entering the
construction. For every choice of signs $\epsilon: F\to \{\pm 1\}$,
we have a cone
    $$R_\epsilon = \{v\in\ring{R}^3 \mid \forall f\in F.\ \epsilon_f f(v) > 0\}.$$
The sets are clearly disjoint for different sign choices $\epsilon$.
The union of the sets $R_\epsilon$ fills all of $\ring{R}^3$ except
for the points in the planes $\{v\mid f(v)=0\}$.


\begin{lemma} Let $(v_0,V,E)$ be a linear graph.  Let $X=X(v_0,V,E)$.
The sets $\ring{R}^3\cap
R_\epsilon$ lie in $Y$.  Each $\ring{R}^3\cap R_\epsilon$ is
empty or a connected component of $Y$.
\end{lemma}

\begin{proof}  The set $X$ lies in the union of the planes $\{v\mid
f(v)\}$, so $R_\epsilon$ is disjoint from $X$.  This proves the
first claim.  Each $R_\epsilon$ is open, and its intersection with
$\ring{R}^3$ is open.  Each $R_\epsilon$ is convex (an intersection of
half-spaces).  The line segment between two points $v,w$ of
$R_\epsilon$ projects to an arc in $\ring{R}^3\cap R_\epsilon$, showing
that any two points $v,w\in \ring{R}^3\cap R_\epsilon$ can be joined by a
continuous curve.  Thus, $\ring{R}^3\cap R_\epsilon$ is connected.

Every point of $Y$ lies in some $R_\epsilon$.  The sets
are open, connected, disjoint, and fill $Y$. Thus, the
nonempty ones are the connected components.
\end{proof}

\begin{lemma} Let $(v_0,V,E)$ be a linear graph.  Each face of
$\op{hyp}(v_0,V,E)$ has cardinality at least $3$.
\end{lemma}

\begin{proof} We have proved in Lemma XX that $f$ has no fixed
points.  If $f^2 (v,w,w')$ has order two, then
    $$(v,w,w') = f^2(v,w,w') = f(w,*,v) = (*,*,w).$$
So $w=w'=\sigma(v,w)$.  Thus, the set $E_v$ of edges at $v$ is a
singleton set $E_v = \{\{v,w\}\}$.  Let $e=\{v,w\}$.  Let $P$ be the
plane of $C(e)$.

Let $u\ne0$ be orthogonal to $v$ and $w$ and let $\tau=\tau_u$ be
the azimuth cycle on $P\cap V$.  Since $\{\tau^{-1}v,v\}$ and $\{tau
v,v\}$ are in $E$, we have $\tau^{-1}v = \tau v = w$.  So $\tau$ has
order $2$.  Then by the definition of linear graph,
  $$C({\{v,w\}}) = \cup_{i} C({\{\tau_u^i v',\tau_u^{i+1} v'\}}) = P.$$
This contradicts the fact that in a pre-planar graph, no $C(e)$
contains antipodal points.
\end{proof}

\begin{lemma}  Let $(v_0,V,E)$ be a linear graph.  Let $C$ be a
connected component of $Y$.  Then every dart that leads
into $C$ belongs to the same face of $\op{hyp}(v_0,V,E)$.
\end{lemma}

\begin{proof}  Let $\#c$ be the number of connected components.  The
map from faces to onto the set of connected components gives
        $$\#c \le \#f.$$
If we prove the reverse inclusion $\#f \le \#c$, then we have a
bijection between connected components and faces, and the result
follows.


[XX fix proof. We now allow antipodal points for endpoints of an
edge.  Thus, we can reduce to a single plane.] Suppose first that
there is a line that contains all the intersections of the planes.
Suppose there are $k$ planes. There are two nodes (the north and
south poles of the sphere). There are $k$ darts at the north pole.
Every face contains a dart at the north pole, so $\#f \le 2 k$. The
wedges $W(x)$ as $x$ runs over darts at the north pole give nonempty
disjoint open connected sets, so $2 k \le \#c$.  This proves the
result in this case.

If there is no line that contains all the pairwise intersections of
the planes, pick a plane $P$ and delete all the nodes that do not
lie on the intersection with another plane, and then delete all the
edges such that $C(e)\subset P$.  This is again a linear graph. This
operation decreases $\#c - \#f$, because the number of components
decreases by at least $1$ for each edge deleted and the number of
faces increases by at most $1$ for each edge deleted.

By repeatedly eliminating planes, we find that eventually there is a
line that contains all the intersections of the planes.  So $\#c -
\#f$ has been decreased to zero, and hence it must have been
non-negative in the beginning.
\end{proof}

Thus, we have a 1-1 correspondence between connected components and
faces of the hypermap.  Each dart $x=(v,w,w')$ has associated with
it the azimuth angle of $(0,v,w,w')$ [XX bad notation].  Write it
$\op{azim}(x)$.

\begin{lemma} Let $(v_0,V,E)$ be a linear graph.  Let $C$ be a connected
component of $Y$, associated with the face $F$ of the
hypermap $\op{hyp}(v_0,V,E)$.    Then $C$ is spherically measurable,
and its solid angle  is
    $$2\pi + \sum_{x\in F} (\op{azim}(x)-\pi).$$
\end{lemma}

\begin{proof} If $\card(F)=3$, then this is the Formula~REFXX for the solid
angle of a spherical triangle.  In general, proceed by complete
induction on $k$, with base case $3$.  [XX either add an edge to
break the triangle, or add an external triangle that decreases the
number of sides by one.  Add detail.]
\end{proof}

\begin{lemma} Let $(v_0,V,E)$ be a linear graph.  Then $\op{hyp}(v_0,V,E)$
is connected.
\end{lemma}

\begin{proof}  Let $x$ and $y$ be two darts.  Pick any edge $e$ at
$x$ and $e'$ at $y$.  Construct the planes $P_e$ and $P_{e'}$
containing $C(e)$ and $C({e'})$.  These planes, if not equal, meet in
a line.  Pick a ray from the origin in this line.  This ray meets
two different cones, one on $P_e$ and one on $P_{e'}$.  By
nondegeneracy, this ray contains a vertex $v\in V$.  Pick a dart $z
= (v,\ldots)$.  It is enough to construct a path from $x$ to $z$
then $z$ to $y$.  Thus, we can now assume that $x$ and $y$ are darts
on the same plane.  Nodes on the same plane are linked by an azimuth
cycle.  So it enough to assume that $x$ and $y$ are darts at $v$ and
$\tau v$.  But then $\{v,\tau v\}\in E$, so connectivity is clear.
\end{proof}

\begin{lemma} Let $(v_0,V,E)$ be a linear graph.  Then $\op{hyp}(v_0,V,E)$
is planar.
\end{lemma}

\begin{proof}  Since every edge has order $2$, we have $\# D = 2\#
e$.  Since the graph is connected $\#\tangle{e,n,f} = 1$.  The Euler
relation takes the form
    $$
    \# n - \# e + \# f = 2.
    $$
Let $k(F)$ be the number of darts on face $F$.  We have $\sum_F k(F)
= \# D = 2 \# e$.  The solid angle of a sphere is $4\pi$, which is
the same as the sum of the solid angles of the connected components.
We have by Lemma XX and Lemma XX,
    \begin{equation}\begin{array}{lll}
    4\pi &= - \sum_F (k(F) - 2)\pi + \sum_F \sum_{x\in
    F}\op{azim}(x)\\
        &= - 2 \pi\# e  + 2 \pi\# f  + 2\pi\# n.
    \end{array}
    \end{equation}
Dividing by $2\pi$, we get the Euler relation.  Hence the hypergraph
is planar.
\end{proof}

\subsection{Planarity}



\begin{lemma}  Let $(v_0,V,E)$ be a pre-planar graph.  Let $\#c$ be the number
of connected components of $Y(v_0,V,E)$.  We have
    \begin{itemize}
    \item The hypergraph $\op{hyp}(v_0,V,E)$ is planar.
    \item No two faces in a given $\tangle{e,n,f}$ orbit lead
    into the same connected component.
    \item $\#c = 1 + \#f - \#\tangle{e,n,f}$
    \item Let $C$ be a connected component. Let $F\mapsto C$ mean
    that the face leads into $C$.  Then $C$ is spherically measurable and
        $$\op{sol}(C) = 4\pi + \sum_{F\mapsto C}(-2\pi + \sum_{x\in F}
        (\op{azim}(x)-\pi))$$
    \end{itemize}
\end{lemma}

\begin{proof}  These formulas have all been established for linear
graphs.  We show that every pre-planar graph can be obtained from a
linear graph by deleting nodes and edges (double walkup
transformations).  We then keep track of the effect of these
deletions on the truth of the the statements of the lemma.

For each edge of $(v_0,V,E)$, construct the plane containing $C(e)$. Add
elements to $V$ to get $V'$ for each point of intersection of $\ring{R}^3$
with two planes (unless there is already a point of $V$ on the same
ray). For each plane, divide it into cones by drawing the rays
through the vectors, and use these cones to construct edges $E'$.
This is a linear graph.

We recover $(v_0,V,E)$ and its hypermap by deleting vertices and edges.
These operations can be described combinatorially on the hypergraph,
but also geometrically in terms of $V$, $E$, and so forth.

The walkup transformations send planar hypermaps to planar
hypermaps.  Thus, $\op{hyp}(v_0,V,E)$ and the intermediate hypermaps
are all planar.  For planar maps, the planar index is preserved by
walkups.

Consider a split form of the double face walkup.  A face walkup that
splits the face also increases the number of orbits of
$\tangle{e,n,f}$ by one, and preserves the number of connected
components (by LemmaXX).  The faces that lead into the connected
component are as before, together with the two faces created by the
split.  The solid angle formula decreases by $2\pi$ for the new
face, and increases by $2\pi$ for the two fewer darts.  So both
sides of the solid angle formula are unchanged.  It is now clear
that all of the statements are preserved in the split case.

Consider the merge form of the double face walkup.  The number of
connected components drops by $1$.  The number of faces drops by
$1$.  The darts lead into the same connected components as before,
except the merged face leads into the merged component.  The orbits
under $\tangle{e,n,f}$ are unchanged.  It is easily seen that the
area formula is compatible with the merge $$\op{sol}(C_1) +
\op{sol}(C_2) = \op{sol}(C_1\cup C_2).$$ It is now clear that all of
the statements are preserved in the merge case.

We now consider a double edge walkup at a node of cardinality two.
This does not affect any of the terms in any of the formulas.  All
of the statements are preserved.

By a combination of these transformations we arrive at $(v_0,V,E)$.  The
conclusion follows.
\end{proof}


\begin{lemma} (Jordan curve theorem)  Let $(v_0,V,E)$ be a pre-planar
graph.   If $\op{hyp}(v_0,V,E)$ is a combinatorial polygon (a
connected hypermap such that every node has cardinality two), then
$Y(v_0,V,E)$ has exactly two connected components.
\end{lemma}

\begin{proof} By the preceding lemma, $\# c = \#f$, and the
hypermap is planar.  Since every node and every edge has order two,
we have $\#D = 2\#n = 2\# e = \#n +\#e$.  Since it is connected,
$\#\tangle{e,n,f} = 1$.  By the preceding lemma, the hypermap is
planar. Hence, the Euler relation gives:
    $$
    \#c = \#f = (\#D - \#n - \#e) + 2\#\tangle{e,n,f} =2.
    $$
\end{proof}

\begin{remark}   Rather than deducing the Euler relation from the Jordan
curve theorem, we have worked in the opposite direction and proved
the Jordan curve theorem from the Euler relation.  For us, the
genesis of the Euler relation is fact that the solid angles of a
triangulation of a sphere must sum to the area of a sphere.
\end{remark}





\section{Deformations of Hypermaps}

In this section, we consider various deformations $(p,V_t,E_t)$,
for $t\in I\subset \ring{R}$, of
a pre-planar graph $(p,V_0,E_0)$.  
We assume that $t=0\in I$ gives the initial point
of the deformation.  
In general, these deformations
are obtained by choosing replacing each vertex $v_0\in V$
with a path $v:I\to \ring{R}^3$.  
The base point remains fixed at $p$ 
(which we have renamed from $v_0$ to
avoid notational conflicts).
The combinatorial structure of the edge set remains
fixed.  
Thus,  
   $$
   E_t = \{ \{v_t,w_t\} \mid \{v_0,w_0\}\in E_0\}.
   $$


\subsection{Connecting a Hypermap}

%% Insert stuff on deforming to make it a single component

Our first deformation corresponds to the intuitive
notion of sliding two objects closer together until
they are a prescribed distance from one another.
In the case we consider, the objects are subsets of
vertices of the hypermap.

\begin{lemma} Let $(p,V_0,E_0)$ be a pre-planar graph and
let $(D,e,n,f)=\op{hyp}(p,V,E)$ be the associated hypermap.
Let $x$ and $y$ be darts of $H$ that lead into the same
component $V_0$ of $Y(v_0,V,E)$.  Let $A(x)$ (resp. $A(y)$)
be the $\tangle {e,n,f}$-component of $x$ (resp. $y$).
Assume that $A(x)\ne A(y)$.
Let $D' = D\setminus A(x)$.  
Fix $L>0$.
Suppose that if $(p,u_0,v_0,w_0)\in D'$ and
$(p,u'_0,v'_0,w'_0)\in A(x)$, then $|u_0-u'_0|>L$ and
that $|\,|u_0| - |u'_0|\,| < L$.
XX Need to insert hypothesis that give the pre-planar condition
on deformations.

Then, there exists a deformation
$(p,V_t,E_t)$ of $(p,V_0,E_0)$, parameterized by $t\in[0,1]$ such
that
\begin{itemize}
\item $(p,V_t,E_t)$ is a pre-planar graph for all $t\in[0,1]$.
\item $|v_t-p| = |v_0-p|$ for all $t$.
\item If $x=(p,v_0,\ldots)\in D'$, then $v_t=v_0$ for all $t$.
\item If $(p,v_0,\ldots)$ and $(p,w_0,\ldots)$ are darts
in $A(x)$, then $|v_t-w_t|=|v_0-w_0|$ for all $t$.
\item If $(p,u_0,v_0,w_0)\in D$, then 
   $$
   \op{azim}(p,u_t,v_t,w_t) = \op{azim}(p,u_0,v_0,w_0),
   $$
   for all $t$.
\item There is a canonical identification of connected components
of $Y(p,V_t,E_t)$ with components of $Y(p,V_0,E_0)$, as $t$ varies.
\item 
Let $V_1$ be the component at $t=1$ corresponding to $V_0$ at $t=0$.
There exists two darts $u=(p,u_1,v_1,w_1)$ and
$u'=(p,u_1',v_1',w_1')$ that lead into $V_1$ such that
  \begin{itemize} % nested
  \item $|u_1-u_1'| = L$.
  \item $\{p,u_1,u'_1\}$ is not collinear.
  \item $\op{aff}_+^0(p,\{u_1,u_1'\}) \subset V_1$.
  \end{itemize} % nested
\end{itemize}
\end{lemma}

\begin{proof}
Let $U\subset V$ be the set of points corresponding
to the darts $(p,u_0,\ldots)\in A(x)$.  Let $U'=V\setminus U$.
Pic $u\in U$ and $u'\in U'$, and let $e_1,e_2,e_3\in\ring{R}^3$ be 
an orthogonal frame with $e_3\cdot u = e_3\cdot u' = 0$.
We apply an orthogonal transformation to $U$.
If $w\in\ring{R}^3$, we write
$w_0-p = a e_1 + b e_2 + c e_3$ and set
$$R_\theta w = p + (a\cos\theta+b\sin\theta) e_1 +
   (-a\sin\theta+b\cos\theta) e_2 + c e_3.$$
For $v_0\in V$, set
  $$
  v_\theta = \begin{cases}
    R_\theta v_0 & v_0\in U\\
    v_0 & v_0\in U'\\
    \end{cases}
  $$
When $\theta=0$, $|u_\theta-u'_\theta|>L$, but for some $\theta\in[0,2\pi]$,
it follow from our choice of $e_3$ that
$u'_\theta\op{aff}_+^0(p,u_\theta)$, so that
$$|u'_\theta - u_\theta| = |\,|u'_\theta| - |u_\theta|\,|
  = |\,|u'_0| - |u_0|\,| < L.$$
By the intermediate value theorem, there is a least angle
$\theta'\in(0,\pi)$ such that there exists $v_0\in U$
and $v'_0\in U'$ with $|v_{\theta'}-v'_{\theta'}|=L$.
%% XX need to reparametrize so that theta'=1.

We claim that the deformation $\theta\mapsto v_\theta$
has all of the required properties, provided that we make
a linear reparameterization so that $v_1$ represents the
rotation at $\theta=\theta'$.

The main point is to check for $0 < \theta < \theta'$,
that $(p,V_\theta,E_\theta)$ is pre-planar.
XX FINISH.
\end{proof}

If $(p,V_1,E_1)$ is the pre-planar graph resulting from
this construction, the lemma guarantees the existence
of two darts $(p,u_1,v_1,w_1)$ and $(p,u'_1,v'_1,w'_1)$
such that $C^0(p,\{u_1,u'_1\})\subset V_1$.  It follows
that if we set $E' = E_1 \cup \{u_1,u'_1\}$, then we obtain
a pre-planar graph $(p,V_1,E')$.  In terms of the 
corresponding hypermaps, $\op{hyp}(p,V_1,E')$ is obtained from
$\op{hyp}(p,V_1,E_1)$ by a reverse double walkup transformation.


%By deformation, we can produce subregions whose boundary is a polygon.
%Let $U$ be the set of vertices over the subregion of height $\le2t_0$.
%As in Section~\ref{sec:the-main-theorem}, the distinguished edges
%partition $U$ into equivalence classes.  Move the vertices in one
%equivalence class $U_1$ as a rigid body preserving heights until the
%class comes sufficiently close to form a distinguished edge with another
%subset. Continue until all the vertices are interconnected by paths of
%distinguished edges. 


If some vertex $v$ is connected to three or more vertices by
distinguished edges, it follows from the connectedness of the open
subregion that there is more than one connected component $U_i$ (by
paths of distinguished edges) of $U\setminus\{v\}$. Move $U_1\cup \{v\}$
rigidly preserving heights and keeping $v$ fixed until a distinguished
edge forms with another component. Continue until the distinguished
edges break the subregions into subregions with polygon boundaries.


By the end of Section~\ref{x-4}, we will deform all subregions into
convex polygons.

\begin{remark}
    \label{remark:proof-2}
We will deform in such a way that the edges $\{v_1,v_2\}$ will maintain a
length of at least $2$. The proof that distances of at least $2$ are
maintained is given in Section~\ref{sec:proof-2}.

We will deform in such a way that no vertex  crosses a boundary of the
subregion passing from outside to inside.
\end{remark}

Edge length constraints prevent a vertex from crossing a boundary of the
subregion from the inside to outside.  In fact, if $v$ is to cross the
edge $\{v_1,v_2\}$, the simplex $S=\{0,v_1,v,v_2\}$ attains volume 0.  We
may assume, by the argument of the proof of Lemma~\ref{x-4.3}, that
there are no vertices enclosed over $S$. Because we are assuming that
the subregion is not a triangle, we may assume that $|v-v_1|>2t_0$. We
have $|v|\in[2,2t_0]$.  Under these constraints,
by Lemma~\ref{tarski:delta-2}, the vertex $v$ cannot cross out of the subregion.




\subsection{Visibility}

%%


%% Moved from the end of [DCG SEC 12.7]
We say that a corner $v_1$ is {\it visible}\index{visible} from another $v_2$ if
$\{v_1,v_2\}$ lies over the subregion.  A deformation may make $v_1$
visible from $v_2$, making it a candidate for a new distinguished edge.
If $|v_1-v_2|\le 3.2$, then as soon as the deformation brings them into
visibility (obstructed until then by some $v$), then
Lemma~\ref{tarski:delta-2} shows that $|v_1-v|,|v_2-v|\le2t_0$. So
$v_1,v,v_2$ are consecutive edges on the polygonal boundary, and
$|v_1-v_2|\ge 2\sqrt{4-t_0^2} > \sqrt{8}$. By the distinguished edge
conditions for special simplices, $\{v_1,v_2\}$ is too long to be
distinguished.  In other words, there can be no potentially
distinguished edges hidden behind corners. They are always formed in
full view.



\subsection{Preservation of Minimal Distance}
%\subsection{Proof that Distances Remain at least $2$} %DCG 12.13, p140
    \label{sec:proof-2}


\begin{remark}
\label{flexremark} In Section~\ref{remark:proof-2}, to allow for
more flexible deformations, we drop all constraints on the lengths
of (undistinguished) edges $\{v_1,v_2\}$ that cross the boundary of
the subregion.  We deform in such a way that the edges $\{v_1,v_2\}$
will maintain a length of at least $2$.
\end{remark}


Recall that we say that a vertex of a subregion is {\it convex\/}
if its angle is less than $\pi$, and otherwise that is {\it
concave}
(Definition~\ref{def:concave}).\index{convex}\index{concave}
%
In general, if $P$ is a subregions and $p_1$ and $p_2$ are two
vertices of $P$, there is a minimal curve joining $p_1$ and $p_2$
inside $P$.  This curve is a finite sequence $e_1,\ldots, e_r$ of
spherical geodesics.  We refer to this sequence as the {\it sequence
of arcs\/} \index{arc!sequence} from $p_1$ to $p_2$. The endpoint of
each spherical arc is a vertex of $P$. All endpoints except possible
$p_1$ and $p_2$ are nonconvex. These endpoints are the radial
projections of corners of $P$: $v_0,v_1,\ldots,v_{r+1}$, with
$p(v_0)=p_1$ and $p(v_{r+1})=p_2$. The vertex $p_1$ is visible from
$p_2$ if and only if $r=1$.


\begin{lemma}\label{dist2}
This deformation of a subregion at a concave corner $v$ maintains
a distance of at least $2$ to every other corner $w$.
\end{lemma}

\begin{proof}
The proof is by contradiction. We may assume that $|v-w|<\sqrt8$.
We may assume that $v$ and $w$ are the first corners to violate
the condition of being at least $2$ apart, so that distances
between other pairs of corners are at least $2$.  A distinguished
edge connects $v$ and $w$, if $w$ is visible from $v$. So assume
that $w$ is not visible.  Let $e(v_1,v_2)$ be the first
distinguished edge crossed by the geodesic arc $g$ from $p(v)$ to
$p(w)$. Let $p_0$ be the intersection of $e(v_1,v_2)$ and $g$. By
construction, the deformation moves $v$ into the subregion, and
the subregion $P$ is concave at the corner $v$, so that the arc
from $p(v)$ to $p(w)$ begins in $P$, then crosses out at
$e(v_1,v_2)$.

We have $|v_1-v_2|\ge2.91$ by Lemma~\ref{tarski:E:part4:10}.

Let $e_1,\ldots,e_r$ be the sequence of arcs from $p(v)$ to
$p(v_1)$, and let $f_1,\ldots,f_s$ be the sequence of arcs from
$p(v)$ to $p(v_2)$. Since this sequence forms a minimal curve, the
sum of the lengths of $e_i$ is at most the sum of the lengths of
$e(v,p_0)$ and $e(p_0,v_1)$, and the sum of the lengths of $f_i$
is at most the sum of the lengths of $e(v,p_0)$ and $e(p_0,v_2)$.

Note that if $r+s\le4$, then one of the edge-lengths must be at
least $3.2$, for otherwise the sequence of arcs are all
distinguished or diagonals of specials, and this would not permit
the existence of a corner $w$. That is, we can fully enumerate the
corners of the subregion, and each projects radially to an
endpoint in the sequence of arcs, or is a vertex of a special
simplex. None of these corners is separated from $v$ by the plane
$\{0,v_1,v_2\}$.

We have $r+s\le3$ by the following calculations.  Here
$y\in[2,2t_0]$.
    $$5\arc(2t_0,2t_0,2) > \arc(2,2,3.2)+ 2 \arc(2,2,2).$$
    $$3\arc(2t_0,2t_0,2) + \arc(2t_0,y,3.2) > \arc(y,2,3.2) + 2 \arc(2,2,2).$$
    $$3\arc(2t_0,2t_0,2) + \arc(2t_0,y,3.2) > \arc(2,2,3.2) + 2\arc(y,2,2).$$


First we prove the lemma in the special case that the distance from
$v$ to one of the endpoints, say $v_1$, of $\{v_1,v_2\}$ is at least
$3.2$. In this special case, Lemma~\ref{tarski:dcg-1220} shows
that we have an
impossible geometric configuration. The
constraints are as follows.  There are five points: $0,v_1,w,v,v_2$.
The plane $\{0,v_1,v_2\}$ separates the point $w$ from $v$. The
distance constraints are as follows:
    $$2\le |u| \le 2t_0,$$
for $u=v_1,w,v,v_2$, $|v-v_1|\ge 3.2$, $|v-w|\le2$, $|v-v_2|\ge2$,
$|w-v_1|\ge2$, $|w-v_2|\ge2$, $2\le |v_1-v_2|\le 3.2$.

Now assume that the distances from $v$ to the vertices $v_1$ and
$v_2$ are at most $3.2$.

If $r+s=2$, then $v_1$ and $v_2$ are visible from $v$. Thus, they
are distinguished or diagonals of special simplices. As
$\{v_1,v_2\}$ is also distinguished, the corners of $P$ are fully
enumerated: $v$, $v_1$, $v_2$, and the vertices of special
simplices.  Since none of these are $w$, we conclude that $w$ does
not exist in this case.

If $r+s=3$, then say $r=1$ and $s=2$. We have $\{v,v_1\}$ is
distinguished or the diagonal of a special simplex. Let
$p(v),p(u)$ be the endpoints of $f_1$, for some corner $u$. We
have $|u-v_1|\ge\sqrt8$ because $\{u,v_1\}$ is not distinguished,
and $\max(|u-v|,|u-v_1|)\ge3.2$, because otherwise we enumerate
all vertices of $P$ as in the case $r+s=2$, and find that $w$ is
not among them. Lemma~\ref{tarski:dcg-p142} now shows that
there does not exist a configuration of five points
$0$, $u$, $v$, $v_1$, $v_2$, with all distances at least $2$
satisfying these constraints.
\end{proof}










\subsection{Convexity}

If all the angles are at most $\pi$,
then the hypermap is contained in a hemisphere and
is geodesically convex.



\begin{lemma}
    \oldlabel{5.1.2}
    \label{lemma:7-sides}
The convex polygon has at most seven sides.
\end{lemma}

\begin{proof}
Since the polygon is convex, its perimeter on the unit sphere is at
most a great circle $2\pi$.  If there are eight sides, the perimeter
is at least $8\arc(2t_0,2t_0,2)>2\pi$.
\end{proof}




\section{Containment of Truncated corner cells} %DCG  12.11, p 136
    \oldlabel{4.12}


Let $H =\op{hyp}(v_0,V,E)$ be the hypermap of a pre-planar graph,
and let $C$ be a connected component
of $Y(v_0,V,E)$.

We assume
that we are working with a component
with the following properties. If $v$ is a concave dart and $w$
is not adjacent to $v$, and yet is visible from $v$, then
$|v-w|\ge3.2$. If $v$ is a concave corner, then $|v-w|\ge3.07$ for
both adjacent corners $w$. If $v$ is a concave corner and
$|v|\ge2.2$, then $|v-w|\ge3.2$ for both adjacent corners $w$.


Recall from Definition~\ref{def:concave} that we call a spherical
region {\it convex} if its interior angles are all less than
$\pi$. 
%The case where the subregion is a convex triangle will be
%treated in Section~\ref{x-5.7}. Hence, we may also assume in
We assume
that the component is
not a convex triangle.

In Section~\ref{sec:tcc}, a region $TC(0,v,w_1,w_2,t_0,\lambda)$,
called the
truncated corner cell (tcc), is introduced.
We construct a {\it truncated corner cell\/} at each corner.  It depends on 
parameters $t_0$ and $\lambda \in [1.6,1.945]$. In all applications, we
take
    $\lambda = 1.945 = 3.2-t_0$, $\lambda = 1.815 = 3.07-t_0$, or
    $\lambda = 1.6 = 3.2/2$.
In all applications $w_1,v,w_2$ will be consecutive corners of
a standard region.

By construction tccs at adjacent
corners of a standard region are separated by a plane . Tccs at
nonadjacent corners do not overlap if the corners are
$\ge2\lambda$ apart. Tccs will only be used in subregions
satisfying this condition. It will be shown in
this section that tccs lie in the cone over the subregion
(for suitable $\lambda$).

\begin{lemma}
    \oldlabel{4.12.1}
Let $v$ be a concave vertex with $|v|\ge2.2$. The truncated
corner cell at $v$ with parameter $\lambda=1.945$ lies in the truncated
$V$-cell over $R$.
\end{lemma}

\begin{proof}
Consider a  corner cell at $v$ and a distinguished edge $\{v_1,v_2\}$
forming the boundary of the subregion. The corner cell with parameter
$\lambda=1.945$ is contained in a cone of arcradius
    $\theta = \arc(2,t_0,\lambda)< 1.21 <\pi/2$
(in terms of the function {\it arc\/} of Section~\ref{x-2.8}). Take two
corners $w_1$, $w_2$, visible from $v$, between which the given bounding
edge appears. (We may have $w_i=v_i$). The two visible edges, $\{v,w_i\}$,
have length $\ge 3.2$. (Recall that the distinguished edges at $v$ have
been deformed to length $3.2$.) They have arc-length at least
$\arc(2t_0,2t_0,3.2)>1.38$. The segment of the distinguished edge
$\{v_1,v_2\}$ visible from $v$ has arc-length at most
$\arc(2,2,3.2)<1.86$.

We check that the corner cell cannot cross the visible portion of
the edge $\{v_1,v_2\}$. Consider the spherical triangle formed by
the edges $\{v,w_1\}$, $\{v,w_2\}$ (extended as needed) and the
visible part of $\{v_1,v_2\}$. Let $C$ be the radial projection of
$v$ and $AB$ be the radial projection of the visible part of
$\{v_1,v_2\}$. Pivot $A$ and $B$ toward $C$ until the edges $AC$ and
$BC$ have arc-length $1.38$.  The perpendicular from $C$ to $AB$
has length at least
    $$\arccos(\cos(1.38)/\cos(1.86/2))>1.21>\theta.$$
This proves that the corner cell lies in the cone over the subregion.
\end{proof}

\begin{lemma}
    \oldlabel{4.12.2}
Let $v$ be a concave vertex. The truncated corner cell at $v$ with
parameter $\lambda=1.815$ lies in the truncated $V$-cell over $R$.
\end{lemma}

\begin{proof}
The proof proceeds along the same lines as the previous lemma, with
slightly different constants. Replace $1.945$ with $1.815$, $1.38$ with
$1.316$, $1.21$ with $1.1$. Replace $3.2$ with $3.07$ in contexts giving
a lower bound to the length of an edge at $v$, and keep it at $3.2$ in
contexts calling for an upper bound on the length of a distinguished
edge. The constant $1.86$ remains unchanged.
\end{proof}

\begin{lemma}
    \oldlabel{4.12.3}
The truncated corner cells with parameter $1.6$ in a subregion do
not meet at interior points.
\end{lemma}

\begin{proof}
We may assume that the corners are not adjacent. If a nonadjacent
corner $w$ is visible from $v$, then $|w-v|\ge3.2$, and an
interior point intersection $p$ is incompatible with the triangle
inequality: $|p-v|\le 1.6$, $|p-w|<1.6$. If $w$ is not visible, we
have a chain $v=v_0,v_1,\ldots,v_r=w$ such that $v_{i+1}$ is
visible from $v_i$. Imagine a taut string inside the subregion
extending from $v$ to $w$. The radial projections of $v_i$ are the
corners of the string's path.   The string bends in an angle
greater than $\pi$ at each $v_i$, so the angle at each
intermediate $v_i$ is greater than $\pi$. That is, they are
concave. Thus, by our deformations $|v_i-v_{i+1}|\ge3.07$. The
string has arc-length at least $r \arc(2t_0,2t_0,3.07)>r (1.316)$.
But the corner cells lie in cones of arcradius
$\arc(2,t_0,\lambda)< 1$. So $2(1.0)>r(1.316)$, or $r=1$.  Thus,
$w$ is visible from $v$.
\end{proof}

\begin{lemma}
    \oldlabel{4.12.4}
The corner cell for $\lambda \le 1.815$ does not meet at an
interior point with the $t_0$-cone wedge around another corner
$w$.
\end{lemma}

\begin{proof}
We take $\lambda=1.815$. As in the previous proof, if there is overlap
along a chain, then
    $$\arc(2,t_0,\lambda) +\arc(2,t_0,t_0) > r \arc(2t_0,2t_0,3.07),$$
and again $r=1$.  So each of the two vertices in question is visible
from the other. But overlap implies $|p-v|\le1.815$ and $|p-w|<t_0$,
forcing the contradiction $|w-v|<3.07$.
\end{proof}

\begin{lemma}
    \oldlabel{4.12.5}
The corner cell for $\lambda \le 1.945$ at a corner $v$ satisfying
$|v|\ge2.2$ does not meet at an interior point with the $t_0$-cone
wedge around another corner $w$.
\end{lemma}

\begin{proof}
We take $\lambda=1.945$. As in the previous proof, if there is overlap
along a chain, then
    $$\arc(2,t_0,\lambda) +\arc(2,t_0,t_0) > r \arc(2t_0,2t_0,3.2),$$
and again $r=1$.  Then the result follows from
    $$|w-v|\le |p-v|+|p-w| < 1.945 + t_0 = 3.2.$$
\end{proof}




