%% HYPERMAPS

\chapter{Hypermap}\label{chap:hypermap}

\section{Basics}



\begin{definition}[hypermap]\label{def:hypermap}  A hypermap is a finite set $D$, together with
three functions $e,n,f:D\to D$ that satisfy
    $$e\circ n\circ f = I.$$
The elements of $D$ are called {\it darts}.  The functions $e,n,f$
are called the {\it edge map}, the {\it node map}, and the {\it
face map}, respectively.
\end{definition}


\begin{figure}[htb]
  \centering
  \myincludegraphics{/ps/dart.ps}
  \caption{This symbol represents a dart.}
  \label{fig:dart}
\end{figure}

\begin{remark}\tlabel{rem:hypermap} A hypermap is an abstraction of
the concept of 
planar graph.  Place a dart at each angle of a planar graph $G$.
One function, $f$, 
cycles counterclockwise around the angles of each face.  
Another function, $n$, 
rotates counterclockwise around the angles at each
node.  A third function, $e$, pairs angles at opposite ends of
each edge  (Figure~\ref{fig:hypermap_ex}).   The hypermap extracts
the data $(D,e,n,f)$ from the planar graph and discards the rest.
\end{remark}

\begin{figure}[htb]
  \centering
  \myincludegraphics{\ps/hypermap_ex.eps}
  \caption{Darts mark the angles of a planar graph.  We may
  permute darts about faces, nodes, and edges.}
  \label{fig:hypermap_ex}
\end{figure}

A hypermap satisfies 
  \begin{equation}\tlabel{eqn:triality}
  n\circ f\circ e = f\circ e\circ n = I.
  \end{equation}
Inverted, this triality becomes
   $$
   n^{-1} \circ e^{-1} \circ f^{-1} = (f \circ e \circ n)^{-1} = I.
   $$
This inversion
is the abstract form of the
the duality between nodes and faces in a planar graph.  
Because of
these symmetries in the defining relation, 
there will be multiple versions of 
theorems about hypermaps,
all obtained from one proof by symmetry.

Each function $e,n,f$ is a permutation of $D$.  
We write $\#h$ for the
number of orbits of a permutation $h$ on $D$, and $\#\tangle{e,n,f}$
for the number of orbits of the combined action of functions $e,n,f$
on $D$.   

\begin{definition}[node,~face,~edge,~connected]  A node is an orbit  under
$n$.  A face is an  orbit  under $f$.  An edge
is an orbit under $e$. An orbit of $D$ under $\tangle{e,n,f}$
(the combined action of $e,n,f$) is called a combinatorial component.
A hypermap is connected
if 
  $\#\tangle{e,n,f} = 1$. 
\end{definition}

\begin{definition}[plain,~planar] A hypermap is {\it plain} (note the spelling!) if
$e$ is an involution on $D$ (that is, $e\circ e = I$).  A hypermap
is {\it planar} (note the spelling!) if the Euler relation holds:
    $$\# n + \# e + \# f = \# D + 2 \#\tangle{e,n,f}.$$
\end{definition}

\begin{definition}[degenerate] A dart is degenerate if it is a
fixed point of one of the maps $e,n,f$; otherwise it is nondegenerate.  
%%It is nondegenerate otherwise.
\indy{Index}{degenerate}\indy{Index}{nondegenerate}
\end{definition}

\begin{definition}[simple] 
A hypermap is {\it simple} if the intersection of a face with
a node never contains more than one dart.
\indy{Index}{simple}
\end{definition}


% Moved from cup05_tame.tex section on tame plane graphs. 9/5/07:
\begin{lemma}\guid{ZHQCZLX}\tlabel{lemma:nondegen} 
Let $(D,e,n,f)$ be a simple plain hypermap such that every face has
at least three darts.
Then $n$ has no fixed point.
\end{lemma}

\begin{proof}  For a contradiction, let $x$ be a fixed point of
$n$. We show that $e x$ and $f x$ lie in the same node and
face, so are equal in the simple hypermap.  
They lie in the same node because
$n(f x) = e^{-1} x = e x$. They lie in the same face because
    $$f^2 (e x) =  f(n^{-1} x) = f x.$$
So $e x = f x$.   Thus, $f^2 (e x) = f x = e x$, and $e x$ lies on a
face with at most two darts.  This contradicts what is given.
\end{proof}

\begin{remark}  The Euler relation for hypermaps harks back
to the Euler relation for planar graphs.
Let $G$ be a connected planar graph that satisfies the
Euler relation
    $$V - E + F = 2$$
where $V$ is the number of vertices, $E$ the number of edges, and
$F$ the number of faces of $G$ (including an unbounded face). The
hypermap $(D,e,n,f)$, made from $G$ in
Remark~\ref{rem:hypermap}, is plain.
Moreover,
    $$\begin{array}{lll}
    V &= \# n\\
    E &= \# e\\
    F &= \# f\\
    2E &= \# D\\
    1 &= \#\tangle{e,n,f}\\
    \# n + \#e + \# f &= 
    V + E + F = 2 E + 2 = \# D + 2 \#\tangle{e,n,f}.
    \end{array}
    $$
Thus, the hypermap is also planar. 
\end{remark}


%% WW Used??
%\begin{lemma}\guid{WXEZQZR}\tlabel{lemma:euler-alt}  Let $H$ be a connected plain planar hypermap.
%Let $f_i$ be the number of faces with $i$ darts.  Then
%    $$2 \# n - 2 =  f_3 + 2 f_4 + 3 f_5 +\cdots$$
%\end{lemma}
%
%\begin{proof}  We have
%    $$
%    \begin{array}{lll}
%     \# D &= 2 \# e = 3 f_3 + 4 f_4 + \cdots\\
%    \# f &= f_3 + f_4 + \cdots.
%    \end{array}
%    $$
%Use these equations to eliminate $\#e$, $\#f$, $\#D$ from the Euler
%relation.  The result follows.
%\end{proof}
%


\subsection{walkup}

When we focus on a dart $x$ in a
hypermap, it can be useful to draw a hexagon around $x$ and place
the six darts $e x$,
$n x$, $f x$, $e^{-1} x$, $n^{-1} x$, $f^{-1} x$ at its corners
in Figure~\ref{fig:dart+}.  Some of these $7$ darts may be
equal to one another, even if the figure draws them apart.
Figure~\ref{fig:dart-fix} shows the layout of the darts, when 
a map $e$, $n$, or $f$ fixes $x$.

\begin{figure}[htb]
  \centering
  \myincludegraphics{noimage.eps}
  \caption{A dart $x$ and its entourage}
  \label{fig:dart+}
\end{figure}

\begin{figure}[htb]
  \centering
  \myincludegraphics{noimage.eps}
  \caption{A dart fixed under a face map.}
  \label{fig:dart-fix}
\end{figure}


A {\it walkup} deletes
a dart from a hypermap and remolds the edge, node, and face
maps to produce a hypermap on the reduced set of darts.  Walkups
come in three flavors: edge walkups, face walkups,
and node walkups.

\begin{definition}[walkup]
Let $x$ be a dart in a hypermap.  The edge walkup 
$W_e$ at $x$ of the hypermap is the hypermap
$(D',e',n',f')$, where $D' = D\setminus\{x\}$ and the
the maps skip over $x$:
    $$
    \begin{array}{lll}
    f' y &= \text{ if } (y = f^{-1} x) \text{ then } f x \text{ else
    } f y\\
    n' y &= \text{ if } (y = n^{-1} x) \text{ then } n x \text{ else
    } n y\\
    e' = (n'\circ f')^{-1}
    \end{array}
    $$
\indy{Index}{walkup}
\indy{Index}{edge walkup}
\end{definition}

Figure~\ref{fig:walk} shows
the result of an edge walkup on the hexagon around a dart $x$.
The Triality symmetry~\ref{eqn:triality}, applied to the definition
of edge walkups, yields the definition of
face walkup $W_f$ and node walkup $W_n$.  
Figure~\ref{fig:walkfn} shows the result of the face and node
walkups on the hexagon around a dart $x$.

A walkup at $x$ is said to be degenerate 
if the dart $x$ is degenerate.   
At a degenerate dart $x$, all three walkups
are equal: $W=W_e=W_n=W_f$ (Figure~\ref{fig:walkdeg}).

\begin{figure}[htb]
  \centering
  \myincludegraphics{noimage.eps}
  \caption{The effect of an edge walkup at $x$}
  \label{fig:walk}
\end{figure}

\begin{figure}[htb]
  \centering
  \myincludegraphics{noimage.eps}
  \caption{The effect of face and node walkups at $x$}
  \label{fig:walkfn}
\end{figure}

\begin{figure}[htb]
  \centering
  \myincludegraphics{noimage.eps}
  \caption{The effect of a walkup at a degenerate dart}
  \label{fig:walkdeg}
\end{figure}


\begin{definition}[merge,~split]\tlabel{def:merge-split} Let $h=n,e$, or $f$.
A walkup $W_h$ at $x$ is said to merge,
if the walkup joins the orbit of $h$ through $x$ with another orbit.  
It is said to split, if the walkup splits the
orbit at $x$ into two orbits.
\indy{Index}{split}
\indy{Index}{merge}
\end{definition}

\begin{lemma}\guid{ZMFKZNH}\tlabel{lemma:merge-split} 
Every nondegenerate walkup merges or splits.
The walkup $W_h$ at $x$ merges if and only if $x$ and $y$  lie
in distinct $h$-orbits, where $(h,y)=(f,e x)$.  
(The lemma also holds for $(h,y)=(e,n x)$ and other cases generated
by triality.)
\end{lemma}

\begin{proof} The walkup $W_f$ splits if and only if $f x$ 
(or $x$)
and $e x$ lie in the same $f$-orbit before the split. 
Figure~\ref{fig:split} makes this clear.
\end{proof}


\begin{figure}[htb]
  \centering
  \myincludegraphics{noimage.eps}
  \caption{The face walkup at $x$ mixes $f$-orbits.  If it mixes
  two separate 
  orbits, the orbits merge.  If it mixes a single orbit, 
  the orbit splits.}
  \label{fig:split}
\end{figure}


\subsection{walkup and planarity}

\begin{definition}[planar~index] Define the planar index of a hypermap to be
$$\# f + \# e + \# n - \# D - 2\# \tangle{e,n,f}.$$
(A hypermap with null index is planar.)
\indy{Index}{index}
\indy{Index}{planar index}
\end{definition}

\begin{lemma}\guid{IUCLZYI}\tlabel{lemma:index} Let $x$ be a dart of a hypermap $(D,e,n,f)$. Let $(D',e',n',f')$ be the result of the edge walkup $W_e$ at
a nondegenerate dart $x$.  
The walkup changes the sizes of some orbits.
    $$
    \begin{array}{lll}
    %\text{\bf Non-degenerate dart $x$: }&\\
    \# f &= \# f'\\  
    \# e + \delta' &= \# e'\\
    \# n &= \# n'\\
    \# D - 1&= \# D' \\
    \# \tangle{e,n,f} + \delta&= \#\tangle{e',n',f'},\\
    \end{array}
    $$
where
   $$
   \delta' = \begin{cases}
     1 & W_e \text{ splits }\\
    -1 & W_e \text{ merges}\\
   \end{cases}
   $$
and
   $$
   \delta = \begin{cases}
    0 & W_e \text{ merges }\\
    0 & W_e \text{ splits and } x,nx 
      \text{ belong to the same combinatorial component}\\
    1 & \text{otherwise}.
     \end{cases}
   $$
Moreover, a walkup at a degenerate dart preserves the planar index.
\end{lemma}

\begin{proof} The figures make this clear.
\end{proof}

\begin{lemma}\guid{BISHKQW}\tlabel{lemma:planar-index2}
Let $\iota$ be the index of a  hypermap $(D,e,n,f)$, and
let $\iota'$ be the index after a walkup $W_h$
at a dart $x$.  We have $\iota = \iota' + 2$ when
$x$ is nondegenerate, $W_h$ splits, but the walkup does not
split the combinatorial component through $x$ into two.
Otherwise, $\iota'=\iota$.
\end{lemma} 


%If $x$ is degenerate, then $\iota=\iota'$.
%If $W_h$ merges, then $\iota=\iota'$.
%If $x$ is non-degenerate and and the walkup
%splits, the planar index is preserved iff the walkup splits the 
%combinatorial component through $x$ into two. When the walkup
%does not preserve the planar index, $\iota+2=\iota'$.


\begin{proof}  By triality symmetry, 
we can assume the walkup is an edge walkup.  
Note that
if the combinatorial component splits then
the $e$-orbit also splits.
From Lemma~\ref{lemma:index},
which lists index data, the
relation between $\iota$ and $\iota'$ is easily calculated.
\end{proof}


\begin{lemma}\guid{FOAGLPA}\tlabel{lemma:planar-nonpos}  
The planar index
of a hypermap is never positive.
\end{lemma}

\begin{proof}  An edge walkup never decreases the index.  By a sequence
of edge walkups we reach the empty hypermap, which has
index zero.
\end{proof}


\begin{lemma}\guid{SGCOSXK}\tlabel{lemma:walkup-planar}
Walkups take planar hypermaps to planar
hypermaps.
\end{lemma}

\begin{proof}  
A planar hypermap has maximum index.  The walkup
can only increase the index, but never beyond its maximum.  
Thus, the index remains at its maximum value.
\end{proof}


\subsection{double walkup}

A double walkup is the composite of two walkups
of the same type.  The
two darts for the two walkups 
are to be the members of an orbit of size
two (under $n$, $e$, or $f$).  The first walkup is to be
chosen so that it merges.  The second walkup is
to be degenerate.
By choosing the type of the walkups to be different from the type of
the orbit, the first walkup reduces the orbit to a singleton,
forcing the second walkup to be degenerate. 
 
Here are some examples.
\begin{itemize}
    \item A double $W_n$ along an edge deletes the edge and 
   merges the two endpoints into
    a single node (Figure~\ref{fig:doublenode}). 
    \item A double $W_f$ along an edge 
    deletes the edge and merges the two faces along the edge into
    one (Figure~\ref{fig:doubleface}).
    \item A double $W_e$ at a node of degree two
    deletes the node and merges the two edges at the node into
    one (Figure~\ref{fig:doubleedge}).
\end{itemize}


\begin{figure}[htb]
  \centering
  \myincludegraphics{noimage.eps}
  \caption{The double node walkup applied to an edge}
  \label{fig:doublenode}
\end{figure}


\begin{figure}[htb]
  \centering
  \myincludegraphics{noimage.eps}
  \caption{The double face walkup applied to an edge}
  \label{fig:doubleface}
\end{figure}


\begin{figure}[htb]
  \centering
  \myincludegraphics{noimage.eps}
  \caption{The double edge walkup applied to a node}
  \label{fig:doubleedge}
\end{figure}


\begin{lemma}\guid{HOZKXVW}\tlabel{lemma:dwalk-planar}  
The three preceding double walkups carry plain
hypermaps into plain hypermaps.
\end{lemma}

\begin{proof} The walkups $W_n$ and $W_f$ preserve the orbit
structure of edges, except for dropping one dart.  By dropping both
darts from the same edge, one edge is lost and all others edges
remain unchanged.

For the double $W_e$, we refer to Figure~\ref{fig:doubleedge}.  
If the
original hypermap is plain, then the two darts marked 
$x$ are equal, as are
the two darts marked $y$.  
The new edge map swaps $x$ and $y$, but is 
otherwise equal to $e$ on 
the reduced set of darts $D''$.  
Swapping two darts has order two, 
as we plainly see.
\end{proof}

The following is a useful way to tell if a walkup merges.


\begin{lemma}\guid{FKSNTKR}\tlabel{lemma:ng-merge}  
Suppose, in a simple hypermap, 
that an edge $\{x,y\}$ consists of two nondegenerate darts.  
Then the walkup
 $W_f$ (resp. $W_n$) at $x$  merges.
\end{lemma}

\begin{proof} 
We have $n (f x) = e^{-1} x = e x$. So $f x$ and $e x$ are at the
same node. If they are also in the same face of a simple hypermap, 
this gives $f x = e x
= y$. So $$n y  = n f x = n f e y = y,$$ and $y$ is a fixed
point of $n$, hence degenerate, contrary to assumption.  
Thus, $f x$
and $e x$ are in different faces, and the walkup merges
by Lemma~\ref{lemma:merge-split}.  
\end{proof}




\subsection{contour}

\begin{definition}[contour~path]  A contour path is a function $p:\{0,\ldots,k\}\to D$
such that $p_{i+1} =
n^{-1} p_i$ or $f p_i$ for each $i<k$.  (That is, each
step in the path is clockwise step around a node or a
counterclockwise step around a face.)   If the contour path
is injective on $\{0,\ldots,k-1\}$
and  $p_0 = p_k$, then it is a contour loop.
\indy{Index}{contour path}\indy{Index}{path}
\indy{Index}{contour loop}\indy{Index}{loop}
\end{definition}

\begin{lemma}\guid{KDAEDEX}\tlabel{lemma:connect-contour}  If $x$ and $y$ are darts
in the same combinatorial component, then there exists
a contour path from $x$ to $y$.
\end{lemma}

\begin{proof} 
By being in the same orbit, the darts
$x$ and $y$ are joined by a path, where each step
is $z\mapsto h z$, for $h=e,n$, or $f$.  Eliminate $e$-steps
through the relation $e\circ
n\circ f = I$.   Replace each $n$-step with a sequence of
$n^{-1}$-steps.  This gives the desired path.
\end{proof}

\begin{definition}[M\"obius~contour] A M\"obius contour is an
injective contour path $p$ that satisfies
    \begin{equation}
    \tlabel{eqn:mobius}
    p_j = n p_0\quad p_k = n p_i
    \end{equation}
for some $0 < i\le j< k$ (Figure~\ref{fig:mobius}).
\end{definition}

\begin{figure}[htb]
  \centering
  \myincludegraphics{noimage.eps}
  \caption{A M\"obius contour}
  \label{fig:mobius}
\end{figure}

\begin{figure}[htb]
  \centering
  \myincludegraphics{noimage.eps}
  \caption{A M\"obius contour with three darts}
  \label{fig:3m}
\end{figure}


\begin{remark}
G. Gonthier devised the notion of M\"obius contour
as a way to prove the Four-Color theorem without appeal
to topology.  (The Appel-Haken
proof of the Four-Color theorem relies on the Jordan
curve theorem.)  A M\"obius contour is a 
combinatorial M\"obius strip that
twists to make 
its left-hand side into
its right-hand side.  A planar hypermap has no such contour.  
Figure~\ref{fig:violate-jct}
redraws a violation of the Jordan curve theorem
as a M\"obius contour.   
\end{remark}

\begin{figure}[htb]
  \centering
  \myincludegraphics{noimage.eps}
  \caption{A path that tunnels from the interior to the exterior
   of a simple closed curve
   is analogous to a M\"obius contour.}
  \label{fig:violate-jct}
\end{figure}






\begin{lemma}\guid{LIPYTUI}\tlabel{lemma:no-mobius}  
Planar hypermaps have no M\"obius contours.
\end{lemma}

\begin{proof} For a contradiction, assume that there exist planar
hypermaps with M\"obius contours.  An edge walkup carries
planar hypermaps into planar hypermaps. An edge walkup
at a dart that is not on the M\"obius contour carries the
M\"obius contour to a M\"obius contour 
and reduces the number of darts.  
In the M\"obius Condition~\ref{eqn:mobius},
an edge walkup at a dart that is not at position $0$, $i$, $j$, $k$
along the contour carries the M\"obius contour to a M\"obius contour
and reduces the number of darts. Thus, a counterexample with
the smallest possible number of darts contains no
darts except those on the M\"obius contour, and its only darts
are at positions $0$, $i=j=1$, $k=2$.

This is a three darted hypermap (Figure~\ref{fig:3m}.)  
The M\"obius condition, the
definition of contours, together with $e\circ n\circ f=I$ force
$e=n=f$, all permutations of order three. We reach the contradiction
that this hypermap is not planar:
    $$3 = \# e + \# n + \# f,\quad 5 = 3+2 = \# D + 2 \#\tangle{e,n,f}.$$
\end{proof}


\begin{lemma}\guid{ITBCENB}\tlabel{lemma:node-nonsimple}  
Let $(D,e,n,f)$ be a hypermap with no M\"obius contours.
Let $y$ be a dart at a node $N$.
Suppose that the $f$-orbit of $y$ meets $N$ in
at least two darts.  Then any contour path from $f y$
to $f^{-1} y$ passes through the node $N$. 
\end{lemma}

\begin{proof} Let $F$ be the $f$-orbit of $y$.
Let $i>0$ be the smallest index such that $f^i y\in N$.
By assumption $f^i y \ne y$.
Let $F' = \{y,f y,\ldots f^{i-1} y\}$.
For a contradiction, assume that there is
a contour path  $(f y,\ldots,f^{-1} y)$ that avoids $N$.
Note that $f y\in F'$ and $f^{-1} y\not\in F'$.
%
The contour path has a subpath $(w,x,\ldots,z)$, where
$w\in F'$, $z\not\in F'$,  $x,\ldots\not\in F$.  
We have $x=n^{-1}w$.

We form a path $x$ to $z$ along this subpath, then
follow $f$-steps to $f^i y\in N$, passing through $y$ and
then $n x = w$ along the way.
Then take $n^{-1}$-steps around the node $N$ to $n y$.  This
path is injective.  It follows the order
   $$
   x\ldots y\ldots n x\ldots n y.
   $$
This is a M\"obius contour.
\end{proof}


\begin{definition}[interior]\label{def:interior} 
a dart $y$ lies in the {\it interior} of a contour
loop $L$ if there is a an injective contour path
$x_0,x_1,\ldots,x_k=y$ such that $x_1 = f x_0$ (if $k>0$), and
such that $x_i$ lies on the loop $L$ if and only if $i=0$.
%$P$ is called an interior path from $x_0$ to $y$.
Write $D_{int}(L)$ for the set of darts in the interior of $L$.
\end{definition}

\begin{lemma}\guid{ILTXRQD}\tlabel{lemma:contour-path-type}
Suppose that a hypermap has no M\"obius contours.
Let $L$ be a contour loop.  Let $P$ be any injective contour path
that starts and ends on $L$, but visits no other darts of $L$ inbetween.  
Then the first and last steps of $P$ are both of the same
type ($n^{-1}$ or $f$).
\end{lemma}

\begin{proof}  Suppose $P$ is $n x,f n x,\ldots,n y,y$.   Form
contour path starting at $x$, then $n^{-1}$ steps to $L$, then
follow $L$ to $y$, and on to $n x$.  Follow $P$ back to $n y$.  This
is a M\"obius contour.

Suppose $P$ is $n x,x,\ldots,f^{-1} y,y$.  Form a contour path
starting at $x$, then along $P$ to $y$, along $L$ to $n x$, and
continuing on $L$ to $n y$.  This is a M\"obius contour.
\end{proof}


%\begin{definition}[interior]  Let $L$ be a contour loop on a hypermap.  We say that a dart
%lies in the interior (resp. exterior) of the loop $L$, if there is a
%path $P$ as in the previous lemma starting and ending with $f$ steps
%(resp. $n^{-1}$ steps).
%\end{definition}

\begin{lemma}\guid{UMYSGDB}\tlabel{lemma:dart-interior}
Let $L$ be a contour loop on a plain hypermap without
M\"obius contours.  Assume a dart $x$ lies in the interior of the loop $L$. 
Then every dart in its $f$-orbit lies in
the interior of the loop.  Moreover, if the dart
$x$ does not lie on the same node as any dart in $L$, then every
dart in the $n$-orbit of $x$ lies in the interior 
of $L$.
\end{lemma}

\begin{proof} Let $P= x_0,\ldots,x$ be an injective path that certifies that $x$ lies
in the interior of $L$.  If $f x$ lies along this path already or if it lies on $L$,
then it is clearly interior.  Otherwise, $x_0,\ldots,x,f x$ is a certifying path
for $f x$.  Similarly, use the certifying path $x_0,\ldots,x,n^{-1} x$ for $n^{-1} x$.
\end{proof}


\begin{definition}[interior~face,~node]  A face or a node is interior to a
loop in a hypermap if all of its darts are interior.
\end{definition}

\begin{lemma}\guid{ICJHAOQ}\tlabel{lemma:contour-interior-exterior}
Suppose that a hypermap has no M\"obius contours.  Let $L$ be a contour loop.
Let $x$ be a dart interior to $L$.  Then there does not exist an injective contour path
$$x_0,\ldots,x_k=x$$
such that $x_i$ does not lie on $L$ for all $i$ and such that $x_0$ lies at a node
visited by $L$.
\end{lemma}

\begin{proof} Assume for a contradiction that the path exists. 
We can reverse the path to get a contour path from $x$ back to a dart $x'_0$ (not on $L$ but at a node
visited by $L$).  In fact, Lemma~\ref{lemma:dart-interior}, shows that the interior points consist of $f$-orbits
and $n$-orbits (away from nodes visited by $L$).  Thus an $f$-step from $x_i$ to $x_{i+1}$ can be replaced
with a sequence of $f$ steps from $x_{i+1}$ to $x_i$.  Similarly and $n^{-1}$ step from $x_i$ to $x_{i+1}$
can be replaced with a sequence of $n^{-1}$ steps from $x_{i+1}$ to $x_i$.  When we reach a dart $x'_0$ on a node
visited by $L$ we stop.  

There is a contour path $y_0,f y_0,\ldots,x$ that certifies that $x$ is interior.  Concatenate this
with the reversed path from $x$ back to $x'_0$.  Then add a sequence of $n^{-1}$ steps to reach a dart $z$
on $L$.  Pass to a subsequence to get an injective contour path $y_0,\ldots,z$ that starts with an $f$ step
and ends with an $n^{-1}$ step.  This is prohibited by Lemma~\ref{lemma:contour-path-type} 
\end{proof}


%
%\begin{lemma}\guid{HWQROBK}\tlabel{lemma:dart-n-fixed}
%Suppose that in a nonempty hypermap without M\"obius contours,
%there is a face that coincides with a combinatorial component of
%darts.  Then that face contains a dart that is fixed under $n$.
%\end{lemma}
%
%\begin{proof}  If the face contains a single dart, then it is
%obviously fixed by $n$.  Assume that the face contains at least two
%darts.  For a contradiction, assume that none of the darts is fixed
%by $n$.  Thus, every node contains at least two darts.
%
%We will use the face path $z,f z,f^2 z,\ldots$ to construct a
%M\"obius contour. Since the set of darts is finite, the face path
%must eventually revisit a node already encountered.  Thus, we can
%find a subpath $z',f z',\ldots,f^{k+1} z'$ such that the first $k$
%darts lie on distinct nodes, but $f^{k+1} z'$ and $z'$ lie in the
%same node $A$.
%
%If we had $f^{k+1} z' = z'$, then we have the full $f$-orbit in this
%subpath, and hence also the full component.  We have
%$k>0$, so $f z'$ is then a dart that has no other darts in its node,
%and is hence a fixed-point.  Hence $f^{k+1} z'\ne z'$.
%
%Continue the path further, so that $f^{r+1} z'$ is at the same node
%as some $f^p z'$ (with $p < r$), at a different node than
%$z',\ldots,f^r z'$, but so that the only repeated node among
%$z',\ldots,f^r z'$ is the one at $z'$.  We have $0 < p$.
%
%If $f^{r+1} z' = f^p z'$, then $f^{r+1-p} z' = z'$ so all darts are
%in the segment $z',f z',\ldots,f^{r-p} z'$ and the only node with
%more than one dart is the one at $z'$.  Thus, we have a fixed point.
%So $f^{r+1} z'\ne f^p z'$.
%
%Let $0 < k_1 < k_2 < \cdots < k_m < r+1$ be the indices at which
%$f^{k_i} z'$ is at $A$.  Let $x = n^{-1} f^{k_m} z'$. If the segment
%$x,n^{-1} x,\ldots,z'$ contains some $f^{k_i} z'$, we obtain a
%M\"obius contour.  [X DETAIL.]  Take $n^{-1}$ steps from $x$ to
%$z'$. Then take $f$-steps to $y = f^p z'$, on to $n x = f^{k_m} z'$,
%on to $f^{r+1} z'$, then $n^{-1}$ steps to $n y$.  This is a
%M\"obius contour.
%\end{proof}
%
%\begin{lemma}\guid{KHVQHCT}[Jordan curve theorem for hypermaps]\tlabel{lemma:jct-hypermap}
%  If a plain hypermap
%has no M\"obius contours then it is planar.
%\end{lemma}
%
%\begin{proof}  Face double walkups along edges preserve the planar
%index.  By repeated application, we reduce to the case where every
%component contains a single face. In
%other words, $f$ acts transitively on the darts in a given combinatorial component.
%
%If there are any darts that are fixed by all three maps $e,n,f$,
%then the walkup at that dart eliminates the dart while preserving
%the planar index.  Thus, we may assume there are no such darts.
%
%If there are any darts that are fixed points under $n$, then the
%dart is degenerate.  The double walkup (of any type) along the edge
%that meets that dart eliminates the dart while preserving the planar
%index.  Thus, we may assume that there are no such darts.
%
%By the previous lemma, the plane hypermap must be empty.  Thus, our
%planar-index preserving walkups have transformed an
%arbitrary plane hypermap without M\"obius contours into the empty
%hypermap, which is clearly planar.  The result follows.
%\end{proof}
%




\section{Quotient}


\begin{definition}[isomorphic] Two hypermaps $(D,e,n,f)$ and $(D',e',n',f')$ are
isomorphic, if there is a bijection $F:D\to D'$ such that
    $$h'\circ F = F\circ h$$
for $(h,h')=(e,e'), (f,f'), (n,n')$.
\end{definition}


\begin{definition}[normal~collection]
Let $H$ be a hypermap. Assume that 
there are no darts fixed by $e$ 
(so that we can distinguish $f x$
from $n^{-1} x$ at each dart). 
Let $\cal L$ be a collection of contour
loops.  We say that $\cal L$ is a normal collection if the following
conditions hold of its loops. \begin{itemize}
 \item No dart is visited by two different loops.
 \item Every loop visits at least two nodes.
 \item If a loop visits a node, then every dart at that node is
 visited by some loop.
\end{itemize}
\end{definition}

From a normal collection we can form a new hypermap.   A dart in the
new set $D'$ of darts
$D$ is a maximal sequence $[x,n^{-1} x, n^{-2} x,\ldots,n^{-k} x]$
    of $n^{-1}$ steps appearing in some loop in $\cal L$.
The map $f'$ takes the maximal sequence
    $[x,n^{-1}x,\ldots,y]$ to the maximal
   sequence (in the same contour loop) starting 
    $[f y,\ldots]$.
The map ${n'}^{-1}$ takes the maximal sequence
    $[\ldots,y]$ to the maximal sequence (in some other contour loop)
starting $[n^{-1}y,\ldots]$. Equivalently, 
$n'$ takes the maximal sequence
$[x,\ldots]$ to the maximal sequence ending $[\ldots,n x]$. The map $e$ is
defined by $e'\circ n'\circ f' = I$.  

\begin{definition}[quotient]  The hypermap constructed from the normal collection
is called the quotient of $H$ by $\cal L$, and is denoted $H/{\cal
L}$.  The hypermap $H$ is said to be a cover of $H/{\cal L}$.
\end{definition}

Intuitively, we can represent the quotient hypermap as a graph whose
cycles under $f$ 
are precisely the contour loops in the normal family (Figure~\ref{fig:quot}).

%% No sketch has been made for this.
\begin{figure}[htb]
  \centering
  \myincludegraphics{noimage.eps}
  \caption{The contour loops in a normal 
   family become faces in the
   quotient}
  \label{fig:quot}
\end{figure}


\begin{example}\label{ex:Hall} 
Assume that $H$ is a hypermap with no fixed points under $e$.
Assume that every face visits at least two nodes.
Then the set of all faces
defines a normal collection of contour loops (follow $f$ around each face:
$x,f x,\ldots$).  Each dart of the quotient is then just a singleton
set consisting of a single dart of $H$, and the quotient is
isomorphic to $H$ itself.
\end{example}

\begin{example}\label{ex:H2} 
Assume that $H$ is a hypermap with no fixed points
under $e$.  Let $F = (x,f x,\ldots)$ be a face 
that visits at least
three nodes and that meets each node in at most one dart.
Let $\cal L$ be the
collection with two contour loops:  $(x,f x,\ldots)$ and its
complement
$$[n^{-1} x,
n^{-2} x,\ldots,n x,f n x = y,n^{-1} y, n^{-2} y,\ldots, n y, f n
y,\ldots]
$$
(See Figure~\ref{fig:contour-comp}.) 
The family $\cal L$ is normal.
The quotient hypermap $H/{\cal L}$ has two faces $F$ and a
backside $F'$ of the same cardinality $k$.
\end{example}


\begin{figure}[htb]
  \centering
  \myincludegraphics{noimage.eps}
  \caption{The complementary contour loop traces the remaining darts
   at the same nodes as the origonal contour loop.}
  \label{fig:contour-comp}
\end{figure}


\begin{example}\label{ex:H2k} 
We 
construct a
hypermap $H_{2k}$, whose darts are arranged in two faces.  Each
face is $Z_n$, a cyclic group of order $n$ with generator $1$.
The face map is $x\mapsto x+1$.
The node map swaps the two faces $Z_n$.
The usual condition $e\circ n\circ f = I$ defines the edge map.
If a hypermap is isomorphic to $H_{2k}$ for
some $k$, then we say that it is {\it cyclic}.  For example,
the hypermap constructed in the previous example is cyclic.
\indy{Index}{cyclic hypermap}
\end{example}

\begin{lemma}\guid{JMKRXLA}\tlabel{lemma:quotient-plain}
Let $H$ be a plain hypermap, and let $\cal L$ be a
normal family.  Then $H/{\cal L}$ is a plain hypermap.
\end{lemma}

\begin{proof} Let $e'$, $f'$, and $n'$ be the edge, face, and node maps on the
quotient hypermap.  Write $[\ldots, x]$ for the node in the quotient
ending in dart $x\in H$ and $[x,\ldots]$ for the node in the quotient
starting with dart $x\in H$.  We have $e^2 x = x$, so that for any
dart $[\ldots x]$ in the quotient:
    $$\begin{array}{lll}
    {e'}^{-2} [\ldots, x] &= n' f' n' f' [\ldots, x] = n' f' n' [f x, \ldots] \\&=
    n' f' [\ldots, n f x] = n' [f n f, \ldots] = [\ldots, n f n f x]\\ &=
    [\ldots, e^{-2} x] = [\ldots, x].
    \end{array}$$
Thus, $e'$ has order $2$ on the quotient.
\end{proof}

%\begin{lemma}\guid{ZOKKAOI}\tlabel{lemma:quotient-planar}
%Let $H$ be a plain planar hypermap, and let $\cal L$
%be a normal family.  Then $H/{\cal L}$ is a plain planar hypermap.
%\end{lemma}
%
%\begin{proof} Suppose $H/{\cal L}$ is not planar.
%Let $P$ be a M\"obius contour on $H/{\cal L}$.  It lifts uniquely to
%a contour on $H$ with the property that the darts visited on $H$ are
%precisely the darts that belong to a dart in the quotient.  This is
%compatible with the node map $n$.  So the contour path lifts to a
%M\"obius contour on $H$.  Thus, $H$ is not planar.
%\end{proof}


\subsection{flag}

By the end of the chapter, we present an algorithm that
generates all plain planar hypermaps satisfying certain general
conditions.   The algorithm  proceeds by inserting one face
at a time into a hypermap.  
The algorithm  marks certain faces as `true.'
Roughly, this  means that the the face cannot be modified
at any later stage of the algorithm.   When all of its faces
are true, the hypermap stands in final form.
The function that marks each face as true or false is a
{\it flag}.


\begin{definition}[flag]  A flag on a hypermap
is a boolean function on its set of faces 
that satisfies the following two
constraints.
\begin{itemize}
    \item If darts $x,y$ belong to true faces,
    then there is a contour path from $x$ to $y$ that remains
    in true faces.
    \item Every edge of a false face is shared with a true face.
    \end{itemize}
%An isomorphism of flagged hypermaps is an isomorphism of
%hypermaps that respects the flags.
\end{definition}

\begin{example} Let $H/{\cal L}$ be a quotient hypermap with
normal family $\cal L$.  The canonical boolean function
$\phi$ on the set of faces of the quotient is the function that
is true exactly when every dart in
the face is a singleton of $H$.
\end{example}

\begin{example} The cyclic hypermap of Example~\ref{ex:H2k}, 
carries a flag
that marks one face true and the other false.
\end{example}

\begin{example} Let 
$H$ be a connected, plain hypermap, and 
such that $e$ has no fixed points,
and let $\cal L$ be the example of Example~\ref{ex:Hall}, 
then the canonical
map takes value $\op{true}$ on every face.  This is a flag.
In fact,
Lemma~\ref{lemma:connect-contour} provides the contour paths 
that are required in the definition of flag.
\end{example}

\begin{lemma}\guid{STKBEPH}\tlabel{lemma:all-dart}  
Let $H$ be a hypermap with normal family ${\cal L}$.
If the canonical boolean function on the set of faces of
$H/{\cal L}$ has at least as many
true values as there are faces of $H$, then $\cal L$ is the normal family
in Example~\ref{ex:Hall}. In particular, $H/{\cal L}$ is isomorphic to $H$.
\end{lemma}

\begin{proof}  If a face takes value $\op{true}$ 
in $H/{\cal L}$, then its darts are
singletons, and the face of $H/{\cal L}$ is naturally identified with
 a face in $H$.  This is an injective map from the 
set of true faces of $H/{\cal L}$ to
the set of faces of $H$.  The hypothesis of the lemma implies that this
injective map is bijective.
All of the darts of $H$ are accounted for under this bijection.
Thus, the quotient has no
false faces.  The result follows.
\end{proof}


\subsection{face insertion}


In this section, we describe an inductive construction of all
connected, plain, planar hypermaps that satisfy certain constraints.
We define a set ${\cal H}$ of tuples $(H,\phi,E,N,\lambda)$.
The tuples are assumed to satisfy the following conditions:
\begin{itemize}
    \item $H$ is a hypermap.
    \item $\phi$ is a flag on $H$.
    \item $E$ is an edge of size two, with one
    dart in a true face and the other in a false face.
    \item $N$ is the size of the false face meeting $E$.
    \item $\lambda$ is a finite increasing sequence of natural numbers:
        $$
        \lambda = (\lambda_1,\lambda_2,\ldots,\lambda_r)
        $$
    such that $\lambda_1 = 1$ and $\lambda_r \le N-1$.
\end{itemize}

We define a function from $\cal H$ to the set of hypermaps with
flags.  We call it face insertion, because the function creates a
hypermap with one more true face than its source hypermap $H$.

We write $x_0$ for the dart of $E$ in the
false face and $y_0$ for the dart of $E$ in the true face.  
Write $f^i
x_0 = x_i$ for the darts in the false face.  (Set $x_N = x_0$.)

\subsection{partition transformation}

We describe an algorithm $\lambda\mapsto A(\lambda)$ that takes
as input a partition $\lambda$ (and the number $N$)
and produces as output a list of
tuples.
In the first step of the algorithm,
replace each $\lambda_j$ except for the
first occurrence of a given natural number by a dummy symbol $*$.
Insert $N$ at the end of the list. For example, if $N=7$,
    $$(1,1,1,2,3,3,3,5,5)$$ becomes
    $$(1,*,*,2,3,*,*,5,*,7).$$

Next, break the sequence at each natural number (except at the initial $1$
and terminal $N$)
creating shorter sequences, duplicating the number at the break,
so that each sequence begins and ends with a natural number,
and is padded inbetween with dummy symbols. So
    $$(1,*,*,2,3,*,*,5,*,7)$$ becomes
$$(1,*,*,2),\ (2,3),\ (3,*,*,5),\ (5,*,7).$$

Next,
delete any ordered pair of the form $(j,j+1)$. In our example, there
is one such ordered pair: $(2,3)$.  Our example becomes
  $$
  (1,*,*,2),\  (3,*,*,5),\ (5,*,7).
  $$
This list of tuples is the output from the algorithm.
In our example,
  $$A(1,1,1,2,3,3,3,5,5) = ((1,*,*,2),(3,*,*,5),(5,*,7)).$$



\subsection{new hypermap}

This output $A(\lambda)$
becomes an instruction for how to draw new edges to create a
new hypermap. A tuple $(j,*,*,\ldots,*,k)$ with $r$ dummy symbols
is an instruction to insert an edge between darts $x_j$ and $x_k$
and then to insert $r$ new nodes along this edge.
Expressed in terms of double walkups, we first apply (in
reverse) the double walkup $W_f$, and then apply $r$ times (in
reverse) the double walkup $W_n$.  Each tuple creates $r$ new
nodes, one new face, and $r+1$ new edges.  This action, 
iterated over all the tuples in $A(\lambda)$, creates a new hypermap
$H'$. 
The function that carries
$(H,\phi,E,\lambda)$ to $H'$ is called
face-insertion.  
Figure~\ref{fig:7darts} gives an example.


\begin{figure}[htb]
  \centering
  \myincludegraphics{noimage.eps}
  \caption{Face-insertion on a $7$-gon when
   $A(\lambda) = ((1,*,*,2),(3,*,*,5),(5,*,7))$.}
  \label{fig:7darts}
\end{figure}


The double node and face walkups preserve edges (except for
the one that the walkup removes).
Thus, the edge $E=\{x_0,y_0\}$
becomes an edge $\{x_0',y_0'\}$ in $H'$
(with $y_0$ corresponding with $y'_0$).

We mark the face containing the dart $x'_0$ true, and the other
faces created by face-insertion false.   All other faces are
marked true or false as in the flag on the originating hypermap $H$.  
Through this
construction, the $H'$ contains exactly one more true face
than the originating hypermap.

\begin{lemma}\guid{AQIUNPP}\tlabel{lemma:flag} 
The boolean function on faces constructed in this way is a
flag.
\end{lemma}

\begin{proof}  We show first that every edge of a false face is shared
with a true face.  If the false face is one of the newly created
faces, its edges are those along the new true face together
with some edges from the old false
face. Either way, the edges are shared with a true face.   If it is a
false face from the originating hypermap $H$, 
it shares edges with the
same true faces as before.

Next, we show that every pair of darts $x,y$ in true faces can be
joined by a contour path.  Let $H'=(D',e',n',f')$.  
If neither of $x,y$ lies in the
$f'$-orbit of $x'_0$, we can use the contour path that was used in the
originating hypermap.  If both are in the $f'$-orbit of $x'_0$, then
we can join $x$ to $y$ by a sequence of $f'$-steps.

If $x$ lies in the $f'$-orbit of $x'_0$, but $y$ does not, 
we first join $x$
to $x'_0$ by $f'$-steps, then to $n'^{-1} x'_0= f' y'_0$, then to $y'_0$,
which lies in a true face.
From $y'_0$, we follow a path $y$.
Similarly, if $y$ lies in the $f'$-orbit of $x'_0$ but $x$ does not; 
we follow a contour path from $x$ to $y'_0$, then to $n'^{-1} y'_0 = f'
x'_0$, then to $y$.
\end{proof}

\subsection{generating hypermap}

The following lemma
and the remark that follows are the principal results of the
chapter.  They present an algorithm that 
generates all nice planar hypermaps by face-insertions.
This book uses the algorithm to classify of a family of
planar hypermaps, called {\it tame hypermaps}.

\begin{theorem}  Let $H$ be a hypermap with the following properties:
    \begin{enumerate}
        \item It is connected, plain, planar, simple.
        \item The edge map $e$ has no fixed points.
        \item The node map $n$ has no fixed points.
        \item The size of every face is at least $3$.
        \item There are at least $2$ faces. 
        %%  (All hypoth. Needed?)
    \end{enumerate}
Let $\cal L$ be a normal family of contour paths in $H$ with
simple quotient. Assume that
the canonical boolean function $\phi$ on $H/{\cal L}$ is a flag. Let
$E$ be an edge of $H/{\cal L}$ that meets both a true face
and a false face. Let $N$ be the cardinality of that false face. Let
$M$ be a constant such that every face of $H$ has cardinality at
most $M$. Then there is exists a partition $\lambda=(\lambda_1,\ldots,\lambda_r)$ with at most
$M$ parts satisfying $$1=\lambda_1\le \cdots\lambda_r \le N-1$$
and a normal family
${\cal L}'$ with simple quotient such that $H/{\cal L}'$  such that
with its canonical boolean
function is isomorphic to the image of face-insertion on
$(H/{\cal L},\phi,E,N,\lambda)\in {\cal H}$. 
Moreover, $H/{\cal L}'$
has one more true face than $H/{\cal L}$ has.
\end{theorem}

\begin{remark}
\label{remark:nice-algorithm} 
The lemma implies that sufficiently nice hypermaps can be recovered
from their quotients by face insertions.  (Here {\it `nice'} means
that it satisfies the conditions of the lemma.)  
Every nice hypermap has a cyclic quotient 
$H_{2k}=H/{\cal L}_0$
(Examples~\ref{ex:H2} and~\ref{ex:H2k}).
Generate all face-insertions of $H/{\cal L}_0$ 
(as we run over relevant partitions).
Among the new hypermaps is some $H/{\cal L}_1$, which
has one more $\op{true}$ face than $H/{\cal L}_0$.  By 
Lemma~\ref{lemma:flag}, 
the canonical boolean function on this new quotient
is a flag.  Iterate to get a sequence
$H_{2k} = H/{\cal L}_0, H/{\cal L}_1,\ldots, H/{\cal L}_k$,
each obtained from the previous one by face-insertion.
By Lemma~\ref{lemma:all-dart}, 
as
soon as a quotient $H/{\cal L}_k$ 
has sufficiently many true faces, it is
isomorphic to the the original hypermap $H$, and the process
terminates.
Note that we choose the edge at which we apply the face
insertion, but we must run through
all partitions.  To make the entire process finite, we can bound the
number of partitions that must be considered, say by placing a
priori bounds $M$ on the cardinalities of the faces of $H$.
\end{remark}

\begin{proof}  We set some notation.
Write $f,e,n$ for the maps on $H$ and $f',e',n'$ for the maps on the
quotient hypermap.   
The dart $y'$ of $E$ that 
lies on the true face is a
singleton set, which can be identified with a dart $y$ in $H$.  Let
$y_0 = e y$, and let $y_k = {f}^k y_0$ be the darts of $H$ on the
face of $y_0$ (Figure~\ref{fig:algordart}).  
Let $r$ be the size of this face. 

We define a map $\psi$.
Let $*$ be a symbol.
A map
$\psi$ on the face of $y_0$ sends 
$y_i$ to $*$ if $y_i$ is disjoint from
the loops of ${\cal L}$ and sends $y_i$
to the dart of $H/{\cal L}$
containing $y_i$ otherwise.
As $H$ is simple, no two darts
$y_k$ map to the same dart in $H/{\cal L}$.
\begin{figure}[htb]
  \centering
  \myincludegraphics{noimage.eps}
  \caption{An example of the algorithm}
  \label{fig:algordart}
\end{figure}

We can write the map $\psi$ in terms of a map $\psi'$ on indices.
Let $x_0 = e' y'$ and let $x_k = {f'}^k x_0$.  Let $r'$ be the
cardinality of the $f'$-orbit through $x_0$.  
We claim that (1) $\psi(y_i)$ is either $*$ or one of the
darts $x_k$.  We justify this claim below.
When $\psi(y_i)$ is a dart, set $\psi(y_i) =
x_{\psi' i}$, for some $0< i \le r$, $0 < \psi' i \le r'$. 
When $\psi(y_i)$ is not a dart,
set $\psi' i = *$, 
We claim further that (2) if
$0< i< i'\le r$, and both $\psi(y_i)$ and $\psi(y_{i'})$ are darts, then
$\psi' i < \psi' i'$.  We justify this claim below.
Accepting these two claims, we complete the proof.    

We construct a partition $\lambda$.
Form a sequence
    $$(\psi' 1,\psi' 2,\ldots,\psi' r).$$
Form a partition $\lambda$ from this sequence, 
by replacing each $*$ in the
subsequence $(j,*,*,\ldots,*)$ with $j$. Thus,
    $$(1,*,*,2,*,4,*,*,5)$$
becomes
    $$(1,1,1,2,2,4,4,4,5).$$
Face-insertion on $(H/{\cal L},\phi,E,N,\lambda)$ yields a new
hypermap $H'$.  

We claim that $H'$ is isomorphic to a quotient
$H/{\cal L}'$, which is specified as follows. The collection
${\cal L}'$ contains all the loops of ${\cal L}$ 
except the loop through the $f'$-orbit of $x_0$.  The collection
${\cal L}'$ also contains
the loop corresponding through the $f$-orbit
of $y_0$ as well as the loops through the false faces on
the new hypermap.  

We describe the contour loops associated with false faces 
in more detail.
The false faces on the new hypermap give a
contour loop of ${\cal L}'$ for each subsequence
$(j,*,\ldots,*,j')$ with $j< j'$ 
and one for each subsequence $(j,j')$ with
$j+1< j'$.  
First take the case $(j,j')$, with $j+1<j'$. 
Write $(j,j') = (\psi'i,\psi' i')$.
The inequality $j+1<j'$ implies that both $n^{-1}
y_i$ and $n y_{i'}$ are in $x_j$ and $x_{j'}$ respectively.
The contour loop for $(j,j')$ runs through 
all the darts of $x_k$ for $j<k<j'$,
the sequence of darts of $x_{j'}$ ending with $n y_{i'}$,
and the sequence darts of $x_j$ starting with $n^{-1} y_i$.

We continue with our description of the contour loops associated
with false faces.
In the case $(j,*,\ldots,j')$, we form consecutive sequences of darts
starting with $n^{-1} y_i$ and another ending at 
$n y_{i'}$ as in the previous case, and
all the darts of $x_k$ for $j<k<j'$, 
Each $y_k$, for $i < k < i'$ belongs to a node $N_k$ in $H$.
We also have the loop visit the darts in $N_k\setminus\{y_k\}$.

Now that the collection ${\cal L}'$ has been described in detail,
it is a routine matter to check that the quotient $H/{\cal L}'$
has the properties asserted in the lemma.
%
%{\bf Claim 1}:  % revised 26/10/07: 
%The proof is now complete except for two earlier claims.  We claim
%that $\psi(y_i)$ is either $*$ or one of the darts $x_k$. 
%For a contradiction, 
%suppose that the dart $z$ of $H/{\cal L}$ containing
%$y_i$ is not equal to any $x_k$.
%Let $L$ be the $f'$-orbit
%of $x_0$.  This is a false face.  This implies that some
%dart of $L$ has the form $x_p=[\ldots,y_q,n^{-1} y_q,\ldots]$.
%Set $x = n^{-1} y_q$.  The face $L$ has a dart of the form 
%$[y_1,\ldots]$.
%Set $y=y_1$.  The dart $n y$ lies in a true face.
%Start at $x$ and follow the darts of $H$ around the contour $L$ 
%to $n x = y_q$, passing through $y$ along the way.  From
%$y_q$, take $f$-steps to $y_i$ in $z$, 
%then step around that node to a true face
%of $H/{\cal L}$.  From there,
%follow a path along true faces (as guaranteed by the definition
%of flag) to $n y$.  The path follows the order
%   $$x \ldots y \ldots n x \ldots n y.$$ 
%We may assume that the path from $y_q$ to $y_i$ is minimal in the
%sense that the $f$-steps between $y_q$ to $y_i$ 
%are darts that map to $*$.  
%% We can clearly cut away from the end if there is another dart
%% like $y_i$.  We can cut away from the front if there is another
%% dart that maps to some x_k.
%% Injective because the 
%With this extra condition, the contour
%is injective and hence a M\"obius contour in 
%the planar hypermap $H$.  
%This contradicts Lemma~\ref{lemma:no-mobius}.
%
%%% 
%{\bf Claim 2}: 
%We claim further that if $i<i'\le r$, and both $\psi(y_i)$ and
%$\psi(y_{i'})$ are darts, then $\psi' i < \psi' i'$.  
%For a contradiction, assume that $\psi' i' \le \psi' i$. 
%In fact, we may assume that $\psi'i' < \psi' i$, because
%each dart of the face of $y_0$ lies at a different node. 
%We may assume that $\psi' j = *$ for $i < j < i'$.  We may
%also assume that the indices $\psi' 1,\psi' 2,\ldots,\psi' i$
%(excluding those that are $*$) are increasing.  
%That is we pick $i$ and $i'$ so that we have the longest
%possible run of increasing indices, terminated by a falling
%index.
%%Form a contour loop
%%$L'$ from $y_1$ along the darts $y_{i'}$ until reaching $x_{\psi' i}$,
%%then continuing for the rest of the path of $L$ back to $y_1$.
%%Giving the identical argument as in the preceding paragraph, but
%%using $L'$ instead of $L$, we again get a M\"obius contour $H$.  
%%Again, we contradict Lemma~\ref{lemma:no-mobius}.
%Let $L$ be the $f'$-orbit of $x_0$.  The is some dart of $L$
%of the form $x_p = [\ldots,y_q,n^{-1}y_q,\ldots]$, with
%$i\le q< i'$.  Let $x = n^{-1}y_q$.  Let $y= y_1$.  The
%dart $n y$ lies in a true face.  Start at $x$ and
%follow the darts of $H$ along $L$ to $y$, then take
%$f$-steps to $y_i$, follow the darts along $L$ to $n x =y_q$.
%Then take $f$-steps again to $y_{i'}$.  Take $n^{-1}$-steps
%around that node to a dart that lies on a true face.  Follow
%true faces back to $n y$.  The path follows the order
%  $$
%  x\ldots y \ldots n x\ldots n y.
%  $$
%  With these
%extra conditions, the contour
%is injective and hence a M\"obius contour in 
%the planar hypermap $H$.  
%This contradicts Lemma~\ref{lemma:no-mobius}.

{\bf Claims 1 and 2:}\FIXX{Check once more.}
The proof is now complete except for two earlier claims.  We claim
that $\psi(y_i)$ is either $*$ or one of the darts $x_k$ and that the darts
$x_k$ have increasing indices.  If the claim is false, then
we can find a counterexample with smallest index.  That is, if we remove
from the list
   $$
   \psi(y_1),\psi(y_2),\ldots,\psi(y_{i'-1})
   $$
those that equal $*$, then we are left with an increasing sequence of 
darts $x_k$.  But no larger index $i'$ has this property.  Thus, either
$\psi(y_{i'})$ is a dart that is not of the form $x_k$ or has this form
but with a drop in index $k$.  Let $i\le i'-1$
be the largest index for which $\psi(y_i)=x_k$ for some $k$.
The dart $x_k$ has the form $[\ldots,y_i,n^{-1}y_i,\ldots]$.  Let $x=n^{-1}y_i$.
Let $y=y_1$.  The dart $n y$ lies in a true face.

Let $L$ be the $f'$-orbit of $x_0$.  This is a false face.
Start at $x$, follow a contour path along $L$ until reaching $y$, then
take $f$-steps from $y$ to $y_{i'}$, passing $y_i = n x$ along the way.
One of the loops of the collection ${\cal L}$ passes through the the node of $y_{i'}$.
Take $n^{-1}$-steps at that node until a dart in a true face is reached.  Then
follow a contour path through true faces (as guaranteed by the definition
of flag) to $n y$.  
This contour path follows the order
  $$
  x\ldots y \ldots n x\ldots n y.
  $$
Since we picked the indices $i,i'$ to give the smallest counterexample, it can be checked
that this contour path is injective and hence a M\"obius contour in 
the planar hypermap $H$.  
This contradicts Lemma~\ref{lemma:no-mobius}.
\end{proof}







%%%%%%%%%%%%%%%%%


\chapter{Fan}

A hypermap is a combinatorial object, but a packing
is a geometric object.  This chapter combines the combinatorics
with the geometry, as objects called fans.  A fan is a geometric
object, yet there is a hypermap attached to it,
which encodes the combinatorial properties of the fan.

%\begin{definition}[azimuth cycle]  Let $v\in\ring{R}^3$ and $W \subset
%\ring{R}^3$.  We say that $\sigma:W\to W$ is an azimuth cycle on $W$
%coming from $v$, if there is a orthonormal $2$-frame $P=(0,e_1,e_2)$
%with $e_1 \times e_2 = v/\normo{v}$, and a cycle is $\sigma:W\to W$ with
%respect to $P$. (By REF%%, an azimuth cycle is unique, but may not
%exist.)
%\end{definition}

%[ change the following definition, so that edges are triples
%$(v,w,u)$, where $u$ is a unit point orthogonal to $v$ and $w$.
%Assume that if $(v,w,u)\in E$ then $(w,v,-u)\in E$.  We then ask for
%an azimuth cycle on the points $u\times v$ rather than on the
%points $w$.  The third element $u$ allows for the case that the $v$
%and $w$ are antipodal, or the long end of a great circle, which is
%convenient for some of the proofs. In standard situations, we can
%just take $u$ to be the unit length point in the direction $v\times
%w$.  This change ripples through the text.  For instance, the proof
%that  $\#c = \#f$ for linear graphs reduces all the way down to the
%case of a single plane.]

If $e=\{v_1,v_2\}$ is a set of two points and $v$ is any other point,
set
  $$
  \begin{array}{lll}
  C(v,e) &= \op{aff}_+(v,e)\\
  C^0(v,e) &= \op{aff}^0_+(v,e)\\
  \end{array}
  $$
%We drop the $v$ from the notation, when it is clear from context,
%and write $C(e), C^0(e)$.
% Note that the base point is always variable $\orgn$.

\begin{definition}[fan]  Let $(\orgn,V,E)$ be a triple consisting of a point,
a set of
points, and a set of pairs of elements of $V$.  The triple is said to be
a {\it fan\/} if the following conditions hold.
    \begin{itemize}
    \item $V$ is finite and nonempty.
    \item $\orgn\not\in V$.
    %\item Each element of $E$ has two elements.
    \item For each $v\in V$, the set
        $$
        %% WW changed notation from E_v to E(v) to allow deformations E_t
        E(v) = \{w\in V\mid \{v,w\}\in E\}
        $$
        is cyclic with respect to $(\orgn,v)$.
    \item For each $e\in E$, $V\cap C^0(\orgn,e)=\emptyset$.
    \item For sets $e,e'\in E$,   we have
        $$C^0(\orgn,e) \cap C^0(\orgn,e')\ne\emptyset\ \Rightarrow (e = e').$$
    \item For $v,v'\in V$, we have
      $$\op{aff}^0_+(\orgn,v) = \op{aff}^0_+(\orgn,v')\ \Rightarrow (v=v').$$
      %% Added condition May 15, 2009.
    \end{itemize}
Call $C^0(\orgn,e)$ or $C(\orgn,e)$ a {\it blade\/} of the fan.
\indy{Index}{blade}
\indy{Index}{fan}
\end{definition}

We make a series of remarks about this definition.

\begin{remark}\tlabel{rem:fan}\rating{30}
\begin{itemize}
\item The point $\orgn$ is a base point that will be fixed throughout
the chapter.  
\item The pair $(V,E)$ is a graph with nodes $V$ and edges $E$.  The set
$E(v)$ is the set of edges around a fixed node $v$.
Note that $w\in E(v)$ if and only if $v\in E(w)$.   
%
\item The final condition implies that the sets $C^0(\orgn,e)$
do not meet.   This condition will eventually yield planar
hypermaps.
%
\item
By the condition that $E(v)$ should be cyclic,
for each $v\in V$, we have an azimuth cycle $\sigma(v):E(v)\to E(v)$.
We allow $E(v) = \{w\}$ to be a
singleton set. If so,
$\sigma(v)$ is the identity map on $E(v)$.
%
\item
Sometimes we write $\sigma(v,w)$ for $\sigma(v)(w)\in E(v)$.
%
\item 
The hypothesis of an azimuth cycle
prevents $\{\orgn,v,v'\}$ from being a collinear set, when $\{v,v'\}\in
E$.  In particular, there are no loops: $\{v,v\}\not\in E$.
%
\end{itemize}
\end{remark}



\section{Topology}\label{sec:topology}

Let $(\orgn,V,E)$ be a fan.  We define sets of darts $D_1,D_2,D$:
    $$
    \begin{array}{lll}
    D_1 &= \{(\orgn,v,w,w')\mid v\in V,\ w\in E(v),\ w' = \sigma(v,w)\}\\
    D_2 &= \{(\orgn,v) \mid v\in V,\ \ E(v) = \emptyset\},\\
    D   &= D_1\cup D_2.
    \end{array}
    $$
We call $D_1$ the reduced set of darts and $D$ the extended set of darts.
%
We define a permutation $n$ on $D_1$ by
    $$n(\orgn,v,w,w') = (\orgn,v,w',\sigma(v,w')).$$
We define a permutation $f$ on $D_1$ by
    $$
    f (\orgn,v,w,w') = (\orgn,w,\sigma(w)^{-1} v,v).
    $$
Define a permutation $e$ on $D_1$ by
    $$
    e (\orgn,v,w,w') = (\orgn,w,v,\sigma(w,v)).
    $$
(Note that the symbol $e$ has two meanings according to context, both
as the edge permutation and as an element of $E$.)
Define permutations $e,n,f$ on $D_2$ by making them degenerate on $D_2$:
    $$
    e (\orgn,v) = n(\orgn,v) = f(\orgn,v) = (\orgn,v).
    $$
Write $\op{hyp}_r(\orgn,V,E)=(D_1,e,n,f)$ and
Write $\op{hyp}(\orgn,V,E)=(D,e,n,f)$.  We call them the reduced hypermap
and the (extended) hypermap associated with $(\orgn,V,E)$.  The next
lemma justifies this terminology.



\begin{lemma}\guid{AAUHTVE}\rating{40}
Let $(\orgn,V,E)$ be a fan.  Let $D = D_1\cup D_2$
and $\op{hyp}(\orgn,V,E) = (D,e,n,f)$, as constructed above.  Then
    \begin{itemize}
    \item $\op{hyp}(\orgn,V,E)$ is a plain hypermap.
    \item  $e$ has no fixed
points in $D_1$.
    \item  $f$ has no fixed points on $D_1$.
    \item For every pair of distinct nodes, there is at most one
    edge meeting both.
    \item The two darts of an edge (of $D_1$) lie at different nodes.
    \end{itemize}
\end{lemma}

\begin{proof}  We compute
    $$e(n(f(\orgn,v,w,w'))) = e(n(\orgn,w,\sigma(w)^{-1} v,v))) =
        e(\orgn,w,v,\sigma(w, v)) = (\orgn,v,w,\sigma(w, v)) = (\orgn,v,w,w').$$
So it is a hypermap. We compute
    $$e(e(\orgn,v,w,w')) = e(\orgn,w,v,\sigma(w,v)) = (\orgn,v,w,w').$$
So it is plain. A fixed point in $D_1$ under $e$ would force $v = w\in E(v)$,
but by construction $v\not\in E(v)$.  The argument that $f$ has no
fixed points is similar.

   We show that for every pair of distinct nodes, there is at most one edge
meeting both.
That is,
        $$(n^k e x = e n^\ell x)\Rightarrow (n^\ell x = x).$$
Let $x = (\orgn,v,w,w')\in D_1$.  Let $\sigma=\sigma(v)$. Then
    $$
    \begin{array}{lllllll}
    n^\ell x &= (\orgn,v,\sigma^\ell w,\sigma^{\ell+1}w)\\
    e n^\ell x &= (\orgn,\sigma^\ell w,*,*)\\
    e x &= (\orgn,w,*,*)\\
    n^k e x &= (\orgn,w,*,*)\\
    n^k e x &= e n^\ell x &\ \Rightarrow (w = \sigma^\ell w) &\ \Rightarrow
    (n^\ell x &= (\orgn,v,w,\sigma w) = x)
    \end{array}
    $$

Finally, we show that each dart of an edge lies on a different node.
That is, $e x \ne n^k x$, for $x\in D_1$.  We have
    $$
    \begin{array}{lll}
        e(\orgn,v,w,w') &= (\orgn,w,*,*),\quad w\in E(v)\\
        n^k(\orgn,v,w,w') &= (\orgn,v,*,*),\quad v\not\in E(v).
    \end{array}
    $$
The result follows.
\end{proof}

\subsection{basics}

There is hardly any topology that comes up in this book.  Most of
what is needed appears in this chapter.  We make use of some basic
notions in topology such as continuity, connectedness, and compactness.

\begin{remark} The term {\it connected} is now being used in
two different senses: in the topological sense and in a combinatorial
sense for hypermaps.   We will refer to the connected components
of a topological space as topological components and the connected
components of a hypermap as combinatorial components to reduce the confusion.
\end{remark}






The set $\ring{R}^3$ is a metric space under the
Euclidean distance function $d(v,w) = \norm{v}{w}$.  Subsets of
$\ring{R}^3$ are a metric space under the restriction of the metric
$d$ to the subset. Subsets carry the metric space topology. 
If $Y$ is an open set in $\ring{R}^3$, write
$\comp{Y}$ for its set of topological components.
If two
points in $\ring{R}^3$ 
can be joined by a continuous path that avoids $X$,
then they lie in the same topological component of $Y$.
If we produce a family of pairwise disjoint nonempty connected open sets in
$Y$, whose union is all of $Y$, then
this family is $\comp{Y}$.
%embers of the family are the topological components of $Y$.
Let $$S^2(\orgn) = \{ v \mid \norm{ v}{\orgn } = 1\}$$ be the unit sphere in
$\ring{R}^3$, centered at $\orgn$.  






\subsection{topological component and dart}

Let $(\orgn,V,E)$ be a fan and let $(D,e,n,f) = \op{hyp}(\orgn,V,E)$
be the associated hypermap.  Write $D = D_1\cup D_2$ as a union of
reduced darts $D_1$ and non-reduced darts $D_2$.

\begin{definition}[X,~Y]\label{def:XY}
Let $(\orgn,V,E)$ be a fan.  Let $X=X(\orgn,V,E)$ be the union of the
cones
   $$C(\orgn,e)$$
as $e$ ranges over $E$.  Let $Y=Y(\orgn,V,E)$ be the complement
$Y = \ring{R}^3\setminus X$.
\indy{Index}{X}\indy{Index}{Y}.
\end{definition}

%% WW Move the following remark elsewhere:
%If $e=\{v,v'\}\in E$, then $\orgn,v,v'$ are not collinear
%(Remark~\ref{rem:fan}), so that $C(\orgn,e)$
%does not lie in a line, and does not contain any
%distinct points $u,u'\in
%C(\orgn,e)\setminus\{\orgn\}$ 
%with $\op{aff}\{u,u',\orgn\}$ collinear. 
%In particular, $C(\orgn,e)$ does not contain a line through $\orgn$.

We associate a wedge $\Wdart(x)$, a subset $\Wdart(x,\epsilon)$,
and an azimuth angle $\op{azim}(x)$
with each dart $x\in D$.  If
$x=(\orgn,v,w,w')\in D_1$, set
$\Wdart(x) = W(\orgn,v,w,w')$ and $\op{azim}(x) =
\op{azim}(\orgn,v,w,w')$.   If $x=(\orgn,v)\in D_2$, then we set
$\Wdart(x) = \ring{R}^3\setminus \op{aff}\{\orgn,v\}$ and $\op{azim}(x) = 2\pi$.  For any $x = (\orgn,v,\ldots)\in D$, set
    $$
    \Wdart(x,\epsilon) = \Wdart(x) \cap \op{rcone}^0(\orgn,v,\cos\epsilon).
    $$
\FIXX{Is the $D_2$ case really needed?}


\begin{lemma}\guid{VBTIKLP}\tlabel{lemma:disjoint}\rating{100}
Let $(D,e,n,f)$ be the hypermap attached to a 
fan $(\orgn,V,E)$.
Let $N$ be a node of $D$.  There exists $v\in V$
such that the darts of $N$ are precisely
the darts of the form $(\orgn,v,\ldots)$.  Furthermore, there is a 
disjoint sum decomposition of $\ring{R}^3$ given by
  $$
  \ring{R}^3 = 
  \op{aff}\{\orgn,v\} \cup
  \bigcup_{x\in N} \Wdart(x)  \cup 
  \bigcup_{\{v,w\}\in E} \op{aff}_+^0(\{\orgn,v\},w).
  $$
\end{lemma}

If $x\in D$, write $v_x\in V$ for the corresponding vertex.  By the lemma,
we may identify $V$ with the set of nodes of $D$.

\begin{proof}
We prove the existence of the disjoint sum decomposition.
First of all, $\ring{R}^3$ is the disjoint union of $\op{aff}\{\orgn,v\}$
and its complement.
Fix $u$ such that $\{v,u\}\in E$, and let $\sigma$ be the azimuth
cycle on $E(v)$.  Every $y\in\ring{R}^3\setminus\op{aff}\{\orgn,v\}$ satisfies
$$
\op{azim}(\orgn,v,u,\sigma^i u)<
\op{azim}(\orgn,v,u,y) < \op{azim}(\orgn,v,u,\sigma^{i+1} u).
$$
or 
$$
\op{azim}(\orgn,v,u,\sigma^i u) = \op{azim}(\orgn,v,u,y)
$$
for a unique $0 \le i < n$, where $n$ is the cardinality of $E(v)$.
These conditions are exactly the membership conditions for the sets
$
\Wdart(\orgn,v,\sigma^i u,\sigma^{i+1}u)
$
and $\op{aff}_+^0(\{\orgn,v\},\sigma^iu)$, respectively.
The result follows.
\end{proof}

\begin{corollary}\tlabel{cor:W}\rating{10}
Let $x = (\orgn,v,\ldots)$ be a node.
We have $\Wdart(x)\cap C(\orgn,e)=\emptyset$, for $e\in E(v)$.
\end{corollary}

\begin{proof} The decomposition of Lemma~\ref{lemma:disjoint} is
disjoint.  It follows directly from the definitions that
   $$C(\orgn,e)\subset \op{aff}_+^0(\{\orgn,v\},w) \cup 
    \op{aff}\{\orgn,v\}.$$
\end{proof}

\begin{lemma}\guid{JGIYDLE}\rating{80} 
For each $x$, and $\epsilon$ sufficiently small and positive,
$\Wdart(x,\epsilon)$ is nonempty and lies in a single 
topological component of $Y(\orgn,V,E)$.
\end{lemma}

\begin{proof}  First we show that $\Wdart(x,\epsilon)$ lies in $Y$,
for $\epsilon$ small.  Let $x=(\orgn,v,w,w')\in D_1$.  
Let $S^2(\orgn)$ be the unit sphere centered at $\orgn$.
By making $\epsilon$ small enough,
the sets $\Wdart(x,\epsilon)\cap S^2(\orgn)$
avoid the compact sets $C(\orgn,e)\cap S^2(\orgn)$ when $v\not\in e$.
Thus, $\Wdart(x,\epsilon)$ also avoids $C(\orgn,e)$ when $v\not\in e$.
By Corollary~\ref{cor:W}, $\Wdart(x,\epsilon)$ avoids $C(\orgn,e)$, when $v\in e$.
Thus, $\Wdart(x,\epsilon)\subset Y$, for $\epsilon$ small.

To complete the proof, it is enough to show that each $\Wdart(x,\epsilon)$ is
connected.  
The  set
   $$
   R=\{(r,\theta,\epsilon') \in (0,\infty) \times (\theta_1,\theta_2) \times (0,\epsilon)\}
   $$
is connected.
The set $\Wdart(x,\epsilon)$  is the image of $R$
under a spherical coordinate representation (Definition~\ref{def:sph}).
It is readily verified that the polar coordinate representation is
a continuous map. As the image of a connected set under a continuous map
is connected, $\Wdart(x,\epsilon)$ is connected.
\end{proof}

\begin{definition}[leads~into] For each dart $x$, 
there is then a well-defined connected
component $U_x$ of $Y(\orgn,V,E)$ 
that contains $\Wdart(x,\epsilon)$ (for all
sufficiently small $\epsilon$). Say the dart {\it leads into}
$U_x$.
\end{definition}


\section{Planarity}

\begin{lemma}\guid{UOCPEYC}\tlabel{lemma:convex-2-dart}\rating{150}
Let $(\orgn,V,E)$ be a fan, with cyclic hypermap.  
Let $U$ be a topological component of $Y(\orgn,V,E)$.
Assume
that every dart of $F$ is weakly convex.  If there is at most
one convex dart in $F$, then all the darts have azimuth angle $\pi$,
and all the vertices of $F$ lie in a plane through $\orgn$.  The path length of the path following the darts of $F$ around its cycle is $2\pi$.
If there are two convex darts in $F$ with vertices $v,w$, then
$\{\orgn,v,w\}$ is collinear, all the vertices of $F$ lie on two planes through $\{\orgn,v,w\}$, and the path length around $F$ is again $2\pi$.
\end{lemma}

\begin{proof}
If every dart but at most one 
has azimuth angle exactly $\pi$, then the set $\{\orgn\}\cup V$ is
planar.  This forces the final dart to have azimuth angle $\pi$ as well. 
The sum of the angles at $\orgn$ is exactly $2\pi$.  The path length
is then also $2\pi$.

If there are only two convex darts $x,y$ (at $v,w\in V$), 
then the darts from $x$ to $y$ (stepping around the face with with face map) lie at a set of vertices of $V$ that all lie on a common plane through $\orgn$.  Similarly, the vertices encountered stepping from $y$ to $x$ (with the inverse of the face map) all lie on a common plane through $\orgn$.  Thus, $v,w$ lie on two distinct planes through $\orgn$.  This forces $\{\orgn,v,w\}$ to be collinear.
Thus, the sum of the arclengths from $x$ to $y$ is $\pi$, and the sum from $y$ back to $x$ is also $\pi$, giving path length $2\pi$ for $P$.
\end{proof}

\begin{lemma}\guid{WSEWPCH}\tlabel{lemma:convex-hyper}\rating{250}
Let $(\orgn,V,E)$ be a fan, with cyclic hypermap.  
Let $U$ be a topological component of $Y(\orgn,V,E)$.  Let $F$ lead
into $U$.
Assume
that every dart of $F$ is weakly convex. 
let $P$ be the vertex path that steps through the vertices of $V$ listed
in the order of the face-map $f$ on $F$.  Then the path-length of the closed
path $P$ is at most $2\pi$.
\end{lemma}

\begin{proof}  Lemma~\ref{lemma:convex-2-dart} handles the case
when there are at most two convex darts in $F$.
Assume that there are at least three convex darts.
We prove the result by induction on the number of convex darts, with base case given by two convex darts.

Pick distinct planes $\op{aff}(\orgn,\{u,v\})$ and $\op{aff}(\orgn,\{u',v'\})$ with vertices $u,v,u,v'\in V$, such that there are no points of
$V$ along the line of intersection.  We may further assume that 
the arclength from $v$ to $v'$ is less than $\pi$ and
$\op{aff}_+(\orgn,\{v,v'\})$ is the path length of the path that
steps consecutively through the darts from $v$ to $v'$\FIXX{Why?}

Pick $w\ne \orgn$ in the intersection of these two planes along
the half circle of radius $1$, centered at $\orgn$, that lies
in the half plane $\op{aff}_+(\{\orgn,u\},v)$.  Modify the fan
as follows. Add to $V$ the point $w$ and delete the vertices along
$F$ strictly between $v$ and $v'$.  Delete the edges with a vertex
at any of these deleted vertices.  Add edges $\{v,w\}$ and $\{w,v'\}$.

The resulting fan $(\orgn,V',E')$ has a corresponding face $F'$ that is
still weakly convex.  It has fewer convex darts (so that the induction
hypothesis applies to it).  By the triangle inequality, the
arclength from $\{v,w\}$ then to $\{w,v'\}$ is at least the arclength
of $v$ to $v'$.  So we increase the perimeter path length to get
a path length at most $2\pi$.
\end{proof}


\begin{lemma}\guid{TXIEOJT}\tlabel{lemma:tri-tri}\rating{100}
Let $(\orgn,V,E)$ be a fan.  Assume
that its hypermap is a triangulation. (That is, all the darts are reduced; there is a single combinatorial component; the size of each face is $3$; and every dart is
convex).   
Let $\#c$ be the number
of topological components of $Y(\orgn,V,E)$.  We have
    \begin{itemize}
    \item The hypergraph $\op{hyp}(\orgn,V,E)$ is planar.
    \item The faces are in bijection with the topological components, given by which
    topological component each face leads into.
        \item Let $U$ be a topological component. Then $U \cap B(\orgn,1)$ 
       is measurable and eventually radial at $\orgn$.  Its solid angle is
        $$-\pi + \sum_{x\in F} \op{azim}(x)$$
    \end{itemize}
\end{lemma}

\begin{proof}
Each topological component 
of $Y(\orgn,V,E)$ has
the form $U(v_1,v_2,v_3)=\op{aff}_+^0(\orgn,\{v_1,v_2,v_3\})$.\footnote{XX Why are these disjoint?}  In fact,
these sets are open, convex, and hence connected, 
and their union is all of $Y(\orgn,V,E)$; thus,
they are the topological components.   There is a bijection
between topological components and faces $U \leftrightarrow F$, which associates this topological component
with the three darts $(\orgn,v_i,v_j,v_k)$, $(i,j,k)$ a cyclic permutation
of $(1,2,3)$  (assuming appropriate orientation on the indices $(1,2,3)$).

Each topological component $U(v_1,v_2,v_3)$ is measurable and eventually radial
at $\orgn$.  By the area formula for a solid triangle, the solid angle of $U(v_1,v_2,v_3)$
is 
   $$-\pi + \sum_{x\in F} \op{azim}(x)$$
as stated in the lemma.  If we sum this relation over all components, we obtain
the solid angle of a sphere:
   \begin{equation}\tlabel{eqn:euler}
   \begin{array}{lll}
   4\pi &= -\sum_{F} \pi + \sum_{x} \op{azim}(x)\\
        &= -\#f \pi + 2 \# n \pi.
   \end{array}
   \end{equation}
In a triangulation, $\#\tangle{e,n,f}=1$, $2 \# e  = 3\#f$, $\# D = 2 \#e$.
It follows from these relations that
   $$
   \#n + \# e + \# f = 2\#\tangle{e,n,f}+\# D.
   $$
Thus, the hypermap is planar.  The lemma is now fully established.
\end{proof}


\begin{lemma}\guid{QBWFUSK}\tlabel{lemma:hypermap-planar}\rating{400}
Let $(\orgn,V,E)$ be a fan.    
Let $\#c$ be the number
of topological components of $Y(\orgn,V,E)$.  Let $t>0$. We have
    \begin{itemize}
    \item The hypermap $\op{hyp}(\orgn,V,E)$ is planar.
    \item No two faces in a combinatorial component lead
    into the same topological component.
    \item $\#c = 1 + \#f - \#\tangle{e,n,f}$
    \item Let $U$ be a topological component. Let $F\mapsto U$ mean
    that the face is non-degenerate and leads into $U$.  
     Then $U \cap B(\orgn,t)$ 
       is measurable and eventually radial at $\orgn$.  Its solid angle is
        $$\op{sol}(U) = 4\pi + \sum_{F\mapsto U}(-2\pi + \sum_{x\in F}
        (\op{azim}(x)-\pi))$$
    \end{itemize}
\end{lemma}

\begin{proof}  
Add to the fan finitely many isolated
points  $V' = V\cup S$ to make $(\orgn,V',E)$ (by isolated we mean that the edge set $E$ does not change) such that no half-space
through $\orgn$ contains $V'$.    While the hypermap
has more than one combinatorial component, 
we may use Lemma~\ref{lemma:exists-diagonal} to find $u,v\in V'$ such
that $C^0=C^0(\orgn,\{u,v\})$ lies in a single topological component of $Y(\orgn,V',E)$ and
joins two combinatorial components of the hypermap.  We add the edge $\{u,v\}$ to $E$ to form
a new fan and hypermap.
We repeat this process until the hypermap has one combinatorial component.  In particular, this
inserts edges to each of the extra added points $S\subset V'$.


By Lemma~\ref{lemma:cx-dart},
every face has at least one convex dart.  By Lemma~\ref{lemma:exists-diagonal},
we can add an edge to every face (that is not already a triangle).  By repeatedly
inserting edges, eventually we obtain a triangulation.  It satisfies
the conclusions of Lemma~\ref{lemma:tri-tri}.

Now we reverse the process.  Starting with the triangulation, we remove the
edges that we have inserted into the preplanar graph  (in a first-in first-out order).  
Each edge removal is
described combinatorially as a double-walkup.  (Note that
in the case of an edge to an isolated vertex  $v\in S\subset V'$, the second walkup
in the double walkup
 removes the degenerate dart at $v$.  Hence in reversing the process,
the vertices $S$ may be removed.)  Double-walkups of
a planar hypermap preserve planarity by Lemma~\ref{lemma:walkup-planar}.  Hence the original
fan has a planar hypermap.  Also, by the calculations of planar indices
in Lemma~\ref{lemma:index}, every double walkup either merges or  splits
 increasing the number of topological components by $1$.

In the triangulation the set of topological components is in natural bijection with the set of faces.
Each merging double walkup is applied to an edge $\{x,y\}$ such that each endpoint $x$,
$y$ leads into a different face, hence into a different topological component.  By Lemma~\ref{XX},
and Lemma~\ref{lemma:U-merge}, the number of topological components and faces both drop by exactly one.
In particular, the topological components and faces remain in natural bijection after the
double walkup.  Each double walkup that splits increases the number of faces by one,
increases $\#\tangle{e,n,f}$ by one, and preserves the number of topological components.
The announced formula for the number of topological components thus holds.

Finally, the solid angle formula is easily checked to be compatible with
the deletion of the edges.  That is, when two areas are joined, we have
  $$\op{sol}(C_1) + \op{sol}(C_2) = \op{sol}(C_1\cup C_2)$$
and the combinatorial formula is similarly additive.
The lemma is now completely established.
\end{proof}




\begin{lemma}[sweep]\label{lemma:sweep}  
Let $(\orgn,V,E)$ be a fan, with hypermap $(D,e,n,f)$.  
Suppose that $\op{azim}(x)<\pi$
for all darts $x\in D$.  Fix a dart $x\in D$.
Let $v = v_x$, $v_0 = v_{f x}$,
and $v_1 = v_{f^2 x}$.  Let $v_t = (1-t) v_0 + t v_1$, for
$0\le t\le 1$.  Let $C_t^0 = \op{aff}_+^0(\orgn,\{v,v_t\})$.
Let $Y = Y(\orgn,V,E)$ and $X = X(\orgn,V,E)$.
Then
\begin{itemize}
\item The set $\{\orgn,v,v_t\}$ is not collinear for any $t\in[0,1]$.
\item For $0< t < 1$, we have $C_t^0\subset Y$.
\item If $\{v,v_1\}\in E$ (that is, if the face of $x$ is a triangle), 
then $C_1^0$ is the blade $C^0(\orgn,\{v,v_1\})$ of the fan.
\item If $\{v,v_1\}\not\in E$, then $C_1^0\subset Y$.
\end{itemize}
\end{lemma}

\begin{proof}
It follows from the definition of a fan that $\{v,v_0\}\in E$ and
that $\{\orgn,v,v_0\}$ is not collinear.  By continuity, $\{orgn,v,v_t\}$
is not collinear for $t>0$ sufficiently small.  If it exists, set $t'$ as
the smallest $t>0$ for which $\{orgn,v,v_t\}$ are not collinear.  If it exists,
let $I=\{t\mid 0\le t < t'\}$, otherwise let $I=[0,1]$.  For
each $t\in I$, the blade $C_t^0$ is not a collinear set and is contained in a unique plane $P(t)$ through $\orgn$ and $v$.

By considering possible intersections with vertices $w\in V$ and blades
$C^0(\orgn,e)\subset X$, we find that for $t>0$ sufficiently small,
$C^0_t$ does not meet $X$, hence $C^0_t\subset Y$.  Assuming 
that it exists, set $t''$
as the smallest $t\in I$ for which $C^0_t$ meets $X$.   Let $C'' = C_{t''}^0$.
$C''$ cannot be $X$ at a vertex $w\in V$, because each azimuth angle
is $<\pi$ at $w$, which means that for any $t$ for which  $C^0_t$ meets $w$ 
there is a smaller $t'''<t$ for which $C^0(t''')$ meets a blade into $w$.
Thus, $C''$ first meets $X$ along a blade $C^0(\orgn,\{w_1,w_2\})$. If
the intersection is transversal, again we can find a smaller $t'''$ that
gives an intersection with the blade.  Hence, we may assume that
$C''$ and $C^0(\orgn,\{w_1,w_2\})$ are coplanar.  From the disjointness
properties of blades of a fan, it follows that $\{w_1,w_2\} = \{v,v_1\}\in E$,
$t''=1$,
and that $C_1^0=C^0(\orgn,\{v,v_1\})$ is a blade of the fan.

Now assume for a contradiction that $t'$ exists.  Pick $0<t''<t'$.  Then
$\{\orgn,v(t''),v(t'),v\}$ lie in a unique plane $P$.  Since all $v(t)$
are collinear,  $v(t)\in P$ all $t\in I$.  In particular $v_0\in C^0(t'')\cap X$,
contradicting the disjointness of $X$ from $C^0(t'')$ established in
the previous paragraph.  Thus, $t'$ does not exist.  This proves the first
claim.  The other claims follow from the previous paragraph.
\end{proof}

\begin{lemma} Let $(\orgn,V,E)$ be a fan with hypermap $(D,e,n,f)$. 
Let $Y=Y(\orgn,V,E)$.
Assume that $\op{azim}(x)<\pi$
for all darts. Then for every face $F$ of the hypermap, there exists a topological component
$U$ of $Y$ such that for every $x\in F$, the dart $x$ leads into $U$. 
\end{lemma}

Write $U_F$ for the topological component of $Y$ that the darts of $F$ lead into.


\begin{proof}  Fix any dart $x\in F$ and construct the set $C^0_t$ as
in the previous lemma.  By the previous lemma, the set $C^0_t$ lies in a single
component $U$ for all $t>0$ sufficiently small.  For all $\epsilon>0$
sufficiently small, there exists $\delta>0$ such that set $C^0_t$ meets
both $W(x,\epsilon)$ and $W(f x,\epsilon)$ for all $t<\delta$.  Thus,
$x$ and $f x$ lead into the same component $U$.  By induction, for all
$y\in F$, we have that $y$ leads into $U$.
\end{proof}

\begin{lemma} Let $(\orgn,V,E)$ be a fan with hypermap $(D,e,n,f)$. 
Let $Y=Y(\orgn,V,E)$.
Assume that $\op{azim}(x)<\pi$
for all darts.  Fix a face $F$ of cardinality three, fix
$x\in F$, and set $x_i = f^i x$. Then
\begin{itemize}  
\item $U_F$ is equal to the intersection of the three half-spaces
$$H^0(i)=\op{aff}_-^0(\{\orgn,v(x_{i+1}),v(x_{i+2})\},v(x_i)),\quad i=0,1,2$$
\item if a dart $y$ leads into $U_F$, then $y\in F$.
\end{itemize}
\end{lemma}

\begin{proof} The intersection of two half-spaces, $H^0(1)\cap H^0(2)$ is
the wedge $W(x)$.   The sets $C^0_t\subset W(x)$ sweep out precisely
the intersection of $W(x)$ with $H^0(0)$.  The sets $C^0_t$ belong to
$U_F$.  Hence the intersection $U'$ of the three half-spaces is a subset of $U_F$.

Suppose for a contradiction 
that $p$ is a point of $U_F$ that does not belong to $U'$.  Choose a path $\gamma:[0,1]\to U_F$ with $\gamma(0)\in U'$ and $\gamma(1)=p$.  Let $t>0$ be the first time such that $\gamma(t)\not\in U'$.  Then $q=\gamma(t)$ lies
in the set $X'$ consisting of the closed intersection of half-spaces $H(i)$
corresponding to $H^0(i)$ and lies
in one of the bounding planes.  However, $X'$ is the union of the three
blades $C(i)=C(\orgn,\{v(x_i),v(x_{i+1})\})\subset X$.  Thus,
$q\in X\cap Y = \emptyset$, which is impossible.  Thus, $U'=U_F$.

Let $y$ be any dart that leads into $U_F$ at vertex $v(y)$.  Then
$W(y,\epsilon)$ meets $U_F$ for all $\epsilon>0$ sufficiently small.
This implies that $v(y)$ lies in the intersection of the closed half-spaces $H(i)$.  As we have seen, this intersection is the disjoint union of $U_F$ and
$X'$.  As $v(y)\in X$, which does not meet $U_F$, we have $v(y)\in X'$.
The set $X'$ is the disjoint union of the rays $\op{aff}_+(\orgn,v(x_i))$ and
the three blades $C^0(i)$.  These blades do not meet the vertices, hence
$v(y)=v(x_i)$ for some $i$.  Thus, $y$ and $x_i$ belong to the same
node.  The sets $W(y)$ and $W( x_i)$ are disjoint for distinct darts at the same
node, and this implies that $y=x_i\in F$.
\end{proof}

\begin{corollary}
$U_F$ is measurable and eventually radial at $\orgn$.
The solid angle of $U_F$ is given by the formula
$$
\sol(U_F) = \pi + \sum_{x\in F}\op{azim}(x),
$$
\end{corollary}

\begin{proof} An intersection of half-spaces is measurable and
eventually radial.  The solid angle is given by Girard's formula for
a spherical triangle.
\end{proof}

\begin{lemma}  Let $(\orgn,V,E)$ be a fan with hypermap $(D,e,n,f)$. 
Let $Y=Y(\orgn,V,E)$.
Assume that $\op{azim}(x)<\pi$
for all darts.  Then
\begin{itemize}
\item The map $F\mapsto U_F$ is a bijection between faces of the hypermap
and topological comonents of $Y$.
\item  Each topological component $U_F$ is the intersection of the open
half-spaces $\op{aff}_+^0(\{\orgn,v_x,v_{f x}\},v_{f^2 x})$, as $x$ runs
over $F$.
\item For every $F$, the topological component $U_F$ is measurable and
eventually radial at $\orgn$.  The solid angle of $U_F$ is given by the
formula
$$
\sol(U_F) = -(n-2)\pi + \sum_{x\in F}\op{azim}(x),
$$
where $n$ is the cardinality of $F$.
\item If $x,y\in F$, with corresponding vertices $v_x,v_y\in V$, then
$\{\orgn,v_x,v_y\}$ are not collinear.
Furthermore, 
either $x,y$ are adjacent under the face map, or $C^0(\orgn,\{v_x,v_y\})\subset U_F$.  {\it That is, the diagonals of the polygon $U_F$ are all interior.}
\item  Triangulations of $U_F$ exist.
\end{itemize}
\end{lemma}

Before moving to the proof, we give some corollaries.

\begin{corollary}
Each topological component $U_F$ is convex.
\end{corollary}

\begin{proof} It is the intersection of half-spaces.
\end{proof}

\begin{corollary}  Each face of the hypermap meets each node in at most
one dart.
\end{corollary}

\begin{proof}  Let $x\in F$.  By the intersection of half-spaces property,
$U_F$ is contained in the wedge $W(x)$ at $x$.  If there is a second
dart $y$ at the same node in $F$, then $U_F$ is also contained in $W(y)$.
However, by Lemma~XX, the wedges at a given node are disjoint.
\end{proof}

\begin{corollary}  The hypermap is connected.
\end{corollary}

\begin{proof} Assume that $x,y$ be any two darts.  By replacing $x$ with $f x$ if necessary, which lies in the same combinatorial component as $x$, we may
assume that $\{\orgn,v_x,v_y\}$ is not a collinear set. 
For each blade $C^0(\orgn,e)$ of the fan that meets $C=C^0(\orgn,\{v_x,v_y\})$
pick one of the two endpoints of $e$.  Then we get a sequence
$$
v_x=v_0,v_1,\ldots,v_k=v_y
$$
such that $C^0(\orgn,\{v_i,v_{i+1}\})$ lies in a single topological component $U_i$.  Each $U_i$ has the form $U_{F_i}$ for some face $F_i$ of the hypermap.
Thus, we may construct a combinatorial path from $x$ to $y$, by moving by the face map from dart to dart within each $F_i$ and by the node map from dart to dart around a given node $v_j$.
\end{proof}

\begin{definition}
An articulation node of a hypermap is a node for which
there exists two darts $x,y$, 
neither belonging to the node,
such that every contour path from $x$ to $y$ passes
through the given node.
A connected hypermap is biconnected
if it contains no articulation node.  
\end{definition}

\begin{corollary} The hypermap is biconnected.
\end{corollary}

\begin{proof} We need to show how to get from one dart $x$ to another $y$
avoiding any node $N$ such that $v\ne v_x,v_y$.  Let $N = \{z_1,\ldots,z_r\}$.
Any contour path through the node $N$ takes the form 
$$\ldots, f^{-1} z_i, z_i, n^{-1} z_i,\ldots, z_k, f z_k,\ldots$$
We can get from $f^{-1} z_i$ to $f z_i$ avoiding $N$, because they
lie on the same face, and the face meets the node $N$ at a single dart $z_i$.
$f z_i$ and $f^{-1} n^{-1} z_i$ are at the same node (since the hypermap is plain), so we can get to $f^{-1} n^{-1} z_i$ avoiding $N$.  From there,
we can reach $f n^{-1} z_i$.  Continuing by induction,
we can reach $f z_k$, avoiding $N$.
\end{proof}

\begin{corollary}  The hypermap is planar.
\end{corollary}

\begin{proof}  The solid angle of a sphere is $4\pi$.  The set $X$
has measure zero, so that
$$
4\pi = \sol(Y)= \sum_F \sol(U_F) = 
\sum_F ( -(-2+ \sum_{x\in F} 1)\pi + \sum_{x\in F} \op{azim}(x) ).
$$
The double sums over faces and darts in a face can be replaced by
a single sum over darts.
The sum of the azimuth angles of all darts at a node is $2\pi$. Thus,
all the azimuth angle terms give $2\pi\#n$.
Thus, the formula becomes
$$
4\pi = 2\pi \#f - \pi \#D + 2\pi\#n.
$$
For a plain connected hypermap, this equation implies planarity.
\end{proof}


Now we turn to the proof of the lemma.

\begin{proof}
Assume for a contradiction that there exists a fan $(\orgn,V,E)$ 
satisfying the assumptions of the lemma, but not the conclusion.
Among all such counterexamples with fixed $(\orgn,V)$, we may pick
$E$ to minimize the natural number $N(E)$ given by
$$
\sum_F (n_F - 3),
$$
where the sum runs over faces of the hypermap, and $n_F$ is the
cardinality of the face $F$.

If $N(E)=0$, then the hypermap is a triangulation.  We consider this
case first.  XX FINISH.


Now consider the case $N(E)>0$.  There exists a face $F$ of the hypermap
that is not a triangle.  By Lemma~\ref{XX}, there is a diagonal in $U_F$.
We form a new fan $(\orgn,V,E')$ on the same vertex set with
$E' = E\cup \{v,w\}$.  XX FINISH.  (XX We have to justify $N(E')<N(E)$
without using the lemma on $E$.)


\end{proof}