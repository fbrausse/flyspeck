
%% HYPERMAPS
%XX e for both hypermap edge and edge {v,w}
\def\e{\varepsilonup}
\chapter{Hypermap}\label{chap:hypermap}

\section{Basics}



\begin{definition}[hypermap]\label{def:hypermap}  A hypermap is a finite set $D$, together with
three functions $e,n,f:D\to D$ that satisfy
    $$e\circ n\circ f = I.$$
The elements of $D$ are called {\it darts}.  The functions $e,n,f$
are called the {\it edge map}, the {\it node map}, and the {\it
face map}, respectively.
\end{definition}


\begin{figure}[htb]
  \centering
  \myincludegraphics{/ps/dart.ps}
  \caption{This symbol represents a dart.}
  \label{fig:dart}
\end{figure}

\begin{remark}\tlabel{rem:hypermap} A hypermap is an abstraction of
the concept of 
planar graph.  Place a dart at each angle of a planar graph $G$.
One function, $f$, 
cycles counterclockwise around the angles of each face.  
Another function, $n$, 
rotates counterclockwise around the angles at each
node.  A third function, $e$, pairs angles at opposite ends of
each edge  (Figure~\ref{fig:hypermap_ex}).   The hypermap extracts
the data $(D,e,n,f)$ from the planar graph and discards the rest.
\end{remark}

\begin{figure}[htb]
  \centering
  \myincludegraphics{\ps/hypermap_ex.eps}
  \caption{Darts mark the angles of a planar graph.  We may
  permute darts about faces, nodes, and edges.}
  \label{fig:hypermap_ex}
\end{figure}

A hypermap satisfies 
  \begin{equation}\tlabel{eqn:triality}
  n\circ f\circ e = f\circ e\circ n = I.
  \end{equation}
Inverted, this triality becomes
   $$
   n^{-1} \circ e^{-1} \circ f^{-1} = (f \circ e \circ n)^{-1} = I.
   $$
This inversion
is the abstract form of the
the duality between nodes and faces in a planar graph.  
Because of
these symmetries in the defining relation, 
there will be multiple versions of 
theorems about hypermaps,
all obtained from one proof by symmetry.

Each function $e,n,f$ is a permutation of $D$.  
We write $\#h$ for the
number of orbits of a permutation $h$ on $D$, and $\#\tangle{e,n,f}$
for the number of orbits of the combined action of functions $e,n,f$
on $D$.   

\begin{definition}[node,~face,~edge,~connected]  A node is an orbit  under
$n$.  A face is an  orbit  under $f$.  An edge
is an orbit under $e$. An orbit of $D$ under $\tangle{e,n,f}$
(the combined action of $e,n,f$) is called a combinatorial component.
A hypermap is connected
if 
  $\#\tangle{e,n,f} = 1$. 
\end{definition}

\begin{definition}[plain,~planar] A hypermap is {\it plain} (note the spelling!) if
$e$ is an involution on $D$ (that is, $e\circ e = I$).  A hypermap
is {\it planar} (note the spelling!) if the Euler relation holds:
    $$\# n + \# e + \# f = \# D + 2 \#\tangle{e,n,f}.$$
\end{definition}


\begin{remark}  The Euler relation for hypermaps harks back
to the Euler relation for planar graphs.
Let $G$ be a connected planar graph that satisfies the
Euler relation
    $$V - E + F = 2$$
where $V$ is the number of vertices, $E$ the number of edges, and
$F$ the number of faces of $G$ (including an unbounded face). The
hypermap $(D,e,n,f)$, made from $G$ in
Remark~\ref{rem:hypermap}, is plain.
Moreover,
    $$\begin{array}{lll}
    V &= \# n\\
    E &= \# e\\
    F &= \# f\\
    2E &= \# D\\
    1 &= \#\tangle{e,n,f}\\
    \# n + \#e + \# f &= 
    V + E + F = 2 E + 2 = \# D + 2 \#\tangle{e,n,f}.
    \end{array}
    $$
Thus, the hypermap is also planar. 
\end{remark}


%% WW Used??
%\begin{lemma}\guid{WXEZQZR}\tlabel{lemma:euler-alt}  Let $H$ be a connected plain planar hypermap.
%Let $f_i$ be the number of faces with $i$ darts.  Then
%    $$2 \# n - 2 =  f_3 + 2 f_4 + 3 f_5 +\cdots$$
%\end{lemma}
%
%\begin{proof}  We have
%    $$
%    \begin{array}{lll}
%     \# D &= 2 \# e = 3 f_3 + 4 f_4 + \cdots\\
%    \# f &= f_3 + f_4 + \cdots.
%    \end{array}
%    $$
%Use these equations to eliminate $\#e$, $\#f$, $\#D$ from the Euler
%relation.  The result follows.
%\end{proof}
%

\begin{lemma}\guid{TGJISOK}\rating{80}\label{lemma:dart-upper} 
Let $H$ be a connected plain planar hypermap.   Assume that
there are at least three darts in every node.  Then
$$
\# D \le (6 \#f - 12).
$$
\end{lemma}

\begin{proof}  In a plain planar hypermap, the Euler relation is
$$6 \#f - 12 = 3\#D - 6\#n,$$
so it is enough to show that
$$
\# D \ge 3\#n.
$$
This follows directly by assumption: the set of darts can be partitioned into nodes, with at least three darts per node.
\end{proof}

%\subsection{biconnected}

\begin{definition}[degenerate] A dart is degenerate if it is a
fixed point of one of the maps $e,n,f$; otherwise it is nondegenerate.  
%%It is nondegenerate otherwise.
\indy{Index}{degenerate}\indy{Index}{nondegenerate}
\end{definition}

\begin{definition}[simple] 
A hypermap is {\it simple} if the intersection of a face with
a node never contains more than one dart.
\indy{Index}{simple}
\end{definition}


% Moved from cup05_tame.tex section on tame plane graphs. 9/5/07:
\begin{lemma}\guid{ZHQCZLX}\rating{50}\tlabel{lemma:nondegen} 
Let $(D,e,n,f)$ be a simple plain hypermap such that every face has
at least three darts.
Then $n$ has no fixed point.
\end{lemma}

\begin{proof}  For a contradiction, let $x$ be a fixed point of
$n$. We show that $e x$ and $f x$ lie in the same node and
face, so are equal in the simple hypermap.  
They lie in the same node because
$n(f x) = e^{-1} x = e x$. They lie in the same face because
    $$f^2 (e x) =  f(n^{-1} x) = f x.$$
So $e x = f x$.   Thus, $f^2 (e x) = f x = e x$, and $e x$ lies on a
face with at most two darts.  This contradicts what is given.
\end{proof}


\begin{definition}[biconnected]
An articulation node of a hypermap is a node for which
there exists two darts $x,y$, 
neither belonging to the node,
such that every contour path from $x$ to $y$ passes
through the given node.
A connected hypermap is biconnected
if it contains no articulation node.  
\end{definition}

\begin{lemma}\guid{MOORQUT}\rating{200} Let $H$ be a connected plain simple hypermap. Then, the hypermap is biconnected.
\end{lemma}

\begin{proof} Let $x$ and $y$ be any darts, and let $N$ be any node such that $x,y\not\in N$.  We need to show how to get from $x$ to $y$ avoiding $N$.  Let $N = \{z_1,\ldots,z_r\}$.  By connectedness, there exists a path from $x$ to $y$.

Any contour path through the node $N$ takes the form 
$$
\ldots, f^{-1} z_i, z_i, n^{-1} z_i,\ldots, z_k, f z_k,\ldots
$$
It is enough to construct a path from $f^{-1} z_i$ to $f z_k$ that avoids $N$. By simplicity, we can get from $f^{-1} z_i$ to $f z_i$ avoiding $N$, because they lie on the same face, and the face meets the node $N$ at a single dart $z_i$.  Also, $f z_i$ and $f^{-1} n^{-1} z_i$ are at the same node (since the hypermap is plain), so we can get to $f^{-1} n^{-1} z_i$ avoiding $N$.  From there, we can reach $f n^{-1} z_i$.  Continuing by induction, we can reach $f z_k$, avoiding $N$.
\end{proof}


\subsection{walkup}

When we focus on a dart $x$ in a
hypermap, it can be useful to draw a hexagon around $x$ and place
the six darts $e x$,
$n x$, $f x$, $e^{-1} x$, $n^{-1} x$, $f^{-1} x$ at its corners
in Figure~\ref{fig:dart+}.  Some of these $7$ darts may be
equal to one another, even if the figure draws them apart.
Figure~\ref{fig:dart-fix} shows the layout of the darts, when 
a map $e$, $n$, or $f$ fixes $x$.

\begin{figure}[htb]
  \centering
  \myincludegraphics{noimage.eps}
  \caption{A dart $x$ and its entourage}
  \label{fig:dart+}
\end{figure}

\begin{figure}[htb]
  \centering
  \myincludegraphics{noimage.eps}
  \caption{A dart fixed under a face map.}
  \label{fig:dart-fix}
\end{figure}


A {\it walkup} deletes
a dart from a hypermap and remolds the edge, node, and face
maps to produce a hypermap on the reduced set of darts.  Walkups
come in three flavors: edge walkups, face walkups,
and node walkups.

\begin{definition}[walkup]
Let $x$ be a dart in a hypermap.  The edge walkup 
$W_e$ at $x$ of the hypermap is the hypermap
$(D',e',n',f')$, where $D' = D\setminus\{x\}$ and the
the maps skip over $x$:
    $$
    \begin{array}{lll}
    f' y &= \text{ if } (y = f^{-1} x) \text{ then } f x \text{ else
    } f y\\
    n' y &= \text{ if } (y = n^{-1} x) \text{ then } n x \text{ else
    } n y\\
    e' = (n'\circ f')^{-1}
    \end{array}
    $$
\indy{Index}{walkup}
\indy{Index}{edge walkup}
\end{definition}

Figure~\ref{fig:walk} shows
the result of an edge walkup on the hexagon around a dart $x$.
The Triality symmetry~\ref{eqn:triality}, applied to the definition
of edge walkups, yields the definition of
face walkup $W_f$ and node walkup $W_n$.  
Figure~\ref{fig:walkfn} shows the result of the face and node
walkups on the hexagon around a dart $x$.

A walkup at $x$ is said to be degenerate 
if the dart $x$ is degenerate.   
At a degenerate dart $x$, all three walkups
are equal: $W=W_e=W_n=W_f$ (Figure~\ref{fig:walkdeg}).

\begin{figure}[htb]
  \centering
  \myincludegraphics{noimage.eps}
  \caption{The effect of an edge walkup at $x$}
  \label{fig:walk}
\end{figure}

\begin{figure}[htb]
  \centering
  \myincludegraphics{noimage.eps}
  \caption{The effect of face and node walkups at $x$}
  \label{fig:walkfn}
\end{figure}

\begin{figure}[htb]
  \centering
  \myincludegraphics{noimage.eps}
  \caption{The effect of a walkup at a degenerate dart}
  \label{fig:walkdeg}
\end{figure}


\begin{definition}[merge,~split]\tlabel{def:merge-split} Let $h=n,e$, or $f$.
A walkup $W_h$ at $x$ is said to merge,
if the walkup joins the orbit of $h$ through $x$ with another orbit.  
It is said to split, if the walkup splits the
orbit at $x$ into two orbits.
\indy{Index}{split}
\indy{Index}{merge}
\end{definition}

\begin{lemma}\guid{ZMFKZNH}\rating{150}\tlabel{lemma:merge-split} 
Every nondegenerate walkup merges or splits.
The walkup $W_h$ at $x$ merges if and only if $x$ and $y$  lie
in distinct $h$-orbits, where $(h,y)=(f,e x)$.  
(The lemma also holds for $(h,y)=(e,n x)$ and other cases generated
by triality.)
\end{lemma}

\begin{proof} The walkup $W_f$ splits if and only if $f x$ 
(or $x$)
and $e x$ lie in the same $f$-orbit before the split. 
Figure~\ref{fig:split} makes this clear.
\end{proof}


\begin{figure}[htb]
  \centering
  \myincludegraphics{noimage.eps}
  \caption{The face walkup at $x$ mixes $f$-orbits.  If it mixes
  two separate 
  orbits, the orbits merge.  If it mixes a single orbit, 
  the orbit splits.}
  \label{fig:split}
\end{figure}


\subsection{walkup and planarity}

\begin{definition}[planar~index] Define the planar index of a hypermap to be
$$\# f + \# e + \# n - \# D - 2\# \tangle{e,n,f}.$$
(A hypermap with null index is planar.)
\indy{Index}{index}
\indy{Index}{planar index}
\end{definition}

\begin{lemma}\guid{IUCLZYI}\rating{150}\tlabel{lemma:index} Let $x$ be a dart of a hypermap $(D,e,n,f)$. Let $(D',e',n',f')$ be the result of the edge walkup $W_e$ at
a nondegenerate dart $x$.  
The walkup changes the sizes of some orbits.
    $$
    \begin{array}{lll}
    %\text{\bf Non-degenerate dart $x$: }&\\
    \# f &= \# f'\\  
    \# e + \delta' &= \# e'\\
    \# n &= \# n'\\
    \# D - 1&= \# D' \\
    \# \tangle{e,n,f} + \delta&= \#\tangle{e',n',f'},\\
    \end{array}
    $$
where
   $$
   \delta' = \begin{cases}
     1 & W_e \text{ splits }\\
    -1 & W_e \text{ merges}\\
   \end{cases}
   $$
and
   $$
   \delta = \begin{cases}
    0 & W_e \text{ merges }\\
    0 & W_e \text{ splits and } x,nx 
      \text{ belong to the same combinatorial component}\\
    1 & \text{otherwise}.
     \end{cases}
   $$
Moreover, a walkup at a degenerate dart preserves the planar index.
\end{lemma}

\begin{proof} The figures make this clear.
\end{proof}

\begin{lemma}\guid{BISHKQW}\rating{100}\tlabel{lemma:planar-index2}
Let $\iota$ be the index of a  hypermap $(D,e,n,f)$, and
let $\iota'$ be the index after a walkup $W_h$
at a dart $x$.  We have $\iota = \iota' + 2$ when
$x$ is nondegenerate, $W_h$ splits, but the walkup does not
split the combinatorial component through $x$ into two.
Otherwise, $\iota'=\iota$.
\end{lemma} 


%If $x$ is degenerate, then $\iota=\iota'$.
%If $W_h$ merges, then $\iota=\iota'$.
%If $x$ is non-degenerate and and the walkup
%splits, the planar index is preserved iff the walkup splits the 
%combinatorial component through $x$ into two. When the walkup
%does not preserve the planar index, $\iota+2=\iota'$.


\begin{proof}  By triality symmetry, 
we can assume the walkup is an edge walkup.  
Note that
if the combinatorial component splits then
the $e$-orbit also splits.
From Lemma~\ref{lemma:index},
which lists index data, the
relation between $\iota$ and $\iota'$ is easily calculated.
\end{proof}


\begin{lemma}\guid{FOAGLPA}\rating{50}\tlabel{lemma:planar-nonpos}  
The planar index
of a hypermap is never positive.
\end{lemma}

\begin{proof}  An edge walkup never decreases the index.  By a sequence
of edge walkups we reach the empty hypermap, which has
index zero.
\end{proof}


\begin{lemma}\guid{SGCOSXK}\rating{50}\tlabel{lemma:walkup-planar}
Walkups take planar hypermaps to planar
hypermaps.
\end{lemma}

\begin{proof}  
A planar hypermap has maximum index.  The walkup
can only increase the index, but never beyond its maximum.  
Thus, the index remains at its maximum value.
\end{proof}


\subsection{double walkup}

A double walkup is the composite of two walkups
of the same type.  The
two darts for the two walkups 
are to be the members of an orbit of size
two (under $n$, $e$, or $f$).  The first walkup is to be
chosen so that it merges.  The second walkup is
to be degenerate.
By choosing the type of the walkups to be different from the type of
the orbit, the first walkup reduces the orbit to a singleton,
forcing the second walkup to be degenerate. 
 
Here are some examples.
\begin{itemize}
    \item A double $W_n$ along an edge deletes the edge and 
   merges the two endpoints into
    a single node (Figure~\ref{fig:doublenode}). 
    \item A double $W_f$ along an edge 
    deletes the edge and merges the two faces along the edge into
    one (Figure~\ref{fig:doubleface}).
    \item A double $W_e$ at a node of degree two
    deletes the node and merges the two edges at the node into
    one (Figure~\ref{fig:doubleedge}).
\end{itemize}


\begin{figure}[htb]
  \centering
  \myincludegraphics{noimage.eps}
  \caption{The double node walkup applied to an edge}
  \label{fig:doublenode}
\end{figure}


\begin{figure}[htb]
  \centering
  \myincludegraphics{noimage.eps}
  \caption{The double face walkup applied to an edge}
  \label{fig:doubleface}
\end{figure}


\begin{figure}[htb]
  \centering
  \myincludegraphics{noimage.eps}
  \caption{The double edge walkup applied to a node}
  \label{fig:doubleedge}
\end{figure}


\begin{lemma}\guid{HOZKXVW}\rating{150}\tlabel{lemma:dwalk-planar}  
The three preceding double walkups carry plain
hypermaps into plain hypermaps.
\end{lemma}

\begin{proof} The walkups $W_n$ and $W_f$ preserve the orbit
structure of edges, except for dropping one dart.  By dropping both
darts from the same edge, one edge is lost and all others edges
remain unchanged.

For the double $W_e$, we refer to Figure~\ref{fig:doubleedge}.  
If the
original hypermap is plain, then the two darts marked 
$x$ are equal, as are
the two darts marked $y$.  
The new edge map swaps $x$ and $y$, but is 
otherwise equal to $e$ on 
the reduced set of darts $D''$.  
Swapping two darts has order two, 
as we plainly see.
\end{proof}

The following is a useful way to tell if a walkup merges.


\begin{lemma}\guid{FKSNTKR}\rating{80}\tlabel{lemma:ng-merge}  
Suppose, in a simple hypermap, 
that an edge $\{x,y\}$ consists of two nondegenerate darts.  
Then the walkup
 $W_f$ (resp. $W_n$) at $x$  merges.
\end{lemma}

\begin{proof} 
We have $n (f x) = e^{-1} x = e x$. So $f x$ and $e x$ are at the
same node. If they are also in the same face of a simple hypermap, 
this gives $f x = e x
= y$. So $$n y  = n f x = n f e y = y,$$ and $y$ is a fixed
point of $n$, hence degenerate, contrary to assumption.  
Thus, $f x$
and $e x$ are in different faces, and the walkup merges
by Lemma~\ref{lemma:merge-split}.  
\end{proof}




\subsection{contour}

\begin{definition}[contour~path]  A contour path is a function $p:\{0,\ldots,k\}\to D$
such that $p_{i+1} =
n^{-1} p_i$ or $f p_i$ for each $i<k$.  (That is, each
step in the path is clockwise step around a node or a
counterclockwise step around a face.)   If the contour path
is injective on $\{0,\ldots,k-1\}$
and  $p_0 = p_k$, then it is a contour loop.
\indy{Index}{contour path}\indy{Index}{path}
\indy{Index}{contour loop}\indy{Index}{loop}
\end{definition}

\begin{lemma}\guid{KDAEDEX}\rating{100}\tlabel{lemma:connect-contour}  
If $x$ and $y$ are darts in the same combinatorial component, then there exists a contour path from $x$ to $y$.
\end{lemma}

\begin{proof} 
By being in the same orbit, the darts $x$ and $y$ are joined by a path, where each step is $z\mapsto h z$, for $h=e,n$, or $f$.  Eliminate $e$-steps through the relation $e\circ n\circ f = I$.   Replace each $n$-step with a sequence of $n^{-1}$-steps.  This gives the desired path.
\end{proof}

\begin{definition}[M\"obius~contour] A M\"obius contour is an
injective contour path $p$ that satisfies
    \begin{equation}
    \tlabel{eqn:mobius}
    p_j = n p_0\quad p_k = n p_i
    \end{equation}
for some $0 < i\le j< k$ (Figure~\ref{fig:mobius}).
\end{definition}

\begin{figure}[htb]
  \centering
  \myincludegraphics{noimage.eps}
  \caption{A M\"obius contour}
  \label{fig:mobius}
\end{figure}

\begin{figure}[htb]
  \centering
  \myincludegraphics{noimage.eps}
  \caption{A M\"obius contour with three darts}
  \label{fig:3m}
\end{figure}


\begin{remark}
G. Gonthier devised the notion of M\"obius contour
as a way to prove the Four-Color theorem without appeal
to topology.  (The Appel-Haken
proof of the Four-Color theorem relies on the Jordan
curve theorem.)  A M\"obius contour is a 
combinatorial M\"obius strip that
twists to make 
its left-hand side into
its right-hand side.  A planar hypermap has no such contour.  
Figure~\ref{fig:violate-jct}
redraws a violation of the Jordan curve theorem
as a M\"obius contour.   
\end{remark}

\begin{figure}[htb]
  \centering
  \myincludegraphics{noimage.eps}
  \caption{A path that tunnels from the interior to the exterior
   of a simple closed curve
   is analogous to a M\"obius contour.}
  \label{fig:violate-jct}
\end{figure}






\begin{lemma}\guid{LIPYTUI}\rating{150}\tlabel{lemma:no-mobius}
Planar hypermaps have no M\"obius contours.
\end{lemma}

\begin{proof} For a contradiction, assume that there exist planar
hypermaps with M\"obius contours.  An edge walkup carries
planar hypermaps into planar hypermaps. An edge walkup
at a dart that is not on the M\"obius contour carries the
M\"obius contour to a M\"obius contour 
and reduces the number of darts.  
In the M\"obius Condition~\ref{eqn:mobius},
an edge walkup at a dart that is not at position $0$, $i$, $j$, $k$
along the contour carries the M\"obius contour to a M\"obius contour
and reduces the number of darts. Thus, a counterexample with
the smallest possible number of darts contains no
darts except those on the M\"obius contour, and its only darts
are at positions $0$, $i=j=1$, $k=2$.

This is a three darted hypermap (Figure~\ref{fig:3m}.)  
The M\"obius condition, the
definition of contours, together with $e\circ n\circ f=I$ force
$e=n=f$, all permutations of order three. We reach the contradiction
that this hypermap is not planar:
    $$3 = \# e + \# n + \# f,\quad 5 = 3+2 = \# D + 2 \#\tangle{e,n,f}.$$
\end{proof}


\begin{lemma}\guid{ITBCENB}\rating{150}\tlabel{lemma:node-nonsimple}  
Let $(D,e,n,f)$ be a hypermap with no M\"obius contours.
Let $y$ be a dart at a node $N$.
Suppose that the $f$-orbit of $y$ meets $N$ in
at least two darts.  Then $N$ is an articulation node.  Specifically,  any contour path from $f y$
to $f^{-1} y$ passes through the node $N$.  
\end{lemma}

In particular, a biconnected hypermap with no M\"obius contours is simple.

\begin{proof} Let $F$ be the $f$-orbit of $y$.
Let $i>0$ be the smallest index such that $f^i y\in N$.
By assumption $f^i y \ne y$.
Let $F' = \{y,f y,\ldots f^{i-1} y\}$.
For a contradiction, assume that there is
a contour path  $(f y,\ldots,f^{-1} y)$ that avoids $N$.
Note that $f y\in F'$ and $f^{-1} y\not\in F'$.
%
The contour path has a subpath $(w,x,\ldots,z)$, where
$w\in F'$, $z\not\in F'$,  $x,\ldots\not\in F$.  
We have $x=n^{-1}w$.

We form a path $x$ to $z$ along this subpath, then
follow $f$-steps to $f^i y\in N$, passing through $y$ and
then $n x = w$ along the way.
Then take $n^{-1}$-steps around the node $N$ to $n y$.  This
path is injective.  It follows the order
   $$
   x\ldots y\ldots n x\ldots n y.
   $$
This is a M\"obius contour.
\end{proof}


\begin{definition}[interior]\label{def:interior} 
a dart $y$ lies in the {\it interior} of a contour
loop $L$ if there is a an injective contour path
$x_0,x_1,\ldots,x_k=y$ such that $x_1 = f x_0$ (if $k>0$), and
such that $x_i$ lies on the loop $L$ if and only if $i=0$.
%$P$ is called an interior path from $x_0$ to $y$.
Write $D_{int}(L)$ for the set of darts in the interior of $L$.
\end{definition}

\begin{lemma}\guid{ILTXRQD}\rating{100}\tlabel{lemma:contour-path-type}
Suppose that a hypermap has no M\"obius contours.
Let $L$ be a contour loop.  Let $P$ be any injective contour path
that starts and ends on $L$, but visits no other darts of $L$ inbetween.  
Then the first and last steps of $P$ are both of the same
type ($n^{-1}$ or $f$).
\end{lemma}

\begin{proof}  Suppose $P$ is $n x,f n x,\ldots,n y,y$.   Form
contour path starting at $x$, then $n^{-1}$ steps to $L$, then
follow $L$ to $y$, and on to $n x$.  Follow $P$ back to $n y$.  This
is a M\"obius contour.

Suppose $P$ is $n x,x,\ldots,f^{-1} y,y$.  Form a contour path
starting at $x$, then along $P$ to $y$, along $L$ to $n x$, and
continuing on $L$ to $n y$.  This is a M\"obius contour.
\end{proof}




\begin{lemma}\guid{UMYSGDB}\rating{80}\tlabel{lemma:dart-interior}
Let $L$ be a contour loop on a plain hypermap without
M\"obius contours.  Assume a dart $x$ lies in the interior of the loop $L$. 
Then every dart in its $f$-orbit lies in
the interior of the loop.  Moreover, if the dart
$x$ does not lie on the same node as any dart in $L$, then every
dart in the $n$-orbit of $x$ lies in the interior 
of $L$.
\end{lemma}

\begin{proof} Let $P= x_0,\ldots,x$ be an injective path that certifies that $x$ lies
in the interior of $L$.  If $f x$ lies along this path already or if it lies on $L$,
then it is clearly interior.  Otherwise, $x_0,\ldots,x,f x$ is a certifying path
for $f x$.  Similarly, use the certifying path $x_0,\ldots,x,n^{-1} x$ for $n^{-1} x$.
\end{proof}


\begin{definition}[interior~face,~node]  A face or a node is interior to a
loop in a hypermap if all of its darts are interior.
\end{definition}

\begin{lemma}\guid{ICJHAOQ}\rating{180}\tlabel{lemma:contour-interior-exterior}
Suppose that a hypermap has no M\"obius contours.  Let $L$ be a contour loop.
Let $x$ be a dart interior to $L$.  Then there does not exist an injective contour path
$$x_0,\ldots,x_k=x$$
such that $x_i$ does not lie on $L$ for all $i$ and such that $x_0$ lies at a node
visited by $L$.
\end{lemma}

\begin{proof} Assume for a contradiction that the path exists. 
We can reverse the path to get a contour path from $x$ back to a dart $x'_0$ (not on $L$ but at a node
visited by $L$).  In fact, Lemma~\ref{lemma:dart-interior}, shows that the interior points consist of $f$-orbits
and $n$-orbits (away from nodes visited by $L$).  Thus an $f$-step from $x_i$ to $x_{i+1}$ can be replaced
with a sequence of $f$ steps from $x_{i+1}$ to $x_i$.  Similarly and $n^{-1}$ step from $x_i$ to $x_{i+1}$
can be replaced with a sequence of $n^{-1}$ steps from $x_{i+1}$ to $x_i$.  When we reach a dart $x'_0$ on a node
visited by $L$ we stop.  

There is a contour path $y_0,f y_0,\ldots,x$ that certifies that $x$ is interior.  Concatenate this
with the reversed path from $x$ back to $x'_0$.  Then add a sequence of $n^{-1}$ steps to reach a dart $z$
on $L$.  Pass to a subsequence to get an injective contour path $y_0,\ldots,z$ that starts with an $f$ step
and ends with an $n^{-1}$ step.  This is prohibited by Lemma~\ref{lemma:contour-path-type} 
\end{proof}


%
%\begin{lemma}\guid{HWQROBK}\tlabel{lemma:dart-n-fixed}
%Suppose that in a nonempty hypermap without M\"obius contours,
%there is a face that coincides with a combinatorial component of
%darts.  Then that face contains a dart that is fixed under $n$.
%\end{lemma}
%
%\begin{proof}  If the face contains a single dart, then it is
%obviously fixed by $n$.  Assume that the face contains at least two
%darts.  For a contradiction, assume that none of the darts is fixed
%by $n$.  Thus, every node contains at least two darts.
%
%We will use the face path $z,f z,f^2 z,\ldots$ to construct a
%M\"obius contour. Since the set of darts is finite, the face path
%must eventually revisit a node already encountered.  Thus, we can
%find a subpath $z',f z',\ldots,f^{k+1} z'$ such that the first $k$
%darts lie on distinct nodes, but $f^{k+1} z'$ and $z'$ lie in the
%same node $A$.
%
%If we had $f^{k+1} z' = z'$, then we have the full $f$-orbit in this
%subpath, and hence also the full component.  We have
%$k>0$, so $f z'$ is then a dart that has no other darts in its node,
%and is hence a fixed-point.  Hence $f^{k+1} z'\ne z'$.
%
%Continue the path further, so that $f^{r+1} z'$ is at the same node
%as some $f^p z'$ (with $p < r$), at a different node than
%$z',\ldots,f^r z'$, but so that the only repeated node among
%$z',\ldots,f^r z'$ is the one at $z'$.  We have $0 < p$.
%
%If $f^{r+1} z' = f^p z'$, then $f^{r+1-p} z' = z'$ so all darts are
%in the segment $z',f z',\ldots,f^{r-p} z'$ and the only node with
%more than one dart is the one at $z'$.  Thus, we have a fixed point.
%So $f^{r+1} z'\ne f^p z'$.
%
%Let $0 < k_1 < k_2 < \cdots < k_m < r+1$ be the indices at which
%$f^{k_i} z'$ is at $A$.  Let $x = n^{-1} f^{k_m} z'$. If the segment
%$x,n^{-1} x,\ldots,z'$ contains some $f^{k_i} z'$, we obtain a
%M\"obius contour.  [X DETAIL.]  Take $n^{-1}$ steps from $x$ to
%$z'$. Then take $f$-steps to $y = f^p z'$, on to $n x = f^{k_m} z'$,
%on to $f^{r+1} z'$, then $n^{-1}$ steps to $n y$.  This is a
%M\"obius contour.
%\end{proof}
%
%\begin{lemma}\guid{KHVQHCT}[Jordan curve theorem for hypermaps]\tlabel{lemma:jct-hypermap}
%  If a plain hypermap
%has no M\"obius contours then it is planar.
%\end{lemma}
%
%\begin{proof}  Face double walkups along edges preserve the planar
%index.  By repeated application, we reduce to the case where every
%component contains a single face. In
%other words, $f$ acts transitively on the darts in a given combinatorial component.
%
%If there are any darts that are fixed by all three maps $e,n,f$,
%then the walkup at that dart eliminates the dart while preserving
%the planar index.  Thus, we may assume there are no such darts.
%
%If there are any darts that are fixed points under $n$, then the
%dart is degenerate.  The double walkup (of any type) along the edge
%that meets that dart eliminates the dart while preserving the planar
%index.  Thus, we may assume that there are no such darts.
%
%By the previous lemma, the plane hypermap must be empty.  Thus, our
%planar-index preserving walkups have transformed an
%arbitrary plane hypermap without M\"obius contours into the empty
%hypermap, which is clearly planar.  The result follows.
%\end{proof}
%




\section{Generation}

\subsection{quotient}

\begin{definition}[isomorphic] Two hypermaps $(D,e,n,f)$ and $(D',e',n',f')$ are
isomorphic, if there is a bijection $F:D\to D'$ such that
    $$h'\circ F = F\circ h$$
for $(h,h')=(e,e'), (f,f'), (n,n')$.
\end{definition}


\begin{definition}[normal~collection]
Let $H$ be a hypermap. Assume that 
there are no darts fixed by $e$ 
(so that we can distinguish $f x$
from $n^{-1} x$ at each dart). 
Let $\cal L$ be a collection of contour
loops.  We say that $\cal L$ is a normal collection if the following
conditions hold of its loops. \begin{itemize}
 \item No dart is visited by two different loops.
 \item Every loop visits at least two nodes.
 \item If a loop visits a node, then every dart at that node is
 visited by some loop.
\end{itemize}
\end{definition}

From a normal collection we can form a new hypermap.   A dart in the
new set $D'$ of darts
$D$ is a maximal sequence $[x,n^{-1} x, n^{-2} x,\ldots,n^{-k} x]$
    of $n^{-1}$ steps appearing in some loop in $\cal L$.
The map $f'$ takes the maximal sequence
    $[x,n^{-1}x,\ldots,y]$ to the maximal
   sequence (in the same contour loop) starting 
    $[f y,\ldots]$.
The map ${n'}^{-1}$ takes the maximal sequence
    $[\ldots,y]$ to the maximal sequence (in some other contour loop)
starting $[n^{-1}y,\ldots]$. Equivalently, 
$n'$ takes the maximal sequence
$[x,\ldots]$ to the maximal sequence ending $[\ldots,n x]$. The map $e$ is
defined by $e'\circ n'\circ f' = I$.  

\begin{definition}[quotient]  The hypermap constructed from the normal collection
is called the quotient of $H$ by $\cal L$, and is denoted $H/{\cal
L}$.  The hypermap $H$ is said to be a cover of $H/{\cal L}$.
\end{definition}

Intuitively, we can represent the quotient hypermap as a graph whose
cycles under $f$ 
are precisely the contour loops in the normal family (Figure~\ref{fig:quot}).

%% No sketch has been made for this.
\begin{figure}[htb]
  \centering
  \myincludegraphics{noimage.eps}
  \caption{The contour loops in a normal 
   family become faces in the
   quotient}
  \label{fig:quot}
\end{figure}


\begin{example}\label{ex:Hall} 
Assume that $H$ is a hypermap with no fixed points under $e$.
Assume that every face visits at least two nodes.
Then the set of all faces
defines a normal collection of contour loops (follow $f$ around each face:
$x,f x,\ldots$).  Each dart of the quotient is then just a singleton
set consisting of a single dart of $H$, and the quotient is
isomorphic to $H$ itself.
\end{example}

\begin{example}\label{ex:H2} 
Assume that $H$ is a hypermap with no fixed points
under $e$.  Let $F = (x,f x,\ldots)$ be a face 
that visits at least
three nodes and that meets each node in at most one dart.
Let $\cal L$ be the
collection with two contour loops:  $(x,f x,\ldots)$ and its
complement
$$[n^{-1} x,
n^{-2} x,\ldots,n x,f n x = y,n^{-1} y, n^{-2} y,\ldots, n y, f n
y,\ldots]
$$
(See Figure~\ref{fig:contour-comp}.) 
The family $\cal L$ is normal.
The quotient hypermap $H/{\cal L}$ has two faces $F$ and a
backside $F'$ of the same cardinality $k$.
\end{example}


\begin{figure}[htb]
  \centering
  \myincludegraphics{noimage.eps}
  \caption{The complementary contour loop traces the remaining darts
   at the same nodes as the origonal contour loop.}
  \label{fig:contour-comp}
\end{figure}


\begin{example}\label{ex:H2k} 
We 
construct a
hypermap $H_{2k}$, whose darts are arranged in two faces.  Each
face is $Z_n$, a cyclic group of order $n$ with generator $1$.
The face map is $x\mapsto x+1$.
The node map swaps the two faces $Z_n$.
The usual condition $e\circ n\circ f = I$ defines the edge map.
If a hypermap is isomorphic to $H_{2k}$ for
some $k$, then we say that it is {\it cyclic}.  For example,
the hypermap constructed in the previous example is cyclic.
\indy{Index}{cyclic hypermap}
\end{example}

\begin{lemma}\guid{JMKRXLA}\rating{280}\tlabel{lemma:quotient-plain}
Let $H$ be a plain hypermap, and let $\cal L$ be a
normal family.  Then $H/{\cal L}$ is a plain hypermap.
\end{lemma}

\begin{proof} Let $e'$, $f'$, and $n'$ be the edge, face, and node maps on the
quotient hypermap.  Write $[\ldots, x]$ for the node in the quotient
ending in dart $x\in H$ and $[x,\ldots]$ for the node in the quotient
starting with dart $x\in H$.  We have $e^2 x = x$, so that for any
dart $[\ldots x]$ in the quotient:
    $$\begin{array}{lll}
    {e'}^{-2} [\ldots, x] &= n' f' n' f' [\ldots, x] = n' f' n' [f x, \ldots] \\&=
    n' f' [\ldots, n f x] = n' [f n f, \ldots] = [\ldots, n f n f x]\\ &=
    [\ldots, e^{-2} x] = [\ldots, x].
    \end{array}$$
Thus, $e'$ has order $2$ on the quotient.
\end{proof}

%\begin{lemma}\guid{ZOKKAOI}\tlabel{lemma:quotient-planar}
%Let $H$ be a plain planar hypermap, and let $\cal L$
%be a normal family.  Then $H/{\cal L}$ is a plain planar hypermap.
%\end{lemma}
%
%\begin{proof} Suppose $H/{\cal L}$ is not planar.
%Let $P$ be a M\"obius contour on $H/{\cal L}$.  It lifts uniquely to
%a contour on $H$ with the property that the darts visited on $H$ are
%precisely the darts that belong to a dart in the quotient.  This is
%compatible with the node map $n$.  So the contour path lifts to a
%M\"obius contour on $H$.  Thus, $H$ is not planar.
%\end{proof}


\subsection{flag}

By the end of the chapter, we present an algorithm that
generates all plain planar hypermaps satisfying certain general
conditions.   The algorithm  proceeds by adding edges and nodes to a hypermap by reverse double walkup transformations.

The algorithm  marks certain faces as `true.'
Roughly, this  means that the the face cannot be modified
at any later stage of the algorithm.   When all of its faces
are true, the hypermap stands in final form.
The function that marks each face as true or false is a
{\it flag}.


\begin{definition}[flag]  A flag on a hypermap
is a boolean function on its set of faces 
that satisfies the following two
constraints.
\begin{itemize}
    \item If darts $x,y$ belong to true faces,
    then there is a contour path from $x$ to $y$ that remains
    in true faces.
    \item Every false face has some edge that is shared with a true face.
    \end{itemize}
%An isomorphism of flagged hypermaps is an isomorphism of
%hypermaps that respects the flags.
\end{definition}

\begin{example} Let $H/{\cal L}$ be a quotient hypermap with
normal family $\cal L$.  The canonical boolean function
$\phi$ on the set of faces of the quotient is the function that
is true exactly when every dart in
the face is a singleton of $H$.
\end{example}

\begin{example} The cyclic hypermap of Example~\ref{ex:H2k}, carries a flag that marks one face true and the other false.
\end{example}

\begin{example} Let $H$ be a connected, plain hypermap, and such that $e$ has no fixed points, and let $\cal L$ be the example of Example~\ref{ex:Hall}, then the canonical map takes value $\op{true}$ on every face.  This is a flag. In fact, Lemma~\ref{lemma:connect-contour} provides the contour paths that are required in the definition of flag.
\end{example}

\begin{lemma}\guid{STKBEPH}\rating{100}\tlabel{lemma:all-dart}  
Let $H$ be a hypermap with normal family ${\cal L}$. If the canonical boolean function on the set of faces of $H/{\cal L}$ has at least as many true values as there are faces of $H$, then $\cal L$ is the normal family in Example~\ref{ex:Hall}. In particular, $H/{\cal L}$ is isomorphic to $H$.
\end{lemma}

\begin{proof}  If a face takes value $\op{true}$ in $H/{\cal L}$, then its darts are singletons, and the face of $H/{\cal L}$ is naturally identified with a face in $H$.  This is an injective map from the set of true faces of $H/{\cal L}$ to the set of faces of $H$.  The hypothesis of the lemma implies that this injective map is bijective. All of the darts of $H$ are accounted for under this bijection. Thus, the quotient has no false faces.  The result follows.
\end{proof}


\subsection{hypermap extension}\label{sec:face-insert}

In this subsection, we assume that $H$ is a hypermap with the following properties:
    \begin{enumerate}
        \item It is connected, plain, planar, simple.
        \item The edge map $e$ has no fixed points.
        \item The node map $n$ has no fixed points.
        \item The size of every face is at least $3$.
        \item There are at least $2$ faces. 
        %%  (All hypoth. Needed?)
    \end{enumerate}

Let $H=(D,e,n,f)$ be a hypermap with normal family $\cal L$, quotient $H/{\cal L}$.  We assume that the quotient is simple.  We assume that the canonical boolean function on $H'=H/{\cal L} = (D',e',n',f')$ is a flag.  Choose $F'$ be a false face of the quotient, corresponding to a contour loop $L$ of ${\cal L}$ and choose $x'\in F'$ that lies on an edge that meets a true face.   $x' = [\ldots,x]$.  As the face $F'$ is false in the canonical flag, there is a smallest $i>0$ such that $f^i x$ is followed by a $n^{-1}$ step in a loop of ${\cal L}$. Let $y = f^i x$. Consider the darts $f^{j+1} y$.  There is a smallest $j\ge0$, such that $f^{j+1} y$ is a dart in ${\cal L}$.  Set $z=f^{j+1} y$.

\begin{lemma}\guid{HQYMRTX}\rating{200}  $z$ is on the contour loop $L$ and is not equal to $f^k x$, for $0 < k \le i$.
\end{lemma}

\begin{proof} 
For a contradiction, suppose $f^{j+1} y = f^k x$. Then also, $f^j y = f^{k-1} x$.  If $j>0$, then this goes against the minimality of $j$.  So $j=0$, and $y=f^{k-1} x = f^i x$.  Also, $k-1 < i$, which contradicts the minimality of $i$.  This proves the second claim of the lemma.

For a contradiction, assume that $z = f^{j+1} y$ lies on a different contour loop $L'$.  If $z$ lies in a true face, then $y$ and $x$ lie in the same true face, contrary to the choice of $x$.  So $z$ lies in a false face.  By the definition of flag, if $z$ is on a false face, then following its contour loop, we arrive at an the edge of $H'$ that has a dart $z'$ in a true face. Again by flags, there is a path from $z'$ to $x''$ the dart in the true face on the same edge of $H'$ as $x'$.  Composing these paths, we obtan a path $[y,f y,\ldots,z,\ldots,z',\ldots,n f x,f x]$ from the loop $L$ to itself that starts with a step $f$ and ends with a step $n^{-1}$, contrary to Lemma~\ref{lemma:contour-path-type}
\end{proof}


We make the following construction.  Let $L'$ be the contour loop
$$
[x,\ldots,y,f y,\ldots,z,\ldots,x]
$$
that follows the contour loop $L$ from $x$ to $y$, then takes $f$-steps from $y$ to $z$, then continues on the contour loop back to $x$.
Let $L''$ be the contour loop
$$
[n^{-1} y,\ldots,n z,f n z,\ldots,n^{-1}y],
$$
which follows the contour loop $L$ from $n^{-1} y$ to $n z$, then reverses the path of $L'$ from $y$ to $z$, traveling instead from $n z$ to $n^{-1} y$. Let ${\cal L'}$ be the normal family obtained by eliminating $L$ and replacing it with $L'$ and $L''$.

\begin{lemma}\guid{AQIUNPP}\rating{400}\tlabel{lemma:flag}  
${\cal L'}$ is a normal family, the canonical function is a flag, and the quotient $H/{\cal L'}$ is simple.
\end{lemma}

\begin{proof} The paths $L'$ and $L''$ visit every dart visited by $L$.  They visit every dart at the nodes of $y,\ldots,z$.  Thus, if a loop visits a node, then every dart at that node is visited by some loop.

Next, we check that no dart is visited by two different loops.  By construction, the sets of darts are visited by $L'$ and $L''$ are disjoint and disjont from the darts visited by the loops of ${\cal L}\setminus \{L\}$.  The result follows.

Finally, every loop visits at least two nodes.  This is true for $L'$ and $L''$ because they visit the nodes of $y$ and $z$.  It is true of the other loops because they belong to the normal family ${\cal L}$.

Next we show that the canonical function is a flag. The contour loops and values of the canonical function do not change on ${\cal L}\setminus \{L\}$.  As $L$ corresponds to a false face, the two defining properties of a flag hold for ${\cal L}\setminus \{L\}$.  The faces $L',L''$ might be either true or false.  Each has an edge shared with a true face.  Also, the darts in each can follow the loop ($L'$ or $L''$) until reaching that edge, so if the face is true, its darts can be connected to any other true dart.  Thus, the canonical function is a flag.

To check simplicity of the quotient, we must check that each of the contour paths in ${\cal L}'$ never returns to a node after leaving it.  This is true of ${\cal L}\setminus\{L\}$ by assumption and true of $L'$ and $L''$ by construction.
\end{proof}

\subsection{algorithm}

We pass from  $H/{\cal L'}$ to $H/{\cal L}$ by a double walkup on all of the nodes coming from the nodes of $f y$, $f^2 y, \ldots, f^j y$, and then a double walkup on the edge from the node of $y$ to the node of $z$.  We pass in the other direction from $H/{\cal L}$ to $H/{\cal L'}$ by adding an edge from the node of $y$ to the node of $z$ and inserting $j$ new nodes (of degree two) along it.

Repeating this construction, starting with $H/{\cal L'}$ and using the same initial dart $x$, with each successive iteration, the natural number $i$ increases, until eventually, $x$ lies on a true face.  When this occurs, the number of true faces increases by one.  By Lemma~\ref{lemma:all-dart}, the process terminates when the number of true faces is sufficiently large, and the quotient $H/{\cal L}$ becomes isomorphic to $H$.

To begin the process, we may take ${\cal L}$ to be the normal family of Example~\ref{ex:H2} with two contour loops, whose quotient hypermap is a polygon $H_{2k}$.  We may assume that we pick the contour loops so that $k$ is as large as possible.  The natural number $k$ is then an upper bound on size of a face.

In summary, we have described a process that by starting with a single polygon and then adding edges and nodes of degree two along the inserted edges, we obtain the connected, biconnected, plain, planar hypermap $H$.

We can describe the steps of the process in a way that does not make explicit reference to the hypermap $H$, nor to the normal family ${\cal L}$.  Let $M$ be an a priori upper bound on the size of a face.  Let $V$ be an a priori upper bound on the number of faces.  For each $k=3,\ldots,M$, we give the steps to generate all  hypermaps whose faces have size at most $k$, with at most $V$ darts, and that satisfy all the properties listed at the beginning of Section~\ref{sec:face-insert}.  Since each face is assumed to contain at least $3$ darts, $V/3$ is an a priori upper bound on the number of faces.

We begin with the following initialization.
We begin with the polygonal hypermap $H_{2k}$.  A flag $t$ marks one face  true and the other false.  We pick out two special darts $x\ne y$ on the false face, with $x\ne y$. 

At each iteration, we have a finite list of objects $(H,t,x,y)$, where $H$ is a connected simple hypermap, $t$ is a flag on $H$, and $x$ and $y$ are two distinct darts on a false face (or any two darts of $H$ if there are no false faces).  The algorithm terminates when every face of every hypermap in the list is true.  At every step of the algorithm, one quadruple with some false face is removed and finitely many quadruples are added to the list.


The hypermap of each of the quadruples that is added at each step have at least one more face than the one removed.  Each isomorphism class of hypermap is added to the list at most finitely many times.  These conditions are sufficient to give the termination of the process.

At each interation the chosen $(H,t,x,y)$ is modified in the following ways and each modification is placed back on the stack.
\begin{itemize}
\item ~[new true face] The false face containing $x$ and $y$ is marked true.  If all faces are true, the graph is returned to the stack.  Otherwise, distinct darts $x$ and $y$ are selected on a new false face, where the edge of $x$ meets a true face.
\item ~[new edge] Write $y=f^i x$ where $i>0$ is as small as possible.  Pick $z$ on the same false face, where $z\ne f^k x$, $k\ne 1,\ldots,i$.  For each such $z$ and for each $j=0,\ldots,M-\#f$, construct a new edge from $y$ to $z$, with $j$ added nodes of degree $2$.  (The reverse double edge walkup splits the face into two.)  Replace $(x,y)$ with $(x,z)$.  If $z=x$, execute the first step [new true face] before returning the modified hypermap to the list.
\end{itemize}

In summary, we have an algorithm for the construction of hypermaps:

\begin{lemma}\guid{BRGEFNH}\rating{2000}  Fix $k>0$ and $V>0$.
This process constructs in a finite number of steps all hypermaps such that
\begin{itemize}
\item The hypermap is connected, plain, planar, and simple.
\item The edge map $e$ has no fixed points.
\item The node map $n$ has no fixed points.
\item The size of every face is at least $3$ and at most $k$.
\item There are at least $2$ faces and at most $V$ faces.
\end{itemize}
\end{lemma}







%%%%%%%%%%%%%%%%%


\chapter{Fan}\label{sec:fan}

A hypermap is a combinatorial object, but a packing
is a geometric object.  This chapter combines the combinatorics
with the geometry, as objects called fans.  A fan is a geometric
object, yet there is a hypermap attached to it,
which encodes the combinatorial properties of the fan.



If $\e=\{v_1,v_2\}$ is a set of two points and $v$ is any other point,
set
  $$
  \begin{array}{lll}
  C(v,\e) &= \op{aff}_+(v,\e)\\
  C^0(v,\e) &= \op{aff}^0_+(v,\e)\\
  \end{array}
  $$

\begin{definition}[fan]  Let $(\orgn,V,E)$ be a triple consisting of a point,
a set of
points, and a set of pairs of elements of $V$.  The triple is said to be
a {\it fan\/} if the following conditions hold.
    \begin{itemize}
    \item $V$ is finite and nonempty.
    \item $\orgn\not\in V$.
    %\item Each element of $E$ has two elements.
    \item For each $v\in V$, the set
        $$
        %% WW changed notation from E_v to E(v) to allow deformations E_t
        E(v) = \{w\in V\mid \{v,w\}\in E\}
        $$
        is cyclic with respect to $(\orgn,v)$.
    \item For each $\e\in E$, $V\cap C^0(\orgn,\e)=\emptyset$.
    \item For sets $\e,\e'\in E$,   we have
        $$C^0(\orgn,\e) \cap C^0(\orgn,\e')\ne\emptyset\ \Rightarrow (\e = \e').$$
    \item For $v,v'\in V$, we have
      $$\op{aff}^0_+(\orgn,v) = \op{aff}^0_+(\orgn,v')\ \Rightarrow (v=v').$$
      %% Added condition May 15, 2009.
    \end{itemize}
Call $C^0(\orgn,\e)$ or $C(\orgn,\e)$ a {\it blade\/} of the fan.
\indy{Index}{blade}
\indy{Index}{fan}
\end{definition}

We make a series of remarks about this definition.

\begin{remark}\tlabel{rem:fan}\rating{30}
\begin{itemize}
\item The point $\orgn$ is a base point that will be fixed throughout
the chapter.  
\item The pair $(V,E)$ is a graph with nodes $V$ and edges $E$.  The set
$\{\{v,w\}\mid w\in E(v)\}$ is the set of edges around a fixed node $v$.
Note that $w\in E(v)$ if and only if $v\in E(w)$.   
%
\item The final condition implies that the sets $C^0(\orgn,\e)$
do not meet.   This condition will eventually yield planar
hypermaps.
%
\item
By the condition that $E(v)$ should be cyclic,
for each $v\in V$, we have an azimuth cycle $\sigma(v):E(v)\to E(v)$.
We allow $E(v) = \{w\}$ to be a
singleton set. If so,
$\sigma(v)$ is the identity map on $E(v)$.
%
\item
Sometimes we write $\sigma(v,w)$ for $\sigma(v)(w)\in E(v)$.
%
\item 
The hypothesis of an azimuth cycle
prevents $\{\orgn,v,v'\}$ from being a collinear set, when $\{v,v'\}\in
E$.  In particular, there are no loops: $\{v,v\}\not\in E$.
%
\end{itemize}
\end{remark}





Let $(\orgn,V,E)$ be a fan.  We define a sets of darts $D$, and
two subsets $D_1,D_2$:
    $$
    \begin{array}{lll}
    D_1 &= \{(\orgn,v,w,w')\mid v\in V,\ w\in E(v),\ w' = \sigma(v,w)\}\\
    D_2 &= \{(\orgn,v) \mid v\in V,\ \ E(v) = \emptyset\},\\
    D   &= D_1\cup D_2.
    \end{array}
    $$
Darts in $D_2$ are said to be {\it isolated}; and darts in $D_1$ are {\it non-isolated}.
%
We define a permutation $n$ on $D_1$ by
    $$n(\orgn,v,w,w') = (\orgn,v,w',\sigma(v,w')).$$
We define a permutation $f$ on $D_1$ by
    $$
    f (\orgn,v,w,w') = (\orgn,w,\sigma(w)^{-1} v,v).
    $$
Define a permutation $e$ on $D_1$ by
    $$
    e (\orgn,v,w,w') = (\orgn,w,v,\sigma(w,v)).
    $$
%(Note that the symbol $e$ has two meanings according to context, both as the edge permutation and as an element of $E$.)
Define permutations $e,n,f$ on $D_2$ by making them degenerate on $D_2$:
    $$
    e (\orgn,v) = n(\orgn,v) = f(\orgn,v) = (\orgn,v).
    $$
Write $\op{hyp}_r(\orgn,V,E)=(D_1,e,n,f)$ and
Write $\op{hyp}(\orgn,V,E)=(D,e,n,f)$.  We call them the non-isolated hypermap
and the hypermap associated with $(\orgn,V,E)$.  The next
lemma justifies this terminology.



\begin{lemma}\guid{AAUHTVE}\rating{70}
Let $(\orgn,V,E)$ be a fan.  Let $D = D_1\cup D_2$
and $\op{hyp}(\orgn,V,E) = (D,e,n,f)$, as constructed above.  Then
    \begin{itemize}
    \item $\op{hyp}(\orgn,V,E)$ is a plain hypermap.
    \item  $e$ has no fixed
points in $D_1$.
    \item  $f$ has no fixed points on $D_1$.
    \item For every pair of distinct nodes, there is at most one
    edge meeting both.
    \item The two darts of an edge (of $D_1$) lie at different nodes.
    \end{itemize}
\end{lemma}

\begin{proof}  We compute
    $$
\begin{array}{lll}
e(n(f(\orgn,v,w,w'))) &= e(n(\orgn,w,\sigma(w)^{-1} v,v))) &=
        e(\orgn,w,v,\sigma(w, v))\\ 
&= (\orgn,v,w,\sigma(w, v)) &= (\orgn,v,w,w').
\end{array}
$$
So it is a hypermap. We compute
    $$e(e(\orgn,v,w,w')) = e(\orgn,w,v,\sigma(w,v)) = (\orgn,v,w,w').$$
So it is plain. A fixed point in $D_1$ under $e$ would force $v = w\in E(v)$,
but by construction $v\not\in E(v)$.  The argument that $f$ has no
fixed points is similar.

   We show that for every pair of distinct nodes, there is at most one edge
meeting both.
That is,
        $$(n^k e x = e n^\ell x)\Rightarrow (n^\ell x = x).$$
Let $x = (\orgn,v,w,w')\in D_1$.  Let $\sigma=\sigma(v)$. Then
    $$
    \begin{array}{lllllll}
    n^\ell x &= (\orgn,v,\sigma^\ell w,\sigma^{\ell+1}w)\\
    e n^\ell x &= (\orgn,\sigma^\ell w,*,*)\\
    e x &= (\orgn,w,*,*)\\
    n^k e x &= (\orgn,w,*,*)\\
    n^k e x &= e n^\ell x &\ \Rightarrow (w = \sigma^\ell w) &\ \Rightarrow
    (n^\ell x &= (\orgn,v,w,\sigma w) = x)
    \end{array}
    $$

Finally, we show that each dart of an edge lies on a different node.
That is, $e x \ne n^k x$, for $x\in D_1$.  We have
    $$
    \begin{array}{lll}
        e(\orgn,v,w,w') &= (\orgn,w,*,*),\quad w\in E(v)\\
        n^k(\orgn,v,w,w') &= (\orgn,v,*,*),\quad v\not\in E(v).
    \end{array}
    $$
The result follows.
\end{proof}

\section{Topology}\label{sec:topology}

\subsection{basics}

There is hardly any topology that comes up in this book.  Most of
what is needed appears in this chapter.  We make use of some basic
notions in topology such as continuity, connectedness, and compactness.

\begin{remark} The term {\it connected} is now being used in
two different senses: in the topological sense and in a combinatorial
sense for hypermaps.   We will refer to the connected components
of a topological space as topological components and the connected
components of a hypermap as combinatorial components to reduce the confusion.
\end{remark}






The set $\ring{R}^3$ is a metric space under the
Euclidean distance function $d(v,w) = \norm{v}{w}$.  Subsets of
$\ring{R}^3$ are a metric space under the restriction of the metric
$d$ to the subset. Subsets carry the metric space topology. 
If $Y$ is an open set in $\ring{R}^3$, write
$\comp{Y}$ for its set of topological components.
If two
points in $\ring{R}^3$ 
can be joined by a continuous path that avoids $X$,
then they lie in the same topological component of $Y$.
If we produce a family of pairwise disjoint nonempty connected open sets in
$Y$, whose union is all of $Y$, then
this family is $\comp{Y}$.
%embers of the family are the topological components of $Y$.
Let $$S^2(\orgn) = \{ v \mid \norm{ v}{\orgn } = 1\}$$ be the unit sphere in
$\ring{R}^3$, centered at $\orgn$.  






\subsection{topological component and dart}

Let $(\orgn,V,E)$ be a fan and let $(D,e,n,f) = \op{hyp}(\orgn,V,E)$
be the associated hypermap.  Write $D = D_1\cup D_2$ as a union of
non-isolated and isolated darts.

\begin{definition}[X,~Y]\label{def:XY}
Let $(\orgn,V,E)$ be a fan.  Let $X=X(\orgn,V,E)$ be the union of the
cones
   $$C(\orgn,\e)$$
as $\e$ ranges over $E$.  Let $Y=Y(\orgn,V,E)$ be the complement
$Y = \ring{R}^3\setminus X$.
\indy{Index}{X}\indy{Index}{Y}.
\end{definition}

%% WW Move the following remark elsewhere:
%If $e=\{v,v'\}\in E$, then $\orgn,v,v'$ are not collinear
%(Remark~\ref{rem:fan}), so that $C(\orgn,\e)$
%does not lie in a line, and does not contain any
%distinct points $u,u'\in
%C(\orgn,\e)\setminus\{\orgn\}$ 
%with $\op{aff}\{u,u',\orgn\}$ collinear. 
%In particular, $C(\orgn,\e)$ does not contain a line through $\orgn$.

We associate a wedge $\Wdart(x)$, a subset $\Wdart(x,\epsilon)$,
and an azimuth angle $\op{azim}(x)$
with each dart $x\in D$.  If
$x=(\orgn,v,w,w')\in D_1$, set
$\Wdart(x) = W(\orgn,v,w,w')$ and $\op{azim}(x) =
\op{azim}(\orgn,v,w,w')$.   If $x=(\orgn,v)\in D_2$, then we set
$\Wdart(x) = \ring{R}^3\setminus \op{aff}\{\orgn,v\}$ and $\op{azim}(x) = 2\pi$.  For any $x = (\orgn,v,\ldots)\in D$, set
    $$
    \Wdart(x,\epsilon) = \Wdart(x) \cap \op{rcone}^0(\orgn,v,\cos\epsilon).
    $$

\begin{note}%XX
All the hypermaps in this book are connected. $D_2$ is not needed.
\end{note}


\begin{lemma}\guid{VBTIKLP}\tlabel{lemma:disjoint}\rating{120}
Let $(D,e,n,f)$ be the hypermap attached to a 
fan $(\orgn,V,E)$.
Let $N$ be a node of $D$.  There exists $v\in V$
such that the darts of $N$ are precisely
the darts of the form $(\orgn,v,\ldots)$.  Furthermore, there is a 
disjoint sum decomposition of $\ring{R}^3$ given by
  $$
  \ring{R}^3 = 
  \op{aff}\{\orgn,v\} \cup
  \bigcup_{x\in N} \Wdart(x)  \cup 
  \bigcup_{\{v,w\}\in E} \op{aff}_+^0(\{\orgn,v\},w).
  $$
\end{lemma}

If $x\in D$, write $v_x\in V$ for the corresponding vertex.  By the lemma,
we may identify $V$ with the set of nodes of $D$.

\begin{proof}
We prove the existence of the disjoint sum decomposition.
First of all, $\ring{R}^3$ is the disjoint union of $\op{aff}\{\orgn,v\}$
and its complement.
Fix $u$ such that $\{v,u\}\in E$, and let $\sigma$ be the azimuth
cycle on $E(v)$.  Every $y\in\ring{R}^3\setminus\op{aff}\{\orgn,v\}$ satisfies
$$
\op{azim}(\orgn,v,u,\sigma^i u)<
\op{azim}(\orgn,v,u,y) < \op{azim}(\orgn,v,u,\sigma^{i+1} u).
$$
or 
$$
\op{azim}(\orgn,v,u,\sigma^i u) = \op{azim}(\orgn,v,u,y)
$$
for a unique $0 \le i < n$, where $n$ is the cardinality of $E(v)$.
These conditions are exactly the membership conditions for the sets
$
\Wdart(\orgn,v,\sigma^i u,\sigma^{i+1}u)
$
and $\op{aff}_+^0(\{\orgn,v\},\sigma^iu)$, respectively.
The result follows.
\end{proof}

\begin{corollary}\guid{IBZWFFH}\tlabel{cor:W}\rating{40}
Let $x = (\orgn,v,\ldots)$ be a node.
We have $\Wdart(x)\cap C(\orgn,\{v,w\})=\emptyset$, for $w\in E(v)$.
\end{corollary}

\begin{proof} The decomposition of Lemma~\ref{lemma:disjoint} is
disjoint.  It follows directly from the definitions that
   $$C(\orgn,\e)\subset \op{aff}_+^0(\{\orgn,v\},w) \cup 
    \op{aff}\{\orgn,v\}.$$
\end{proof}

\begin{lemma}\guid{JGIYDLE}\rating{120} 
For each $x$, and $\epsilon$ sufficiently small and positive,
$\Wdart(x,\epsilon)$ is nonempty and lies in a single 
topological component of $Y(\orgn,V,E)$.
\end{lemma}

\begin{proof}  First we show that $\Wdart(x,\epsilon)$ lies in $Y$,
for $\epsilon$ small.  Let $x=(\orgn,v,w,w')\in D_1$.  
Let $S^2(\orgn)$ be the unit sphere centered at $\orgn$.
By making $\epsilon$ small enough,
the sets $\Wdart(x,\epsilon)\cap S^2(\orgn)$
avoid the compact sets $C(\orgn,\e)\cap S^2(\orgn)$ when $v\not\in e$.
Thus, $\Wdart(x,\epsilon)$ also avoids $C(\orgn,e)$ when $v\not\in e$.
By Corollary~\ref{cor:W}, $\Wdart(x,\epsilon)$ avoids $C(\orgn,\e)$, when $v\in \e$.
Thus, $\Wdart(x,\epsilon)\subset Y$, for $\epsilon$ small.

To complete the proof, it is enough to show that each $\Wdart(x,\epsilon)$ is
connected.  
The  set
   $$
   R=\{(r,\theta,\epsilon') \in (0,\infty) \times (\theta_1,\theta_2) \times (0,\epsilon)\}
   $$
is connected.
The set $\Wdart(x,\epsilon)$  is the image of $R$
under a spherical coordinate representation (Definition~\ref{def:sph}).
It is readily verified that the polar coordinate representation is
a continuous map. As the image of a connected set under a continuous map
is connected, $\Wdart(x,\epsilon)$ is connected.
\end{proof}

\begin{definition}[leads~into] For each dart $x$, 
there is then a well-defined connected
component $U_x$ of $Y(\orgn,V,E)$ 
that contains $\Wdart(x,\epsilon)$ (for all
sufficiently small $\epsilon$). Say the dart {\it leads into}
$U_x$.
\end{definition}


\section{Planarity}


\subsection{face attributes}


\begin{lemma}\guid{DHVFGBC}[sweep]\rating{400}\label{lemma:sweep}  
Let $(\orgn,V,E)$ be a fan, with hypermap $(D,e,n,f)$.  
Suppose that $\op{azim}(x)<\pi$
for all darts $x\in D$.  Fix a dart $x\in D$.
Let $v = v_x$, $v_0 = v_{f x}$,
and $v_1 = v_{f^2 x}$.  Let $v_t = (1-t) v_0 + t v_1$, for
$0\le t\le 1$.  Let $C_t^0 = \op{aff}_+^0(\orgn,\{v,v_t\})$.
Let $Y = Y(\orgn,V,E)$ and $X = X(\orgn,V,E)$.
Then
\begin{itemize}
\item The set $\{\orgn,v,v_t\}$ is not collinear for any $t\in[0,1]$.
\item For $0< t < 1$, we have $C_t^0\subset Y$.
\item If $\{v,v_1\}\in E$ (that is, if the face of $x$ is a triangle), 
then $C_1^0$ is the blade $C^0(\orgn,\{v,v_1\})$ of the fan.
\item If $\{v,v_1\}\not\in E$, then $C_1^0\subset Y$.
\end{itemize}
\end{lemma}

\begin{proof}
It follows from the definition of a fan that $\{v,v_0\}\in E$ and
that $\{\orgn,v,v_0\}$ is not collinear.  By continuity, $\{\orgn,v,v_t\}$
is not collinear for $t>0$ sufficiently small.  If it exists, set $t'$ as
the smallest $t>0$ for which $\{\orgn,v,v_t\}$ are not collinear.  If it exists,
let $I=\{t\mid 0\le t < t'\}$, otherwise let $I=[0,1]$.  For
each $t\in I$, the blade $C_t^0$ is not a collinear set and is contained in a unique plane $P(t)$ through $\orgn$ and $v$.

By considering possible intersections with vertices $w\in V$ and blades
$C^0(\orgn,\e)\subset X$, we find that for $t>0$ sufficiently small,
$C^0_t$ does not meet $X$, hence $C^0_t\subset Y$.  Assuming 
that it exists, set $t''$
as the smallest $t\in I$ for which $C^0_t$ meets $X$.   Let $C'' = C_{t''}^0$.
$C''$ cannot be $X$ at a vertex $w\in V$, because each azimuth angle
is $<\pi$ at $w$, which means that for any $t$ for which  $C^0_t$ meets $w$ 
there is a smaller $t'''<t$ for which $C^0(t''')$ meets a blade into $w$.
Thus, $C''$ first meets $X$ along a blade $C^0(\orgn,\{w_1,w_2\})$. If
the intersection is transversal, again we can find a smaller $t'''$ that
gives an intersection with the blade.  Hence, we may assume that
$C''$ and $C^0(\orgn,\{w_1,w_2\})$ are coplanar.  From the disjointness
properties of blades of a fan, it follows that $\{w_1,w_2\} = \{v,v_1\}\in E$,
$t''=1$,
and that $C_1^0=C^0(\orgn,\{v,v_1\})$ is a blade of the fan.

Now assume for a contradiction that $t'$ exists.  Pick $0<t''<t'$.  Then
$\{\orgn,v(t''),v(t'),v\}$ lie in a unique plane $P$.  Since all $v(t)$
are collinear,  $v(t)\in P$ all $t\in I$.  In particular $v_0\in C^0(t'')\cap X$,
contradicting the disjointness of $X$ from $C^0(t'')$ established in
the previous paragraph.  Thus, $t'$ does not exist.  This proves the first
claim.  The other claims follow from the previous paragraph.
\end{proof}

\begin{lemma}\guid{RWXUYZZ}\rating{100} 
Let $(\orgn,V,E)$ be a fan with hypermap $(D,e,n,f)$. Let $Y=Y(\orgn,V,E)$. Assume that $\op{azim}(x)<\pi$ for all darts. Then for every face $F$ of the hypermap, there exists a topological component $U$ of $Y$ such that for every $x\in F$, the dart $x$ leads into $U$. 
\end{lemma}

Write $U_F$ for the topological component of $Y$ that the darts of $F$ lead into.


\begin{proof}  Fix any dart $x\in F$ and construct the set $C^0_t$ as
in the previous lemma.  By the previous lemma, the set $C^0_t$ lies in a single
component $U$ for all $t>0$ sufficiently small.  For all $\epsilon>0$
sufficiently small, there exists $\delta>0$ such that set $C^0_t$ meets
both $W(x,\epsilon)$ and $W(f x,\epsilon)$ for all $t<\delta$.  Thus,
$x$ and $f x$ lead into the same component $U$.  By induction, for all
$y\in F$, we have that $y$ leads into $U$.
\end{proof}

\begin{lemma}\guid{JUTSTKG}\rating{120}
Let $(\orgn,V,E)$ be a fan with hypermap $(D,e,n,f)$. Let $Y=Y(\orgn,V,E)$. Assume that $\op{azim}(x)<\pi$ for all darts.  For every topological component $U$ of $Y$, there is a dart $x\in D$ that leads into $U$.
\end{lemma}

\begin{proof}  
To show the dependence of the sets $C^0_t$ on the initial dart $x$, write $C^0_t(x)$.

Let $p\in U$.  Choose a path $\gamma:[0,1]\to \ring{R}^3$
such that $\gamma(t)\in U$ for $t<1$ and $\gamma(t)\not\in U$.  Then
$q=\gamma(1)\in X$.  If $q\in\op{aff}^0_+(\orgn,v)$ for some $v\in V$,
then there exists a dart $x$ with node $v = v_x$ such that for 
all $0\le t < 1$ and all sufficiently
small $\epsilon>0$, we have $\gamma(t)\in W(x,\epsilon)$.  Thus,
$x$ leads into $U$.

The other possibility is that
$q\in C^0(\orgn,\{v,w\})$ for some $\{v,w\}\in E$.  There is a unique
edge $\{x,y\}$ of the hypermap such that $v=v_x$ and $w=v_y$.  
There
is a small neighborhood of $q$ such that every point $q'$ in that neighborhood
takes one of the following forms:
\begin{itemize} \item $q'\in C^0(\orgn,\{v,w\})$.
\item $q'\in C^0_s(x)$ for some $0<s<1$.
\item $q'\in C^0_s(y)$ for some $0<s<1$.
\end{itemize}
Points of the first form do not meet $Y$.  Thus for some $t<1$ and $s<1$
we have $\gamma(t)\in C^0_s(x)$ or $\gamma(t)\in C^0_s(y)$.  Thus,
$x$ or $y$ leads into $U$.
\end{proof}

\begin{lemma}\guid{KVQWYDL}[triangle attributes]\rating{200} \label{lemma:triangle}
Let $(\orgn,V,E)$ be a fan with hypermap $(D,e,n,f)$. 
Let $Y=Y(\orgn,V,E)$.
Assume that $\op{azim}(x)<\pi$
for all darts.  Fix a face $F$ of cardinality three, fix
$x\in F$, and set $x_i = f^i x$. Then
\begin{itemize}  
\item $U_F$ is equal to the intersection of the three half-spaces
$$H^0(i)=\op{aff}_-^0(\{\orgn,v(x_{i+1}),v(x_{i+2})\},v(x_i)),\quad i=0,1,2$$
\item if a dart $y$ leads into $U_F$, then $y\in F$.
\end{itemize}
\end{lemma}

\begin{proof} The intersection of two half-spaces, $H^0(1)\cap H^0(2)$ is
the wedge $W(x)$.   The sets $C^0_t\subset W(x)$ sweep out precisely
the intersection of $W(x)$ with $H^0(0)$.  The sets $C^0_t$ belong to
$U_F$.  Hence the intersection $U'$ of the three half-spaces is a subset of $U_F$.

Suppose for a contradiction 
that $p$ is a point of $U_F$ that does not belong to $U'$.  Choose a path $\gamma:[0,1]\to U_F$ with $\gamma(0)\in U'$ and $\gamma(1)=p$.  Let $t>0$ be the first time such that $\gamma(t)\not\in U'$.  Then $q=\gamma(t)$ lies
in the set $X'$ consisting of the closed intersection of half-spaces $H(i)$
corresponding to $H^0(i)$ and lies
in one of the bounding planes.  However, $X'$ is the union of the three
blades $C(i)=C(\orgn,\{v(x_i),v(x_{i+1})\})\subset X$.  Thus,
$q\in X\cap Y = \emptyset$, which is impossible.  Thus, $U'=U_F$.

Let $y$ be any dart that leads into $U_F$ at vertex $v(y)$.  Then
$W(y,\epsilon)$ meets $U_F$ for all $\epsilon>0$ sufficiently small.
This implies that $v(y)$ lies in the intersection of the closed half-spaces $H(i)$.  As we have seen, this intersection is the disjoint union of $U_F$ and
$X'$.  As $v(y)\in X$, which does not meet $U_F$, we have $v(y)\in X'$.
The set $X'$ is the disjoint union of the rays $\op{aff}_+(\orgn,v(x_i))$ and
the three blades $C^0(i)$.  These blades do not meet the vertices, hence
$v(y)=v(x_i)$ for some $i$.  Thus, $y$ and $x_i$ belong to the same
node.  The sets $W(y)$ and $W( x_i)$ are disjoint for distinct darts at the same
node, and this implies that $y=x_i\in F$.
\end{proof}

\begin{corollary}\guid{MOZNWEH}\rating{60}\label{lemma:girard-component}
$U_F$ is measurable and eventually radial at $\orgn$.
The solid angle of $U_F$ is given by the formula
$$
\sol(U_F) = -\pi + \sum_{x\in F}\op{azim}(x),
$$
\end{corollary}

\begin{proof} An intersection of half-spaces is measurable and
eventually radial.  The solid angle is given by Girard's formula for
a spherical triangle.
\end{proof}

\begin{lemma}\guid{PIIJBJK}[face attributes]\rating{1000}\label{lemma:face}
Let $(\orgn,V,E)$ be a fan with hypermap $(D,e,n,f)$. 
Let $Y=Y(\orgn,V,E)$.
Assume that $\op{azim}(x)<\pi$
for all darts $x\in D$.  Then
\begin{itemize}
\item The map $F\mapsto U_F$ is a bijection between faces of the hypermap
and topological comonents of $Y$.
\item  Each topological component $U_F$ is the intersection of the open
half-spaces $\op{aff}_+^0(\{\orgn,v_x,v_{f x}\},v_{f^2 x})$, as $x$ runs
over $F$.
\item For every $F$, the topological component $U_F$ is measurable and
eventually radial at $\orgn$.  The solid angle of $U_F$ is given by the
formula
$$
\sol(U_F) = 2\pi + \sum_{x\in F}(\op{azim}(x)-\pi).
$$
\item If $x,y\in F$, with corresponding vertices $v_x,v_y\in V$, then
$\{\orgn,v_x,v_y\}$ are not collinear.
Furthermore, 
either $x,y$ are adjacent under the face map, or $C^0(\orgn,\{v_x,v_y\})\subset U_F$.  {\it That is, the diagonals of the polygon $U_F$ are all interior.}
\item  Triangulations of $U_F$ exist.
\end{itemize}
\end{lemma}

Before moving to the proof, we give some corollaries.

\begin{corollary}\guid{GINGUAP}\rating{40}
Each topological component $U_F$ is convex.
\end{corollary}

\begin{proof} It is the intersection of half-spaces.
\end{proof}

\begin{corollary}\guid{SRPRNPL}\rating{60}  
The hypermap is simple.
\end{corollary}

\begin{proof}  Let $x\in F$.  By the intersection of half-spaces property, $U_F$ is contained in the wedge $W(x)$ at $x$.  If there is a second dart $y$ at the same node in $F$, then $U_F$ is also contained in $W(y)$. However, by Lemma~\ref{lemma:disjoint}, the wedges at a given node are disjoint.
\end{proof}

\begin{corollary}\guid{WGVWSKE}\rating{150}  
The hypermap is connected.
\end{corollary}

\begin{proof} Assume that $x,y$ be any two darts.  By replacing $x$ with $f x$ if necessary, which lies in the same combinatorial component as $x$, we may
assume that $\{\orgn,v_x,v_y\}$ is not a collinear set. 
For each blade $C^0(\orgn,\e)$ of the fan that meets $C=C^0(\orgn,\{v_x,v_y\})$
pick one of the two endpoints of $\e$.  Then we get a sequence
$$
v_x=v_0,v_1,\ldots,v_k=v_y
$$
such that $C^0(\orgn,\{v_i,v_{i+1}\})$ lies in a single topological component $U_i$.  Each $U_i$ has the form $U_{F_i}$ for some face $F_i$ of the hypermap.
Thus, we may construct a combinatorial path from $x$ to $y$, by moving by the face map from dart to dart within each $F_i$ and by the node map from dart to dart around a given node $v_j$.
\end{proof}

\begin{corollary}\guid{GGRLKHP}\rating{100}  
The hypermap is planar.
\end{corollary}

\begin{proof}  The solid angle of a sphere is $4\pi$.  The set $X$
has measure zero, so that
$$
4\pi = \sol(Y)= \sum_F \sol(U_F) = 
\sum_F ( 2\pi + \sum_{x\in F} (\op{azim}(x)-\pi) ).
$$
The double sum over faces and darts in a face can be replaced by
a single sum over darts.  
The sum of the azimuth angles of all darts at a node is $2\pi$. Thus,
all the azimuth angle terms give $2\pi\#n$.
Thus, the formula becomes
$$
4\pi = 2\pi \#f +2\pi\#n - \pi \#D.
$$
In a plain hypermap in which the edge map has no fixed points, $\#D = 2\#e$.
The relation becomes
$$
2 + \#D = \#f + \#e + \#n.
$$
This is the condition of planarity for a connected hypermap.
\end{proof}

\subsection{proof of face attributes}

Now we turn to the proof of the face-attribute lemma.

\begin{proof}
Let $N(E)$ be the natural number
$$
\sum_F (n_F - 3),
$$
where the sum runs over faces of the hypermap, and $n_F$ is the
cardinality of the face $F$.
%We prove the conclusion of the lemma, together with the additional
%conclusion:
%\begin{itemize}
%\item If $C^0(\orgn,\e)$ is any diagonal of $U_F$ (with $\e\not\in E$), then the %fan $(\orgn,V,E'')$, where $E'' = E\cup\{\e\}$, satisfies
%$N(E'')+1 = N(E)$.
%\end{itemize}
Assume for a contradiction that there exists a fan $(\orgn,V,E)$ 
satisfying the assumptions of the lemma, but not the conclusion.
Among all such counterexamples with fixed $(\orgn,V)$, we may pick
$E$ to minimize  $N(E)$.

If $N(E)=0$, then the hypermap is a triangulation.  We consider this
case first.  By earlier lemmas, every topological component of $Y$ has
the form $U_F$ for some face $F$.  By Lemma~\ref{lemma:triangle}, the indexing
face $F$ is uniquely determined.  Thus, there is a bijection between
faces of the hypermap and topological components.  By Lemma~\ref{lemma:triangle}, the topological component $U_F$ is the intersection of open half-spaces as asserted.  The solid angle formula is given by Corollary~\ref{lemma:girard-component}.  The facts about diagonals and triangulations are trivial for a hypermap
that is already a triangulation. This completes the proof in the base
case $N(E)=0$.


Now consider the case $N(E)>0$.  There exists a face $F$ of the hypermap
that is not a triangle.  By Lemma~\ref{lemma:sweep}, there is a diagonal in $U_F$.
We form a new fan $(\orgn,V,E')$ on the same vertex set with
$E' = E\cup \{\{v,w\}\}$.   

We claim $n(E')<n(E)$.
There is a uniquely determined edge $\{x,z\}$ of
$\op{hyp}(\orgn,V,E')$ such that $v=v_x$ and $w=v_z$. The hypermap $\op{hyp}(\orgn,V,E)$ is obtained
from $\op{hyp}(\orgn,V,E')$ by a double walkup transformation on the
edge $\{x,z\}$.  The darts belong to different faces $F_x$ and $F_z$
(by Lemma~\ref{lemma:triangle}), one of which (say $F_x$ is a triangle.  Thus, the
walkup transformation merges two faces.  Let $n$ be the cardinality of $F_z$.
Then 
$$n(E) - n(E') = ((n+1)-3) - (n-3) - (3-3) = 1 >0.$$

By the presumed minimality of $E$, the conclusion of the lemma holds for the
fan $(\orgn,V,E')$.  Add primes
for quantities associated to the fan $(\orgn,V,E)$.  The two faces
$F_x$ and $F_z$ merge into a single face $F$ of $\op{hyp}(\orgn,V,E)$.
Then 
\begin{equation}\label{eqn:U}
U= U_{F_x}\cup U_{F_z}\cup C^0(\orgn,\e)
\end{equation} 
is a connected open set in $Y$.
If $F'\ne F_x,F_z$ is any other face in $\op{hyp}'$ then $U_{F'}$ is
a connected open set in $Y$.  Moreover, the set $U$ and sets $U_{F'}$
are disjoint and exhaust $Y$, so that the are precisely the topological
components of $Y$.  Some dart of $F$ leads into $U$, so $U=U_F$.  It follows
that the number of faces is equal to the number of topological components, so that the surjective map from faces to topological components is a bijection.

Next we establish the area formula.  Every topological component of $Y$ 
except $U$ is already a topological component of $Y'$ and the conclusion
holds for components of $Y'$.  The component $U$ is a disjoint union of two
components of $Y'$ and a set $C^0(\orgn,\e)$ of measure zero.  Thus, it
is also measurable and eventually radial.  The solid angle formula is
additive over the disjoint union, so the formula holds for $U$.

Next we show the existence of interior diagonals from the dart $x$ (which was arbitrary).  By the minimality of $E$, it is enough to consider the merged face $F$.  
If $y=f^2x$, then the diagonal is precisely $C^0(\orgn,\{v,w\})$,
which has already been established.  Otherwise, $y$ can be identified with
a dart of the face $F_z$ in the hypermap $\op{hyp}'$.  The conclusion holds
already for $U_{F_z}\subset U$.  

%Next we show the extra conclusion added at the beginning of the lemma.
%If the added diagonal is $\{v,w\}$, then $E''=E'$ and we have already
%checked that $N(E')+1=N(E)$.  Since $x$ was arbitrary, we may assume
%that $v_x\in e$.  Let $E''' = E \cup \{e\, \{v,w\}\}$.  By the minimality,
%$N(E''') + 1 = N(E')$.  Also, $E''' = E''\cup \{\{v,w\}\}$.  The
%same argument that shows $N(E')+1=N(E)$ shows $N(E''')+1 = N(E'')$.
%Hence,
%$$
%N(E'')+1 = N(E''')+2 = N(E')+1 = N(E).
%$$

Next, we establish that the given intersection of open half-spaces is equal
to the topological component. By the minimality of $E$, it is enough to consider
the merged face $F$ and its topological component $U=U_F$.
We first show that the intersection $U'$ of half-spaces lies in $U$.
Every $p$ in this intersection lies in the plane
$$
\op{aff}(\{\orgn,v,w\})
$$
or in one of the two open half-planes bounded by this plane.  The intersection
of this plane with $U'$ is the blade $C^0(\orgn,\{v,w\})$, which belongs
to $U$. The intersection of the two half-spaces, by the minimality of $E$,
belong to $U_{F_x}$ and $U_{F_y}$, which are subsets of $U$.  Thus, $U'\subset U$.

To prove the reverse inclusion, let $y$ and $f y$ be darts of
the face $F$.  we show that $U$ is a subset of the half-space with bounding
plane $\{\orgn,v(y),v(f y)\}$.  We may assume that the edge $\{x,z\}$ of the
hypermap $\op{hyp}'$ satisfies $v_x = v_y$, as $x$ can be chosen at an
arbitrary node.  By the minimality of $E$,  
the partition (\ref{eqn:U}) of $U$ gives three pieces
contained respectively in the three parts:
$$
W(x) \cup C^0(\orgn,\{v,w\}) \cup W(x'),
$$
where $x,x'\in D'$ correspond to the single dart $y\in D$:
$$
\op{azim}(x) + \op{azim}(x') = \op{azim}(y) < \pi.
$$
Thus, $U$ itself is contained in the lune
$$
\op{wedge}(\{\orgn,v(y)\},\{v(f y),v(f^{-1} y)\}),
$$
which is contained in the desired half-space.
\end{proof}

\section{polygon}


\subsection{perimeter}


\begin{lemma}\guid{WSEWPCH}\tlabel{lemma:convex-hyper}\rating{400}
Let $(\orgn,V,E)$ be a fan.  
Let $U=U_F$ be a topological component of $Y(\orgn,V,E)$, associated
with face $F$.
Assume
that every dart of $F$ has $\op{azim}(x)<\pi$. 
Then the unit-sphere perimeter of the face is at most $2\pi$.
\end{lemma}

\begin{proof}  A fan does not have any faces of cardinality less than three.
Every blade of the fan has radian measure less than $\pi$.  

Consider the case of a spherical triangle.  If the edges of the
the triangle are $a_i$ and the angles of the polar
triangle are $\alpha'_i$, then $\alpha'_i+a_i=\pi$.
The the perimeter is 
$$a_1+a_2+a_3 = 2\pi - (\alpha'_1 -\alpha'_2 - \alpha'_3-\pi) < 2\pi,$$
because the area of the polar triangle is always strictly positive.

Similarly, if the sides of the faces of the spherical polygon are
$a_i$, then the angles of the polar polygon are $\alpha'_i = \pi-a_i$.
The perimeter is
$$
a_1+\cdots+a_n  = 2pi- A< 2\pi,
$$
where $A = 2\pi-\sum a_i$ is the area of the polar polygon.
%~\cite[p.261]{williamson:2008}.
\end{proof}

\begin{note}%XX
Futher details about polar polygons are to be added, including a definition and a justification of the area formula for the polar.
\end{note}


\subsection{area}

\begin{note}%XX
This subsection will be expanded with a lemma on the properties of  deformations of polygons needed for estimates of $\tau$.
\end{note}


\section{Polyhedron}

This section shows that a convex polyhedron determines a fan.

\begin{definition}
A polyhedron the intersection of finitely many closed half-spaces.
An interior point $p$ of a polyhedron is a point that contains a neighborhood
entirely contained in the polyhedron. An isolating half-space of
a polyhedron is a closed half-space containing the polyhedron.  A face of a polyhedron
is the intersection of the polyhedron with the bounding plane of an isolating-half space.   The dimension of a face is defined as the dimension of the affine hull of the face.  A vertex is a face of dimension $0$.  An edge is a face of dimension $1$.
\end{definition}

\begin{lemma}\guid{JLIGZGS}\rating{800}\label{lemma:polyhedron}  
Let $P$ be a polyhedron with an interior point $\orgn$.
Let $V$ be the set of vertices of $P$.  Let $E$ be the set of pairs $\{v,w\}$
of vertices such that $\op{conv}\{v,w\}$ is an edge of $P$.
\begin{itemize}
\item $(\orgn,V,E)$ is a fan.
\item Every dart $x$ of the associated hypermap satisfies $\op{azim}(x)<\pi$.
\end{itemize}
\end{lemma}


\begin{note}%XX
We also need the fact that the circular disks of Lemma~\ref{lemma:13-14} lie in different topological components $Y(\orgn,V,E)$.  More precisely, no disk meets $X$; and no two disks lie in the same topological component.
\end{note}


