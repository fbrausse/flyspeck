\chapter{Hypermap}\label{chap:hypermap}
\indy{Index}{hypermap}%

\begin{summary}
  A \fullterm{planar graph}{planar!graph}, which is a graph that admits a planar
  embedding, has too little structure for our purposes because it
  does not specify a particular embedding.  A \fullterm{plane graph}{plane!graph}
  carries a fixed embedding, which gives it a topological structure
  where combinatorics alone should suffice.  A hypermap gives just the
  right amount of structure.  It is a purely combinatorial object, but
  carries information that the planar graph lacks by encoding the
  relations among nodes, edges, and faces.  This chapter is about
  hypermaps.

  In the original proof of the Kepler conjecture, the basic
  combinatorial structure was that of a \fullterm{planar map}{planar!map}, as
  defined by Tutte~\cite{Tutte:1984}.  Although
  planar maps appear throughout that proof, they are lightweight
  objects, in the sense that no significant structural results are
  needed about them.

Gonthier makes hypermaps the fundamental combinatorial structure in
his formal proof of the four-color theorem~\cite{gonthier:2008:formal}.  His formal
proof eliminates topological arguments such as the Jordan curve theorem 
in favor of
purely combinatorial arguments.    When I learned of Gonthier's work,
I significantly reorganized the proof by replacing planar maps with
hypermaps, making them heavyweight objects, in the
sense that significant structural results about them are needed.

As a result of these changes, many parts of the proof that were
originally done topologically can now be done combinatorially, a change that
significantly reduces the effort required to formalize the proof.
These changes also make it possible to treat rigorously what was
earlier done by geometric intuition.  For example, the original proof
made implicit use of the equivalence of two different notions of a
planar map: a combinatorial notion that was used in the computer
algorithms and a topological notion of an equivalence class of
embeddings of a graph into a sphere.  Hypermaps make this equivalence
explicit and rigorous.

Put simply a hypermap  is a finite set together
with two permutations on that set.  It is therefore useful to start
the chapter with a brief review of permutations.  The second section
develops the basic terminology of hypermaps.  The next section
describes various transformations of hypermaps called walkup
transformations.  These transformations can be viewed as corresponding
to  operations such as contracting an edge in a graph or deleting
a node of a graph.  Next, properties of planar hypermaps are
developed.  The final sections prove the correctness of an algorithm
to generate all planar hypermaps with given properties.  The algorithm
can be described heuristically in terms of drawing graphs in pencil
and pen on a sheet of paper.  This algorithm has been implemented as a
computer program.  The output from this program is an essential part
of the proof of the Kepler conjecture.
\end{summary}


\section{Background on Permutations}

This section reviews the theory of permutations, as presented in
standard textbooks.

\begin{definition}[permutation]\guid{IFPQAWD}
\formaldef{permutation}{permutes}
\formaldef{$I_D$}{I}
\formaldef{$f^{-1}$}{inverse}
\formaldef{$f^k$}{POWER}
A \newterm{permutation} $f$ on a set
  $D$ is a bijection $f:D\to D$.
\end{definition}
\indy{Notation}{I@$I$ (identity map)}

For example, the identity map $I_D$ on a set $D$  is a permutation:
\[ 
I_D(x)=x \text{ for all } x \in D.
\] 
If $f:D\to D$ is a permutation, then  its inverse function $f^{-1}:D\to D$
is also a permutation.  
It satisfies
\[ 
f f^{-1} = f^{-1} f = I_D.
\] 
(This chapter uses product notation $f g$ for the composition $f\circ g$ of maps.)
If $D$ is a finite set, and two maps
$f,g:D\to D$ satisfy $f g = I_D$ on $D$, then $f$ and $g$ are permutations and are
inverses of one another:
\[ 
f g = g f = I_D.
\] 

Natural number powers  $f^k$ of a permutation $f:D\to D$ are defined
recursively by
\[ 
f^0 = I_D,\textand  f^{k+1} = f f^k.
\] 
Integer powers $f^m$ of a permutation are defined as
\[f^m = f^i (f^{-1})^j,\] where $m = i -j$.  This is well-defined.
The usual rule of exponents holds:
\[ 
f^{m+n} = f^m f^n.
\] 

If $f:D\to D$ is a permutation on a finite set $D$, then there is a
smallest positive integer $k$ such that $f^k=I_D$.  The integer $k$ is
the \newterm{order} of the permutation $f$.  If $f^m=I_D$ for some
$m$, then $m = k i$ for some integer $i$, where $k$ is the order of
$f$. The inverse $f^{-1} = f^k f^{-1} = f^{k-1}$ can be written as a
nonnegative power of $f$.

% Corrected Jan 22, 2012.
A permutation $f$ of a finite set $D$ is \fullterm{cyclic}{cyclic!permutation} 
if for every $x,y\in D$, there exists an integer $i$ such that
$f^i x = y$.

The set of all permutations of the set $\{0,1,2,\ldots,k-1\}$ is written $\op{Sym}(k)$.
The set $\op{Sym}(k)$ is finite and has cardinality $k!$.



\section{Definitions}

A hypermap, presented in the next definition, is the main subject of this chapter.

\begin{definition}[hypermap,~dart]\guid{ZIHYYRA}\label{def:hypermap}  
\formaldef{hypermap}{(:(A)hypermap)}
\formaldef{dart}{dart}
\formaldef{$e$}{edge\_map}
\formaldef{$f$}{face\_map}
\formaldef{$n$}{node\_map}
\formaldef{set of faces}{face\_set}
\formaldef{set of edges}{edge\_set}
\formaldef{set of nodes}{node\_set}
  A \newterm{hypermap} is a finite set $D$, together with three functions
  $e,n,f:D\to D$ that compose to the identity
  \[ 
e\ocirc n\ocirc f = I_D.
\]  The
elements of $D$ are called \fullterm{darts}{dart}.  The functions $e,n$ and
$f$ are called the \fullterm{edge map}{edge!map}, the \fullterm{node map}{node!map}, and
the \fullterm{face map}{face!map}, respectively. 
\indy{Notation}{ey@$e$ (edge map)}%
\indy{Notation}{nodemap@$n$ (node map)}%
\indy{Notation}{facemap@$f$ (face map)}%
\indy{Notation}{D@$D$ (dart set)}%
\end{definition}


\begin{remark}[plane graphs as hypermaps]\guid{IVPJYAG}\label{rem:hypermap} 
  A hypermap is an abstraction of the concept of plane graph.  Place a
  dart at each angle of a plane graph (Figure~\ref{fig:hypermap_ex}).
  One function, $f$, cycles counterclockwise around the angles of each
  face.  Another function, $n$, rotates counterclockwise around the
  angles at each node.  A third function, $e$, pairs angles at
  opposite ends of each edge.  The hypermap extracts the data
  $(D,e,n,f)$ from the plane graph and discards the rest.

  This construction of hypermaps from plane graphs is our primary
  reason to study hypermaps.  Many of the lemmas and proofs in this
  chapter are standard results about plane graphs, translated
  into the language of hypermaps.  
%
\indy{Index}{plane!graph}%
\end{remark}


\figZGPXAWJ % {fig:hypermap_ex}

It follows from the background on permutations that $e,n,f$ are all permutations on $D$.
A hypermap satisfies 
\begin{equation}\label{eqn:triality}
e \ocirc n\ocirc f = n\ocirc f\ocirc e = f\ocirc e\ocirc n = I_D.
\end{equation}
This \newterm{triality relation} shows that if $(e,n,f)$ give a
hypermap, then so do $(n,f,e)$ and $(f,e,n)$.  Because of these
symmetries in the defining relation, there are multiple versions of
theorems about hypermaps, all obtained from one proof by symmetry.
Alternatively, it is possible to define a hypermap as a finite set
with two permutations $e,n$, leaving $f$ to be derived from $e n f =
I_D$; however, the triality symmetry would be lost in such a
definition.

Inverted, this triality becomes
\[ 
n^{-1} \ocirc e^{-1} \ocirc f^{-1} = (f \ocirc e \ocirc n)^{-1} = I_D.
\] 
This inversion is the abstract form of the duality between nodes
and faces in a plane graph. 


\begin{definition}[path,~list,~sublist,~dart~set,~visit]\guid{RRQWGAY} 
  \formaldef{path}{is\_path} Let $D$ be a set of darts and let $S$ be
  a set of permutations of $D$.  A \newterm{path} with \newterm{steps}
  in $S$ from $x_0$ to $x_{k-1}$ is a \newterm{list}\footnote{The
    empty path $[]$ seems to have an ancient origin: ``This is the
    path made known to me when I had learned to remove all darts.''
    --The Dhammapada} of darts $[x_0;x_1;\ldots;x_{k-1}]$ such that
  for each $i$, $x_{i+1} = h_i x_i$ for some $h_i \in S$.  A
  \newterm{sublist} of a list is a consecutive subsequence
  $[x_i;x_{i+1};\ldots;x_j]$, with $0\le i\le j\le k-1$.  A
  \newterm{unit list} is a list of the form $[x]$.  A path is
  \fullterm{injective}{path!injective} if the condition $x_i=x_j$ implies $i=j$.  The
  \fullterm{dart set}{dart!set} of $L$ is $\{x_0,x_1,\ldots,x_{k-1}\}$.  A path
  \newterm{visits} a dart $x$, if $x$ is an element of the dart set of
  $L$.  A set of paths {\it visits} a dart $x$, if some path in the set
  visits the dart.
\end{definition}
\indy{Notation}{P@$P$ (dart path)}%
\indy{Notation}{L@$L$ (dart path)}%

%\begin{notation}[$\cooln$]
%Write $P[x_i:x_j]$ for $i<j$ for the sublist $[x_{i+1};\ldots;x_j]$ of
%$P=[x_0;\ldots;x_{k-1}]$.  (The notation is ambiguous when the path is
%not injective.)  
%The infix operator $\cooln$ prepends an element $x$ to a list $[x_0;\ldots]$:
%\[ 
%x\cooln[x_0;\ldots] = [x;x_0;\ldots].
%\] 
%The infix operator $\opat$  \newterm{concatenates} 
%lists:
%\[ 
%[a;\ldots;b] \opat [c;\ldots;d]  = [a;\ldots;b;c;\ldots;d].
%\] 
%\end{notation}


\begin{definition}[$\sim_S$]\guid{IENSLJP}
Let $D$ be a set and let $S$ be a 
set of permutations on $D$.
Define a relation on the set of darts by $x\sim_S y$ if and only if  a
path runs from $x$ to $y$ with steps in $S$.
\end{definition}
\indy{Notation}{9a@$\sim$ (equivalence relation)}%

This book intentionally avoids group theory to keep the theoretical
background to a minimum.  The relation could be expressed group
theoretically by saying $x\sim_S y$ means that $x$ and $y$ lie in the
same orbit of the group generated by $S$.  The following simple
lemma provides a substitute for group theory.

\begin{lemma}[equal equivalences]\guid{YBGABWW}\label{lemma:er} %\guid{QLPBIKV}
% wording changed by thales Jan 7, 2010.
Let $(D,e,n,f)$ be a hypermap and let $S$ be a  set of permutations.
Then for each $h_1,h_2\in S$, 
the relation $\sim_S$ is the same as the relation $\sim_T$, where
\[ 
T = S \cup \{h_1h_2\}.
\] 
Moreover, for each $h\in S$, 
the relation $\sim_S$ is the same as the relation $\sim_T$, where
\[ 
T = S \cup \{h^{-1}\}.
\] 
Also,  the relation $\sim_S$ (that is, $\sim_T$) is an equivalence relation.  
\indy{Index}{equivalence relation}%
\end{lemma}

\begin{proof} If $x\sim_S y$, then clearly $x\sim_T y$.  Conversely, if
  $x\sim_T y$, where $T = S\cup\{h_1h_2\}$, select a path $P$ from $x$
  to $y$ with steps in $T$ that contains the fewest $h_1h_2$-steps.

  \claim{$P$ does not contain\footnote{This paragraph continues with the
      book's general convention of typesetting in italic a  claim that is followed
     by its justification.} any $h_1h_2$-steps}.  Otherwise, a
  sublist $[\ldots;u;h_1h_2u;\ldots]$ of $P$ can be expanded to a path
  $[\ldots;u;h_2u;h_1 h_2 u;\ldots]$ that contradicts the minimal property
  of $P$. This claim gives the first conclusion of the lemma.

 Fix $h$ in a set of
permutations $R$.  By an induction that uses the first conclusion, for
all $i$, $\sim_R$ equals the relation $\sim_{R(h,i)}$, where $R(h,i) =
R \cup \{h,h^2,\ldots,h^i\}$.  If $h\in S$ is an element of order $k$,
and $T = S\cup\{h^{-1}\}$, then the second conclusion follows because
the following sets give the same relation:
\[ 
S,\quad S(h,k-1) = T(h,k-2),\quad T.
\] 

By repeated action of the previous conclusion, we obtain $(\sim_S)~=~(\sim_T)$, where
$T = S\cup S^{-1}\cup \{I_D\}$, and where $S^{-1} = \{h^{-1}\mid h\in
S\}$.  The unit path $[x]$ yields reflexivity of $\sim_T$.  Also,
$T^{-1} = T$ gives the symmetry.  Finally, concatenation of paths
gives transitivity.  Thus, $\sim_T$ (i.e., $\sim_S$) is an equivalence
relation.
\end{proof}

Several of the following definitions -- components, connected, node,
edge, face -- have been appropriated from planar graph theory.  These
definitions are intended to capture the intuitive notions of the nodes
and edges of a graph, faces of a plane graph, and connectivity.

\begin{definition}[combinatorial~component,~connected]\guid{JVTRXQR}
\formaldef{combinatorial component}{comb\_component}
\formaldef{$\#c$}{number\_of\_components}
\formaldef{connected}{connected\_hypermap}
A \newterm{combinatorial component} of a hypermap $(D,e,n,f)$ is an 
equivalence class of the relation $\sim_S$, where
$S=\{e,f,n\}$. 
(See Lemma~\ref{lemma:er} for other sets that define the same equivalence classes.)  
Let $\#c$ denote the
number of combinatorial components of $(D,e,n,f)$.  
The hypermap is \newterm{connected} if
$\#c=1$.  \indy{Index}{Dhammapada}%
\indy{Index}{path}%
\indy{Index}{connected}%
\indy{Index}{component!combinatorial}%
\indy{Notation}{3@$\#c$~ (number of components)}%
\end{definition}





\begin{definition}[orbit,~node,~face,~edge]\guid{JIOUCMV}
\formaldef{orbit}{orbit\_map}
\formaldef{edge}{edge}
\formaldef{node}{node}
\formaldef{face}{face}
The \newterm{orbit} of $x\in D$ under a permutation $h$ on
a set $D$ is a set of the form $\{h^i x\mid i\in\ring{N}\}$.  A \newterm{node}
of a hypermap $(D,e,n,f)$ is the orbit of a dart $x\in D$ under $n$.  
A \newterm{face} is an orbit under $f$.  
An \newterm{edge} is an
orbit under $e$.  \indy{Index}{node}%
\indy{Index}{face}%
\indy{Index}{edge}%
\end{definition}

Plane graphs are conventionally illustrated in such a way that nodes,
edges, and faces have an entirely different appearance: nodes as
point, edges as curves, and faces as polygons.  In an abstract
hypermap, the triality symmetry shows that the nodes, edges, and faces
have equal footing.  Nevertheless, to retain the intuition of plane
graphs, this book  often depicts hypermaps with the darts in a node
arranged in a small cluster around a point, the darts in a edge along
a curve, and the darts in a face around a polygon.

Let $\#h$ denote
number of orbits of a permutation $h$ on $D$.  
\indy{Notation}{h@$h$ (permutation)}%
\indy{Notation}{3@$\#h$~(number of orbits)}%
\formaldef{$\#h$}{number\_of\_edges, number\_of\_nodes, number\_of\_faces}


\begin{lemma}[orbit]\guid{PKRQTKP}
Let $D$ be a finite set.  The orbit of $x\in D$ of a permutation $h:D\to D$
is the equivalence class of $x$ under the relation $\sim_S$, when $S=\{h\}$.
\end{lemma}

\begin{definition}[plain]\guid{HFRNMIU}
  \formaldef{plain}{plain\_hypermap} A hypermap $(D,e,n,f)$ is
  \newterm{plain} (carefully note\footnote{This is a deliberate and
    dangerous play on the homophonous \newterm{plane} that makes this
    topic unspeakable.  Although plane graphs are planar, not all
    plain hypermaps are planar.}  the spelling) when $e$ is an
  involution on $D$ (that is, $e^2 = I_D$).  \indy{Index}{plain}%
\end{definition}




\begin{definition}[degenerate]\guid{MKSZLRM}
\formaldef{degenerate}{dart\_degenerate}
\formaldef{nondegenerate}{dart\_nondegenerate, is\_edge\_nondegenerate, etc.}
 A dart in a hypermap $(D,e,n,f)$ 
is \newterm{degenerate} if it is a
fixed point of one of the maps $e,n,f$; otherwise it is \newterm{nondegenerate}.  
%%It is nondegenerate otherwise.
\indy{Index}{dart!degenerate}%
\indy{Index}{dart!nondegenerate}%
\end{definition}

\begin{definition}[simple]\guid{KMHUQNS} 
\formaldef{simple}{simple\_hypermap}
A hypermap is \newterm{simple} if the intersection of each face with
each node contains at most one dart.  \indy{Index}{simple}%
\end{definition}


% Moved from cup05_tame.tex section on tame plane graphs. 9/5/07:
\begin{lemma}[nodal fixed point]\guid{ZHQCZLX}\label{lemma:nondegen} 
\formalauthor{TNT, lemmaZHQCZLX}
  Let $(D,e,n,f)$ be a simple plain hypermap such that every face has
  at least three darts.  Then $n$ has no fixed point.
  \indy{Index}{fixed point}%
\end{lemma}

\begin{proof} For a contradiction, let $x\in D$ be a fixed point of
$n$. 

\claim{The darts $e x$ and $f x$ lie in the same node and face and  are therefore
  equal in the simple hypermap.}  Indeed, they lie in the same node
because $n(f x) = e^{-1} x = e x$ and they lie in the same face because
\[ f^2 (e x) = f (f e n x) = f x.\]  So
$e x = f x$.

Thus, $f^2 (e x) = f x = e x$, and $e x$ lies on a face with at most
two darts.  This contradicts what is given.
\end{proof}




\section{Walkup}

This section describes various operations to transform one hypermap to
another.  The simplest of these operations is the \newterm{walkup}
transformation that deletes one dart from a hypermap and constructs
permutations that skip past the deleted dart.  More complex
transformations of hypermaps can be constructed as a sequence of walkup
transformations and correspond to standard operations on graphs such as the
contraction or deletion of an edge.

To focus attention on a dart $x$ in a hypermap, it can be useful to draw a
hexagon around $x$ and place the six darts $e x$, $f x$, $e^{-1} x$,
$n x$, $f^{-1} x$, $e x$, $n^{-1} x$ at its corners as shown in
Figure~\ref{fig:dart+}.  Some of these seven darts may be equal to one
another, even if the figure draws them apart.
Figure~\ref{fig:dart-fix} shows the layout of a degenerate dart.
\indy{Notation}{x@$x$ (dart)}%

\figLMGQYKG % fig:dart+

\figANDKKER % fig:dart-fix


\subsection{single}

A walkup deletes a dart from a hypermap and reforms the edge, node,
and face maps to produce a hypermap on the reduced set of darts.
Walkups come in three varieties: edge walkups, face walkups, and node
walkups.

\begin{definition}[walkup,~degenerate]\guid{DAIZNHD}
\formaldef{edge walkup}{edge\_walkup}
\formaldef{node walkup}{node\_walkup}
\formaldef{face walkup}{face\_walkup}
The edge \newterm{walkup}
$W_e$ at  a dart $x\in D$ of a hypermap $(D,e,n,f)$ is the hypermap
$(D',e',n',f')$, where $D' = D\setminus\{x\}$ and the maps skip over $x$:
\begin{align*}
f' y &= \text{ if } (f y =  x) \text{ then } f x \text{ else
} f y\\
n' y &= \text{ if } (n y = x) \text{ then } n x \text{ else
} n y\\
e' &= (n'\ocirc f')^{-1}.
\end{align*}
A walkup at $x$ is said to be \newterm{degenerate} if the dart $x$ is
degenerate.  
\indy{Index}{walkup}%
\indy{Index}{edge!walkup}%
\indy{Index}{face!walkup}%
\indy{Index}{node!walkup}%
\indy{Notation}{W4@$W$ (walkup)}%
\end{definition}

Figure~\ref{fig:walk} shows
the result of an edge walkup on the hexagon around a dart $x$.
The triality symmetry~\ref{eqn:triality}, applied to the definition
of edge walkups, yields the definition of
face walkup $W_f$ and node walkup $W_n$.  
% Figure~\ref{fig:walkfn} shows the result of the face and node
% walkups on the hexagon around a dart $x$.

At a degenerate dart $x$, all three walkups are equal: $W=W_e=W_n=W_f$
(Figure~\ref{fig:walkdegen}).  \indy{Index}{walkup!degenerate}%
\indy{Notation}{x@$x$ (dart)}%

\figGFJIBZV  %{fig:walk}

\figLNIZBPW % fig:walkdegen 


\begin{definition}[merge,~split]\guid{KJIOZBJ}\label{def:merge-split} 
\formalnote{Note: ZMFKZNH and def swapped}
  \formaldef{merge}{is\_edge\_merge}
  \formaldef{merge}{is\_node\_merge}
  \formaldef{merge}{is\_face\_merge}
  \formaldef{split}{is\_edge\_split}
  \formaldef{split}{is\_node\_split}
  \formaldef{split}{is\_face\_split} 
Let $(D,e,n,f)$ be a hypermap and
  let $h=n,e$, or $f$.  Let $O(h,x)$ denote the orbit of
  $x\in D$ under $h$.  Let $(D',e',n',f')$ be the hypermap obtained
  from $(D,e,n,f)$ by the walkup $W_h$ at $x\in D$.  Let
  $h'=e',n',f'$, respectively, according to the choice of $h$.  The
  walkup $W_h$ at $x$ \fullterm{merges}{merge} when the walkup joins the orbit
  of $h$ through $x$ with another orbit.  That is, the orbit $O$ of
  some $y\in D'$ under $h':D'\to D'$ has the form
\[ 
  O \cup\{x\} = O(h,x) \cup O(h,y),
\] 
where $y\not\in O(h,x)$.  It \fullterm{splits}{split} when the walkup
splits the orbit at $x$ into two orbits.  That is, there are distinct
orbits $O_1,O_2$ under $h'$ in the hypermap $(D',e',n',f')$ such that
\[ 
  \{x\}\cup O_1\cup O_2 = O(h,x).
\] 
\indy{Index}{orbit}%
\indy{Notation}{O@$O(h,x)$ (orbit of $x$ under $h$)}%
\end{definition}

\begin{lemma}[merge-split]\guid{ZMFKZNH}\label{lemma:merge-split} 
\formalauthor{lemma\_face\_merge, lemma\_edge\_merge, lemma\_node\_merge}
  Let $(D,e,n,f)$ be a hypermap and let $W_h$ be a nondegenerate
  walkup at a dart $x$.  Then $W_h$ merges or splits. Moreover, it merges if
  and only if $x$ and $y$ lie in distinct $h$-orbits, where
  $(h,y)=(f,e x)$,  $(e,n x)$, or $(n,f x)$.
\end{lemma}

\begin{proof} The walkup $W_f$ splits if and only if $f x$ 
(or $x$)
and $e x$ lie in the same $f$-orbit before the split. 
Figure~\ref{fig:split} makes this clear.
The other cases $h=e,n$ hold by triality.
\end{proof}

\figILWHXTE % fig:split


The following is a useful way to tell if a walkup merges.


\begin{lemma}[merge criterion]\guid{FKSNTKR}\label{lemma:ng-merge}  
\formalauthor{TNT, lemma FKSNTKR}
\hspace{-10pt}
Suppose, in a simple plain hypermap $(D,e,n,f)$, that an edge $\{x,y\}$ consists
of two nondegenerate darts.  Then the walkup $W_f$ 
% (resp. $W_n$)  removed Jan 10, 2009.  Needed? It is formalized in TNT's formal proof.
at $x$ merges.
\end{lemma}
\indy{Index}{merge}%

\begin{proof}
The darts $f x$ and $e x$ lie in the same node: $n (f x) = e^{-1} x
= e x$. If they are also in the same face of a simple hypermap, then
$f x = e x = y$. So
\[ n y = n f x = n f e y = y,\]  and $y$
is a fixed point of $n$, and hence degenerate, contrary to assumption.
Thus, $f x$ and $e x$ are in different faces, and the walkup merges by
Lemma~\ref{lemma:merge-split}.
\end{proof}


\subsection{double}
\indy{Index}{walkup!double}%

A double walkup is the composite of two walkups of the same type.  The
two darts for the two walkups are to be the members of an orbit of
cardinality two (under $n$, $e$, or $f$).
By choosing the type of the walkups to be different from the type of
the orbit, the first walkup reduces the orbit to a singleton, forcing
the second walkup to be degenerate.
\formaldef{double edge walkup}{double\_edge\_walkup}

Here are some examples.
\begin{enumerate}\wasitemize 
\item A double $W_n$ along an edge deletes the edge and merges the two
  endpoints into a single node (Figure~\ref{fig:doublenode}).
\item A double $W_f$ along an edge deletes the edge and merges the two
  faces along the edge into one (Figure~\ref{fig:doubleface}).
\item A double $W_e$ at a node of degree two deletes the node and
  merges the two edges at the node into one
  (Figure~\ref{fig:doubleedge}).
\end{enumerate}\wasitemize 

\figYKJFZEB % fig:doublenode


\figRVNJBTK % fig:doubleface


\figCBQQAKM % fig:doubleedge


\figKLANQLT % fig:doubleplain


\begin{lemma}[plain walkup]\guid{HOZKXVW}\label{lemma:dwalk-planar}  
\formalauthor{TNT, lemmaHOZKXVW}
The three preceding double walkups carry plain
hypermaps into plain hypermaps.
\end{lemma}
\indy{Index}{hypermap!plain}%

\begin{proof} The walkups $W_n$ and $W_f$ preserve the orbit structure
  of edges, except for dropping one dart.  By dropping both darts from
  the same edge, one edge is lost and all others edges remain
  unchanged.

  Figure~\ref{fig:doubleplain} illustrates the double $W_e$ at $\{x,y\}$.  The two
  edges $\{x,e x\}$, $\{y, e y\}$ meeting the node are fused by the
  double walkup into $\{e x, e y\}$, which is still an edge of cardinality
  two.
\end{proof}





\section{Planarity}
\indy{Index}{walkup}%
\indy{Index}{planar}%

Just as a graph can be planar or nonplanar, so too can a hypermap.  A
plane graph satisfies Euler's formula, which relates the number of
vertices, edges, and faces of the graph.  Euler's formula can be
expressed in purely combinatorial terms, then generalized to
hypermaps.  A hypermap for which Euler's formula holds is defined to
be planar.  
%This definition is one of the most important concepts in
%this chapter.

\begin{definition}[planar]\guid{QVATKMJ}
\formaldef{planar}{planar\_hypermap}
A hypermap is \newterm{planar} (note the
spelling!) when the Euler relation holds:
\[ \# n + \# e + \# f = \# D + 2\, \#c.\] 
\indy{Index}{planar}%
\end{definition}


\begin{remark}[Eulerian relation]\guid{YPVCMHI}\label{rem:Euler}
The Euler relation for plane graphs can be translated into the
language of hypermaps.  Consider a connected plane graph that
satisfies the Euler relation for the alternating sum of Betti
numbers:
\[ b_0 - b_1 + b_2 = 2,\]  where $b_0$
is the number of vertices, $b_1$ the number of edges, and $b_2$ the
number of faces (including an unbounded face) of the plane
graph. The hypermap $(D,e,n,f)$, made from the plane graph in
Remark~\ref{rem:hypermap}, is plain, and the involution $e$ has no fixed points.  
Thus, $\# D = 2\#e$, according to the partition of $D$ into edges.  Moreover,
\begin{align*}
b_0 &= \# n\\
b_1 &= \# e\\
b_2 &= \# f\\
2b_1 &= \# D\\
1 &= \#c\\
b_0 - b_1 + b_2  &= \# n + (\#e - \#D) + \# f = 2\,\# c.
\end{align*}
Thus, the hypermap is also planar.
\indy{Index}{Euler characteristic relation} %
\end{remark}


The Euler relation for graphs has many consequences, one of which is
 that in a triangulation of the sphere, the number of
edges is equal to $3/2$ times the number of faces because each face
has three edges and each edge borders two faces.  Here is another simple
consequence, expressed in the language of hypermaps.

\begin{lemma}[dart bound]\guid{TGJISOK}\label{lemma:dart-upper} 
\formalauthor{TNT, lemmaTGJISOK}
Let $H$ be a connected plain planar hypermap such that every edge
has cardinality two.  Assume that there are at least three darts in
every node.  Then
\[ 
\# D \le (6\, \#f - 12).
\] 
\end{lemma}
\indy{Notation}{H@$H$ (hypermap)}%

\begin{proof}  In a connected plain planar hypermap, the Euler relation becomes
\[ 6\, \#f - 12 = \#D + 2(\#D - 3\,\#n),\] 
so it is enough to show that
\[ 
\# D \ge 3\,\#n.
\] 
The inequality follows directly by assumption: the set of darts can be
partitioned into nodes, with at least three darts per node.
\end{proof}


\begin{definition}[planar~index]\guid{ICAWSNK}
\formaldef{planar index}{planar\_ind}
The \fullterm{planar index}{planar!index} of a hypermap is
\[ \iota = \# f + \# e + \# n - \# D - 2\,\#
c.\] 
\indy{Index}{hypermap!planar index}%
\indy{Notation}{zzi@$\iota$ (planar index)}%
\end{definition}

The index measure the departure of a hypermap from planarity; a
hypermap with index zero is planar.

\begin{lemma}[walkup index]\guid{IUCLZYI}\label{lemma:index} 
\formalauthor{TNT, lemmaIUCLZYI}
\formalnote{done for edge walkup}
Let $x$ be a nondegenerate dart of a hypermap $(D,e,n,f)$. Let
$(D',e',n',f')$ be the result of the face walkup $W$ at $x$.  The
walkup changes the cardinality of some orbits.
\begin{align*}
%\text{\bf Non-degenerate dart $x$: }&\\
\# f' &=\# f +\op{split}_f  \\  
\# e'&=\# e \\
\# n'&=\# n \\
\# D'&=\# D - 1 \\
\#c'&=\# c + \op{split}_c\\
\iota' &= \iota + 1+\op{split}_f - 2\op{split}_c,\\
\end{align*}
where
\[ 
\op{split}_f = \begin{cases}
1,&\text{if $W$ splits }\\
-1,&\text{if $W$ merges}\\
\end{cases}
\] 
and $\op{split}_c=1$ if $e x$ and $f^{-1} x$ belong to different
combinatorial components after the walkup $W$, and $\op{split}_c=0$
otherwise. Moreover, a walkup at a degenerate dart preserves the
planar index.  \indy{Notation}{split@$\op{split}_c$, $\op{split}_f$}%
\indy{Notation}{W4@$W$ (walkup)}%
\end{lemma}

\begin{proof} The proof is evident from Figures \ref{fig:walk},
  \ref{fig:walkdegen}, and \ref{fig:split}.
\end{proof}

\begin{lemma}[index inequality]\guid{BISHKQW}\label{lemma:planar-index2}
\formalauthor{TNT, lemmaBISHKQW}
Let $\iota$ be the index of a hypermap $(D,e,n,f)$ and let $\iota'$
be the index after a walkup $W_h$ at a dart $x$.  Then $\iota \le
\iota'$.
\end{lemma} 


\begin{proof} Without loss of generality, by triality symmetry, the
walkup is a face walkup.  If $\op{split}_c=0$, then the inequality is
immediate by Lemma~\ref{lemma:index}.  If $\op{split}_c=1$, 
then $e x$ and $f^{-1} x$ lie in
different components after the walkup and in different
faces as well.  Thus, the walkup splits by Lemma~\ref{lemma:merge-split}, and
  $\op{split}_f = 1$.  The result
follows by Lemma~\ref{lemma:index}.
\end{proof}

The following lemma is a hypermap analogue of the fact that the Euler characteristic
of a surface graph is never greater than the Euler characteristic of a plane graph.

\begin{lemma}[nonpositive index]\guid{FOAGLPA}
\formalauthor{TNT, lemmaFOAGLPA}
\label{lemma:planar-nonpos}  
The planar index
of a hypermap is never positive.
\end{lemma}

\begin{proof}  An face walkup never decreases the index.  A sequence
of face walkups leads to the empty hypermap, which has
index zero.
\end{proof}


\begin{lemma}[planar walkup]\guid{SGCOSXK}
\formalauthor{TNT,  lemmaSGCOSXK}
\label{lemma:walkup-planar}
Walkups take planar hypermaps to planar
hypermaps.
\end{lemma}

\begin{proof}  
A planar hypermap has maximum index.  The walkup
can only increase the index, but never beyond its maximum.  
Thus, the index remains at its maximum value.
\end{proof}





\section{Path}

This section develops the basic properties of paths in hypermaps.


\subsection{contour}

We make a distinction between injective paths, which never
repeat a dart, and loops that return to the initial dart in the trajectory.
In the definition of loop, we wish to remove any dependence on an initial dart.
A loop can start in at an arbitrary dart in the trajectory.  If a path is a certain
kind of list, then a loop is a certain kind of cyclic list, as given in the
definition that follows.

\begin{definition}[cyclic~list]\guid{MYJNYCZ}\label{def:cyclic:list}
  \formaldef{cyclic list}{samsara} \formaldef{cyclic list}{(:(A)loop)}
\formalnote{samara is the function that goes to the next element on the list}
  A \fullterm{cyclic list}{cyclic!list} $\lp{x_0;\ldots;x_{k-1}}$ is an equivalence
  class of lists under the transitive closure of the relation:
\[ 
[x_0;x_1;x_2;\ldots;x_{k-1}] \sim [x_1;x_2;\ldots;x_{k-1};x_0].
\] 
A \newterm{sublist} of a cyclic list is a sublist of some representative of the
equivalence class.
\end{definition}
%\indy{Notation}{4@$\lp{\wild}$ (cyclic list)}% %doesn't parse

\begin{definition}[contour~path,~contour~loop]\guid{AUIDQRN}
\formaldef{contour}{is\_contour}
\formaldef{injective}{is\_inj\_contour}
\formaldef{contour loop}{is\_loop}
 A \fullterm{contour path}{contour!path} from
$x_0$ to $x_{k-1}$ is a path $[x_0;x_1;\ldots;x_{k-1}]$ such that
$x_{i+1} = n^{-1} x_i$ or $f x_i$ for each $i<k$.  (That is, each
step in the path is a clockwise step around a node or a
counterclockwise step around a face.)  
A \fullterm{contour loop}{contour!loop} is an injective cyclic list
$\lp{x_0;x_1;\ldots;x_{k-1}}$ such that
for every $i$, there exists $h_i\in \{f,n^{-1}\}$ such that $x_{i+1} = h_i x_i$, 
where the subscripts are
read modulo $k$.
%$[x_1;\ldots;x_{k-1}]$ is injective and $x_0 = x_{k-1}$, then it is
%a \newterm{contour loop}.  
%A sublist of a contour loop $[x_0;\ldots;x_{k-1}]$ is a path
%$[y_0;
\indy{Index}{path}%
\indy{Index}{loop}%
\end{definition}


If we consider steps $x\mapsto n^{-1} x$ and $x\mapsto f x $ as
positive and other steps as negative, then a contour path can be
intuitively imagined as a path that carries an intrinsic positive
orientation.  That is, a contour path is an oriented path of sorts.



\begin{remark}[contour path illustration]\guid{AWRGIPA}
 Figure~\ref{fig:hypermap_ex}
  constructs a hypermap from a plane graph by drawing darts next to
  each angle.  In this representation, the darts along a contour path
  lie to the left of the corresponding plane graph edges.  For that
  reason, a shaded region to the left of a curve depicts a contour
  path.
\end{remark}

\figTUPLKAJ % fig:shade-dart


\begin{lemma}[injective path]\guid{QZTPGJV} 
\formalauthor{TNT, lemmaQZTPGJV}
An injective contour path from
  $x$ to $y$ can be constructed from an arbitrary contour path from
  $x$ to $y$ by dropping some darts from the path.
\end{lemma}

\begin{proof} Repeatedly replace $[\ldots;a;b;\ldots;b;c;\ldots]$ with
$[\ldots;a;b;c;\ldots]$.
\end{proof}





\begin{lemma}[contours-components]\guid{KDAEDEX}\label{lemma:connect-contour}  
\formalauthor{TNT, lemmaKDAEDEX}
Let $H$ be a hypermap.
If $x$ and $y$ are darts in the same combinatorial component of $H$ if and only if
there exists a contour path from $x$ to $y$.
\end{lemma}

\begin{proof} 
Combinatorial components are defined by an equivalence relation $\sim_S$, where
$S = \{e,n,f\}$.  By Lemma~\ref{lemma:er}, this is the same equivalence relation as
$\sim_T$, where $T = \{n^{-1},f\}$.  By the definition of the equivalence relation $T$,
$x\sim_T y$ if and only if some contour path runs from $x$ to $y$.
\end{proof}
\indy{Index}{component!combinatorial}%

\begin{definition}[complement]\guid{GCACAFP} 
\formaldef{complement}{complement}
Let $(D,e,n,f)$ be a plain hypermap.
Let $P=\lp{x;y;\ldots}$ be a contour loop that does not return to visit any node
a second time.   (In particular, the dart set of $P$ intersected with a node
is the dart set of a maximal sublist $[z;n^{-1}z;\ldots;n^{-k}z]$ of $n^{-1}$ steps.)
 Replace each maximal sublist of
$n^{-1}$-steps
\[ 
[z;n^{-1} z; \ldots; n^{-k} z]
\] 
with the sublist
\[ 
[n^{-(k+1)} z;n^{-(k+2)} z;\ldots; n z].
\] 
Concatenate these new sublists in reverse order.  By the relation $n f = f^{-1} n^{-1}$,
the transitions between the new sublists are $f$-steps.
The resulting contour loop $P^c$
is the \newterm{complement}. 
\end{definition}
\indy{Notation}{4@$\wild ^c$ (complement)}%

\figJMTLBJN % fig:contour-comp



\subsection{M\"obius}

The rest of this section develops the basic properties of M\"obius
contours.  A M\"obius contour should be thought of as the simplest
kind of nonplanar contour path.  M\"obius contours turn out to be
extremely useful because in practice the best way to certify that a
given hypermap is nonplanar is to produce a M\"obius contour in the
hypermap (Lemma~\ref{lemma:no-mobius}).

\begin{definition}[M\"obius~contour]\guid{MBYIEQP}
\formaldef{M\"obius contour}{is\_Moebius\_contour}
\hspace{-4pt}
 A M\"obius contour in a hypermap
$(D,e,n,f)$ is an
injective contour path $P=[x_0;\ldots]$ that satisfies
\begin{equation}
\label{eqn:mobius}
x_j = n x_0,\quad x_k = n x_i
\end{equation}
for some $0 < i\le j< k$ (Figure~\ref{fig:mobius}).
\indy{Index}{contour!Moebius}%
\end{definition}


\begin{remark}[Four-color theorem]\guid{ROIPZSU}
Gonthier devised the notion of M\"obius contour as a way to prove
the four-color theorem without appeal to topology.  (The Appel--Haken
proof of the four-color theorem ultimately relies on the Jordan curve theorem.)
This chapter uses a significant amount of material from ~\cite{Gonthier:2005:FourColor}.
\end{remark}

\figMSWJHND % fig:mobius


\figIWKICBI % fig:3m 


\begin{remark}[M\"obius strip]\guid{NGALZAC}
 Heuristically, a M\"obius contour is a 
combinatorial M\"obius strip that
twists one side to the other (Figure~\ref{fig:mobius-strip}).  
A planar hypermap has no such contour.  
\end{remark}

\figOOXPORQ % fig:mobius-strip


\begin{lemma}[planar-non-M\"obius]\guid{LIPYTUI}\label{lemma:no-mobius}
\formalauthor{TNT, lemmaLIPYTUI}
\hspace{-6pt}
A planar hypermap does not have a M\"obius contour.
\end{lemma}
\indy{Index}{hypermap!planar}%

\begin{proof} For a contradiction, assume that there exist planar
  hypermaps with M\"obius contours.  To simplify the counterexample
  and reduce the number of darts, we may use walkups that transform a
  planar hypermap with a M\"obius contour into another planar hypermap
  with a M\"obius contour.  An edge walkup at a dart that is not on
  the M\"obius contour transforms a counterexample in this way.  A
  walkup of the right sort at a dart that is not at position $0$, $i$,
  $j$, $k$ also transforms a counterexample into another counterexample.  (See
  M\"obius condition~\ref{eqn:mobius}.)
%
%An edge walkup carries
%planar hypermaps into planar hypermaps. 
%In the M\"obius condition~\ref{eqn:mobius},
%. 
Eventually, a counterexample with
the smallest possible number of darts contains no
darts except those on the M\"obius contour, and its only darts
are at positions $0$, $i=j=1$, $k=2$.

This counterexample has three darts (Figure~\ref{fig:3m}).  
The M\"obius condition, the
definition of contours, together with $e\ocirc n\ocirc f=I_D$ force
$e=n=f$, which are all permutations of order three.  This hypermap is not planar:
\[
\# e + \# n + \# f = 3\,\ne\, 5 = \# D + 2\,
\#c.\qedhere
\]
\end{proof}



The final results in this section are somewhat  technical lemmas that are
needed later in the correctness proof of an algorithm that generates planar hypermaps.

\begin{lemma}[step coherence]\guid{ILTXRQD}\label{lemma:contour-path-type}
\formalauthor{TNT, lemmaILTXRQD}
Suppose that a hypermap has no M\"obius contours. Let $L$ be a
contour loop.  Let $P$ be any injective contour path with at least
three darts, that starts and ends on $L$, but visits no other darts of
$L$.  Then the first and last steps of $P$ are both of the same type
($n^{-1}$ or $f$).
\end{lemma}
\indy{Notation}{P@$P$ (dart path)}%


\begin{proof} The proof shows the contrapositive.  Suppose $P=[n x;f n
x;\ldots;n y;y]$.  The successor of $n x$ on $L$ is $x$.  Starting
at $x$, follow $L$ to $y$, and on to $n x$.  Follow $P$ back to $n
y$.
%\[ 
%x\cooln L[x:n x] \opat P[ n x;ny].
%\]   
This is a M\"obius contour $x\ldots y\ldots n x\ldots n y$.

Suppose $P=[n x;x;\ldots;f^{-1} y;y]$.  Starting at $x$, follow $P$ to
$y$, then follow $L$ to $n x$, and on to $n y$.  This is also a M\"obius
contour.\footnote{The second statement can also be deduced from the first statement
by the duality $(D,e,n,f)\leftrightarrow (D,e^{-1},f^{-1},n^{-1})$ that swaps
$f$-steps with $n^{-1}$-steps in a path.}
\end{proof}



\begin{lemma}[loop separation]\guid{ICJHAOQ}\label{lemma:contour-f}
\formalauthor{TNT, lemmaCJHAOQ}
Suppose that a hypermap has no M\"obius contours.  Let $L$ be a
contour loop.  Then there does not exist a contour path
$[x_0;\ldots;x_k]$ for $k\ge 1$ with the following properties.
\begin{enumerate}
\item $x_i$ lies on $L$ if and only if $i=0$.
\item $x_1 = f x_0$.
\item $x_0$ and $x_k$ lie in different nodes.
\item Some dart of $L$ is at the node of $x_k$.
\end{enumerate}
\end{lemma}


\begin{proof} Assume for a contradiction that the path $P$ exists.
Some sublist is injective and satisfies the same conditions.  Again,
without loss of generality, shrinking the path if needed, $k$ is the
smallest index for which the last two conditions are met.  Append
$n^{-1}$-steps to $P$ to reach a dart of $L$.  This is contrary to
Lemma~\ref{lemma:contour-path-type}.
\end{proof}

\begin{lemma}[three darts]\guid{EUXPBPO}\cutrate{}\label{lemma:3dart}  
\formalauthor{TNT, lemmaThreeDarts}
Assume that each face of a hypermap  has at least three darts.
Then every contour loop that meets at least two nodes has at least
three darts.
\end{lemma}

\begin{proof} Let $P=\lp{x;y}$ be a contour loop meeting two nodes.  Then
$y = f x$ and $x = f y$, so that the face has cardinality two.
\end{proof}


\section{Subquotient}
\indy{Index}{subquotient}%

This section develops the properties of \newterm{subquotient}
  hypermaps.  Each dart in a subquotient hypermap is an equivalence
class of darts in the originating hypermap.  It is a subquotient
rather than a quotient because the equivalence relation
is only defined on a {\it subset} of the darts of the originating
hypermap. 

Subquotients are used in the algorithm to generate planar hypermaps, described
later in the chapter.  The
originating hypermap is the one we wish to construct and the subquotient
is the partially constructed hypermap of the unfinished algorithm.  The material
in this section has the narrow purpose  of providing a descriptive language for the
algorithm.  This material  is not  used outside this chapter.

\subsection{definition}

An isomorphism is a structure preserving map.

\begin{definition}[isomorphism]\guid{GUDUERI}
\formaldef{isomorphic}{iso}
 Two hypermaps $(D,e,n,f)$ and
$(D',e',n',f')$ are \fullterm{isomorphic}{isomorphism!hypermap} 
when there is a bijection
$G:D\to D'$ such that
\[ h'\circ G = G\circ h\] 
for $(h,h')=(e,e'), (f,f'), (n,n')$.
\indy{Notation}{G@$G$ (isomorphism of hypermaps)}%
\end{definition}

The faces of a subquotient are to be traced out by a collection of contour loops
in the originating hypermap.  To get a well-defined subquotient, the collection
of contour loops must be normal in the following sense.

\begin{definition}[normal family]\guid{RQSVFLE}
\formaldef{normal}{is\_normal}
Let $(D,e,n,f)$ be a hypermap. 
%Assume that 
%there are no darts fixed by $e$ 
%(so that $f x \ne n^{-1} x$ at each dart). 
Let $\cal L$ be a family of contour
loops.  The family $\cal L$ is  \fullterm{normal}{normal family} if the following
conditions hold of its loops. \begin{enumerate}
\item  No dart is visited by two different loops.
\item  Every loop visits at least two nodes.
\item  If a loop visits a node, then every dart at that node is visited
by some loop.
\end{enumerate}
\end{definition}


A normal family determines a new hypermap.  A dart in the new set $D'$
of darts is a maximal sublist $[x;n^{-1} x; n^{-2} x;\ldots;n^{-k}
x]$ of $n^{-1}$ steps appearing in some loop in $\cal L$. The map $f'$
takes the maximal path $[x;n^{-1}x;\ldots;y]$ to the maximal path (in
the same contour loop) starting at $f y$. The map ${n'}^{-1}$ takes
the maximal path $[\ldots;y]$ to the maximal sequence (in some other
contour loop) starting $[n^{-1}y;\ldots]$. Equivalently, $n'$ takes
the maximal path $[x;\ldots]$ to the maximal path ending $[\ldots;n
x]$. The map $e'$ is defined by $e'\ocirc n'\ocirc f' = I_{D'}$.
\indy{Index}{path!maximal} %
\indy{Notation}{D@$D$ (dart set)}%

\begin{definition}[subquotient]\guid{AJENHSB}
\formaldef{quotient dart}{atom}
\formaldef{subquotient}{subquotient}
\formaldef{$D'$}{quotient\_darts}
\formaldef{$e'$}{emap}
 The hypermap $(D',e',n',f')$
constructed from the normal
family $\cal L$ of $H=(D,e,n,f)$ 
is called the \newterm{subquotient} of $H$ by $\cal L$ and is denoted
$H/{\cal L}$.  If $x$ is a dart visited by some loop in $\cal L$, then
the maximal path $[\ldots;x;\ldots]$ is called the \newterm{quotient dart} of $x$.
%The hypermap $H$ is said to be a \newterm{cover} of $H/{\cal L}$.  
\indy{Index}{subquotient}%
\end{definition}
\indy{Notation}{L@$\cal L$ (normal family of loops)}%
\indy{Notation}{H@$H/{\cal L}$ (subquotient)}%
%\indy{Index}{cover}%
\indy{Index}{hypermap!subquotient}%
\indy{Index}{normal family}%

Intuitively, the subquotient hypermap is represented as a graph with
cycles under $f'$ that are precisely the contour loops in the normal family
(Figure~\ref{fig:quot}).

\figWMWCTGH   % fig:quot   


\subsection{properties}

This subsection explores some of the properties of a subquotient hypermap.
The first two lemmas describe the faces and the nodes of the subquotient
in terms of the combinatorics of the normal family.

\begin{lemma}[subquotient face,~$\F$]\guid{WIRLCNL}\label{lemma:subquotient-bijection}
\formaldef{$F(L)$}{cycle}
\formalnote{lemma\_cycle\_is\_face, lemmaQuotientFace}
  Let ${\cal L}$ be a normal family of the hypermap $H$.  Then ${\cal
    L}$ is in natural bijection with the set of faces of the subquotient
  $H/{\cal L}$.  If $x'=[x;\ldots;n^{-k}x]$ is a maximal path of
  $n^{-1}$ steps in the contour loop $L\in{\cal L}$, then the
  corresponding face $\F(L)$ of $H/{\cal L}$ is the
  one containing the quotient dart $x'$.
\end{lemma}
\indy{Notation}{F@$\F$ (subquotient bijection)}%

\begin{proof}  This is left as an exercise for the reader.
\end{proof}


\begin{lemma}[subquotient node]\guid{UDJNSHH}\label{lemma:subquotient-node}
\formalnote{not formalized, go back to definitions and lemma\_QuotientNode, lemma\_in\_QuotientNode describing quotient nodes}
Let $H$ be a hypermap and let ${\cal L}$ be a normal family of $H$.
Then there is a natural bijection between  the set of nodes of
$H/{\cal L}$ and the set of nodes of $H$ that
are visited by some contour loop in ${\cal L}$.   
The bijective function sends the node in $H/{\cal L}$ of 
the dart $x' = [x;n^{-1} x;\ldots;n^{-k}x]$ to the node of $x$ in $H$.
\end{lemma}

\begin{proof}  The proof is an elementary verification.
Let $H/{\cal L} = (D',e',n',f')$.
\claim{The function described in the lemma is well-defined.}  Indeed, 
 \[ 
(n')^{-1} x' = [n^{-(k+1)} x;\ldots]
\] 
 is also sent to the node of $x$ in $H$.

\claim{This function is onto.}  Indeed,
If $L\in {\cal L}$ visits $x$,  and $x'$ is the quotient dart of $x$ in $D'$,
then the node of $x'$ clearly maps to the node of $x$.  

\claim{Finally, the function is one-to-one.}  Indeed, if the nodes of
two quotient darts $x'$, $y'$ map to the same node of $H$, then
$x'=[x;\ldots]$ and $y'=[y;\ldots]$, where $n^j x = y$ for some $j$.
It follows by the definition of the node map on the subquotient that
$x'$ and $y'$ belong to the same node.
\end{proof}

The next two lemmas look at properties of the subquotient that are
inherited from the original hypermap.

\begin{lemma}[plain subquotient]\guid{JMKRXLA}\label{lemma:subquotient-plain}
\formalauthor{TNT, lemmaJMKRXLA}
Let $H$ be a plain hypermap and let $\cal L$ be a
normal family.  Then $H/{\cal L}$ is a plain hypermap.
\end{lemma}

\begin{proof}  Write $H=(D,e,n,f)$ and $H/{\cal L} = (D',e',n',f')$.  
Write $[\ldots; x]$ for the node in
the subquotient ending in dart $x\in D$ and $[x;\ldots]$ for the node
in the subquotient starting with dart $x\in D$.  Plainness gives $e^2 x
= x$, so that for any dart $[\ldots x]$ in the subquotient
\begin{align*}
{e'}^{-2} [\ldots; x] &= n' f' n' f' [\ldots; x] = n' f' n' [f x; \ldots] \\&=
n' f' [\ldots; n f x] = n' [f n f; \ldots] = [\ldots; n f n f x]\\ &=
[\ldots; e^{-2} x] = [\ldots; x].
\end{align*}
Thus, $e'$ has order two on the subquotient.
\end{proof}




\begin{definition}[no double joins]\guid{EDUYIEA}\label{def:ndj}
\formaldef{no double joins}{is\_no\_double\_joins}
A hypermap $H$ has no \fullterm{double joins}{double join}
if for every two nodes (possibly equal to each other), 
 at most one edge of $H$  meets both of them.
\end{definition}


\begin{lemma}[subquotient-no-double-joins]\guid{KSRDPTZ}
\formalauthor{TNT, lemmaQuotientNoDoubleJoins}
Let $H$ be a plain hypermap with no double joins and let ${\cal L}$ be a normal
family of $H$.  Then $H/{\cal L}$ has no double joins.
\end{lemma}

\begin{proof} \hspace{-5.5pt}By Lemma~\ref{lemma:subquotient-plain}, the subquotient
  $H/{\cal L}$ is plain.  Let $\{x',e'x'\}$ and $\{y',e'y'\}$ be edges
  with the property that $x'$ and $y'$ lie at one node of $H/{\cal L}$
  and $e'x'$ and $e'y'$ lie at a second node.  Write $x' =
  [\ldots;x]$ and $y' = [\ldots;y]$.  Then $e'x' = [\ldots;e x]$ and
  $e'y' = [\ldots;e y]$.  According to
  Lemma~\ref{lemma:subquotient-node}, the map from
  nodes of $H/{\cal L}$ to nodes of $H$ is one-to-one.  It follows that $x$ and $y$
  belong to the same node and that $e x$ and $e y$ belong to the same
   node.  By the assumption that $H$ has no double joins,
  it follows that $\{x,ex\}=\{y,ey\}$.  Hence also $\{x',e'x'\} = \{y',e'y'\}$, 
  and $H/{\cal L}$ has
  no double joins.
\end{proof}


\begin{lemma}[nodal fixed point]\guid{PYOVATA}\label{lemma:nfp}
\formalnote{Done with different hypotheses. lemmaNodalFixedPoint assumes simple hypermap quotient}
Let $H=(D,e,n,f)$ be a hypermap in which the edge map has no fixed points.
Let ${\cal  L}$ be a normal family of $H$, with subquotient $H/{\cal L} = (D',e',n',f')$.  
Then the following are equivalent conditions.
\begin{enumerate}\wasitemize 
\item $n'$ has a fixed point in $D'$.
\item The dart set of some $L\in {\cal L}$ contains a node.
\end{enumerate}\wasitemize 
\end{lemma}

\begin{proof}
If $x'=[x;n^{-1} x;\ldots;n^{-k} x]$ is a dart in $D'$, then $(n')^{-1}x'$ is
$[n^{-(k+1)} x;\ldots]$.  The dart $x'$ is a fixed point if and only if
$x = n^{-(k+1)} x$.  This holds if and only if the dart set of $x'$ is an entire node.
\end{proof}

\subsection{example}

\begin{example}[maximal normal family]\label{ex:Hall} 
  Assume that $H=(D,e,n,f)$ is a
  hypermap. % with no fixed points under $e$.
  Assume that every face meets at least two nodes. Then the set of all
  faces defines a normal family of contour loops in which each contour loop follows $f$ around
  a face $[x;f x;\ldots]$.  If $e$ acts without fixed points, then
  each dart of the subquotient is just a unit path consisting of a single
  dart of $H$, and the subquotient is isomorphic to $H$ itself.
\end{example}

\begin{example}[minimal normal family]\label{ex:H2} 
  Assume that $H=(D,e,n,f)$ is a plain hypermap.  Let $F = \{x,f x,\ldots\}$ be a face
  that visits at least three nodes and that meets each node in at most
  one dart.  Let $\cal L$ be the family with two contour loops: $\lp{x;f x;\ldots}$ 
and its complement $L^c = \lp{n^{-1} x;\ldots}$.
%\[ 
%  [n^{-1} x;n^{-2} x;\ldots;n x;f n x = y;n^{-1} y; n^{-2} y;\ldots; n y; f ny;\ldots]
%\] 
The family $\cal L$ is normal. The subquotient hypermap $H/{\cal L}$ has
two faces: $F$ and a back side $F'$ of the same cardinality $k$.
\indy{Notation}{F@$F$ (hypermap face)}%
\end{example}

\begin{example}[dihedral]\label{ex:D2k} 
\formaldef{$\op{Dih}_{2k}$}{Localization.dih2k}
\formalnote{The definition is different from what is here.}
There is a hypermap $\op{Dih}_{2k}$ with a dart set of cardinality $2k$.
The permutations $f,n,e$ have  orders $k$, $2$, and $2$ respectively, and 
$e n f = I$.
The set of darts is given by
\[ 
\{x, f x,f^2 x,\ldots,f^{k-1} x\}\cup \{n x, n f x, n f^2 x,\ldots, n f^{k-1} x\}
\] 
for any dart $x$.
If a hypermap is isomorphic to $\op{Dih}_{2k}$ for
some $k$, then it is \newterm{dihedral}.\footnote{The three permutations generate the dihedral
group of order $2k$, acting on a set of $2k$ darts under the left action of the group upon itself.}   
In particular,
the hypermap constructed in the previous example is dihedral.
\indy{Index}{hypermap!dihedral}%
\end{example}

\begin{lemma}\guid{QQYVCFM}\cutrate{}\label{lemma:dih-iso}
\formalnote{This becomes the definition}
  A hypermap $H$ is isomorphic to $\op{Dih}_{2k}$ if and only if the
  hypermap is connected, the dart set has cardinality $2k$, and the
  permutations $f,n,e$ have orders $k$, $2$, and $2$, respectively.
\end{lemma}

\begin{proof} Let $y$ be any dart of $H$, and $x$ any dart of
  $\op{Dih}_{2k}=(D,e',n',f')$.  By the connectedness of $H$, and the
  relations between $f$ and $n$, every dart of $H$ is equal to one of
  the following: $f^i y$, $n f^i y$ for $i=0,\ldots,k-1$.  By the
  cardinality assumption, these darts are all distinct.  The bijection
  ${f'}^i x \mapsto f^i y$, $n' {f'}^i x \mapsto n f^i y$ is an
  isomorphism of hypermaps.
\end{proof}

\begin{lemma}\guid{CTJYKFZ}\label{lemma:dj}
% Moved May 3, 2012 from "further.tex"
\formalnote{not needed: CRTTXAT was proved without it.}
Let $(D,e,n,f)$ be a connected plain hypermap with more than
two darts.  Assume that the hypermap has no  double joins. Assume that the
two darts of each edge lie at different nodes.
Then
every face has at least three darts.
\end{lemma}

\begin{proof}
Otherwise, if some face is a singleton $\{x\}$, then both darts
of the edge $\{x,e x\}$ lie at the same node, which is contrary to
assumption.

  Furthermore, if some face has only two darts, then 
 the two edges meeting the face, $\{x, e x\}$
  and $\{ e^{-1} f^{-1} x, f^{-1} x\}$, which join the same two nodes,
 must actually be equal.  That
  is, $ x = f e x = n^{-1} x$, so that $x$ is a fixed point of the node
  map.  Similarly, $f x$ is a fixed point of the node map.  Then $\{x,
  f x\}$ is a combinatorial component, which is contrary to the
  assumption that the hypermap is connected with more than two darts.
\end{proof}

\section{Generation}\label{sec:generation}
\indy{Index}{generation}%

This final section of the chapter, which presents an algorithm that
generates all simple, plain, planar hypermaps satisfying certain
general conditions (Definition~\ref{def:restricted}), is more
technical than other sections.  This material may be skipped without
disrupting the flow of the book because there is no need to return to
the description of the algorithm, although the book relies on the
output of the algorithm's execution in  Chapter~\ref{sec:tame}.  The
algorithm proceeds by adding more and more edges and nodes to a
dihedral hypermap.
% by a sequence of reverse double walkup
%transformations.

The algorithm itself is elementary to describe in intuitive terms.
Imagine that a biconnected plane graph $G$ has been drawn on a sheet
of paper in pencil and that the purpose of the algorithm is to retrace
the edges of graph in pen.\footnote{Historically, this algorithm was
  developed in precisely this way.  After drawing many plane graphs by
  hand while working on the Kepler conjecture, I started to generate
  the graphs by computer by automating the manual process in 1994.
  The code was first implemented in \newterm{Mathematica}, then later
  in \newterm{Java}, and more recently by Bauer and Nipkow in
  \newterm{ML} and \newterm{Isabelle/HOL}~\cite{Nipkow:2005:Tame}.}
We start the algorithm by selecting any face $F_0$ of the graph and
tracing its edges in pen.   Next, we select any node $v$ on $F_0$ at 
an edge that is still in pencil.  We can find a face $F_1$
of $G$ that shares an edge with $F_0$ with endpoint $v$, and that has
an edge in pencil at $v$.  The second step of the algorithm pens the
edges of the simple arc to complete the simple closed curve around
$F_1$.  Continue in this manner, adding a simple arc in pen to the
penciled lines to add a face of $G$, until all the edges of $G$ have
been traced in pen.  \indy{Index}{pencil and pen heuristic}%


It is remarkable (and rather unfortunate) that it requires a technical
section to put these simple pencil and pen drawings into a rigorous
form that function as a blueprint for a formal proof.  A hypermap
gives rigorous form to the pencil drawing, and various subquotients
are the inked drawings at various stages of the algorithm.


We do not attempt to work in the greatest possible generality.  As a
matter of convenience, we impose a large number of conditions on the
class of hypermaps that the algorithm generates.  In particular, we
assume that the hypermaps are restricted, as defined below.  This
definition is idiosyncratic, tailored to our needs, and matched to our
particular proof methods.


\begin{definition}[restricted]\guid{INCRVQC}\label{def:restricted}
\formaldef{restricted}{is\_restricted}
A \newterm{restricted hypermap} $H = (D,e,n,f)$ is one with the following 
properties.
\begin{enumerate}
\item The hypermap $H$ has no double joins, and is nonempty,
  connected, planar, plain and simple.
\item The edge map $e$ has no fixed points.  % Needed in Lemma:[flag subquotient]
\item The node map $n$ has no fixed points.
\item The cardinality of every face is at least three.
%%  (All hypoth. Needed?)
\end{enumerate}
\indy{Index}{hypermap!restricted}%
\indy{Notation}{H@$H$ (hypermap)}%
\end{definition}

\begin{remark}[step type]\guid{BMZYWKV}
The assumption that $e x \ne x$ implies that $f x \ne n^{-1} x$ so that $f$-steps of a 
path can be distinguished from $n^{-1}$-steps.
\end{remark}


\subsection{flag}
\indy{Index}{flag}%

The algorithm marks certain faces as ``true.''  Roughly, this means that
the face cannot be modified at any later stage of the algorithm.
That is, the edges of the faces are in ink and no pencil lines lie
within its interior.  When all of its faces are true, the hypermap
stands in final form.  The function that marks each face as true or
false is a \newterm{flag}.  For the algorithm to work properly, it is
necessary to impose some constraints, as captured in
Definition~\ref{def:flag}.  \indy{Index}{hypermap!algorithm}%


Under the bijection $\F$ between a normal family ${\cal L}$ and the
set of faces of a subquotient $H/{\cal L}$, any function 
on ${\cal L}$ can be identified with a function  on the
set of faces of $H/{\cal L}$.   
%The identification
%$\hat\varphi\leftrightarrow\check\varphi$ is frequently used  in
%this section.

\begin{definition}[canonical function]\guid{CRUDEHU}
  \formaldef{canonical function}{final\_quotient\_faces} 
\formaldef{canonical   function}{final\_loops} 
\formaldef{}{darts\_in\_final\_loops}
Let $H$ be a hypermap with normal family $\cal
  L$.  The \newterm{canonical function} $\check\varphi_{can}$ is the
  boolean-valued function on the set of faces of $H/{\cal L}$ that is
  true on $\F(L)$ exactly when the dart set of $L$ maps bijectively to
  the face $\F(L)$ of $H/{\cal L}$, under $x\mapsto [x]$.  That is,
  each dart of $\F(L)$ is a unit path in $H$.  A face $\F(L)$ (or
  contour loop $L$) is said to be canonically true or false, according
  to the value of the canonical function.
\end{definition}
\indy{Notation}{zzuvar@$\check\varphi_{can}$ (canonical function)}%


In other words, the face in the subquotient is canonically true, exactly
when the corresponding contour loop $L\in {\cal L}$ has no $n^{-1}$
steps.  The dart set of such a contour loop $L$ is a face of $H$.  
%Based on this observation, we make the following definition.


\begin{definition}[flag]\guid{HFTAHWB}\label{def:flag} 
\formaldef{flag}{empty\_flagged}
\formaldef{$S$-flag}{s\_flagged}
\formalnote{definitions use standard $S$}
  Let $S$ be a set of darts in a hypermap $H$.  An $S$-\newterm{flag}
  on $H$ is a boolean-valued function $\check\varphi$ on the set of faces that
  satisfies the following two constraints.
\begin{enumerate}
\item If darts $x,y$ belong to true faces,
then  some contour path runs from $x$ to $y$ that remains
in true faces.
\item Each edge of the hypermap meets a true face or $S$.
\end{enumerate}
An $\emptyset$-flag is simply called a flag.
%An isomorphism of flagged hypermaps is an isomorphism of
%hypermaps that respects the flags.
\indy{Index}{flag}%
\indy{Notation}{S@$S$ (flag, set of darts)}%
\end{definition}



\begin{example}[dihedral hypermap flag] \label{ex:DH}
The dihedral hypermap of Example~\ref{ex:D2k} carries a
flag that marks one face true and the other false.
\end{example}

\begin{example}[maximal subquotient flag]\label{ex:Hall-flag} 
Let $H$ be a connected hypermap and let $\cal L$ be the example of
Example~\ref{ex:Hall}. Then the canonical map takes value
$\op{true}$ on every face.  This is a flag. In fact,
Lemma~\ref{lemma:connect-contour} provides the contour paths that
are required in the definition of flag.
\end{example}



There is a standard way of constructing the sets $S$ of darts that
 are used in $S$-flags.  


\begin{definition}[S]\guid{FDRMSZG}
Let $H$ be a hypermap, $L$ a contour loop of the hypermap,
and $x$ an element of the dart set of $L$.
If  $L$ is  canonically true, then let $S=\emptyset$.
Otherwise,
let $j\ge 0$ to be the largest integer
such that 
\[ 
[x;f x; f^2 x;\ldots;f^{j} x]
\]   
is a sublist of $L$.
%Set $y = f^{m+1} x$
Set $S(H,L,x) = \{f^i x \mid 1 \le i\le j-1\}$, and $m = \card(S(H,L,x)) =\max(0,j-1)$.
\end{definition}
\indy{Notation}{S@$S(H,L,x)$ (flag set)}%

\begin{lemma}[flag subquotient]\guid{KHGAQRG}\label{lemma:flag-set-subquotient}
Let $H$ be a hypermap in which $e$ acts without fixed points, 
$L$ a contour loop, and $x$ and element of the dart set of $L$.
Let ${\cal L}$ be a normal family of $H$ that contains $L$.
Then $S(H,L,x)$ maps bijectively to a set $S'$ of darts in the subquotient $H/{\cal L}$.
\end{lemma}

\begin{proof} The darts of the subquotient are maximal sublists
  $[y;n^{-1} y;\ldots;n^{-k} y]$ of contour loops $L'\in {\cal L}$
  made entirely of $n^{-1}$ steps.  Each $y\in S(H,L,x)$ is preceded
  by an $f$-step and is followed by an $f$-step in $L$.  Hence, the
  maximal sublist of $L$ containing $y$ is a unit path $[y]$.  The
  bijection ensues.
\end{proof}


\subsection{markup}\label{sec:face-insert}
\indy{Index}{extension}%




In the heuristics at the beginning of this section, a graph is drawn in pencil
on a sheet of paper and various edges are retraced in pen.  In the following
definition, $H$ represents the pencil drawing, $H/{\cal L}$ represents the ink
drawing,  $L$ and $x$ guide the tip of the pen to the next edge to be retraced in pen.


\begin{definition}[marked hypermap]\guid{TUFOKWK}\label{def:marked}
\formaldef{marked hypermap}{is\_marked}
Let $(H,{\cal L},L,x)$ be a tuple consisting of 
\begin{enumerate}
\item a hypermap $H=(D,e,n,f)$ with no M\"obius contours  in which
  $e$ acts without fixed points;  % Mobius needed for HQY...
\item a normal family ${\cal L}$; 
\item a contour loop $L\in{\cal L}$; and
\item a dart $x$ visited by $L$.
%and 
%\item the canonical boolean-valued function $\varphi'$ on $H/{\cal L}$
%  (identified with a function $\varphi$ on ${\cal L}$ by
%  Lemma~\ref{lemma:subquotient-bijection}).
\end{enumerate}
Such a tuple is a \newterm{marked hypermap} if
the following conditions hold.
\begin{enumerate}
\item The subquotient $H'=H/{\cal L} = (D',e',n',f')$ is simple.  
\item $n'$ has no fixed points on $D'$.
\item $x$ is followed by an $f$-step in the loop: $L = \lp{x;fx;\ldots}$.
%\item $\varphi$ coincides with the natural boolean function on ${\cal L}\setminus \{L\}$.
%\item $\varphi$ is false on the loop $L$.
\item The contour loop $L'\in {\cal L}$ that visits%
\footnote{$L$ visits  $f x$.  By the definition of normality, some contour loop in
${\cal L}$ visits the dart $n f x$ at the same node.} 
$n f x$ is canonically true.
\item 
  $\check\varphi_{can}$ is an $S'$-flag on $H'$, where $S'$ is the image of 
  $S(H,L,x)$ in $D'$.  %Lemma~\ref{lemma:flag-set-subquotient}.
  %under the identification of $\varphi$ with a boolean-valued
  %function on $H'$ ().
\end{enumerate}
\end{definition}


\begin{example}[illustration]\label{ex:graph-gen}  \hspace{-5pt}
  This example illustrates the markup (Figure~\ref{fig:graph-gen}).
  In the figure, the hypermap $H$ is represented as a plane graph.
  The contour loops are represented by gray loops alongside edges
  of the  graph.  The darts in each shaded face also form a contour loop
  under the face map.  The edges of the plane graph that are flanked in gray
  give the edges of a plane
  graph representing the subquotient.  The polygons that are fully shaded
  are true, together with the unbounded face.
  Two polygons in the subquotient are false.  A dart of $H$ in
  a false contour loop $L$ in ${\cal L}$ is marked $x$.  By inspection,
  $S(H,L,x)=\{f x,f^2 x,f^3 x\}$.  By inspection,
  $\check\varphi_{can}$ is an $S'$-flag.  (In fact, the darts in true
  faces form a connected region.  Every edge in the subquotient meets a true face, except
  the edges through darts $f'x'$, $f'^{2} x'$, and $f'^{3} x'$, which meet $S'$.)
\end{example}

\figALMINNP % fig:graph-gen.



\begin{definition}[$m$,~$p$,~$q$,~$y$,~$z$]\guid{BVUFRRE}\label{def:yz}
\formaldef{$m$}{mInside}
\formaldef{$z$}{attach}
\formaldef{$y$}{heading}
\formaldef{$p$}{mAdd}
Let $(H,{\cal L},L,x)$ be a marked hypermap.
Set  $y = f^{m+1} x$, where $m = \card(S(H,L,x))$.
  Set
$z=f^{p+1} y$, where $p$ is the smallest natural number 
such that some contour loop in ${\cal L}$ visits $f^{p+1} y$.
Let $x'$ and $z'$ be the images of $x$ and $z$ respectively in $H/{\cal L} = (D',e',n',f')$.
Let $q$ be the smallest natural number such that $z' = (f')^{q+1} x'$.  
\end{definition}
\indy{Notation}{m@$m$ (face map exponent)}%
\indy{Notation}{p@$p$ (face map exponent)}%
\indy{Notation}{y@$y$ (dart)}%
\indy{Notation}{z@$z$ (dart)}%

In the pencil-pen analogy, the dart $y$ marks the tip of the pen as it
is about to draw a simple arc. The dart $z$ marks the endpoint of that
arc.  The integers $m,p,q$ track how far the pen has progressed in
tracing the edges of a face, how many nodes appear on the arc about to
be drawn, and how $z$ sits in relation to $y$ in the current pen
sketch.

The following lemma gives the existence of $q$, by showing that
$x'$ and $z'$ lie in the same face $\F(L)$ of $H/{\cal L}$.  (The
existence of $q$ is trivial when $L$ is canonically true.)  In terms
of the pencil and pen drawing, the following
lemma expresses the planarity of the drawing:
a continuous stroke of the pen that starts in one connected component of
the complement of Jordan curve and that does not cross the Jordan
curve must end in the same connected component.

\begin{lemma}[loop confinement]\guid{HQYMRTX} \label{lemma:yz}
\formalauthor{TNT, lemmaHQYMRTX}
\formalnote{Furthermore part is done in lemmaParameters}
  Let $(H,{\cal L},L,x)$ be a marked hypermap, where $H$ is
  restricted.  Assume that $L$ is canonically
  false. % canonically true assumption not needed.
  Let the natural numbers $m$ and $p$ and darts $y$ and $z$ be given
  by Definition~\ref{def:yz}.  Then, $L$ visits $z$, and $z\ne f^k x$
  when $0 < k \le {m+1}$.  Furthermore, the darts $x$ and $y$ belong
  to different nodes; the darts $y$ and $z$ belong to different nodes.
\end{lemma}

\begin{proof} 
  For a contradiction, suppose $z=f^{p+1} y = f^k x$ for some $0<k\le
  m+1$.  Then also, $f^p y = f^{k-1} x$.  If $p>0$, then this
  contradicts the minimality of $p$.  (Note that $L$ visits $f^{k-1}x$
  by the definition of $S$ and $m$.)  So $p=0$, and $y=f^{k-1} x =
  f^{m+1} x$.  Also, $0\le k-1 < {m+1}$, which implies that the face
  of $x$ has cardinality at most $m+1$.  This forces $L$ to be canonically
  true, which is contrary to assumption.  This contradiction proves the
  conclusion $z\ne f^k x$ of the lemma.  In particular, $z\not\in S$, where $S =
  S(H,L,x)$.

  \claim{The darts $x$ and $y$ belong to different nodes; the darts
    $y$ and $z$ belong to different nodes.}  Indeed, $x$, $y$, and $z$
  belong to the same face.  By the simplicity of $H$, if two of these
  darts belong to the same node, then they are equal to each other.
  However, $x\ne y$ because otherwise the subpath $P=[x;f
  x;\ldots;f^{m+1}x]$ gives a canonically true contour loop, which is
  contrary to the assumption that $L$ is canonically false.  Also,
  $y\ne z$ because otherwise the face of $y$ is equal to $\{y,f y,f^2
  y,\ldots,f^p y\}$.  It follows that $x = f^k y$ is visited by $L$
  for some $1\le k\le p$.  This contradicts the defining minimality
  property of $p$.

  Let $L'$ be the contour loop of ${\cal L}$ that visits $z$.  For a final
  contradiction, assume that $L'\ne L$.

  \claim{$L'$ is false.}  Otherwise, $L'$ is true with respect to the
  canonical flag and is therefore a loop consisting entirely of
  $f$-steps.  In particular, $L'$ visits $z,x$, and $y$.  This is
  contrary to the assumption that the contour loop containing $x$ is
  false.

  Let $H' = (D',e',n',f') = H/{\cal L}$ and let $S'$ be the image of
  $S$ in $D'$.  Let $z' = [\ldots;u]\in D'$ be the image in $D'$ of
  $z$.  As $z\not\in S$, we also have $z'\not\in S'$.  By the
  definition of $S'$-flag, the dart $e'z'$ lies in a true face or
  $e'z'\in S'$.  This disjunction splits the proof into two
  cases.
\begin{enumerate}
%\item\claim{[]}  
\item In the case that $e'z'$ lies in a true face, 
\[ 
e'z' = {f'}^{-1} {n'}^{-1} [\ldots,u] = {f'}^{-1} [n^{-1}u;\ldots]=[f^{-1}n^{-1}u],
\] 
so that $n^{-1} u$ is visited by a true contour loop.
Consider the contour
path in $H$, obtained by concatenating
\[ 
[y;fy;\ldots;z],\quad [n^{-1}z;\ldots;u],~\text{ and } ~ [n^{-1} u;\ldots;n^{-1} x].
\] 
The first segment consists of $f$-steps, the second of $n^{-1}$-steps,
and the third segment exists within true contour loops of ${\cal L}$
by the connectedness of true faces (by properties of flags).  This
path satisfies all the properties of Lemma~\ref{lemma:contour-f}.
In particular, the second segment avoids $L$ by Lemma~\ref{lemma:contour-path-type}.  
The lemma asserts that the path does not exist.
\item 
%\claim {[.]}  
In the case that $e'z'\in S'$,  it follows that
$f^{-1}n^{-1}u \in S$ and $L$ visits $n^{-1} u$ at the node of $z$.
Consider the following path of $f$-steps in $H$:
\[ 
[y;f y;\ldots;z].
\] 
This path satisfies all the enumerated properties of
Lemma~\ref{lemma:contour-f}.   The lemma asserts that the path does not exist.
\end{enumerate}
\end{proof}

\begin{lemma}[parameters]\guid{QRDYXYJ}\label{lemma:parameters}
\formalauthor{TNT, lemmaParameters}
Let $(H,{\cal L},L,x)$ be a
marked hypermap, where $H$ is restricted. Assume that $L$ is canonically false.
Let $m$, $p$, and $q$ be the natural numbers and let $x$, $y$, and $z$ be the darts given by
Definition~\ref{def:yz}.  Let $r = \op{card}(\F(L))$.  Then
\[ 
0\le p,\quad 0\le m < q < r,\quad m+1 < p+q.
\] 
\end{lemma}

\begin{proof}
Let $H/{\cal L}=(D',e',n',f')$.  Let $y'$ and $z'$ be the images of $y$ and $z$
in $D'$, respectively.  Let $S'$ be the image of $S(H,L,x)$ in $D'$.
By definition $m = \op{card}(S(H,L,x))$.  Both $m$ and $p$ are natural numbers,
so $0\le p$ and $0\le m$. 


\claim{$q<r$.}  Indeed,
by definition, $z' = (f')^{q+1} x'$ and no smaller natural
number has this property.  Also, $x'$ and $y'$ belong to the face $\F(L)$.
If $q\ge r$, then $(f')^{q+1} = (f')^{q-r+1}$, which contradicts the minimality of $q$.

\claim{We claim $m<q$.} Indeed, if $0\le k< m$, then
\[ 
(f')^{k+1} x' = [f^{k+1} x]\in S',\quad \text{ and }\quad (f')^{q+1}x' = z'\not\in S',
\] 
by Lemma~\ref{lemma:flag-set-subquotient} and Lemma~\ref{lemma:yz}.
Thus, $m\le q$.  Also, $q\ne m$ because otherwise $z' = (f')^{m+1} x'
= y'$.  This implies that $z$ and $y$ lie in the same node, which has
been proved impossible.  This completes the proof that $m<q$.
 
\claim{We claim $m+1 < p+q$.}  Indeed, the inequalities $0\le p$ and $m<q$ imply
that either $m+1 < p+q$ or $p=0~\land~m+1=q$.  The second disjunct
cannot hold because otherwise $z' = (f')^{q+1} x' = f' y'$.  Write $y' = [y;\ldots;u]$.
This is not a unit path by the definitions of $S(H,L,x)$ and $m$, so $y\ne u$; however,
$y$ and $u$ lie in the same node.  Also from $p=0$, it follows that $z= f^{p+1} y = f y$.
So, $e y$ and $e u$ both lie in the node of $z'$.  The existence of
 two edges, $\{y, e y\}$ and
$\{u, e u\}$, between the same nodes contradicts the hypothesis
on $H$ of no double joins.  This proves the claim and the lemma.
\end{proof}

\subsection{transform}

\indy{Notation}{T@$T$ (transform)}%
\begin{definition}[transform]\guid{YQANQNF}\label{def:transform}
  From one marked hypermap $(H,{\cal L},L,x)$ in which $L$ is
  canonically false, we construct a new tuple
\[ 
T(H,{\cal L},L,x) = (H,{\cal M},L_1,x),
\] 
 called the \newterm{transform} of
  $(H,{\cal{L}},L,x)$.  
As the notation indicates, the hypermap $H$ and the dart $x$ are the same for both
tuples.  The data ${\cal M}$ and $L_1$ are specified in
the following paragraph.
\end{definition}

\figKCSQIOY % fig:transform

In the pencil-pen heuristic, the transform is the act of drawing a single simple arc in
pen (Figure~\ref{fig:transform}).
Let $m$, $p$, $y$, and $z$ be  given by
Definition~\ref{def:yz}.
Let $L_1$ be 
%With improvised notation, write
%\[ 
%L_1 = \lp{L[x:y] \opat P[y:z] \opat L[z:x]},
%\] 
the contour loop in $H$ that follows $L$ from $x$ to $y$,  takes
$f$-steps from $y$ to $z$, and then continues along $L$ back to $x$.  
Let $L_2$ be
%\[ 
%L_2 = \lp{L[n^{-1}y:n z] \opat P^c[n z:n^{-1}y]},
%\] 
the contour loop in $H$ that follows $L$ from $n^{-1} y$ to $n z$, and
then complements the path of $L_1$ from $y$ to $z$, traveling instead
from $n z$ to $n^{-1} y$. 
Let
\begin{equation}\label{eqn:ML} 
{\cal M} = ({\cal L}\setminus \{L\}) \cup\{L_1,L_2\}.
\end{equation}

\begin{remark}[canonical compatibility]\guid{HBLIYVM}
There is a canonical boolean function on ${\cal L}$ and one on ${\cal M}$.
The canonical boolean functions agree on the intersection ${\cal L}\cap {\cal M}$.
This means there is a well defined boolean-valued function on 
${\cal L}\cup {\cal M}$.  There is no ambiguity.  
\end{remark}




\begin{lemma}[markup transform]\guid{AQIUNPP}\label{lemma:flag} 
\formalauthor{TNT, lemma\_normal\_genesis, lemma\_disjoint\_new\_loops, partially done as of Jan 2014.}
Let $(H,{\cal L},L,x)$ be a marked hypermap in which
 $H$ is a restricted hypermap and $L$
is canonically false.  Then the transform
$(H,{\cal M},L_1,x)$ 
is also a marked hypermap.
\end{lemma}

In the pencil-pen heuristic, the marking of the hypermap records the
state of the pen.  The transform draws a single simple arc on paper in
pen.  The lemma asserts that in the act of drawing a simple arc, we
retain a record of the state of the pen.

\begin{proof} Let 
\[ 
H=(D,e,n,f),\   H' =(D',e',n',f') = H/{\cal
    L},\  H'' = (D'',e'',n'',f'') = H/{\cal M}.   
\] 
Let $S'$ be the image of $S(H,L,x)$ in $D'$.  Let $y$ and $z$ be the
darts constructed in Definition~\ref{def:yz} from the marked hypermap
$(H,{\cal L},L,x)$.  The dart $z$ is not at the same node as $y$ (by
Lemma~\ref{lemma:yz}).

The proof can be organized into independent claims (typeset as usual
in italic), according to the separate properties of a marked hypermap.
The first part of the proof establishes that ${\cal M}$ is a normal
family.


\case{normal-1} \claim{No dart is visited by two different loops.}
Indeed by construction, the sets of darts of $L_1$ and $L_2$ are
disjoint from each other and disjoint from the sets of darts of $L'\in
{\cal L}\setminus \{L\}$.  The result now follows from the normality
of ${\cal L}$.

\case{normal-2} \claim{Every loop visits at least two nodes.}  Indeed, this
is true for $L_1$ and $L_2$ because they visit the nodes of $y$ and
$z$.  It is also true of the other loops because they belong to the
normal family ${\cal L}$. 

\case{normal-3} \claim{If a loop visits a node, then every dart at
that node is visited by some loop.} 
Indeed, the nodes that are visited by some loop in ${\cal M}$ are
precisely those visited by some loop in ${\cal L}$, together with the
{\it new} nodes; that is, the nodes of $f y,\ldots,f^p y$.  The set of
darts that are visited by some loop of ${\cal M}$ is the union of the
set visited by loops in ${\cal L}$, together with the darts at the
new nodes.  As $L_1$ and $L_2$ are complementary at each new node, 
and as ${\cal L}$ itself
is normal, the claim ensues. It follows that ${\cal M}$ is normal.  

Next we check the properties of a marked hypermap (page~\pageref{def:marked}).

\case{simple} To prove the simplicity of the subquotient, it is enough
to show that none of the contour loops in ${\cal M}$ ever return to a
node after leaving it.  (In particular, the dart set of any
$L'\in{\cal M}$ intersected with a node is the dart set of a maximal
sublist $[z;n^{-1}z;\ldots;n^{-k}z]$ of $n^{-1}$ steps.)  This is true
of $L'\in{\cal L}\setminus\{L\}$ by assumption and true of $L_1$ and
$L_2$ by construction.  Simplicity ensues.

\case{fixed-point free} By Lemma~\ref{lemma:nfp}, to prove that $n''$
does not have a fixed-point, it is enough to show that no loop in
${\cal M}$ has a dart set containing a node.  It is sufficient to
consider the loops $L_1$ and $L_2$.  The set of darts of $L_1$ and
$L_2$ at the old nodes (that is, those not meeting $\{f y,\ldots,f^p
y\}$) are subsets of the set of darts of $L$ at those nodes.  As the
dart set of $L$ does not contain an old node, neither do $L_1$ and
$L_2$.  At the new nodes, $L_1$ and $L_2$ both have at least one dart,
so neither contains the entire node.  It follows that $n''$ is
fixed-point free.

The third and fourth properties of a marked hypermap are routine
verifications.  Consider the flag property (page~\pageref{def:flag}).

\claim{We claim that $e'y'\not\in S'$, where $y'$ is the image of $y$ in $H'$. }
Otherwise, write $y' = [y;n^{-1}y;\ldots;u]$, a sublist of $L$, and
select $k$ such that $e'y' = [f^k x]\in S'$.  Then
\[ 
(n')^{-1} y' = f'e'y' = f'[f^k x] = [f^{k+1}x;\ldots].
\] 
By the construction of $S(H,L,x)$, we know that $L$ visits $f^{k+1}x$.
Hence, $y'$ and $(n')^{-1}y'$ both lie in the same node and in the same
face $\F(L)$.  By the simplicity of $H'$, it follows that $y' =
(n')^{-1} y'$.  That is, $y'$ is a fixed point of $n'$.  This is contrary to
assumption. The claim ensues.


\claim{We claim that $e'y'$ lies in a true face of $H'$.}  Indeed, since
$\check\varphi_{can}$ is an $S'$-flag on $H'$, the edge $\{y',e'y'\}$
meets a true face or $S'$.  However, $y'\not\in S'$, because each dart
of $S'$ is a unit path but $y'$ is not.  Also, $e'y'\not\in S'$, by
the previous paragraph.  The dart $y'$ lies in the false face $\F(L)$.
The only remaining possibility is that $e'y'$ lies in a true face.



\case{flag-1} \claim{The true faces of $H''$ are connected.}  Indeed,
$L_1$ is connected to a true face by the contour path $[x;n^{-1} x]$
because $n^{-1} x$ lies in the same face as $n f x$, which is a true
face by assumption.  If $L'\in{\cal M}\setminus\{L_1,L_2\}$ is true,
then $L'\in {\cal L}$, and it connects with the true faces of ${\cal
  L}$ as before.  If $L_2$ is true, then the proof requires more
argument.  Write $y'=[y;\ldots;u]$ as above.  (The dart $e'y'$ is
naturally identified with a dart $[e u]$ on in $H''$ because the face
is true.)  The dart $u''=[n^{-1}y;\ldots;u]$ of $H''$ lies in the face
$\F(L_2)$.  Also,
\[ 
(n'')^{-1} u''= [n^{-1} u;\ldots] = [f e u;\ldots] = f'' [ e u]
  = f'' e' y'.
\] 
Thus, $(n'')^{-1}$ steps from $u''\in \F(L_2)$ into a true face, and
from there any true face may be reached.

\case{flag-2} \claim{Each edge of $H''$ meets a true face or $S''$,
  where $S''$ is the image of $S(H,L_1,x)$ in $D''$.}  Indeed, the
function $\check\varphi_{can}$ is an $S'$-flag on $H'$.  
Let $S_1 = \{f x,\ldots,f^{m+p+1} x \}$.  Then
$S(H,L,x)\subset S_1$ and
\[
 S_1 \subset \begin{cases} \F(L_1) & \text{ if } \F(L_1) \text{ is true}
\\ S(H,L_1,x) & \text{otherwise}.\end{cases}
\]
The following four cases exhaust all edges of $H''$.
\begin{enumerate}
\item Edges of $H''$ that are identical to an edge of $H'$, which is
verified using  the $S'$-flag on $H'$;
\item edges that meet $S_1$;
\item the edge $\{u'',e''u''\}$, which is discussed and treated above;
\item the edge $\{z'',e''z''\}$, 
where $e'[z;\ldots]=[ez'']$, with $z''$ in a true face.
\end{enumerate}
%The edges of
%$H'$ can be identified with a subset of the edges of $H''$.  For this
%subset, the flag condition on edges is immediate.  Consider the new
%edges (that is, edges of $H''$ that are not in $H'$).  They all meet
%$\{y,f y,\ldots,f^p y\}$.  This set is either contained in
%$S(H,L_1,x)$ (when $F_1$ is false), or is contained in the true face
%$F_1$ (when $F_1$ is true).  Hence, each new edge meets a true face or
%$S''$.


The other verifications are routine.
\end{proof}


\subsection{algorithm}\label{sec:hypermap-algorithm}

The aim in this chapter is to prove that every restricted hypermap
with a given bound on the cardinality of the dart set is generated by
a particular algorithm.  The proof, a long induction argument, starts
by showing how to go from one partially constructed hypermap to
another more fully constructed one.  The hypermap $H$ represents the
fully constructed one and the subquotient $H/{\cal L}$ represents a
partially constructed one.

The data structures used to implementation of algorithm in computer
are less abstract than the structures we have described in this
chapter.  This subsection describes how hypermaps have been
implemented in code.


\begin{definition}[listing]\guid{ZEZRIXV}
  Let $H=(D,e,n,f)$ be a hypermap.  Write $O(h,x)$ for the orbit of a
  dart $x$ under a permutation $h$ of $D$.  In particular, $O(n,x)$ is
  the node of $x$.  The \newterm{listing} of a dart $x\in D$ is the
  list
\[
\ell_H(x) = [O(n,x);O(n,f x);\ldots;O(n,f^{k-1} x)   ], 
\]
where $k$ is the cardinality of the face of $x$.  If $\ell$ is a list,
let $\lp{\ell}$ denote the cyclic list of $\ell$
(Definition~\ref{def:cyclic:list}).  The \indexterm{listing} of $H$ is
the set
\[
\{\ell_H(x) \mid x\in D\}.
\]
\end{definition}
\indy{Notation}{O@$O(h,x)$ (orbit of $x$ under $h$)}%
\indy{Notation}{lH@$\ell_H(x)$ (listing of dart $x$)}%

To describe the computer implementation of the algorithm, we require
some basic operators on lists.

\begin{definition}[set,~carrier,~map,~proper~isomorphism]\guid{MHAPXRC}
  If $\ell$ is a list, let $\op{set}(\ell)$ be the set whose elements
  are the entries of $\ell$.  If $\ell=[x_0;\ldots;x_{k-1}]$ is a list
  and $\phi$ is a function, we define the operator \newterm{map} by
\[
\op{map}(\phi,\ell) = [\phi(x_0);\ldots;\phi(x_{k-1})],
\]
which applies $\phi$ to each entry of the list.  Let $g$ be a set of
lists.  The \newterm{carrier} of $g$ is the set
\[
\bigcup \{ \op{set}(\ell) \mid \ell\in g\}.
\]
Let $g_1$ and $g_2$ be two sets of lists.  We say that they are
\fullterm{properly isomorphic}{isomorphism!proper}, 
if there is a bijection $\phi$ from the
carrier of $g_1$ to the carrier of $g_2$, such that
\[
\{ \lp{\op{map}(\phi,\ell)} \mid \ell \in g_1 \} = 
\{ \lp{\ell} \mid \ell \in g_2 \}.
\]
\end{definition}
\indy{Notation}{set (of a list)}%
\indy{Index}{set (of a list)}%
\indy{Notation}{map@$\op{map}(\phi,\ell)$ (map of a function over a list)}%
\indy{Notation}{zzv@$\phi$ (proper isomorphism between sets of lists)}%

\begin{lemma}\guid{QZHDZVO}\label{lemma:distinct:listing}
  Let $x$ be a dart of a restricted hypermap $H=(D,e,n,f)$.  Then the
  entries of $\ell_H(x)$ are all distinct.
\end{lemma}

\begin{proof}
  If $O(n,f^i x) = O(n,f^j x)$, then by the simplicity of the
  hypermap, we have $f^i x = f^j x$.  By construction, the exponents
  $i$ and $j$ are nonnegative and less than the cardinality of the
  face of $x$.  This forces $i=j$.
\end{proof}

\begin{lemma}\guid{XKABSJX}\label{lemma:list-u}
  Let $x$ and $y$ be darts of a restricted hypermap $H=(D,e,n,f)$.  If
  $x\ne y$, then $\ell_H(x)\ne \ell_H(y)$.  In fact, the first two
  entries of the listings are sufficient to distinguish darts.
\end{lemma}

\begin{proof}
  If the first two entries of $\ell_H(x)$ equal the first two entries
  of $\ell_H(y)$, then $O(n,x)=O(n,y)$ and $O(n,fx) = O(n,fy)$.  The
  edges $\{x,n f x\}$ and $\{y, n f y\}$ of the hypermap run between
  the same nodes.  By the no double joins condition of restricted
  hypermaps (Definition~\ref{def:ndj}), the two edges are equal:
\[
\{x,n f x\} = \{y, n f y\}.
\]
The two nodes $O(n,x)$ and $O(n,f x)$ are distinct by Lemma~\ref{lemma:distinct:listing}.  This forces $x=y$.
\end{proof}

\begin{lemma}\guid{RFLGXTI}\label{lemma:f-equi}
  Let $x$ be a dart of a restricted hypermap $H=(D,e,n,f)$.  If
  $\ell_H(x) = [x_0;\ldots,x_{k-1}]$, then $\ell_H(f x) =
  [x_1;\ldots;x_{k-1};x_0]$.  In particular,
  $\lp{\ell_H(x)}=\lp{\ell_H(f x)}$.  As $y$ runs over the face of
  $x$, $\ell_H(y)$ runs over the set of representatives of the cyclic
  list $\lp{\ell_H(x)}$.
\end{lemma}

\begin{proof} This is an elementary verification.
\end{proof}

If we write $\rho$ for the rotation operator on lists:
\[
\rho  [x_0;\ldots,x_{k-1}]= [x_1;\ldots;x_{k-1};x_0],
\]
then the first statement of the lemma takes the form
\[
 \ell_H(f x) = \rho\, \ell_H(x).
\]
\indy{Notation}{zzr@$\rho$ (rotation of lists)}%

\begin{lemma}\guid{PSZUDYT}\label{lemma:pr-iso} 
  Let $H_1$ and $H_2$ be restricted hypermaps that have properly
  isomorphic listings.  Then $H_1$ and $H_2$ are isomorphic hypermaps.
\end{lemma}

\begin{proof} 
  Write $H_1 =(D_1,e_1,n_1,f_1)$ and $H_2=(D_2,e_2,n_2,f_2)$.  Set
  $\ell_i = \ell_{H_i}$.  Let $\phi$ be the  bijection $\phi$
  from the set of nodes of $H_1$ to the set of nodes of $H_2$ that
  realizes the proper isomorphism between listings.  By the definition
  of proper isomorphism, for every $x\in D_1$, there exists $y\in D_2$
  such that
\[
\lp{\op{map}(\phi,\ell_{1}(x))} = \lp{\ell_{2}(y)}.
\]
By Lemma~\ref{lemma:f-equi}, there is a dart $z$ in the face of $y$ such that
\[
\op{map}(\phi,\ell_{1}(x)) = \ell_{2}(z).
\]
By Lemma~\ref{lemma:list-u}, $z$ is uniquely determined by this
condition.  Define $\psi:D_1\to D_2$ by $\psi x = z$.  By
Lemma~\ref{lemma:list-u} again, from $\phi$ being one-to-one, we find
that $\psi$ is one-to-one.

Next we check the equivariance of $\psi$ with respect to face permutations:
\begin{align*}
\ell_{2}(\psi f_1 x) &= \op{map}(\phi,\ell_{1}(f_1 x)) \\
   &= \rho\, \op{map}(\phi,\ell_{1} (x)) \\
   &= \rho\, \ell_{2}(\psi x)\\
   &= \ell_2(\,f_2 \psi x).
\end{align*}
By Lemma~\ref{lemma:list-u}, it follows that $\psi f_1 x = f_2 \psi x$.

Next we check the equivariance of $\psi$ with respect to edge
permutations.  Recall that in a restricted hypermap, we have
$e^2=I_D$.  This implies
\[
O(n,e x) =  O(n,f x),\quad
O(n,f e x) = O(n,x),
\]
so that $\ell_H(e x) = [O(n,f x);O(n,x);\ldots]$.  We compute
\begin{align*}
\ell_2(\psi e_1 x) &= \op{map}(\phi,\ell_1(e_1 x)) \\
  &= [\phi(O(n_1,f_1 x));\phi(O(n_1,x));\ldots]\\
  &= [O(n_2,\psi f_1 x);O(n_2,\psi x);\ldots]\\
  &= [O(n_2,f_2\psi x);O(n_2,\psi x);\ldots]\\
   &=\ell_2(e_2 \psi x).
\end{align*}
It follows that $\psi e_1 x = e_2 \psi x$.

By the hypermap triality relation $e n f = I_D$, the equivariance of
$\psi$ with respect to $f$ and $e$ give the equivariance with respect
to $n$ as well.

The map $\psi$ is one-to-one between finite sets $D_1$ and $D_2$.
Proper isomorphism is a symmetric relation.  This means that there
exists a one-to-one mapping from $D_2$ to $D_1$.  Thus, $D_1$ and
$D_2$ have the same cardinality, and $\psi$ is a bijection.  This
proves that $\psi$ is an isomorphism from $H_1$ to $H_2$.
\end{proof}

\bigskip

We give a description of a hypermap generating algorithm in very
broad terms.  In the algorithm, the primary data structure is a
\newterm{graph record}, which has the general form of a tuple
$(r,\ldots)$, where $r$ is a list of ordered pairs $(a,b)$, where
$a$ itself is a list of integers and $b$ takes values $\op{true}$ or
$\op{false}$.


The algorithm depends on a parameter $p$, which gives the size of the
largest face of the graphs generated by the algorithm.  The algorithm
starts with a particular graph record, called the $p$th seed:
\begin{alignat*}{4}
\op{seed}_p =
&(
[   \\
 &~~([0;1;2;\ldots;p-1],&&~\op{true}); \\
 &~~([p-1;\ldots;2;1;0],&&~\op{false}) \\
 &~],\ldots).
\end{alignat*}
Every step of the algorithm has input a graph record, and output a
finite set of graph records.  We use the notation $g_1
\dashrightarrow_p g_2$ for the relation asserting that $g_2$ is among
the graph records output, when the input is $g_1$.  We write
$\dashrightarrow_p^*$ for the reflexive transitive closure of the
relation $\dashrightarrow_p$.  That is, $\dashrightarrow_p^*$ is the
smallest set of ordered pairs that contains $\dashrightarrow_p$ and
that is both reflexive and transitive.
\indy{Notation}{g@$g$ (graph record)}

A graph record $([(a_0,b_0);\ldots],\ldots)$ is \newterm{final}, if all of
the terms $b_i$ are $\op{true}$.  
The algorithm consists of iterating $\dashrightarrow_p$ on  $\op{seed}_p$,
to obtain all graph records $g$ such that
\begin{enumerate}
\item $\op{seed}_p \dashrightarrow_p^* g$, and
\item $g$ is final.
\end{enumerate}
We call  graph records that satisfy these two properties
\newterm{algorithmically planar} (with parameter $p$).
\indy{Notation}{seed@$\op{seed}_p$}%
\indy{Index}{planar!algorithmic}%
\indy{Notation}{9@$\dashrightarrow_p$ (input-output hypermap-generating relation)}%

We now show in broad terms how to relate this algorithm to the
classification of restricted hypermaps.

\begin{definition}[record]\guid{AAIVWQU}
  Let $(H,{\cal L})$ be a pair consisting of a restricted hypermap $H$
  and a normal family ${\cal L}$ of $H$.  We say that a graph record
\[
([(a_0,b_0);\ldots;(a_{k-1},b_{k-1})],\ldots)
\]
is a \newterm{record} of $(H,{\cal L})$ provided that there is an
proper isomorphism $\phi$ between the listing of $H/{\cal L}$ and the
set
\[
\{a_0,\ldots,a_{k-1}\}
\]
such that for all darts $x$ in the hypermap $H/{\cal L}$ and all
indices $i$, if
\[
\lp{\op{map}(\phi,\ell_{H/{\cal L}}(x))} = \lp{a_i},
\]
then the canonical flag on the face of $x$ takes value $b_i$.
\end{definition}


\begin{theorem}\guid{CHAKYSS}\label{lemma:bn}
  Let $H$ be a restricted hypermap.  Let $p$ be the cardinality of the
  largest face of $H$. Let ${\cal L}$ be the maximal normal family of
  Example~\ref{ex:Hall}.  Then there exists an algorithmically plane
  graph record (with parameter $p$) that records $(H,{\cal L})$.
\end{theorem}

The rest of this chapter sketches a proof of this theorem.
The theorem shows that the hypermap generating algorithm captures all
restricted planar hypermaps up to isomorphism.  Specifically, a
restricted hypermap $H$ is isomorphic to its subquotient by the maximal
normal family ${\cal L}$.  If two hypermaps $H_1$ and $H_2$ have
properly isomorphic records with respect to their maximal normal
families, then they are isomorphic, by Lemma~\ref{lemma:pr-iso}.


There is a more refined version of this theorem that produces records for each
step of the algorithm.  The following lemma treats the initialization step.

\begin{lemma}\guid{VHTHIOG}\label{lemma:algo-init}
  Let $H$ be a restricted hypermap.  Let $p$ be the cardinality of the
  largest face of $H$.  Let $F$ be any face with $p$ darts.  Let
  ${\cal L}$ be the minimal normal family of Example~\ref{ex:H2}
  associated with $F$.  Then $\op{seed}_p$ records $(H,{\cal L})$.
\end{lemma}

\begin{proof}
  This follows from the explicit description of $\op{seed}_p$ and
  Examples~\ref{ex:D2k} and \ref{ex:DH}, which identify $H/{\cal L}$
  with the dihedral hypermap.
\end{proof}


\begin{lemma}\guid{DMFMDYP}\label{lemma:algo-step}  
  Let $H$ be a restricted hypermap.  Let $p$ be the cardinality of the
  largest face of $H$.  Suppose that ${\cal L}$ is a normal family of
  $H$ that is not maximal, and such that $H/{\cal L}$ is a simple
  hypermap on which the node map acts without fixed points.  Suppose
  that the canonical function is a flag on $H/{\cal L}$.  Suppose that
  $g_1$ is a graph record that records $(H,{\cal L})$.
  Then there exists a normal family ${\cal M}$ of $H$ and a graph
  record $g_2$ with the following properties.
\begin{enumerate}
\item $H/{\cal M}$ is simple.
\item The node map acts without fixed points on $H/{\cal M}$.
\item The canonical function on $H/{\cal M}$ is a flag.
\item The set of darts visited by ${\cal M}$ has larger cardinality than the set of
darts visited by ${\cal L}$.
\item $g_2$ records $(H,{\cal M})$.
\item $g_1 \dashrightarrow_p g_2$.
\end{enumerate}
\end{lemma}

\begin{remark}
  A given graph record may record many different pairs $(H,{\cal L})$.
  In general, the relation $\dashrightarrow_p$ is multi-valued.
  Because of multiplicities of choices, the lemma only asserts the
  existence of ${\cal M}$ and $g_2$, but makes no uniqueness claims.
\end{remark}

\begin{proof}[Proof sketch]
We give a few more details about the input-output relation
$\dashrightarrow_p$ on a graph record 
\[
g_1 = ([(a_0,b_0);\ldots],\ldots).
\]
The assumption that ${\cal L}$ is not maximal, implies that some term
$b_i$ is false.  The algorithm selects some list $a_i$ such that $b_i$
is false.  The claim of the lemma is independent of how this choice is
made, and we disregard the details of the choice.  The algorithm also
selects an entry $c_j$ of the list $a_i$.  Because $g_1$ records
$(H,{\cal L})$, there is a contour loop $L$ in ${\cal L}$ that is
canonically false that corresponds to $a_i$.  Similarly, there is a
node of $H/{\cal L}$ that corresponds to the entry $c_j$.  Under the
injection from nodes of $H/{\cal L}$ to nodes of $H$
(Lemma~\ref{lemma:subquotient-node}), we obtain a node of $H$ visited
by $L$.  Because the subquotient $H/{\cal L}$ is simple, the set of
darts visited by $L$ at the node has the form $\{n^{-k}
x,\ldots,n^{-1}x,x\}$ for some uniquely determined dart $x$ of $H$.

The rules about how to choose $c_i$ are such that the resulting dart
$x$ has the property $S(H,L,x)=\emptyset$, and the loop of ${\cal L}$
visiting $n f x$ is true.  This means that $(H,{\cal L},L,x)$ is a
marked hypermap (Definition~\ref{def:marked}) with canonically false
$L$.

By Lemma~\ref{lemma:flag}, the transform $(H,{\cal M}_1,L_1,x)$ of
$(H,{\cal L},L,x)$ is marked.  We repeatedly take the
tranform
\[
T^i(H,{\cal L},L,x) = (H,{\cal M}_i,L_i,x),
\]
until $L_i$ is canonically true.  Set ${\cal M}={\cal M}_i$.

We claim that there exists $g_2$ such that $g_1 \dashrightarrow_p
g_2$, and such that $g_2$ records $(H,{\cal M})$.  In fact, without
elaborating on details, this is not surprising, because it has been
arranged to be true by construction: the algorithm is just the
implementation at the level of lists of integers the iterated
transform of marked hypermaps.  Specifically, it implements the
transform (Definition~\ref{def:transform}) in lists.  But there is one important
distinction.  The iterated transform starts with a specific marked
hypermap $H$ and results in a single normal family ${\cal M}$.
However, $\dashrightarrow_p$ works without prior assumptions about the
eventual end hypermap $H$, and generates all possible iterated
transforms, subject to Lemma~\ref{lemma:parameters}.  
For this reason, in general, $g_2$ will be just one of
many graph records $g$ such that $g_1\dashrightarrow_p g$.  Nevertheless,
the claim of the lemma holds for this particular $g_2$.
\end{proof}


\begin{remark}
  According to the pencil-pen heuristic, this section describes in
  rigorous terms the process of retracing a pencil drawing in pen.
  One transform of a marked hypermap corresponds to retracing a single pencil
  arc in pen.  The iterated transform corresponds to retracing in pen an
  entire face.  The step $\dashrightarrow_p$ corresponds to working
  without the pencil tracings, and drawing in pen a single face of
  cardinality at most $p$, along a given edge in all possible ways.
  The relation $\dashrightarrow_p^*$ corresponds to drawing all
  possible sequences of faces.  Theorem~\ref{lemma:bn} asserts that
  all restricted hypermaps admit a sequential construction in this
  fashion.
\end{remark}


Finally, we  turn to the proof of Theorem~\ref{lemma:bn}.

\begin{proof}
Let $H$ be a restricted hypermap.  
Let $p$ be the cardinality of the largest face of $H$.
Let ${\cal L}_0$ be the minimal normal family of $H$.
By Lemma~\ref{lemma:algo-init}, $g_0=\op{seed}_p$ records $(H,{\cal L}_0)$.
Assume inductively, that $g_i$ records $(H,{\cal L}_i)$ and that $H/{\cal L}_i$
has simple subquotient.  If $i>0$, we assume inductively
that $g_{i-1}\dashrightarrow_p g_i$.  If ${\cal L}_i$ contains a canonically false
loop, then  Lemma~\ref{lemma:algo-step} constructs $g_{i+1}$ and ${\cal L}_{i+1}$.
The process terminates when every face of ${\cal L}_i$ is canonically true.
The process must terminate, because the number of darts visited by ${\cal L}_i$
is increasing in $i$, and is 
 bounded from above by the cardinality of the dart set of $H$.
When every loop ${\cal L}_i$ is canonically true, then ${\cal L}_i$ is the maximal
normal family, $g_i$ is final, and
\[
g_0 \dashrightarrow_p g_1 \dashrightarrow\cdots \dashrightarrow_p g_i,
\quad \text{ or }\quad  g_0 \dashrightarrow_p^* g_i.
\]
That is, $g_i$ is an algorithmically plane graph record with parameter $p$.
It records $(H,{\cal L}_i)$, where ${\cal L}_i$ is the maximal normal family.
\end{proof}