%% HYPERMAPS



\section{Basic Concepts}



\begin{definition}  A hypermap is a finite set $D$, together with
three functions $e,n,f:D\to D$ that satisfy
    $$e\circ n\circ f = I.$$
The elements of $D$ are called {\it darts}.  The functions $e,n,f$
are called the {\it edge map}, the {\it node map}, and the {\it
face map}, respectively.
\end{definition}


\begin{figure}[htb]
  \centering
  \myincludegraphics{\ps/dart.eps}
  \caption{This symbol represents a dart.}
  \label{fig:dart}
\end{figure}

\begin{remark}\label{rem:hypermap} A hypermap is an abstraction of
the concept of 
planar graph.  Place a dart at each angle of a planar graph $G$.
One function, $f$, 
cycles counterclockwise around the angles of each face.  
Another function, $n$, 
rotates counterclockwise around the angles at each
node.  A third function, $e$, pairs angles at opposite ends of
each edge  (Figure~\ref{fig:hypermap_ex}).   The hypermap extracts
the data $(D,e,n,f)$ from the planar graph and discards the rest.
\end{remark}

\begin{figure}[htb]
  \centering
  \myincludegraphics{\ps/hypermap_ex.eps}
  \caption{Darts mark the angles of a planar graph.  We may
  permute darts about faces, nodes, and edges.}
  \label{fig:hypermap_ex}
\end{figure}

A hypermap satisfies 
  \begin{equation}\label{eqn:triality}
  n\circ f\circ e = f\circ e\circ n = I.
  \end{equation}
Inverted, this triality becomes
   $$
   n^{-1} \circ e^{-1} \circ f^{-1} = f \circ e \circ n = I.
   $$
This inversion
is the abstract form of the
the duality between nodes and faces in a planar graph.  
Because of
these symmetries in the defining relation, 
there will be multiple versions of 
theorems about hypermaps,
all obtained from one proof by symmetry.

Each function $e,n,f$ is a permutation of $D$.  
We write $\#h$ for the
number of orbits of a permutation $h$ on $D$, and $\#\tangle{e,n,f}$
for the number of orbits of the combined action of functions $e,n,f$
on $D$.  A hypermap is said to be connected if 
  $\#\tangle{e,n,f} = 1$.

\begin{definition}  A node is an orbit  under
$n$.  A face is an  orbit  under $f$.  An edge
is an orbit under $e$.
\end{definition}

\begin{definition} A hypermap is {\it plain} (note the spelling!) if
$e$ is an involution on $D$ (that is, $e\circ e = I$).  A hypermap
is {\it planar} (note the spelling!) if the Euler relation holds:
    $$\# n + \# e + \# f = \# D + 2 \#\tangle{e,n,f}.$$
\end{definition}

\begin{definition} A dart is degenerate if it is a
fixed point of one of the maps $e,n,f$; otherwise it's nondegenerate.  
%%It is nondegenerate otherwise.
\index{degenerate}\index{nondegenerate}
\end{definition}

\begin{definition} 
A hypermap is {\it simple} if the intersection of a face with
a node never contains more than one dart.
\index{simple}
\end{definition}


% Moved from cup05_tame.tex section on tame plane graphs. 9/5/07:
\begin{lemma}\label{lemma:nondegen} 
Let $(D,e,n,f)$ be a simple plane hypermap such that every face has
at least three darts.
Then $n$ has no fixed point.
\end{lemma}

\begin{proof}  For a contradiction, let $x$ be a fixed point of
$n$. We show that $e x$ and $f x$ lie in the same node and
face, so are equal in the simple hypermap.  
They lie in the same node because
$n(f x) = e^{-1} x = e x$. They lie in the same face because
    $$f^2 (e x) =  f(n^{-1} x) = f x.$$
So $e x = f x$.   Thus, $f^2 (e x) = f x = e x$, and $e x$ lies on a
face with at most two darts.  This contradicts what is given.
\end{proof}

\begin{remark}  The Euler relation for hypermaps harks back
to the Euler relation for planar graphs.
Let $G$ be a connected planar graph that satisfies the
Euler relation
    $$V - E + F = 2$$
where $V$ is the number of vertices, $E$ the number of edges, and
$F$ the number of faces of $G$ (including an unbounded face). The
hypermap $(D,e,n,f)$, made from $G$ in
Remark~\ref{rem:hypermap}, is plain.
Moreover,
    $$\begin{array}{lll}
    V &= \# n\\
    E &= \# e\\
    F &= \# f\\
    2E &= \# D\\
    1 &= \#\tangle{e,n,f}\\
    \# n + \#e + \# f &= 
    V + E + F = 2 E + 2 = \# D + 2 \#\tangle{e,n,f}.
    \end{array}
    $$
Thus, the hypermap is also planar. 
\end{remark}


%% WW Used??
%\begin{lemma}  Let $H$ be a connected plain planar hypermap.
%Let $f_i$ be the number of faces with $i$ darts.  Then
%    $$2 \# n - 2 =  f_3 + 2 f_4 + 3 f_5 +\cdots$$
%\end{lemma}
%
%\begin{proof}  We have
%    $$
%    \begin{array}{lll}
%     \# D &= 2 \# e = 3 f_3 + 4 f_4 + \cdots\\
%    \# f &= f_3 + f_4 + \cdots.
%    \end{array}
%    $$
%Use these equations to eliminate $\#e$, $\#f$, $\#D$ from the Euler
%relation.  The result follows.
%\end{proof}
%


\subsection{walkups}

When we focus on a dart $x$ in a
hypermap, it can be useful to draw a hexagon around $x$ and place
the six darts $e x$,
$n x$, $f x$, $e^{-1} x$, $n^{-1} x$, $f^{-1} x$ at its corners
in Figure~\ref{fig:dart+}.  Some of these $7$ darts may be
equal to one another, even if the figure draws them apart.
Figure~\ref{fig:dart-fix} shows the layout of the darts, when 
a map $e$, $n$, or $f$ fixes $x$.

\begin{figure}[htb]
  \centering
  \myincludegraphics{noimage.eps}
  \caption{A dart $x$ and its entourage}
  \label{fig:dart+}
\end{figure}

\begin{figure}[htb]
  \centering
  \myincludegraphics{noimage.eps}
  \caption{A dart fixed under a face map.}
  \label{fig:dart-fix}
\end{figure}


A {\it walkup} deletes
a dart from a hypermap and remolds the edge, node, and face
maps to produce a hypermap on the reduced set of darts.  Walkups
come in three flavors: edge walkups, face walkups,
and node walkups.

\begin{definition}
Let $x$ be a dart in a hypermap.  The edge walkup 
$W_e$ at $x$ of the hypermap is the hypermap
$(D',e',n',f')$, where $D' = D\setminus\{x\}$ and the
the maps skip over $x$:
    $$
    \begin{array}{lll}
    f' y &= \text{ if } (y = f^{-1} x) \text{ then } f x \text{ else
    } f y\\
    n' y &= \text{ if } (y = n^{-1} x) \text{ then } n x \text{ else
    } n y\\
    e' = (n'\circ f')^{-1}
    \end{array}
    $$
\index{walkup}
\index{edge walkup}
\end{definition}

Figure~\ref{fig:walk} shows
the result of an edge walkup on the hexagon around a dart $x$.
The Triality symmetry~\ref{eqn:triality}, applied to the definition
of edge walkups, yields the definition of
face walkup $W_f$ and node walkup $W_n$.  
Figure~\ref{fig:walkfn} shows the result of the face and node
walkups on the hexagon around a dart $x$.

A walkup at $x$ is said to be degenerate 
if the dart $x$ is degenerate.   
At a degenerate dart $x$, all three walkups
are equal: $W=W_e=W_n=W_f$ (Figure~\ref{fig:walkdeg}).

\begin{figure}[htb]
  \centering
  \myincludegraphics{noimage.eps}
  \caption{The effect of an edge walkup at $x$}
  \label{fig:walk}
\end{figure}

\begin{figure}[htb]
  \centering
  \myincludegraphics{noimage.eps}
  \caption{The effect of face and node walkups at $x$}
  \label{fig:walkfn}
\end{figure}

\begin{figure}[htb]
  \centering
  \myincludegraphics{noimage.eps}
  \caption{The effect of a walkup at a degenerate dart}
  \label{fig:walkdeg}
\end{figure}


\begin{definition}\label{def:merge-split} Let $h=n,e$, or $f$.
A walkup $W_h$ at $x$ is said to merge,
if the walkup joins the orbit of $h$ through $x$ with another orbit.  
It is said to split, if the walkup splits the
orbit at $x$ into two orbits.
\index{split}
\index{merge}
\end{definition}

\begin{lemma}\label{lemma:merge-split} 
Every nondegenerate walkup merges or splits.
The walkup $W_h$ at $x$ merges if and only if $x$ and $y$  lie
in distinct $h$-orbits, where $(h,y)=(f,e x)$.  
(The lemma also holds for $(h,y)=(e,n x)$ and other cases generated
by triality.)
\end{lemma}

\begin{proof} The walkup $W_f$ splits if and only if $f x$ 
(or $x$)
and $e x$ lie in the same $f$-orbit before the split. 
Figure~\ref{fig:split} makes this clear.
\end{proof}


\begin{figure}[htb]
  \centering
  \myincludegraphics{noimage.eps}
  \caption{The face walkup at $x$ mixes $f$-orbits.  If it mixes
  two separate 
  orbits, the orbits merge.  If it mixes a single orbit, 
  the orbit splits.}
  \label{fig:split}
\end{figure}


\subsection{walkups and planarity}

\begin{definition} Define the planar index of a hypermap to be
$$\# f + \# e + \# n - \# D - 2\# \tangle{e,n,f}.$$
(A hypermap with null index is planar.)
\index{index}
\index{planar index}
\end{definition}

\begin{lemma}\label{lemma:index} Let $x$ be a dart of a hypermap $(D,e,n,f)$. Let $(D',e',n',f')$ be the result of the edge walkup $W_e$ at
a nondegenerate dart $x$.  
The walkup changes the sizes of some orbits.
    $$
    \begin{array}{lll}
    %\text{\bf Non-degenerate dart $x$: }&\\
    \# f &= \# f'\\  
    \# e + \delta' &= \# e'\\
    \# n &= \# n'\\
    \# D - 1&= \# D' \\
    \# \tangle{e,n,f} + \delta&= \#\tangle{e',n',f'},\\
    \end{array}
    $$
where
   $$
   \delta' = \begin{cases}
     1 & W_e \text{ splits }\\
    -1 & W_e \text{ merges}\\
   \end{cases}
   $$
and
   $$
   \delta = \begin{cases}
    0 & W_e \text{ merges }\\
    0 & W_e \text{ splits and } x,nx \text{ belong to the same } \tangle{e,n,f}\text{-orbit}\\
    1 & otherwise.
     \end{cases}
   $$
Moreover, a walkup at a degenerate dart preserves the planar index.
\end{lemma}

\begin{proof} The figures make this clear.
\end{proof}

\begin{lemma}  Let $\iota$ be the index of a  hypermap $(D,e,n,f)$, and
let $\iota'$ be the index of the hypermap obtained by a walkup
$W_h$
at a dart $x$.  We have $\iota = \iota' + 2$ when
$x$ is nondegenerate, $W_h$ splits, but the walkup does not
split the orbit of $\tangle{e,n,f}$ through $x$ into two orbits.
Otherwise, $\iota'=\iota$.
\end{lemma} 


%If $x$ is degenerate, then $\iota=\iota'$.
%If $W_h$ merges, then $\iota=\iota'$.
%If $x$ is non-degenerate and and the walkup
%splits, the planar index is preserved iff the walkup splits the orbit of
%$\tangle{e,n,f}$ through $x$ into two orbits. When the walkup
%does not preserve the planar index, $\iota+2=\iota'$.


\begin{proof}  By triality symmetry, 
we can assume the walkup is an edge walkup.  
Note that
if the $\tangle{e,n,f}$-orbit splits then
the $e$-orbit also splits.
From Lemma~\ref{lemma:index},
which lists index data, the
relation between $\iota$ and $\iota'$ is easily calculated.
\end{proof}


\begin{lemma}  The planar index
of a hypermap is never positive.
\end{lemma}

\begin{proof}  An edge walkup never decreases the index.  By a sequence
of edge walkups we reach the empty hypermap, which has
index zero.
\end{proof}


\begin{lemma} Walkups take planar hypermaps to planar
hypermaps.
\end{lemma}

\begin{proof}  
A planar hypermap has maximum index.  The walkup
can only increase the index, but never beyond its maximum.  
Thus, the index remains at its maximum value.
\end{proof}


\subsection{double walkups}

A double walkup is the composite of two walkups
of the same type.  The
two darts for the two walkups 
are to be the members of an orbit of size
two (under $n$, $e$, or $f$).  The first walkup is to be
chosen so that it merges.  The second walkup is
to be degenerate.
By choosing the type of the walkups to be different from the type of
the orbit, the first walkup reduces the orbit to a singleton,
forcing the second walkup to be degenerate. 
 
Here are some examples.
\begin{itemize}
    \item A double $W_n$ along an edge deletes the edge and 
   merges the two endpoints into
    a single node (Figure~\ref{fig:doublenode}). 
    \item A double $W_f$ along an edge 
    deletes the edge and merges the two faces along the edge into
    one (Figure~\ref{fig:doubleface}).
    \item A double $W_e$ at a node of degree two
    deletes the node and merges the two edges at the node into
    one (Figure~\ref{fig:doubleedge}).
\end{itemize}


\begin{figure}[htb]
  \centering
  \myincludegraphics{noimage.eps}
  \caption{The double node walkup applied to an edge}
  \label{fig:doublenode}
\end{figure}


\begin{figure}[htb]
  \centering
  \myincludegraphics{noimage.eps}
  \caption{The double face walkup applied to an edge}
  \label{fig:doubleface}
\end{figure}


\begin{figure}[htb]
  \centering
  \myincludegraphics{noimage.eps}
  \caption{The double edge walkup applied to a node}
  \label{fig:doubleedge}
\end{figure}


\begin{lemma}  The three preceding double walkups carry plain
hypermaps into plain hypermaps.
\end{lemma}

\begin{proof} The walkups $W_n$ and $W_f$ preserve the orbit
structure of edges, except for dropping one dart.  By dropping both
darts from the same edge, one edge is lost and all others edges
remain unchanged.

For the double $W_e$, we refer to Figure~\ref{fig:doubleedge}.  
If the
original hypermap is plain, then the two darts marked 
$x$ are equal, as are
the two darts marked $y$.  
The new edge map swaps $x$ and $y$, but is 
otherwise equal to $e$ on 
the reduced set of darts $D''$.  
Swapping two darts has order two, 
as we plainly see.
\end{proof}

The following is a useful way to tell if a walkup merges.


\begin{lemma}  Suppose, in a simple hypermap, 
that an edge $\{x,y\}$ consists of two nondegenerate darts.  
Then the walkup
 $W_f$ (resp. $W_n$) at $x$  merges.
\end{lemma}

\begin{proof} 
We have $n (f x) = e^{-1} x = e x$. So $f x$ and $e x$ are at the
same node. If they are also in the same face of a simple hypermap, 
this gives $f x = e x
= y$. So $$n y  = n f x = n f e y = y,$$ and $y$ is a fixed
point of $n$, hence degenerate, contrary to assumption.  
Thus, $f x$
and $e x$ are in different faces, and the walkup merges
by Lemma~\ref{lemma:merge-split}.  
\end{proof}




\subsection{contours}

\begin{definition}  A contour path is a function $p:\{0,\ldots,k\}\to D$
such that $p_{i+1} =
n^{-1} p_i$ or $f p_i$ for each $i<k$.  (That is, each
step in the path is clockwise step around a node or a
counterclockwise step around a face.)   If the contour path
is injective on $\{0,\ldots,k-1\}$
and  $p_0 = p_k$, then it is a contour loop.
\index{contour path}\index{path}
\index{contour loop}\index{loop}
\end{definition}

\begin{lemma}\label{lemma:connect-contour}  If $x$ and $y$ are darts
in the same $\tangle{e,n,f}$-orbit of a hypermap, then there exists
a contour path from $x$ to $y$.
\end{lemma}

\begin{proof} 
By being in the same orbit, the darts
$x$ and $y$ are joined by a path, where each step
is $z\mapsto h z$, for $h=e,n$, or $f$.  Eliminate $e$-steps
through the relation $e\circ
n\circ f = I$.   Replace each $n$-step with a sequence of
$n^{-1}$-steps.  This gives the desired path.
\end{proof}

\begin{definition} A M\"obius contour is an
injective contour path $p$ that satisfies
    \begin{equation}
    \label{eqn:mobius}
    p_j = n p_0\quad p_k = n p_i
    \end{equation}
for some $0 < i\le j< k$ (Figure~\ref{fig:mobius}).
\end{definition}

\begin{figure}[htb]
  \centering
  \myincludegraphics{noimage.eps}
  \caption{A M\"obius contour}
  \label{fig:mobius}
\end{figure}

\begin{figure}[htb]
  \centering
  \myincludegraphics{noimage.eps}
  \caption{A M\"obius contour with three darts}
  \label{fig:3m}
\end{figure}


\begin{remark}
G. Gonthier devised the notion of M\"obius contour
as a way to prove the Four-Color theorem without appeal
to topology.  (The Appel-Haken
proof of the Four-Color theorem relies on the Jordan
curve theorem.)  A M\"obius contour is a 
combinatorial M\"obius strip that
twists to make 
its left-hand side into
its right-hand side.  A planar hypermap has no such contour.  
Figure~\ref{fig:violate-jct}
redraws a violation of the Jordan curve theorem
as a M\"obius contour.   
\end{remark}

\begin{figure}[htb]
  \centering
  \myincludegraphics{noimage.eps}
  \caption{A path that tunnels from the interior to the exterior
   of a simple closed curve
   is analogous to a M\"obius contour.}
  \label{fig:violate-jct}
\end{figure}






\begin{lemma}\label{lemma:no-mobius}  
Planar hypermaps have no M\"obius contours.
\end{lemma}

\begin{proof} For a contradiction, assume that there exist planar
hypermaps with M\"obius contours.  An edge walkup carries
planar hypermaps into planar hypermaps. An edge walkup
at a dart that is not on the M\"obius contour carries the
M\"obius contour to a M\"obius contour 
and reduces the number of darts.  
In the M\"obius Condition~\ref{eqn:mobius},
an edge walkup at a dart that is not at position $0$, $i$, $j$, $k$
along the contour carries the M\"obius contour to a M\"obius contour
and reduces the number of darts. Thus, a counterexample with
the smallest possible number of darts contains no
darts except those on the M\"obius contour, and its only darts
are at positions $0$, $i=j=1$, $k=2$.

This is a three darted hypermap (Figure~\ref{fig:3m}.)  
The M\"obius condition, the
definition of contours, together with $e\circ n\circ f=I$ force
$e=n=f$, all permutations of order three. We reach the contradiction
that this hypermap is not planar:
    $$3 = \# e + \# n + \# f,\quad 5 = 3+2 = \# D + 2 \#\tangle{e,n,f}.$$
\end{proof}

\begin{definition}\label{def:interior} 
a dart $y$ lies in the {\it interior} of a contour
loop $L$ if there is a an injective contour path
$x_0,x_1,\ldots,x_k=y$ such that $x_1 = f x_0$ (if $k>0$), and
such that $x_i$ lies on the loop $L$ if and only if $i=0$.
\end{definition}

%\begin{lemma}  Suppose that a hypermap has no M\"obius contours.
%Let $L$ be a contour loop.  Let $P$ be any injective contour path
%that starts and ends on $L$, but visits no other darts of $L$ in
%between.  Then the first and last steps of $P$ are both of the same
%type $n^{-1}$ or $f$.
%\end{lemma}
%
%\begin{proof}  Suppose $P$ is $n x,f n x,\ldots,n y,y$.   Form
%contour path starting at $x$, then $n^{-1}$ steps to $L$, then
%follow $L$ to $y$, and on to $n x$.  Follow $P$ back to $n y$.  This
%is a M\"obius contour.
%
%Suppose $P$ is $n x,x,\ldots,f^{-1} y,y$.  Form a contour path
%starting at $x$, then along $P$ to $y$, along $L$ to $n x$, and
%continuing on $L$ to $n y$.  This is a M\"obius contour.
%\end{proof}
%
%\begin{definition}  Let $L$ be a contour loop on a hypermap.  We say that a dart
%lies in the interior (resp. exterior) of the loop $L$, if there is a
%path $P$ as in the previous lemma starting and ending with $f$ steps
%(resp. $n^{-1}$ steps).
%\end{definition}
%
%\begin{lemma}  Let $L$ be a contour loop on a plain hypermap without
%M\"obius contours.  Assume a dart $x$ lies in the interior (resp.
%exterior) of the loop $L$. Then every dart in its $f$-orbit lies in
%the interior (resp. exterior) of the loop.  Moreover, if the dart
%$x$ does not lie on the same node as any dart in $L$, then every
%dart in the $n$-orbit of $x$ lies in the interior (resp. exterior)
%of $L$.
%\end{lemma}
%
%\begin{proof} First consider the $f$-orbit.
%For a contradiction, we may assume that $x$ is in the interior but
%not $f^{-1} x$.  If we have a contour path $P = \ldots,n  x,
%x,\ldots$, we can modify it by stepping around the node of $f^{-1}
%x$:
%  $$P' = \ldots,n  x,f n  x = n^{-1}f^{-1} x,n^{-2}
%f^{-1} x,\ldots,f^{-1} x,f x,\ldots.
%    $$
%This works when the new darts added to the path are not already on
%$P$ and not on $L$.  If one of the new darts is on $L$, a subpath of
%$P'$ starts and ends on $L$ in different types of steps, which is
%prohibited by Lemma X.  If a new dart is on $P$, we just eliminate
%a segment of $P'$ if the new dart appears on the initial segment of
%$P$.  If it appears on the final segment of $P$, there is a M\"obius
%loop on $P$, which is contrary to hypothesis.  [X finish.]
%
%
%For the $n$-orbit, assume that $x$ but not $n^{-1} x$ is in the path
%$P$.  We take a path $P = \ldots,x,f x,\ldots$ and modify it by
%stepping around the face of $n^{-1} x$
%    $$
%    P' = \ldots,x,n^{-1}x,f n^{-1}x,f^2 n^{-1}x\ldots,f^{-1} n^{-1}
%    x = n f x, f x,\ldots
%    $$
%[Can you get everything by symmetry? X] [X finish]
%\end{proof}
%
%\begin{definition}  A face or a node is interior (resp. exterior) to a
%loop in a hypermap if all of its darts are interior (resp.
%exterior).
%\end{definition}
%
%\begin{lemma} Suppose that in a nonempty hypermap without M\"obius contours,
%there is a face that coincides with an $\tangle{e,n,f}$-orbit of
%darts.  Then that face contains a dart that is fixed under $n$.
%\end{lemma}
%
%\begin{proof}  If the face contains a single dart, then it is
%obviously fixed by $n$.  Assume that the face contains at least two
%darts.  For a contradiction, assume that none of the darts is fixed
%by $n$.  Thus, every node contains at least two darts.
%
%We will use the face path $z,f z,f^2 z,\ldots$ to construct a
%M\"obius contour. Since the set of darts is finite, the face path
%must eventually revisit a node already encountered.  Thus, we can
%find a subpath $z',f z',\ldots,f^{k+1} z'$ such that the first $k$
%darts lie on distinct nodes, but $f^{k+1} z'$ and $z'$ lie in the
%same node $A$.
%
%If we had $f^{k+1} z' = z'$, then we have the full $f$-orbit in this
%subpath, and hence also the full $\tangle{e,n,f}$-orbit.  We have
%$k>0$, so $f z'$ is then a dart that has no other darts in its node,
%and is hence a fixed-point.  Hence $f^{k+1} z'\ne z'$.
%
%Continue the path further, so that $f^{r+1} z'$ is at the same node
%as some $f^p z'$ (with $p < r$), at a different node than
%$z',\ldots,f^r z'$, but so that the only repeated node among
%$z',\ldots,f^r z'$ is the one at $z'$.  We have $0 < p$.
%
%If $f^{r+1} z' = f^p z'$, then $f^{r+1-p} z' = z'$ so all darts are
%in the segment $z',f z',\ldots,f^{r-p} z'$ and the only node with
%more than one dart is the one at $z'$.  Thus, we have a fixed point.
%So $f^{r+1} z'\ne f^p z'$.
%
%Let $0 < k_1 < k_2 < \cdots < k_m < r+1$ be the indices at which
%$f^{k_i} z'$ is at $A$.  Let $x = n^{-1} f^{k_m} z'$. If the segment
%$x,n^{-1} x,\ldots,z'$ contains some $f^{k_i} z'$, we obtain a
%M\"obius contour.  [X DETAIL.]  Take $n^{-1}$ steps from $x$ to
%$z'$. Then take $f$-steps to $y = f^p z'$, on to $n x = f^{k_m} z'$,
%on to $f^{r+1} z'$, then $n^{-1}$ steps to $n y$.  This is a
%M\"obius contour.
%\end{proof}
%
%\begin{lemma}[Jordan curve theorem for hypermaps]  If a plain hypermap
%has no M\"obius contours then it is planar.
%\end{lemma}
%
%\begin{proof}  Face double walkups along edges preserve the planar
%index.  By repeated application, we reduce to the case where every
%connected component of $\tangle{e,n,f}$ contains a single face. In
%other words, $f$ acts transitively on the darts in a given connected
%component.
%
%If there are any darts that are fixed by all three maps $e,n,f$,
%then the walkup at that dart eliminates the dart while preserving
%the planar index.  Thus, we may assume there are no such darts.
%
%If there are any darts that are fixed points under $n$, then the
%dart is degenerate.  The double walkup (of any type) along the edge
%that meets that dart eliminates the dart while preserving the planar
%index.  Thus, we may assume that there are no such darts.
%
%By the previous lemma, the plane hypermap must be empty.  Thus, our
%planar-index preserving walkups have transformed an
%arbitrary plane hypermap without M\"obius contours into the empty
%hypermap, which is clearly planar.  The result follows.
%\end{proof}
%




\section{Quotient Hypermaps}


\begin{definition} Two hypermaps $(D,e,n,f)$ and $(D',e',n',f')$ are
isomorphic, if there is a bijection $F:D\to D'$ such that
    $$h'\circ F = F\circ h$$
for $(h,h')=(e,e'), (f,f'), (n,n')$.
\end{definition}


\begin{definition}
Let $H$ be a hypermap. Assume that 
there are no darts fixed by $e$ 
(so that we can distinguish $f x$
from $n^{-1} x$ at each dart). 
Let $\cal L$ be a collection of contour
loops.  We say that $\cal L$ is a normal collection if the following
conditions hold of its loops. \begin{itemize}
 \item No dart is visited by two different loops.
 \item Every loop visits at least two nodes.
 \item If a loop visits a node, then every dart at that node is
 visited by some loop.
\end{itemize}
\end{definition}

From a normal collection we can form a new hypermap.   A dart in the
new set $D'$ of darts
$D$ is a maximal sequence $[x,n^{-1} x, n^{-2} x,\ldots,n^{-k} x]$
    of $n^{-1}$ steps appearing in some loop in $\cal L$.
The map $f'$ takes the maximal sequence
    $[x,n^{-1}x,\ldots,y]$ to the maximal
   sequence (in the same contour loop) starting 
    $[f y,\ldots]$.
The map ${n'}^{-1}$ takes the maximal sequence
    $[\ldots,y]$ to the maximal sequence (in some other contour loop)
starting $[n^{-1}y,\ldots]$. Equivalently, 
$n'$ takes the maximal sequence
$[x,\ldots]$ to the maximal sequence ending $[\ldots,n x]$. The map $e$ is
defined by $e'\circ n'\circ f' = I$.  

\begin{definition}  The hypermap constructed from the normal collection
is called the quotient of $H$ by $\cal L$, and is denoted $H/{\cal
L}$.  The hypermap $H$ is said to be a cover of $H/{\cal L}$.
\end{definition}

Intuitively, we can represent the quotient hypermap as a graph whose
cycles under $f$ 
are precisely the contour loops in the normal family (Figure~\ref{fig:quot}).

%% No sketch has been made for this.
\begin{figure}[htb]
  \centering
  \myincludegraphics{noimage.eps}
  \caption{The contour loops in a normal 
   family become faces in the
   quotient}
  \label{fig:quot}
\end{figure}


\begin{example}\label{ex:Hall} 
Assume that $H$ is a hypermap with no fixed points under $e$.
Assume that every face visits at least two nodes.
Then the set of all faces
defines a normal collection of contour loops (follow $f$ around each face:
$x,f x,\ldots$).  Each dart of the quotient is then just a singleton
set consisting of a single dart of $H$, and the quotient is
isomorphic to $H$ itself.
\end{example}

\begin{example}\label{ex:H2} 
Assume that $H$ is a hypermap with no fixed points
under $e$.  Let $F = (x,f x,\ldots)$ be a face 
that visits at least
three nodes and that meets each node in at most one dart.
Let $\cal L$ be the
collection with two contour loops:  $(x,f x,\ldots)$ and its
complement
$$[n^{-1} x,
n^{-2} x,\ldots,n x,f n x = y,n^{-1} y, n^{-2} y,\ldots, n y, f n
y,\ldots]
$$
(See Figure~\ref{fig:contour-comp}.) 
The family $\cal L$ is normal.
The quotient hypermap $H/{\cal L}$ has two faces $F$ and a
backside $F'$ of the same cardinality $k$.
\end{example}


\begin{figure}[htb]
  \centering
  \myincludegraphics{noimage.eps}
  \caption{The complementary contour loop traces the remaining darts
   at the same nodes as the origonal contour loop.}
  \label{fig:contour-comp}
\end{figure}


\begin{example}\label{ex:H2k} 
We 
construct a
hypermap $H_{2k}$, whose darts are arranged in two faces.  Each
face is $Z_n$, a cyclic group of order $n$ with generator $1$.
The face map is $x\mapsto x+1$.
The node map swaps the two faces $Z_n$.
The usual condition $e\circ n\circ f = I$ defines the edge map.
This hypermap is isomorphic to the quotient constructed in
the previous example.
\end{example}

\begin{lemma} Let $H$ be a plain hypermap, and let $\cal L$ be a
normal family.  Then $H/{\cal L}$ is a plain hypermap.
\end{lemma}

\begin{proof} Let $e'$, $f'$, and $n'$ be the edge, face, and node maps on the
quotient hypermap.  Write $[\ldots, x]$ for the node in the quotient
ending in dart $x\in H$ and $[x,\ldots]$ for the node in the quotient
starting with dart $x\in H$.  We have $e^2 x = x$, so that for any
dart $[\ldots x]$ in the quotient:
    $$\begin{array}{lll}
    {e'}^{-2} [\ldots, x] &= n' f' n' f' [\ldots, x] = n' f' n' [f x, \ldots] \\&=
    n' f' [\ldots, n f x] = n' [f n f, \ldots] = [\ldots, n f n f x]\\ &=
    [\ldots, e^{-2} x] = [\ldots, x].
    \end{array}$$
Thus, $e'$ has order $2$ on the quotient.
\end{proof}

%\begin{lemma} Let $H$ be a plain planar hypermap, and let $\cal L$
%be a normal family.  Then $H/{\cal L}$ is a plain planar hypermap.
%\end{lemma}
%
%\begin{proof} Suppose $H/{\cal L}$ is not planar.
%Let $P$ be a M\"obius contour on $H/{\cal L}$.  It lifts uniquely to
%a contour on $H$ with the property that the darts visited on $H$ are
%precisely the darts that belong to a dart in the quotient.  This is
%compatible with the node map $n$.  So the contour path lifts to a
%M\"obius contour on $H$.  Thus, $H$ is not planar.
%\end{proof}


\subsection{flags}

By the end of the chapter, we present an algorithm that
generates all plain planar hypermaps satisfying certain general
conditions.   The algorithm  proceeds by inserting one face
at a time into a hypermap.  
The algorithm  marks certain faces as `true.'
Roughly, this  means that the the face cannot be modified
at any later stage of the algorithm.   When all of its faces
are true, the hypermap stands in final form.
The function that marks each face as true or false is a
{\it flag}.


\begin{definition}  A flag on a hypermap
is a boolean function on its set of faces 
that satisfies the following two
constraints.
\begin{itemize}
    \item If darts $x,y$ belong to true faces,
    then there is a contour path from $x$ to $y$ that remains
    in true faces.
    \item Every edge of a false face is shared with a true face.
    \end{itemize}
%An isomorphism of flagged hypermaps is an isomorphism of
%hypermaps that respects the flags.
\end{definition}

\begin{example} Let $H/{\cal L}$ be a quotient hypermap with
normal family $\cal L$.  The canonical boolean function
$\phi$ on the set of faces of the quotient is the function that
is true exactly when every dart in
the face is a singleton of $H$.
\end{example}

\begin{example} The hypermap $H_{2k}$ of Example~\ref{ex:H2k}, 
carries a flag
that marks one face true and the other false.
\end{example}

\begin{example} Let 
$H$ be a connected plain hypermap and $e$ has no fixed points,
and let $\cal L$ be the example of Example~\ref{ex:Hall}, 
then the canonical
map takes value $\op{true}$ on every face.  This is a flag.
In fact,
Lemma~\ref{lemma:connect-contour} provides the contour paths 
that are required in the definition of flag.
\end{example}

\begin{lemma}\label{lemma:all-dart}  
Let $H$ be a hypermap with normal family ${\cal L}$.
If the canonical boolean function on the set of faces of
$H/{\cal L}$ has at least as many
true values as there are faces of $H$, then $\cal L$ is the normal family
in Example~\ref{ex:Hall}. In particular, $H/{\cal L}$ is isomorphic to $H$.
\end{lemma}

\begin{proof}  If a face takes value $\op{true}$ 
in $H/{\cal L}$, then its darts are
singletons, and the face of $H/{\cal L}$ is naturally identified with
 a face in $H$.  This is an injective map from the 
set of true faces of $H/{\cal L}$ to
the set of faces of $H$.  The hypothesis of the lemma implies that this
injective map is bijective.
All of the darts of $H$ are accounted for under this bijection.
Thus, the quotient has no
false faces.  The result follows.
\end{proof}


\subsection{face insertion}


In this section, we describe an inductive construction of all
connected, plain, planar hypermaps that satisfy certain constraints.
We define a set ${\cal H}$ of tuples $(H,\phi,E,N,\lambda)$.
The tuples are assumed to satisfy the following conditions:
\begin{itemize}
    \item $H$ is a hypermap.
    \item $\phi$ is a flag on $H$.
    \item $E$ is an edge of size two, with one
    dart in a true face and the other in a false face.
    \item $N$ is the size of the false face meeting $E$.
    \item $\lambda$ is a finite increasing sequence of natural numbers:
        $$
        \lambda = (\lambda_1,\lambda_2,\ldots,\lambda_r)
        $$
    such that $\lambda_1 = 1$ and $\lambda_r \le N-1$.
\end{itemize}

We define a function from $\cal H$ to the set of hypermaps with
flags.  We call it face insertion, because the function creates a
hypermap with one more true face than its source hypermap $H$.

We write $x_0$ for the dart of $E$ in the
false face and $y_0$ for the dart of $E$ in the true face.  
Write $f^i
x_0 = x_i$ for the darts in the false face.  (Set $x_N = x_0$.)

\subsection{transforming partitions}

We describe an algorithm $\lambda\mapsto A(\lambda)$ that takes
as input a partition $\lambda$ (and the number $N$)
and produces as output a list of
tuples.
In the first step of the algorithm,
replace each $\lambda_j$ except for the
first occurrence of a given natural number by a dummy symbol $*$.
Insert $N$ at the end of the list. For example, if $N=7$,
    $$(1,1,1,2,3,3,3,5,5)$$ becomes
    $$(1,*,*,2,3,*,*,5,*,7).$$

Next, break the sequence at each natural number (except at the initial $1$
and terminal $N$)
creating shorter sequences, duplicating the number at the break,
so that each sequence begins and ends with a natural number,
and is padded inbetween with dummy symbols. So
    $$(1,*,*,2,3,*,*,5,*,7)$$ becomes
$$(1,*,*,2),\ (2,3),\ (3,*,*,5),\ (5,*,7).$$

Next,
delete any ordered pair of the form $(j,j+1)$. In our example, there
is one such ordered pair: $(2,3)$.  Our example becomes
  $$
  (1,*,*,2),\  (3,*,*,5),\ (5,*,7).
  $$
This list of tuples is the output from the algorithm.
In our example,
  $$A(1,1,1,2,3,3,3,5,5) = ((1,*,*,2),(3,*,*,5),(5,*,7)).$$



\subsection{new hypermaps}

This output $A(\lambda)$
becomes an instruction for how to draw new edges to create a
new hypermap. A tuple $(j,*,*,\ldots,*,k)$ with $r$ dummy symbols
is an instruction to insert an edge between darts $x_j$ and $x_k$
and then to insert $r$ new nodes along this edge.
Expressed in terms of double walkups, we first apply (in
reverse) the double walkup $W_f$, and then apply $r$ times (in
reverse) the double walkup $W_n$.  Each tuple creates $r$ new
nodes, one new face, and $r+1$ new edges.  This action, 
iterated over all the tuples in $A(\lambda)$, creates a new hypermap
$H'$. 
The function that carries
$(H,\phi,E,\lambda)$ to $H'$ is called
face-insertion.  
Figure~\ref{fig:7darts} gives an example.


\begin{figure}[htb]
  \centering
  \myincludegraphics{noimage.eps}
  \caption{Face-insertion on a $7$-gon when
   $A(\lambda) = ((1,*,*,2),(3,*,*,5),(5,*,7))$.}
  \label{fig:7darts}
\end{figure}


The double node and face walkups preserve edges (except for
the one that the walkup removes).
Thus, the edge $E=\{x_0,y_0\}$
becomes an edge $\{x_0',y_0'\}$ in $H'$
(with $y_0$ corresponding with $y'_0$).

We mark the face containing the dart $x'_0$ true, and the other
faces created by face-insertion false.   All other faces are
marked true or false as in the flag on the originating hypermap $H$.  
Through this
construction, the $H'$ contains exactly one more true face
than the originating hypermap.

\begin{lemma}\label{lemma:flag} 
The boolean function on faces constructed in this way is a
flag.
\end{lemma}

\begin{proof}  We show first that every edge of a false face is shared
with a true face.  If the false face is one of the newly created
faces, its edges are those along the new true face together
with some edges from the old false
face. Either way, the edges are shared with a true face.   If it is a
false face from the originating hypermap $H$, 
it shares edges with the
same true faces as before.

Next, we show that every pair of darts $x,y$ in true faces can be
joined by a contour path.  Let $H'=(D',e',n',f')$.  
If neither of $x,y$ lies in the
$f'$-orbit of $x'_0$, we can use the contour path that was used in the
originating hypermap.  If both are in the $f'$-orbit of $x'_0$, then
we can join $x$ to $y$ by a sequence of $f'$-steps.

If $x$ lies in the $f'$-orbit of $x'_0$, but $y$ does not, 
we first join $x$
to $x'_0$ by $f'$-steps, then to $n'^{-1} x'_0= f' y'_0$, then to $y'_0$,
which lies in a true face.
From $y'_0$, we follow a path $y$.
Similarly, if $y$ lies in the $f'$-orbit of $x'_0$ but $x$ does not; 
we follow a contour path from $x$ to $y'_0$, then to $n'^{-1} y'_0 = f'
x'_0$, then to $y$.
\end{proof}

\subsection{generating hypermaps}

The following lemma
and the remark that follows are the principal results of the
chapter.  These results tell us that 
face-insertions generate all nice hypermaps.
This algorithm to generate hypermaps is used later in the
book to produce an explicit classification of a family of
planar hypermaps, called {\it tame hypermaps}.

\begin{theorem}  Let $H$ be a hypermap with the following properties:
    \begin{enumerate}
        \item It is plain, planar, simple, and connected.
        \item The edge map $e$ has no fixed points.
        \item The node map $n$ has no fixed points.
        \item The size of every face is at least $3$.
        \item There are at least $2$ faces. 
        %%  (All hypoth. Needed?)
    \end{enumerate}
Let $\cal L$ be a normal family of contour paths in $H$. Assume that
the canonical boolean function $\phi$ on $H/{\cal L}$ is a flag. Let
$E$ be an edge of $H/{\cal L}$ that meets both a true face
and a false face. Let $N$ be the cardinality of that false face. Let
$M$ be a constant such that every face of $H$ has cardinality at
most $M$. Then there is exists a partition $\lambda=(\lambda_1,\ldots,\lambda_r)$ with at most
$M$ parts satisfying $$1=\lambda_1\le \cdots\lambda_r \le N-1$$
and a normal family
${\cal L}'$ such that $H/{\cal L}'$ with its canonical boolean
function is isomorphic to the image of face-insertion on
$(H/{\cal L},\phi,E,N,\lambda)\in {\cal H}$. 
Moreover, $H/{\cal L}'$
has one more true face than $H/{\cal L}$ has.
\end{theorem}

\begin{remark} The lemma implies that sufficiently nice hypermaps can be recovered
from their quotients by face insertions.  (Here {\it `nice'} means
that it satisfies the conditions of the lemma.)  
Every nice hypermap has a quotient 
$H_{2k}=H/{\cal L}_0$
(Examples~\ref{ex:H2} and~\ref{ex:H2k}).
Generate all face-insertions of $H/{\cal L}_0$ 
(as we run over relevant partitions).
Among the new hypermaps is some $H/{\cal L}_1$, which
has one more $\op{true}$ face than $H/{\cal L}_0$.  By 
Lemma~\ref{lemma:flag}, 
the canonical boolean function on this new quotient
is a flag.  Iterate to get a sequence
$H_{2k} = H/{\cal L}_0, H/{\cal L}_1,\ldots, H/{\cal L}_k$,
each obtained from the previous one by face-insertion.
By Lemma~\ref{lemma:all-dart}, 
as
soon as a quotient $H/{\cal L}_k$ 
has sufficiently many true faces, it is
isomorphic to the the original hypermap $H$, and the process
terminates.
Note that we choose the edge at which we apply the face
insertion, but we must run through
all partitions.  To make the entire process finite, we can bound the
number of partitions that must be considered, say by placing a
priori bounds $M$ on the cardinalities of the faces of $H$.
\end{remark}

\begin{proof}  We set some notation.
Write $f,e,n$ for the maps on $H$ and $f',e',n'$ for the maps on the
quotient hypermap.   
The dart $y'$ of $E$ that 
lies on the true face is a
singleton set, which can be identified with a dart $y$ in $H$.  Let
$y_0 = e y$, and let $y_k = {f}^k y_0$ be the darts of $H$ on the
face of $y_0$ (Figure~\ref{fig:algordart}).  
Let $r$ be the size of this face. 

We define a map $\psi$.
Let $*$ be a symbol.
A map
$\psi$ on the face of $y_0$ sends 
$y_i$ to $*$ if $y_i$ is disjoint from
the loops of ${\cal L}$ and sends $y_i$
to the dart of $H/{\cal L}$
containing $y_i$ otherwise.
As $H$ is simple, no two darts
$y_k$ map to the same dart in $H/{\cal L}$.
\begin{figure}[htb]
  \centering
  \myincludegraphics{noimage.eps}
  \caption{An example of the algorithm}
  \label{fig:algordart}
\end{figure}

We can write the map $\psi$ in terms of a map $\psi'$ on indices.
Let $x_0 = e' y'$ and let $x_k = {f'}^k x_0$.  Let $r'$ be the
cardinality of the $f'$-orbit through $x_0$.  
We claim that (1) $\psi(y_i)$ is either $*$ or one of the
darts $x_k$.  We justify this claim below.
When $\psi(y_i)$ is a dart, set $\psi(y_i) =
x_{\psi' i}$, for some $0\le i < r'$. 
When $\psi(y_i)$ is not a dart,
set $\psi' i = *$, 
We claim further that (2) if
$i< i'< r$, and both $\psi(y_i)$ and $\psi(y_{i'})$ are darts, then
$\psi' i < \psi' i'$.  We justify this claim below.
Accepting these two claims, we complete the proof.    

We construct a partition $\lambda$.
Form a sequence
    $$(\psi' 1,\psi' 2,\ldots,\psi' r).$$
Form a partition $\lambda$ from this sequence, 
by replacing each $*$ in the
subsequence $(j,*,*,\ldots,*)$ with $j$. Thus,
    $$(1,*,*,2,*,4,*,*,5)$$
becomes
    $$(1,1,1,2,2,4,4,4,5).$$
Face-insertion on $(H/{\cal L},\phi,E,N,\lambda)$ yields a new
hypermap $H'$.  

We claim that $H'$ is isomorphic to a quotient
$H/{\cal L}'$, which is specified as follows. The collection
${\cal L}'$ contains all the loops of ${\cal L}$ 
except the loop through the $f'$-orbit of $x_0$.  The collection
${\cal L}'$ also contains
the loop corresponding through the $f$-orbit
of $y_0$ as well as the loops through the false faces on
the new hypermap.  

We describe the contour loops associated with false faces 
in more detail.
The false faces on the new hypermap give a
contour loop of ${\cal L}'$ for each subsequence
$(j,*,\ldots,*,j')$ with $j< j'$ 
and one for each subsequence $(j,j')$ with
$j+1< j'$.  
First take the case $(j,j')$, with $j+1<j'$. 
Write $(j,j') = (\psi'i,\psi' i')$.
The inequality $j+1<j'$ implies that both $n^{-1}
y_i$ and $n y_{i'}$ are in $x_j$ and $x_{j'}$ respectively.
The contour loop for $(j,j')$ runs through 
all the darts of $x_k$ for $j<k<j'$,
the sequence of darts of $x_{j'}$ ending with $n y_{i'}$,
and the sequence darts of $x_j$ starting with $n^{-1} y_i$.

We continue with our description of the contour loops associated
with false faces.
In the case $(j,*,\ldots,j')$, we form consecutive sequences of darts
starting with $n^{-1} y_i$ and another ending at 
$n y_{i'}$ as in the previous case, and
all the darts of $x_k$ for $j<k<j'$, 
Each $y_k$, for $i < k < i'$ belongs to a node $N_k$ in $H$.
We also have the loop visit the darts in $N_k\setminus\{y_k\}$.

Now that the collection ${\cal L}'$ has been described in detail,
it is a routine matter to check that the quotient $H/{\cal L}'$
has the properties asserted in the lemma.

{\bf Claim 1}:
The proof is now complete except for two earlier claims.  We claim
that $\psi(y_i)$ is either $*$ or one of the darts $x_k$. 
For a contradiction, 
suppose that the dart $z$ of $H/{\cal L}$ containing
$y_i$ is not equal to any $x_k$.
Set $x = n^{-1}y_1$.  Define $y$ by
$[y,n^{-1}y,\ldots,y_0] = x_0$.  Let $L$ be the $f'$-orbit
of $x_0$.  This is a false face.
Start at $x$ and follow the darts of $H$ in $L$ 
to $n x = y_1$, passing through $y$ along the way.  Then from
$y_1$ take $f$-steps to $z$, step around that node to a true face
of $H/{\cal L}$,
follow a path along true faces (as guaranteed by the definition
of flag) to $n y$.  Along this path, 
darts are visited in the order
   $$x \ldots y \ldots n x \ldots n y.$$ 
This is a M\"obius contour in 
the planar hypermap $H$.  
This contradicts Lemma~\ref{lemma:no-mobius}.

{\bf Claim 2}:
We claim further that if $i<j\le n$, and both $\psi(y_i)$ and
$\psi(y_j)$ are darts, then $\psi' i < \psi' j$.  Assume to the
contrary that $\psi' j \le \psi' i$.  Then we take a contour loop
$L'$ from $y_1$ along the darts $y_j$ until reaching $x_{\psi' i}$,
then continuing for the rest of the path of $L$ back to $y_1$.
Giving the identical argument as in the preceding paragraph, but
using $L'$ instead of $L$, we again get a M\"obius contour $H$.  
Again, we contradict Lemma~\ref{lemma:no-mobius}.
\end{proof}


%% \section{All about Polygons}

\section{Patching}\label{sec:patch}


Let $H=(D,e,n,f)$ be a hypermap.  We write
$\op{face}(\alpha)$, $\op{edge}(\alpha)$, and $\op{node}(\alpha)$
for the face, edge, and node containing the dart $\alpha\in D$.
We write $H/f$, $H/e$, and $H/n$ for the set of faces,
edges, and darts.



Let $A$ and $B$ be simple hypermaps with face and node
permutations
    $f_A,f_B$, and $n_A,n_B$, respectively; and darts $D_A$ and
    $D_B$.  Assume that the darts of $A$ and the darts of $B$ are
    disjoint sets.

Let $\phi:F_A\to F_B$ be a bijection between a face of $A$ and a
face of $B$ such that
    $$
    \phi(f_A \alpha) = f_B^{-1}\phi(\alpha),\quad \forall
    \alpha\in F_A.
    $$

\begin{definition} Let $\op{patch}(A,B,\phi)$ be the following hypermap
$(D,f,n,e)$:
    $$D = D_A \cup D_B \setminus (F_A\cup F_B)$$
    $$f\alpha = f_A\alpha \text{if } \alpha\in D_A, \ f_B\alpha
    \text{otherwise}.
    $$
    $$n\alpha = \begin{cases}
    n_A\alpha &
        \text{if } \alpha\in D_A \wedge n_A\alpha\not\in F_A\\
    n_B[\phi(n_A\alpha)] &
        \text{if } \alpha\in D_A \wedge n_A\alpha\in F_A\\
    n_B\alpha &
        \text{if } \alpha\in D_B \wedge n_B\alpha\not\in F_B\\
    n_A[\phi^{-1}(n_B \alpha)] &
        \text{if } \alpha\in D_B \wedge n_B\alpha\in F_B\\
    \end{cases}
    $$
Let $e$ be defined by the relation $e\circ n\circ f = 1$.
\end{definition}

To justify this construction, the following lemma shows that the
maps $\phi,\phi^{-1}$ are applied only to darts in their domains.

\begin{lemma} With context as above (simple hypermaps, etc.),
if $\alpha\in F_B$ then $n_B\alpha\not\in F_B$.  If $\alpha\in
F_A$, then $n_A\alpha\not\in F_A$.
\end{lemma}

\begin{proof} Elementary.
\end{proof}

\begin{lemma} If $n_A$ and $n_B$ have no fixed points, then
    the node map on $\op{patch}(A,B,\phi)$ does not either.
\end{lemma}

\begin{proof}
\end{proof}

\begin{lemma} If $A$ and $B$ are simple, then
$\op{patch}(A,B,\phi)$ is simple.
\end{lemma}

\begin{lemma} If $A$ and $B$ are plain, then
$\op{patch}(A,B,\phi)$ is plain.
\end{lemma}

\begin{lemma} If $A$ and $B$ are planar and plain, then
    $\op{patch}(A,B,\phi)$ is planar.
\end{lemma}


%%%%%%%%%%%%%%%%%


\chapter{Hypermap and Geometry}

In this section we show how a hypermap can be attached to certain
graphs whose nodes are vectors in $\ring{R}^3$. This hypermap will
encode the combinatorial properties of the vectors.

%\begin{definition}  Let $v\in\ring{R}^3$ and $W \subset
%\ring{R}^3$.  We say that $\sigma:W\to W$ is an azimuth cycle on $W$
%coming from $v$, if there is a orthonormal $2$-frame $P=(0,e_1,e_2)$
%with $e_1 \times e_2 = v/|v|$, and a cycle is $\sigma:W\to W$ with
%respect to $P$. (By REF%%, an azimuth cycle is unique, but may not
%exist.)
%\end{definition}

%[ change the following definition, so that edges are triples
%$(v,w,u)$, where $u$ is a unit vector orthogonal to $v$ and $w$.
%Assume that if $(v,w,u)\in E$ then $(w,v,-u)\in E$.  We then ask for
%an azimuth cycle on the vectors $u\times v$ rather than on the
%vectors $w$.  The third element $u$ allows for the case that the $v$
%and $w$ are antipodal, or the long end of a great circle, which is
%convenient for some of the proofs. In standard situations, we can
%just take $u$ to be the unit length vector in the direction $v\times
%w$.  This change ripples through the text.  For instance, the proof
%that  $\#c = \#f$ for linear graphs reduces all the way down to the
%case of a single plane.]

If $e=\{v_1,v_2\}$ is a set of two points and $v_0$ is any other point,
set
  $$
  \begin{array}{lll}
  C(v_0,e) &= \op{aff}_+(v_0,e)\\
  C^0(v_0,e) &= \op{aff}^0_+(v_0,e)\\
  \end{array}
  $$
We drop the $v_0$ from the notation, when it is clear from context,
and write $C(e), C^0(e)$.

% Note that the base point is always variable $v_0$.
%% WW Sometimes v_0 is base point, sometimes p.

\begin{definition}  Let $(v_0,V,E)$ be a triple consisting of a point,
a set of
vectors, and a set of pairs of elements of $V$.  The triple is said to be
a {\it fan\/} if the following conditions hold.
    \begin{itemize}
    \item $V$ is finite and nonempty.
    \item $v_0\not\in V$.
    %\item Each element of $E$ has two elements.
    \item For each $v\in V$, the set
        $$
        %% WW changed notation from E_v to E(v) to allow deformations E_t
        E(v) = \{w\in V\mid \{v,w\}\in E\}
        $$
        is cyclic with respect to $(v_0,v)$.
    \item For sets $e,e'\in E$,   we have
        $$C^0(v_0,e) \cap C^0(v_0,e')\ne\emptyset\ \Rightarrow e = e'.$$
    \end{itemize}
The sets $C^0(v_0,e)$ and $C(v_0,e)$ are {\it blades\/} of the fan.
\index{blade}
\index{fan}
\end{definition}

We make a series of remarks about this definition.

\begin{remark}\tlabel{rem:fan}
\begin{itemize}
\item The pair $(V,E)$ is a graph with nodes $V$ and edges $E$.  The set
$E(v)$ is the set of edges around a fixed node $v$.
Note that $w\in E(v)$ if and only if $v\in E(w)$.   
%
\item The final condition implies that the sets $C^0(v_0,e)$
do not meet.   It
is this condition that will eventually give us a construction of planar
hypermaps.
%
\item
By the condition that $E(v)$ should be cyclic,
for each $v\in V$, we have an azimuth cycle $\sigma(v):E(v)\to E(v)$.
We specifically allow the situation where $E(v) = \{w\}$ is a
singleton set. In this case,
$\sigma(v)$ is the identity map on $E(v)$.
%
\item
We generally write $\sigma(v,w)$ for $\sigma(v)(w)\in E(v)$.
%
\item 
The hypothesis of the existence of an azimuth cycle
prevents $\{v_0,v,v'\}$ from being a collinear set, when $\{v,v'\}\in
E$.
%
\end{itemize}
\end{remark}



\section{Topology of fans}

Let $(v_0,V,E)$ be a fan.  We define sets of darts $D_1,D_2,D$:
    $$
    \begin{array}{lll}
    D_1 &= \{(v_0,v,w,w')\mid v\in V,\ w\in E(v),\ w' = \sigma(v,w)\}\\
    D_2 &= \{(v_0,v) \mid v\in V,\ \ E(v) = \emptyset\},\\
    D   &= D_1\cup D_2.
    \end{array}
    $$
We call $D_1$ the reduced set of darts and $D$ the extended set of darts.

We define a permutation $n$ on $D_1$ by
    $$n(v_0,v,w,w') = (v_0,v,w',\sigma(v,w')).$$
We define a permutation $f$ on $D_1$ by
    $$
    f (v_0,v,w,w') = (v_0,w,\sigma(w)^{-1} v,v).
    $$
Define a permutation $e$ on $D_1$ by
    $$
    e (v_0,v,w,w') = (v_0,w,v,\sigma(w,v)).
    $$
Define permutations $e,n,f$ on $D_2$ by making them degenerate on $D_2$:
    $$
    e (v_0,v) = n(v_0,v) = f(v_0,v) = (v_0,v).
    $$
Write $\op{hyp}_r(v_0,V,E)=(D_1,e,n,f)$ and
Write $\op{hyp}(v_0,V,E)=(D,e,n,f)$.  We call them the reduced hypermap
and the (extended) hypermap associated with $(v_0,V,E)$.  The next
lemma justifies this terminology.



\begin{lemma} Let $(v_0,V,E)$ be a fan.  Let $D = D_1\cup D_2$
and $\op{hyp}(v_0,V,E) = (D,e,n,f)$, as constructed above.  Then
    \begin{itemize}
    \item $\op{hyp}(v_0,V,E)$ is a plain hypermap.
    \item The edge map $e$ has no fixed
points in $D_2$.
    \item The face map $f$ has no fixed points on $D_2$.
    \item For every pair of distinct nodes, there is at most one
    edge meeting both.
    \item Both darts of an edge (of $D_2$) lies on a different node.
    \end{itemize}
\end{lemma}

\begin{lemma}  We compute
    $$e(n(f(v_0,v,w,w'))) = e(n(v_0,w,\sigma(w)^{-1} v,v))) =
        e(v_0,w,v,\sigma(w, v)) = (v_0,v,w,\sigma(w, v)) = (v_0,v,w,w').$$
So it is a hypermap. We compute
    $$e(e(v_0,v,w,w')) = e(v_0,w,v,\sigma(w,v)) = (v_0,v,w,w').$$
So it is plain. A fixed point in $D_2$ under $e$ would force $v = w\in E(v)$,
but by construction $v\not\in E(v)$.  The argument that $f$ has no
fixed points is similar.

    Next we show that for every pair of distinct nodes, there is at
most one edge meeting both.  That is,
        $$(n^k e x = e n^\ell x)\Rightarrow n^\ell x = x.$$
Let $x = (v_0,v,w,w')\in D_1$.  Let $\sigma=\sigma(v)$. Then
    $$
    \begin{array}{lll}
    n^\ell x &= (v_0,v,\sigma^\ell w,\sigma^{\ell+1}w)\\
    e n^\ell x &= (v_0,\sigma^\ell w,*,*)\\
    e x &= (v_0,w,*,*)\\
    n^k e x &= (v_0,w,*,*)\\
    n^k e x &= e n^\ell x \Rightarrow w = \sigma^\ell w \Rightarrow
    n^\ell x &= (v_0,v,w,\sigma w) = x
    \end{array}
    $$

Finally, we show that each dart of an edge lies on a different node.
That is, $e x \ne n^k x$, for $x\in D_1$.  We have
    $$
    \begin{array}{lll}
        e(v_0,v,w,w') &= (v_0,w,*,*),\quad w\in E(v)\\
        n^k(v_0,v,w,w') &= (v_0,v,*,*),\quad v\not\in E(v).
    \end{array}
    $$
The result follows.
\end{lemma}

\subsection{basic topology}

There is hardly any topology that comes up in this book.  Most of
what is needed appears in this chapter.  We make use of some basic
notions in topology such as continuity, connectedness, and compactness.

\begin{remark} The term {\it connected} is now being used in
two different senses: in the topological sense and in a combinatorial
sense for hypermaps.
\end{remark}





The set $\ring{R}^3$ is a metric space under the
Euclidean distance function $d(v,w) = |v-w|$.  Subsets of
$\ring{R}^3$ are a metric space under the restriction of the metric
$d$ to the subset. Subsets carry the metric space topology.  We
investigate the connected components of $Y$,
for a given closed set $X$.    If two
points in $\ring{R}^3$ 
can be joined by a continuous path that avoids $X$,
then they lie in the same connected component of $Y$.
If we produce a family of nonempty connected open sets in
$Y$, whose union is all of $Y$, then the
members of the family are the connected components of $Y$.
Let $$S^2(v_0) = \{ v \mid | v-v_0 | = 1\}$$ be the unit sphere in
$\ring{R}^3$, centered at $v_0$.  






\subsection{components and darts}

\begin{definition}\label{def:XY}
Let $(v_0,V,E)$ be a fan.  Let $X=X(v_0,V,E)$ be the union of the
cones
   $$C(v_0,e)$$
as $e$ ranges over $E$.  Let $Y=Y(v_0,V,E)$ be the complement
$Y = \ring{R}^3\setminus X$.
\index{X}\index{Y}.
\end{definition}

%% WW Move the following remark elsewhere:
If $e=\{v,v'\}\in E$, then $v_0,v,v'$ are not collinear
(Remark~\ref{rem:fan}), so that $C(v_0,e)$
does not lie in a line, and does not contain any
distinct points $u,u'\in
C(v_0,e)\setminus\{v_0\}$ 
with $\op{aff}\{u,u',v_0\}$ collinear. 
In particular, $C(v_0,e)$ does not contain a line through $v_0$.

Let $(v_0,V,E)$ be a fan and let $(D,e,n,f) = \op{hyp}(v_0,V,E)$
be the associated hypermap.  Write $D = D_1\cup D_2$ as a union of
reduced darts $D_1$ and non-reduced darts $D_2$.

Each dart $x=(v_0,v,w,w')\in D_1$ defines
a wedge $W(x) = W(v_0,v,w,w')$ and an azimuth angle $\op{azim}(x) =
\op{azim}(v_0,v,w,w')$.   If $x=(v_0,v)\in D_2$, then we set
$W(x) = \ring{R}^3\setminus \op{aff}\{v_0,v\}$ and $\op{azim}(x) = 2\pi$.

We can further restrict the wedge by putting conditions on the zenith angle.
If $x = (v_0,v,w,w')\in D_1$ or $x = (v_0,v)\in D_2$, set
    $$
    W(x,\phi) = W(x) \cap \op{rcone}^0(v_0,v,\cos\phi).
    $$

\begin{lemma}\tlabel{lemma:disjoint}  
Let $(D,e,n,f)$ be the hypermap attached to a 
fan $(v_0,V,E)$.
Let $N$ be a node of $D$.  There exists $v\in V$
such that the darts of $N$ are precisely
the darts of the form $(v_0,v,\ldots)$.  Furthermore, there is a 
disjoint sum decomposition of $\ring{R}^3$ given by
  $$
  \ring{R}^3 = 
  \op{aff}\{v_0,v\} \cup
  \bigcup_{x\in N} W(x)  \cup 
  \bigcup_{\{v,w\}\in E} \op{aff}_+^0(\{v_0,v\},w).
  $$
\end{lemma}

\begin{corollary}\tlabel{cor:W}  
Let $x = (v_0,v,\ldots)$ be a node.
We have $W(x)\cap C(v_0,e)=\emptyset$, for $e\in E(v)$.
\end{corollary}

\begin{proof} The decomposition of Lemma~\ref{lemma:disjoint} is
disjoint.  It follows directly from the definitions that
   $$C(v_0,e)\subset \op{aff}_+^0(\{v_0,v\},w).$$
\end{proof}

\begin{lemma} For each $x$, and $\phi$ sufficiently small and positive,
$W(x,\phi)$ is nonempty and lies in a single connected
component of $Y$.
\end{lemma}

\begin{proof}  First we show that $W(x,\phi)$ lies in $Y$,
for $\phi$ small.  Let $x=(v_0,v,w,w')\in D_1$.  
Let $S^2(v_0)$ be the unit sphere centered at $v_0$.
By making $\phi$ small enough,
the sets $W(x,\phi)\cap S^2(v_0)$
avoid the compact sets $C(v_0,e)\cap S^2(v_0)$ when $v\not\in e$.
Thus, $W(x,\phi)$ also avoids $C(v_0,e)$ when $v\not\in e$.
By Corollary~\ref{cor:W}, $W(x,\phi)$ avoids $C(v_0,e)$, when $v\in e$.
Thus, $W(x,\phi)\in Y$, for $\phi$ small.

To complete the proof, it is enough to show that each $W(x,\phi)$ is
connected.  
The  set
   $$
   R=\{(r,\theta,\phi) \in (0,\infty) \times (\theta_1,\theta_2) \times (0,\phi)\}
   $$
is connected.
The set $W(x,\phi)$  is the image of $R$
under a spherical coordinate representation (Definition~\ref{def:sph}).
It is readily verified that the polar coordinate representation is
a continuous map. As the image of a connected set under a continuous map
is connected, we conclude that $W(x,\phi)$ is connected.
\end{proof}

\begin{definition} For each dart $x$, 
there is then a well-defined connected
component $U_x$ of $Y(v_0,V,E)$ 
that contains $W(x,\phi)$ (for all
sufficiently small $\phi$). We say that the dart {\it leads into}
$U_x$.
\end{definition}


\subsection{components and faces}

%% WW: notation e for edge of E and for edge of the hypermap,
% and for the edge permutation on darts.

Let $(v_0,V,E)$ be a fan.  Let $X=X(v_0,V,E)$ as above. Let
$x=(v_0,v,w,w')$ be a dart, and  $e = \{v,w\}\in E$.
Let 
  $$C(v_0,e,\psi) =
    \{ c\in C(v_0,e) \mid c\not\in \op{rcone}(v_0,v,\psi)
    \cup\op{rcone}(v_0,w,\psi)\}.
  $$
Let 
  $$n = (v-v_0)\times (w-v_0)$$
and let
  $$
  U(x,s,\phi) = \{ x  \in \ring{R}^3 \mid
     x = c + \mu\, n\, |c-v_0|,\quad
     c\in C(v_0,e,\phi/2),\quad
     0 < \mu < s
     \}.
  $$

\begin{lemma}  Let $(v_0,V,E)$ be a fan.
Let $x=(v_0,v,w,w')$ be a dart in the associated hypermap.
Pick $\phi$ so small that $W(x,\phi)$
and $W(f x,\phi)$ each lie in a single connected component 
of $Y(v_0,V,E)$ and
that $W(x,\phi)\cap W(f x,\phi) =\emptyset$.
For $s,\phi > 0$, the set $U(x,s,\phi)$ is
open and connected.
\end{lemma}

\begin{proof}  Let $v_0 + y \in U(x,s,\phi)$.
Then $y$ can be written uniquely as
$$
  y = t (c - v_0) + \mu t n,\quad
  t > 0,\quad
  0 < \mu < s,\quad
  c \in C(v_0,s,\psi) \cap S^2(v_0).
$$
The parameter $c$ ranges over an open arc of the circle
$$S^2(v_0) \cap \op{aff}(v_0,v,w).$$
The parameters $(t,\mu,c)$ give a homeomorphism of $U(x,s,\phi)$
with a product of three connected open sets.  The result follows.
\end{proof}

%The set 
%$U=U(x,s,\phi)$ is homeomorphic to the product
%  $$
%  \{x \in\ring{R}\mid x > 0\} \times U',\quad
%  U' = \{x \in U \mid |x-v_0| = 1\}.
%  $$
%It is enough to show that $U'$ is open and connected in
%the sphere $$S^2(v_0) = \{x\mid |x-v_0|=1\}.$$
%$C(v_0,e,\phi/2) \cap S^2(v_0)$ is open in the
%topology on the circle $A=\op{aff}\{v_0,v,w\}\cap S^2(v_0)$, 
%because it is
%obtained by removing the closed sets $\op{rcone}(v_0,\cdot,\phi/2)\cap A$ from the open set $A\cap C^0(v_0,e)$.
%It is also connected.   However, $U'$ is homeomophic to the
%product
%  $$
%  (0,s) \times (C(v_0,e,\phi/2) \cap A.
%  $$
%The result follows.


\begin{lemma}
Let $(v_0,V,E)$ be a fan.
Let $x=(v_0,v,w,w')$ be a dart in the associated hypermap.
For all $\phi > 0$ and sufficiently small, there exists
$\epsilon=\epsilon(\phi)>0$ such that
the set $U(x,s,\phi)$ is
contained in a single connected component of $Y(v_0,V,E)$ for all 
$0 < s <\epsilon(\phi)$.
\end{lemma}

\begin{proof}  Fix $\phi>0$ small enough that $W(x,\phi)$
and $W(f x,\phi)$ are contained in a single component.
By the previous lemma, $U=U(x,s,\phi)$ 
is connected.  It is enough to
show that $U\cap S^2(v_0)$  does not meet $X(v_0,V,E) \cap S^2(v_0)$.
By construction, the set $U$ does not meet the blade
$C(v_0,\{v,w\})$.  If the lemma is false, we can find an
edge $e\ne \{v,w\}$,
and
a sequence $c_i + \mu_i n \in U(x,s_i,\phi)\cap S^2(v_0)
\cap C(v_0,e)$, and $c_i\in C(v_0,\{v,w\},\phi/2)$. 
with $s_i \to 0$ and $\mu_i\to 0$. 
By compactness, a subsequence
the elements $c_i$ converges to an
element $c$ in 
  $$(C(v_0,\{v,w\})\cap C(v_0,e)\cap S^2)
  $$
By the assumption that  $(v_0,V,E)$ is a fan, this
implies that $\{v,w\}$ meets $e$ at a vertex, say $v\in e$.
The elements $c_i\not\in \op{rcone}^0(v_0,v,\phi/2)$, so
in the limit we have $c\not\in\op{rcone}^0(v_0,v,\phi/2)$.
However, the intersection of $C(v_0,v)$ with $C(v_0,\{v,w\})$
lies in $\op{rcone}^0(v_0,v,\phi/2)$.  This is a contradiction.
\end{proof}

\begin{lemma}
Let $(v_0,V,E)$ be a fan.
Let $x=(v_0,v,w,w')$ be a dart in the associated hypermap.
For all $\phi,\epsilon > 0$
the set $U=U(x,\epsilon,\phi)$ meets $W=W(x,\phi)$ and 
$W'=W(f x,\phi)$.
Furthermore, the darts $x$ and $f x$ lead into the same
component of $Y(v_0,V,E)$.
\end{lemma}

\begin{proof}
We will show that $U$ meets $W$.    Let $e=\{v,w\}$. Pick 
 $$c\in C(v_0,e) \cap 
      (\op{rcone}^0(v_0,v,\phi)\setminus \op{rcone}(v_0,v,\phi/2)).
 $$
Let $n$ be as above.  For $\mu$ sufficiently small, the point
$u_\mu=c + \mu n$ lies in  $U$.  We show that $u_\mu\in W(x,\phi)$, for $\mu$ small.
By construction $u_\mu\in \op{rcone}^0(v_0,v,\phi)$.
The direction of the normal $n$ was chosen so that for $\mu$ small
we have
   $$
   \op{azim}(v_0,v,w,c) < \op{azim}(v_0,v,w,u_\mu).
   $$
Note that $\op{azim}(v_0,v,w,c) = 0$, because 
$c\in\op{aff}_+^0(\{v_0,v\},w)$. 
The function $\op{azim}$ is equal to $\op{dih}_V$ for
small angles (Lemma~\ref{lemma:dih-azim}).  Moreover,
the function $\dih_V$ is continuous (provided
we avoid the set along which $\{v_0,v,w\}$ or $\{v_0,v,c\}$ is
collinear), as can be seen
from the explicit formula 
for the function in Lemma~\ref{lemma:dihform}.
Hence, $\op{azim}(v_0,v,w,u_\mu)$ tends to zero with $\mu$.
Thus, for $\mu$ sufficiently small,
   $$
   0 < \op{azim}(v_0,v,w,u_\mu) < \op{azim}(v_0,v,w,w').
   $$
This is precisely the condition for $u_\mu\in W(x,\phi)$.
The argument that $U$ meets
$W'$ is similar.

Each of the sets $U$, $W$, $W'$ lies in a single connected
component of the complement.  Since $W$ and $U$ meet, they
lie in the same component.  Likewise, $U$ and $W'$ lie in the
same component.  By transitivity, $W$ and $W'$ lie in the same
component.
\end{proof}

\begin{lemma}\label{lemma:face-component} 
Let $(v_0,V,E)$ be a fan.
If $x$ and $y$ are darts in the same face of the hypermap
$\op{hyp}(v_0,V,E)$, then they lead into the same connected component.
\end{lemma}

\begin{proof}  This is an easy induction, based on the previous
lemma.  
\end{proof}

%This implies in particular
%that the number of connected components is no more than
%the number of faces of the hypermap.  

%%%%%

\begin{lemma}\label{lemma:approach-Ce}
Let $(v_0,V,E)$ be a fan.  Let $U$ be a connected
component of $Y(v_0,V,E)$.  Let $e\in E$ and let $\{x,y\}$
be the two darts forming an edge of $\op{hyp}(v_0,V,E)$
corresponding to $e$.  Let $\gamma:[0,1]\to U\cup C^0(v_0,e)$
be a path that begins in $U$ and ends on $C^0(v_0,e)$.
Then for all $\phi,\epsilon>0$ sufficiently small,
there exists  $t\in[0,1]$ such that
  $$\gamma(t)\in 
  V(x,\phi) \cup 
  V(f x,\phi)\cup 
  V(y,\phi)\cup 
  V(f y,\phi) 
  \cup U(x,\epsilon,\phi)
  \cup U(y,\epsilon,\phi).
  $$
\end{lemma}

\begin{proof}
Suppose for a contradiction, that path avoids the given union
of sets.  By going to a smaller interval $[0,t']$, $t'\le 1$,
we may assume that $\gamma(t)\in U$ for $t < t'$ and $\gamma(t')\in
C^0(v_0,e)$.  

Fix $\phi,\epsilon$ small and positive.
Let $x = (v_0,v,w,w')$.
If $\gamma(t')\in \op{rcone}^0(v_0,v,\phi)$, then $\gamma(t)\in
\op{rcone}^0(v_0,v,\phi)$ for $t$ sufficiently close to $t'$.  The
azimuth angle $\op{azim}(v_0,v,w,\gamma(t))$ is small but nonzero, 
when
$t$ is close to $t'$.  If it is small and positive, then 
it follows that $\gamma(t)\in V(x,\phi)$.  If it is negative, then
$\gamma(t)\in V(n^{-1} x,\phi)$ and $n^{-1} x = f y$.

The proof is similar, if $\gamma(t')\in \op{rcone}^0(v_0,w,\phi)$.
Finally, in the remaining case, 
$\gamma(t')\in C(v_0,\{v,w\},\phi/2)$ and 
$$\gamma(t)\in U(x,\epsilon,\phi)\cup U(y,\epsilon,\phi).$$
\end{proof}

\begin{lemma}
Let $(v_0,V,E)$ be a fan.  Let $U$ be a connected
component of $Y(v_0,V,E)$.
Then, there exists a
dart $x$ that leads into that component.
\end{lemma}

\begin{proof}  Let $v\in U$ and pick curve (say an arc of a
circle centered at $v_0$) from $p$ to a point on $X=X(v_0,V,E)$.
By picking an appropriate circle, 
we may assume that the first point of the curve in $X$ lies
in $C^0(v_0,e)$ for some edge $e\in E$.  
By Lemma~\ref{lemma:approach-Ce},
the connected component $U$ contains one of the connected
sets $V(y,\phi),\ldots$.
For each of these connected sets, there is a dart leading
into its component.
\end{proof}

\begin{lemma}
Let $(v_0,V,E)$ be a fan.  Let $(v_0,V,E')$
be the fan obtained by deleting one edge:
  $$
  E' = E\setminus\{e\}, \quad X(v_0,V,E) = X(v_0,V,E')\cup C(v_0,e).
  $$
The inclusion  $$Y(v_0,V,E) \subset Y(v_0,V,E').
   $$
gives a map
from the set of components
of $Y(v_0,V,E)$ to the set of components
of $Y(v_0,V,E')$.
\end{lemma}

\begin{lemma}\label{lemma:pre-walkup}
Let $(v_0,V,E)$ be a fan.  Let $(v_0,V,E')$
be the fan obtained by deleting one edge $e$
of the hypermap.
Then the double walkup on the edge $e$
transforms $\op{hyp}(v_0,V,E)$ into
$\op{hyp}(v_0,V,E')$.
\end{lemma}


\begin{lemma}\label{lemma:join-comp}
Let $(v_0,V,E)$ be a fan.  Let $(v_0,V,E')$
be the fan obtained by deleting one edge $e$.
Let $x,y$ be the darts of the edge of
$\op{hyp}(v_0,V,E)$ corresponding
to $e$.
Let $U,U'$ be two distinct
components of $Y(v_0,V,E)$ that are mapped
to the same component of $Y'=Y(v_0,V,E')$.  Then exchanging
$x$ and $y$ if necessary, we have that $x$ leads into $U$
and $y$ leads into $U'$.
\end{lemma}

\begin{proof}
Since $U$ and $U'$ merges into a single component of $Y'$,
there is a path in $U\cup U'\cup C^0(v_0,e)$, starting in $U$
and ending in $U'$.  Since $U$ and $U'$ are separate components
in $Y$, the path necessarily meets $C^0(v_0,e)$.
By Lemma~\ref{lemma:approach-Ce}, the
initial part of the path in $U\cup C^0(v_0,e)$ up to the first
intersection with $C^0(v_0,e)$ meets $A(x)\cup A(y)$, where
  $$
  A(z,\epsilon,\phi) = 
    V(z,\phi) \cup V(f z,\phi) 
  \cup U(z,\epsilon,\phi).
  $$
(We assume that $\epsilon$ and $\phi$ are positive and sufficiently
small; then drop them from the notation.)
Similarly, the terminal part of the path in $U'\cup C^0(v_0,e)$, 
from the
final intersection with $C^0(v_0,e)$ on, meets $A(x)\cup A(y)$.
Recall that $A(x)$ and $A(y)$ are connected.  Thus,
if the initial and terminal segments of the path were to
meet the
same set (say $A(x)$), then $U$ and $U'$ would be equal components.
Thus, $U$ contains (say) $A(x)$ and $U'$ contains $A(y)$.
The result now follows from the definition of what it means
to lead into a component.
\end{proof}


\begin{lemma}
Let $(v_0,V,E)$ be a fan.  Let $(v_0,V,E')$
be the fan obtained by deleting one edge $e$.
Let $x,y$ be the darts of the edge of
$\op{hyp}(v_0,V,E)$ corresponding
to $e$.  Then
the natural map from components of $Y(v_0,V,E)$ to components
of $Y'=Y(v_0,V,E')$ is onto.
Suppose, furthermore, that the double walkup
on $\{x,y\}$ corresponding to the deletion of $e$ splits
(see Lemma~\ref{lemma:pre-walkup} 
and Definition~\ref{def:merge-split}).  
The the natural map from components of $Y$ to those of $Y'$ is a bijection.
\end{lemma}

\begin{proof}
First we show that the map is onto.  Let $U'$
be a component of $Y'$.  If $p\in U'$,
then a sufficiently small neighborhood of $p$ is contained
in $Y'$ and contains a point $q\not\in C(v_0,e)$.  The
point $q$ belongs to some component $U$ of $Y$.  The image
of $U$ is $U'$.

We show that the map is injective.  If not, two
components $U_1,U_2$ map to the same component of $Y'$.
By Lemma~\ref{lemma:join-comp}, we may assume
that $x$ leads into $U_1$ and
$y$ leads into $U_2$.
However, when splitting, $x$ and $y$ are in the same face of
the hypermap $\op{hyp}(v_0,V,E)$ and hence lead into the
same component.  Thus, $U_1=U_2$.
\end{proof}

%\begin{lemma} Let $(v_0,V,E)$ be a fan.  Suppose that
%deleting an edge of the graph is given combinatorially as a splitting
%double face walkup.  Then the number of connected components of
%$Y(v_0,V,E)$ is preserved by the edge deletion.  All
%components are left as before, except one that differs only by the
%presence of the edge.
%\end{lemma}
%
%\begin{proof}
%The components other those along the edge are unaffected. Suppose
%that there are two connected components $U,U'$ in $H'$ that become
%connected after the edge deletion.  If sets $U(x,\epsilon,\phi)$ and
%$U({e x},\epsilon,\phi)$  ($\epsilon$ small) were both to belong to the
%same component $U$, then $U\cup\{\text{the open-ended edge}\}$ WW
%and $U$ are disjoint open after the deletion, contrary to the
%assumption they become connected.  So $U(x,\epsilon,\phi) \subset U$ and
%$U({e x},\epsilon,\phi) \subset U'$.  Thus, $x$ and $e x$ lie on
%different faces of $H'$ and this implies that the double walkup
%merges, contradicting the hypothesis that it splits. Thus, the
%number of connected components remains constant.
%\end{proof}
%

\begin{lemma} 
Let $(v_0,V,E)$ be a fan.  Let $(v_0,V,E')$
be the fan obtained by deleting one edge $e$.
Let $x,y$ be the darts of the edge of
$H=\op{hyp}(v_0,V,E)$ corresponding
to $e$.  
Suppose that $x$ and $y$ lead into different components $U_x,U_y$
of $Y(v_0,V,E)$.
Then $U_x$ and $U_y$ map to the same component of $Y'=Y(v_0,V,E')$.
\end{lemma}

\begin{proof}
Let $f,n$ be the face and node maps on the hypermap
$H$.
If $y$ leads into $U_y$, then so does
$f y = n^{-1} x$.  Let $z$ be the dart in
$(D',\cdot,n',\cdot)=\op{hyp}(v_0,V,E')$ that is the image of the dart $n^{-1}x$
in $H$. We see that
$W(x,\phi)$ and $W(n^{-1} x,\phi)$ combine into a single
region $W({n'}^{-1}z,\phi)$.  Thus, $U_x$ and $U_y$ map to the
same component of $Y'$.
\end{proof}

%
%%Let $(v_0,V,E)$ be a fan.  Suppose that
%deleting an edge of the graph is given combinatorially as a merging
%double face walkup.  Let $x$ be a dart along the given edge.  Assume
%that $x$ and $e x$ lead into distinct components. Then the number of
%connected components of $Y(v_0,V,E)$ is decreased by one by
%the edge deletion. All components except the components of $x$ and
%$e x$ (along the given edge) are left as before.  The components of
%$x$ and $e x$ are joined.


%\begin{proof} The components other than those of $x$ and $e x$ are
%unaffected.  The darts $f x$ and $e x$ lead into different
%components before the deletion, but the wedge $W({f x})$ and $W({e
%x})$ are combined into $W({f' x})$ after the deletion.  So the two
%components are combined.
%\end{proof}
%

\begin{lemma}  
Let $(v_0,V,E)$ be a fan with associated hypermap 
$(D,e,n,f)$.
Fix a union of orbits $A$ 
of $\tangle{e,n,f}$.  Let $X_1$ be
the union of blades $C(v_0,{\{v,w\}})$ such that there is a dart 
$x =
(v_0,v,w,w')$ in $A$.  Let $X_2$ be the union of blades coming in the
same way, but for darts not in $A$.  
Then $$X_1\cap X_2 = \{v_0\}.$$
\end{lemma}

\begin{proof} 
If the intersection of the two sets is not $\{v_0\}$, then
by the conditions on the intersection of blades in the definition
of a fan,
there are blades of the form
  $$
  \begin{array}{lll}
   C_1 &= C(v_0,\{u,v\})\subset X_1,\\
   C_2 &= C(v_0,\{v,w\})\subset X_2.\\
  \end{array}
  $$
By the definition of fans, $u$ and $w$ are
in the same orbit of the azimuth cycle $\sigma(v)$ on $E(v)$.
The azimuth cycle is used to define the node map.
Hence, the darts 
   $$
   (v_0,v,u,\sigma(v,u)) \text{ and }
   (v_0,v,w,\sigma(v,w))
   $$
are connected by a contour path of $n^{-1}$-steps.
This gives a contour path from a dart in $A$ to a dart that
is not in $A$.
This is contrary to the assumption that these darts lie in
separate orbits of $\tangle{e,n,f}$.
\end{proof}



%%% EXIST DART
%%%
%\begin{lemma}
%For each connected component of 
%$Y$, there exists a
%dart $x$ that leads into that component.
%\end{lemma}
%
%\begin{proof} This follows from the claim
%of the following lemma (Lemma~\ref{lemma:dart-curve}), 
%which constructs
%a continuous curve from any point in 
%$Y$ to a wedge
%$W(x,\phi)$.
%\end{proof}
%
%\begin{lemma}\label{lemma:dart-curve}
%Let $(v_0,V,E)$ be a fan.  Assume that $E\ne\emptyset$.
%%Let $X=X(v_0,V,E)$.
%Let $v\in Y$.  
%Then there exists a nondegenerate dart 
%$x=(v_0,v_1,w_1,w_2)$ of $\op{hyp}(v_0,V,E)$ with the
%following properties:
%\begin{itemize}
%\item Let $F$ be the orthonormal frame with respect to 
%  $(v_0,v_1,w_1)$ and let $P(F,r,\theta,\phi)$ be the spherical
%  coordinate representation with respect to this frame
%  (Definition~\ref{def:sph}).
%\item We have
%   $$v = P(F,r_v,\theta_v,\phi_v).$$
%\item 
%   For all $0 < \phi \le \phi_v$, we have
%   $P(F,r_v,\theta_v,\phi)$ does not meet any $C(v_0,e)$, 
%   for $e\in E$.
%\item For all $\phi>0$ sufficiently small,
%   $P(F,r_v,\theta_v,\phi)\in W(x)$.
%\end{itemize}
%\end{lemma}
%
%\begin{proof} 
%If $v$ lies in some $W(x,\phi)$, the conclusion follows
%directly from the definition of $W(x,\phi)$.  We may
%assume that $v$ does not lie in any of the sets $W(x,\phi)$.
%
%Now assume that no  dart $x$ satisfying the conditions
%of the lemma exists.  
%Consider the circle
%   $$S^1 = \{u\mid |u-v_0|=1,\quad
%     (u-v_0)\cdot (v-v_0) = 0\}.$$
%The set $S^1$ is a metric space in the induced metric
%from $\ring{R}^3$ and a connected topological space in the
%metric space topology.
%Let $A\subset S^1$ be defined as
%  $$
%  A = \{u \in S^1 \mid  \op{aff}\{v_0,v,u\} \cap X(v_0,V,E)\ne\emptyset\}.
%  $$
%
%We claim that $A$ is not empty.  Let $u'\in X(v_0,V,E)$ be any
%element such that $u'\not\in \op{aff}\{v_0,v\}$.  Then
%$\op{aff}\{v_0,v,u'\} = \op{aff}\{v_0,v,u\}$ for some $u\in S^1$.
%This element $u$ belongs to $A$.
%
%The set $X(v_0,V,E)$ is closed, and this implies that $A\subset S^1$
%is closed.  
%
%We define a function $f:A\to E$ as follows.  Take $u\in A$.
%Write
%$u'\in\op{aff}(v_0,v,u)$ in polar coordinates
%$(r,\theta)$ with respect to $(v_0,v,u)$ (Definition~\ref{def:polar}).
%Let $\theta$ be the smallest polar coordinate such
%that the point $u'$ with polar coordinates $(r,\theta)$ lies
%in $X(v_0,V,E)$.  (By a compactness argument
%on $X(v_0,V,E)\cap S^2(v_0)$, $\theta$ exists.)  By the
%assumption that the desired dart $x$ does not exist, we
%find that $u'$ lies in a unique $C(v_0,e)$.  Define $f(u)=e$.
%
%In fact, the element $u'$  lies in $C^0(v_0,e)$.  Under small
%perturbations of $u\in S^1$, the corresponding $u'$ also
%lies in $C^0(v_0,e)$.  Thus, the preimage $f^{-1}(e)$ is an
%open set of $S^1$, for each $e\in E$.  The sets $S^1\setminus A$,
%and $f^{-1}(e)$ give a finite cover of $S^1$ by disjoint open
%sets.  By the connectedness of $S^1$, we have $f^{-1}(e)=S^1$
%for some $e\in E$.
%
%However, by Lemma~\ref{tarski:miss-plane}, there is a 
%plane $\op{aff}\{v_0,v,u\}$ that does not meet $C(v_0,e)$.
%This contradiction gives the desired conclusion.
%\end{proof}
%
%%::DONE:: Why not replace this with a result that takes any
%%plane that meets $X()$.  It isn't necessary to close in on
%%a corner.  The only use of generalized polar coords was this.
%

\section{Deformations of Fans}

In this section, we consider various deformations $(p,V_t,E_t)$,
for $t\in I\subset \ring{R}$, of
a fan $(p,V_0,E_0)$.  
We assume that $t=0\in I$ gives the initial point
of the deformation.  
In general, these deformations
are obtained by choosing replacing each vertex $w_0\in V$
with a path $w:I\to \ring{R}^3$, which we write as $w_t$.  
The base point remains fixed at $p$ 
(which we have renamed from $v_0$ to
avoid notational conflicts).

We assume that every configuration $(p,V_t,E_t)$ of the 
deformation is a fan.
We assume that every deformation
leaves the edge set invariant:
   \begin{equation}\label{eqn:edge}
   E_t = \{ \{v_t,w_t\} \mid \{v_0,w_0\}\in E_0\}.
   \end{equation}
When these conditions hold, we call the deformation a 
fan deformation.

\begin{lemma}  Let $(p,V_t,E_t)$ (for $0\le t\le s$) 
be a fan deformation. Then we have the following invariants
of the deformation:
\begin{itemize}
\item The bijection $V_0\to V_t$ of vertex sets
given by $v_0\mapsto v_t$ 
is equivariant for
azimuth cycles on $E_0(v_0)$ and $E_t(v_t)$.
\item There is a bijection between the darts of $\op{hyper}(p,V_0,E_0)$
and those of $\op{hyper}(p,V_t,E_t)$ given by
   $$(p,v_0,\ldots) \mapsto (p,v_t,\ldots).$$
\item The hypermaps $\op{hyper}(p,V_0,E_0)$ and $\op{hyper}(p,V_t,E_t)$
are isomorphic under this bijection of darts.
\item There is a bijection $U_0\mapsto U_t$ 
between the components of $Y(p,V_0,E_0)$
and components of $Y(p,V_t,E_t)$ such that if the dart $x_0$ leads into
the component $U_0$, then the corresponding dart $x_t$ leads into
the corresponding component $U_t$.
\end{itemize}
\end{lemma}

\begin{proof} By the Identity~\ref{eqn:edge}, the set of
edges remains invariant through the deformation.  There
is thus a natural bijection between $E(v_0)$ and $E_t(v_t)$.
This bijection is compatible with the azimuth cycles on both
sets.  In fact, for the azimuth cycle to change, there must
be some earlier time $0\le\tau \le t$ when two azimuth angles coincide:
$$\op{azim}(p,v_\tau,w_\tau,u_\tau) = \op{azim}(p,v_\tau,w_\tau,u'_\tau)$$
with $w_\tau,u_\tau,u'_\tau\in E_\tau(v_\tau)$.  However, this
implies that the intersection of two blades 
   $$
   C(p,\{v_\tau,u_\tau\}) \text{ and } C(p,\{v_\tau,u'_\tau\})
   $$
is larger than what is allowed by the definition of fan.  Thus,
the azimuth cycle is compatible with the bijection.

It is clear that there is a bijection of darts of the two
hypermaps.   The edge, node, and face maps on darts are defined
in terms of the azimuth cycle.  Since the azimuth cycle is
equivariant, the two hypermaps are easily seen to be isomorphic.

We define a relation $R$ consisting of all ordered pairs $(U_0,U_t)$
such that there exists a dart $x_0$ of $(p,V_0,E_0)$ and 
corresponding dart $x_t$ of $(p,V_t,E_t)$ such that $x_0$
and $x_t$ lead into $U_0$ and $U_t$, respectively.  If we show
that this relation is a bijective function, then the claim
of the lemma follows.

To show that the relation $R$ is a function, we must check that
if $x_0$ and $x'_0$ both lead into $U_0$, then $x_t$ and $x'_t$
both lead into the same component $U'_t$.  If $x_0$ and $x_0'$
lie in the same face, then $x_t$ and $x'_t$ lie in the same face.
In this case, Lemma~\ref{lemma:face-component} 
implies that both darts, $x_t$
and $x'_t$, lead into the same component. 

By a compactness argument, we can find positive parameters
$\phi,\epsilon$ that give 
   $$
   \begin{array}{rll}
   V(x_t,\phi)&\subset Y(p,V_t,E_t)\\
   U(x_t,\epsilon,\phi)&\subset Y(p,V_t,E_t)
   \end{array}
   $$
for all darts $x_0$ and all subsequent times $0\le t\le s$.

Assume that $x_0$ and $x'_0$ lie in different faces, but lead
into the same component.
If $x_\tau$ and $x'_\tau$ lead into the same component, there is
a path $\gamma$ in $Y(p,V_\tau,E_\tau)$
from $V(x_\tau,\phi)$ to $V(x'_\tau,\phi)$.  This path avoids 
$X(p,V_\sigma,E_\sigma)$ and connects $V(x_\sigma,\phi)$ to
$V(x'_\sigma,\phi)$ for all $\sigma$ sufficiently close to $\tau$.
Thus, there is smallest time $\sigma>0$ at which 
$x_\sigma$ and $x'_\sigma$ lead into different components.

let $W_\tau(F,\rho)$ be the union of the sets
   $$W(y_\tau,\rho\phi) \text{ and } U(y_\tau,\rho\epsilon,\rho\phi)$$
as $y_\tau$ runs over the darts in a face $F$, considered as a face
of $\op{hyp}(p,V_\tau,E_\tau)$.
As $\tau$ approaches $\sigma$ from below, the vectors $v_\tau\in V_\tau$
approach $v_\sigma\in V_\sigma$.  It follows that we can find
some $\tau<\sigma$ sufficiently close to $\sigma$ has the
following properties.
\begin{itemize}
%% WW This will take some work to prove formally.
 \item Let $p$ be a point in the boundary of $W_\tau(F,1/10)$ that
   also lies in $Y(p,V_\tau,E_\tau)$.  Then $p\in W_\sigma(F,1)$.
 \item  $X(p,V_\sigma,E_\sigma)$, lies in the union of the
  sets $W_\tau(F,1/10)$ (as $F$ runs over faces) and $X(p,V_\tau,E_\tau)$.
\end{itemize}
Let $\gamma$ be a path in $Y(p,V_\tau,E_\tau)$ from $W(x_\tau,\phi/10)$
to $W(x'_\tau,\phi/10)$.  By using these two properties, 
we can break the path into finitely many
segements $[s_i,s_{i+1}]$ such that for each $i$ we have one
of the following two conditions
\begin{itemize} 
\item
$\gamma({(s_i,s_{i+1})})$ does not meet any
$W(F,1/10)$ as $F$ runs over faces of the hypermap.
\item There is a face $F$ such that
$\gamma(s_i), \gamma(s_{i+1})\in W_\sigma(F,1)$.
\end{itemize}
Along each interval of the first type, the path takes values in
$Y(p,V_\sigma,E_\sigma)$.  Along each interval of the second type,
we may use the face that $W_\sigma(F,1)$ is connected to modify
the curve so that it lies in $Y(p,V_\sigma,E_\sigma)$ and takes
the same values at the endpoints.  Modifying the curve in this way,
we obtain a path in $Y(p,V_\sigma,E_\sigma)$
from $W(x_\sigma,\phi)$ to $W(x'_\sigma,\phi)$.  This completes
the proof that the relation $R$ is a function.

The function $R$ is onto, because every component of $(p,V_t,E_t)$
has a dart $x_t$ that leads into it.  The function is injective,
if the opposite relation $R^{op}$ consisting of all ordered pairs
$(U_t,U_0)$ is a function.  This is established by the same argument
that shows that $R$ is a function.  The lemma follows. 
\end{proof}

\subsection{connecting a hypermap}

%% Insert stuff on deforming to make it a single component

Our first deformation corresponds to the intuitive
notion of sliding two objects closer together.
In the case we consider, the objects are sets of vertices.

\begin{lemma} Let $(p,V_0,E_0)$ be a fan with hypermap $(D,e,n,f)$.
Let $x$ and $y$ be darts of $H$ that lead into the same
component $U_0$ of $Y(v_0,V,E)$.  For any dart $z$, let $A(z)$
be the $\tangle {e,n,f}$-component of $z$.
Assume that $A(x)\ne A(y)$.
Let $D' = D\setminus A(x)$.  
Fix $L>0$.
Suppose that if $(p,u_0,v_0,w_0)\in D'$ and
$(p,u'_0,v'_0,w'_0)\in A(x)$, then $|u_0-u'_0|>L$ and
that $|\,|u_0| - |u'_0|\,| < L$.
XX Need to insert hypothesis that give the fan condition
on deformations.

Then, there exists a deformation
$(p,V_t,E_t)$ of $(p,V_0,E_0)$, 
parameterized by $t\in[0,s]$ (for some $s$) 
such that
\begin{itemize}
\item $(p,V_t,E_t)$ is a fan for all $t\in[0,s]$.
\item $|v_t-p| = |v_0-p|$ for all $t\in[0,s]$.
\item If $x=(p,v_0,\ldots)\in D'$, then $v_t=v_0$ for all $t\in[0,s]$.
\item If $(p,v_0,\ldots)$ and $(p,w_0,\ldots)$ are darts
in $A(x)$, then $|v_t-w_t|=|v_0-w_0|$ for all $t\in[0,s]$.
\item If $(p,u_0,v_0,w_0)\in D$, then 
   $$
   \op{azim}(p,u_t,v_t,w_t) = \op{azim}(p,u_0,v_0,w_0),
   $$
   for all $t$.
\item There is a canonical identification of connected components
of $Y(p,V_t,E_t)$ with components of $Y(p,V_0,E_0)$, as $t$ varies.
\item 
Let $V_s$ be the component at $t=s$ corresponding to $V_0$ at $t=0$.
There exists two darts $u=(p,u_s,v_s,w_s)$ and
$u'=(p,u_s',v_s',w_s')$ that lead into $V_s$ such that
  \begin{itemize} % nested
  \item $|u_s-u_s'| = L$.
  \item $\{p,u_s,u'_s\}$ is not collinear.
  \item $\op{aff}_+^0(p,\{u_s,u_s'\}) \subset V_s$.
  \end{itemize} % nested
\end{itemize}
\end{lemma}

\begin{proof}
Let $U\subset V$ be the set of points corresponding
to the darts $(p,u_0,\ldots)\in A(x)$.  Let $U'=V\setminus U$.
Pic $u\in U$ and $u'\in U'$, and let $e_1,e_2,e_3\in\ring{R}^3$ be 
an orthogonal frame with $e_3\cdot u = e_3\cdot u' = 0$.
We apply an orthogonal transformation to $U$.
If $w\in\ring{R}^3$, we write
$w_0-p = a e_1 + b e_2 + c e_3$ and set
$$R_\theta w = p + (a\cos\theta+b\sin\theta) e_1 +
   (-a\sin\theta+b\cos\theta) e_2 + c e_3.$$
For $v_0\in V$, set
  $$
  v_\theta = \begin{cases}
    R_\theta v_0 & v_0\in U\\
    v_0 & v_0\in U'\\
    \end{cases}
  $$
When $\theta=0$, $|u_\theta-u'_\theta|>L$, but for some $\theta\in[0,2\pi]$,
it follow from our choice of $e_3$ that
$u'_\theta\op{aff}_+^0(p,u_\theta)$, so that
$$|u'_\theta - u_\theta| = |\,|u'_\theta| - |u_\theta|\,|
  = |\,|u'_0| - |u_0|\,| < L.$$
By the intermediate value theorem, there is a least angle
$\theta'\in(0,\pi)$ such that there exists $v_0\in U$
and $v'_0\in U'$ with $|v_{\theta'}-v'_{\theta'}|=L$.
%% XX need to reparametrize so that theta'=1.

We claim that the deformation $\theta\mapsto v_\theta$
has all of the required properties, provided that we make
a linear reparameterization so that $v_1$ represents the
rotation at $\theta=\theta'$.

The main point is to check for $0 < \theta < \theta'$,
that $(p,V_\theta,E_\theta)$ is a fan.
XX FINISH.
\end{proof}

If $(p,V_s,E_s)$ is the fan resulting from
this construction, the lemma guarantees the existence
of two darts $(p,u_s,v_s,w_s)$ and $(p,u'_s,v'_s,w'_s)$
such that $C^0(p,\{u_s,u'_s\})\subset V_s$.  It follows
that if we set $E' = E_s \cup \{u_s,u'_s\}$, then we obtain
a fan $(p,V_s,E')$.  In terms of the 
corresponding hypermaps, $\op{hyp}(p,V_s,E')$ is obtained from
$\op{hyp}(p,V_s,E_s)$ by a reverse double walkup.

\begin{lemma}\label{lemma:simple-polygon} 
Let $(p,V_0,E_0)$ be a fan and
let $(D,e,n,f)=\op{hyp}(p,V,E)$ be the associated hypermap.
Assume that there is a face $F$ of the hypermap such that every
node meets a dart of $F$.  Let $U_0\subset Y(p,V,E)$ be the corresponding
component. 
Assume that $F$ is not simple; that is, there is a node 
that contains at least two darts of $F$.
Assume that $|v-v'|\ge2$ for $v\ne v'\in V_0$.
Fix $L>0$.
XX Need to insert hypothesis that give the fan condition
on deformations.

Then, there exists a deformation
$(p,V_t,E_t)$ of $(p,V_0,E_0)$, parameterized by $t\in[0,s]$ (for some $s$) 
such
that
\begin{itemize}
\item $(p,V_t,E_t)$ is a fan for all $t\in[0,s]$.
\item $|v_t-p| = |v_0-p|$ for all $t\in[0,s]$.
\item $|v_t-v_t'|\ge 2$, for $v_t,v_t'\in V_t$.
\item There is a canonical identification of $(D_t,e_t,n_t,f_t)$
with $(D,e,n,f)$ and of $U_t$ with $U_0$.  (XX This might not be
phrased precisely enough.)
\item If $(p,v_0,w_0,\ldots)$ is a dart, then
   $|v_t-w_t|$ is constant as a function of $t\in[0,s]$.
\item If $X_t$ is the set of darts at a node leading into $U_t$
   $$
   \sum_{x_t\in X_t} \op{azim}(x_t)
   $$
is independent of $t\in[0,s]$.
\item 
Let $U_s$ be the component at $t=s$ corresponding to $U_0$ at $t=0$.
There exists two darts $u=(p,u_s,v_s,w_s)$ and
$u'=(p,u_s',v_s',w_s')$ that lead into $U_s$ such that
  \begin{itemize} % nested
  \item $|u_s-u_s'| = L$.
  \item $\{p,u_s,u'_s\}$ is not collinear.
  \item $\op{aff}_+^0(p,\{u_s,u_s'\}) \subset U_s$.
  \end{itemize} % nested
\end{itemize}
\end{lemma}



%By deformation, we can produce subregions whose boundary is a polygon.
%Let $U$ be the set of vertices over the subregion of height $\le2t_0$.
%As in Section~\ref{sec:the-main-theorem}, the distinguished edges
%partition $U$ into equivalence classes.  Move the vertices in one
%equivalence class $U_1$ as a rigid body preserving heights until the
%class comes sufficiently close to form a distinguished edge with another
%subset. Continue until all the vertices are interconnected by paths of
%distinguished edges. 


%If some vertex $v$ is connected to three or more vertices by
%distinguished edges, it follows from the connectedness of the open
%subregion that there is more than one connected component $U_i$ (by
%paths of distinguished edges) of $U\setminus\{v\}$. Move $U_i\cup \{v\}$
%rigidly preserving heights and keeping $v$ fixed until a distinguished
%edge forms with another component. Continue until the distinguished
%edges break the subregions into subregions with polygon boundaries.


%By the end of Section~\ref{x-4}, we will deform all subregions into
%convex polygons.

%\begin{remark}
%    \label{remark:proof-2}
%We will deform in such a way that the edges $\{v_1,v_2\}$ will maintain a
%length of at least $2$. The proof that distances of at least $2$ are
%maintained is given in Section~\ref{sec:proof-2}.
%
%We will deform in such a way that no vertex  crosses a boundary of the
%subregion passing from outside to inside.
%\end{remark}

%Edge length constraints prevent a vertex from crossing a boundary of the
%subregion from the inside to outside.  In fact, if $v$ is to cross the
%edge $\{v_1,v_2\}$, the simplex $S=\{0,v_1,v,v_2\}$ attains volume 0.  We
%may assume, by the argument of the proof of Lemma~\ref{x-4.3}, that
%there are no vertices enclosed over $S$. Because we are assuming that
%the subregion is not a triangle, we may assume that $|v-v_1|>2t_0$. We
%have $|v|\in[2,2t_0]$.  Under these constraints,
%by Lemma~\ref{tarski:delta-2}, the vertex $v$ cannot cross out of the subregion.



\subsection{vertex paths} % Visibility % DCG Sec. 12.7

%%

XX This section is sloppy when it comes to the nonuniqueness of geodesic
with antipodal points.


%% Moved from the end of [DCG SEC 12.7]

\begin{definition}
Let $(v_0,V,E)$ be a fan, and let $v,v'\in V$.  We say
that $v$ is visible from $v'$ if $v\ne v'$, $\{v,v',p\}$ is not
collinear,  and
  $$\op{aff}_+^0(v_0,\{v,v'\})\subset Y(v_0,V,E).$$
\end{definition}

The visibility relation is clearly symmetric in $v$ and $v'$.

\begin{lemma} Let $(v_0,V,E)$ be a fan and let $v,v'\in V$.
Suppose that $v$ is visible from $v'$.  Then
$(v_0,V,E\cup\{v,v'\})$ is a fan.
\index{visible}
\end{lemma}

\begin{lemma}  Let $(p,V_0,E_0)$ be a fan whose hypermap
is isomorphic to $H_{2n}$ of Example~\ref{XX}.  (That is, assume that
the hypermap has two simple polygonal faces $F,F'$.)  Let $(p,V_t,E_t)$
for $t\in[0,s]$ be a deformation of $(p,V_0,E_0)$ satisfying the same
properties.  We have a canonical identification of the components
of $Y(p,V_t,E_t)$ with $\{F,F'\}$ for all $t$.
Suppose that $|v_t-v'_t|\ge 2$ for all $t$ and all $v_t,v_t'\in V_t$.  
Suppose for two vertices $v_0,v'_0\in V_0$, such that $v'_0$
is not visible from $v_0$ (in the component of $F$).
Suppose that for all $t$, and $|v_t-v'_t|< L$.
(XX add hypothesis to make result true.)
Then for all $t$, $v'_t$ is not visible from $v_t$.
\end{lemma}

\begin{proof} Fix $t>0$ at the inf of $t$ for which $v'_t$ is visible
from $v_t$.   Then there is $w_t\in V_t$ such that
$w_t\in \op{aff}_+^0(p,\{v_t,v_t'\}$.  We reach the contradiction XX.
\end{proof}



\begin{definition}\label{def:concave}
A dart of of a hypermap of a fan is {\it convex\/}
if its azimuth angle is less than $\pi$, and otherwise that it
is {\it concave}
\index{convex}\index{concave}
%
\end{definition}



%\subsection{Preservation of Minimal Distance}
%\subsection{Proof that Distances Remain at least $2$} %DCG 12.13, p140
    \label{sec:proof-2}


%\begin{remark}
%\label{flexremark} In Section~\ref{remark:proof-2}, to allow for
%more flexible deformations, we drop all constraints on the lengths
%of (undistinguished) edges $\{v_1,v_2\}$ that cross the boundary of
%the subregion.  We deform in such a way that the edges $\{v_1,v_2\}$
%will maintain a length of at least $2$.
%\end{remark}



Let $(p,V,E)$ be a fan.   
Let $F$ be one of the faces of the
hypermap with corresponding component $U_F\subset Y(p,V,E)$.
Let $v,v'\in V$.    We consider sequences
$v=v_0,v_1,\ldots,v_r=v'$ such that for every $i$,
\begin{itemize}
  \item $\{v_i,v_{i+1}\} \in E$, or
  \item $v_i$ is visible from $v_{i+1}$ in $U_F$.
\end{itemize}
(XX modify the definition so that if a vertex has two or more darts
at a node, it still traces things in a correct way. It must depart
a midpoint of an edge into the same nbd as it came. That is, it
can't cross an edge even if $U_F$ is on both sides.  It must depart
the same dart in which it came.)
We call such a sequence a vertex-path in $F$ from $v$ to $v'$.
The {\it arc-length} of a vertex-path is the sum of the lengths
$$
\sum_{i=0}^{r-1}\arc(p,v_i,v_{i+1})
$$
For a fixed $(p,V,E)$, there is a constant $C$ such that
each term $\arc(p,v_i,v_{i+1})$ has length greater than $C$.  It
follows that the arc-length tends to infinity as the length of
the vertex-path tends to infinity.  It also follows that there are only
finitely many vertex-paths that are contenders for the shortest arc-length,
and that some path attains the smallestt arc-length among all vertex-paths.

More generally, we consider paths
$v=v_0,v_1,v_2,\ldots,v_r=v'$ such that 
\begin{itemize}
\item for each $i$, there exists $w_i$, $w_{i+1}$ with $\{w_i,w_{i+1}\}\in E$
such that $C^0(v_i,v_{i+1})\subset C^0(w_i,w_{i+1})$, or
\item $C^0(v_i,v_{i+1})\subset U_F$.
\end{itemize}
Again, we measure the arc-length as the sums of the arcs.

\begin{lemma}
For every path, there is a vertex-path that has no greater length
such that the intermediate points on that vertex path occur at convex darts
and such that no vertex occurs in the path more than once.
Among such vertex paths there is one of least arc-length.
\end{lemma}

\begin{proof}  For simplicity, assume that $p=0$.
The paths arc-length remains the same if $v_i$ is replaced with $v_i/|v_i|$.
We assume that points have been scaled in this way.  Also, let $\bar V$ be
the set of $v/|v|$, with $v\in V$.  Let $\bar W\subset \bar V$ be those
vertices whose corresponding dart is convex.

We define the lexicographical order of a path to be the lexicographical order on
pairs
   $(a,b)$
where $a$ is the cardinality of
   $$\bar W \cup \{v_1,\ldots,v_r\},$$
and $b$ is the cardinality of the set
   $$\bar W \setminus \{v_1,\ldots,v_r\}.$$

The basic construction that we use to decrease path length is the following.
Assume that $v\not\in \bar W$.
Let $(u,v,w)$ be consecutive points on the path.  Let $[v,w]_t$,
for $0\le t\le 1$, be the parametrized arc
of a circle, centered at $p$ from $v$ to $w$, such that $[v,w]_0=v$ and $[v,w]_1=w$.
Assume that for sufficiently small $t$, $C^0(u,[v,w]_t)\subset U_F$.
Then, let $s$ be the sup of $t\le 1$ such that $C^0(u,[v,w]_t)\subset U_F$.
Either $s=1$, or 
If $C^0_s=C^0(u,[v,w]_s)$ contains a vertex $v'\in \bar W$.
If $s=1$, then we can replace the path
$(\ldots,u,v,w,\ldots)$ with $(\ldots,u,w,\ldots)$ to obtain a path whose
arc-length is smaller (by the spherical triangle inequality) and whose 
lexicographical order is smaller.
If $s<1$, then we have vertices $v'_1,\ldots,v'_k\in \bar W$ that lies on $C^0_s$.
Assume that the indices are compatible with the order on $C^0_s$.
Then replace $(\ldots,u,v,w,\ldots)$ with
$(\ldots,u,v'_1,\ldots,v'_k,[u,v]_s,w,\ldots)$.  If any of the points $v'_j$
equal any of the points $v_k$ on the path, then a loop is created in the path.
We may eliminate the loop and thereby shorten the arc-length
(by the spherical triangle inequality Lemma~\ref{lemma:sph-tri-ineq}) and decrease the 
lexicographical order.  If there is no equality $v'_j=v_k$, then the the new
path has shorter arc-length.  The first lexicographic coordinate $a$ is unchanged.
The second lexicographic coordinate $b$ is decreased.

The conclusion of this construction is that whenever we have a consecutive
points on the path $(u,v,w)$ such that $v\not\in \bar W$ and $C^0(u,[v,w]_t)\subset U_F$ (or
symmetrically $C^0(w,[v,u]_t)\subset U_F$) for small $t$, then we can decrease
the arc-length and lexicographic order by modifying the path.
In fact, the second condition is automatically satisfied whenever $v\not\in \bar W$.
We conclude that for every path there is a path with shorter arc-length and
smaller lexicographic order such that
$v_i\in W$ for $0 < i < r$.  

Thus, for every path there is a vertex path that has smaller arc-length 
(and lexicographical order)
and
such that none of the intermediate vertices are associated with  convex darts.
None of the vertices are visitied more than once.
There are finitely many possibilities for such vertex-paths.  Thus, there
must exist one of minimal arc-length.
\end{proof}


\begin{lemma}  The vertex $v_0$ is visible from $v_r$ if and
only if $r=1$.
\end{lemma}

\begin{proof}  This follows from the previous lemma by the spherical triangle inequality.
(XX need case of equality here??)
\end{proof}

\subsection{convexity}


\begin{lemma}  Let a face be such that every vertex is convex.  Then $U_F$ is
geodesically convex.  That is, for every $v,v'\in \bar U = U_F\cup_{x\in XX} C(p,\{u,w\})$
we have $C^0(p,\{v,v'\})\subset U_F$.  In particular, the arc-length between any
two points in $\bar U$ is at most $\pi$. 
\end{lemma}

\begin{proof}
XX need to generalize previous stuff so that $v,v'$ don't have to lie at a vertex.
They can lie at an edge or interior.
\end{proof}

\begin{lemma} Let a face be such that every vertex is convex.  Then the face
is simple.  That is, no two darts lie on the same face.
\end{lemma}

\begin{proof} Let $x,y$ be two darts.
There are no intermediate vertices in the vertex-path from $x$ to $y$.
XX need to generalize vertex-path so that starting points can be darts rather than
vertices.
\end{proof}

\begin{lemma}\label{lemma:details}
Let $F$ be a face such that every dart is convex except possibly one
at vertex $v$.  Then  every vertex $w$ of $F$ is visible from $v$.
\end{lemma}

\begin{proof}  In the shortest vertex-path from $w$ to $v$, every intermediate
vertex is concave.  By assumption, no such vertices exist.  Therefore,
the vertex-path runs directly from $w$ to $v$.  In particular,
$w$ is visible from $v$.
\end{proof}

\begin{lemma}\label{lemma:convex-hyper}  
Let $(p,V,E)$ be a fan whose hypermap is isomorphic
to $H_{2n}$ for some $n$.  Let $F$ be one of the two faces of the hypermap.  Assume
that every dart of $F$ is convex (or azimuth angle exactly $\pi$).  Let $x,y$
be consecutive darts on $F$ and let $u,v$ be the corresponding points of $V$.
Let $w$ be any third vertex of $V$.  Then $U_F$
is contained in
a half-space through $p$.  Specifically, $U_F\subset \op{aff}_+^0(\{p,u,v\},w)$.
Morevover,
let $P=(v_1,\ldots,v_r,v_1)$ be the vertices of $V$ listed
in the order of the face-map $f$ on $F$.  Then the arc-length of the closed
path $P$ is at most $2\pi$.
\end{lemma}

\begin{proof}  If every dart but at most one 
has azimuth angle exactly $\pi$, then the set $\{p\}\cup V$ is
planar.  This forces the final dart to have azimuth angle $\pi$ as well. 
The sum of the angles at $p$ is exactly $2\pi$.

Assume that there is some dart at vertex $v\in V$ with azimuth angle less than $\pi$.
If there are only two darts with azimuth angle less than $\pi$, 
we have
a lune and $V$ consists of two antipodal points and possibly additional points
with azimuth angle $\pi$.  In this case, the arc-length
is precisely $2\pi$ and the lune is contained in half-space.

We now assume that there are at least three darts with azimuth angle less than $\pi$.
We prove the result by induction on the number of azimuth angles less than $\pi$,
with base case given by $2$ angles.

By Lemma~\ref{XX}, the distances between points in $\bar U$ are at most arc-length $\pi$.
We consider a deformation $(p,V_t,E)$ such that the only vertex that moves is
$v$.  Suppose that $(u,v,w)$ are consecutive (distinct) vertices in the face cycle $F$.
Let $v_t$ be the point in the plane of $\{p,u,v\}$ at distance $1$ from $p$ that
is extended by arc-length $t$ beyond the arc from $(u-p)/|u-p|$ to $(v-p)/|v-p|$.
As $t$ increases, the angle at $w$ increases until for some value $t=s$, the angle
at $w$ is $\pi$.  The angle at $v_t$ remains between $0$ and $\pi$.  This deformation
is increasing in the set $\bar U_t$.  By the spherical-triangle inequality, it is
also increasing in the perimeter arc-length.   Because of the bound on the arc-length
at most $\pi$ in $\bar U_t$, it is not possible for $C^0(p,\{v_t,w\})$ to meet
$C^0(p,\{u,u'\})$ for any edge $\{u,u'\}\ne\{v_t,w\}\in E$.   
When $t=s$, we reduce to a case known by the induction hypothesis.
\end{proof}





\begin{lemma}
    \oldlabel{5.1.2}
    \label{lemma:7-sides}
Let $(p,V,E)$ be a fan whose hypermap is isomorphic
to $H_{2n}$ for some $n$.  Let $F$ be one of the two faces of the
hypermap.  Assume that every dart of $F$ has azimuth angle at
most $\pi$.  
The convex polygon has at most seven sides.
\end{lemma}

\begin{proof}
Since the polygon is convex, its perimeter arc-length is at
most $2\pi$.  If there are eight sides, the perimeter
is at least $8\arc(2t_0,2t_0,2)>2\pi$.
\end{proof}




\subsection{triangulations}

Let $(p,V,E)$ be a fan.  Let $F$ be a face of the hypermap
with corresponding component $U_F$.

\begin{lemma} Assume that one of the following conditions hold:
\begin{itemize} 
  \item There are at darts $x,y$ in different (combinatorial) components of the 
   hypermap that lead into $U_F$, or
  \item The face $F$ has more than three darts and there is a convex dart of $F$.
\end{itemize}
Then there exists $\{u,v\}$ such that $\{u,v\}\not\in E$ and such
that $u$ is visible from $v$.
\end{lemma}

\begin{proof} Suppose that there are darts $x,y$ in different components
of the hypermap that lead into $U_F$.  Let $v,v'\in V$ be the vertices of $x,y$, respectively.
Let $(v=v_0,\ldots,v_r=v')$ be a vertex-path of minimal-arc length.
By Lemma~\ref{XX},  the components
lie in topologically distinct sets of vertices and edges of the fan.   
Thus, for some $i$,
   $$
   C^0(p,\{v_i,v_{i+1}\})\subset U_F
   $$
where $\{v_i,v_{i+1}\}\not\in E$.  This is the desired pair.

We may now assume that the darts leading into $U_F$ all belong to the same
combinatorial component of the hypermap.  In particular, we may assume that
the darts leading into $U_F$ are non-degenerate (Lemma~\ref{XX}).
Suppose that there is a convex  dart of $F$, with corresponding vertex $v\in V$.
Assume further that there are at least four darts in $F$.
Let $(x,y,z)$ be consecutive darts of $F$ under the face map.  By Lemma~\ref{XX},
the darts are at different vertices $(u,v,w)$.  


As in the proof of 
Lemma~\ref{XX}, we consider the blade $C^0_s= C^0(p,\{u,[v,w]_t\})$ and the
sup $s$ of $t\le 1$ for which $C^0_t\subset U_F$.  IF $s=1$ and $C^0_1\subset U_F$,
then the assumption that that there are at least four darts in $F$ allows us
to conclude that $\{v,w\}\not\in F$, so that $C^0_1$ is the desired blade.
If, on the other hand, $s<1$, we find that $C^0_s$ contains points
$v'_1,\ldots,v'_k$ of $V$.  We may order the points along $C^0_s$.  If
$v'_1$ is not the vertex consecutive to $u$ in the order imposed by the face map on $F$,
then $C^0(p,\{u,v'_1\})$ gives the desired blade.  Hence we may assume that
the vertices appear in the face $F$ in the order $(v'_1,u,v,w)$.  The azimuth
angle of at $u$ is less than the dihedral angle of $\{p,u\},\{v,w\}$.  In particular,
it is a convex dart at $u$.  By a symmetrical argument, we also find a desired blade at $w$
or prove that the azimuth angle of the at $w$ is convex.  

Consider the vertex-path of smallest arc-length from $v=v_0$ to $v'_1$.  Any intermediate
vertices on this path are concave by Lemma~\ref{XX}.  In particular, the path
not not pass through the darts $x$ and $z$ at $u$ and $w$.  That is, the path
jumps from $y$ past the adjacent darts $x$ and $y$.  Hence 
$C(p,\{v_0,v_1\})$ gives the desired blade.
\end{proof}



\subsection{planarity}



\begin{lemma}  Let $(v_0,V,E)$ be a fan.  Assume
that all the darts in the corresponding hypermap are reduced.   
Let $\#c$ be the number
of connected components of $Y(v_0,V,E)$.  We have
    \begin{itemize}
    \item The hypergraph $\op{hyp}(v_0,V,E)$ is planar.
    \item No two faces in a given $\tangle{e,n,f}$ orbit lead
    into the same connected component.
    \item $\#c = 1 + \#f - \#\tangle{e,n,f}$
    \item Let $U$ be a connected component. Let $F\mapsto U$ mean
    that the face leads into $U$.  Then $U \cap B(v_0,1)$ 
       is measurable and eventually radial at $v_0$.  Its solid angle is
        $$\op{sol}(U) = 4\pi + \sum_{F\mapsto C}(-2\pi + \sum_{x\in F}
        (\op{azim}(x)-\pi))$$
    \end{itemize}
\end{lemma}

\begin{proof}  We first establish the result when the hypermap
of $(v_0,V,E)$ is a triangulation.  More precisely, assume that the hypermap
is connected ($\#\tangle{e,n,f}=1$), that every face has three darts,
and every edge has two darts, and every dart is convex.  
In this case, each connected component 
of $Y(v_0,V,E)$ has
the form $U(v_1,v_2,v_3)=\op{aff}_+^0(v_0,\{v_1,v_2,v_3\})$.  In fact,
these sets are connected and their union is all of $Y(v_0,V,E)$; thus,
they are the connected components.   There is a bijection
between components and faces $U \leftrightarrow F$, which associates this connected component
with the three darts $(v_0,v_i,v_j,v_k)$, $(i,j,k)$ a cyclic permutation
of $(1,2,3)$.  (For the previous statement to be correct, we must assume
that the indices $(1,2,3)$ are properly oriented.)

Each connected component $U(v_1,v_2,v_3)$ is measurable and eventually radial
at $v_0$.  By the area formula for a solid triangle, the solid angle of $U(v_1,v_2,v_3)$
is 
   $$-\pi + \sum_{x\in F} \op{azim}(x) = 4\pi + (-2\pi + \sum (\op{azim}(x) - \pi)),$$
as stated in the lemma.  If we sum this relation over all components, we obtain
the solid angle of a sphere:
   \begin{equation}\label{eqn:euler}
   \begin{array}{lll}
   4\pi &= -\sum_{F} \pi + \sum_{x} \op{azim}(x)\\
        &= -\#f \pi + 2 \# n \pi.
   \end{array}
   \end{equation}
In a triangulation, $\#\tangle{e,n,f}=1$, $2 \# e  = 3\#f$, $\# D = 2 \#e$.
It follows from these relations that
   $$
   2(\#n + \# e + \# f) = (4 + 3\#f) + 2\#e = 4 + 4\# e = 4 + 2 \# D = 2(2\#\tangle{e,n,f}+\# D).
   $$
Thus, the hypermap is planar.  The lemma is now fully established under the
triangulation hypotheses.

Now turn to the general case.  Add to the fan finitely many isolated
points (no edges) $V' = V\cup S$ to make $(v_0,V',E)$ such that no half-space
through $v_0$ contains all the points of $V'$.    While $\tangle{e,n,f}$ has
more than one orbit, we may use Lemma~\ref{XX} to find $u,v\in V'$ such
that $C^0=C^0(v_0,\{u,v\})$ lies in a single connected component of $Y(v_0,V',E)$ and
joins two components of $\tangle{e,n,f}$.  We add the edge $\{u,v\}$ to $E$ to form
a new fan and hypermap.
We repeat this process until $\tangle{e,n,f}$ is connected.  In particular, this
inserts edges to each of the extra added points $S\subset V'$.

Suppose that some face of the resulting hypermap only has concave darts.  Then
in particular each node that the face meets has only one dart.  (If two darts
of the face appear at a node, the azimuth angle constraint forces both darts to
have angle $\pi$, so that the node has degree two and lies in the same plane
as the adjacent nodes.  Continuing, the adjacent nodes also have degree two and
have angle $\pi$.  By induction, the entire vertex set $V'$ lies in a plane, which
is contrary to the choice of $V'$.)   In particular, the face of concave darts
is simple.   The complementary path describes a convex polygon.  There
is a normal family consisting of the concave face and the complementary path.
The quotient is isomorphic to $H_{2n}$ for some $n$.  By Lemma~\ref{XX}, the
convex polygon in the quotient lies in the intersection $R$ of half-planes
$$
\op{aff}_+(\{v_0,u,v\},w),
$$
where $\{u,v\}$ runs over adjacent vertices.  

We claim that every vertex of $V'$ lies in this intersection of half-planes.
(This will contradict the assumption on $S$ and will lead to the conclusion that
there is no face whose darts are all concave.)
If not, we use that the hypermap is connected to find an edge $\{w,w'\}$ such
that one endpoint $w$ lies in $R$ and the other $w'$ does not.  
Let $\op{aff}(\{v_0,u,v\})$ be the bounding plane of $R$ that 
is crossed first (say at point $p$) by
$C(v_0,\{w,w'\})$.  (XX isolate in elementary reals.)  
Let consecutive vertices be $u,v,v'$ on the concave face.  Since
$p\in \op{aff}_+(\{v_0,v,v'\},u)$, we see that $p$ has non-negative barycentric
coordinate with respect to $u$ in $\{v_0,v,v',u\}$.  Since $p\in \op{aff}\{v_0,u,v\})$
its barycentric coordinate with respect to $v'$ is zero.  Similarly, its
coordinate with respect to $v$ is non-negative.  We conclude that 
  $$p\in \op{aff}_+(v_0,\{u,v\}),$$
with $\{u,v\}\in E$.  By the definition of fans, the meeting of two
blades implies that $w\in\{u,v\}$.
However, the endpoint $w$ cannot be a node of the concave face, because this would
create two darts of the concave face at $w$ (XX Clarify.)

We conclude that every face has at least one convex dart.  By Lemma~\ref{XX},
we can add an edge to every face (that is not already a triangle).  By repeatedly
inserting edges, eventually we obtain a triangulation, hence a fan
that satisfies the conclusions of the lemma.

XX separate out several sublemmas.  The case of triangulations, the nonexistence
of a concave face.

Now we reverse the process.  Starting with the triangulation, we remove the
edges that we have inserted into the preplanar graph  (in a first-in first-out order).  
Each edge removal is
described combinatorially as a double-walkup.  (Note that
in the case of an edge to an isolated vertex  $v\in S\subset V'$, the second walkup
in the double walkup
 removes the degenerate dart at $v$.  Hence in reversing the process,
the vertices $V$ are eventually removed.)  Double-walkups of
a planar hypermap preserve planarity by Lemma~\ref{XX}.  Hence the original
fan has a planar hypermap.  Also, by the calculations of planar indices
in Lemma~\ref{XX}, every double walkup either merges or  splits
 increasing the number of connected components by $1$.

In the triangulation the components is in natural bijection with the number of faces.
Each merging double walkup is applied to an edge $\{x,y\}$ such that each endpoint $x$,
$y$ leads into a different face, hence into a different component.  By Lemma~\ref{XX},
and Lemma~\ref{XX}, the number of components and faces both drop by exactly one.
In particular, the components and faces remain in natural bijection after the
double walkup.  Each double walkup that splits increases the number of faces by one,
increases $\#\tangle{e,n,f}$ by one, and preserves the number of connected components.
The announced formula for the number of connected components thus holds.

Finally, the solid angle formula is easily checked to be compatible with
the deletion of the edges.  That is, when two areas are joined, we have
  $$\op{sol}(C_1) + \op{sol}(C_2) = \op{sol}(C_1\cup C_2)$$
and the combinatorial formula is similarly additive.
The lemma is now completely established.
\end{proof}



\begin{lemma} (Jordan curve theorem)  Let $(v_0,V,E)$ be a fan.
If $\op{hyp}(v_0,V,E)$ is a combinatorial polygon (a
connected hypermap such that every node has cardinality two), then
$Y(v_0,V,E)$ has exactly two connected components.
\end{lemma}

\begin{proof} By the preceding lemma, $\# c = \#f$, and the
hypermap is planar.  Since every node and every edge has order two,
we have $\#D = 2\#n = 2\# e = \#n +\#e$.  Since it is connected,
$\#\tangle{e,n,f} = 1$.  By the preceding lemma, the hypermap is
planar. Hence, the Euler relation gives:
    $$
    \#c = \#f = (\#D - \#n - \#e) + 2\#\tangle{e,n,f} =2.
    $$
\end{proof}


\subsection{minimum distance}

\begin{lemma}\label{dist2} In the same context, consider a deformation
of the fan $(v_0,V_0,E_0)$ that moves a single vertex $w_t$
and keeps all other vertices fixed.  Suppose that the deformation is
smooth such that the tangent vector points into $U_t$ for all $t$.
Suppose for all $t$ that $|w-v_t| \ge L$ whenever
$C^0(p,\{w,v_t\})\subset U_t$.
XX finish statement (conditions on lengths, specials, etc).   
Then the distances $|w-v_t|\ge 2$ for all
$t$.
\end{lemma}

XX need to define special vertex in $V$ and special pair
of vertices $\{u,w\}$ (those adjacent to the special one).


\begin{proof}
The proof is by contradiction.  We drop the subscripts on $v_t$, $V_t$,
and simply remember that we are dealing with a variable points $v$.
We may assume that $|v-w|<\sqrt8$.
We may assume that $v$ and $w$ are the first points of $V$ to violate
the condition of being at least $2$ apart, so that distances
between other pairs of corners are at least $2$.  We have $\{v,w\}\in E$
if $w$ is visible from $v$. So assume
that $w$ is not visible.  Let $C(p,\{v_1,v_2\})$ be the first
blade $\{v_1,v_2\}\in E$ meeting $C(p,\{v,w\})$.  Let  $p_0$ be a point of
By
construction, the deformation moves $v$ into the subregion, and
the dart at $v$ is concave, so that the blade
$C(p,\{v,w\})$ begins in $U_F$, then crosses out at
$p_0$.

We have $|v_1-v_2|\ge2.91$ by Lemma~\ref{tarski:E:part4:10}.

Let $e_0,\ldots,e_r$ be the arc-length minimal vertex-path from $v$ to
$v_1$, and let $f_0,\ldots,f_s$ be the arc-length minimal vertex-path from
$v$ to $v_2$. Since this sequence has minimal arc-length, the
sum of the arc-lengths $\arc(p,e_i,e_{i+1})$ is at most the sum of 
$\arc(p,v,p_0)$ and $\arc(p,p_0,v_1)$, and the sum of arc-lengths of $\arc(p,f_i,f_{i+1})$
is at most the sum of the lengths of $\arc(p,v,p_0)$ and $\arc(p,p_0,v_2)$.

Note that if $r+s\le4$, then one of the edge-lengths must be at
least $3.2$, for otherwise each blade in the sequence corresponds to
an 
edge of $E$ or to a special pair, and this would not permit
the existence of a corner $w$. That is, we can fully enumerate the
vertices of $V$, and each is a
point in a vertex-path, or is a special vertex.
None of these corners is separated from $v$ by the plane
$\{p,v_1,v_2\}$.

We have $r+s\le3$ by the following calculations.  Here
$y\in[2,2t_0]$.
    $$5\arc(2t_0,2t_0,2) > \arc(2,2,3.2)+ 2 \arc(2,2,2).$$
    $$3\arc(2t_0,2t_0,2) + \arc(2t_0,y,3.2) > \arc(y,2,3.2) + 2 \arc(2,2,2).$$
    $$3\arc(2t_0,2t_0,2) + \arc(2t_0,y,3.2) > \arc(2,2,3.2) + 2\arc(y,2,2).$$


First we prove the lemma in the case that the distance from
$v$ to one of the endpoints, say $v_1$, of $\{v_1,v_2\}$ is at least
$3.2$. In this case, Lemma~\ref{tarski:dcg-1220} shows
that we have an
impossible geometric configuration. The
constraints are as follows.  There are five points: $0,v_1,w,v,v_2$.
The plane $\{0,v_1,v_2\}$ separates the point $w$ from $v$. The
distance constraints are as follows:
    $$2\le |u| \le 2t_0,$$
for $u=v_1,w,v,v_2$, $|v-v_1|\ge 3.2$, $|v-w|\le2$, $|v-v_2|\ge2$,
$|w-v_1|\ge2$, $|w-v_2|\ge2$, $2\le |v_1-v_2|\le 3.2$.

Now assume that the distances from $v$ to the vertices $v_1$ and
$v_2$ are at most $3.2$.

If $r+s=2$, then $v_1$ and $v_2$ are visible from $v$. Thus, the
blades come from $E$ or special pairs.  As
$\{v_1,v_2\}$ is also an edge of $E$, the vertices in $V$ are fully
enumerated: $v$, $v_1$, $v_2$, and the special vertices.  
Since none of these are $w$, we conclude that $w$ does
not exist in this case.

If $r+s=3$, then say $r=1$ and $s=2$. We have $\{v,v_1\}$ is
an edge of $E$ or a special pair.  Let
$\{v,u\}=\{f_0,f_1\}$. We
have $|u-v_1|\ge\sqrt8$ because $\{u,v_1\}$ is not in $E$,
and $\max(|u-v|,|u-v_1|)\ge3.2$, because otherwise we enumerate
all vertices of $P$ as in the case $r+s=2$, and find that $w$ is
not among them. Lemma~\ref{tarski:dcg-p142} now shows that
there does not exist a configuration of five points
$0$, $u$, $v$, $v_1$, $v_2$, with all distances at least $2$
satisfying these constraints.
\end{proof}















\subsection{containment of truncated corner cells} %DCG  12.11, p 136
    \oldlabel{4.12}


Let $H =\op{hyp}(v_0,V,E)$ be the hypermap of a fan,
and let $C$ be a connected component
of $Y(v_0,V,E)$.

We assume
that we are working with a component
with the following properties. If $v$ is a concave dart and $w$
is not adjacent to $v$, and yet is visible from $v$, then
$|v-w|\ge3.2$. If $v$ is a concave corner, then $|v-w|\ge3.07$ for
both adjacent corners $w$. If $v$ is a concave corner and
$|v|\ge2.2$, then $|v-w|\ge3.2$ for both adjacent corners $w$.


Recall from Definition~\ref{def:concave} that we call a spherical
region {\it convex} if its interior angles are all less than
$\pi$. 
%The case where the subregion is a convex triangle will be
%treated in Section~\ref{x-5.7}. Hence, we may also assume in
We assume
that the component is
not a convex triangle.

In Section~\ref{sec:tcc}, a region $TC(0,v,w_1,w_2,t_0,\lambda)$,
called the
truncated corner cell (tcc), is introduced.
We construct a {\it truncated corner cell\/} at each corner.  It depends on 
parameters $t_0$ and $\lambda \in [1.6,1.945]$. In all applications, we
take
    $\lambda = 1.945 = 3.2-t_0$, $\lambda = 1.815 = 3.07-t_0$, or
    $\lambda = 1.6 = 3.2/2$.
In all applications $w_1,v,w_2$ will be consecutive corners of
a standard region.

By construction tccs at adjacent
corners of a standard region are separated by a plane . Tccs at
nonadjacent corners do not overlap if the corners are
$\ge2\lambda$ apart. Tccs will only be used in subregions
satisfying this condition. It will be shown in
this section that tccs lie in the cone over the subregion
(for suitable $\lambda$).

\begin{lemma}
    \oldlabel{4.12.1}
Let $v$ be a concave vertex with $|v|\ge2.2$. The truncated
corner cell at $v$ with parameter $\lambda=1.945$ lies in the truncated
$V$-cell over $R$.
\end{lemma}

\begin{proof}
Consider a  corner cell at $v$ and a distinguished edge $\{v_1,v_2\}$
forming the boundary of the subregion. The corner cell with parameter
$\lambda=1.945$ is contained in a cone of arcradius
    $\theta = \arc(2,t_0,\lambda)< 1.21 <\pi/2$
(in terms of the function {\it arc\/} of Section~\ref{x-2.8}). Take two
corners $w_1$, $w_2$, visible from $v$, between which the given bounding
edge appears. (We may have $w_i=v_i$). The two visible edges, $\{v,w_i\}$,
have length $\ge 3.2$. (Recall that the distinguished edges at $v$ have
been deformed to length $3.2$.) They have arc-length at least
$\arc(2t_0,2t_0,3.2)>1.38$. The segment of the distinguished edge
$\{v_1,v_2\}$ visible from $v$ has arc-length at most
$\arc(2,2,3.2)<1.86$.

We check that the corner cell cannot cross the visible portion of
the edge $\{v_1,v_2\}$. Consider the spherical triangle formed by
the edges $\{v,w_1\}$, $\{v,w_2\}$ (extended as needed) and the
visible part of $\{v_1,v_2\}$. Let $C$ be the radial projection of
$v$ and $AB$ be the radial projection of the visible part of
$\{v_1,v_2\}$. Pivot $A$ and $B$ toward $C$ until the edges $AC$ and
$BC$ have arc-length $1.38$.  The perpendicular from $C$ to $AB$
has length at least
    $$\arccos(\cos(1.38)/\cos(1.86/2))>1.21>\theta.$$
This proves that the corner cell lies in the cone over the subregion.
\end{proof}

\begin{lemma}
    \oldlabel{4.12.2}
Let $v$ be a concave vertex. The truncated corner cell at $v$ with
parameter $\lambda=1.815$ lies in the truncated $V$-cell over $R$.
\end{lemma}

\begin{proof}
The proof proceeds along the same lines as the previous lemma, with
slightly different constants. Replace $1.945$ with $1.815$, $1.38$ with
$1.316$, $1.21$ with $1.1$. Replace $3.2$ with $3.07$ in contexts giving
a lower bound to the length of an edge at $v$, and keep it at $3.2$ in
contexts calling for an upper bound on the length of a distinguished
edge. The constant $1.86$ remains unchanged.
\end{proof}

\begin{lemma}
    \oldlabel{4.12.3}
The truncated corner cells with parameter $1.6$ in a subregion do
not meet at interior points.
\end{lemma}

\begin{proof}
We may assume that the corners are not adjacent. If a nonadjacent
corner $w$ is visible from $v$, then $|w-v|\ge3.2$, and an
interior point intersection $p$ is incompatible with the triangle
inequality: $|p-v|\le 1.6$, $|p-w|<1.6$. If $w$ is not visible, we
have a chain $v=v_0,v_1,\ldots,v_r=w$ such that $v_{i+1}$ is
visible from $v_i$. Imagine a taut string inside the subregion
extending from $v$ to $w$. The radial projections of $v_i$ are the
corners of the string's path.   The string bends in an angle
greater than $\pi$ at each $v_i$, so the angle at each
intermediate $v_i$ is greater than $\pi$. That is, they are
concave. Thus, by our deformations $|v_i-v_{i+1}|\ge3.07$. The
string has arc-length at least $r \arc(2t_0,2t_0,3.07)>r (1.316)$.
But the corner cells lie in cones of arcradius
$\arc(2,t_0,\lambda)< 1$. So $2(1.0)>r(1.316)$, or $r=1$.  Thus,
$w$ is visible from $v$.
\end{proof}

\begin{lemma}
    \oldlabel{4.12.4}
The corner cell for $\lambda \le 1.815$ does not meet at an
interior point with the $t_0$-cone wedge around another corner
$w$.
\end{lemma}

\begin{proof}
We take $\lambda=1.815$. As in the previous proof, if there is overlap
along a chain, then
    $$\arc(2,t_0,\lambda) +\arc(2,t_0,t_0) > r \arc(2t_0,2t_0,3.07),$$
and again $r=1$.  So each of the two vertices in question is visible
from the other. But overlap implies $|p-v|\le1.815$ and $|p-w|<t_0$,
forcing the contradiction $|w-v|<3.07$.
\end{proof}

\begin{lemma}
    \oldlabel{4.12.5}
The corner cell for $\lambda \le 1.945$ at a corner $v$ satisfying
$|v|\ge2.2$ does not meet at an interior point with the $t_0$-cone
wedge around another corner $w$.
\end{lemma}

\begin{proof}
We take $\lambda=1.945$. As in the previous proof, if there is overlap
along a chain, then
    $$\arc(2,t_0,\lambda) +\arc(2,t_0,t_0) > r \arc(2t_0,2t_0,3.2),$$
and again $r=1$.  Then the result follows from
    $$|w-v|\le |p-v|+|p-w| < 1.945 + t_0 = 3.2.$$
\end{proof}





